                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   LSX-Dodgers for MZ-700/1500
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "M7DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MZ-700/1500
                                
       0001                     MAC EQU 1   ;MZ-700/1500
       0000                     DEV EQU 0
                                
       8080                     RUN EQU 08080H
       8000                     OFFSET  EQU RUN-128
       CF06                     BDOS    EQU 0CF06H
       ED40                     TABLEAD EQU 0ED40H
       F000                     WORKAD  EQU 0F000H
       F300                     FATBF   EQU 0F300H
       FB00                     DTBUF   EQU 0FB00H
       FF00                     KEYBF   EQU 0FF00H
       FF20                     KBUF    EQU 0FF20H
       FFD9                     TRAP38  EQU 0FFD9H
       0028                     WIDTH   EQU 40
       0019                     LINE    EQU 25
       0070                     COLORF  EQU 070H
       0010                     KEYSP_H EQU 16
       0083                     KEYSP_L EQU 131
       000A                     COMS    EQU 10
[EOF:M7DEF.ASM:UTF_8]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0005                     VER_2   EQU 5
       0006                     VER_3   EQU 6
       1D01                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0001                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0156                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       FFCA                     EXTBIO  EQU 0FFCAH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 8000                         ORG OFFSET
                                                    ;MZTヘッダ128バイト
000000 8000 01                      DB  1           ;ファイルモード
000001 8001 4C44202020202020        DB  "LD           "     ;ファイル名(13)
            2020202020          
00000E 800E 535953                  DB  "SYS"           ;拡張子(3)
000011 8011 0D                      DB  $0D
000012 8012 EB24                    DW  LAST_ADR-RUN        ;サイズ
000014 8014 8080                    DW  RUN         ;開始アドレス
000016 8016 8080                    DW  RUN         ;実行アドレス
000018 8018                         DS  104
                                
                                    INCLUDE "M7INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   MZ-700/1500
                                
000080 8080 C38780          10      JP  START
000083 8083 011D                    DW  MACW
000085 8085 5601                    DW  VER
                                
       8087                     START:
000087 8087 F3               4      DI
000088 8088 ED56             8      IM  1
00008A 808A 318780          10      LD  SP,START
00008D 808D CD9B80          17      CALL    INIT        ;NZならAUTOEXECを実行
000090 8090 210000          10      LD  HL,0
000093 8093 E5              11      PUSH    HL
000094 8094 C8              11      RET Z
000095 8095 112881          10      LD  DE,AUTOD
000098 8098 C3FDF0          10      JP  _COMANL
                                
       809B                     INIT:
00009B 809B D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFFH)
00009D 809D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00009F 809F 218D81          10      LD  HL,INITE
0000A2 80A2 1106CF          10      LD  DE,BDOS
0000A5 80A5 01DE23          10      LD  BC,LAST_ADR-INITE
0000A8 80A8 EDB0                    LDIR
0000AA 80AA 215E81          10      LD  HL,M7BEEPD
0000AD 80AD 1162F0          10      LD  DE,BEEPD+1
0000B0 80B0 010800          10      LD  BC,M7BEEPE-M7BEEPD
0000B3 80B3 EDB0                    LDIR
                                
0000B5 80B5 210000          10      LD  HL,0
0000B8 80B8 065C             7      LD  B,05CH
0000BA 80BA 3EEF             7      LD  A,0EFH      ;RST 28H
0000BC 80BC CDE1DC          17      CALL    FILL_MEMORY
0000BF 80BF 06A4             7      LD  B,0A4H
0000C1 80C1 AF               4      XOR A
0000C2 80C2 CDE1DC          17      CALL    FILL_MEMORY
                                
0000C5 80C5 3EC3             7      LD  A,0C3H      ;JP
0000C7 80C7 2103F0          10      LD  HL,CPM_WBOOT
0000CA 80CA 320000          13      LD  (00000H),A
0000CD 80CD 220100          16      LD  (00001H),HL ;IPL
                                
0000D0 80D0 21011D          10      LD  HL,MACW     ;3 bit7  DPB Compatible LA(1)
0000D3 80D3 220300          16      LD  (00003H),HL ;  bit6-0 Machine
                                ;               ;4 LSX-Dodgers(01DH)
0000D6 80D6 2106CF          10      LD  HL,BDOS
0000D9 80D9 320500          13      LD  (00005H),A
0000DC 80DC 220600          16      LD  (00006H),HL ;BDOS
                                
0000DF 80DF 21D9FF          10      LD  HL,TRAP38   ;TRAP38
0000E2 80E2 322800          13      LD  (00028H),A
0000E5 80E5 222900          16      LD  (00029H),HL ;RST 028H
                                
0000E8 80E8 323800          13      LD  (00038H),A
0000EB 80EB 210ECF          10      LD  HL,IO_INT8253
0000EE 80EE 223900          16      LD  (00039H),HL
                                
0000F1 80F1 3EF0             7      LD  A,CPM_BOOT/256
0000F3 80F3 320B00          13      LD  (0000BH),A
                                
0000F6 80F6 3EE9             7      LD  A,0E9H      ;JP (HL)
0000F8 80F8 320F00          13      LD  (0000FH),A
                                
0000FB 80FB 213481          10      LD  HL,INIMES
0000FE 80FE CD51D5          17      CALL    MSX
       8101                     INIT1:
000101 8101 F3               4      DI
000102 8102 1100FF          10      LD  DE,0FF00H
000105 8105 0600             7      LD  B,0
000107 8107 CDA4D3          17      CALL    ZERO_MEMORY_DE
00010A 810A 21CAFF          10      LD  HL,EXTBIO
00010D 810D 36C9            10      LD  (HL),0C9H   ;RET
00010F 810F 23               6      INC HL
000110 8110 060E             7      LD  B,TRAP38-EXTBIO-1
000112 8112 3EEF             7      LD  A,0EFH      ;RST 28H
000114 8114 CDE1DC          17      CALL    FILL_MEMORY
000117 8117 216681          10      LD  HL,AT_TRAP38
00011A 811A 11D9FF          10      LD  DE,TRAP38
00011D 811D 012700          10      LD  BC,AT_TRAPE-AT_TRAP38
000120 8120 EDB0                    LDIR
                                
000122 8122 CDBCDB          17      CALL    CHKEY
000125 8125 FE03             7      CP  3
000127 8127 C9              10      RET
                                
000128 8128 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
000131 8131 413A00              AUTODV: DB  "A:",0
                                
000134 8134 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for MZ-700/1500 v"
            6765727320666F72    
            204D5A2D3730302F    
            313530302076        
000152 8152 312E                    DB  030H + VER_1, '.'
000154 8154 3536                    DB  030H + VER_2 ,030H + VER_3
                                ;   DB  ""
000156 8156 2047616B750D0A          DB  ' Gaku',0DH,0AH
00015D 815D 00                      DB  0
                                
       815E                     M7BEEPD:
00015E 815E 0801                    DB  8,1
000160 8160 0736                    DB  7,036H
000162 8162 04F9                    DB  4,0F9H
000164 8164 0403                    DB  4,3
       8166                     M7BEEPE:
                                
       8166                     AT_TRAP38:
000166 FFD9                         ORG TRAP38,AT_TRAP38-OFFSET
000166 FFD9 210000          10      LD  HL,0
000169 FFDC E3              19      EX  (SP),HL
00016A FFDD 3E24             7      LD  A,'$'
00016C FFDF CD27D8          17      CALL    MSG_A
00016F FFE2 2B               6      DEC HL
000170 FFE3 7C               4      LD  A,H
000171 FFE4 CDE8FF          17      CALL    PRHX
000174 FFE7 7D               4      LD  A,L
       FFE8                     PRHX:
000175 FFE8 F5              11      PUSH    AF
000176 FFE9 07               4      RLCA
000177 FFEA 07               4      RLCA
000178 FFEB 07               4      RLCA
000179 FFEC 07               4      RLCA
00017A FFED CDF1FF          17      CALL    PRHX2
00017D FFF0 F1              10      POP AF
       FFF1                     PRHX2:
00017E FFF1 E60F             7      AND 00FH
000180 FFF3 FE0A             7      CP  10
000182 FFF5 3F               4      CCF
000183 FFF6 CE30             7      ADC A,'0'
000185 FFF8 27               4      DAA
000186 FFF9 C327D8          10      JP  MSG_A
000189 FFFC                         DS  4
       818D                         ORG $$+OFFSET   ;$DEPHASE
       818D                     AT_TRAPE:
                                
       818D                     INITE:
00018D CF06                         ORG BDOS,INITE-OFFSET
                                
00018D CF06 C309CF          10      JP  IO_BDOS
[EOF:M7INIT.ASM:SHIFT_JIS]
                                    INCLUDE "M7BANK.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                ;   VRAM/KEY/TIMER(0D000H-0EFFFH)にアクセスするので0D000H-0FFFFHに置けない部分
                                ;
                                
       CF09                     IO_BDOS:
000190 CF09 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000192 CF0B C310D5          10      JP  BDOS0
                                
       CF0E                     IO_INT8253:
000195 CF0E F3               4      DI
000196 CF0F F5              11      PUSH    AF
000197 CF10 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000199 CF12 3E01             7      LD  A,1
00019B CF14 3206E0          13      LD  (0E006H),A  ;8253 Ch.2 カウンタ
00019E CF17 AF               4      XOR A
00019F CF18 3206E0          13      LD  (0E006H),A  ;8253 Ch.2 カウンタ
0001A2 CF1B D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001A4 CF1D C3E1D7          10      JP  INT8253 
                                
       CF20                     RDKEYDATA:
0001A7 CF20 F3               4      DI
0001A8 CF21 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001AA CF23 3200E0          13      LD  (0E000H),A
0001AD CF26 3A01E0          13      LD  A,(E001H)
0001B0 CF29 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001B2 CF2B FB               4      EI
0001B3 CF2C C9              10      RET
                                
       CF2D                     RD556VSYNC:
0001B4 CF2D F3               4      DI
0001B5 CF2E D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001B7 CF30 3A02E0          13      LD  A,(0E002H)
0001BA CF33 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001BC CF35 FB               4      EI
0001BD CF36 C9              10      RET
                                
       CF37                     RDMMIO:
0001BE CF37 F3               4      DI
0001BF CF38 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001C1 CF3A 7E               7      LD  A,(HL)
0001C2 CF3B D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001C4 CF3D FB               4      EI
0001C5 CF3E C9              10      RET
                                
       CF3F                     WRMMIO:
0001C6 CF3F F3               4      DI
0001C7 CF40 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001C9 CF42 77               7      LD  (HL),A
0001CA CF43 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001CC CF45 FB               4      EI
0001CD CF46 C9              10      RET
                                
       CF47                     RDMMIO_BC:
0001CE CF47 F3               4      DI
0001CF CF48 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001D1 CF4A 0A               7      LD  A,(BC)
0001D2 CF4B D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001D4 CF4D FB               4      EI
0001D5 CF4E C9              10      RET
                                
       CF4F                     WRMMIO_BC:
0001D6 CF4F F3               4      DI
0001D7 CF50 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001D9 CF52 02               7      LD  (BC),A
0001DA CF53 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001DC CF55 FB               4      EI
0001DD CF56 C9              10      RET
                                
       CF57                     IO_PRINT:
0001DE CF57 F3               4      DI
0001DF CF58 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001E1 CF5A 77               7      LD  (HL),A
0001E2 CF5B CBDC             8      SET 3,H
0001E4 CF5D 71               7      LD  (HL),C
0001E5 CF5E D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001E7 CF60 FB               4      EI
0001E8 CF61 C9              10      RET
                                
       CF62                     IO_CLR:
0001E9 CF62 F3               4      DI
0001EA CF63 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF65                     C1AX1:
0001EC CF65 7A               4      LD  A,D
0001ED CF66 C6D0             7      ADD A,0D0H
0001EF CF68 57               4      LD  D,A
0001F0 CF69 AF               4      XOR A
0001F1 CF6A 12               7      LD  (DE),A      ;Text
0001F2 CF6B CBDA             8      SET 3,D
       CF6E                     ICSMC   EQU $+1
0001F4 CF6D 3E00             7      LD  A,0     ;自己書き換え
0001F6 CF6F 12               7      LD  (DE),A      ;Color
0001F7 CF70 13               6      INC DE
0001F8 CF71 7A               4      LD  A,D
0001F9 CF72 D6D8             7      SUB 0D8H
0001FB CF74 57               4      LD  D,A
0001FC CF75 2118FC          10      LD  HL,0-WIDTH*LINE
0001FF CF78 19              11      ADD HL,DE
000200 CF79 30EA            12      JR  NC,C1AX1
000202 CF7B E1              10      POP HL
000203 CF7C D1              10      POP DE
000204 CF7D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000206 CF7F FB               4      EI
000207 CF80 C9              10      RET
                                
       CF81                     IO_CLLINE:
000208 CF81 F3               4      DI
000209 CF82 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF84                     CLLINE1:
00020B CF84 CB9C             8      RES 3,H
00020D CF86 77               7      LD  (HL),A      ;Text
00020E CF87 CBDC             8      SET 3,H
000210 CF89 71               7      LD  (HL),C      ;Color
000211 CF8A 23               6      INC HL
000212 CF8B 10F7            13      DJNZ    CLLINE1
000214 CF8D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000216 CF8F FB               4      EI
000217 CF90 C9              10      RET
                                
       CF91                     IO_INS:
000218 CF91 F3               4      DI
000219 CF92 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF94                     IO_INS1:
00021B CF94 CDABCF          17      CALL    C12S
00021E CF97 23               6      INC HL
00021F CF98 10FA            13      DJNZ    IO_INS1
000221 CF9A D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000223 CF9C FB               4      EI
000224 CF9D C9              10      RET
                                
       CF9E                     IO_BS:
000225 CF9E F3               4      DI
000226 CF9F D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CFA1                     IO_BS1:
000228 CFA1 CDABCF          17      CALL    C12S
00022B CFA4 2B               6      DEC HL
00022C CFA5 10F7            13      DJNZ    IO_BS
00022E CFA7 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000230 CFA9 FB               4      EI
000231 CFAA C9              10      RET
                                
       CFAB                     C12S:
000232 CFAB CB9C             8      RES 3,H
000234 CFAD 5E               7      LD  E,(HL)
000235 CFAE 77               7      LD  (HL),A
000236 CFAF 7B               4      LD  A,E
000237 CFB0 CBDC             8      SET 3,H
000239 CFB2 5E               7      LD  E,(HL)
00023A CFB3 71               7      LD  (HL),C
00023B CFB4 4B               4      LD  C,E
00023C CFB5 C9              10      RET
                                
       CFB6                     IO_SCRUP:
00023D CFB6 F3               4      DI
00023E CFB7 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CFB9                     SCRUP1:
000240 CFB9 2815            12      JR  Z,SCRCL
000242 CFBB D5              11      PUSH    DE
000243 CFBC E5              11      PUSH    HL
000244 CFBD CBDA             8      SET 3,D
000246 CFBF CBDC             8      SET 3,H
000248 CFC1 012800          10      LD  BC,WIDTH
00024B CFC4 EDB0                    LDIR
00024D CFC6 E1              10      POP HL
00024E CFC7 D1              10      POP DE
00024F CFC8 012800          10      LD  BC,WIDTH
000252 CFCB EDB0                    LDIR
000254 CFCD 3D               4      DEC A
000255 CFCE 18E9            12      JR  SCRUP1
                                
       CFD0                     SCRCL:
000257 CFD0 0628             7      LD  B,WIDTH
000259 CFD2 EB               4      EX  DE,HL
00025A CFD3 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00025C CFD5 CD21DA          17      CALL    CLLINE
00025F CFD8 E1              10      POP HL
000260 CFD9 D1              10      POP DE
000261 CFDA C1              10      POP BC
000262 CFDB C9              10      RET
                                
       CFDC                     C_MON:
000263 CFDC D3E4            11      OUT (0E4H),A    ;MONITOR ROM(0000H-0FFFH) & VRAM/KEY/TIMER(D000H-FFFFH)
000265 CFDE C7              12      RST 0
                                
       CFDF                     INITINT:
000266 CFDF D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000268 CFE1 2107E0          10      LD  HL,0E007H   ;HL=0E007H 8253 コントロール
00026B CFE4 36B0            10      LD  (HL),0B0H   ;Ch.2 カウンタの下位バイト→上位バイトの順に連続してアクセス Mode 0 16ビットバイナリ
00026D CFE6 3674            10      LD  (HL),074H   ;Ch.1 カウンタの下位バイト→上位バイトの順に連続してアクセス Mode 2 16ビットバイナリ
00026F CFE8 2D               4      DEC L       ;0E006H 8253 Ch.2 カウンタ
000270 CFE9 3602            10      LD  (HL),2
000272 CFEB 3600            10      LD  (HL),0
000274 CFED 2D               4      DEC L       ;0E005H 8253 Ch.1 カウンタ
000275 CFEE 77               7      LD  (HL),A
000276 CFEF 3600            10      LD  (HL),0
000278 CFF1 3E05             7      LD  A,5
00027A CFF3 3203E0          13      LD  (0E003H),A  ;8255 コントロールポートでポートC(0E002H)のINTMSKを1にする
00027D CFF6 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00027F CFF8 C9              10      RET
                                
       CFF9                     BANKE:
000280 CFF9                         DS  0CFFEH-BANKE
[EOF:M7BANK.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   MZ-700/1500
                                
       CFFE                     WBOOT1:
000285 CFFE D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)　ここは0CFFEH
000287 D000 D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFHH)
000289 D002 F3               4      DI
00028A D003 3A94F0          13      LD  A,(_KEYSP)
00028D D006 CDDFCF          17      CALL    INITINT
000290 D009 ED7B0600        20      LD  SP,(SYSTEM+1)
000294 D00D FB               4      EI
000295 D00E 2192F0          10      LD  HL,_KEYD
000298 D011 3600            10      LD  (HL),0
00029A D013 CDBCDB          17      CALL    CHKEY
00029D D016 CD14D8          17      CALL    KEYBC_IFBREAK
0002A0 D019 3E04             7      LD  A,4
0002A2 D01B CD27D8          17      CALL    MSG_A
[EOF:M7CCP.ASM:UTF_8]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D01E                     COMMAND:
0002A5 D01E 3AFEEB          13      LD  A,(FCB_BAT)
0002A8 D021 B7               4      OR  A
0002A9 D022 C263D1          10      JP  NZ,C_BAT1
0002AC D025 CDD8D0          17      CALL    SETDTA1
0002AF D028 3A87F0          13      LD  A,(_DVSW)
0002B2 D02B C641             7      ADD A,'A'
0002B4 D02D CD27D8          17      CALL    MSG_A
0002B7 D030 3E3E             7      LD  A,'>'
0002B9 D032 CD27D8          17      CALL    MSG_A
0002BC D035 3E50             7      LD  A,80
0002BE D037 12               7      LD  (DE),A
0002BF D038 CD87D8          17      CALL    _SYS0A      ;(BDOS)文字列入力
0002C2 D03B CD66D2          17      CALL    LTNL
       D03E                     COMMAND2:
0002C5 D03E 118200          10      LD  DE,DTA1+2
0002C8 D041 CDFDF0          17      CALL    _COMANL
0002CB D044 30D8            12      JR  NC,COMMAND
0002CD D046 1179F0          10      LD  DE,COMERM
0002D0 D049 CD42D5          17      CALL    _SYS09      ;(BDOS)文字列出力
0002D3 D04C C7              12      RST 0
                                
       D04D                     COMANL:
0002D4 D04D CD35DC          17      CALL    FILE
0002D7 D050 3A19F0          13      LD  A,(FNAME+4)
0002DA D053 FE20             7      CP  020H
0002DC D055 201C            12      JR  NZ,COMB2
0002DE D057 D5              11      PUSH    DE
0002DF D058 1115F0          10      LD  DE,FNAME
0002E2 D05B 1A               7      LD  A,(DE)
0002E3 D05C FE20             7      CP  020H
0002E5 D05E 2844            12      JR  Z,SDVSW
0002E7 D060 1B               6      DEC DE
0002E8 D061 1A               7      LD  A,(DE)
0002E9 D062 C6FF             7      ADD A,0FFH
0002EB D064 3809            12      JR  C,COMB
0002ED D066 13               6      INC DE
                                
0002EE D067 21D4D4          10      LD  HL,COMTB
0002F1 D06A 060A             7      LD  B,COMS
0002F3 D06C CDB9DE          17      CALL    CPNAME
       D06F                     COMB:
0002F6 D06F D1              10      POP DE
0002F7 D070 D20F00          10      JP  NC,JP_HL
       D073                     COMB2:
0002FA D073 EB               4      EX  DE,HL
0002FB D074 2240D1          16      LD  (COMPAT+1),HL
0002FE D077 F5              11      PUSH    AF
0002FF D078 CDF8D0          17      CALL    CEXE4
000302 D07B F1              10      POP AF
000303 D07C 2115F0          10      LD  HL,FNAME
000306 D07F 116D00          10      LD  DE,FCB2+1   ;COMMAND NAME
000309 D082 010B00          10      LD  BC,11
00030C D085 EDB0                    LDIR
00030E D087 1198EB          10      LD  DE,PATHD
       D08A                     CEX1:
000311 D08A 1A               7      LD  A,(DE)
000312 D08B FE20             7      CP  020H
000314 D08D D8              11      RET C
000315 D08E CD2ADC          17      CALL    FILEC
000318 D091 D5              11      PUSH    DE
000319 D092 216D00          10      LD  HL,FCB2+1   ;COMMAND NAME
00031C D095 1115F0          10      LD  DE,FNAME
00031F D098 010B00          10      LD  BC,11
000322 D09B EDB0                    LDIR
000324 D09D CDF8D0          17      CALL    CEXE4
000327 D0A0 D1              10      POP DE
000328 D0A1 13               6      INC DE
000329 D0A2 18E6            12      JR  CEX1
                                
       D0A4                     SDVSW:
00032B D0A4 F1              10      POP AF
00032C D0A5 3A14F0          13      LD  A,(FDRV)
00032F D0A8 3D               4      DEC A
000330 D0A9 5F               4      LD  E,A
000331 D0AA 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
000333 D0AC 1831            12      JR  SYSTEM0
                                
       D0AE                     OPEN1:
000335 D0AE 2114F0          10      LD  HL,FDRV
       D0B1                     OPEN:
000338 D0B1 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D0B3                     OPEN3:
00033A D0B3 D5              11      PUSH    DE
00033B D0B4 11D9EB          10      LD  DE,DTA_CCP
00033E D0B7 CDD5D0          17      CALL    SETDTA
000341 D0BA EB               4      EX  DE,HL
000342 D0BB CDDFD0          17      CALL    SYSTEM0
000345 D0BE D1              10      POP DE
000346 D0BF C9              10      RET
                                
       D0C0                     OPEN2:
000347 D0C0 0E12             7      LD  C,012H
000349 D0C2 18EF            12      JR  OPEN3
                                
       D0C4                     DEFCB:              ;Z=Ok NZ=Error
00034B D0C4 11D9EB          10      LD  DE,DTA_CCP
00034E D0C7 CDDDD0          17      CALL    SYSC0F
                                
000351 D0CA 11FAEB          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
000354 D0CD 0604             7      LD  B,4
000356 D0CF CDA4D3          17      CALL    ZERO_MEMORY_DE
       D0D2                     SETDTA100:
000359 D0D2 110001          10      LD  DE,00100H
       D0D5                     SETDTA:
00035C D0D5 C31AD7          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D0D8                     SETDTA1:
00035F D0D8 118000          10      LD  DE,DTA1
000362 D0DB 18F8            12      JR  SETDTA
                                
       D0DD                     SYSC0F:
000364 D0DD 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D0DF                     SYSTEM0:
000366 D0DF CD0500          17      CALL    SYSTEM
000369 D0E2 B7               4      OR  A
00036A D0E3 C9              10      RET
                                
       D0E4                     C_CD:
00036B D0E4 0E5A             7      LD  C,5AH
00036D D0E6 18F7            12      JR  SYSTEM0
                                
       D0E8                     S27BUF:
00036F D0E8 3A0700          13      LD  A,(SYSTEM+2)
000372 D0EB 3D               4      DEC A
000373 D0EC E6F8             7      AND 0F8H
000375 D0EE 67               4      LD  H,A
000376 D0EF 2E00             7      LD  L,0
       D0F1                     S27DTA:
000378 D0F1 11D9EB          10      LD  DE,DTA_CCP
       D0F4                     S27:
00037B D0F4 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
00037D D0F6 18E7            12      JR  SYSTEM0
                                
       D0F8                     CEXE4:
00037F D0F8 211DF0          10      LD  HL,FNAME+8
000382 D0FB 7E               7      LD  A,(HL)
000383 D0FC FE20             7      CP  020H
000385 D0FE 2007            12      JR  NZ,CEXE7
000387 D100 3E3F             7      LD  A,'?'
000389 D102 77               7      LD  (HL),A
00038A D103 23               6      INC HL
00038B D104 77               7      LD  (HL),A
00038C D105 23               6      INC HL
00038D D106 77               7      LD  (HL),A
       D107                     CEXE7:
00038E D107 CDAED0          17      CALL    OPEN1
       D10A                     CEXE5:
000391 D10A C0              11      RET NZ
000392 D10B 2AE3EB          16      LD  HL,(DTA_CCP+1+9)
000395 D10E 7C               4      LD  A,H
000396 D10F CD41DF          17      CALL    CAP
000399 D112 67               4      LD  H,A
00039A D113 7D               4      LD  A,L
00039B D114 CD41DF          17      CALL    CAP
00039E D117 6F               4      LD  L,A
00039F D118 3AE2EB          13      LD  A,(DTA_CCP+1+8)
0003A2 D11B CD41DF          17      CALL    CAP
0003A5 D11E D642             7      SUB 'B'
0003A7 D120 282C            12      JR  Z,C_BAT
0003A9 D122 3D               4      DEC A       ;'C'
0003AA D123 2805            12      JR  Z,C_EXE
       D125                     CEXE6:
0003AC D125 CDC0D0          17      CALL    OPEN2
0003AF D128 18E0            12      JR  CEXE5
                                
       D12A                     C_EXE:
0003B1 D12A 7C               4      LD  A,H
0003B2 D12B FE4D             7      CP  'M'
0003B4 D12D 20F6            12      JR  NZ,CEXE6
                                
0003B6 D12F CDC4D0          17      CALL    DEFCB
0003B9 D132 CDE8D0          17      CALL    S27BUF
0003BC D135 3D               4      DEC A
0003BD D136 37               4      SCF
0003BE D137 C0              11      RET NZ
0003BF D138 7C               4      LD  A,H
0003C0 D139 B5               4      OR  L
0003C1 D13A 37               4      SCF
0003C2 D13B C8              11      RET Z
0003C3 D13C CDD8D0          17      CALL    SETDTA1
0003C6 D13F 110000          10  COMPAT: LD  DE,0                ; self-modifying code
0003C9 D142 ED7B0600        20      LD  SP,(SYSTEM+1)
0003CD D146 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
0003CE D147 6F               4      LD  L,A
0003CF D148 E5              11      PUSH    HL              ; push $0000 (reboot address)
0003D0 D149 24               4      INC H
0003D1 D14A E5              11      PUSH    HL              ; push $0100 (TPA address)
0003D2 D14B C36FD3          10      JP  SETFCB              ; and JP $0100
                                
       D14E                     C_BAT:
0003D5 D14E 114154          10      LD  DE,'A'+'T'*256
0003D8 D151 ED52            15      SBC HL,DE
0003DA D153 20D0            12      JR  NZ,CEXE6
                                
0003DC D155 CDC4D0          17      CALL    DEFCB
                                
0003DF D158 21D9EB          10      LD  HL,DTA_CCP
0003E2 D15B 11FEEB          10      LD  DE,FCB_BAT
0003E5 D15E 012500          10      LD  BC,37
0003E8 D161 EDB0                    LDIR
       D163                     C_BAT1:
0003EA D163 CDD2D0          17      CALL    SETDTA100
0003ED D166 CD9AD1          17      CALL    FGETC_BAT
0003F0 D169 218100          10      LD  HL,DTA1+1
0003F3 D16C 2025            12      JR  NZ,END_BATCH
0003F5 D16E FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
0003F7 D170 38F1            12      JR  C,C_BAT1
0003F9 D172 3620            10      LD  (HL),' '
0003FB D174 23               6      INC HL
       D175                     C_BAT2:
0003FC D175 77               7      LD  (HL),A
0003FD D176 23               6      INC HL
0003FE D177 7D               4      LD  A,L
0003FF D178 3C               4      INC A       ;L==0FFH
000400 D179 2809            12      JR  Z,RUN_BATCH
000402 D17B CD9AD1          17      CALL    FGETC_BAT
000405 D17E 2004            12      JR  NZ,RUN_BATCH
000407 D180 FE20             7      CP  020H
000409 D182 30F1            12      JR  NC,C_BAT2
       D184                     RUN_BATCH:
00040B D184 7D               4      LD  A,L
00040C D185 D67F             7      SUB DTA1-1
00040E D187 328000          13      LD  (DTA1),A
000411 D18A FE04             7      CP  4
000413 D18C 3805            12      JR  C,END_BATCH
000415 D18E 3600            10      LD  (HL),0
000417 D190 C33ED0          10      JP  COMMAND2
       D193                     END_BATCH:
00041A D193 AF               4      XOR A       ;バッチファイルを閉じる
00041B D194 32FEEB          13      LD  (FCB_BAT),A
00041E D197 C300F0          10      JP  CPM_BOOT
                                
       D19A                     FGETC_BAT:
000421 D19A 11FEEB          10      LD  DE,FCB_BAT
       D19D                     FGETC:              ;1文字ずつ読み込む
000424 D19D E5              11      PUSH    HL      ;Z:成功
000425 D19E 210100          10      LD  HL,1
000428 D1A1 CDF4D0          17      CALL    S27
00042B D1A4 E1              10      POP HL
00042C D1A5 3A0001          13      LD  A,(00100H)
00042F D1A8 C9              10      RET
                                
       D1A9                     C_DEL:
000430 D1A9 CD6FD3          17      CALL    SETFCB
000433 D1AC CD3DD8          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
000436 D1AF 0E13             7      LD  C,013H
000438 D1B1 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       D1B3                     C_REN:
00043A D1B3 CD6FD3          17      CALL    SETFCB
00043D D1B6 3E10             7      LD  A,010H      ;ディレクトリも対象にする
00043F D1B8 326900          13      LD  (FCB1+13),A ;属性
000442 D1BB 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       D1BD                     CDEL1:
000444 D1BD 115C00          10      LD  DE,FCB1
000447 D1C0 CD0500          17      CALL    SYSTEM
00044A D1C3 C6FF             7      ADD A,0FFH
00044C D1C5 C9              10      RET
                                
       D1C6                     C_DIR:
00044D D1C6 CD2ADC          17      CALL    FILEC
000450 D1C9 2115F0          10      LD  HL,FDRV+1
000453 D1CC CDBAD4          17      CALL    CWILD1
000456 D1CF 3EF1             7      LD  A,0F1H
000458 D1D1 3221F0          13      LD  (FDRV+13),A
00045B D1D4 CDAED0          17      CALL    OPEN1
       D1D7                     CDIR1:
00045E D1D7 B7               4      OR  A
00045F D1D8 2008            12      JR  NZ,PDSKF
000461 D1DA CD25D2          17      CALL    P_NAME
000464 D1DD CDC0D0          17      CALL    OPEN2
000467 D1E0 18F5            12      JR  CDIR1
                                
       D1E2                     PDSKF:
000469 D1E2 3A14F0          13      LD  A,(FDRV)
00046C D1E5 5F               4      LD  E,A
00046D D1E6 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
00046F D1E8 CD0500          17      CALL    SYSTEM
000472 D1EB 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
000473 D1EC C601             7      ADD A,001H
000475 D1EE D8              11      RET C       ;Aが0FFHだった場合
000476 D1EF 3E06             7      LD  A,8-2
       D1F1                     PDS1:               ;HL=未使用クラスタの総数
000478 D1F1 3C               4      INC A
000479 D1F2 CB19             8      RR  C
00047B D1F4 30FB            12      JR  NC,PDS1
       D1F6                     PDS2:               ;B←論理セクタのサイズの上位8ビット
00047D D1F6 3C               4      INC A
00047E D1F7 CB18             8      RR  B
000480 D1F9 30FB            12      JR  NC,PDS2
000482 D1FB 47               4      LD  B,A
                                
000483 D1FC 110000          10      LD  DE,0
       D1FF                     PDS3:
000486 D1FF 29              11      ADD HL,HL
000487 D200 EB               4      EX  DE,HL
000488 D201 ED6A            15      ADC HL,HL
00048A D203 EB               4      EX  DE,HL
00048B D204 10F9            13      DJNZ    PDS3
       D206                     PDSKF1:
00048D D206 CD9ED2          17      CALL    PRDEC_DEHL
000490 D209 1123EC          10      LD  DE,FREE
000493 D20C CD42D5          17      CALL    _SYS09      ;(BDOS)文字列出力
000496 D20F CD8DD2          17      CALL    PUTDRV
000499 D212 3E5C             7      LD  A,05CH      ;\
00049B D214 CD27D8          17      CALL    MSG_A
00049E D217 2A22F0          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
0004A1 D21A AF               4      XOR A
0004A2 D21B 11FEFF          10      LD  DE,0-2
0004A5 D21E 19              11      ADD HL,DE
0004A6 D21F 23               6      INC HL
0004A7 D220 DC9AD2          17      CALL    C,PRDEC_HL
0004AA D223 1841            12      JR  LTNL
                                
       D225                     P_NAME:
0004AC D225 3ADAEB          13      LD  A,(DTA_CCP+1)
0004AF D228 FE2E             7      CP  '.'
0004B1 D22A C8              11      RET Z
0004B2 D22B 11D0D4          10      LD  DE,DIRHD
0004B5 D22E CD42D5          17      CALL    _SYS09      ;(BDOS)文字列出力
0004B8 D231 3AE5EB          13      LD  A,(DTA_CCP+1+00BH)
0004BB D234 F5              11      PUSH    AF
0004BC D235 0F               4      RRCA
0004BD D236 9F               4      SBC A,A
0004BE D237 E60A             7      AND '*'-020H
0004C0 D239 C620             7      ADD A,020H
0004C2 D23B CD27D8          17      CALL    MSG_A
0004C5 D23E CD8DD2          17      CALL    PUTDRV
0004C8 D241 21DAEB          10      LD  HL,DTA_CCP+1
0004CB D244 CDDED2          17      CALL    FPRNT
                                
0004CE D247 F1              10      POP AF
0004CF D248 CB67             8      BIT 4,A
0004D1 D24A 2808            12      JR  Z,DIR3
0004D3 D24C 11C5D4          10      LD  DE,DIRMES
0004D6 D24F CD42D5          17      CALL    _SYS09      ;(BDOS)文字列出力
0004D9 D252 180A            12      JR  DIR6
       D254                     DIR3:
0004DB D254 ED5BF8EB        20      LD  DE,(DTA_CCP+1+01EH)
0004DF D258 2AF6EB          16      LD  HL,(DTA_CCP+1+01CH)
0004E2 D25B CD9ED2          17      CALL    PRDEC_DEHL
       D25E                     DIR6:
0004E5 D25E 3AB1F0          13      LD  A,(_WIDTH)
0004E8 D261 FE29             7      CP  40+1
0004EA D263 D400D3          17      CALL    NC,PRTTMS
                                
       D266                     LTNL:
0004ED D266 1E03             7      LD  E,3
0004EF D268 C3CDF0          10      JP  _PRINT
                                
       D26B                     C_PATH:
0004F2 D26B CD0CDD          17      CALL    SPCUT
0004F5 D26E 2198EB          10      LD  HL,PATHD
0004F8 D271 FE21             7      CP  021H
0004FA D273 300C            12      JR  NC,CPATH0
       D275                     CPATHP:
0004FC D275 7E               7      LD  A,(HL)
0004FD D276 23               6      INC HL
0004FE D277 FE20             7      CP  020H
000500 D279 3F               4      CCF
000501 D27A 30EA            12      JR  NC,LTNL
000503 D27C CD27D8          17      CALL    MSG_A
000506 D27F 18F4            12      JR  CPATHP
       D281                     CPATH0:
000508 D281 FE3B             7      CP  ';'
00050A D283 2001            12      JR  NZ,CPATH1
00050C D285 13               6      INC DE
       D286                     CPATH1:
00050D D286 EB               4      EX  DE,HL
00050E D287 014000          10      LD  BC,PATHX
000511 D28A EDB0                    LDIR
000513 D28C C9              10      RET
                                
       D28D                     PUTDRV:
000514 D28D 3A14F0          13      LD  A,(FDRV)
000517 D290 C640             7      ADD A,'A'-1
000519 D292 CD27D8          17      CALL    MSG_A
00051C D295 3E3A             7      LD  A,':'
       D297                     MSG_AR:
00051E D297 C327D8          10      JP  MSG_A
                                
       D29A                     PRDEC_HL:
000521 D29A AF               4      XOR A
       D29B                     PRDEC_AHL:
000522 D29B 5F               4      LD  E,A
000523 D29C 1600             7      LD  D,0
       D29E                     PRDEC_DEHL:
000525 D29E D5              11      PUSH    DE
000526 D29F 110FF0          10      LD  DE,DECBF
000529 D2A2 0605             7      LD  B,5
00052B D2A4 CDA4D3          17      CALL    ZERO_MEMORY_DE  ;A=0
00052E D2A7 D1              10      POP DE
                                
00052F D2A8 0E20             7      LD  C,32
       D2AA                     DEC1:
000531 D2AA 29              11      ADD HL,HL
000532 D2AB EB               4      EX  DE,HL
000533 D2AC ED6A            15      ADC HL,HL
000535 D2AE EB               4      EX  DE,HL
000536 D2AF E5              11      PUSH    HL
000537 D2B0 2113F0          10      LD  HL,DECBF+4
00053A D2B3 0605             7      LD  B,5
       D2B5                     DEC2:
00053C D2B5 7E               7      LD  A,(HL)
00053D D2B6 8F               4      ADC A,A
00053E D2B7 27               4      DAA
00053F D2B8 77               7      LD  (HL),A
000540 D2B9 2B               6      DEC HL
000541 D2BA 10F9            13      DJNZ    DEC2
000543 D2BC E1              10      POP HL
000544 D2BD 0D               4      DEC C
000545 D2BE 20EA            12      JR  NZ,DEC1
                                
000547 D2C0 210FF0          10      LD  HL,DECBF
00054A D2C3 3E20             7      LD  A,020H
00054C D2C5 0604             7      LD  B,4
       D2C7                     DEC3:
00054E D2C7 CDD4D2          17      CALL    DEC4
000551 D2CA CDD4D2          17      CALL    DEC4
000554 D2CD 23               6      INC HL
000555 D2CE 10F7            13      DJNZ    DEC3
       D2D0                     DECX:
000557 D2D0 CDD4D2          17      CALL    DEC4
00055A D2D3 AF               4      XOR A
       D2D4                     DEC4:
00055B D2D4 ED6F            18      RLD
00055D D2D6 FE20             7      CP  020H
00055F D2D8 2802            12      JR  Z,DEC5
000561 D2DA F630             7      OR  030H
       D2DC                     DEC5:
000563 D2DC 18B9            12      JR  MSG_AR
                                
       D2DE                     FPRNT:
000565 D2DE 0608             7      LD  B,8
000567 D2E0 CDF1D2          17      CALL    P_N1
00056A D2E3 7E               7      LD  A,(HL)
00056B D2E4 C680             7      ADD A,0A0H-020H
00056D D2E6 FEA0             7      CP  0A0H
00056F D2E8 2802            12      JR  Z,FPR1
000571 D2EA 3E2E             7      LD  A,'.'
       D2EC                     FPR1:
000573 D2EC CD27D8          17      CALL    MSG_A
000576 D2EF 0603             7      LD  B,3
                                
       D2F1                     P_N1:
000578 D2F1 C5              11      PUSH    BC
000579 D2F2 E5              11      PUSH    HL
00057A D2F3 7E               7      LD  A,(HL)
00057B D2F4 CD4DDF          17      CALL    CAP3
00057E D2F7 CD27D8          17      CALL    MSG_A
000581 D2FA E1              10      POP HL
000582 D2FB C1              10      POP BC
000583 D2FC 23               6      INC HL
000584 D2FD 10F2            13      DJNZ    P_N1
000586 D2FF C9              10      RET
                                
       D300                     PRTTMS:
000587 D300 3E20             7      LD  A,020H
000589 D302 CD27D8          17      CALL    MSG_A
                                
00058C D305 2AF2EB          16      LD  HL,(DTA_CCP+1+24)
00058F D308 7D               4      LD  A,L
000590 D309 B7               4      OR  A
000591 D30A C8              11      RET Z
000592 D30B CB3C             8      SRL H
000594 D30D 17               4      RLA
000595 D30E 17               4      RLA
000596 D30F 17               4      RLA
000597 D310 17               4      RLA
000598 D311 E60F             7      AND 00FH
00059A D313 57               4      LD  D,A
00059B D314 7C               4      LD  A,H
00059C D315 C650             7      ADD A,80
00059E D317 CD5AD3          17      CALL    PRDEC_A
0005A1 D31A 3E2D             7      LD  A,'-'
0005A3 D31C CD27D8          17      CALL    MSG_A
0005A6 D31F 7A               4      LD  A,D
0005A7 D320 CD5AD3          17      CALL    PRDEC_A
0005AA D323 3E2D             7      LD  A,'-'
0005AC D325 CD27D8          17      CALL    MSG_A
0005AF D328 7D               4      LD  A,L
0005B0 D329 E61F             7      AND 01FH
0005B2 D32B CD5AD3          17      CALL    PRDEC_A
                                
0005B5 D32E 2AF0EB          16      LD  HL,(DTA_CCP+1+22)
                                
0005B8 D331 3E20             7      LD  A,020H
0005BA D333 CD27D8          17      CALL    MSG_A
0005BD D336 7C               4      LD  A,H
0005BE D337 65               4      LD  H,L
0005BF D338 0603             7      LD  B,3
       D33A                     PRTTMS1:
0005C1 D33A 1F               4      RRA
0005C2 D33B CB1D             8      RR  L
0005C4 D33D 10FB            13      DJNZ    PRTTMS1
0005C6 D33F E61F             7      AND 01FH
0005C8 D341 CD5AD3          17      CALL    PRDEC_A
0005CB D344 3E3A             7      LD  A,':'
0005CD D346 CD27D8          17      CALL    MSG_A
0005D0 D349 7D               4      LD  A,L
0005D1 D34A 0F               4      RRCA
0005D2 D34B 0F               4      RRCA
0005D3 D34C E63F             7      AND 03FH
0005D5 D34E CD5AD3          17      CALL    PRDEC_A
0005D8 D351 3E3A             7      LD  A,':'
0005DA D353 CD27D8          17      CALL    MSG_A
0005DD D356 7C               4      LD  A,H
0005DE D357 E61F             7      AND 01FH
0005E0 D359 87               4      ADD A,A
                                
                                ;   PRINT10
                                
       D35A                     PRDEC_A:
0005E1 D35A E5              11      PUSH    HL
0005E2 D35B 0608             7      LD  B,8
0005E4 D35D 4F               4      LD  C,A
0005E5 D35E AF               4      XOR A
       D35F                     PRTA1:
0005E6 D35F CB01             4      RLC C
0005E8 D361 8F               4      ADC A,A
0005E9 D362 27               4      DAA
0005EA D363 10FA            13      DJNZ    PRTA1
0005EC D365 210FF0          10      LD  HL,DECBF
0005EF D368 77               7      LD  (HL),A
0005F0 D369 AF               4      XOR A
0005F1 D36A CDD0D2          17      CALL    DECX
0005F4 D36D E1              10      POP HL
0005F5 D36E C9              10      RET
                                
       D36F                     SETFCB:
0005F6 D36F CD0CDD          17      CALL    SPCUT
0005F9 D372 1A               7      LD  A,(DE)
0005FA D373 FE20             7      CP  020H
0005FC D375 3801            12      JR  C,SETFCBA
0005FE D377 1B               6      DEC DE
       D378                     SETFCBA:
0005FF D378 0624             7      LD  B,36
000601 D37A 215C00          10      LD  HL,FCB1
000604 D37D E5              11      PUSH    HL
000605 D37E AF               4      XOR A
000606 D37F CDE1DC          17      CALL    FILL_MEMORY
000609 D382 E1              10      POP HL
00060A D383 D5              11      PUSH    DE
00060B D384 CD80D7          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
00060E D387 216C00          10      LD  HL,FCB2
000611 D38A CD80D7          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
000614 D38D E1              10      POP HL
000615 D38E 010050          10      LD  BC,05000H
000618 D391 118100          10      LD  DE,00081H
       D394                     SETFCB1:
00061B D394 7E               7      LD  A,(HL)
00061C D395 23               6      INC HL
00061D D396 FE20             7      CP  020H
00061F D398 3805            12      JR  C,SETFCB2
000621 D39A 12               7      LD  (DE),A
000622 D39B 13               6      INC DE
000623 D39C 0C               4      INC C
000624 D39D 10F5            13      DJNZ    SETFCB1
       D39F                     SETFCB2:
000626 D39F 79               4      LD  A,C
000627 D3A0 328000          13      LD  (DTA1),A
00062A D3A3 04               4      INC B
       D3A4                     ZERO_MEMORY_DE:
00062B D3A4 AF               4      XOR A
       D3A5                     FILL_MEMORY_DE:
00062C D3A5 12               7      LD  (DE),A
00062D D3A6 13               6      INC DE
00062E D3A7 10FC            13      DJNZ    FILL_MEMORY_DE
000630 D3A9 C9              10      RET
                                
       D3AA                     C_COPY:
000631 D3AA CD6FD3          17      CALL    SETFCB
                                
000634 D3AD 1161F0          10      LD  DE,ZERO
000637 D3B0 CD2DDC          17      CALL    FILEC2
00063A D3B3 216C00          10      LD  HL,FCB2
00063D D3B6 CD87D7          17      CALL    S29X1
                                
000640 D3B9 3E10             7      LD  A,010H
000642 D3BB 326900          13      LD  (FCB1+13),A
000645 D3BE 216D00          10      LD  HL,FCB2+1
000648 D3C1 CDBAD4          17      CALL    CWILD1
       D3C4                     COPY0:
00064B D3C4 CDB7D4          17      CALL    CWILD
00064E D3C7 215C00          10      LD  HL,FCB1
000651 D3CA CDB1D0          17      CALL    OPEN
000654 D3CD 37               4      SCF
       D3CE                     COPY1:
000655 D3CE C0              11      RET NZ
000656 D3CF CDC4D0          17      CALL    DEFCB
                                
000659 D3D2 3AE6EB          13      LD  A,(DTA_CCP+13)
00065C D3D5 CB67             8      BIT 4,A
00065E D3D7 2821            12      JR  Z,COPY1A
                                
000660 D3D9 215D00          10      LD  HL,FCB1+1
000663 D3DC CD70E0          17      CALL    CHKWILD
000666 D3DF 3814            12      JR  C,COPY9
                                
000668 D3E1 3E20             7      LD  A,020H
00066A D3E3 325D00          13      LD  (FCB1+1),A
00066D D3E6 2AF3EB          16      LD  HL,(DTA_CCP+26)
000670 D3E9 23               6      INC HL
000671 D3EA 226A00          16      LD  (FCB1+14),HL
000674 D3ED 18D5            12      JR  COPY0
                                
       D3EF                     COPY8:
000676 D3EF CD42D5          17      CALL    _SYS09      ;(BDOS)文字列出力
000679 D3F2 CD66D2          17      CALL    LTNL
       D3F5                     COPY9:
00067C D3F5 CDC0D0          17      CALL    OPEN2
00067F D3F8 18D4            12      JR  COPY1
                                
       D3FA                     COPY1A:
000681 D3FA 216C00          10      LD  HL,FCB2
000684 D3FD 1114F0          10      LD  DE,FDRV
000687 D400 01DBEB          10      LD  BC,DTA_CCP+2
00068A D403 EDA0            16      LDI
00068C D405 3E0B             7      LD  A,11
       D407                     COPY2:
00068E D407 F5              11      PUSH    AF
00068F D408 7E               7      LD  A,(HL)
000690 D409 FE3F             7      CP  '?'
000692 D40B 2001            12      JR  NZ,COPY3
000694 D40D 0A               7      LD  A,(BC)
       D40E                     COPY3:
000695 D40E 12               7      LD  (DE),A
000696 D40F 03               6      INC BC
000697 D410 13               6      INC DE
000698 D411 23               6      INC HL
000699 D412 F1              10      POP AF
00069A D413 3D               4      DEC A
00069B D414 20F1            12      JR  NZ,COPY2
00069D D416 010500          10      LD  BC,16-11
0006A0 D419 EDB0                    LDIR
       D41B                     PUTNAME:
0006A2 D41B 215D00          10      LD  HL,FCB1+1
0006A5 D41E CD70E0          17      CALL    CHKWILD
0006A8 D421 300B            12      JR  NC,PUTN1
0006AA D423 2115F0          10      LD  HL,FDRV+1
0006AD D426 CDDED2          17      CALL    FPRNT
0006B0 D429 3E20             7      LD  A,020H
0006B2 D42B CD27D8          17      CALL    MSG_A
       D42E                     PUTN1:
0006B5 D42E 1114F0          10      LD  DE,FDRV
0006B8 D431 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
0006BA D433 CDDFD0          17      CALL    SYSTEM0
0006BD D436 2048            12      JR  NZ,COPYE2
0006BF D438 67               4      LD  H,A     ;A=0
0006C0 D439 6F               4      LD  L,A
0006C1 D43A 2235F0          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
0006C4 D43D 2237F0          16      LD  (FDRV+35),HL
       D440                     COPY6:
0006C7 D440 CDE8D0          17      CALL    S27BUF
0006CA D443 47               4      LD  B,A
0006CB D444 3C               4      INC A
0006CC D445 2831            12      JR  Z,COPYE
0006CE D447 7C               4      LD  A,H
0006CF D448 B5               4      OR  L
0006D0 D449 280C            12      JR  Z,COPY7
0006D2 D44B 1114F0          10      LD  DE,FDRV
0006D5 D44E 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0006D7 D450 CDDFD0          17      CALL    SYSTEM0
0006DA D453 2023            12      JR  NZ,COPYE
0006DC D455 10E9            13      DJNZ    COPY6
       D457                     COPY7:
0006DE D457 3AE6EB          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
0006E1 D45A 3221F0          13      LD  (FDRV+13),A
0006E4 D45D 21EDEB          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
0006E7 D460 1128F0          10      LD  DE,FDRV+20
0006EA D463 010400          10      LD  BC,4
0006ED D466 EDB0                    LDIR
                                
0006EF D468 1114F0          10      LD  DE,FDRV
0006F2 D46B 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
0006F4 D46D CDDFD0          17      CALL    SYSTEM0
0006F7 D470 2006            12      JR  NZ,COPYE
                                
0006F9 D472 1171F0          10      LD  DE,OK
0006FC D475 C3EFD3          10      JP  COPY8
                                
       D478                     COPYE:
0006FF D478 1114F0          10      LD  DE,FDRV
000702 D47B 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
000704 D47D CD0500          17      CALL    SYSTEM
       D480                     COPYE2:
000707 D480 37               4      SCF
000708 D481 C9              10      RET
                                
       D482                     C_TYPE:
000709 D482 CD6FD3          17      CALL    SETFCB
00070C D485 215C00          10      LD  HL,FCB1
00070F D488 CDB1D0          17      CALL    OPEN
000712 D48B 37               4      SCF
       D48C                     TYPE1:
000713 D48C C0              11      RET NZ
000714 D48D CDC4D0          17      CALL    DEFCB
000717 D490 3E06             7      LD  A,6
000719 D492 CD27D8          17      CALL    MSG_A
       D495                     TYPE2:
00071C D495 CDE8D0          17      CALL    S27BUF
00071F D498 C6FE             7      ADD A,0FEH
000721 D49A D8              11      RET C
000722 D49B 7C               4      LD  A,H
000723 D49C B5               4      OR  L
000724 D49D 2813            12      JR  Z,TYPEE
000726 D49F 010001          10      LD  BC,00100H
       D4A2                     TYPE3:
000729 D4A2 0A               7      LD  A,(BC)
00072A D4A3 03               6      INC BC
00072B D4A4 FE1A             7      CP  01AH
00072D D4A6 280A            12      JR  Z,TYPEE
00072F D4A8 CD27D8          17      CALL    MSG_A
000732 D4AB 2B               6      DEC HL
000733 D4AC 7C               4      LD  A,H
000734 D4AD B5               4      OR  L
000735 D4AE 20F2            12      JR  NZ,TYPE3
000737 D4B0 18E3            12      JR  TYPE2
       D4B2                     TYPEE:
000739 D4B2 CDC0D0          17      CALL    OPEN2
00073C D4B5 18D5            12      JR  TYPE1
                                
       D4B7                     CWILD:
00073E D4B7 215D00          10      LD  HL,FCB1+1
       D4BA                     CWILD1:
000741 D4BA 7E               7      LD  A,(HL)
000742 D4BB FE20             7      CP  020H
000744 D4BD C0              11      RET NZ
       D4BE                     CWILD2:
000745 D4BE 3E3F             7      LD  A,'?'
000747 D4C0 060B             7      LD  B,11
000749 D4C2 C3E1DC          10      JP  FILL_MEMORY
                                
00074C D4C5 20202020203C4449    DIRMES: DB  "     <DIR>$"
            523E24              
000757 D4D0 20203A24            DIRHD:  DB  "  :$"
                                
       D4D4                     COMTB:
00075B D4D4 44202020                DB  "D   "  ;1
00075F D4D8 C6D1                    DW  C_DIR
000761 D4DA 44495220                DB  "DIR "  ;2
000765 D4DE C6D1                    DW  C_DIR
000767 D4E0 434F5059                DB  "COPY"  ;3
00076B D4E4 AAD3                    DW  C_COPY
00076D D4E6 43442020                DB  "CD  "  ;4
000771 D4EA E4D0                    DW  C_CD
000773 D4EC 44454C20                DB  "DEL "  ;5
000777 D4F0 A9D1                    DW  C_DEL
000779 D4F2 50415448                DB  "PATH"  ;6
00077D D4F6 6BD2                    DW  C_PATH
00077F D4F8 52454E20                DB  "REN "  ;7
000783 D4FC B3D1                    DW  C_REN
000785 D4FE 54595045                DB  "TYPE"  ;8
000789 D502 82D4                    DW  C_TYPE
00078B D504 52454D20                DB  "REM "  ;9
00078F D508 3FD5                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP2.ASM"
                                
                                ;   LSX-Dodgers CCP2
                                ;   MZ-700/1500
                                
000791 D50A 4D4F4E20                DB  "MON "  ;10
000795 D50E DCCF                    DW  C_MON
[EOF:M7CCP2.ASM:UTF_8]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       D510                     BDOS0:
000797 D510 E5              11      PUSH    HL
000798 D511 79               4      LD  A,C
000799 D512 FE3C             7      CP  03CH
00079B D514 3802            12      JR  C,DOS1
00079D D516 3E3C             7      LD  A,03CH
       D518                     DOS1:
00079F D518 87               4      ADD A,A
0007A0 D519 6F               4      LD  L,A
0007A1 D51A 26F1             7      LD  H,STABLE/256
0007A3 D51C 7E               7      LD  A,(HL)
0007A4 D51D 2C               4      INC L
0007A5 D51E 66               7      LD  H,(HL)
0007A6 D51F 6F               4      LD  L,A
0007A7 D520 E3              19      EX  (SP),HL
0007A8 D521 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
0007A9 D522 C9              10      RET
       D523                     _DOS2:
0007AA D523 FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
0007AC D525 CAC2D7          10      JP  Z,_SYS5A
0007AF D528 FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
0007B1 D52A CA80D7          10      JP  Z,_SYS29
0007B4 D52D FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
0007B6 D52F CA89E9          10      JP  Z,_SYS5F
0007B9 D532 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
0007BB D534 200A            12      JR  NZ,_ERROR
0007BD D536 011D01          10      LD  BC,011DH
0007C0 D539 115601          10      LD  DE,VER
0007C3 D53C 210100          10      LD  HL,MACD
       D53F                     C_REM:
0007C6 D53F AF               4      XOR A
       D540                     _ERROR:
0007C7 D540 A7               4      AND A
0007C8 D541 C9              10      RET
                                
       D542                     _SYS09:     ;文字列出力
0007C9 D542 D5              11      PUSH    DE
       D543                     _SX09:
0007CA D543 1A               7      LD  A,(DE)
0007CB D544 13               6      INC DE
0007CC D545 FE24             7      CP  '$'
0007CE D547 2831            12      JR  Z,SX0E2
0007D0 D549 CD27D8          17      CALL    MSG_A
0007D3 D54C 18F5            12      JR  _SX09
                                
       D54E                     MSX1:
0007D5 D54E CD27D8          17      CALL    MSG_A
       D551                     MSX:
0007D8 D551 7E               7      LD  A,(HL)
0007D9 D552 23               6      INC HL
0007DA D553 B7               4      OR  A
0007DB D554 20F8            12      JR  NZ,MSX1
0007DD D556 C9              10      RET
                                
       D557                     _SYS0C:     ;(BDOS)バージョン番号の獲得
0007DE D557 212200          10      LD  HL,00022H
0007E1 D55A 7D               4      LD  A,L
0007E2 D55B C9              10      RET
                                
       D55C                     _SYS0D:     ;(BDOS)ディスクリセット
0007E3 D55C CDDFF0          17      CALL    _FFLUSH
0007E6 D55F E5              11      PUSH    HL
0007E7 D560 218000          10      LD  HL,00080H
0007EA D563 228AF0          16      LD  (_DTA),HL
0007ED D566 E1              10      POP HL
0007EE D567 D5              11      PUSH    DE
0007EF D568 1E00             7      LD  E,0
0007F1 D56A 3E                      DB  03EH
                                
       D56B                     _SYS0E:     ;(BDOS)カレントドライブの設定
0007F2 D56B D5              11      PUSH    DE
0007F3 D56C 7B               4      LD  A,E
0007F4 D56D DDE5            15      PUSH    IX
0007F6 D56F CDDCF0          17      CALL    _GETDPB
0007F9 D572 DDE1            14      POP IX
0007FB D574 3804            12      JR  C,SX0E2
0007FD D576 7B               4      LD  A,E
0007FE D577 3287F0          13      LD  (_DVSW),A
       D57A                     SX0E2:
000801 D57A D1              10      POP DE
000802 D57B C9              10      RET
                                
       D57C                     _SYS0F:     ;(BDOS)ファイルのオープン
000803 D57C CD1EDD          17      CALL    SETDRV
000806 D57F FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000809 D582 C602             7      ADD A,002H      ;Write
00080B D584 2848            12      JR  Z,FEND0F
00080D D586 CD6CE0          17      CALL    CHKWILDX
                                
000810 D589 D43EDD          17      CALL    NC,SOPENX
       D58C                     _S16XX:
000813 D58C 3840            12      JR  C,FEND0F
                                                ;Directory location
000815 D58E 3A9FF0          13      LD  A,(_FILEN)
000818 D591 FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
00081B D594 3AA0F0          13      LD  A,(_DIRF)
00081E D597 FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
000821 D59A FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
000824 D59D FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
000827 D5A0 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
00082B D5A4 FDE5            15      PUSH    IY
00082D D5A6 D1              10      POP DE
00082E D5A7 13               6      INC DE
00082F D5A8 010B00          10      LD  BC,11
000832 D5AB EDB0                    LDIR
                                ;               Attribute
000834 D5AD 7E               7      LD  A,(HL)
000835 D5AE FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
000838 D5B1 110B00          10      LD  DE,11       ;Reserved
00083B D5B4 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
00083C D5B5 11EAF1          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
00083F D5B8 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D5BA                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
000841 D5BA 1A               7      LD  A,(DE)
000842 D5BB 13               6      INC DE
000843 D5BC 32C3D5          13      LD  (S16PAT+2),A
000846 D5BF 7E               7      LD  A,(HL)
000847 D5C0 23               6      INC HL
000848 D5C1 FD7700          19  S16PAT: LD  (IY+0),A
00084B D5C4 10F4            13      DJNZ    S16LOOP
                                
00084D D5C6 AF               4      XOR A
00084E D5C7 FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
000851 D5CA FD2272D6        20      LD  (OFCB+1),IY
       D5CE                     FEND0F:
000855 D5CE 1845            12      JR  FEND10
                                
       D5D0                     _SYS10:     ;(BDOS)ファイルのクローズ
000857 D5D0 CD1EDD          17      CALL    SETDRV
00085A D5D3 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
00085D D5D6 D6FE             7      SUB 0FEH
00085F D5D8 37               4      SCF
000860 D5D9 3F               4      CCF
000861 D5DA 2039            12      JR  NZ,FEND10
       D5DC                     _S10A:              ;Write
000863 D5DC FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000866 D5DF FD770F          19      LD  (IY+15),A
                                
000869 D5E2 FD341C          23      INC (IY+28)     ;0FEH->0FFH ;オープンモード
00086C D5E5 CD68E1          17      CALL    SETTMS
                                
00086F D5E8 FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000872 D5EB 32A0F0          13      LD  (_DIRF),A
000875 D5EE E67F             7      AND 07FH
000877 D5F0 3293E6          13      LD  (_SECPS+1),A
00087A D5F3 FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
00087D D5F6 FD561F          19      LD  D,(IY+31)
000880 D5F9 CD72DE          17      CALL    READ_DIR
000883 D5FC 3817            12      JR  C,FEND10
                                
000885 D5FE 3A9CDD          13  SDECM1: LD  A,(SDECPAT+1)   ;1セクタ辺りのディレクトリエントリ数
000888 D601 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
000889 D602 FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
00088C D605 6F               4      LD  L,A
00088D D606 2600             7      LD  H,0
00088F D608 29              11      ADD HL,HL       ;*2
000890 D609 29              11      ADD HL,HL       ;*4
000891 D60A 29              11      ADD HL,HL       ;*8
000892 D60B 29              11      ADD HL,HL       ;*16
000893 D60C 29              11      ADD HL,HL       ;*32
000894 D60D ED4B7EF1        20      LD  BC,(_DTBUF)
000898 D611 09              11      ADD HL,BC
                                
000899 D612 CD7CE0          17      CALL    SDIRENT
       D615                     FEND10:
00089C D615 1842            12      JR  FEND
                                
       D617                     _SYS11:     ;(BDOS)最初のファイルの検索
00089E D617 CD1EDD          17      CALL    SETDRV
0008A1 D61A CD6BDD          17      CALL    SOPEN
       D61D                     _S12X1:
0008A4 D61D 383A            12      JR  C,FEND
0008A6 D61F CD0BDE          17      CALL    SOPENE2
0008A9 D622 ED5B8AF0        20      LD  DE,(_DTA)
0008AD D626 3A88F0          13      LD  A,(_DRV)
0008B0 D629 3C               4      INC A
0008B1 D62A 12               7      LD  (DE),A
0008B2 D62B D5              11      PUSH    DE
0008B3 D62C 13               6      INC DE
0008B4 D62D 012000          10      LD  BC,32
0008B7 D630 EDB0                    LDIR
0008B9 D632 FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
0008BC D635 FD660F          19      LD  H,(IY+15)
0008BF D638 22F4F1          16      LD  (SCDIR),HL
0008C2 D63B 2A9AF0          16      LD  HL,(_FBPS)
0008C5 D63E 22F6F1          16      LD  (SFBPS),HL
0008C8 D641 2A9FF0          16      LD  HL,(_FILEN)
0008CB D644 7C               4      LD  A,H
0008CC D645 B7               4      OR  A
0008CD D646 2806            12      JR  Z,_S12DIR
0008CF D648 3A93E6          13      LD  A,(_SECPS+1)
0008D2 D64B F680             7      OR  080H
0008D4 D64D 67               4      LD  H,A
       D64E                     _S12DIR:
0008D5 D64E 22F8F1          16      LD  (SFNDF),HL  ;Directory position and Flags
0008D8 D651 E1              10      POP HL
0008D9 D652 1139F0          10      LD  DE,SFILE
0008DC D655 0E21             7      LD  C,33
       D657                     _S11B:
0008DE D657 EDB0                    LDIR
       D659                     FEND:
0008E0 D659 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D65A                     FENDE:
0008E1 D65A FDE1            14      POP IY
0008E3 D65C C1              10      POP BC
0008E4 D65D D1              10      POP DE
0008E5 D65E E1              10      POP HL
0008E6 D65F C9              10      RET
                                
       D660                     _SYS12:     ;(BDOS)次のファイルの検索
0008E7 D660 E5              11      PUSH    HL
0008E8 D661 D5              11      PUSH    DE
0008E9 D662 C5              11      PUSH    BC
0008EA D663 FDE5            15      PUSH    IY
0008EC D665 CDCFDD          17      CALL    NOPEN
0008EF D668 18B3            12      JR  _S12X1
                                
       D66A                     _S16K:
0008F1 D66A FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0008F4 D66D FEFD             7      CP  0FDH        ;Device(0FDH)
0008F6 D66F 37               4      SCF
0008F7 D670 C8              11      RET Z
                                
0008F8 D671 110000          10  OFCB:   LD  DE,0
0008FB D674 D5              11      PUSH    DE
0008FC D675 061A             7      LD  B,26        ;First cluster
       D677                     S16K1:
0008FE D677 13               6      INC DE
0008FF D678 23               6      INC HL
000900 D679 10FC            13      DJNZ    S16K1
                                
000902 D67B 1A               7      LD  A,(DE)
000903 D67C BE               7      CP  (HL)
000904 D67D 2013            12      JR  NZ,S16K2
000906 D67F 13               6      INC DE
000907 D680 23               6      INC HL
000908 D681 1A               7      LD  A,(DE)
000909 D682 BE               7      CP  (HL)
00090A D683 200D            12      JR  NZ,S16K2
                                
00090C D685 E1              10      POP HL
00090D D686 FDE5            15      PUSH    IY
00090F D688 D1              10      POP DE
000910 D689 1A               7      LD  A,(DE)      ;Drive
000911 D68A BE               7      CP  (HL)
000912 D68B 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
000914 D68D ED52            15      SBC HL,DE       ;CP HL,DE
000916 D68F 37               4      SCF
000917 D690 C0              11      RET NZ
000918 D691 E5              11      PUSH    HL
       D692                     S16K2:
000919 D692 E1              10      POP HL
       D693                     S16K3:
00091A D693 FDE5            15      PUSH    IY
00091C D695 D1              10      POP DE
       D696                     _SYS13:     ;(BDOS)ファイルの削除
00091D D696 CD1EDD          17      CALL    SETDRV
000920 D699 CD9CDF          17      CALL    KILL
       D69C                     FEND13:
000923 D69C 18BB            12      JR  FEND
                                
       D69E                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000925 D69E CD1EDD          17      CALL    SETDRV
000928 D6A1 CDD4E1          17      CALL    INIT_SEQ
       D6A4                     SREAD:
00092B D6A4 CD1CE2          17      CALL    RB_READ
                                
00092E D6A7 C601             7      ADD A,001H
000930 D6A9 38AE            12      JR  C,FEND
                                
000932 D6AB 7D               4      LD  A,L
000933 D6AC D601             7      SUB 001H
       D6AE                     FENDX:
000935 D6AE 9F               4      SBC A,A
000936 D6AF E603             7      AND 3
000938 D6B1 1F               4      RRA
000939 D6B2 18A6            12      JR  FENDE
                                
       D6B4                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
00093B D6B4 CD1EDD          17      CALL    SETDRV
00093E D6B7 CDD4E1          17      CALL    INIT_SEQ
       D6BA                     SWRITE:
000941 D6BA CD15E2          17      CALL    RB_WRITE
                                
000944 D6BD C6FF             7      ADD A,0FFH
000946 D6BF 18ED            12      JR  FENDX
                                
       D6C1                     _SYS17:     ;(BDOS)ファイル名の変更
000948 D6C1 CD1EDD          17      CALL    SETDRV
00094B D6C4 CDF2DF          17      CALL    NAME
00094E D6C7 18D3            12      JR  FEND13
                                
       D6C9                     _SYS16:     ;(BDOS)ファイルの作成
000950 D6C9 CD1EDD          17      CALL    SETDRV
                                
000953 D6CC CD6CE0          17      CALL    CHKWILDX
000956 D6CF 38CB            12      JR  C,FEND13
000958 D6D1 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
00095B D6D4 FE05             7      CP  5
00095D D6D6 2805            12      JR  Z,_S16X2
00095F D6D8 FE21             7      CP  021H
000961 D6DA DA9CD6          10      JP  C,FEND13
       D6DD                     _S16X2:
                                ;               Clear FCB
000964 D6DD FDE5            15      PUSH    IY
000966 D6DF E1              10      POP HL
000967 D6E0 011000          10      LD  BC,16
00096A D6E3 09              11      ADD HL,BC
       D6E4                     _S16X1:
00096B D6E4 70               7      LD  (HL),B      ;B=0
00096C D6E5 23               6      INC HL
00096D D6E6 0D               4      DEC C
00096E D6E7 20FB            12      JR  NZ,_S16X1
                                
000970 D6E9 CD6DE1          17      CALL    SETTMSX
000973 D6EC FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000977 D6F0 CD3EDD          17      CALL    SOPENX
00097A D6F3 3F               4      CCF
00097B D6F4 CC6AD6          17      CALL    Z,_S16K
00097E D6F7 D41CDE          17      CALL    NC,COPEN
000981 D6FA D47CE0          17      CALL    NC,SDIRENT
000984 D6FD C38CD5          10      JP  _S16XX
                                
       D700                     _SYS21:     ;(BDOS)ランダムな読み出し
000987 D700 CD1EDD          17      CALL    SETDRV
00098A D703 CDB8E1          17      CALL    INIT_RND
00098D D706 189C            12      JR  SREAD
                                
       D708                     _SYS22:     ;(BDOS)ランダムな書き込み
       D708                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
00098F D708 CD1EDD          17      CALL    SETDRV
000992 D70B CDB8E1          17      CALL    INIT_RND
000995 D70E 18AA            12      JR  SWRITE
                                
       D710                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000997 D710 21FF00          10      LD  HL,000FFH
00099A D713 AF               4      XOR A
00099B D714 C9              10      RET
                                
       D715                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
00099C D715 3A87F0          13      LD  A,(_DVSW)
00099F D718 A7               4      AND A
0009A0 D719 C9              10      RET
                                
       D71A                     _SYS1A:     ;(BDOS)DTAの設定
0009A1 D71A ED538AF0        20      LD  (_DTA),DE
0009A5 D71E AF               4      XOR A
0009A6 D71F C9              10      RET
                                
       D720                     _SYS1B:     ;(BDOS)ディスク情報の獲得
0009A7 D720 7B               4      LD  A,E
0009A8 D721 CD31DD          17      CALL    GETDRV
0009AB D724 CDDCF0          17      CALL    _GETDPB
0009AE D727 D4E2F0          17      CALL    NC,_RDFATX
0009B1 D72A 210000          10      LD  HL,0
0009B4 D72D D446E1          17      CALL    NC,DSKF
                                
0009B7 D730 ED5B47E1        20      LD  DE,(MAXCLP+1)   ;DPB_08_MAXCL-1
0009BB D734 1B               6      DEC DE      ;DE←クラスタの総数
0009BC D735 FD2A7CF1        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
0009C0 D739 9F               4      SBC A,A
0009C1 D73A D8              11      RET C
0009C2 D73B 4F               4      LD  C,A     ;C=0
0009C3 D73C DD7E0F          19      LD  A,(IX+00FH) ;DPB_0F_BPS
0009C6 D73F E60F             7      AND 00FH
0009C8 D741 47               4      LD  B,A
0009C9 D742 DD7E07          19      LD  A,(IX+7)    ;DPB_07_SECPCL
0009CC D745 C9              10      RET
                                
       D746                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
0009CD D746 AF               4      XOR A
0009CE D747 67               4      LD  H,A
0009CF D748 6F               4      LD  L,A
0009D0 D749 C9              10      RET
                                
       D74A                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
0009D1 D74A 2100F2          10      LD  HL,DEVICE
0009D4 D74D 7B               4      LD  A,E
0009D5 D74E C3DCF0          10      JP  _GETDPB
                                
       D751                     _SYS23:     ;(BDOS)ファイルサイズの獲得
0009D8 D751 E5              11      PUSH    HL
0009D9 D752 2A1EF1          16      LD  HL,(STABLE+2*00FH)  ;ファイルのオープン
0009DC D755 CD0F00          17      CALL    JP_HL
0009DF D758 381B            12      JR  C,_S23X1
                                
0009E1 D75A D5              11      PUSH    DE      ;EX DE,IY
0009E2 D75B FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
0009E4 D75D FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
0009E7 D760 FD6E11          19      LD  L,(IY+17)   ;
0009EA D763 FD6612          19      LD  H,(IY+18)   ;
0009ED D766 C5              11      PUSH    BC      ;
0009EE D767 FD4613          19      LD  B,(IY+19)   ;
0009F1 D76A CDAAE1          17      CALL    GET_CPM_R_SIZE
0009F4 D76D C1              10      POP BC
       D76E                     _S24X1:
0009F5 D76E CDCAE1          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
0009F8 D771 FDE3            23      EX  (SP),IY     ;
0009FA D773 D1              10      POP DE      ;
                                
0009FB D774 AF               4      XOR A
       D775                     _S23X1:
0009FC D775 E1              10      POP HL
0009FD D776 C9              10      RET
                                
       D777                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
0009FE D777 E5              11      PUSH    HL
0009FF D778 D5              11      PUSH    DE      ;EX DE,IY
000A00 D779 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000A02 D77B CDDCE1          17      CALL    GETSEQ
000A05 D77E 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D780                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000A07 D780 C5              11      PUSH    BC
000A08 D781 E5              11      PUSH    HL
000A09 D782 CD35DC          17      CALL    FILE
000A0C D785 E1              10      POP HL
000A0D D786 C1              10      POP BC
       D787                     S29X1:
000A0E D787 C5              11      PUSH    BC
000A0F D788 D5              11      PUSH    DE
000A10 D789 E5              11      PUSH    HL
000A11 D78A EB               4      EX  DE,HL
000A12 D78B AF               4      XOR A
000A13 D78C 3221F0          13      LD  (FDRV+13),A
000A16 D78F 2114F0          10      LD  HL,FDRV
000A19 D792 011000          10      LD  BC,16
000A1C D795 EDB0                    LDIR
000A1E D797 E1              10      POP HL
000A1F D798 D1              10      POP DE
000A20 D799 C1              10      POP BC
000A21 D79A C9              10      RET
                                
       D79B                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
000A22 D79B C5              11      PUSH    BC
000A23 D79C 012DE8          10      LD  BC,DWT24B
000A26 D79F 1804            12      JR  S2FX
       D7A1                     _SYS2F:
000A28 D7A1 C5              11      PUSH    BC
000A29 D7A2 011DE8          10      LD  BC,DRD24B
       D7A5                     S2FX:
000A2C D7A5 ED43BBD7        20      LD  (S2FPAT+1),BC
000A30 D7A9 CDDFF0          17      CALL    _FFLUSH
                                
000A33 D7AC D5              11      PUSH    DE
000A34 D7AD E5              11      PUSH    HL
000A35 D7AE 7D               4      LD  A,L     ;Drive
000A36 D7AF CDD9F0          17      CALL    _CHGDRV
000A39 D7B2 3809            12      JR  C,S30X2
000A3B D7B4 44               4      LD  B,H     ;Number of clusters
000A3C D7B5 2A8AF0          16      LD  HL,(_DTA)
                                
000A3F D7B8 0E00             7      LD  C,0
000A41 D7BA CD1DE8          17  S2FPAT: CALL    DRD24B
       D7BD                     S30X2:
000A44 D7BD E1              10      POP HL
000A45 D7BE D1              10      POP DE
000A46 D7BF C1              10      POP BC
000A47 D7C0 9F               4      SBC A,A
000A48 D7C1 C9              10      RET
                                
       D7C2                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
000A49 D7C2 C5              11      PUSH    BC
000A4A D7C3 D5              11      PUSH    DE
000A4B D7C4 E5              11      PUSH    HL
000A4C D7C5 CD2ADC          17      CALL    FILEC
000A4F D7C8 210000          10      LD  HL,0
000A52 D7CB 1114F0          10      LD  DE,FDRV
000A55 D7CE 2A4EF1          16      LD  HL,(STABLE+2*027H)  ;ランダムブロック読み込み
000A58 D7D1 CD0F00          17      CALL    JP_HL
000A5B D7D4 18E7            12      JR  S30X2
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "M7IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                
       D540                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D540                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D540                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D540                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D540                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D540                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
       D7D6                     ARWKEY:
000A5D D7D6 3D               4      DEC A
000A5E D7D7 32E9D7          13      LD  (KEYAR),A
000A61 D7DA 181D            12      JR  INT8253E
       D7DC                     SETKEY1:
000A63 D7DC 3A95F0          13      LD  A,(_KEYSP+1)
000A66 D7DF 180C            12      JR  SETKEY
       D7E1                     INT8253:
000A68 D7E1 CDBCDB          17      CALL    CHKEY
       D7E5                     KEYDT   EQU $+1
000A6B D7E4 FE00             7      CP  0
000A6D D7E6 20F4            12      JR  NZ,SETKEY1
       D7E9                     KEYAR   EQU $+1
000A6F D7E8 3E00             7      LD  A,0
000A71 D7EA B7               4      OR  A
000A72 D7EB 20E9            12      JR  NZ,ARWKEY
       D7ED                     SETKEY:
000A74 D7ED 32E9D7          13      LD  (KEYAR),A
000A77 D7F0 3A92F0          13      LD  A,(_KEYD)
000A7A D7F3 32E5D7          13      LD  (KEYDT),A
000A7D D7F6 CDFCD7          17      CALL    KEYSET
       D7F9                     INT8253E:
000A80 D7F9 F1              10      POP AF
000A81 D7FA FB               4      EI
000A82 D7FB C9              10      RET
       D7FC                     KEYSET:
       D7FC                     KEYBS:
000A83 D7FC B7               4      OR  A
000A84 D7FD C8              11      RET Z
       D7FE                     KEYBS1:
000A85 D7FE CD14D8          17      CALL    KEYBC_IFBREAK
000A88 D801 E5              11      PUSH    HL
000A89 D802 F5              11      PUSH    AF
000A8A D803 2A90F0          16      LD  HL,(_KEYPS)
000A8D D806 2C               4      INC L
000A8E D807 7D               4      LD  A,L
000A8F D808 BC               4      CP  H
000A90 D809 2815            12      JR  Z,POP_AF_HL_SCF_RET
000A92 D80B 3290F0          13      LD  (_KEYPS),A
000A95 D80E 26FF             7      LD  H,KEYBF/256
000A97 D810 F1              10      POP AF
000A98 D811 77               7      LD  (HL),A
000A99 D812 E1              10      POP HL
000A9A D813 C9              10      RET
       D814                     KEYBC_IFBREAK:
000A9B D814 FE03             7      CP  3
000A9D D816 C0              11      RET NZ
       D817                     KEYBC:
000A9E D817 E5              11      PUSH    HL
000A9F D818 210000          10      LD  HL,0
000AA2 D81B 2290F0          16      LD  (_KEYPS),HL
000AA5 D81E E1              10      POP HL
000AA6 D81F C9              10      RET
                                
       D820                     POP_AF_HL_SCF_RET:
000AA7 D820 F1              10      POP AF
000AA8 D821 E1              10      POP HL
000AA9 D822 37               4      SCF
000AAA D823 C9              10      RET
                                
       D824                     _SYS01:     ;(BDOS)コンソール入力
000AAB D824 CD09F0          17      CALL    _SYS07
       D827                     MSG_A:
000AAE D827 F5              11      PUSH    AF
000AAF D828 D5              11      PUSH    DE
000AB0 D829 5F               4      LD  E,A
000AB1 D82A CD30D8          17      CALL    _SYS02
000AB4 D82D D1              10      POP DE
000AB5 D82E F1              10      POP AF
000AB6 D82F C9              10      RET
                                
       D830                     _SYS02:     ;(BDOS)コンソール出力
000AB7 D830 CD42D8          17      CALL    BREAK
000ABA D833 1805            12      JR  PRINTX
                                
       D835                     _SYS06:     ;(BDOS)コンソール直接入出力
000ABC D835 7B               4      LD  A,E
000ABD D836 3C               4      INC A
000ABE D837 CACAF0          10      JP  Z,_INKEY
       D83A                     PRINTX:
000AC1 D83A C3CDF0          10      JP  _PRINT
                                
       D83D                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000AC4 D83D CD09F0          17      CALL    _SYS07
000AC7 D840 1804            12      JR  BREAK1
       D842                     BREAK:
000AC9 D842 FB               4      EI
000ACA D843 3A92F0          13      LD  A,(_KEYD)
       D846                     BREAK1:
000ACD D846 FE03             7      CP  3       ;CTRL+C
000ACF D848 CA00F0          10      JP  Z,CPM_BOOT
000AD2 D84B FE13             7      CP  013H        ;CTRL+S
000AD4 D84D C0              11      RET NZ
                                
       D84E                     PAUSE:
000AD5 D84E CD17D8          17      CALL    KEYBC
                                
       D851                     FLGET:
000AD8 D851 CDDFF0          17      CALL    _FFLUSH
000ADB D854 E5              11      PUSH    HL
000ADC D855 2A8EF0          16      LD  HL,(_TXADR)
000ADF D858 7C               4      LD  A,H
000AE0 D859 C6D0             7      ADD A,0D0H
000AE2 D85B 67               4      LD  H,A
000AE3 D85C CD37CF          17      CALL    RDMMIO
000AE6 D85F 3274D8          13      LD  (FLSMC),A
       D862                     FLGET1:
000AE9 D862 CD2DCF          17      CALL    RD556VSYNC
000AEC D865 CB77             8      BIT 6,A
000AEE D867 3EEF             7      LD  A,0EFH      ;カーソル
000AF0 D869 200A            12      JR  NZ,FLGET2
000AF2 D86B 3A92F0          13      LD  A,(_KEYD)
000AF5 D86E B7               4      OR  A
000AF6 D86F 3EEF             7      LD  A,0EFH      ;カーソル
000AF8 D871 2002            12      JR  NZ,FLGET2
       D874                     FLSMC   EQU $+1
000AFA D873 3E00             7      LD  A,0     ;自己書き換え
       D875                     FLGET2:
000AFC D875 CD3FCF          17      CALL    WRMMIO
000AFF D878 CDCAF0          17      CALL    _INKEY
000B02 D87B 28E5            12      JR  Z,FLGET1
000B04 D87D F5              11      PUSH    AF
000B05 D87E 3A74D8          13      LD  A,(FLSMC)
000B08 D881 CD3FCF          17      CALL    WRMMIO
000B0B D884 F1              10      POP AF
000B0C D885 E1              10      POP HL
000B0D D886 C9              10      RET
                                
       D887                     _SYS0A:     ;(BDOS)文字列入力
000B0E D887 C5              11      PUSH    BC
000B0F D888 E5              11      PUSH    HL
000B10 D889 D5              11      PUSH    DE
000B11 D88A CD1CDB          17      CALL    GETL
000B14 D88D 1120FF          10      LD  DE,KBUF
000B17 D890 E1              10      POP HL
000B18 D891 E5              11      PUSH    HL
000B19 D892 0E00             7      LD  C,0
000B1B D894 3004            12      JR  NC,SAX0
000B1D D896 23               6      INC HL
000B1E D897 23               6      INC HL
000B1F D898 1808            12      JR  SAX4
       D89A                     SAX0:
000B21 D89A 46               7      LD  B,(HL)
000B22 D89B 23               6      INC HL
       D89C                     SAX1:
000B23 D89C 23               6      INC HL
000B24 D89D 1A               7      LD  A,(DE)
000B25 D89E 13               6      INC DE
000B26 D89F B7               4      OR  A
000B27 D8A0 2004            12      JR  NZ,SAX2
       D8A2                     SAX4:
000B29 D8A2 360D            10      LD  (HL),00DH
000B2B D8A4 1804            12      JR  SAX3
       D8A6                     SAX2:
000B2D D8A6 77               7      LD  (HL),A
000B2E D8A7 0C               4      INC C
000B2F D8A8 10F2            13      DJNZ    SAX1
       D8AA                     SAX3:
000B31 D8AA D1              10      POP DE
000B32 D8AB 79               4      LD  A,C
000B33 D8AC 13               6      INC DE
000B34 D8AD 12               7      LD  (DE),A
000B35 D8AE 1B               6      DEC DE
000B36 D8AF E1              10      POP HL
000B37 D8B0 C1              10      POP BC
000B38 D8B1 A7               4      AND A
000B39 D8B2 C9              10      RET
                                
       D8B3                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000B3A D8B3 CD42D8          17      CALL    BREAK
000B3D D8B6 3A92F0          13      LD  A,(_KEYD)
000B40 D8B9 B7               4      OR  A
000B41 D8BA C8              11      RET Z
       D8BB                     CONSTX:
000B42 D8BB CDDFF0          17      CALL    _FFLUSH
000B45 D8BE E5              11      PUSH    HL
000B46 D8BF 2A90F0          16      LD  HL,(_KEYPS)
000B49 D8C2 7C               4      LD  A,H
000B4A D8C3 AD               4      XOR L
000B4B D8C4 E1              10      POP HL
000B4C D8C5 C6FF             7      ADD A,0FFH
000B4E D8C7 9F               4      SBC A,A
000B4F D8C8 C9              10      RET
                                
       D8C9                     _SYS2A:     ;(BDOS)日付の獲得
000B50 D8C9 AF               4      XOR A
000B51 D8CA 57               4      LD  D,A
000B52 D8CB 5F               4      LD  E,A
000B53 D8CC 67               4      LD  H,A
000B54 D8CD 6F               4      LD  L,A
000B55 D8CE C9              10      RET
                                
       D8CF                     _SYS2C:     ;(BDOS)時刻の獲得
000B56 D8CF AF               4      XOR A
000B57 D8D0 57               4      LD  D,A
000B58 D8D1 5F               4      LD  E,A
000B59 D8D2 67               4      LD  H,A
000B5A D8D3 6F               4      LD  L,A
000B5B D8D4 C9              10      RET
                                
       D8D5                     ESC1:
000B5C D8D5 7B               4      LD  A,E
000B5D D8D6 FE41             7      CP  'A'
000B5F D8D8 CACDD9          10      JP  Z,CTRL1E
000B62 D8DB FE42             7      CP  'B'
000B64 D8DD CADFDA          10      JP  Z,CTRL1F
000B67 D8E0 FE43             7      CP  'C'
000B69 D8E2 CAA0D9          10      JP  Z,CTRL1C
000B6C D8E5 FE44             7      CP  'D'
000B6E D8E7 CAC4D9          10      JP  Z,CTRL1D
000B71 D8EA FE45             7      CP  'E'
000B73 D8EC 2802            12      JR  Z,CT0CX
000B75 D8EE FE6A             7      CP  'j'
       D8F0                     CT0CX:
000B77 D8F0 CAC4DA          10      JP  Z,CTRL0C
000B7A D8F3 FE48             7      CP  'H'
000B7C D8F5 CA41DA          10      JP  Z,CTRL0B
000B7F D8F8 FE4A             7      CP  'J'
000B81 D8FA CAC7DA          10      JP  Z,CTRL06
000B84 D8FD FE4B             7      CP  'K'
000B86 D8FF CA13DA          10      JP  Z,CTRL05
000B89 D902 FE4C             7      CP  'L'
000B8B D904 CAF1DA          10      JP  Z,CTRL0E
000B8E D907 FE54             7      CP  'T'
000B90 D909 CA13DA          10      JP  Z,CTRL05
000B93 D90C FE78             7      CP  'x'
000B95 D90E 2804            12      JR  Z,ESC1X
000B97 D910 FE79             7      CP  'y'
000B99 D912 2002            12      JR  NZ,ESC1Y
       D914                     ESC1X:
000B9B D914 3601            10      LD  (HL),1
       D916                     ESC1Y:
000B9D D916 FE3D             7      CP  '='
000B9F D918 2804            12      JR  Z,ESC1W
000BA1 D91A FE59             7      CP  'Y'
000BA3 D91C 2002            12      JR  NZ,ESC1Z
       D91E                     ESC1W:
000BA5 D91E 3602            10      LD  (HL),2
       D920                     ESC1Z:
000BA7 D920 FE20             7      CP  020H
000BA9 D922 3802            12      JR  C,ESC1C
000BAB D924 87               4      ADD A,A
000BAC D925 D0              11      RET NC
       D926                     ESC1C:
000BAD D926 E1              10      POP HL
000BAE D927 1832            12      JR  ANK
                                
       D929                     ESC:
000BB0 D929 218CD9          10      LD  HL,PRINTE5
000BB3 D92C E5              11      PUSH    HL
000BB4 D92D 214FD9          10      LD  HL,ESCFLG
000BB7 D930 3600            10      LD  (HL),0
000BB9 D932 3D               4      DEC A
000BBA D933 28A0            12      JR  Z,ESC1
000BBC D935 3D               4      DEC A
000BBD D936 2009            12      JR  NZ,ESC2
000BBF D938 3603            10      LD  (HL),3
000BC1 D93A 7B               4      LD  A,E
000BC2 D93B D620             7      SUB 020H
000BC4 D93D 3244D9          13      LD  (ESCYP+1),A
000BC7 D940 C9              10      RET
       D941                     ESC2:
000BC8 D941 3D               4      DEC A
000BC9 D942 C0              11      RET NZ
000BCA D943 2600             7  ESCYP:  LD  H,0
000BCC D945 7B               4      LD  A,E
000BCD D946 D620             7      SUB 020H
000BCF D948 6F               4      LD  L,A
000BD0 D949 C3D6F0          10      JP  _LOC
                                
       D94C                     PRINT:
000BD3 D94C C5              11      PUSH    BC
000BD4 D94D E5              11      PUSH    HL
       D94F                     ESCFLG  EQU $+1
000BD5 D94E 3E00             7      LD  A,000H      ;自己書き換え
000BD7 D950 B7               4      OR  A
000BD8 D951 20D6            12      JR  NZ,ESC
                                
000BDA D953 3E1F             7      LD  A,01FH
000BDC D955 BB               4      CP  E
000BDD D956 3038            12      JR  NC,CTRL
       D958                     INSFLG  EQU $
000BDF D958 0199DA          10      LD  BC,INSERT   ;自己書き換え
       D95B                     ANK:
000BE2 D95B 3A96F0          13      LD  A,(_COLORF)
000BE5 D95E 4F               4      LD  C,A
000BE6 D95F 7B               4      LD  A,E
000BE7 D960 FE61             7      CP  'a'     ;英小文字
000BE9 D962 3806            12      JR  C,PRT1
000BEB D964 FE7B             7      CP  'z'+1
000BED D966 3002            12      JR  NC,PRT1
000BEF D968 CBF9             8      SET 7,C
       D96A                     PRT1:
000BF1 D96A FE86             7      CP  $86     ;ひらがな1(を－そ)
000BF3 D96C 3806            12      JR  C,PRT2
000BF5 D96E FEA0             7      CP  $A0
000BF7 D970 3002            12      JR  NC,PRT2
000BF9 D972 CBF9             8      SET 7,C
       D974                     PRT2:
000BFB D974 FEE0             7      CP  $E0     ;ひらがな2(たーん)
000BFD D976 3802            12      JR  C,PRT3
000BFF D978 CBF9             8      SET 7,C
       D97A                     PRT3:
000C01 D97A 2A8EF0          16      LD  HL,(_TXADR)
000C04 D97D 7C               4      LD  A,H
000C05 D97E C6D0             7      ADD A,0D0H
000C07 D980 67               4      LD  H,A
000C08 D981 42               4      LD  B,D
000C09 D982 16EE             7      LD  D,CD_TABLE/256
000C0B D984 1A               7      LD  A,(DE)
000C0C D985 50               4      LD  D,B
000C0D D986 CD57CF          17      CALL    IO_PRINT
000C10 D989 CDA0D9          17      CALL    CTRL1C
       D98C                     PRINTE5:
000C13 D98C E1              10      POP HL
000C14 D98D C1              10      POP BC
000C15 D98E AF               4      XOR A
000C16 D98F C9              10      RET
                                
       D990                     CTRL:
000C17 D990 7B               4      LD  A,E
000C18 D991 87               4      ADD A,A
000C19 D992 F680             7      OR  080H
000C1B D994 6F               4      LD  L,A
000C1C D995 26F1             7      LD  H,CTRLTB/256
000C1E D997 7E               7      LD  A,(HL)
000C1F D998 2C               4      INC L
000C20 D999 66               7      LD  H,(HL)
000C21 D99A 6F               4      LD  L,A
000C22 D99B CD0F00          17      CALL    JP_HL
000C25 D99E 18EC            12      JR  PRINTE5
                                
       D9A0                     CTRL1C:
000C27 D9A0 ED4B8EF0        20      LD  BC,(_TXADR)
000C2B D9A4 03               6      INC BC
       D9A5                     PRINTE3:
000C2C D9A5 2118FC          10      LD  HL,0-WIDTH*LINE
000C2F D9A8 A7               4      AND A
000C30 D9A9 ED4A            15      ADC HL,BC
       D9AB                     PRINTE8:
000C32 D9AB 2805            12      JR  Z,PRINT2
000C34 D9AD ED438EF0        20      LD  (_TXADR),BC
       D9B1                     CTRL00:
000C38 D9B1 C9              10      RET
                                
       D9B2                     PRINT2:
000C39 D9B2 CDF7DA          17      CALL    SCR
000C3C D9B5 21D8FF          10      LD  HL,0-WIDTH
000C3F D9B8 09              11      ADD HL,BC
       D9B9                     SET_TXADR_HL:
000C40 D9B9 228EF0          16      LD  (_TXADR),HL
000C43 D9BC C9              10      RET
                                
       D9BD                     CTRL08:
000C44 D9BD 3A58D9          13      LD  A,(INSFLG)
000C47 D9C0 FECD             7      CP  0CDH        ;CALL ????
000C49 D9C2 2823            12      JR  Z,CTRL02
       D9C4                     CTRL1D:
000C4B D9C4 2A8EF0          16      LD  HL,(_TXADR)
000C4E D9C7 7C               4      LD  A,H
000C4F D9C8 B5               4      OR  L
000C50 D9C9 C8              11      RET Z
000C51 D9CA 2B               6      DEC HL
000C52 D9CB 18EC            12      JR  SET_TXADR_HL
                                
       D9CD                     CTRL1E:
000C54 D9CD ED4B8EF0        20      LD  BC,(_TXADR)
000C58 D9D1 21D8FF          10      LD  HL,0-WIDTH
000C5B D9D4 09              11      ADD HL,BC
000C5C D9D5 D0              11      RET NC
000C5D D9D6 18E1            12      JR  SET_TXADR_HL
                                
       D9D8                     CTRL09:
000C5F D9D8 ED4B8EF0        20      LD  BC,(_TXADR)
000C63 D9DC 79               4      LD  A,C
000C64 D9DD E6F8             7      AND 0F8H
000C66 D9DF C608             7      ADD A,8
000C68 D9E1 4F               4      LD  C,A
000C69 D9E2 88               4      ADC A,B
000C6A D9E3 91               4      SUB C
000C6B D9E4 47               4      LD  B,A
000C6C D9E5 18BE            12      JR  PRINTE3
                                
       D9E7                     CTRL02:
000C6E D9E7 CDC4D9          17      CALL    CTRL1D
000C71 D9EA C8              11      RET Z
000C72 D9EB D5              11      PUSH    DE
000C73 D9EC CDD3F0          17      CALL    _POS
000C76 D9EF 54               4      LD  D,H
000C77 D9F0 3E28             7      LD  A,WIDTH
000C79 D9F2 95               4      SUB L
000C7A D9F3 4F               4      LD  C,A
000C7B D9F4 0D               4      DEC C
000C7C D9F5 06D0             7      LD  B,0D0H
000C7E D9F7 2A8EF0          16      LD  HL,(_TXADR)
000C81 D9FA 09              11      ADD HL,BC
000C82 D9FB 47               4      LD  B,A
                                
000C83 D9FC 3AB5DA          13      LD  A,(MULINE)
000C86 D9FF BA               4      CP  D
000C87 DA00 2007            12      JR  NZ,C02X1
000C89 DA02 112800          10      LD  DE,WIDTH
000C8C DA05 19              11      ADD HL,DE
000C8D DA06 78               4      LD  A,B
000C8E DA07 83               4      ADD A,E
000C8F DA08 47               4      LD  B,A
       DA09                     C02X1:
000C90 DA09 3A96F0          13      LD  A,(_COLORF) ;C:Color
000C93 DA0C 4F               4      LD  C,A
000C94 DA0D AF               4      XOR A       ;A:Text
000C95 DA0E CD9ECF          17      CALL    IO_BS
000C98 DA11 D1              10      POP DE
000C99 DA12 C9              10      RET
                                
       DA13                     CTRL05:
000C9A DA13 CDD3F0          17      CALL    _POS
000C9D DA16 3E28             7      LD  A,WIDTH
000C9F DA18 95               4      SUB L
000CA0 DA19 47               4      LD  B,A
       DA1A                     C08X1:
000CA1 DA1A 2A8EF0          16      LD  HL,(_TXADR)
000CA4 DA1D 7C               4      LD  A,H
000CA5 DA1E C6D0             7      ADD A,0D0H
000CA7 DA20 67               4      LD  H,A
       DA21                     CLLINE:
000CA8 DA21 3A96F0          13      LD  A,(_COLORF)
000CAB DA24 4F               4      LD  C,A
000CAC DA25 AF               4      XOR A
000CAD DA26 C381CF          10      JP  IO_CLLINE
                                
       DA29                     CTRL0D:
000CB0 DA29 CDD3F0          17      CALL    _POS
000CB3 DA2C 2E00             7      LD  L,0
       DA2E                     LOC:
000CB5 DA2E C5              11      PUSH    BC
000CB6 DA2F E5              11      PUSH    HL
000CB7 DA30 CD4EDA          17      CALL    LOC1
000CBA DA33 228EF0          16      LD  (_TXADR),HL
000CBD DA36 E1              10      POP HL
000CBE DA37 C1              10      POP BC
000CBF DA38 C9              10      RET
                                
       DA39                     CTRL12:
000CC0 DA39 2158D9          10      LD  HL,INSFLG
000CC3 DA3C 7E               7      LD  A,(HL)
000CC4 DA3D EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
000CC6 DA3F 77               7      LD  (HL),A
000CC7 DA40 C9              10      RET
                                
       DA41                     CTRL0B:
000CC8 DA41 210000          10      LD  HL,0
000CCB DA44 228EF0          16      LD  (_TXADR),HL
000CCE DA47 C9              10      RET
                                
       DA48                     CTRL1B:
000CCF DA48 3E01             7      LD  A,1
000CD1 DA4A 324FD9          13      LD  (ESCFLG),A
000CD4 DA4D C9              10      RET
                                
       DA4E                     LOC1:
000CD5 DA4E D5              11      PUSH    DE
000CD6 DA4F 4D               4      LD  C,L
000CD7 DA50 0608             7      LD  B,8
000CD9 DA52 5C               4      LD  E,H
000CDA DA53 210028          10      LD  HL,WIDTH*256
000CDD DA56 55               4      LD  D,L ;L=0
       DA57                     LOC2:
000CDE DA57 29              11      ADD HL,HL
000CDF DA58 3001            12      JR  NC,LOC3
000CE1 DA5A 19              11      ADD HL,DE
       DA5B                     LOC3:
000CE2 DA5B 10FA            13      DJNZ    LOC2
000CE4 DA5D 09              11      ADD HL,BC
000CE5 DA5E D1              10      POP DE
000CE6 DA5F C9              10      RET
                                
       DA60                     CONOUT1:
                                ;   CALL    CURSOR
000CE7 DA60 59               4      LD  E,C
000CE8 DA61 CDCDF0          17      CALL    _PRINT
000CEB DA64 7B               4      LD  A,E
000CEC DA65 FE0A             7      CP  00AH
000CEE DA67 2006            12      JR  NZ,CURSOR
000CF0 DA69 CD29DA          17      CALL    CTRL0D
000CF3 DA6C CD13DA          17      CALL    CTRL05
       DA6F                     CURSOR:
000CF6 DA6F C9              10      RET
                                
       DA70                     CTRL07:
000CF7 DA70 06E0             7      LD  B,0E0H
000CF9 DA72 2162F0          10      LD  HL,BEEPD+1
       DA75                     C07X0:
000CFC DA75 4E               7      LD  C,(HL)
000CFD DA76 23               6      INC HL
000CFE DA77 7E               7      LD  A,(HL)
000CFF DA78 23               6      INC HL
000D00 DA79 CD4FCF          17      CALL    WRMMIO_BC
000D03 DA7C 7D               4      LD  A,L
000D04 DA7D FE6A             7      CP  (BEEPD+1+M7BEEPE-M7BEEPD)&255
000D06 DA7F 20F4            12      JR  NZ,C07X0
000D08 DA81 0610             7      LD  B,16
       DA83                     C07X1:
000D0A DA83 CD2DCF          17      CALL    RD556VSYNC
000D0D DA86 87               4      ADD A,A
000D0E DA87 30FA            12      JR  NC,C07X1
       DA89                     C07X2:
000D10 DA89 CD2DCF          17      CALL    RD556VSYNC
000D13 DA8C 87               4      ADD A,A
000D14 DA8D 38FA            12      JR  C,C07X2
000D16 DA8F 10F2            13      DJNZ    C07X1
                                
000D18 DA91 AF               4      XOR A
000D19 DA92 2108E0          10      LD  HL,0E008H
000D1C DA95 CD3FCF          17      CALL    WRMMIO
000D1F DA98 C9              10      RET
                                
       DA99                     INSERT:
000D20 DA99 D5              11      PUSH    DE
000D21 DA9A CDD3F0          17      CALL    _POS
000D24 DA9D 54               4      LD  D,H
000D25 DA9E 3E28             7      LD  A,WIDTH
000D27 DAA0 95               4      SUB L
000D28 DAA1 47               4      LD  B,A
000D29 DAA2 2A8EF0          16      LD  HL,(_TXADR)
000D2C DAA5 7C               4      LD  A,H
000D2D DAA6 C6D0             7      ADD A,0D0H
000D2F DAA8 67               4      LD  H,A
000D30 DAA9 3A96F0          13      LD  A,(_COLORF) ;C:Color
000D33 DAAC 4F               4      LD  C,A
000D34 DAAD AF               4      XOR A       ;A:Text
000D35 DAAE CD91CF          17      CALL    IO_INS
000D38 DAB1 B7               4      OR  A
000D39 DAB2 2005            12      JR  NZ,INS1
       DAB5                     MULINE  EQU $+1
000D3B DAB4 3EFF             7      LD  A,-1
000D3D DAB6 92               4      SUB D
000D3E DAB7 2009            12      JR  NZ,INS2
       DAB9                     INS1:
000D40 DAB9 0628             7      LD  B,WIDTH
000D42 DABB CD91CF          17      CALL    IO_INS
000D45 DABE 7A               4      LD  A,D
000D46 DABF 32B5DA          13      LD  (MULINE),A
       DAC2                     INS2:
000D49 DAC2 D1              10      POP DE
000D4A DAC3 C9              10      RET
                                
       DAC4                     CTRL0C:
000D4B DAC4 CD41DA          17      CALL    CTRL0B
       DAC7                     CTRL06:
000D4E DAC7 D5              11      PUSH    DE
000D4F DAC8 E5              11      PUSH    HL
000D50 DAC9 ED5B8EF0        20      LD  DE,(_TXADR)
000D54 DACD 3A96F0          13      LD  A,(_COLORF)
000D57 DAD0 326ECF          13      LD  (ICSMC),A
000D5A DAD3 C362CF          10      JP  IO_CLR
                                
       DAD6                     CTRL04:
000D5D DAD6 CDD3F0          17      CALL    _POS
000D60 DAD9 7D               4      LD  A,L
000D61 DADA B7               4      OR  A
000D62 DADB C8              11      RET Z
       DADC                     CTRL03:
000D63 DADC CD29DA          17      CALL    CTRL0D
       DADF                     CTRL0A:
       DADF                     CTRL1F:
000D66 DADF 2A8EF0          16      LD  HL,(_TXADR)
000D69 DAE2 012800          10      LD  BC,WIDTH
000D6C DAE5 09              11      ADD HL,BC
000D6D DAE6 44               4      LD  B,H
000D6E DAE7 4D               4      LD  C,L
000D6F DAE8 2118FC          10      LD  HL,0-WIDTH*LINE
000D72 DAEB 09              11      ADD HL,BC
000D73 DAEC 3F               4      CCF
000D74 DAED 9F               4      SBC A,A
000D75 DAEE C3ABD9          10      JP  PRINTE8
                                
       DAF1                     CTRL0E:
000D78 DAF1 CDD3F0          17      CALL    _POS
000D7B DAF4 7C               4      LD  A,H
000D7C DAF5 1804            12      JR  SCR1
       DAF7                     SCR:
000D7E DAF7 3A97F0          13      LD  A,(_LINE)
000D81 DAFA 3D               4      DEC A
       DAFB                     SCR1:
000D82 DAFB C5              11      PUSH    BC
000D83 DAFC D5              11      PUSH    DE
000D84 DAFD E5              11      PUSH    HL
000D85 DAFE 1100D0          10      LD  DE,0D000H
000D88 DB01 2128D0          10      LD  HL,0D000H+WIDTH
                                
000D8B DB04 47               4      LD  B,A
000D8C DB05 B7               4      OR  A
000D8D DB06 C3B6CF          10      JP  IO_SCRUP
                                
       DB09                     POS:
000D90 DB09 2A8EF0          16      LD  HL,(_TXADR)
000D93 DB0C C5              11      PUSH    BC
000D94 DB0D 01D8FF          10      LD  BC,0-WIDTH
000D97 DB10 AF               4      XOR A
       DB11                     POS1:
000D98 DB11 09              11      ADD HL,BC
000D99 DB12 3C               4      INC A
000D9A DB13 38FC            12      JR  C,POS1
000D9C DB15 ED42            15      SBC HL,BC
000D9E DB17 3D               4      DEC A
000D9F DB18 67               4      LD  H,A
000DA0 DB19 C1              10      POP BC
000DA1 DB1A A7               4      AND A
000DA2 DB1B C9              10      RET
                                
       DB1C                     GETL:
000DA3 DB1C CDD3F0          17      CALL    _POS
000DA6 DB1F E5              11      PUSH    HL
000DA7 DB20 3ECD             7      LD  A,0CDH      ;CALL ????
000DA9 DB22 3258D9          13      LD  (INSFLG),A
       DB25                     GETL1:
000DAC DB25 CD3DD8          17      CALL    _SYS08
000DAF DB28 FE09             7      CP  9
000DB1 DB2A 2008            12      JR  NZ,GETL1V
000DB3 DB2C 2120FF          10      LD  HL,KBUF
000DB6 DB2F CD51D5          17      CALL    MSX
000DB9 DB32 18F1            12      JR  GETL1
       DB34                     GETL1V:
000DBB DB34 5F               4      LD  E,A
000DBC DB35 CDD3F0          17      CALL    _POS
000DBF DB38 CDCDF0          17      CALL    _PRINT
000DC2 DB3B 7B               4      LD  A,E
000DC3 DB3C FE20             7      CP  $20
000DC5 DB3E 3809            12      JR  C,GETL1V1
000DC7 DB40 7D               4      LD  A,L
000DC8 DB41 FE27             7      CP  WIDTH-1
000DCA DB43 2004            12      JR  NZ,GETL1V1
000DCC DB45 7C               4      LD  A,H
000DCD DB46 32B5DA          13      LD  (MULINE),A
       DB49                     GETL1V1:
000DD0 DB49 7B               4      LD  A,E
000DD1 DB4A FE0D             7      CP  00DH
000DD3 DB4C 20D7            12      JR  NZ,GETL1
000DD5 DB4E 3E01             7      LD  A,1     ;LD BC,????
000DD7 DB50 3258D9          13      LD  (INSFLG),A
000DDA DB53 1120FF          10      LD  DE,KBUF
000DDD DB56 0628             7      LD  B,WIDTH
000DDF DB58 CDA4D3          17      CALL    ZERO_MEMORY_DE
                                
000DE2 DB5B D1              10      POP DE
000DE3 DB5C CDD3F0          17      CALL    _POS
000DE6 DB5F 6B               4      LD  L,E
000DE7 DB60 3E28             7      LD  A,WIDTH
000DE9 DB62 95               4      SUB L
000DEA DB63 57               4      LD  D,A
                                
000DEB DB64 3AB5DA          13      LD  A,(MULINE)
000DEE DB67 94               4      SUB H
000DEF DB68 2806            12      JR  Z,GL2X
000DF1 DB6A 3C               4      INC A
000DF2 DB6B 200C            12      JR  NZ,GL3X
000DF4 DB6D 25               4      DEC H
000DF5 DB6E 1805            12      JR  GL4X
       DB70                     GL2X:
000DF7 DB70 3E1F             7      LD  A,$1F
000DF9 DB72 CD27D8          17      CALL    MSG_A
       DB75                     GL4X:
000DFC DB75 7A               4      LD  A,D
000DFD DB76 C628             7      ADD A,WIDTH
000DFF DB78 57               4      LD  D,A
       DB79                     GL3X:
000E00 DB79 CD4EDA          17      CALL    LOC1
000E03 DB7C 4D               4      LD  C,L
000E04 DB7D 7C               4      LD  A,H
000E05 DB7E C6D0             7      ADD A,0D0H
000E07 DB80 47               4      LD  B,A
000E08 DB81 5A               4      LD  E,D
000E09 DB82 2120FF          10      LD  HL,KBUF
       DB85                     GETL2:
000E0C DB85 CDD0F0          17      CALL    _SCRN
000E0F DB88 03               6      INC BC
000E10 DB89 77               7      LD  (HL),A
000E11 DB8A 23               6      INC HL
000E12 DB8B 1D               4      DEC E
000E13 DB8C 20F7            12      JR  NZ,GETL2
       DB8E                     GETL3:
000E15 DB8E 2B               6      DEC HL
000E16 DB8F 7E               7      LD  A,(HL)
000E17 DB90 FE21             7      CP  021H
000E19 DB92 D0              11      RET NC
000E1A DB93 3600            10      LD  (HL),0
000E1C DB95 15               4      DEC D
000E1D DB96 20F6            12      JR  NZ,GETL3
000E1F DB98 C9              10      RET
                                
       DB99                     INKEY:
000E20 DB99 FB               4      EI
000E21 DB9A E5              11      PUSH    HL
000E22 DB9B 2A90F0          16      LD  HL,(_KEYPS)
000E25 DB9E 7C               4      LD  A,H
000E26 DB9F AD               4      XOR L
000E27 DBA0 2809            12      JR  Z,INKEY1
000E29 DBA2 7C               4      LD  A,H
000E2A DBA3 3C               4      INC A
000E2B DBA4 3291F0          13      LD  (_KEYPS+1),A
000E2E DBA7 6F               4      LD  L,A
000E2F DBA8 26FF             7      LD  H,KEYBF/256
000E31 DBAA 7E               7      LD  A,(HL)
       DBAB                     INKEY1:
000E32 DBAB E1              10      POP HL
000E33 DBAC B7               4      OR  A
000E34 DBAD C9              10      RET
                                
       DBAE                     INKEYB:
000E35 DBAE C1              10      POP BC
000E36 DBAF CB47             8      BIT 0,A
000E38 DBB1 3E08             7      LD  A,8
000E3A DBB3 2002            12      JR  NZ,INKEYD
000E3C DBB5 3E03             7      LD  A,3
       DBB7                     INKEYD:
000E3E DBB7 B7               4      OR  A
000E3F DBB8 3292F0          13      LD  (_KEYD),A
000E42 DBBB C9              10      RET
       DBBC                     CHKEY:
000E43 DBBC C5              11      PUSH    BC
000E44 DBBD 3E08             7      LD  A,8
000E46 DBBF CD20CF          17      CALL    RDKEYDATA
000E49 DBC2 3293F0          13      LD  (_KEYD+1),A
000E4C DBC5 CB7F             8      BIT 7,A
000E4E DBC7 28E5            12      JR  Z,INKEYB
000E50 DBC9 E5              11      PUSH    HL
000E51 DBCA 0E07             7      LD  C,7
000E53 DBCC 2140ED          10      LD  HL,KEY_TABLE
000E56 DBCF CB47             8      BIT 0,A
000E58 DBD1 2003            12      JR  NZ,CHKEY0
000E5A DBD3 2180ED          10      LD  HL,SHIFT_TABLE
       DBD6                     CHKEY0:
000E5D DBD6 CB77             8      BIT 6,A
000E5F DBD8 2003            12      JR  NZ,CHKEY1
000E61 DBDA 21C0ED          10      LD  HL,CTRL_TABLE
       DBDD                     CHKEY1:
000E64 DBDD 79               4      LD  A,C
000E65 DBDE CD20CF          17      CALL    RDKEYDATA
000E68 DBE1 0608             7      LD  B,8
       DBE3                     CHKEY2:
000E6A DBE3 87               4      ADD A,A
000E6B DBE4 3009            12      JR  NC,CHKEY3
000E6D DBE6 23               6      INC HL
000E6E DBE7 10FA            13      DJNZ    CHKEY2
000E70 DBE9 0D               4      DEC C
000E71 DBEA 79               4      LD  A,C
000E72 DBEB 3C               4      INC A
000E73 DBEC 20EF            12      JR  NZ,CHKEY1
000E75 DBEE 06                      DB  $06     ;LD B,?? 次の1バイトを飛ばす
       DBEF                     CHKEY3:
000E76 DBEF 7E               7      LD  A,(HL)
000E77 DBF0 E1              10      POP HL
000E78 DBF1 C1              10      POP BC
000E79 DBF2 18C3            12      JR  INKEYD
                                
       DBF4                     SCRN:
000E7B DBF4 E5              11      PUSH    HL
000E7C DBF5 CD47CF          17      CALL    RDMMIO_BC
000E7F DBF8 6F               4      LD  L,A
000E80 DBF9 26EF             7      LD  H,DC_TABLE/256
000E82 DBFB 7E               7      LD  A,(HL)
000E83 DBFC FE41             7      CP  'A'     ;英小文字チェック
000E85 DBFE 380E            12      JR  C,SCRN1
000E87 DC00 FE5B             7      CP  'Z'+1
000E89 DC02 DC10DC          17      CALL    C,SCRNC
000E8C DC05 FEA6             7      CP  $A6     ;ひらがなチェック
000E8E DC07 3805            12      JR  C,SCRN1
000E90 DC09 FEE0             7      CP  $E0
000E92 DC0B DC10DC          17      CALL    C,SCRNC
       DC0E                     SCRN1:
000E95 DC0E E1              10      POP HL
000E96 DC0F C9              10      RET
                                
       DC10                     SCRNC:
000E97 DC10 6F               4      LD  L,A
000E98 DC11 60               4      LD  H,B
000E99 DC12 CBD8             8      SET 3,B
000E9B DC14 CD47CF          17      CALL    RDMMIO_BC
000E9E DC17 44               4      LD  B,H
000E9F DC18 CB7F             8      BIT 7,A
000EA1 DC1A 7D               4      LD  A,L
000EA2 DC1B C8              11      RET Z
000EA3 DC1C FE5B             7      CP  'Z'+1
000EA5 DC1E 3804            12      JR  C,SCRNC_ADD
000EA7 DC20 FEC0             7      CP  $C0
000EA9 DC22 3803            12      JR  C,SCRNC_SUB
       DC24                     SCRNC_ADD:
000EAB DC24 C620             7      ADD A,$20
000EAD DC26 C9              10      RET
       DC27                     SCRNC_SUB:
000EAE DC27 D620             7      SUB $20
000EB0 DC29 C9              10      RET
[EOF:M7IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
       DC2A                     FILEC:
000EB1 DC2A CD35DC          17      CALL    FILE
       DC2D                     FILEC2:
000EB4 DC2D 3A15F0          13      LD  A,(FDRV+1)
000EB7 DC30 FE20             7      CP  020H
000EB9 DC32 C8              11      RET Z
000EBA DC33 1839            12      JR  SETDIR1
                                
       DC35                     FILE:
000EBC DC35 AF               4      XOR A
000EBD DC36 3214F0          13      LD  (FDRV),A
000EC0 DC39 67               4      LD  H,A
000EC1 DC3A 6F               4      LD  L,A
000EC2 DC3B 2222F0          16      LD  (FDRV+14),HL
000EC5 DC3E CD0CDD          17      CALL    SPCUT
000EC8 DC41 CDF1DC          17      CALL    CCHK3
000ECB DC44 2812            12      JR  Z,DEVI1
000ECD DC46 13               6      INC DE
000ECE DC47 1A               7      LD  A,(DE)
000ECF DC48 1B               6      DEC DE
000ED0 DC49 FE3A             7      CP  ':'
000ED2 DC4B 200B            12      JR  NZ,DEVI1
000ED4 DC4D 1A               7      LD  A,(DE)      ;DRIVE
000ED5 DC4E CD41DF          17      CALL    CAP
000ED8 DC51 D640             7      SUB '@'
000EDA DC53 13               6      INC DE
000EDB DC54 13               6      INC DE
000EDC DC55 3214F0          13      LD  (FDRV),A
       DC58                     DEVI1:
000EDF DC58 1A               7      LD  A,(DE)
000EE0 DC59 D65C             7      SUB 05CH        ;\
000EE2 DC5B 2009            12      JR  NZ,NOROOT
000EE4 DC5D 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
000EE5 DC5E 222EF0          16      LD  (FDRV+26),HL
000EE8 DC61 2C               4      INC L
000EE9 DC62 2222F0          16      LD  (FDRV+14),HL
000EEC DC65 13               6      INC DE
       DC66                     NOROOT:
                                
       DC66                     SETDIR:
000EED DC66 CD92DC          17      CALL    FILED
000EF0 DC69 1A               7      LD  A,(DE)
000EF1 DC6A FE5C             7      CP  05CH        ;\
000EF3 DC6C C0              11      RET NZ
000EF4 DC6D 13               6      INC DE
       DC6E                     SETDIR1:
000EF5 DC6E 3E10             7      LD  A,010H      ;Directory
000EF7 DC70 3221F0          13      LD  (FDRV+13),A
000EFA DC73 D5              11      PUSH    DE
000EFB DC74 1114F0          10      LD  DE,FDRV
000EFE DC77 2A1EF1          16      LD  HL,(STABLE+2*00FH)
000F01 DC7A CD0F00          17      CALL    JP_HL
000F04 DC7D D1              10      POP DE
000F05 DC7E B7               4      OR  A
000F06 DC7F C0              11      RET NZ
                                
000F07 DC80 3A21F0          13      LD  A,(FDRV+13)
000F0A DC83 CB67             8      BIT 4,A
000F0C DC85 C8              11      RET Z
                                
000F0D DC86 CDD9DC          17      CALL    FILEI
000F10 DC89 2A2EF0          16      LD  HL,(FDRV+26)
000F13 DC8C 23               6      INC HL
000F14 DC8D 2222F0          16      LD  (FDRV+14),HL
000F17 DC90 18D4            12      JR  SETDIR
                                
       DC92                     FILED:
000F19 DC92 CDD9DC          17      CALL    FILEI
000F1C DC95 2115F0          10      LD  HL,FNAME
                                
000F1F DC98 0608             7      LD  B,8
       DC9A                     FILE2:
000F21 DC9A CDE6DC          17      CALL    CCHKF
000F24 DC9D C8              11      RET Z
000F25 DC9E FE2A             7      CP  '*'
000F27 DCA0 282E            12      JR  Z,FILE9
000F29 DCA2 FE2E             7      CP  '.'
000F2B DCA4 280C            12      JR  Z,FILE4
000F2D DCA6 77               7      LD  (HL),A
000F2E DCA7 23               6      INC HL
000F2F DCA8 10F0            13      DJNZ    FILE2
                                
       DCAA                     FILE3:
000F31 DCAA CDE6DC          17      CALL    CCHKF
000F34 DCAD C8              11      RET Z
000F35 DCAE FE2E             7      CP  '.'
000F37 DCB0 20F8            12      JR  NZ,FILE3
                                
       DCB2                     FILE4:
000F39 DCB2 211DF0          10      LD  HL,FNAME+8
000F3C DCB5 0603             7      LD  B,3
                                
       DCB7                     FILE4L:
000F3E DCB7 CDE6DC          17      CALL    CCHKF
000F41 DCBA C8              11      RET Z
000F42 DCBB FE2E             7      CP  '.'
000F44 DCBD 2008            12      JR  NZ,FILE12
000F46 DCBF 3215F0          13      LD  (FNAME),A   ;Parent directory(..)
000F49 DCC2 3216F0          13      LD  (FNAME+1),A
000F4C DCC5 3E20             7      LD  A,020H
       DCC7                     FILE12:
000F4E DCC7 FE2A             7      CP  '*'
000F50 DCC9 280A            12      JR  Z,FILE10
000F52 DCCB 77               7      LD  (HL),A
000F53 DCCC 23               6      INC HL
000F54 DCCD 10E8            13      DJNZ    FILE4L
000F56 DCCF C9              10      RET
                                
       DCD0                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000F57 DCD0 CDD5DC          17      CALL    FILE10
000F5A DCD3 18D5            12      JR  FILE3
                                
       DCD5                     FILE10:
000F5C DCD5 3E3F             7      LD  A,'?'
000F5E DCD7 1808            12      JR  FILL_MEMORY
       DCD9                     FILEI:              ;名前＋拡張子をスペースで初期化
000F60 DCD9 3E20             7      LD  A,020H
000F62 DCDB 01000B          10      LD  BC,11*256   ;C=0にしておく
000F65 DCDE 2115F0          10      LD  HL,FNAME
       DCE1                     FILL_MEMORY:            ;HLからBバイトAで埋める
000F68 DCE1 77               7      LD  (HL),A
000F69 DCE2 23               6      INC HL
000F6A DCE3 10FC            13      DJNZ    FILL_MEMORY
000F6C DCE5 C9              10      RET
                                
       DCE6                     CCHKF:
000F6D DCE6 1A               7      LD  A,(DE)
000F6E DCE7 CDEEDC          17      CALL    CCHK2
000F71 DCEA C8              11      RET Z
000F72 DCEB C359E0          10      JP  FKAN
                                
       DCEE                     CCHK2:
000F75 DCEE 0C               4      INC C
000F76 DCEF 0D               4      DEC C
000F77 DCF0 C0              11      RET NZ
       DCF1                     CCHK3:              ;ZF=1 で使えない文字
000F78 DCF1 FE2B             7      CP  '+'
000F7A DCF3 C8              11      RET Z
000F7B DCF4 FE2C             7      CP  ','
000F7D DCF6 C8              11      RET Z
000F7E DCF7 FE2F             7      CP  '/'
000F80 DCF9 C8              11      RET Z
000F81 DCFA FE3A             7      CP  ':'
000F83 DCFC C8              11      RET Z
000F84 DCFD FE3B             7      CP  ';'
000F86 DCFF C8              11      RET Z
000F87 DD00 FE3D             7      CP  '='
000F89 DD02 C8              11      RET Z
000F8A DD03 FE5C             7      CP  05CH    ;\
000F8C DD05 C8              11      RET Z
000F8D DD06 FE20             7      CP  020H
000F8F DD08 D0              11      RET NC
000F90 DD09 BF               4      CP  A       ;Z=1
000F91 DD0A C9              10      RET
                                
       DD0B                     SS1:
000F92 DD0B 13               6      INC DE
       DD0C                     SPCUT:              ;スペースをカット
000F93 DD0C 1A               7      LD  A,(DE)
000F94 DD0D FE20             7      CP  020H
000F96 DD0F 28FA            12      JR  Z,SS1
000F98 DD11 C9              10      RET
                                
       DD12                     SETDRVF:
000F99 DD12 1114F0          10      LD  DE,FDRV
       DD15                     SETDRV0:
000F9C DD15 CD1EDD          17      CALL    SETDRV
000F9F DD18 FDE1            14      POP IY
000FA1 DD1A C1              10      POP BC
000FA2 DD1B D1              10      POP DE
000FA3 DD1C E1              10      POP HL
000FA4 DD1D C9              10      RET
                                
       DD1E                     SETDRV:
000FA5 DD1E E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
000FA6 DD1F D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
000FA7 DD20 C5              11      PUSH    BC
000FA8 DD21 1A               7      LD  A,(DE)
000FA9 DD22 D5              11      PUSH    DE
000FAA DD23 FDE3            23      EX  (SP),IY
                                
000FAC DD25 CD31DD          17      CALL    GETDRV
000FAF DD28 3C               4      INC A
000FB0 DD29 FD7700          19      LD  (IY+0),A    ;(FCB)ドライブ番号
000FB3 DD2C 3D               4      DEC A
000FB4 DD2D CDD9F0          17      CALL    _CHGDRV
                                
000FB7 DD30 E9               4      JP  (HL)
                                
       DD31                     GETDRV:
000FB8 DD31 E67F             7      AND 07FH
000FBA DD33 D601             7      SUB 001H
000FBC DD35 3003            12      JR  NC,GETDRV1
000FBE DD37 3A87F0          13      LD  A,(_DVSW)   ;Current Drive
       DD3A                     GETDRV1:
000FC1 DD3A 3288F0          13      LD  (_DRV),A
000FC4 DD3D C9              10      RET
                                
       DD3E                     SOPENX:
000FC5 DD3E 1139F0          10      LD  DE,SFILE
000FC8 DD41 1A               7      LD  A,(DE)
000FC9 DD42 FDBE00           7      CP  (IY+0)      ;(FCB)ドライブ番号
000FCC DD45 2024            12      JR  NZ,SOPEN
000FCE DD47 13               6      INC DE
000FCF DD48 FDE5            15      PUSH    IY
000FD1 DD4A E1              10      POP HL
000FD2 DD4B 23               6      INC HL
000FD3 DD4C CDD9DE          17      CALL    CPFILE
000FD6 DD4F 201A            12      JR  NZ,SOPEN
                                
000FD8 DD51 2AF4F1          16      LD  HL,(SCDIR)
000FDB DD54 FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
000FDE DD57 FD740F          19      LD  (IY+15),H
                                
000FE1 DD5A 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
000FE4 DD5D 229FF0          16      LD  (_FILEN),HL
                                
000FE7 DD60 ED5BF6F1        20      LD  DE,(SFBPS)
000FEB DD64 2139F0          10      LD  HL,SFILE
000FEE DD67 36FF            10      LD  (HL),0FFH
000FF0 DD69 23               6      INC HL
000FF1 DD6A C9              10      RET
       DD6B                     SOPEN:
000FF2 DD6B 2181DE          10      LD  HL,FILESE
       DD6E                     SOPENC:
000FF5 DD6E 22A7DD          16      LD  (OPENPAT+1),HL
                                
000FF8 DD71 CDE2F0          17      CALL    _RDFATX     ;Detect Media
000FFB DD74 3856            12      JR  C,RDDERR
                                
000FFD DD76 AF               4      XOR A
000FFE DD77 329FF0          13      LD  (_FILEN),A
001001 DD7A CD86DF          17      CALL    LDDIRX1     ;A=0で呼び出す
001004 DD7D 2818            12      JR  Z,SDIRX1
                                
001006 DD7F CD72DE          17      CALL    READ_DIR    ;Sub Directory
001009 DD82 3808            12      JR  C,SDIRX0
00100B DD84 2A7EF1          16      LD  HL,(_DTBUF)
00100E DD87 7E               7      LD  A,(HL)
00100F DD88 FE2E             7      CP  '.'
001011 DD8A 280F            12      JR  Z,SOPEN1
       DD8C                     SDIRX0:
001013 DD8C AF               4      XOR A
001014 DD8D 32A0F0          13      LD  (_DIRF),A
001017 DD90 FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
00101B DD94 FD770F          19      LD  (IY+15),A
       DD97                     SDIRX1:
00101E DD97 ED5BFCF1        20      LD  DE,(_DIRPS) ;Root Directory
       DD9B                     SOPEN1:
001022 DD9B 0E20             7  SDECPAT:LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       DD9D                     SOPEN1X:
001024 DD9D CD72DE          17      CALL    READ_DIR    ;FILE SEARCH
001027 DDA0 382A            12      JR  C,RDDERR
001029 DDA2 2A7EF1          16      LD  HL,(_DTBUF)
       DDA5                     SOPEN2:
00102C DDA5 D5              11      PUSH    DE
00102D DDA6 CD81DE          17  OPENPAT:CALL    FILESE      ;(self-modifying code)
001030 DDA9 D1              10      POP DE
001031 DDAA 386E            12      JR  C,SOPENE
001033 DDAC 281B            12      JR  Z,SCF_FF_RET
       DDAE                     SOPEN3:
001035 DDAE 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
001038 DDB1 B7               4      OR  A
001039 DDB2 200C            12      JR  NZ,SOPEN5
00103B DDB4 13               6      INC DE      ;ルートディレクトリ
00103C DDB5 E5              11      PUSH    HL
00103D DDB6 210C00          10  MD_PAT: LD  HL,12       ;(self-modifying code)MAXDIR
001040 DDB9 ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
001042 DDBB E1              10      POP HL
001043 DDBC 20DD            12      JR  NZ,SOPEN1
001045 DDBE 1807            12      JR  SOPEN6
       DDC0                     SOPEN5:
001047 DDC0 CD9BE6          17      CALL    GNCLX       ;END DIR
00104A DDC3 D8              11      RET C
00104B DDC4 CD39DF          17      CALL    ENDCL
       DDC7                     SOPEN6:
00104E DDC7 38D2            12      JR  C,SOPEN1
       DDC9                     SCF_FF_RET:
001050 DDC9 37               4      SCF         ;CF=1
001051 DDCA 9F               4      SBC A,A     ;A=0FFH
001052 DDCB C9              10      RET
                                
       DDCC                     RDDERR:
001053 DDCC BF               4      CP  A       ;READ ERR CF=1 ZF=1
001054 DDCD 37               4      SCF
001055 DDCE C9              10      RET
                                
       DDCF                     NOPEN:
001056 DDCF 2181DE          10      LD  HL,FILESE
001059 DDD2 22A7DD          16      LD  (OPENPAT+1),HL
00105C DDD5 FD2A98F0        20      LD  IY,(_FCB)
001060 DDD9 CD6CE0          17      CALL    CHKWILDX
001063 DDDC 30EB            12      JR  NC,SCF_FF_RET
001065 DDDE FD7E00          19      LD  A,(IY+0)    ;(FCB)ドライブ番号
001068 DDE1 3D               4      DEC A
001069 DDE2 3288F0          13      LD  (_DRV),A
00106C DDE5 CDD9F0          17      CALL    _CHGDRV
00106F DDE8 D8              11      RET C
001070 DDE9 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
001073 DDEC 229FF0          16      LD  (_FILEN),HL
                                
001076 DDEF CD81DF          17      CALL    LDDIRX
001079 DDF2 ED5B9AF0        20      LD  DE,(_FBPS)
00107D DDF6 CD72DE          17      CALL    READ_DIR
001080 DDF9 38D1            12      JR  C,RDDERR
001082 DDFB 3A9EF0          13      LD  A,(_FBCNT)
001085 DDFE 3D               4      DEC A
001086 DDFF 28AD            12      JR  Z,SOPEN3
       DE01                     NOPEN2:
001088 DE01 2A9CF0          16      LD  HL,(_FBAD)
00108B DE04 012000          10      LD  BC,020H
00108E DE07 09              11      ADD HL,BC
00108F DE08 4F               4      LD  C,A
001090 DE09 189A            12      JR  SOPEN2
                                
       DE0B                     SOPENE2:
001092 DE0B 229CF0          16      LD  (_FBAD),HL
001095 DE0E 79               4      LD  A,C
001096 DE0F 329EF0          13      LD  (_FBCNT),A
001099 DE12 ED539AF0        20      LD  (_FBPS),DE
00109D DE16 FD2298F0        20      LD  (_FCB),IY
       DE1A                     SOPENE:
0010A1 DE1A AF               4      XOR A
0010A2 DE1B C9              10      RET
                                
       DE1C                     COPEN:
0010A3 DE1C FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
0010A7 DE20 219EDE          10      LD  HL,NEXTSE
0010AA DE23 CD6EDD          17      CALL    SOPENC
0010AD DE26 D0              11      RET NC
0010AE DE27 C8              11      RET Z
0010AF DE28 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
0010B2 DE2B B7               4      OR  A
0010B3 DE2C 37               4      SCF
0010B4 DE2D C8              11      RET Z       ;ルートディレクトリ
0010B5 DE2E 0601             7      LD  B,1
0010B7 DE30 CDCBE0          17      CALL    WRDF
0010BA DE33 D8              11      RET C
0010BB DE34 ED5BFEF1        20      LD  DE,(_CLPS)
0010BF DE38 D5              11      PUSH    DE
0010C0 DE39 CD02DF          17      CALL    DCPAT
0010C3 DE3C CD26E5          17      CALL    DRDNX
0010C6 DE3F 2A7EF1          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
0010C9 DE42 3A30E4          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
0010CC DE45 47               4      LD  B,A
0010CD DE46 AF               4      XOR A
0010CE DE47 4F               4      LD  C,A
       DE48                     COPENCL:
0010CF DE48 77               7      LD  (HL),A
0010D0 DE49 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0010D2 DE4B EA48DE          10      JP  PE,COPENCL
                                
0010D5 DE4E 3A20DF          13      LD  A,(SPCPAT+1)    ;1クラスタの論理セクタ数
0010D8 DE51 3D               4      DEC A
0010D9 DE52 2819            12      JR  Z,COPENE
0010DB DE54 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
0010DD DE56 3293E6          13      LD  (_SECPS+1),A
0010E0 DE59 D1              10      POP DE      ;DE=(_CLPS)
0010E1 DE5A D5              11      PUSH    DE
       DE5B                     COPEN1:
0010E2 DE5B D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
0010E3 DE5C C5              11      PUSH    BC
0010E4 DE5D 2A7EF1          16      LD  HL,(_DTBUF)
0010E7 DE60 CD1CDF          17      CALL    CLUSTX
0010EA DE63 CD2BE8          17      CALL    DWT24
0010ED DE66 C1              10      POP BC
0010EE DE67 D1              10      POP DE
0010EF DE68 CD92E6          17      CALL    NEXTX
0010F2 DE6B 20EE            12      JR  NZ,COPEN1
       DE6D                     COPENE:
0010F4 DE6D 2A7EF1          16      LD  HL,(_DTBUF)
0010F7 DE70 D1              10      POP DE
0010F8 DE71 C9              10      RET
                                
       DE72                     READ_DIR:
0010F9 DE72 ED53FEF1        20      LD  (_CLPS),DE
0010FD DE76 C5              11      PUSH    BC
0010FE DE77 D5              11      PUSH    DE
0010FF DE78 CD02DF          17      CALL    DCPAT
001102 DE7B CD06E5          17      CALL    DRDX
001105 DE7E D1              10      POP DE
001106 DE7F C1              10      POP BC
001107 DE80 C9              10      RET
                                
       DE81                     FILESE:
001108 DE81 7E               7      LD  A,(HL)
001109 DE82 B7               4      OR  A
00110A DE83 C8              11      RET Z       ;END:ZF=1 CF=0
00110B DE84 FEE5             7      CP  0E5H
00110D DE86 280E            12      JR  Z,FILESE1
00110F DE88 FDE5            15      PUSH    IY
001111 DE8A D1              10      POP DE
001112 DE8B 13               6      INC DE
001113 DE8C E5              11      PUSH    HL
001114 DE8D CDD9DE          17      CALL    CPFILE
001117 DE90 CCFADE          17      CALL    Z,CPFILE2
00111A DE93 E1              10      POP HL
00111B DE94 37               4      SCF
00111C DE95 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       DE96                     FILESE1:
00111D DE96 CDADDE          17      CALL    FNEXT
001120 DE99 20E6            12      JR  NZ,FILESE
       DE9B                     ZF0_CF0_AFF_RET:
001122 DE9B F6FF             7      OR  0FFH        ;ZF=0 CF=0
001124 DE9D C9              10      RET
                                
       DE9E                     NEXTSE:
001125 DE9E 7E               7      LD  A,(HL)
001126 DE9F B7               4      OR  A
001127 DEA0 37               4      SCF
001128 DEA1 C8              11      RET Z       ;!!!:ZF=1 CF=1
001129 DEA2 FEE5             7      CP  0E5H
00112B DEA4 37               4      SCF
00112C DEA5 C8              11      RET Z       ;!!!:(ZF=1) CF=1
00112D DEA6 CDADDE          17      CALL    FNEXT
001130 DEA9 20F3            12      JR  NZ,NEXTSE
001132 DEAB 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       DEAD                     FNEXT:
001134 DEAD E5              11      PUSH    HL
001135 DEAE 219FF0          10      LD  HL,_FILEN
001138 DEB1 34              11      INC (HL)
001139 DEB2 E1              10      POP HL
00113A DEB3 112000          10      LD  DE,020H
00113D DEB6 19              11      ADD HL,DE
00113E DEB7 0D               4      DEC C
00113F DEB8 C9              10      RET
                                
       DEB9                     CPNAME:
001140 DEB9 C5              11      PUSH    BC
001141 DEBA D5              11      PUSH    DE
001142 DEBB E5              11      PUSH    HL
001143 DEBC CDD3DE          17      CALL    CPFILE4
001146 DEBF E1              10      POP HL
001147 DEC0 23               6      INC HL
001148 DEC1 23               6      INC HL
001149 DEC2 23               6      INC HL
00114A DEC3 23               6      INC HL
00114B DEC4 D1              10      POP DE
00114C DEC5 C1              10      POP BC
00114D DEC6 2005            12      JR  NZ,CPNAME1
00114F DEC8 7E               7      LD  A,(HL)
001150 DEC9 23               6      INC HL
001151 DECA 66               7      LD  H,(HL)
001152 DECB 6F               4      LD  L,A
001153 DECC C9              10      RET
       DECD                     CPNAME1:
001154 DECD 23               6      INC HL
001155 DECE 23               6      INC HL
001156 DECF 10E8            13      DJNZ    CPNAME
001158 DED1 37               4      SCF
001159 DED2 C9              10      RET
                                
       DED3                     CPFILE4:
00115A DED3 C5              11      PUSH    BC
00115B DED4 010004          10      LD  BC,00400H
00115E DED7 1804            12      JR  CPSTR1
       DED9                     CPFILE:
001160 DED9 C5              11      PUSH    BC
001161 DEDA 01000B          10      LD  BC,00B00H
       DEDD                     CPSTR1:
001164 DEDD 1A               7      LD  A,(DE)
001165 DEDE FE3F             7      CP  '?'     ;Wild card
001167 DEE0 2812            12      JR  Z,CPSTR2
001169 DEE2 7E               7      LD  A,(HL)
00116A DEE3 CD52E0          17      CALL    FKANC
00116D DEE6 E5              11      PUSH    HL
00116E DEE7 67               4      LD  H,A
00116F DEE8 1A               7      LD  A,(DE)
001170 DEE9 CB01             4      RLC C
001172 DEEB CD52E0          17      CALL    FKANC
001175 DEEE CB09             4      RRC C
001177 DEF0 BC               4      CP  H       ;CP (HL),(DE)
001178 DEF1 E1              10      POP HL
001179 DEF2 2004            12      JR  NZ,CPSTR3
       DEF4                     CPSTR2:
00117B DEF4 13               6      INC DE
00117C DEF5 23               6      INC HL
00117D DEF6 10E5            13      DJNZ    CPSTR1
       DEF8                     CPSTR3:
00117F DEF8 C1              10      POP BC
001180 DEF9 C9              10      RET
                                
       DEFA                     CPFILE2:
001181 DEFA FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001184 DEFD F6E1             7      OR  0E1H
001186 DEFF 2F               4      CPL
001187 DF00 A6               7      AND (HL)
001188 DF01 C9              10      RET
                                
       DF02                     DCPAT:
001189 DF02 0E00             7      LD  C,0
00118B DF04 2A7EF1          16      LD  HL,(_DTBUF)
00118E DF07 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
001191 DF0A B7               4      OR  A
001192 DF0B C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
001193 DF0C 3A20DF          13      LD  A,(SPCPAT+1)
001196 DF0F 4F               4      LD  C,A
001197 DF10 3A93E6          13      LD  A,(_SECPS+1)
00119A DF13 B9               4      CP  C
00119B DF14 3801            12      JR  C,DC1
00119D DF16 AF               4      XOR A
       DF17                     DC1:
00119E DF17 F680             7      OR  080H
0011A0 DF19 32A0F0          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       DF1C                     CLUSTX:
0011A3 DF1C E5              11      PUSH    HL
0011A4 DF1D EB               4      EX  DE,HL
0011A5 DF1E AF               4      XOR A
0011A6 DF1F 0E01             7  SPCPAT: LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       DF21                     L_CLDBL:
0011A8 DF21 CB19             8      RR  C       ;->CF
0011AA DF23 3804            12      JR  C,E_CLDBL
0011AC DF25 29              11      ADD HL,HL       ;*2
0011AD DF26 8F               4      ADC A,A
0011AE DF27 18F8            12      JR  L_CLDBL
       DF29                     E_CLDBL:
0011B0 DF29 4F               4      LD  C,A
0011B1 DF2A 3A93E6          13      LD  A,(_SECPS+1)
0011B4 DF2D B5               4      OR  L
0011B5 DF2E 6F               4      LD  L,A
0011B6 DF2F 110800          10  CLSPAT: LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
0011B9 DF32 AF               4      XOR A
0011BA DF33 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
0011BB DF34 89               4      ADC A,C
0011BC DF35 4F               4      LD  C,A
0011BD DF36 EB               4      EX  DE,HL
0011BE DF37 E1              10      POP HL
0011BF DF38 C9              10      RET
                                
       DF39                     ENDCL:
0011C0 DF39 7A               4      LD  A,D ;END CLUSTER
0011C1 DF3A FE01             7  CLPAT1: CP  1   ;164=356    (self-modifying code)
0011C3 DF3C C0              11      RET NZ
0011C4 DF3D 7B               4      LD  A,E
0011C5 DF3E FE64             7  CLPAT2: CP  064H    ;       (self-modifying code)
0011C7 DF40 C9              10      RET
                                
       DF41                     CAP:
0011C8 DF41 FE61             7      CP  'a'
0011CA DF43 D8              11      RET C
0011CB DF44 FE7B             7      CP  'z'+1
0011CD DF46 D0              11      RET NC
0011CE DF47 D620             7      SUB 020H
0011D0 DF49 C9              10      RET
       DF4A                     CAP2:
0011D1 DF4A CD41DF          17      CALL    CAP
       DF4D                     CAP3:
0011D4 DF4D CD56DF          17      CALL    CAP4
0011D7 DF50 FE21             7      CP  021H
0011D9 DF52 D0              11      RET NC
0011DA DF53 3EA0             7      LD  A,0A0H
0011DC DF55 C9              10      RET
       DF56                     CAP4:
0011DD DF56 FE05             7      CP  5
0011DF DF58 C0              11      RET NZ
0011E0 DF59 3EE5             7      LD  A,0E5H
0011E2 DF5B C9              10      RET
                                
       DF5C                     CHDIR:
0011E3 DF5C CD59E9          17      CALL    GETDPBD
0011E6 DF5F 381D            12      JR  C,CHDIR2
0011E8 DF61 DD751A          19      LD  (IX+01AH),L     ;_SDIR_
0011EB DF64 DD741B          19      LD  (IX+01BH),H     ;_SDIR_+1
0011EE DF67 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       DF69                     LDDIR:
0011F0 DF69 CD59E9          17      CALL    GETDPBD
0011F3 DF6C DD5E1A          19      LD  E,(IX+01AH)     ;_SDIR_
0011F6 DF6F DD561B          19      LD  D,(IX+01BH)     ;_SDIR_+1
0011F9 DF72 13               6      INC DE
0011FA DF73 FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0011FD DF76 FD720F          19      LD  (IY+15),D
001200 DF79 1B               6      DEC DE
001201 DF7A AF               4      XOR A
001202 DF7B 32A0F0          13      LD  (_DIRF),A
       DF7E                     CHDIR2:
001205 DF7E DDE1            14      POP IX
001207 DF80 C9              10      RET
                                
       DF81                     LDDIRX:
001208 DF81 3AA0F0          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
00120B DF84 E67F             7      AND 07FH
       DF86                     LDDIRX1:
00120D DF86 3293E6          13      LD  (_SECPS+1),A
001210 DF89 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
001213 DF8C FD560F          19      LD  D,(IY+15)
001216 DF8F 1B               6      DEC DE
001217 DF90 CD39DF          17      CALL    ENDCL
00121A DF93 D469DF          17      CALL    NC,LDDIR
       DF96                     LDDIRS:
00121D DF96 7A               4      LD  A,D
00121E DF97 B3               4      OR  E
00121F DF98 32A0F0          13      LD  (_DIRF),A   ;ディレクトリか判別
001222 DF9B C9              10      RET
                                
       DF9C                     KILL:
001223 DF9C CD6CE0          17      CALL    CHKWILDX
001226 DF9F 3834            12      JR  C,KILLW
001228 DFA1 CD3EDD          17      CALL    SOPENX
       DFA4                     KILLS:
00122B DFA4 3E1F             7      LD  A,01FH
00122D DFA6 D4E8DF          17      CALL    NC,CHKATT
001230 DFA9 D8              11      RET C
       DFAA                     KILLSX:
001231 DFAA 36E5            10      LD  (HL),0E5H   ;DIR
001233 DFAC CD46E0          17      CALL    WTDB
001236 DFAF 111A00          10      LD  DE,01AH
001239 DFB2 19              11      ADD HL,DE
00123A DFB3 5E               7      LD  E,(HL)
00123B DFB4 23               6      INC HL
00123C DFB5 56               7      LD  D,(HL)
       DFB6                     KILLS1:
00123D DFB6 CD39DF          17      CALL    ENDCL
001240 DFB9 D0              11      RET NC      ;CF=0
001241 DFBA 21FEFF          10      LD  HL,0-2
001244 DFBD 19              11      ADD HL,DE
001245 DFBE D0              11      RET NC      ;DE= 0 or 1
001246 DFBF D5              11      PUSH    DE
001247 DFC0 CDF7F0          17      CALL    _GNCL
00124A DFC3 ED53FEF1        20      LD  (_CLPS),DE
00124E DFC7 D1              10      POP DE
00124F DFC8 210000          10      LD  HL,0
001252 DFCB D4FAF0          17      CALL    NC,_SNCL
001255 DFCE D8              11      RET C
001256 DFCF ED5BFEF1        20      LD  DE,(_CLPS)  ;FAT
00125A DFD3 18E1            12      JR  KILLS1
                                
       DFD5                     KILLW:
00125C DFD5 CD6BDD          17      CALL    SOPEN
       DFD8                     KILLW1:
00125F DFD8 380B            12      JR  C,KILLW2
001261 DFDA CD0BDE          17      CALL    SOPENE2
001264 DFDD CDA4DF          17      CALL    KILLS
001267 DFE0 CDCFDD          17      CALL    NOPEN
00126A DFE3 18F3            12      JR  KILLW1
       DFE5                     KILLW2:
00126C DFE5 C8              11      RET Z
00126D DFE6 3F               4      CCF
00126E DFE7 C9              10      RET
                                
       DFE8                     CHKATT:
00126F DFE8 E5              11      PUSH    HL
001270 DFE9 110B00          10      LD  DE,00BH
001273 DFEC 19              11      ADD HL,DE
001274 DFED A6               7      AND (HL)
001275 DFEE E1              10      POP HL
001276 DFEF C8              11      RET Z
001277 DFF0 37               4      SCF
001278 DFF1 C9              10      RET
                                
       DFF2                     NAME:
001279 DFF2 CD6CE0          17      CALL    CHKWILDX
00127C DFF5 D8              11      RET C
00127D DFF6 110400          10      LD  DE,4
001280 DFF9 19              11      ADD HL,DE
001281 DFFA 2212E0          16      LD  (NAMEP+2),HL
001284 DFFD 23               6      INC HL
001285 DFFE CD70E0          17      CALL    CHKWILD
001288 E001 D8              11      RET C
                                
001289 E002 CD3EDD          17      CALL    SOPENX
00128C E005 3E0F             7      LD  A,00FH
00128E E007 D4E8DF          17      CALL    NC,CHKATT
001291 E00A D8              11      RET C
                                
001292 E00B FD7E00          19      LD  A,(IY+0)
001295 E00E FDE5            15      PUSH    IY
001297 E010 FD210000        14  NAMEP:  LD  IY,0        ;自己書き換え
00129B E014 FD7700          19      LD  (IY+0),A
00129E E017 CD3EDD          17      CALL    SOPENX
0012A1 E01A FDE3            23      EX  (SP),IY
0012A3 E01C 3F               4      CCF
0012A4 E01D D46BDD          17      CALL    NC,SOPEN
0012A7 E020 EB               4      EX  DE,HL
0012A8 E021 E1              10      POP HL
0012A9 E022 D8              11      RET C
                                
       E023                     SETNAME:
0012AA E023 01000B          10      LD  BC,11*256
0012AD E026 23               6      INC HL
0012AE E027 7E               7      LD  A,(HL)
0012AF E028 FEE5             7      CP  0E5H
0012B1 E02A 2004            12      JR  NZ,SNAME1
0012B3 E02C 3E05             7      LD  A,5
0012B5 E02E 180E            12      JR  SNAME3
       E030                     SNAME1:
0012B7 E030 7E               7      LD  A,(HL)
0012B8 E031 0C               4      INC C
0012B9 E032 0D               4      DEC C
0012BA E033 2009            12      JR  NZ,SNAME3
0012BC E035 CD41DF          17      CALL    CAP
0012BF E038 FEA0             7      CP  0A0H
0012C1 E03A 2002            12      JR  NZ,SNAME3
0012C3 E03C 3E20             7      LD  A,020H
       E03E                     SNAME3:
0012C5 E03E 12               7      LD  (DE),A
0012C6 E03F 7E               7      LD  A,(HL)
0012C7 E040 23               6      INC HL
0012C8 E041 CD59E0          17      CALL    FKAN
0012CB E044 10EA            13      DJNZ    SNAME1
       E046                     WTDB:
0012CD E046 3EFF             7      LD  A,0FFH
0012CF E048 3239F0          13      LD  (SFILE),A
       E04B                     SWTDBF:
0012D2 E04B 3E01             7      LD  A,1
0012D4 E04D 32A4F0          13      LD  (_WTDBF),A
0012D7 E050 AF               4      XOR A
0012D8 E051 C9              10      RET
                                
       E052                     FKANC:
0012D9 E052 CB41             8      BIT 0,C
0012DB E054 CC4ADF          17      CALL    Z,CAP2
0012DE E057 1801            12      JR  FKANX
       E059                     FKAN:           ;漢字チェック
0012E0 E059 13               6      INC DE
       E05A                     FKANX:
0012E1 E05A CB41             8      BIT 0,C
0012E3 E05C CB81             8      RES 0,C
0012E5 E05E C0              11      RET NZ
0012E6 E05F FE80             7      CP  080H
0012E8 E061 D8              11      RET C
0012E9 E062 FEA0             7      CP  0A0H
0012EB E064 3803            12      JR  C,FKAN1
0012ED E066 FEE0             7      CP  0E0H
0012EF E068 D8              11      RET C
       E069                     FKAN1:
0012F0 E069 0C               4      INC C
0012F1 E06A A7               4      AND A
0012F2 E06B C9              10      RET
                                
       E06C                     CHKWILDX:
0012F3 E06C FDE5            15      PUSH    IY
0012F5 E06E E1              10      POP HL
0012F6 E06F 23               6      INC HL
       E070                     CHKWILD:
0012F7 E070 060B             7      LD  B,11
0012F9 E072 3E3F             7      LD  A,'?'
       E074                     CHKWIL1:
0012FB E074 BE               7      CP  (HL)
0012FC E075 23               6      INC HL
0012FD E076 37               4      SCF
0012FE E077 C8              11      RET Z
0012FF E078 10FA            13      DJNZ    CHKWIL1
001301 E07A AF               4      XOR A
001302 E07B C9              10      RET
                                
       E07C                     SDIRENT:        ;IY=FCB HL=DIR
001303 E07C D5              11      PUSH    DE
001304 E07D E5              11      PUSH    HL
001305 E07E FDE5            15      PUSH    IY
001307 E080 D1              10      POP DE
001308 E081 EB               4      EX  DE,HL
001309 E082 CD23E0          17      CALL    SETNAME
                                ;               Attribute
00130C E085 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
00130F E088 12               7      LD  (DE),A
001310 E089 13               6      INC DE
                                ;               Reserved
001311 E08A AF               4      XOR A
001312 E08B 060A             7      LD  B,10
       E08D                     SDE1:
001314 E08D 12               7      LD  (DE),A
001315 E08E 13               6      INC DE
001316 E08F 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
001318 E091 21EAF1          10      LD  HL,SDDATA       ;(FCB)更新年月日
00131B E094 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       E096                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
00131D E096 7E               7      LD  A,(HL)
00131E E097 23               6      INC HL
00131F E098 329DE0          13      LD  (SDPAT+2),A
001322 E09B FD7E00          19  SDPAT:  LD  A,(IY+0)    ;LD A,(IY+A)
001325 E09E 12               7      LD  (DE),A
001326 E09F 13               6      INC DE
001327 E0A0 10F4            13      DJNZ    SDLOOP
                                
001329 E0A2 AF               4      XOR A
00132A E0A3 E1              10      POP HL
00132B E0A4 D1              10      POP DE
00132C E0A5 C9              10      RET
                                
       E0A6                     WOPEN:
00132D E0A6 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001330 E0A9 E61F             7      AND 01FH
001332 E0AB 37               4      SCF
001333 E0AC C0              11      RET NZ
001334 E0AD FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       E0B1                     TOPEN2:
001338 E0B1 AF               4      XOR A
       E0B2                     TOPEN:              ;Initializes the time stamp
001339 E0B2 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
00133D E0B6 C9              10      RET
                                
       E0B7                     WRDFX:
00133E E0B7 3A20DF          13      LD  A,(SPCPAT+1)    ;1クラスタの論理セクタ
       E0BA                     L_WRFX:
001341 E0BA 1F               4      RRA         ;->CF
001342 E0BB 3806            12      JR  C,E_WRFX
001344 E0BD CB39             8      SRL C
001346 E0BF CB1C             8      RR  H       ;CH=CH/2
001348 E0C1 18F7            12      JR  L_WRFX
       E0C3                     E_WRFX:
00134A E0C3 41               4      LD  B,C
00134B E0C4 4C               4      LD  C,H
00134C E0C5 03               6      INC BC
00134D E0C6 3E37             7      LD  A,037H      ;SCF
00134F E0C8 3223E5          13      LD  (DRDN1),A
                                
       E0CB                     WRDF:               ;BCクラスタ分FATを確保する
001352 E0CB 110200          10      LD  DE,2
001355 E0CE AF               4      XOR A
001356 E0CF 3293E6          13      LD  (_SECPS+1),A
       E0D2                     WRDF1:
001359 E0D2 C5              11      PUSH    BC
00135A E0D3 D5              11      PUSH    DE
00135B E0D4 CDF7F0          17      CALL    _GNCL
00135E E0D7 381C            12      JR  C,WRDF3
001360 E0D9 7A               4      LD  A,D     ;空いているかチェック
001361 E0DA B3               4      OR  E
001362 E0DB 202A            12      JR  NZ,WRDF4
001364 E0DD E1              10      POP HL      ;HL=空いているクラスタ
001365 E0DE E5              11      PUSH    HL
001366 E0DF ED5BFEF1        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
00136A E0E3 22FEF1          16      LD  (_CLPS),HL
00136D E0E6 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
00136E E0E7 B3               4      OR  E
00136F E0E8 2008            12      JR  NZ,WRDF2
001371 E0EA FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
001374 E0ED FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
001377 E0F0 1803            12      JR  WRDF3
       E0F2                     WRDF2:
001379 E0F2 CDFAF0          17      CALL    _SNCL
       E0F5                     WRDF3:
00137C E0F5 D1              10      POP DE
00137D E0F6 C1              10      POP BC
00137E E0F7 D8              11      RET C
00137F E0F8 0B               6      DEC BC
001380 E0F9 78               4      LD  A,B
001381 E0FA B1               4      OR  C
001382 E0FB 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
001384 E0FD ED5BFEF1        20      LD  DE,(_CLPS)
001388 E101 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
00138B E104 C3FAF0          10      JP  _SNCL
                                
       E107                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
00138E E107 D1              10      POP DE
00138F E108 C1              10      POP BC
       E109                     WRDF5:
001390 E109 13               6      INC DE
001391 E10A CD39DF          17      CALL    ENDCL
001394 E10D 38C3            12      JR  C,WRDF1
001396 E10F 37               4      SCF
001397 E110 C9              10      RET
                                
       E111                     RWXR:
001398 E111 3A30E4          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       E114                     L_RWX:
00139B E114 1F               4      RRA     ;->CF
00139C E115 3808            12      JR  C,E_RWX
00139E E117 CB38             8      SRL B   ;BCH=BCH/2
0013A0 E119 CB19             8      RR  C   ;
0013A2 E11B CB1C             8      RR  H   ;
0013A4 E11D 18F5            12      JR  L_RWX
       E11F                     E_RWX:
0013A6 E11F FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0013A9 E122 FD561B          19      LD  D,(IY+27)
0013AC E125 AF               4      XOR A
0013AD E126 3293E6          13      LD  (_SECPS+1),A
       E129                     RWX1:
0013B0 E129 ED53FEF1        20      LD  (_CLPS),DE
0013B4 E12D 7A               4      LD  A,D
0013B5 E12E B3               4      OR  E
0013B6 E12F 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
0013B8 E131 78               4      LD  A,B
0013B9 E132 B1               4      OR  C
0013BA E133 B4               4      OR  H
0013BB E134 C8              11      RET Z       ;RET BCH==0 => CF=0
                                
0013BC E135 CD9BE6          17      CALL    GNCLX
0013BF E138 D8              11      RET C
0013C0 E139 7C               4      LD  A,H     ;
0013C1 E13A 25               4      DEC H       ;
0013C2 E13B B7               4      OR  A       ;DEC BCH
0013C3 E13C 2001            12      JR  NZ,RWX2     ;
0013C5 E13E 0B               6      DEC BC      ;
       E13F                     RWX2:
0013C6 E13F CD39DF          17      CALL    ENDCL
0013C9 E142 38E5            12      JR  C,RWX1
       E144                     SCF_RET:
0013CB E144 37               4      SCF
0013CC E145 C9              10      RET
                                
       E146                     DSKF:
0013CD E146 110000          10  MAXCLP: LD  DE,0
0013D0 E149 2AACF0          16      LD  HL,(_FAKEFREE)
0013D3 E14C 7C               4      LD  A,H
0013D4 E14D B5               4      OR  L
0013D5 E14E 2803            12      JR  Z,DSKF1
0013D7 E150 110100          10      LD  DE,1
       E153                     DSKF1:
0013DA E153 D5              11      PUSH    DE
0013DB E154 CDF7F0          17      CALL    _GNCL
0013DE E157 380C            12      JR  C,POPSCF
0013E0 E159 7A               4      LD  A,D
0013E1 E15A B3               4      OR  E
0013E2 E15B 2001            12      JR  NZ,DSKF2
0013E4 E15D 23               6      INC HL
       E15E                     DSKF2:
0013E5 E15E D1              10      POP DE
0013E6 E15F 1B               6      DEC DE
0013E7 E160 7A               4      LD  A,D
0013E8 E161 B3               4      OR  E
0013E9 E162 20EF            12      JR  NZ,DSKF1
0013EB E164 C9              10      RET
                                
       E165                     POPSCF:
0013EC E165 F1              10      POP AF
0013ED E166 37               4      SCF
0013EE E167 C9              10      RET
                                
       E168                     SETTMS:
0013EF E168 FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
0013F2 E16B 3C               4      INC A
0013F3 E16C C0              11      RET NZ      ;ファイルが更新されていない
       E16D                     SETTMSX:            ;FCBに日付時刻をセットする
0013F4 E16D CDCFD8          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
0013F7 E170 CB25             8      SLA L       ;   *2
0013F9 E172 CB25             8      SLA L       ;   *4
0013FB E174 29              11      ADD HL,HL       ;*2 *8
0013FC E175 29              11      ADD HL,HL       ;*4 *16
0013FD E176 29              11      ADD HL,HL       ;*8 *32
0013FE E177 7A               4      LD  A,D
0013FF E178 0F               4      RRCA            ;bit.0->7->->->0->C
001400 E179 E61F             7      AND 01FH
001402 E17B B5               4      OR  L
001403 E17C FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
001406 E17F FD7417          19      LD  (IY+23),H
                                
001409 E182 CDC9D8          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
00140C E185 0144F8          10      LD  BC,0-1980
00140F E188 09              11      ADD HL,BC
001410 E189 65               4      LD  H,L
                                
001411 E18A 7A               4      LD  A,D
001412 E18B 87               4      ADD A,A     ;*2
001413 E18C 87               4      ADD A,A     ;*4
001414 E18D 87               4      ADD A,A     ;*8
001415 E18E 87               4      ADD A,A     ;*16
001416 E18F 6F               4      LD  L,A
001417 E190 29              11      ADD HL,HL       ;*32
001418 E191 7D               4      LD  A,L
001419 E192 B3               4      OR  E
00141A E193 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
00141D E196 FD7415          19      LD  (IY+21),H
001420 E199 C9              10      RET
                                
       E19A                     PUSHRR:
001421 E19A 3232E2          13      LD  (SETSEQ_SWC_RND),A
001424 E19D 2244E2          16      LD  (SETSEQ_SWC_SEQ_RR),HL
001427 E1A0 CDC0E1          17      CALL    GET_RR_AHL
00142A E1A3 220FF0          16      LD  (RR_BUF_HL),HL
00142D E1A6 3211F0          13      LD  (RR_BUF_A),A
001430 E1A9 C9              10      RET
                                
       E1AA                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
001431 E1AA 87               4      ADD A,A     ;in BHLA => out AHL
001432 E1AB ED6A            15      ADC HL,HL
001434 E1AD CB18             8      RR  B
001436 E1AF B7               4      OR  A
001437 E1B0 78               4      LD  A,B     ;ここでフラグは変化しない
001438 E1B1 C8              11      RET Z
001439 E1B2 2C               4      INC L       ;INC AHL
00143A E1B3 C0              11      RET NZ      ;
00143B E1B4 24               4      INC H       ;
00143C E1B5 C0              11      RET NZ      ;
00143D E1B6 3C               4      INC A       ;
00143E E1B7 C9              10      RET
                                
       E1B8                     INIT_RND:
00143F E1B8 3ECD             7      LD  A,0CDH      ;CALL ????
001441 E1BA 2107E2          10      LD  HL,POPRR
001444 E1BD CD9AE1          17      CALL    PUSHRR
       E1C0                     GET_RR_AHL:
001447 E1C0 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
00144A E1C3 FD6622          19      LD  H,(IY+34)   ;
00144D E1C6 FD7E23          19      LD  A,(IY+35)   ;
001450 E1C9 C9              10      RET
       E1CA                     SET_RR_AHL:
001451 E1CA FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001454 E1CD FD7422          19      LD  (IY+34),H
001457 E1D0 FD7723          19      LD  (IY+35),A
00145A E1D3 C9              10      RET
       E1D4                     INIT_SEQ:
00145B E1D4 3E01             7      LD  A,1     ;LD BC,????
00145D E1D6 2104E2          10      LD  HL,SETSEQ
001460 E1D9 CD9AE1          17      CALL    PUSHRR
       E1DC                     GETSEQ:
001463 E1DC FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
001466 E1DF FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
001469 E1E2 AF               4      XOR A
                                
00146A E1E3 CB25             8      SLA L   ;L=L*2
                                
00146C E1E5 CB3C             8      SRL H   ;HL=HL/2
00146E E1E7 CB1D             8      RR  L   ;
001470 E1E9 C9              10      RET
                                
       E1EA                     SETSEQ1:
001471 E1EA F5              11      PUSH    AF
001472 E1EB E5              11      PUSH    HL      ;AHL=Random record
001473 E1EC CDC0E1          17      CALL    GET_RR_AHL
001476 E1EF 47               4      LD  B,A     ;AHL→HLA
001477 E1F0 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
001478 E1F1 6C               4      LD  L,H     ;(IY+34)
001479 E1F2 60               4      LD  H,B     ;(IY+35)
00147A E1F3 0600             7      LD  B,0
                                
00147C E1F5 CDAAE1          17      CALL    GET_CPM_R_SIZE
                                
00147F E1F8 29              11      ADD HL,HL
001480 E1F9 CB3D             8      SRL L       ;L=L/2
001482 E1FB FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
001485 E1FE FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
001488 E201 E1              10      POP HL
001489 E202 F1              10      POP AF
00148A E203 C9              10      RET
       E204                     SETSEQ:
00148B E204 CDEAE1          17      CALL    SETSEQ1
       E207                     POPRR:
00148E E207 F5              11      PUSH    AF
00148F E208 E5              11      PUSH    HL
001490 E209 2A0FF0          16      LD  HL,(RR_BUF_HL)
001493 E20C 3A11F0          13      LD  A,(RR_BUF_A)
001496 E20F CDCAE1          17      CALL    SET_RR_AHL
001499 E212 E1              10      POP HL
00149A E213 F1              10      POP AF
00149B E214 C9              10      RET
                                
       E215                     RB_WRITE:
00149C E215 C5              11      PUSH    BC
00149D E216 ED4B4CF1        20      LD  BC,(STABLE+2*026H)  ;(BDOS)ランダムブロック書き込み
0014A1 E21A 1805            12      JR  RBRW
       E21C                     RB_READ:
0014A3 E21C C5              11      PUSH    BC
0014A4 E21D ED4B4EF1        20      LD  BC,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       E221                     RBRW:
0014A8 E221 1F               4      RRA     ;AHL = AHL*128
0014A9 E222 7C               4      LD  A,H ;AHL = AHL0/2
0014AA E223 1F               4      RRA     ;A
0014AB E224 65               4      LD  H,L ;
0014AC E225 CB1C             8      RR  H   ;H
0014AE E227 2E00             7      LD  L,0 ;
0014B0 E229 CB1D             8      RR  L   ;L
0014B2 E22B CDCAE1          17      CALL    SET_RR_AHL
0014B5 E22E 218000          10      LD  HL,128
0014B8 E231 C5              11      PUSH    BC
       E232                     SETSEQ_SWC_RND:
0014B9 E232 CDEAE1          17      CALL    SETSEQ1
0014BC E235 C1              10      POP BC
0014BD E236 FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
0014C1 E23A FDE5            15      PUSH    IY
0014C3 E23C D1              10      POP DE
0014C4 E23D D5              11      PUSH    DE
0014C5 E23E CD4CE2          17      CALL    JP_BC
0014C8 E241 FDE1            14      POP IY
0014CA E243 CD04E2          17      CALL    SETSEQ
       E244                     SETSEQ_SWC_SEQ_RR   EQU $-2
0014CD E246 FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
0014D1 E24A C1              10      POP BC
0014D2 E24B C9              10      RET
       E24C                     JP_BC:
0014D3 E24C C5              11      PUSH    BC
0014D4 E24D C9              10      RET
                                
       DDC9                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       DDC9                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       DDC9                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       DDC9                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       DDC9                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E24E                     _SYS26:     ;(BDOS)ランダムブロック書き込み
0014D5 E24E AF               4      XOR A
0014D6 E24F 3223E5          13      LD  (DRDN1),A   ;NOP
0014D9 E252 2273E4          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
0014DC E255 225DF0          16      LD  (LEFTX),HL
0014DF E258 CD1EDD          17      CALL    SETDRV
                                
0014E2 E25B CDCBE3          17      CALL    RBX0
0014E5 E25E DAEBE2          10      JP  C,RBWERR
0014E8 E261 CDA6E0          17      CALL    WOPEN
0014EB E264 DAEBE2          10      JP  C,RBWERR
0014EE E267 7C               4      LD  A,H
0014EF E268 B5               4      OR  L
0014F0 E269 CAE4E2          10      JP  Z,RBW1
                                
0014F3 E26C 2B               6      DEC HL
                                
0014F4 E26D CD89E4          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0014F7 E270 19              11      ADD HL,DE       ;BCHL=HL+BCDE
0014F8 E271 3001            12      JR  NC,S26X1    ;
0014FA E273 03               6      INC BC      ;
       E274                     S26X1:
0014FB E274 CD11E1          17      CALL    RWXR
0014FE E277 DCB7E0          17      CALL    C,WRDFX
001501 E27A DAEBE2          10      JP  C,RBWERR
                                
001504 E27D CDFAE3          17      CALL    RBX2
001507 E280 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
001509 E282 CD19E4          17      CALL    RBXA
00150C E285 3864            12      JR  C,RBWERR
00150E E287 EB               4      EX  DE,HL
00150F E288 C5              11      PUSH    BC
001510 E289 EDB0                    LDIR
001512 E28B 225FF0          16      LD  (DTAX),HL
                                
001515 E28E CD4BE0          17      CALL    SWTDBF      ;バッファデータは更新された
                                
001518 E291 2A5DF0          16      LD  HL,(LEFTX)
00151B E294 D1              10      POP DE
00151C E295 ED52            15      SBC HL,DE
00151E E297 225DF0          16      LD  (LEFTX),HL
001521 E29A 2831            12      JR  Z,RBWEND
                                
       E29C                     RBWB:
001523 E29C CD4EE4          17      CALL    RBXB
001526 E29F 2814            12      JR  Z,RBWC
       E2A1                     RBWB1:
001528 E2A1 C5              11      PUSH    BC
001529 E2A2 D5              11      PUSH    DE
00152A E2A3 CD1CDF          17      CALL    CLUSTX
00152D E2A6 CD9DE4          17      CALL    DWTC
001530 E2A9 D1              10      POP DE
001531 E2AA C1              10      POP BC
001532 E2AB D49BE6          17      CALL    NC,GNCLX
001535 E2AE 383B            12      JR  C,RBWERR
001537 E2B0 10EF            13      DJNZ    RBWB1
001539 E2B2 CDEDE4          17      CALL    DRW_FLUSH
       E2B5                     RBWC:
00153C E2B5 CD66E4          17      CALL    RBXC
00153F E2B8 2813            12      JR  Z,RBWEND
001541 E2BA C5              11      PUSH    BC
001542 E2BB CD1CDF          17      CALL    CLUSTX
001545 E2BE CD22E5          17      CALL    DRDN
001548 E2C1 C1              10      POP BC
001549 E2C2 3827            12      JR  C,RBWERR
00154B E2C4 ED5B7EF1        20      LD  DE,(_DTBUF)
00154F E2C8 EDB0                    LDIR
001551 E2CA CD4BE0          17      CALL    SWTDBF      ;バッファデータは更新された
       E2CD                     RBWEND:
001554 E2CD CD72E4          17      CALL    RBXEND
                                
001557 E2D0 CDDAE3          17      CALL    RBX1
00155A E2D3 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
00155C E2D5 CD89E4          17      CALL    GET_RR_BCDE ;BCDE=Random record
00155F E2D8 FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
001562 E2DB FD7211          19      LD  (IY+17),D   ;
001565 E2DE FD7112          19      LD  (IY+18),C   ;
001568 E2E1 FD7013          19      LD  (IY+19),B   ;
       E2E4                     RBW1:
00156B E2E4 FDE1            14      POP IY
00156D E2E6 C1              10      POP BC
00156E E2E7 D1              10      POP DE
00156F E2E8 E1              10      POP HL
       E2E9                     DD_NUL:
001570 E2E9 AF               4      XOR A
       E2EA                     DRDF0:
       E2EA                     DWTF0:
001571 E2EA C9              10      RET
                                
       E2EB                     RBWERR:
001572 E2EB FDE5            15      PUSH    IY
001574 E2ED D1              10      POP DE
001575 E2EE 2A20F1          16      LD  HL,(STABLE+2*010H)
001578 E2F1 CD0F00          17      CALL    JP_HL
       E2F4                     RBRERR1:
00157B E2F4 3E01             7      LD  A,001H
       E2F6                     RBRERR2:
00157D E2F6 FDE1            14      POP IY
00157F E2F8 C1              10      POP BC
001580 E2F9 D1              10      POP DE
001581 E2FA E1              10      POP HL
001582 E2FB 37               4      SCF
001583 E2FC 210000          10      LD  HL,0
001586 E2FF C9              10      RET
                                
       E300                     RBRERR:
001587 E300 3EFF             7      LD  A,0FFH
001589 E302 18F2            12      JR  RBRERR2
                                
       E304                     RBRFL:
00158B E304 3E00             7  RBRFLP: LD  A,000H
00158D E306 FE0D             7      CP  00DH
00158F E308 2005            12      JR  NZ,RBRFL1
001591 E30A D5              11      PUSH    DE
001592 E30B 1E0A             7      LD  E,00AH
001594 E30D 1805            12      JR  RBRFL2
       E30F                     RBRFL1:
001596 E30F D5              11      PUSH    DE
001597 E310 CD09F0          17      CALL    _SYS07
00159A E313 5F               4      LD  E,A
       E314                     RBRFL2:
00159B E314 CDCDF0          17      CALL    _PRINT
00159E E317 7B               4      LD  A,E
00159F E318 D1              10      POP DE
0015A0 E319 3205E3          13      LD  (RBRFLP+1),A
0015A3 E31C C9              10      RET
       E31D                     DDX:
0015A4 E31D FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
0015A7 E320 CD41DF          17      CALL    CAP
0015AA E323 FE41             7      CP  'A'
0015AC E325 C9              10      RET
                                
                                                ;Read random block
       E326                     _SYS27:     ;(BDOS)ランダムブロック読み込み
0015AD E326 225DF0          16      LD  (LEFTX),HL
0015B0 E329 CD1EDD          17      CALL    SETDRV
                                
0015B3 E32C FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
0015B7 E330 C2B9E3          10      JP  NZ,RBRDIR   ;ディレクトリ
0015BA E333 CDCBE3          17      CALL    RBX0
0015BD E336 DA00E3          10      JP  C,RBRERR
0015C0 E339 CDDAE3          17      CALL    RBX1
0015C3 E33C D4F2E3          17      CALL    NC,RBX1R
0015C6 E33F DAF4E2          10      JP  C,RBRERR1
0015C9 E342 EB               4      EX  DE,HL
0015CA E343 ED52            15      SBC HL,DE       ;CP 00HL,BCDE
0015CC E345 19              11      ADD HL,DE
0015CD E346 79               4      LD  A,C
0015CE E347 DE00             7      SBC A,0
0015D0 E349 78               4      LD  A,B
0015D1 E34A DE00             7      SBC A,0
0015D3 E34C 3801            12      JR  C,RBR1
0015D5 E34E EB               4      EX  DE,HL
       E34F                     RBR1:
0015D6 E34F 9F               4      SBC A,A
0015D7 E350 E601             7      AND 1
0015D9 E352 32B7E3          13      LD  (RBRAP+1),A
                                
0015DC E355 7C               4      LD  A,H
0015DD E356 B5               4      OR  L
0015DE E357 2857            12      JR  Z,RBREND0
                                
0015E0 E359 2273E4          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
0015E3 E35C 225DF0          16      LD  (LEFTX),HL
                                
0015E6 E35F CDFAE3          17      CALL    RBX2
0015E9 E362 2819            12      JR  Z,RBRB
0015EB E364 CD19E4          17      CALL    RBXA
0015EE E367 DA00E3          10      JP  C,RBRERR
0015F1 E36A C5              11      PUSH    BC
0015F2 E36B EDB0                    LDIR
0015F4 E36D ED535FF0        20      LD  (DTAX),DE
0015F8 E371 2A5DF0          16      LD  HL,(LEFTX)
0015FB E374 D1              10      POP DE
0015FC E375 A7               4      AND A
0015FD E376 ED52            15      SBC HL,DE
0015FF E378 225DF0          16      LD  (LEFTX),HL
001602 E37B 2830            12      JR  Z,RBREND
                                
       E37D                     RBRB:
001604 E37D CD4EE4          17      CALL    RBXB
001607 E380 2815            12      JR  Z,RBRC
       E382                     RBRB1:
001609 E382 C5              11      PUSH    BC
00160A E383 D5              11      PUSH    DE
00160B E384 CD1CDF          17      CALL    CLUSTX
00160E E387 CDA3E4          17      CALL    DRDC
001611 E38A D1              10      POP DE
001612 E38B C1              10      POP BC
001613 E38C D49BE6          17      CALL    NC,GNCLX
001616 E38F DA00E3          10      JP  C,RBRERR
001619 E392 10EE            13      DJNZ    RBRB1
00161B E394 CDEDE4          17      CALL    DRW_FLUSH
       E397                     RBRC:
00161E E397 CD66E4          17      CALL    RBXC
001621 E39A 2811            12      JR  Z,RBREND
001623 E39C C5              11      PUSH    BC
001624 E39D CD1CDF          17      CALL    CLUSTX
001627 E3A0 CD06E5          17      CALL    DRDX
00162A E3A3 C1              10      POP BC
00162B E3A4 DA00E3          10      JP  C,RBRERR
00162E E3A7 EB               4      EX  DE,HL
00162F E3A8 2A7EF1          16      LD  HL,(_DTBUF)
001632 E3AB EDB0                    LDIR
       E3AD                     RBREND:
001634 E3AD CD72E4          17      CALL    RBXEND
       E3B0                     RBREND0:
001637 E3B0 FDE1            14      POP IY
001639 E3B2 C1              10      POP BC
00163A E3B3 D1              10      POP DE
00163B E3B4 F1              10      POP AF  ;(HL)
00163C E3B5 AF               4      XOR A
00163D E3B6 3E00             7  RBRAP:  LD  A,000H
00163F E3B8 C9              10      RET
                                
       E3B9                     RBRDIR:
001640 E3B9 FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001643 E3BC FD661B          19      LD  H,(IY+27)
001646 E3BF CD5CDF          17      CALL    CHDIR
001649 E3C2 AF               4      XOR A
00164A E3C3 67               4      LD  H,A
00164B E3C4 6F               4      LD  L,A
00164C E3C5 3C               4      INC A
00164D E3C6 32B7E3          13      LD  (RBRAP+1),A
001650 E3C9 18E5            12      JR  RBREND0
                                
       E3CB                     RBX0:
001652 E3CB 2A8AF0          16      LD  HL,(_DTA)
001655 E3CE 225FF0          16      LD  (DTAX),HL
001658 E3D1 2A5DF0          16      LD  HL,(LEFTX)
00165B E3D4 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
00165E E3D7 D6FD             7      SUB 0FDH
001660 E3D9 C9              10      RET
                                
       E3DA                     RBX1:               ;ファイルサイズとランダムレコードを比べる
001661 E3DA E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
001662 E3DB FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
001665 E3DE FD6611          19      LD  H,(IY+17)   ;
001668 E3E1 FD7E12          19      LD  A,(IY+18)   ;
                                
00166B E3E4 CD89E4          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
00166E E3E7 A7               4      AND A
00166F E3E8 ED52            15      SBC HL,DE
001671 E3EA 99               4      SBC A,C
001672 E3EB 4F               4      LD  C,A
001673 E3EC FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
001676 E3EF 98               4      SBC A,B
001677 E3F0 D1              10      POP DE
001678 E3F1 C9              10      RET
       E3F2                     RBX1R:
001679 E3F2 47               4      LD  B,A
00167A E3F3 B1               4      OR  C
00167B E3F4 EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
00167C E3F5 B2               4      OR  D
00167D E3F6 B3               4      OR  E
00167E E3F7 C0              11      RET NZ
00167F E3F8 37               4      SCF
001680 E3F9 C9              10      RET
                                
       E3FA                     RBX2:               ;Cluster settings
001681 E3FA FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
001684 E3FD FD4E23          19      LD  C,(IY+35)
001687 E400 0600             7      LD  B,0
001689 E402 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00168D E406 2003            12      JR  NZ,RBX3
00168F E408 FD4624          19      LD  B,(IY+36)
       E40B                     RBX3:
001692 E40B CD11E1          17      CALL    RWXR
001695 E40E 3A30E4          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
001698 E411 3D               4      DEC A
001699 E412 FDA622          19      AND (IY+34)
00169C E415 FDB621          19      OR  (IY+33)
00169F E418 C9              10      RET
                                
       E419                     RBXA:
0016A0 E419 C5              11      PUSH    BC
0016A1 E41A D5              11      PUSH    DE
0016A2 E41B CD1CDF          17      CALL    CLUSTX
0016A5 E41E CD06E5          17      CALL    DRDX
0016A8 E421 D1              10      POP DE
0016A9 E422 C1              10      POP BC
0016AA E423 D49BE6          17      CALL    NC,GNCLX
0016AD E426 D8              11      RET C
0016AE E427 ED53FEF1        20      LD  (_CLPS),DE
                                
0016B2 E42B FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
0016B5 E42E 210004          10  SECSZ:  LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
0016B8 E431 7C               4      LD  A,H
0016B9 E432 3D               4      DEC A       ;1024=3 / 512=1
0016BA E433 FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
0016BD E436 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
0016BE E437 ED42            15      SBC HL,BC       ;残りを計算
                                
0016C0 E439 ED5B5DF0        20      LD  DE,(LEFTX)
0016C4 E43D ED52            15      SBC HL,DE       ;CP HL,DE
0016C6 E43F 19              11      ADD HL,DE       ;
0016C7 E440 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
0016C9 E442 EB               4      EX  DE,HL
       E443                     RBXA1:
0016CA E443 E5              11      PUSH    HL
0016CB E444 2A7EF1          16      LD  HL,(_DTBUF)
0016CE E447 09              11      ADD HL,BC
0016CF E448 ED5B5FF0        20      LD  DE,(DTAX)
0016D3 E44C C1              10      POP BC
0016D4 E44D C9              10      RET
                                
       E44E                     RBXB:
0016D5 E44E 2A5FF0          16      LD  HL,(DTAX)
0016D8 E451 ED5BFEF1        20      LD  DE,(_CLPS)
0016DC E455 3A5EF0          13      LD  A,(LEFTX+1)
0016DF E458 47               4      LD  B,A
0016E0 E459 3A30E4          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       E45C                     RBXB1:
0016E3 E45C 1F               4      RRA     ;->CF
0016E4 E45D 3804            12      JR  C,RBXB2
0016E6 E45F CB38             8      SRL B   ;B=B/2
0016E8 E461 18F9            12      JR  RBXB1
       E463                     RBXB2:
0016EA E463 78               4      LD  A,B
0016EB E464 B7               4      OR  A
0016EC E465 C9              10      RET
                                
       E466                     RBXC:
0016ED E466 ED4B5DF0        20      LD  BC,(LEFTX)
0016F1 E46A 3A30E4          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
0016F4 E46D 3D               4      DEC A
0016F5 E46E A0               4      AND B
0016F6 E46F 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
0016F7 E470 B1               4      OR  C
0016F8 E471 C9              10      RET
                                
       E472                     RBXEND:             ;レコード数だけランダムレコードを進める
0016F9 E472 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       E473                     RBSIZE  EQU $-2
0016FC E475 CDC0E1          17      CALL    GET_RR_AHL
0016FF E478 19              11      ADD HL,DE
001700 E479 CE00             7      ADC A,0
001702 E47B CDCAE1          17      CALL    SET_RR_AHL
001705 E47E EB               4      EX  DE,HL       ;HL=進めるレコード数
001706 E47F D0              11      RET NC
001707 E480 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00170B E484 C0              11      RET NZ
00170C E485 FD3424          23      INC (IY+36)
00170F E488 C9              10      RET
                                
       E489                     GET_RR_BCDE:            ;BCDE=Random record
001710 E489 FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
001713 E48C FD5622          19      LD  D,(IY+34)
001716 E48F FD4E23          19      LD  C,(IY+35)
001719 E492 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
00171B E494 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00171F E498 C0              11      RET NZ
001720 E499 FD4624          19      LD  B,(IY+36)
001723 E49C C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E49D                     DWTC:
001724 E49D E5              11      PUSH    HL
001725 E49E 212DE8          10      LD  HL,DWT24B
001728 E4A1 1804            12      JR  DWTC1
       E4A3                     DRDC:
00172A E4A3 E5              11      PUSH    HL
00172B E4A4 211DE8          10      LD  HL,DRD24B
       E4A7                     DWTC1:
00172E E4A7 2201E5          16      LD  (DRWF_MODE),HL
001731 E4AA E1              10      POP HL
001732 E4AB 3AF1E4          13      LD  A,(DRWF_B)
001735 E4AE B7               4      OR  A
001736 E4AF 200F            12      JR  NZ,DRDC1
       E4B1                     SAVE_DRWC:
001738 E4B1 0601             7      LD  B,1
00173A E4B3 ED43F0E4        20      LD  (DRWF_C),BC
00173E E4B7 ED53F7E4        20      LD  (DRWF_E),DE
001742 E4BB 22FAE4          16      LD  (DRWF_HL),HL
001745 E4BE 1820            12      JR  INC_HL_DRWC
       E4C0                     DRDC1:
001747 E4C0 E5              11      PUSH    HL
001748 E4C1 21F7E4          10      LD  HL,DRWF_E
00174B E4C4 86               7      ADD A,(HL)
00174C E4C5 F5              11      PUSH    AF
00174D E4C6 BB               4      CP  E
00174E E4C7 201D            12      JR  NZ,DRDC2
001750 E4C9 F1              10      POP AF
001751 E4CA 23               6      INC HL
001752 E4CB 7E               7      LD  A,(HL)
001753 E4CC CE00             7      ADC A,0
001755 E4CE F5              11      PUSH    AF
001756 E4CF BA               4      CP  D
001757 E4D0 2014            12      JR  NZ,DRDC2
001759 E4D2 F1              10      POP AF
00175A E4D3 3AF0E4          13      LD  A,(DRWF_C)
00175D E4D6 CE00             7      ADC A,0
00175F E4D8 B9               4      CP  C
001760 E4D9 200C            12      JR  NZ,DRDC3
001762 E4DB 21F1E4          10      LD  HL,DRWF_B
001765 E4DE 34              11      INC (HL)
001766 E4DF E1              10      POP HL
       E4E0                     INC_HL_DRWC:
001767 E4E0 3A30E4          13      LD  A,(SECSZ+2)     ;1セクタのサイズの上位1バイト
00176A E4E3 84               4      ADD A,H
00176B E4E4 67               4      LD  H,A
00176C E4E5 C9              10      RET
       E4E6                     DRDC2:
00176D E4E6 F1              10      POP AF
       E4E7                     DRDC3:
00176E E4E7 CDEDE4          17      CALL    DRW_FLUSH
001771 E4EA E1              10      POP HL
001772 E4EB 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E4ED                     DRW_FLUSH:
001774 E4ED C5              11      PUSH    BC
001775 E4EE D5              11      PUSH    DE
001776 E4EF 010000          10      LD  BC,0
       E4F0                     DRWF_C  EQU $-2
       E4F1                     DRWF_B  EQU $-1
001779 E4F2 78               4      LD  A,B
00177A E4F3 B7               4      OR  A
00177B E4F4 280D            12      JR  Z,DRDF1
00177D E4F6 110000          10      LD  DE,0
       E4F7                     DRWF_E  EQU $-2
       E4F8                     DRWF_D  EQU $-1
001780 E4F9 210000          10      LD  HL,0
       E4FA                     DRWF_HL EQU $-2
001783 E4FC AF               4      XOR A
001784 E4FD 32F1E4          13      LD  (DRWF_B),A
001787 E500 CD1DE8          17      CALL    DRD24B
       E501                     DRWF_MODE   EQU $-2
       E503                     DRDF1:
00178A E503 D1              10      POP DE
00178B E504 C1              10      POP BC
00178C E505 C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E506                     DRDX:
00178D E506 CD44E5          17      CALL    DRDY
001790 E509 C8              11      RET Z
001791 E50A CD2AE5          17      CALL    DRDX1       ;データバッファの情報を保存
001794 E50D D8              11      RET C
001795 E50E E5              11      PUSH    HL
001796 E50F C5              11      PUSH    BC
001797 E510 D5              11      PUSH    DE
001798 E511 2A7EF1          16      LD  HL,(_DTBUF)
00179B E514 3A6DE5          13      LD  A,(_DBS24+1)
00179E E517 4F               4      LD  C,A
00179F E518 CD1BE8          17      CALL    DRD24
0017A2 E51B DC3FE5          17      CALL    C,DRDNE
       E51E                     POP_DE_BC_HL_RET:
0017A5 E51E D1              10      POP DE
0017A6 E51F C1              10      POP BC
0017A7 E520 E1              10      POP HL
0017A8 E521 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E522                     DRDN:
0017A9 E522 AF               4      XOR A
0017AA E523 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
0017AB E524 30E0            12      JR  NC,DRDX
       E526                     DRDNX:
0017AD E526 CD44E5          17      CALL    DRDY
0017B0 E529 C8              11      RET Z
       E52A                     DRDX1:
0017B1 E52A CD5AE5          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
0017B4 E52D ED53A6F0        20      LD  (_DBSEC),DE
0017B8 E531 79               4      LD  A,C
0017B9 E532 326DE5          13      LD  (_DBS24+1),A
                                
0017BC E535 3A88F0          13      LD  A,(_DRV)
0017BF E538 32A5F0          13      LD  (_DBDRV),A
0017C2 E53B CDD9F0          17      CALL    _CHGDRV
0017C5 E53E D0              11      RET NC
       E53F                     DRDNE:
0017C6 E53F 9F               4      SBC A,A     ;CF=1ならばA=0FFH
0017C7 E540 32A5F0          13      LD  (_DBDRV),A
0017CA E543 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E544                     DRDY:
0017CB E544 3A6DE5          13      LD  A,(_DBS24+1)
0017CE E547 B9               4      CP  C
0017CF E548 C0              11      RET NZ
                                
0017D0 E549 E5              11      PUSH    HL
0017D1 E54A 3A88F0          13      LD  A,(_DRV)
0017D4 E54D 21A5F0          10      LD  HL,_DBDRV
0017D7 E550 AE               7      XOR (HL)
0017D8 E551 2005            12      JR  NZ,POP_HL_RET
                                
0017DA E553 2AA6F0          16      LD  HL,(_DBSEC)
0017DD E556 ED52            15      SBC HL,DE       ;CF=0
       E558                     POP_HL_RET:
0017DF E558 E1              10      POP HL
0017E0 E559 C9              10      RET
                                
       E55A                     DWTX:
0017E1 E55A 3AA4F0          13      LD  A,(_WTDBF)
0017E4 E55D B7               4      OR  A
0017E5 E55E C8              11      RET Z
0017E6 E55F AF               4      XOR A
0017E7 E560 32A4F0          13      LD  (_WTDBF),A
                                
0017EA E563 E5              11      PUSH    HL
0017EB E564 C5              11      PUSH    BC
0017EC E565 D5              11      PUSH    DE
0017ED E566 3AA5F0          13      LD  A,(_DBDRV)
0017F0 E569 CDD9F0          17      CALL    _CHGDRV
0017F3 E56C 0E00             7  _DBS24: LD  C,0
0017F5 E56E ED5BA6F0        20      LD  DE,(_DBSEC)
0017F9 E572 2A7EF1          16      LD  HL,(_DTBUF)
0017FC E575 D42BE8          17      CALL    NC,DWT24
       E578                     POP_DE_BC_HL_RET2:
0017FF E578 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E57A                     RDFATX:
001801 E57A E5              11      PUSH    HL
001802 E57B 3A88F0          13      LD  A,(_DRV)
001805 E57E 21AAF0          10      LD  HL,_FATDRV
001808 E581 AE               7      XOR (HL)
001809 E582 28D4            12      JR  Z,POP_HL_RET
                                
00180B E584 C5              11      PUSH    BC
00180C E585 D5              11      PUSH    DE
00180D E586 DDE5            15      PUSH    IX
00180F E588 CDA4E5          17      CALL    WTFATX
001812 E58B 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
001814 E58D AF               4      XOR A
001815 E58E 32ABF0          13      LD  (_FATIX),A
001818 E591 3A88F0          13      LD  A,(_DRV)
00181B E594 32AAF0          13      LD  (_FATDRV),A
00181E E597 CDE5F0          17      CALL    _RDFAT
       E59A                     RDFATE2:
001821 E59A 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
001823 E59C 9F               4      SBC A,A     ;A=0xFF
001824 E59D 32AAF0          13      LD  (_FATDRV),A
       E5A0                     POP_IX_DE_BC_HL_RET:
001827 E5A0 DDE1            14      POP IX
001829 E5A2 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E5A4                     WTFATX:
00182B E5A4 3AA2F0          13      LD  A,(_WTFATF)
00182E E5A7 B7               4      OR  A
00182F E5A8 C8              11      RET Z
001830 E5A9 E5              11      PUSH    HL
001831 E5AA 3AAAF0          13      LD  A,(_FATDRV)
001834 E5AD 21A5F0          10      LD  HL,_DBDRV
001837 E5B0 AE               7      XOR (HL)
001838 E5B1 CC5AE5          17      CALL    Z,DWTX
00183B E5B4 38A2            12      JR  C,POP_HL_RET
00183D E5B6 C5              11      PUSH    BC
00183E E5B7 D5              11      PUSH    DE
00183F E5B8 DDE5            15      PUSH    IX
001841 E5BA CD38E8          17      CALL    WTFAT
001844 E5BD AF               4      XOR A
001845 E5BE 32A2F0          13      LD  (_WTFATF),A
001848 E5C1 18DD            12      JR  POP_IX_DE_BC_HL_RET
                                
       E5C3                     NCL1:
00184A E5C3 7A               4      LD  A,D
00184B E5C4 B3               4      OR  E
00184C E5C5 37               4      SCF
00184D E5C6 C8              11      RET Z
                                
00184E E5C7 7A               4      LD  A,D
00184F E5C8 CB3F             8      SRL A   ;/2
001851 E5CA CB3F             8      SRL A   ;/2
                                
001853 E5CC E5              11      PUSH    HL
001854 E5CD 32ECE5          13      LD  (NCLPAT+2),A    ;_FATIX
001857 E5D0 2AAAF0          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
00185A E5D3 BC               4      CP  H
00185B E5D4 3A88F0          13      LD  A,(_DRV)    ;この間でフラグは変化しない
00185E E5D7 32EBE5          13      LD  (NCLPAT+1),A    ;_FATDRV
001861 E5DA 2005            12      JR  NZ,NCL2     ;FATIXが違う
001863 E5DC BD               4      CP  L
001864 E5DD 2002            12      JR  NZ,NCL2     ;ドライブが違う
001866 E5DF E1              10      POP HL
001867 E5E0 C9              10      RET
       E5E1                     NCL2:
001868 E5E1 C5              11      PUSH    BC
001869 E5E2 D5              11      PUSH    DE
00186A E5E3 DDE5            15      PUSH    IX
00186C E5E5 CDA4E5          17      CALL    WTFATX
00186F E5E8 38B6            12      JR  C,POP_IX_DE_BC_HL_RET
001871 E5EA 010000          10  NCLPAT: LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
001874 E5ED ED43AAF0        20      LD  (_FATDRV),BC
001878 E5F1 CD0DE8          17      CALL    RDFATS
00187B E5F4 18A4            12      JR  RDFATE2
                                
       E5F6                     NCL3:
00187D E5F6 CB9A             8      RES 3,D
00187F E5F8 CB92             8      RES 2,D
001881 E5FA 6B               4      LD  L,E
001882 E5FB 62               4      LD  H,D
001883 E5FC CB3C             8      SRL H   ;
001885 E5FE CB1D             8      RR  L   ;HLA=HLA/2
001887 E600 1F               4      RRA     ;
001888 E601 F5              11      PUSH    AF
001889 E602 3AABF0          13      LD  A,(_FATIX)
00188C E605 0F               4      RRCA
00188D E606 300B            12      JR  NC,NCL3X1
00188F E608 3A30E4          13      LD  A,(SECSZ+2)
001892 E60B FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
001894 E60D 2004            12      JR  NZ,NCL3X1
001896 E60F 010002          10      LD  BC,512
001899 E612 09              11      ADD HL,BC
       E613                     NCL3X1:
00189A E613 F1              10      POP AF
00189B E614 ED4B7CF1        20      LD  BC,(_FATBF)
00189F E618 19              11      ADD HL,DE
0018A0 E619 09              11      ADD HL,BC
0018A1 E61A 17               4      RLA
0018A2 E61B C9              10      RET
                                
       E61C                     GNCL:
0018A3 E61C CDC3E5          17      CALL    NCL1        ;GET NEXT CLUSTER
0018A6 E61F D8              11      RET C
0018A7 E620 C5              11      PUSH    BC
0018A8 E621 E5              11      PUSH    HL
0018A9 E622 CDF6E5          17      CALL    NCL3
0018AC E625 3809            12      JR  C,GNC1
0018AE E627 5E               7      LD  E,(HL)
0018AF E628 23               6      INC HL
0018B0 E629 7E               7      LD  A,(HL)
0018B1 E62A E60F             7      AND 00FH
0018B3 E62C 57               4      LD  D,A
0018B4 E62D E1              10      POP HL
0018B5 E62E C1              10      POP BC
0018B6 E62F C9              10      RET
       E630                     GNC1:
0018B7 E630 7E               7      LD  A,(HL)
0018B8 E631 23               6      INC HL
0018B9 E632 56               7      LD  D,(HL)
0018BA E633 0604             7      LD  B,4
       E635                     GNC1L:
0018BC E635 CB3A             8      SRL D   ;DA=DA/2
0018BE E637 1F               4      RRA     ;
0018BF E638 10FB            13      DJNZ    GNC1L
                                
0018C1 E63A 5F               4      LD  E,A
0018C2 E63B E1              10      POP HL
0018C3 E63C C1              10      POP BC
0018C4 E63D A7               4      AND A
0018C5 E63E C9              10      RET
                                
       E63F                     SNCL:
0018C6 E63F CDC3E5          17      CALL    NCL1
0018C9 E642 D8              11      RET C
                                ;               SET NEXT CLUSTER
0018CA E643 E5              11      PUSH    HL
0018CB E644 C5              11      PUSH    BC
0018CC E645 D5              11      PUSH    DE
0018CD E646 E5              11      PUSH    HL
0018CE E647 CDF6E5          17      CALL    NCL3
0018D1 E64A D1              10      POP DE
                                ;CF=ODD
0018D2 E64B 7E               7      LD  A,(HL)
0018D3 E64C 73               7      LD  (HL),E
0018D4 E64D 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
0018D6 E64F 23               6      INC HL
0018D7 E650 ED67            18      RRD     ;M={A[3:0],E[3:0]}
0018D9 E652 7A               4      LD  A,D
0018DA E653 1804            12      JR  SNC11
       E655                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
0018DC E655 ED6F            18      RLD     ;M={D[3:0],E[7:4]}
0018DE E657 23               6      INC HL
0018DF E658 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E659                     SNC11:
0018E0 E659 ED6F            18      RLD     ;M={M[7:4],D[3:0]}
0018E2 E65B B7               4      OR  A
0018E3 E65C D1              10      POP DE
0018E4 E65D C1              10      POP BC
0018E5 E65E E1              10      POP HL
       E65F                     FAT_CHANGED:
0018E6 E65F 3E01             7      LD  A,1
0018E8 E661 32A2F0          13      LD  (_WTFATF),A
0018EB E664 C9              10      RET
                                
       E665                     N16CL3:
0018EC E665 C5              11      PUSH    BC
0018ED E666 6B               4      LD  L,E
0018EE E667 7A               4      LD  A,D
0018EF E668 E603             7      AND 3
0018F1 E66A 67               4      LD  H,A
0018F2 E66B 29              11      ADD HL,HL
0018F3 E66C ED4B7CF1        20      LD  BC,(_FATBF)
0018F7 E670 09              11      ADD HL,BC
0018F8 E671 C1              10      POP BC
0018F9 E672 C9              10      RET
                                
       E673                     GNCL16:
0018FA E673 CDC3E5          17      CALL    NCL1        ;GET NEXT CLUSTER for FAT16
0018FD E676 D8              11      RET C
0018FE E677 E5              11      PUSH    HL
0018FF E678 CD65E6          17      CALL    N16CL3
001902 E67B 5E               7      LD  E,(HL)
001903 E67C 23               6      INC HL
001904 E67D 56               7      LD  D,(HL)
001905 E67E E1              10      POP HL
001906 E67F C9              10      RET
                                
       E680                     SNCL16:
001907 E680 CDC3E5          17      CALL    NCL1        ;GET NEXT CLUSTER for FAT16
00190A E683 D8              11      RET C
00190B E684 D5              11      PUSH    DE
00190C E685 E5              11      PUSH    HL
00190D E686 CD65E6          17      CALL    N16CL3
001910 E689 D1              10      POP DE      ;HL
001911 E68A 73               7      LD  (HL),E
001912 E68B 23               6      INC HL
001913 E68C 72               7      LD  (HL),D
001914 E68D 6B               4      LD  L,E
001915 E68E 62               4      LD  H,D
001916 E68F D1              10      POP DE
001917 E690 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E692                     NEXTX:
001919 E692 3E00             7  _SECPS: LD  A,0 ;自己書き換え
00191B E694 3C               4      INC A
00191C E695 E600             7  NCPAT:  AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
00191E E697 3293E6          13      LD  (_SECPS+1),A
001921 E69A C9              10      RET
                                
       E69B                     GNCLX:
001922 E69B CD92E6          17      CALL    NEXTX
001925 E69E C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
001926 E69F C3F7F0          10      JP  _GNCL   ;次のクラスタを探す
                                
       E6A2                     RDFAT:
001929 E6A2 3E80             7      LD  A,080H
00192B E6A4 3270F0          13      LD  (CHECK),A
       E6A7                     RDFAT1:
00192E E6A7 3A88F0          13      LD  A,(_DRV)
001931 E6AA CD62E9          17      CALL    CHGDRVR
001934 E6AD D8              11      RET C
001935 E6AE DD7E12          19      LD  A,(IX+012H) ;DPB_12_DEVICE
001938 E6B1 CB6F             8      BIT 5,A
00193A E6B3 286B            12      JR  Z,RDFAT0X
00193C E6B5 2170F0          10      LD  HL,CHECK
00193F E6B8 A6               7      AND (HL)
001940 E6B9 77               7      LD  (HL),A
001941 E6BA 110000          10      LD  DE,0        ;BPB
001944 E6BD 2A7CF1          16      LD  HL,(_FATBF)
001947 E6C0 CD19E8          17      CALL    DRD16
00194A E6C3 3024            12      JR  NC,GETBPB
00194C E6C5 2170F0          10      LD  HL,CHECK
00194F E6C8 CB06            15      RLC (HL)
001951 E6CA 3F               4      CCF
001952 E6CB D8              11      RET C
001953 E6CC DDCB0A1E        23      RR  (IX+00AH)   ;DPB_0A_FDMODE
001957 E6D0 3F               4      CCF         ;フロッピーディスクのFDモードを切り替える
001958 E6D1 DDCB0A16        23      RL  (IX+00AH)   ;DPB_0A_FDMODE
00195C E6D5 3EFF             7      LD  A,0FFH
00195E E6D7 3289F0          13      LD  (_DSK),A
001961 E6DA 3A84F0          13      LD  A,(_DRIVE)
001964 E6DD E603             7      AND 3
001966 E6DF F680             7      OR  080H
001968 E6E1 6F               4      LD  L,A
001969 E6E2 26F0             7      LD  H,_CYL0/256
00196B E6E4 3EFF             7      LD  A,0FFH
00196D E6E6 77               7      LD  (HL),A
00196E E6E7 18BE            12      JR  RDFAT1
       E6E9                     GETBPB:
001970 E6E9 FDE5            15      PUSH    IY
001972 E6EB FD2A7CF1        20      LD  IY,(_FATBF) ;BPB
001976 E6EF CDF1F0          17      CALL    _BPB2DPB
001979 E6F2 FDE1            14      POP IY
00197B E6F4 DD7E12          19      LD  A,(IX+012H) ;DPB_12_DEVICE
00197E E6F7 3021            12      JR  NC,GETBPBOK
001980 E6F9 E60F             7      AND 00FH
001982 E6FB FE07             7      CP  7
001984 E6FD 37               4      SCF
001985 E6FE C0              11      RET NZ
001986 E6FF DDCB0A46        20      BIT 0,(IX+00AH) ;DPB_0A_FDMODE
00198A E703 21C0F1          10      LD  HL,M2D
00198D E706 2002            12      JR  NZ,SETFDMODE
00198F E708 2ED2             7      LD  L,M2HD-STABLE
       E70A                     SETFDMODE:
001991 E70A DDE5            15      PUSH    IX
001993 E70C D1              10      POP DE
001994 E70D EDA0            16      LDI
001996 E70F EDA0            16      LDI
001998 E711 13               6      INC DE
001999 E712 13               6      INC DE
00199A E713 13               6      INC DE
00199B E714 13               6      INC DE
00199C E715 010C00          10      LD  BC,12
00199F E718 EDB0                    LDIR
       E71A                     GETBPBOK:
0019A1 E71A 3229E7          13      LD  (DEVSWC),A
0019A4 E71D CDC1E8          17      CALL    CHGDRV2
       E720                     RDFAT0X:
0019A7 E720 CD0DE8          17      CALL    RDFATS
0019AA E723 D8              11      RET C
0019AB E724 DDAE06          19      XOR (IX+6)      ;DPB_06_FATID
0019AE E727 C8              11      RET Z
0019AF E728 3E00             7      LD  A,0     ;DPB_12_DEVICE
       E729                     DEVSWC  EQU $-1
0019B1 E72A CB6F             8      BIT 5,A
0019B3 E72C C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
0019B4 E72D 37               4      SCF
0019B5 E72E C9              10      RET
                                
       E72F                     BPB2DPB:
0019B6 E72F FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
0019B9 E732 B7               4      OR  A
0019BA E733 37               4      SCF
0019BB E734 C0              11      RET NZ
       E735                     BPBOK:
0019BC E735 FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
0019BF E738 DD7707          19      LD  (IX+7),A    ;DPB_07_SECPCL
                                
0019C2 E73B FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
0019C5 E73E DD7700          19      LD  (IX+0),A    ;DPB_00_FATLN
0019C8 E741 FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
0019CB E744 DD7701          19      LD  (IX+1),A    ;DPB_00_FATLN
                                
0019CE E747 FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
0019D1 E74A FD660F          19      LD  H,(IY+15)
0019D4 E74D DD750E          19      LD  (IX+00EH),L ;DPB_0E_FATPS
0019D7 E750 FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
0019DA E753 FD5617          19      LD  D,(IY+23)
0019DD E756 FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E759                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
0019E0 E759 19              11      ADD HL,DE
0019E1 E75A 10FD            13      DJNZ    BPBDP1
       E75C                     BPBDP2:
0019E3 E75C DD7510          19      LD  (IX+010H),L ;DPB_10_DIRPS
0019E6 E75F DD7411          19      LD  (IX+011H),H
0019E9 E762 E5              11      PUSH    HL
                                
0019EA E763 FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
0019ED E766 FD6612          19      LD  H,(IY+18)
0019F0 E769 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
0019F3 E76C B7               4      OR  A
0019F4 E76D 37               4      SCF
0019F5 E76E C8              11      RET Z
0019F6 E76F 0606             7      LD  B,6
       E771                     BPBBPS1:
0019F8 E771 05               4      DEC B
0019F9 E772 0F               4      RRCA
0019FA E773 30FC            12      JR  NC,BPBBPS1
       E775                     BPBDE1:
0019FC E775 29              11      ADD HL,HL
0019FD E776 10FD            13      DJNZ    BPBDE1
                                
0019FF E778 7C               4      LD  A,H
001A00 E779 DD770B          19      LD  (IX+00BH),A ;DPB_0B_DIRSCNT
                                
001A03 E77C D1              10      POP DE      ;DPB_10_DIRPS
001A04 E77D 6C               4      LD  L,H
001A05 E77E 2600             7      LD  H,0
001A07 E780 19              11      ADD HL,DE       ;MAXDIR
001A08 E781 E5              11      PUSH    HL
001A09 E782 FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
001A0C E785 CB21             8      SLA C       ;*2
001A0E E787 AF               4      XOR A
001A0F E788 47               4      LD  B,A
001A10 E789 ED42            15      SBC HL,BC
001A12 E78B DD7514          19      LD  (IX+014H),L ;DPB_14_ADDCL16
001A15 E78E DD7415          19      LD  (IX+015H),H
                                
001A18 E791 D1              10      POP DE      ;DE=DPB_0B_MAXDIR
001A19 E792 FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
001A1C E795 FD6614          19      LD  H,(IY+20)
                                
001A1F E798 DD7E12          19      LD  A,(IX+012H) ;DPB_12_DEVICE
001A22 E79B E60F             7      AND 00FH
001A24 E79D FE07             7      CP  7       ;フロッピー
001A26 E79F 2019            12      JR  NZ,NOT_FD
001A28 E7A1 E5              11      PUSH    HL
001A29 E7A2 FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
001A2C E7A5 DD710D          19      LD  (IX+00DH),C ;DPB_0D_MAXSEC
001A2F E7A8 AF               4      XOR A
001A30 E7A9 CB21             8      SLA C       ;両面なのでセクタ数を２倍
001A32 E7AB 0610             7      LD  B,16
       E7AD                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
001A34 E7AD 29              11      ADD HL,HL
001A35 E7AE 17               4      RLA
001A36 E7AF B9               4      CP  C
001A37 E7B0 3802            12      JR  C,DIVSEC1
001A39 E7B2 91               4      SUB C
001A3A E7B3 2C               4      INC L
       E7B4                     DIVSEC1:
001A3B E7B4 10F7            13      DJNZ    DIVSEC
001A3D E7B6 DD750C          19      LD  (IX+00CH),L ;DPB_0C_MAXCYL
001A40 E7B9 E1              10      POP HL  ;ここまでフロッピー専用
       E7BA                     NOT_FD:
001A41 E7BA 7C               4      LD  A,H
001A42 E7BB B5               4      OR  L
001A43 E7BC 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001A45 E7BE 2010            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001A47 E7C0 FD7E23          19      LD  A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001A4A E7C3 B7               4      OR  A
001A4B E7C4 37               4      SCF
001A4C E7C5 C0              11      RET NZ
001A4D E7C6 FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001A50 E7C9 FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_07_SECPCL)が最大128なので
001A53 E7CC FD7E22          19      LD  A,(IY+34)   ;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
001A56 E7CF A7               4      AND A       ;CF=0
       E7D0                     BPB16BIT:
001A57 E7D0 ED52            15      SBC HL,DE
001A59 E7D2 DE00             7      SBC A,0
001A5B E7D4 FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E7D7                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001A5E E7D7 CB18             8      RR  B       ;->CY
001A60 E7D9 3808            12      JR  C,BPBTC2
001A62 E7DB CB3F             8      SRL A
001A64 E7DD CB1C             8      RR  H       ;AHL=AHL/2
001A66 E7DF CB1D             8      RR  L
001A68 E7E1 18F4            12      JR  BPBTC1
       E7E3                     BPBTC2:
001A6A E7E3 B7               4      OR  A
001A6B E7E4 37               4      SCF
001A6C E7E5 C0              11      RET NZ      ;念のため(クラスタ数が16ビットを超える場合)
001A6D E7E6 23               6      INC HL
001A6E E7E7 23               6      INC HL
001A6F E7E8 DD7508          19      LD  (IX+8),L    ;DPB_08_MAXCL
001A72 E7EB DD7409          19      LD  (IX+9),H
                                
001A75 E7EE FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001A78 E7F1 DD7706          19      LD  (IX+6),A    ;DPB_06_FATID
                                
001A7B E7F4 FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001A7E E7F7 C6FE             7      ADD A,0-2       ;>2:CF=1
001A80 E7F9 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001A83 E7FC 6F               4      LD  L,A
001A84 E7FD 3002            12      JR  NC,BPBFAT1
001A86 E7FF F680             7      OR  080H
       E801                     BPBFAT1:
001A88 E801 DD770F          19      LD  (IX+00FH),A ;DPB_0F_BPS
001A8B E804 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001A8C E805 C8              11      RET Z       ;1セクタ256バイト
001A8D E806 2D               4      DEC L
001A8E E807 C8              11      RET Z       ;1セクタ512バイト
001A8F E808 2D               4      DEC L
001A90 E809 2D               4      DEC L
001A91 E80A C8              11      RET Z       ;1セクタ1024バイト
001A92 E80B 37               4      SCF
001A93 E80C C9              10      RET
                                
       E80D                     RDFATS:
001A94 E80D CD53E8          17      CALL    FATSETUP
001A97 E810 D8              11      RET C
001A98 E811 CD1DE8          17      CALL    DRD24B
001A9B E814 2A7CF1          16      LD  HL,(_FATBF)
001A9E E817 7E               7      LD  A,(HL)
001A9F E818 C9              10      RET
                                
       E819                     DRD16:
001AA0 E819 0E00             7      LD  C,0
       E81B                     DRD24:
001AA2 E81B 0601             7      LD  B,1
       E81D                     DRD24B:
001AA4 E81D DDE5            15      PUSH    IX
001AA6 E81F DD2AA8F0        20      LD  IX,(_DPB)
001AAA E823 CDACEA          17  DRDPAT: CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E826                     POP_IX_RET:
001AAD E826 DDE1            14      POP IX
001AAF E828 C9              10      RET
                                
       E829                     DWT16:
001AB0 E829 0E00             7      LD  C,0
       E82B                     DWT24:
001AB2 E82B 0601             7      LD  B,1
       E82D                     DWT24B:
001AB4 E82D DDE5            15      PUSH    IX
001AB6 E82F DD2AA8F0        20      LD  IX,(_DPB)
001ABA E833 CD52EA          17  DWTPAT: CALL    FDWT        ;自己書き換え（ディスク書き込み）
001ABD E836 18EE            12      JR  POP_IX_RET
                                
       E838                     WTFAT:
001ABF E838 CD53E8          17      CALL    FATSETUP
001AC2 E83B D42DE8          17      CALL    NC,DWT24B
001AC5 E83E D8              11      RET C
001AC6 E83F DDCB0F7E        20      BIT 7,(IX+00FH) ;DPB_0F_BPS
001ACA E843 C8              11      RET Z       ;予備FATが無い
001ACB E844 CD5AE8          17      CALL    FATS2
001ACE E847 E5              11      PUSH    HL      ;予備FAT
001ACF E848 DD6E00          19      LD  L,(IX+0)    ;DPB_00_FATLN
001AD2 E84B DD6601          19      LD  H,(IX+1)
001AD5 E84E 19              11      ADD HL,DE
001AD6 E84F EB               4      EX  DE,HL
001AD7 E850 E1              10      POP HL
001AD8 E851 18DA            12      JR  DWT24B
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ1024毎に2KBを切り替える
                                ;------------------------
       E853                     FATSETUP:
001ADA E853 3AAAF0          13      LD  A,(_FATDRV)
001ADD E856 CD62E9          17      CALL    CHGDRVR     ;ドライブ切り替え
001AE0 E859 D8              11      RET C
       E85A                     FATS2:
001AE1 E85A DD7E0F          19      LD  A,(IX+00FH) ;DPB_0F_BPS 512=2 1024=4
001AE4 E85D 0F               4      RRCA
001AE5 E85E CD87E8          17  FATSX:  CALL    FATSETUP12  ;自己書き換え
001AE8 E861 210000          10      LD  HL,0
001AEB E864 4A               4      LD  C,D
001AEC E865 54               4      LD  D,H
001AED E866 3AABF0          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
001AF0 E869 47               4      LD  B,A
001AF1 E86A 04               4      INC B
001AF2 E86B DD7E00          19      LD  A,(IX+0)    ;DPB_00_FATLN
       E86E                     FAT_SKP:
001AF5 E86E 05               4      DEC B
001AF6 E86F 2805            12      JR  Z,FAT1
001AF8 E871 19              11      ADD HL,DE
001AF9 E872 93               4      SUB E
001AFA E873 30F9            12      JR  NC,FAT_SKP
001AFC E875 C9              10      RET
       E876                     FAT1:
001AFD E876 EB               4      EX  DE,HL
001AFE E877 B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001AFF E878 3801            12      JR  C,FAT2
001B01 E87A 79               4      LD  A,C
       E87B                     FAT2:
001B02 E87B 47               4      LD  B,A
                                
001B03 E87C 2AFAF1          16      LD  HL,(_FATPS) ;fat sector pos
001B06 E87F 19              11      ADD HL,DE
001B07 E880 EB               4      EX  DE,HL
001B08 E881 2A7CF1          16      LD  HL,(_FATBF)
001B0B E884 AF               4      XOR A       ;CF=0
001B0C E885 4F               4      LD  C,A
001B0D E886 C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       E887                     FATSETUP12:
001B0E E887 110606          10      LD  DE,0606H    ;256
001B11 E88A D8              11      RET C
001B12 E88B 110303          10      LD  DE,0303H    ;512
001B15 E88E 0F               4      RRCA
001B16 E88F D8              11      RET C
001B17 E890 110102          10      LD  DE,0201H    ;1024
001B1A E893 C9              10      RET
                                
       E894                     FATSETUP16:
001B1B E894 110808          10      LD  DE,0808H    ;256
001B1E E897 D8              11      RET C
001B1F E898 110404          10      LD  DE,0404H
001B22 E89B 0F               4      RRCA            ;512
001B23 E89C D8              11      RET C
001B24 E89D 110202          10      LD  DE,0202H    ;1024
001B27 E8A0 C9              10      RET
                                
       E8A1                     CHGDRV:
001B28 E8A1 E5              11      PUSH    HL
001B29 E8A2 2189F0          10      LD  HL,_DSK
001B2C E8A5 BE               7      CP  (HL)
001B2D E8A6 280A            12      JR  Z,CHGDRVE
       E8A8                     CHGDRV1:
001B2F E8A8 DDE5            15      PUSH    IX
001B31 E8AA CDB4E8          17      CALL    CHGDRV0
001B34 E8AD 3A89F0          13      LD  A,(_DSK)
001B37 E8B0 DDE1            14      POP IX
       E8B2                     CHGDRVE:
001B39 E8B2 E1              10      POP HL
001B3A E8B3 C9              10      RET
                                
       E8B4                     CHGDRV0:
001B3B E8B4 6F               4      LD  L,A
001B3C E8B5 CDDCF0          17      CALL    _GETDPB
001B3F E8B8 D8              11      RET C
001B40 E8B9 DD22A8F0        20      LD  (_DPB),IX
001B44 E8BD 7D               4      LD  A,L
001B45 E8BE 3289F0          13      LD  (_DSK),A
       E8C1                     CHGDRV2:
001B48 E8C1 C5              11      PUSH    BC
001B49 E8C2 D5              11      PUSH    DE
001B4A E8C3 ED7318E9        20      LD  (SPPAT2+1),SP
001B4E E8C7 F3               4      DI
001B4F E8C8 DDF9            10      LD  SP,IX
                                
001B51 E8CA E1              10      POP HL      ;DPB_00_FATLN
001B52 E8CB E1              10      POP HL      ;DPB_02_DRD
001B53 E8CC 2224E8          16      LD  (DRDPAT+1),HL
                                
001B56 E8CF E1              10      POP HL
001B57 E8D0 2234E8          16      LD  (DWTPAT+1),HL   ;DPB_04_DWT
                                
001B5A E8D3 E1              10      POP HL      ;L=DPB_06_FATID H=DPB_07_SECPCL
001B5B E8D4 7C               4      LD  A,H
001B5C E8D5 3220DF          13      LD  (SPCPAT+1),A    ;1クラスタの論理セクタ数
001B5F E8D8 3D               4      DEC A
001B60 E8D9 3296E6          13      LD  (NCPAT+1),A
                                
001B63 E8DC E1              10      POP HL      ;DPB_08_MAXCL
001B64 E8DD 7D               4      LD  A,L
001B65 E8DE 323FDF          13      LD  (CLPAT2+1),A
001B68 E8E1 7C               4      LD  A,H
001B69 E8E2 323BDF          13      LD  (CLPAT1+1),A
001B6C E8E5 2B               6      DEC HL
001B6D E8E6 2247E1          16      LD  (MAXCLP+1),HL
                                
001B70 E8E9 E1              10      POP HL      ;L=DPB_0A_FDMODE H=DPB_0B_DIRSCNT
001B71 E8EA 7D               4      LD  A,L
001B72 E8EB F6FE             7      OR  0FEH
001B74 E8ED 32B3F0          13      LD  (FDMODE+1),A
001B77 E8F0 07               4      RLCA
001B78 E8F1 E603             7      AND 3
001B7A E8F3 32EFE9          13      LD  (FSPAT+1),A
001B7D E8F6 4C               4      LD  C,H
                                
001B7E E8F7 E1              10      POP HL      ;L=DPB_0C_MAXCYL H=DPB_0D_MAXSEC
                                
001B7F E8F8 E1              10      POP HL      ;L=DPB_0E_FATPS H=DPB_0F_BPS
001B80 E8F9 7C               4      LD  A,H     ;DPB_0F_BPS
001B81 E8FA E607             7      AND 7
001B83 E8FC 3230E4          13      LD  (SECSZ+2),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98
                                                ;1セクタ256 GRAM/RAMF/CMOS/等
                                                ;1024   512 256
                                                ;4  2   1
001B86 E8FF 87               4      ADD A,A     ;8  4   2
001B87 E900 87               4      ADD A,A     ;010H   8   4
001B88 E901 87               4      ADD A,A     ;020H   010H    8
001B89 E902 329CDD          13      LD  (SDECPAT+1),A   ;1セクタ辺りのディレクトリエントリ数
                                
001B8C E905 2600             7      LD  H,0
001B8E E907 22FAF1          16      LD  (_FATPS),HL
                                
001B91 E90A E1              10      POP HL      ;DPB_10_DIRPS
001B92 E90B 22FCF1          16      LD  (_DIRPS),HL
                                
001B95 E90E E1              10      POP HL      ;L=DPB_12_DEVICE H=DPB_13_UNITNO
001B96 E90F 7C               4      LD  A,H
001B97 E910 3284F0          13      LD  (_DRIVE),A
                                
001B9A E913 E1              10      POP HL      ;DPB_14_ADDCL16
001B9B E914 2230DF          16      LD  (CLSPAT+1),HL
                                
001B9E E917 310000          10  SPPAT2: LD  SP,0        ;元のSPを復元
001BA1 E91A FB               4      EI
001BA2 E91B 2AFCF1          16      LD  HL,(_DIRPS)
001BA5 E91E 0600             7      LD  B,0
001BA7 E920 09              11      ADD HL,BC       ;C=DPB_0B_DIRSCNT
001BA8 E921 22B7DD          16      LD  (MD_PAT+1),HL
                                
001BAB E924 2A47E1          16      LD  HL,(MAXCLP+1);
001BAE E927 11F60F          10      LD  DE,4086     ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001BB1 E92A ED52            15      SBC HL,DE       ;CF=0のはず
001BB3 E92C 300F            12      JR  NC,SETFAT16
001BB5 E92E 211CE6          10      LD  HL,GNCL     ;FAT12
001BB8 E931 113FE6          10      LD  DE,SNCL
001BBB E934 0187E8          10      LD  BC,FATSETUP12
001BBE E937 DDCB0FAE        23      RES 5,(IX+00FH) ;DPB_0F_BPS(FAT12)
001BC2 E93B 180D            12      JR  EXTRA1
       E93D                     SETFAT16:
001BC4 E93D 2173E6          10      LD  HL,GNCL16   ;FAT16
001BC7 E940 1180E6          10      LD  DE,SNCL16
001BCA E943 0194E8          10      LD  BC,FATSETUP16
001BCD E946 DDCB0FEE        23      SET 5,(IX+00FH) ;DPB_0F_BPS(FAT16)
       E94A                     EXTRA1:
001BD1 E94A 22F8F0          16      LD  (GNCPAT+1),HL
001BD4 E94D ED53FBF0        20      LD  (SNCPAT+1),DE
001BD8 E951 ED435FE8        20      LD  (FATSX+1),BC
001BDC E955 D1              10      POP DE
001BDD E956 C1              10      POP BC
001BDE E957 AF               4      XOR A
001BDF E958 C9              10      RET
                                
       E959                     GETDPBD:
001BE0 E959 DDE3            23      EX  (SP),IX
001BE2 E95B DDE5            15      PUSH    IX
001BE4 E95D 3A88F0          13      LD  A,(_DRV)
001BE7 E960 1807            12      JR  GETDPB1
                                
       E962                     CHGDRVR:
001BE9 E962 CDD9F0          17      CALL    _CHGDRV
001BEC E965 D8              11      RET C
001BED E966 3A89F0          13      LD  A,(_DSK)
       E969                     GETDPB1:
001BF0 E969 C3DCF0          10      JP  _GETDPB
                                
       E96C                     GETDPB:
001BF3 E96C FE08             7      CP  8
001BF5 E96E 3F               4      CCF
001BF6 E96F D8              11      RET C
001BF7 E970 0F               4      RRCA
001BF8 E971 0F               4      RRCA
001BF9 E972 0F               4      RRCA
001BFA E973 DD                      DB  0DDH        ;Z80未定義命令
001BFB E974 6F               4      LD  L,A     ;LD IXL,A
001BFC E975 DD                      DB  0DDH        ;Z80未定義命令
001BFD E976 26F2             7      LD  H,DEVICE/256    ;LD IXH,DEVICE/256
001BFF E978 DD7E00          19      LD  A,(IX+0)    ;DPB_00_FATLN
001C02 E97B A7               4      AND A       ;CF=0の為
001C03 E97C DDCB0F6E        20      BIT 5,(IX+00FH) ;DPB_0F_BPS
001C07 E980 C0              11      RET NZ      ;FAT16
001C08 E981 DDCB126E        20      BIT 5,(IX+012H) ;DPB_12_DEVICE
001C0C E985 C0              11      RET NZ      ;BPB
001C0D E986 FE01             7      CP  001H        ;A=0 THEN CF=1
001C0F E988 C9              10      RET
                                
       E989                     _SYS5F:
001C10 E989 AF               4      XOR A
       E98A                     FFLUSH:
001C11 E98A F5              11      PUSH    AF
001C12 E98B 3EFF             7      LD  A,0FFH
001C14 E98D 3239F0          13      LD  (SFILE),A
001C17 E990 CD5AE5          17      CALL    DWTX
001C1A E993 3EFF             7      LD  A,0FFH
001C1C E995 32A5F0          13      LD  (_DBDRV),A
001C1F E998 CDA4E5          17      CALL    WTFATX
001C22 E99B AF               4      XOR A
001C23 E99C 32ABF0          13      LD  (_FATIX),A
001C26 E99F 2F               4      CPL         ;0FFH
001C27 E9A0 32AAF0          13      LD  (_FATDRV),A
001C2A E9A3 F1              10      POP AF
001C2B E9A4 C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   MZ-700/1500
                                
       E9A5                     SEEK:
001C2C E9A5 0610             7      LD  B,16
001C2E E9A7 DD4E0D          19  MAXSEC: LD  C,(IX+0DH)  ;DPB_0D_MAXSEC
001C31 E9AA AF               4      XOR A
001C32 E9AB EB               4      EX  DE,HL
       E9AC                     DIV1:
001C33 E9AC 29              11      ADD HL,HL
001C34 E9AD 8F               4      ADC A,A
001C35 E9AE B9               4      CP  C
001C36 E9AF 3802            12      JR  C,DIV2
001C38 E9B1 91               4      SUB C
001C39 E9B2 2C               4      INC L
       E9B3                     DIV2:
001C3A E9B3 10F7            13      DJNZ    DIV1
                                
001C3C E9B5 3C               4      INC A   ;最小のセクタは１固定
001C3D E9B6 55               4      LD  D,L ;TRACK
001C3E E9B7 5F               4      LD  E,A ;SECTOR
                                
001C3F E9B8 3A84F0          13      LD  A,(_DRIVE)
001C42 E9BB FE04             7      CP  4
001C44 E9BD 3F               4      CCF
001C45 E9BE D8              11      RET C
001C46 E9BF F684             7      OR  084H        ;Motor on + ドライブセレクト有効
001C48 E9C1 D3DC            11      OUT (0DCH),A
001C4A E9C3 CB3A             8      SRL D       ;CYLINDER
001C4C E9C5 9F               4      SBC A,A
001C4D E9C6 D3DD            11      OUT (0DDH),A    ;SIDE
                                
001C4F E9C8 CD05EA          17      CALL    SETMODE
001C52 E9CB D8              11      RET C
                                
001C53 E9CC CD3CEA          17      CALL    DRIVE
001C56 E9CF FEFF             7      CP  0FFH        ;A=0FFH Unknown CYLINDER
001C58 E9D1 CC21EA          17      CALL    Z,FDCRES    ;Restore
001C5B E9D4 2F               4      CPL         ;データバスが負論理
001C5C E9D5 D3D9            11      OUT (0D9H),A    ;Currrent CYLINDER
001C5E E9D7 2F               4      CPL         ;データバスが負論理
001C5F E9D8 92               4      SUB D
001C60 E9D9 C8              11      RET Z       ;No seek
                                
001C61 E9DA 3A86F0          13      LD  A,(_ISEEK)
001C64 E9DD 4F               4      LD  C,A
                                
001C65 E9DE DD7E0C          19      LD  A,(IX+00CH) ;DPB_0C_MAXCYL
001C68 E9E1 3D               4      DEC A
001C69 E9E2 BA               4      CP  D       ;Over CYLINDER
001C6A E9E3 D8              11      RET C
                                
001C6B E9E4 7A               4      LD  A,D
001C6C E9E5 2F               4      CPL         ;データバスが負論理
001C6D E9E6 D3DB            11      OUT (0DBH),A
001C6F E9E8 72               7      LD  (HL),D
                                
001C70 E9E9 0E18             7      LD  C,018H      ;Seek
       E9EB                     FDCCMD2:
001C72 E9EB 3A85F0          13      LD  A,(_SEEKSP)
001C75 E9EE E6FF             7  FSPAT:  AND 0FFH
001C77 E9F0 B1               4      OR  C
                                
       E9F1                     FDCCMD:
001C78 E9F1 CD33EA          17      CALL    COMSET
       E9F5                     FDCSMC  EQU $+1
001C7B E9F4 3E80             7      LD  A,080H      ;FDC COMMAND(Self-modifying code)
001C7D E9F6 E620             7      AND 020H        ;Write data Write track
001C7F E9F8 3C               4      INC A
                                
       E9F9                     SST:
001C80 E9F9 0E00             7      LD  C,0
       E9FB                     SST1:
001C82 E9FB 0D               4      DEC C       ; 4
001C83 E9FC 20FD            12      JR  NZ,SST1     ;12 * 256 / 4 = About 1ms
001C85 E9FE 3D               4      DEC A
001C86 E9FF 20FA            12      JR  NZ,SST1
                                
001C88 EA01 3C               4      INC A       ;A=1
001C89 EA02 CD0AEA          17      CALL    READY
       EA05                     SETMODE:
001C8C EA05 CD36EA          17      CALL    DELAY0      ;Head select time
001C8F EA08 3E81             7      LD  A,081H
       EA0A                     READY:
001C91 EA0A 3214EA          13      LD  (WAITA),A
001C94 EA0D E5              11      PUSH    HL
001C95 EA0E 26F8             7      LD  H,0F8H
       EA10                     READY2:
001C97 EA10 DBD8            11      IN  A,(0D8H)
001C99 EA12 2F               4      CPL         ;データバスが負論理
       EA14                     WAITA   EQU $+1
001C9A EA13 E681             7      AND 081H        ;NOT READY,BUSY
001C9C EA15 2808            12      JR  Z,READYE
001C9E EA17 E3              19      EX  (SP),HL     ;wait 19clock
001C9F EA18 E3              19      EX  (SP),HL     ; //
001CA0 EA19 2B               6      DEC HL
001CA1 EA1A 7C               4      LD  A,H
001CA2 EA1B B5               4      OR  L
001CA3 EA1C 20F2            12      JR  NZ,READY2
001CA5 EA1E 37               4      SCF
       EA1F                     READYE:
001CA6 EA1F E1              10      POP HL
001CA7 EA20 C9              10      RET
                                
       EA21                     FDCRES:
001CA8 EA21 3600            10      LD  (HL),0
001CAA EA23 0E08             7      LD  C,8
001CAC EA25 18C4            12      JR  FDCCMD2
                                
       EA27                     FDMOFF:
001CAE EA27 F5              11      PUSH    AF
001CAF EA28 AF               4      XOR A       ;Motor off(ドライブセレクト無効)
001CB0 EA29 D3DC            11      OUT (0DCH),A
001CB2 EA2B F1              10      POP AF
001CB3 EA2C C9              10      RET
                                
       EA2D                     SECSET:
001CB4 EA2D F5              11      PUSH    AF
001CB5 EA2E 7B               4      LD  A,E
001CB6 EA2F 2F               4      CPL         ;データバスが負論理
001CB7 EA30 D3DA            11      OUT (0DAH),A
001CB9 EA32 F1              10      POP AF
       EA33                     COMSET:
001CBA EA33 2F               4      CPL         ;データバスが負論理
001CBB EA34 D3D8            11      OUT (0D8H),A
       EA36                     DELAY0:
001CBD EA36 3E1A             7      LD  A,26
       EA38                     DELAY:
001CBF EA38 3D               4      DEC A
001CC0 EA39 20FD            12      JR  NZ,DELAY
001CC2 EA3B C9              10      RET
                                
       EA3C                     DRIVE:
001CC3 EA3C 2A84F0          16      LD  HL,(_DRIVE)
001CC6 EA3F 26F0             7      LD  H,_CYL0/256
001CC8 EA41 CBFD             8      SET 7,L
001CCA EA43 7E               7      LD  A,(HL)
001CCB EA44 C9              10      RET
                                
       EA45                     RNF:
001CCC EA45 CD3CEA          17      CALL    DRIVE
001CCF EA48 36FF            10      LD  (HL),0FFH
001CD1 EA4A C9              10      RET
                                
001CD2 EA4B 02                  RETRY:  DB  2
                                
                                
                                ;   FLOPPY DISK DRIVER
                                
       EA4C                     WTTRK:
001CD3 EA4C 0601             7      LD  B,1
001CD5 EA4E 3EF4             7      LD  A,0F4H
001CD7 EA50 1802            12      JR  WTTRK1
       EA52                     FDWT:
001CD9 EA52 3EA0             7      LD  A,0A0H
       EA54                     WTTRK1:
001CDB EA54 32F5E9          13      LD  (FDCSMC),A
       EA57                     DWTBL:
001CDE EA57 78               4      LD  A,B
001CDF EA58 3297EA          13      LD  (WTBSMC),A
001CE2 EA5B 3E02             7      LD  A,2     ;Retry count
001CE4 EA5D 324BEA          13      LD  (RETRY),A
                                
       EA60                     DWT0:
001CE7 EA60 D5              11      PUSH    DE
001CE8 EA61 E5              11      PUSH    HL
001CE9 EA62 CDA5E9          17      CALL    SEEK        ;Write disk
001CEC EA65 E1              10      POP HL
001CED EA66 383A            12      JR  C,ERRDW
001CEF EA68 F3               4      DI
001CF0 EA69 3AF5E9          13      LD  A,(FDCSMC)
001CF3 EA6C CD2DEA          17      CALL    SECSET
001CF6 EA6F 0EDB             7      LD  C,0DBH
       EA71                     DWT1:
001CF8 EA71 7E               7      LD  A,(HL)
001CF9 EA72 2F               4      CPL         ;データバスが負論理
001CFA EA73 57               4      LD  D,A
                                
       EA74                     DWT2:
001CFB EA74 DBD8            11      IN  A,(0D8H)
001CFD EA76 2F               4      CPL         ;データバスが負論理
001CFE EA77 0F               4      RRCA
001CFF EA78 3008            12      JR  NC,DWT4
001D01 EA7A 0F               4      RRCA
001D02 EA7B 30F7            12      JR  NC,DWT2
       EA7D                     DWT3:
001D04 EA7D ED51            12      OUT (C),D
001D06 EA7F 23               6      INC HL
001D07 EA80 18EF            12      JR  DWT1
                                
       EA82                     DWT4:
001D09 EA82 3D               4      DEC A
001D0A EA83 28F8            12      JR  Z,DWT3
001D0C EA85 3C               4      INC A
001D0D EA86 FB               4      EI
001D0E EA87 D1              10      POP DE
001D0F EA88 13               6      INC DE
001D10 EA89 CD27EA          17      CALL    FDMOFF
001D13 EA8C 2808            12      JR  Z,DISKOK_WT
001D15 EA8E CDF9EA          17      CALL    DISKC
001D18 EA91 20CD            12      JR  NZ,DWT0
001D1A EA93 B7               4      OR  A
001D1B EA94 2005            12      JR  NZ,ERRW
                                
       EA96                     DISKOK_WT:
       EA97                     WTBSMC  EQU $+1
001D1D EA96 0601             7      LD  B,1
001D1F EA98 10BD            13      DJNZ    DWTBL
001D21 EA9A C9              10      RET
                                
       EA9B                     ERRW:
001D22 EA9B 3EFF             7      LD  A,0FFH
       EA9D                     ERRZ:
001D24 EA9D BF               4      CP  A
001D25 EA9E 37               4      SCF
001D26 EA9F C327EA          10      JP  FDMOFF
                                
       EAA2                     ERRDW:
001D29 EAA2 D1              10      POP DE
001D2A EAA3 CD0AEB          17      CALL    DELP
001D2D EAA6 20B8            12      JR  NZ,DWT0
001D2F EAA8 B7               4      OR  A
001D30 EAA9 20F0            12      JR  NZ,ERRW
001D32 EAAB C9              10      RET
                                
       EAAC                     FDRD:
001D33 EAAC 3E80             7      LD  A,080H
001D35 EAAE 32F5E9          13      LD  (FDCSMC),A
       EAB1                     DRDBL:
001D38 EAB1 78               4      LD  A,B
001D39 EAB2 32EBEA          13      LD  (RDBSMC),A
001D3C EAB5 3E02             7      LD  A,2     ;Retry count
001D3E EAB7 324BEA          13      LD  (RETRY),A
       EABA                     DRD0:
001D41 EABA D5              11      PUSH    DE
001D42 EABB E5              11      PUSH    HL
001D43 EABC CDA5E9          17      CALL    SEEK        ;Read disk
001D46 EABF E1              10      POP HL
001D47 EAC0 382D            12      JR  C,ERRDR
001D49 EAC2 F3               4      DI
001D4A EAC3 3AF5E9          13      LD  A,(FDCSMC)
001D4D EAC6 CD2DEA          17      CALL    SECSET
       EAC9                     DRD1:
001D50 EAC9 DBD8            11      IN  A,(0D8H)
001D52 EACB 2F               4      CPL         ;データバスが負論理
001D53 EACC 0F               4      RRCA
001D54 EACD 300A            12      JR  NC,DRD3
001D56 EACF 0F               4      RRCA
001D57 EAD0 30F7            12      JR  NC,DRD1
001D59 EAD2 DBDB            11      IN  A,(0DBH)
001D5B EAD4 2F               4      CPL         ;データバスが負論理
001D5C EAD5 77               7      LD  (HL),A
001D5D EAD6 23               6      INC HL
001D5E EAD7 18F0            12      JR  DRD1
                                
       EAD9                     DRD3:
001D60 EAD9 B7               4      OR  A
001D61 EADA FB               4      EI
001D62 EADB D1              10      POP DE
001D63 EADC 13               6      INC DE
001D64 EADD CD27EA          17      CALL    FDMOFF
001D67 EAE0 2808            12      JR  Z,DISKOK_RD
001D69 EAE2 CDF9EA          17      CALL    DISKC
001D6C EAE5 20D3            12      JR  NZ,DRD0
001D6E EAE7 B7               4      OR  A
001D6F EAE8 20B1            12      JR  NZ,ERRW
                                
       EAEA                     DISKOK_RD:
       EAEB                     RDBSMC  EQU $+1
001D71 EAEA 0601             7      LD  B,1
001D73 EAEC 10C3            13      DJNZ    DRDBL
001D75 EAEE C9              10      RET
                                
       EAEF                     ERRDR:
001D76 EAEF D1              10      POP DE
001D77 EAF0 CD0AEB          17      CALL    DELP
001D7A EAF3 20C5            12      JR  NZ,DRD0
001D7C EAF5 B7               4      OR  A
001D7D EAF6 20A3            12      JR  NZ,ERRW
001D7F EAF8 C9              10      RET
       EAF9                     DISKC:
001D80 EAF9 1B               6      DEC DE
001D81 EAFA CB5F             8      BIT 3,A
001D83 EAFC C445EA          17      CALL    NZ,RNF
       EAFF                     DISKD:
001D86 EAFF E5              11      PUSH    HL
001D87 EB00 214BEA          10      LD  HL,RETRY
001D8A EB03 35              11      DEC (HL)
001D8B EB04 E1              10      POP HL
001D8C EB05 200C            12      JR  NZ,ERR      ;Retry
001D8E EB07 B7               4      OR  A
001D8F EB08 2809            12      JR  Z,ERR       ;Error
                                
       EB0A                     DELP:
001D91 EB0A CD45EA          17      CALL    RNF
001D94 EB0D CD27EA          17      CALL    FDMOFF
001D97 EB10 3EFF             7      LD  A,0FFH
       EB12                     AERRZ:
001D99 EB12 BF               4      CP  A
       EB13                     ERR:
001D9A EB13 3EFF             7      LD  A,0FFH
001D9C EB15 C9              10      RET
                                
       F0B2                     FDMODE  EQU TVRAMTOP
[EOF:M7DISK.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   MZ-700/1500
                                
                                ;   EMM DRIVER
                                ;   1セクタ可変(256/512/1024)
                                
       EB16                     EDWT:
001D9D EB16 F5              11      PUSH    AF
001D9E EB17 CD35EB          17      CALL    EADR
001DA1 EB1A 0600             7      LD  B,0
       EB1C                     EDWT1:
001DA3 EB1C EDB3                    OTIR
001DA5 EB1E 3D               4      DEC A
001DA6 EB1F 20FB            12      JR  NZ,EDWT1
001DA8 EB21 180B            12      JR  EDRW1
                                
       EB23                     EDRD:
001DAA EB23 C5              11      PUSH    BC
001DAB EB24 CD35EB          17      CALL    EADR
001DAE EB27 0600             7      LD  B,0
       EB29                     EDRD1:
001DB0 EB29 EDB2                    INIR
001DB2 EB2B 3D               4      DEC A
001DB3 EB2C 20FB            12      JR  NZ,EDRD1
       EB2E                     EDRW1:
001DB5 EB2E F1              10      POP AF
001DB6 EB2F 83               4      ADD A,E ;セクタを進める
001DB7 EB30 5F               4      LD  E,A
001DB8 EB31 8A               4      ADC A,D
001DB9 EB32 93               4      SUB E
001DBA EB33 57               4      LD  D,A
001DBB EB34 C9              10      RET
                                
       EB35                     EADR:
001DBC EB35 C5              11      PUSH    BC
001DBD EB36 D5              11      PUSH    DE
001DBE EB37 EB               4      EX  DE,HL
001DBF EB38 29              11      ADD HL,HL
001DC0 EB39 DD4E0D          19      LD  C,(IX+00DH) ;DPB_0D_MAXSEC
001DC3 EB3C DD460C          19      LD  B,(IX+00CH) ;DPB_0C_MAXCYL
001DC6 EB3F 09              11      ADD HL,BC
001DC7 EB40 DD4E13          19      LD  C,(IX+013H) ;DPB_13_UNITNO
001DCA EB43 ED49            12      OUT (C),C
001DCC EB45 0C               4      INC C
001DCD EB46 ED69            12      OUT (C),L
001DCF EB48 0C               4      INC C
001DD0 EB49 ED61            12      OUT (C),H
001DD2 EB4B 0C               4      INC C
001DD3 EB4C EB               4      EX  DE,HL
001DD4 EB4D D1              10      POP DE
001DD5 EB4E DD460F          19      LD  B,(IX+00FH) ;DPB_0F_BPS
001DD8 EB51 F1              10      POP AF
       EB52                     EADR1:              ;読み込むセクタ数と1クラスタのセクタ数を掛ける
001DD9 EB52 CB18             8      RR  B
001DDB EB54 D8              11      RET C
001DDC EB55 87               4      ADD A,A
001DDD EB56 18FA            12      JR  EADR1
                                
                                ;   CMOS BACKUP MEMORY DRIVER(32KB)
                                ;   1セクタ256
                                
       EB58                     CDWT:
001DDF EB58 78               4      LD  A,B
001DE0 EB59 DD4E13          19      LD  C,(IX+013H) ;DPB_13_UNITNO
001DE3 EB5C ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001DE5 EB5E ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001DE7 EB60 01FA00          10      LD  BC,000FAH
       EB63                     CDWT1:
001DEA EB63 EDB3                    OTIR            ;W)データ書き込み・アドレスカウンタ+1
001DEC EB65 13               6      INC DE
001DED EB66 3D               4      DEC A
001DEE EB67 20FA            12      JR  NZ,CDWT1
001DF0 EB69 A7               4      AND A
001DF1 EB6A C9              10      RET
                                
       EB6B                     CDRD:
001DF2 EB6B 78               4      LD  A,B
001DF3 EB6C DD4E13          19      LD  C,(IX+013H) ;DPB_13_UNITNO
001DF6 EB6F ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001DF8 EB71 ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001DFA EB73 01F900          10      LD  BC,000F9H
       EB76                     CDRD1:
001DFD EB76 EDB2                    INIR            ;R)データ読み出し・アドレスカウンタ+1
001DFF EB78 13               6      INC DE
001E00 EB79 3D               4      DEC A
001E01 EB7A 20FA            12      JR  NZ,CDRD1
001E03 EB7C A7               4      AND A
001E04 EB7D C9              10      RET
                                
                                ;   RAM DISK DRIVER (64KB)
                                ;   1セクタ256
                                
       EB7E                     RDWT:
001E05 EB7E 3EB3             7      LD  A,0B3H      ;OTIR
001E07 EB80 1802            12      JR  RDRW
       EB82                     RDRD:
001E09 EB82 3EB2             7      LD  A,0B2H      ;INIR
       EB84                     RDRW:
001E0B EB84 3291EB          13      LD  (RDRW1+1),A
                                
001E0E EB87 78               4      LD  A,B
001E0F EB88 43               4      LD  B,E     ;B=アドレスカウンタ上位(X1の様な16bitのI/Oアクセス)
001E10 EB89 0EEB             7      LD  C,0EBH
001E12 EB8B ED71            12      OUT (C),0       ;0=アドレスカウンタ下位
001E14 EB8D 0D               4      DEC C       ;EA(R)データ読み出し・アドレスカウンタ+1
001E15 EB8E 0600             7      LD  B,0
       EB90                     RDRW1:
001E17 EB90 EDB2                    INIR            ;自己書き換え(INIR/OTIR)
001E19 EB92 13               6      INC DE
001E1A EB93 3D               4      DEC A
001E1B EB94 20FA            12      JR  NZ,RDRW1
001E1D EB96 A7               4      AND A
001E1E EB97 C9              10      RET
[EOF:M7DISK2.ASM:UTF_8]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       0040                     PATHX   EQU 64
001E1F EB98                     PATHD:  DS  PATHX
001E5F EBD8 00                  PATHE:  DB  0
                                
       EBD9                     DTA_CCP:
001E60 EBD9                         DS  37
                                
       EBFE                     FCB_BAT:
001E85 EBFE                         DS  37
                                
                                
001EAA EC23 2062797465732066    FREE:   DB  " bytes free",9,'$'
            7265650924          
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "M7TABLE.ASM"
                                
                                ;   LSX-Dodgers TABLE 表示関連のテーブル
                                ;   MZ-700/1500
                                
       EC30                     AT_TABLE:
001EB7 EC30                         DS  TABLEAD-AT_TABLE
                                
       ED40                     KEY_TABLE:
001FC7 ED40 12081E1F1C1D5C2F        DB  12H,08H,1EH,1FH,1CH,1DH,5CH,'/'
001FCF ED48 5C5E2D2030392C2E        DB  5CH,'^','-',20H,'0','9',',','.'
001FD7 ED50 3132333435363738        DB  '1','2','3','4','5','6','7','8'
001FDF ED58 6162636465666768        DB  'a','b','c','d','e','f','g','h'
001FE7 ED60 696A6B6C6D6E6F70        DB  'i','j','k','l','m','n','o','p'
001FEF ED68 7172737475767778        DB  'q','r','s','t','u','v','w','x'
001FF7 ED70 797A405B5D000000        DB  'y','z','@','[',']',00H,00H,00H
001FFF ED78 001B3D09003B3A0D        DB  00H,1BH,'=',09H,00H,';',':',0DH
       ED80                     SHIFT_TABLE:
002007 ED80 12081E1F1C1D5F3F        DB  12H,08H,1EH,1FH,1CH,1DH,'_','?'
00200F ED88 7C7E3D2030293C3E        DB  '|','~','=',20H,'0',')','<','>'
002017 ED90 2122232425262728        DB  '!','"','#','$','%','&',27H,'('
00201F ED98 4142434445464748        DB  'A','B','C','D','E','F','G','H'
002027 EDA0 494A4B4C4D4E4F50        DB  'I','J','K','L','M','N','O','P'
00202F EDA8 5152535455565758        DB  'Q','R','S','T','U','V','W','X'
002037 EDB0 595A607B7D000000        DB  'Y','Z','`','{','}',00H,00H,00H
00203F EDB8 00003D09002B2A0D        DB  00H,00H,'=',09H,00H,'+','*',0DH
       EDC0                     CTRL_TABLE:
002047 EDC0 12081E1F1C1D3F2F        DB  12H,08H,1EH,1FH,1CH,1DH,'?','/'
00204F EDC8 2A2B2D2030392C2E        DB  '*','+','-',20H,'0','9',',','.'
002057 EDD0 3132333435363738        DB  '1','2','3','4','5','6','7','8'
00205F EDD8 0102030405060708        DB  01H,02H,03H,04H,05H,06H,07H,08H
002067 EDE0 090A0B0C0D0E0F10        DB  09H,0AH,0BH,0CH,0DH,0EH,0FH,10H
00206F EDE8 1112131415161718        DB  11H,12H,13H,14H,15H,16H,17H,18H
002077 EDF0 191A1B5B5D000000        DB  19H,1AH,1BH,'[',']',00H,00H,00H
00207F EDF8 00003D09003B3A0D        DB  00H,00H,'=',09H,00H,';',':',0DH
                                
                                ;   アドレス下位1バイトが0になるように
       EE00                     CD_TABLE:
002087 EE00 00D1D2D3D4D5D6D0        DB  $00,$D1,$D2,$D3,$D4,$D5,$D6,$D0 ;月火水木金土日
00208F EE08 D8DCD9DADBD7CFCE        DB  $D8,$DC,$D9,$DA,$DB,$D7,$CF,$CE ;年円時分秒
002097 EE10 601F5F5E1E1B7978        DB  $60,$1F,$5F,$5E,$1E,$1B,$79,$78 ;
00209F EE18 5C5D1C1D6DCACDC7        DB  $5C,$5D,$1C,$1D,$6D,$CA,$CD,$C7 ;
0020A7 EE20 0061626364656667        DB  $00,$61,$62,$63,$64,$65,$66,$67 ; !"#$%&'
0020AF EE28 68696B6A2F2A2E2D        DB  $68,$69,$6B,$6A,$2F,$2A,$2E,$2D ;()*+,-./
0020B7 EE30 2021222324252627        DB  $20,$21,$22,$23,$24,$25,$26,$27 ;01234567
0020BF EE38 28294F2C512B5749        DB  $28,$29,$4F,$2C,$51,$2B,$57,$49 ;89:;<=>?
0020C7 EE40 5501020304050607        DB  $55,$01,$02,$03,$04,$05,$06,$07 ;@ABCDEFG
0020CF EE48 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;HIJKLMNO
0020D7 EE50 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;PQRSTUVW
0020DF EE58 18191A52DD54507C        DB  $18,$19,$1A,$52,$DD,$54,$50,$7C ;XYZ[\]^_
0020E7 EE60 5901020304050607        DB  $59,$01,$02,$03,$04,$05,$06,$07 ;`abcdefg   ATB:1
0020EF EE68 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;hijklmno   ATB:1
0020F7 EE70 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;pqrstuvw   ATB:1
0020FF EE78 18191ACB35CC705A        DB  $18,$19,$1A,$CB,$35,$CC,$70,$5A ;xyz{|}~    ATB:1
002107 EE80 415346444847B49E        DB  $41,$53,$46,$44,$48,$47,$B4,$9E ;トランプ〇●をぁ   ATB:1
00210F EE88 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ぃぅぇぉゃゅょっ   ATB:1
002117 EE90 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーあいうえおかき   ATB:1
00211F EE98 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;くけこさしすせそ   ATB:1
002127 EEA0 F0BD9DB1B5B9B49E        DB  $F0,$BD,$9D,$B1,$B5,$B9,$B4,$9E ;　。「」、・ヲァ
00212F EEA8 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ィゥェォャョュッ
002137 EEB0 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーアイウエオカキ
00213F EEB8 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;クケコサシスセソ
002147 EEC0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;タチツテトナニヌ
00214F EEC8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ネノハヒフヘホマ
002157 EED0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;ミムメモヤユヨラ
00215F EED8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;リルレロワン゛゜
002167 EEE0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;たちつてとねにぬ   ATB:1
00216F EEE8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ねのはひふへほま   ATB:1
002177 EEF0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;みむめもやゆよら   ATB:1
00217F EEF8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;りるれろわん゛゜   ATB:1
       EF00                     DC_TABLE:
002187 EF00 2041424344454647        DB  $20,$41,$42,$43,$44,$45,$46,$47 ;0
00218F EF08 48494A4B4C4D4E4F        DB  $48,$49,$4A,$4B,$4C,$4D,$4E,$4F
002197 EF10 5051525354555657        DB  $50,$51,$52,$53,$54,$55,$56,$57 ;1
00219F EF18 58595A151A1B1411        DB  $58,$59,$5A,$15,$1A,$1B,$14,$11
0021A7 EF20 3031323334353637        DB  $30,$31,$32,$33,$34,$35,$36,$37 ;2
0021AF EF28 38392D3D3B2F2E2C        DB  $38,$39,$2D,$3D,$3B,$2F,$2E,$2C
0021B7 EF30 00000000007C0000        DB  $00,$00,$00,$00,$00,$7C,$00,$00 ;3
0021BF EF38 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
0021C7 EF40 0080000083008285        DB  $00,$80,$00,$00,$83,$00,$82,$85 ;4
0021CF EF48 843F00000000003A        DB  $84,$3F,$00,$00,$00,$00,$00,$3A
0021D7 EF50 5E3C5B815D40003E        DB  $5E,$3C,$5B,$81,$5D,$40,$00,$3E ;5
0021DF EF58 00607F0018191312        DB  $00,$60,$7F,$00,$18,$19,$13,$12
0021E7 EF60 1021222324252627        DB  $10,$21,$22,$23,$24,$25,$26,$27 ;6
0021EF EF68 28292B2A001C0000        DB  $28,$29,$2B,$2A,$00,$1C,$00,$00
0021F7 EF70 7E00000000000000        DB  $7E,$00,$00,$00,$00,$00,$00,$00 ;7
0021FF EF78 171600005F000000        DB  $17,$16,$00,$00,$5F,$00,$00,$00
002207 EF80 00C19A9F9C92CA97        DB  $00,$C1,$9A,$9F,$9C,$92,$CA,$97 ;8
00220F EF88 98C6CFC9D8D3D0D7        DB  $98,$C6,$CF,$C9,$D8,$D3,$D0,$D7
002217 EF90 9EC09DC496C5CBC3        DB  $9E,$C0,$9D,$C4,$96,$C5,$CB,$C3 ;9
00221F EF98 9BDDC2DB99A2878C        DB  $9B,$DD,$C2,$DB,$99,$A2,$87,$8C
002227 EFA0 DCC7CC91939495D4        DB  $DC,$C7,$CC,$91,$93,$94,$95,$D4 ;A
00222F EFA8 D5D6CECDDAD2D9C8        DB  $D5,$D6,$CE,$CD,$DA,$D2,$D9,$C8
002237 EFB0 D1A3888D86A4898E        DB  $D1,$A3,$88,$8D,$86,$A4,$89,$8E ;B
00223F EFB8 DFA58A8FDEA18B90        DB  $DF,$A5,$8A,$8F,$DE,$A1,$8B,$90
002247 EFC0 000000000000001F        DB  $00,$00,$00,$00,$00,$00,$00,$1F ;C
00224F EFC8 00001D7B7D1E0F0E        DB  $00,$00,$1D,$7B,$7D,$1E,$0F,$0E
002257 EFD0 070102030405060D        DB  $07,$01,$02,$03,$04,$05,$06,$0D ;D
00225F EFD8 080A0B0C095C0000        DB  $08,$0A,$0B,$0C,$09,$5C,$00,$00
002267 EFE0 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00 ;E
00226F EFE8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
002277 EFF0 A000000000000000        DB  $A0,$00,$00,$00,$00,$00,$00,$00 ;F
00227F EFF8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
[EOF:M7TABLE.ASM:SHIFT_JIS]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
       F000                     AT_WORK:
002287 F000                         DS  WORKAD-AT_WORK
                                
       F000                     CPM_BOOT:
002287 F000 C30000          10      JP  0
       F003                     _SYS00:     ;(BDOS)プログラム終了
       F003                     CPM_WBOOT:
00228A F003 C3FECF          10      JP  WBOOT1
       F006                     CPM_CONST:
00228D F006 C3BBD8          10      JP  CONSTX
       F009                     _SYS07:     ;(BDOS)コンソール直接入力
       F009                     CPM_CONIN:
002290 F009 C351D8          10      JP  FLGET
       F00C                     CPM_CONOUT:
002293 F00C C360DA          10      JP  CONOUT1
                                
       F00F                     DECBF:              ;10進数表示時のバッファ(5バイト)
002296 F00F                         DS  5
       F00F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       F011                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
00229B F014 00                  FDRV:   DB  0
00229C F015                     FNAME:  DS  36
0022C0 F039                     SFILE:  DS  33      ;DRV FILENAME
                                
0022E1 F05A                         DS  3
                                
0022E4 F05D 0000                LEFTX:  DW  0
0022E6 F05F 0000                DTAX:   DW  0
                                
       F061                     ZERO:
       F061                     BEEPD:
0022E8 F061 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
0022F0 F069 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
       F062                     RTC_YY  EQU BEEPD+1
       F063                     RTC_MW  EQU BEEPD+2
       F064                     RTC_DD  EQU BEEPD+3
       F065                     RTC_TT  EQU BEEPD+4
       F066                     RTC_MM  EQU BEEPD+5
       F067                     RTC_SS  EQU BEEPD+6
                                
0022F7 F070 00                  CHECK:  DB  0
                                
0022F8 F071 4F4B24              OK: DB  "OK$"
0022FB F074                         DS  5
002300 F079 4572726F722124      COMERM: DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
002307 F080 FF                  _CYL0:  DB  0FFH    ;Cylinder
002308 F081 FF                  _CYL1:  DB  0FFH    ;Cylinder
002309 F082 FF                  _CYL2:  DB  0FFH    ;Cylinder
00230A F083 FF                  _CYL3:  DB  0FFH    ;Cylinder
00230B F084 00                  _DRIVE: DB  0   ;unit number
00230C F085 00                  _SEEKSP:DB  0   ;Seek speed
00230D F086 FF                  _ISEEK: DB  0FFH    ;
00230E F087 00                  _DVSW:  DB  0
00230F F088 00                  _DRV:   DB  0
002310 F089 FF                  _DSK:   DB  0FFH
002311 F08A 8000                _DTA:   DW  00080H
002313 F08C 0000                _CTC:   DW  0
002315 F08E 0000                _TXADR: DW  0
002317 F090 0000                _KEYPS: DW  0
002319 F092 00FF                _KEYD:  DW  0FF00H  ;キーデータ
00231B F094 8310                _KEYSP: DB  KEYSP_L,KEYSP_H ;オートリピートの速度
00231D F096 70                  _COLORF:DB  COLORF  ;色
00231E F097 19                  _LINE:  DB  LINE
                                
00231F F098 0000                _FCB:   DW  0   ;SEARCH FILES
002321 F09A 0000                _FBPS:  DW  0   ;    //
002323 F09C 0000                _FBAD:  DW  0   ;    //
002325 F09E 00                  _FBCNT: DB  0   ;    //
002326 F09F 00                  _FILEN: DB  0   ;    //
002327 F0A0 00                  _DIRF:  DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
002328 F0A1                         DS  1
002329 F0A2 00                  _WTFATF:DB  0   ;FATバッファの更新フラグ
00232A F0A3                         DS  1
00232B F0A4 00                  _WTDBF: DB  0   ;データバッファの更新フラグ
00232C F0A5 FF                  _DBDRV: DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
00232D F0A6 0000                _DBSEC: DW  0   ;データバッファにあるデータを読み込んだセクタ番号
00232F F0A8 0000                _DPB:   DW  0
       F0AA                     _FATDRV:
002331 F0AA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
002332 F0AB 00                  _FATIX: DB  0   ;FATバッファに読み込んでいるインデックス
       F0AC                     _FAKEFREE:
002333 F0AC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
002335 F0AE                         DS  2
                                
       F0B0                     CRTCD:
002337 F0B0 6F                      DB  06FH
       F0B1                     _WIDTH:
002338 F0B1 28                      DB  WIDTH
       F0B2                     TVRAMTOP:
002339 F0B2 5938                    DB  059H,038H
00233B F0B4 1F02                    DB  01FH,002H
       F0B6                     _LINE2:
00233D F0B6 19                      DB  019H
       F0B7                     WKE4:
00233E F0B7 1C                      DB  01CH
       F0B8                     WKE6:
00233F F0B8 00                      DB  000H
       F0B9                     WK40:
002340 F0B9 07                      DB  007H
       F0BA                     _PAGE_MINUS:
002341 F0BA 18FC                    DW  0-WIDTH*LINE
       F0BC                     _WIDTH_MINUS:
002343 F0BC D8FF                    DW  0-WIDTH
       F0BE                     WK30:
002345 F0BE 0C                      DB  00CH
       F0BF                     WK31:
       F0BF                     WK1FD0:
002346 F0BF 20                      DB  020H
                                
002347 F0C0 0000                CTC0:   DW  INTCTCE
002349 F0C2 0000                CTC1:   DW  INTCTCE
00234B F0C4 0000                CTC2:   DW  INTCTC2
00234D F0C6 0000                CTC3:   DW  INTCTCE
00234F F0C8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
002351 F0CA C399DB          10  _INKEY: JP  INKEY
002354 F0CD C34CD9          10  _PRINT: JP  PRINT
002357 F0D0 C3F4DB          10  _SCRN:  JP  SCRN
00235A F0D3 C309DB          10  _POS:   JP  POS
00235D F0D6 C32EDA          10  _LOC:   JP  LOC
       F0D9                     _CHGDRV:
002360 F0D9 C3A1E8          10      JP  CHGDRV
       F0DC                     _GETDPB:
002363 F0DC C36CE9          10      JP  GETDPB
       F0DF                     _FFLUSH:
002366 F0DF C38AE9          10      JP  FFLUSH
       F0E2                     _RDFATX:
002369 F0E2 C37AE5          10      JP  RDFATX
00236C F0E5 C3A2E6          10  _RDFAT: JP  RDFAT
00236F F0E8 C34CEA          10  _WTTRK: JP  WTTRK
002372 F0EB C3ACEA          10  _FDRD:  JP  FDRD
002375 F0EE C352EA          10  _FDWT:  JP  FDWT
       F0F1                     _BPB2DPB:
002378 F0F1 C32FE7          10      JP  BPB2DPB
       F0F4                     _BREAK:
00237B F0F4 C393D1          10      JP  END_BATCH
       F0F7                     _GNCL:
00237E F0F7 C31CE6          10  GNCPAT: JP  GNCL        ; self-modifying code
       F0FA                     _SNCL:
002381 F0FA C33FE6          10  SNCPAT: JP  SNCL        ; self-modifying code
002384 F0FD C34DD0          10  _COMANL:JP  COMANL
                                
       F100                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       F100                     STABLE:
                                ;0
002387 F100 03F024D830D8C9DD        DW  _SYS00,_SYS01,_SYS02,_SYS03
00238F F108 40D540D535D809F0        DW  _SYS04,_SYS05,_SYS06,_SYS07
002397 F110 3DD842D587D8B3D8        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
00239F F118 57D55CD56BD57CD5        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
0023A7 F120 D0D517D660D696D6        DW  _SYS10,_SYS11,_SYS12,_SYS13
0023AF F128 9ED6B4D6C9D6C1D6        DW  _SYS14,_SYS15,_SYS16,_SYS17
0023B7 F130 10D715D71AD720D7        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
0023BF F138 40D546D740D54AD7        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
0023C7 F140 40D500D708D751D7        DW  _SYS20,_SYS21,_SYS22,_SYS23
0023CF F148 77D740D54EE226E3        DW  _SYS24,_ERROR,_SYS26,_SYS27
0023D7 F150 08D780D7C9D8C9DD        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
0023DF F158 CFD8C9DD40D5A1D7        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
0023E7 F160 9BD740D540D540D5        DW  _SYS30,_ERROR,_ERROR,_ERROR
0023EF F168 40D540D540D540D5        DW  _ERROR,_ERROR,_ERROR,_ERROR
0023F7 F170 40D5C9DDC9DDC2D7        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
0023FF F178 23D5                    DW  _DOS2
                                
002401 F17A                         DS  2
002403 F17C 00F3                _FATBF: DW  FATBF
002405 F17E 00FB                _DTBUF: DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       F180                     CTRLTB:
002407 F180 B1D9B1D9E7D9DCDA        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
00240F F188 D6DA13DAC7DA70DA        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
002417 F190 BDD9D8D9DFDA41DA        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
00241F F198 C4DA29DAF1DAB1D9        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
002427 F1A0 B1D9B1D939DAB1D9        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
00242F F1A8 B1D9B1D9B1D9B1D9        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
002437 F1B0 B1D9B1D9C4DA48DA        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
00243F F1B8 A0D9C4D9CDD9DFDA        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
002447 F1C0 0200                M2D:    DW  2
002449 F1C2 FD02                    DB  0FDH,2
00244B F1C4 6401                    DW  356
00244D F1C6 FF0728090182            DB  0FFH,7,40,9,1,082H
002453 F1CC 0500A7000800            DW  5,0A7H,8
                                
002459 F1D2 0200                M2HD:   DW  2
00245B F1D4 FE01                    DB  0FEH,1
00245D F1D6 C704                    DW  1223
00245F F1D8 FE064D080184            DB  0FEH,6,77,8,1,084H
002465 F1DE 0500A7000900            DW  5,0A7H,9
                                
00246B F1E4                         DS  6
                                
002471 F1EA 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
002473 F1EC 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
002475 F1EE 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
002477 F1F0 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       F1F4                     SDDATAE:
                                
00247B F1F4                     SCDIR:  DS  2       ;+14 +15
00247D F1F6                     SFBPS:  DS  2       ;FBPS
00247F F1F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
002481 F1FA 0000                _FATPS: DW  0
002483 F1FC 0000                _DIRPS: DW  0
002485 F1FE 0000                _CLPS:  DW  0
                                
       F200                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "M7DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   MZ-700/1500
                                
       F200                     DEVICE:
                                
                                ;   A:
                                
002487 F200 0200                    DW  2   ;DPB_00_FATLN
002489 F202 EBF0                    DW  _FDRD   ;DPB_02_DRD
00248B F204 EEF0                    DW  _FDWT   ;DPB_04_DWT
00248D F206 FD                      DB  0FDH    ;DPB_06_FATID
00248E F207 02                      DB  2   ;DPB_07_SECPCL
00248F F208 6401                    DW  356 ;DPB_08_MAXCL
002491 F20A FF                      DB  0FFH    ;DPB_0A_FDMODE  0FFH=2D / 0FEH=2HD
002492 F20B 07                      DB  7   ;DPB_0B_DIRSCNT
002493 F20C 28                      DB  40  ;DPB_0C_MAXCYL
002494 F20D 09                      DB  9   ;DPB_0D_MAXSEC  Number of sectors
002495 F20E 01                      DB  1   ;DPB_0E_FATPS
002496 F20F 82                      DB  082H    ;DPB_0F_BPS
002497 F210 0500                    DW  5   ;DPB_10_DIRPS
002499 F212 27                      DB  027H    ;DPB_12_DEVICE  Device Number
00249A F213 00                      DB  0   ;DPB_13_UNITNO
00249B F214 0800                    DW  8   ;DPB_14_ADDCL16
00249D F216 0000                    DW  0   ;DPB_16
00249F F218 0000                    DW  0   ;DPB_18
0024A1 F21A 0000                    DW  0   ;DPB_1A_SDIR
0024A3 F21C 46444430                DB  "FDD0"  ;DPB_1C_NAME
                                
                                ;   B:
                                
0024A7 F220 0200                    DW  2   ;DPB_00_FATLN
0024A9 F222 EBF0                    DW  _FDRD   ;DPB_02_DRD
0024AB F224 EEF0                    DW  _FDWT   ;DPB_04_DWT
0024AD F226 FD                      DB  0FDH    ;DPB_06_FATID
0024AE F227 02                      DB  2   ;DPB_07_SECPCL
0024AF F228 6401                    DW  356 ;DPB_08_MAXCL
0024B1 F22A FF                      DB  0FFH    ;DPB_0A_FDMODE  0FFH=2D / 0FEH=2HD
0024B2 F22B 07                      DB  7   ;DPB_0B_DIRSCNT
0024B3 F22C 28                      DB  40  ;DPB_0C_MAXCYL
0024B4 F22D 09                      DB  9   ;DPB_0D_MAXSEC  Number of sectors
0024B5 F22E 01                      DB  1   ;DPB_0E_FATPS
0024B6 F22F 82                      DB  082H    ;DPB_0F_BPS
0024B7 F230 0500                    DW  5   ;DPB_10_DIRPS
0024B9 F232 27                      DB  027H    ;DPB_12_DEVICE  Device Number
0024BA F233 01                      DB  1   ;DPB_13_UNITNO
0024BB F234 0800                    DW  8   ;DPB_14_ADDCL16
0024BD F236 0000                    DW  0   ;DPB_16
0024BF F238 0000                    DW  0   ;DPB_18
0024C1 F23A 0000                    DW  0   ;DPB_1A_SDIR
0024C3 F23C 46444431                DB  "FDD1"  ;DPB_1C_NAME
                                
                                ;   C:
                                
0024C7 F240 0100                    DW  1   ;DPB_00_FATLN
0024C9 F242 6BEB                    DW  CDRD    ;DPB_02_DRD
0024CB F244 58EB                    DW  CDWT    ;DPB_04_DWT
0024CD F246 FA                      DB  0FAH    ;DPB_06_FATID
0024CE F247 01                      DB  1   ;DPB_07_SECPCL
0024CF F248 7A00                    DW  122 ;DPB_08_MAXCL
0024D1 F24A 00                      DB  0   ;DPB_0A_FDMODE
0024D2 F24B 06                      DB  6   ;DPB_0B_DIRSCNT
0024D3 F24C 00                      DB  0   ;DPB_0C_MAXCYL
0024D4 F24D 00                      DB  0   ;DPB_0D_MAXSEC
0024D5 F24E 01                      DB  1   ;DPB_0E_FATPS
0024D6 F24F 01                      DB  1   ;DPB_0F_BPS
0024D7 F250 0200                    DW  2   ;DPB_10_DIRPS
0024D9 F252 0C                      DB  00CH    ;DPB_12_DEVICE
0024DA F253 F8                      DB  0F8H    ;DPB_13_UNITNO
0024DB F254 0600                    DW  6   ;DPB_14_ADDCL16
0024DD F256 0000                    DW  0   ;DPB_16
0024DF F258 0000                    DW  0   ;DPB_18
0024E1 F25A 0000                    DW  0   ;DPB_1A_SDIR
0024E3 F25C 434D4F53                DB  "CMOS"  ;DPB_1C_NAME
                                
                                ;   D:
                                
0024E7 F260                         DS  32
                                
                                ;   E:
                                
002507 F280 0000                    DW  0   ;DPB_00_FATLN
002509 F282 23EB                    DW  EDRD    ;DPB_02_DRD
00250B F284 16EB                    DW  EDWT    ;DPB_04_DWT
00250D F286 FA                      DB  0FAH    ;DPB_06_FATID
00250E F287 02                      DB  2   ;DPB_07_SECPCL
00250F F288 0000                    DW  0   ;DPB_08_MAXCL
002511 F28A 00                      DB  0   ;DPB_0A_FDMODE
002512 F28B 10                      DB  16  ;DPB_0B_DIRSCNT
002513 F28C 00                      DB  0   ;DPB_0C_MAXCYL
002514 F28D 00                      DB  0   ;DPB_0D_MAXSEC
002515 F28E 01                      DB  1   ;DPB_0E_FATPS
002516 F28F 01                      DB  1   ;DPB_0F_BPS
002517 F290 0000                    DW  0   ;DPB_10_DIRPS
002519 F292 26                      DB  026H    ;DPB_12_DEVICE
00251A F293 00                      DB  0   ;DPB_13_UNITNO
00251B F294 0000                    DW  0   ;DPB_14_ADDCL16
00251D F296 0000                    DW  0   ;DPB_16
00251F F298 0000                    DW  0   ;DPB_18
002521 F29A 0000                    DW  0   ;DPB_1A_SDIR
002523 F29C 454D4D30                DB  "EMM0"  ;DPB_1C_NAME
                                
                                ;   F:
                                
002527 F2A0 0200                    DW  2   ;DPB_00_FATLN
002529 F2A2 82EB                    DW  RDRD    ;DPB_02_DRD
00252B F2A4 7EEB                    DW  RDWT    ;DPB_04_DWT
00252D F2A6 FA                      DB  0FAH    ;DPB_06_FATID
00252E F2A7 01                      DB  1   ;DPB_07_SECPCL
00252F F2A8 F600                    DW  246 ;DPB_08_MAXCL
002531 F2AA 00                      DB  0   ;DPB_0A_FDMODE
002532 F2AB 09                      DB  9   ;DPB_0B_DIRSCNT
002533 F2AC 00                      DB  0   ;DPB_0C_MAXCYL
002534 F2AD 00                      DB  0   ;DPB_0D_MAXSEC
002535 F2AE 01                      DB  1   ;DPB_0E_FATPS
002536 F2AF 01                      DB  1   ;DPB_0F_BPS
002537 F2B0 0300                    DW  3   ;DPB_10_DIRPS
002539 F2B2 0F                      DB  00FH    ;DPB_12_DEVICE
00253A F2B3 00                      DB  0   ;DPB_13_UNITNO
00253B F2B4 0A00                    DW  10  ;DPB_14_ADDCL16
00253D F2B6 0000                    DW  0   ;DPB_16
00253F F2B8 0000                    DW  0   ;DPB_18
002541 F2BA 0000                    DW  0   ;DPB_1A_SDIR
002543 F2BC 52414D46                DB  "RAMF"  ;DPB_1C_NAME
                                
                                ;   G:
                                
002547 F2C0                         DS  32
                                
                                ;   H:
002567 F2E0                         DS  3
00256A F2E3 00                      DB  0
[EOF:M7DPB.ASM:UTF_8]
                                
       A56B                         ORG $$+OFFSET   ;$DEPHASE
       A56B                     LAST_ADR:
                                
                                    END
[EOF:M7.ASM:UTF_8]
