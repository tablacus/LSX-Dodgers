                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   LSX-Dodgers for MZ-700/1500
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "M7DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MZ-700/1500
                                
       0001                     MAC EQU 1   ;MZ-700/1500
       0000                     DEV EQU 0
                                
       8080                     RUN EQU 08080H
       8000                     OFFSET  EQU RUN-128
       CF06                     BDOS    EQU 0CF06H
       EC40                     TABLEAD EQU 0EC40H
       EF00                     WORKAD  EQU 0EF00H
       F200                     FATBF   EQU 0F200H
       FA00                     DTBUF   EQU 0FA00H
       FE00                     KEYBF   EQU 0FE00H
       FF00                     KBUF    EQU 0FF00H
       FFD9                     TRAP38  EQU 0FFD9H
       0028                     WIDTH   EQU 40
       0019                     LINE    EQU 25
       0071                     COLORF  EQU 071H
       0010                     KEYSP_H EQU 16
       0083                     KEYSP_L EQU 131
       000A                     COMS    EQU 10
[EOF:M7DEF.ASM:UTF_8]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0005                     VER_2   EQU 5
       0001                     VER_3   EQU 1
       1D01                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0001                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0151                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       FFCA                     EXTBIO  EQU 0FFCAH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 8000                         ORG OFFSET
                                                    ;MZTヘッダ128バイト
000000 8000 01                      DB  1           ;ファイルモード
000001 8001 4C44202020202020        DB  "LD           "     ;ファイル名(13)
            2020202020          
00000E 800E 535953                  DB  "SYS"           ;拡張子(3)
000011 8011 0D                      DB  $0D
000012 8012 0724                    DW  LAST_ADR-RUN        ;サイズ
000014 8014 8080                    DW  RUN         ;開始アドレス
000016 8016 8080                    DW  RUN         ;実行アドレス
000018 8018                         DS  104
                                
                                    INCLUDE "M7INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   MZ-700/1500
                                
000080 8080 C38780          10      JP  START
000083 8083 011D                    DW  MACW
000085 8085 5101                    DW  VER
                                
       8087                     START:
000087 8087 F3               4      DI
000088 8088 ED56             8      IM  1
00008A 808A 318780          10      LD  SP,START
00008D 808D CD9B80          17      CALL    INIT        ;NZならAUTOEXECを実行
000090 8090 210000          10      LD  HL,0
000093 8093 E5              11      PUSH    HL
000094 8094 C8              11      RET Z
000095 8095 114481          10      LD  DE,AUTOD
000098 8098 C3FDEF          10      JP  _COMANL
                                
       809B                     INIT:
00009B 809B D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFFH)
00009D 809D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00009F 809F 21A981          10      LD  HL,INITE
0000A2 80A2 1106CF          10      LD  DE,BDOS
0000A5 80A5 01DE22          10      LD  BC,LAST_ADR-INITE
0000A8 80A8 EDB0                    LDIR
0000AA 80AA 217A81          10      LD  HL,M7BEEPD
0000AD 80AD 1162EF          10      LD  DE,BEEPD+1
0000B0 80B0 010800          10      LD  BC,M7BEEPE-M7BEEPD
0000B3 80B3 EDB0                    LDIR
                                
0000B5 80B5 210000          10      LD  HL,0
0000B8 80B8 065C             7      LD  B,05CH
0000BA 80BA 3EEF             7      LD  A,0EFH      ;RST 28H
0000BC 80BC CD6DDD          17      CALL    FILL_MEMORY
0000BF 80BF 06A4             7      LD  B,0A4H
0000C1 80C1 AF               4      XOR A
0000C2 80C2 CD6DDD          17      CALL    FILL_MEMORY
                                
0000C5 80C5 3EC3             7      LD  A,0C3H      ;JP
0000C7 80C7 2103EF          10      LD  HL,CPM_WBOOT
0000CA 80CA 320000          13      LD  (00000H),A
0000CD 80CD 220100          16      LD  (00001H),HL ;IPL
                                
0000D0 80D0 21011D          10      LD  HL,MACW     ;3 bit7  DPB Compatible LA(1)
0000D3 80D3 220300          16      LD  (00003H),HL ;  bit6-0 Machine
                                ;               ;4 LSX-Dodgers(01DH)
0000D6 80D6 2106CF          10      LD  HL,BDOS
0000D9 80D9 320500          13      LD  (00005H),A
0000DC 80DC 220600          16      LD  (00006H),HL ;BDOS
                                
0000DF 80DF 21D9FF          10      LD  HL,TRAP38   ;TRAP38
0000E2 80E2 322800          13      LD  (00028H),A
0000E5 80E5 222900          16      LD  (00029H),HL ;RST 028H
                                
0000E8 80E8 323800          13      LD  (00038H),A
0000EB 80EB 210ECF          10      LD  HL,IO_INT8253
0000EE 80EE 223900          16      LD  (00039H),HL
                                
0000F1 80F1 3EEF             7      LD  A,CPM_BOOT/256
0000F3 80F3 320B00          13      LD  (0000BH),A
                                
0000F6 80F6 3EE9             7      LD  A,0E9H      ;JP (HL)
0000F8 80F8 320F00          13      LD  (0000FH),A
                                
0000FB 80FB 3A7DF0          13      LD  A,(_FATBF+1)
0000FE 80FE 321300          13      LD  (00013H),A
                                
000101 8101 3A7FF0          13      LD  A,(_DTBUF+1)
000104 8104 321700          13      LD  (00017H),A
                                
000107 8107 3EFE             7      LD  A,KEYBF/256
000109 8109 321B00          13      LD  (0001BH),A
                                
00010C 810C 3EFF             7      LD  A,KBUF/256
00010E 810E 321F00          13      LD  (0001FH),A
                                
000111 8111 215101          10      LD  HL,VER
000114 8114 225A00          16      LD  (0005AH),HL
                                
000117 8117 215081          10      LD  HL,INIMES
00011A 811A CDD9D5          17      CALL    MSX
       811D                     INIT1:
00011D 811D F3               4      DI
00011E 811E 1100FF          10      LD  DE,0FF00H
000121 8121 0600             7      LD  B,0
000123 8123 CDB9D3          17      CALL    ZERO_MEMORY_DE
000126 8126 21CAFF          10      LD  HL,EXTBIO
000129 8129 36C9            10      LD  (HL),0C9H   ;RET
00012B 812B 23               6      INC HL
00012C 812C 060E             7      LD  B,TRAP38-EXTBIO-1
00012E 812E 3EEF             7      LD  A,0EFH      ;RST 28H
000130 8130 CD6DDD          17      CALL    FILL_MEMORY
000133 8133 218281          10      LD  HL,AT_TRAP38
000136 8136 11D9FF          10      LD  DE,TRAP38
000139 8139 012700          10      LD  BC,AT_TRAPE-AT_TRAP38
00013C 813C EDB0                    LDIR
                                
00013E 813E CD48DC          17      CALL    CHKEY
000141 8141 FE03             7      CP  3
000143 8143 C9              10      RET
                                
000144 8144 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
00014D 814D 413A00              AUTODV: DB  "A:",0
                                
000150 8150 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for MZ-700/1500 v"
            6765727320666F72    
            204D5A2D3730302F    
            313530302076        
00016E 816E 312E                    DB  030H + VER_1, '.'
000170 8170 3531                    DB  030H + VER_2 ,030H + VER_3
                                ;   DB  ""
000172 8172 2047616B750D0A          DB  ' Gaku',0DH,0AH
000179 8179 00                      DB  0
                                
       817A                     M7BEEPD:
00017A 817A 0801                    DB  8,1
00017C 817C 0736                    DB  7,036H
00017E 817E 04F9                    DB  4,0F9H
000180 8180 0403                    DB  4,3
       8182                     M7BEEPE:
                                
       8182                     AT_TRAP38:
000182 FFD9                         ORG TRAP38,AT_TRAP38-OFFSET
000182 FFD9 210000          10      LD  HL,0
000185 FFDC E3              19      EX  (SP),HL
000186 FFDD 3E24             7      LD  A,'$'
000188 FFDF CDB3D8          17      CALL    MSG_A
00018B FFE2 2B               6      DEC HL
00018C FFE3 7C               4      LD  A,H
00018D FFE4 CDE8FF          17      CALL    PRHX
000190 FFE7 7D               4      LD  A,L
       FFE8                     PRHX:
000191 FFE8 F5              11      PUSH    AF
000192 FFE9 07               4      RLCA
000193 FFEA 07               4      RLCA
000194 FFEB 07               4      RLCA
000195 FFEC 07               4      RLCA
000196 FFED CDF1FF          17      CALL    PRHX2
000199 FFF0 F1              10      POP AF
       FFF1                     PRHX2:
00019A FFF1 E60F             7      AND 00FH
00019C FFF3 FE0A             7      CP  10
00019E FFF5 3F               4      CCF
00019F FFF6 CE30             7      ADC A,'0'
0001A1 FFF8 27               4      DAA
0001A2 FFF9 C3B3D8          10      JP  MSG_A
0001A5 FFFC                         DS  4
       81A9                         ORG $$+OFFSET   ;$DEPHASE
       81A9                     AT_TRAPE:
                                
       81A9                     INITE:
0001A9 CF06                         ORG BDOS,INITE-OFFSET
                                
0001A9 CF06 C309CF          10      JP  IO_BDOS
[EOF:M7INIT.ASM:SHIFT_JIS]
                                    INCLUDE "M7BANK.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                ;   VRAM/KEY/TIMER(0D000H-0EFFFH)にアクセスするので0D000H-0FFFFHに置けない部分
                                ;
                                
       CF09                     IO_BDOS:
0001AC CF09 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001AE CF0B C398D5          10      JP  BDOS0
                                
       CF0E                     IO_INT8253:
0001B1 CF0E F3               4      DI
0001B2 CF0F F5              11      PUSH    AF
0001B3 CF10 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001B5 CF12 3E01             7      LD  A,1
0001B7 CF14 3206E0          13      LD  (0E006H),A  ;8253 Ch.2 カウンタ
0001BA CF17 AF               4      XOR A
0001BB CF18 3206E0          13      LD  (0E006H),A  ;8253 Ch.2 カウンタ
0001BE CF1B D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001C0 CF1D C36DD8          10      JP  INT8253 
                                
       CF20                     RDKEYDATA:
0001C3 CF20 F3               4      DI
0001C4 CF21 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001C6 CF23 3200E0          13      LD  (0E000H),A
0001C9 CF26 3A01E0          13      LD  A,(E001H)
0001CC CF29 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001CE CF2B FB               4      EI
0001CF CF2C C9              10      RET
                                
       CF2D                     RD556VSYNC:
0001D0 CF2D F3               4      DI
0001D1 CF2E D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001D3 CF30 3A02E0          13      LD  A,(0E002H)
0001D6 CF33 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001D8 CF35 FB               4      EI
0001D9 CF36 C9              10      RET
                                
       CF37                     RDMMIO:
0001DA CF37 F3               4      DI
0001DB CF38 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001DD CF3A 7E               7      LD  A,(HL)
0001DE CF3B D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001E0 CF3D FB               4      EI
0001E1 CF3E C9              10      RET
                                
       CF3F                     WRMMIO:
0001E2 CF3F F3               4      DI
0001E3 CF40 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001E5 CF42 77               7      LD  (HL),A
0001E6 CF43 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001E8 CF45 FB               4      EI
0001E9 CF46 C9              10      RET
                                
       CF47                     RDMMIO_BC:
0001EA CF47 F3               4      DI
0001EB CF48 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001ED CF4A 0A               7      LD  A,(BC)
0001EE CF4B D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001F0 CF4D FB               4      EI
0001F1 CF4E C9              10      RET
                                
       CF4F                     WRMMIO_BC:
0001F2 CF4F F3               4      DI
0001F3 CF50 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001F5 CF52 02               7      LD  (BC),A
0001F6 CF53 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001F8 CF55 FB               4      EI
0001F9 CF56 C9              10      RET
                                
       CF57                     IO_PRINT:
0001FA CF57 F3               4      DI
0001FB CF58 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001FD CF5A 77               7      LD  (HL),A
0001FE CF5B CBDC             8      SET 3,H
000200 CF5D 71               7      LD  (HL),C
000201 CF5E D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000203 CF60 FB               4      EI
000204 CF61 C9              10      RET
                                
       CF62                     IO_CLR:
000205 CF62 F3               4      DI
000206 CF63 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF65                     C1AX1:
000208 CF65 7A               4      LD  A,D
000209 CF66 C6D0             7      ADD A,0D0H
00020B CF68 57               4      LD  D,A
00020C CF69 AF               4      XOR A
00020D CF6A 12               7      LD  (DE),A      ;Text
00020E CF6B CBDA             8      SET 3,D
       CF6E                     ICSMC   EQU $+1
000210 CF6D 3E00             7      LD  A,0     ;自己書き換え
000212 CF6F 12               7      LD  (DE),A      ;Color
000213 CF70 13               6      INC DE
000214 CF71 7A               4      LD  A,D
000215 CF72 D6D8             7      SUB 0D8H
000217 CF74 57               4      LD  D,A
000218 CF75 2118FC          10      LD  HL,0-WIDTH*LINE
00021B CF78 19              11      ADD HL,DE
00021C CF79 30EA            12      JR  NC,C1AX1
00021E CF7B E1              10      POP HL
00021F CF7C D1              10      POP DE
000220 CF7D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000222 CF7F FB               4      EI
000223 CF80 C9              10      RET
                                
       CF81                     IO_CLLINE:
000224 CF81 F3               4      DI
000225 CF82 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF84                     CLLINE1:
000227 CF84 CB9C             8      RES 3,H
000229 CF86 77               7      LD  (HL),A      ;Text
00022A CF87 CBDC             8      SET 3,H
00022C CF89 71               7      LD  (HL),C      ;Color
00022D CF8A 23               6      INC HL
00022E CF8B 10F7            13      DJNZ    CLLINE1
000230 CF8D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000232 CF8F FB               4      EI
000233 CF90 C9              10      RET
                                
       CF91                     IO_INS:
000234 CF91 F3               4      DI
000235 CF92 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF94                     IO_INS1:
000237 CF94 CDABCF          17      CALL    C12S
00023A CF97 23               6      INC HL
00023B CF98 10FA            13      DJNZ    IO_INS1
00023D CF9A D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00023F CF9C FB               4      EI
000240 CF9D C9              10      RET
                                
       CF9E                     IO_BS:
000241 CF9E F3               4      DI
000242 CF9F D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CFA1                     IO_BS1:
000244 CFA1 CDABCF          17      CALL    C12S
000247 CFA4 2B               6      DEC HL
000248 CFA5 10F7            13      DJNZ    IO_BS
00024A CFA7 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00024C CFA9 FB               4      EI
00024D CFAA C9              10      RET
                                
       CFAB                     C12S:
00024E CFAB CB9C             8      RES 3,H
000250 CFAD 5E               7      LD  E,(HL)
000251 CFAE 77               7      LD  (HL),A
000252 CFAF 7B               4      LD  A,E
000253 CFB0 CBDC             8      SET 3,H
000255 CFB2 5E               7      LD  E,(HL)
000256 CFB3 71               7      LD  (HL),C
000257 CFB4 4B               4      LD  C,E
000258 CFB5 C9              10      RET
                                
       CFB6                     IO_SCRUP:
000259 CFB6 F3               4      DI
00025A CFB7 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CFB9                     SCRUP1:
00025C CFB9 2815            12      JR  Z,SCRCL
00025E CFBB D5              11      PUSH    DE
00025F CFBC E5              11      PUSH    HL
000260 CFBD CBDA             8      SET 3,D
000262 CFBF CBDC             8      SET 3,H
000264 CFC1 012800          10      LD  BC,WIDTH
000267 CFC4 EDB0                    LDIR
000269 CFC6 E1              10      POP HL
00026A CFC7 D1              10      POP DE
00026B CFC8 012800          10      LD  BC,WIDTH
00026E CFCB EDB0                    LDIR
000270 CFCD 3D               4      DEC A
000271 CFCE 18E9            12      JR  SCRUP1
                                
       CFD0                     SCRCL:
000273 CFD0 0628             7      LD  B,WIDTH
000275 CFD2 EB               4      EX  DE,HL
000276 CFD3 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000278 CFD5 CDADDA          17      CALL    CLLINE
00027B CFD8 E1              10      POP HL
00027C CFD9 D1              10      POP DE
00027D CFDA C1              10      POP BC
00027E CFDB C9              10      RET
                                
       CFDC                     C_MON:
00027F CFDC D3E4            11      OUT (0E4H),A    ;MONITOR ROM(0000H-0FFFH) & VRAM/KEY/TIMER(D000H-FFFFH)
000281 CFDE C7              12      RST 0
                                
       CFDF                     INITINT:
000282 CFDF D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000284 CFE1 2107E0          10      LD  HL,0E007H   ;HL=0E007H 8253 コントロール
000287 CFE4 36B0            10      LD  (HL),0B0H   ;Ch.2 カウンタの下位バイト→上位バイトの順に連続してアクセス Mode 0 16ビットバイナリ
000289 CFE6 3674            10      LD  (HL),074H   ;Ch.1 カウンタの下位バイト→上位バイトの順に連続してアクセス Mode 2 16ビットバイナリ
00028B CFE8 2D               4      DEC L       ;0E006H 8253 Ch.2 カウンタ
00028C CFE9 3602            10      LD  (HL),2
00028E CFEB 3600            10      LD  (HL),0
000290 CFED 2D               4      DEC L       ;0E005H 8253 Ch.1 カウンタ
000291 CFEE 77               7      LD  (HL),A
000292 CFEF 3600            10      LD  (HL),0
000294 CFF1 3E05             7      LD  A,5
000296 CFF3 3203E0          13      LD  (0E003H),A  ;8255 コントロールポートでポートC(0E002H)のINTMSKを1にする
000299 CFF6 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00029B CFF8 C9              10      RET
                                
       CFF9                     BANKE:
00029C CFF9                         DS  0CFFEH-BANKE
[EOF:M7BANK.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   MZ-700/1500
                                
       CFFE                     WBOOT1:
0002A1 CFFE D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)　ここは0CFFEH
0002A3 D000 D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFHH)
0002A5 D002 F3               4      DI
0002A6 D003 3A94EF          13      LD  A,(_KEYSP)
0002A9 D006 CDDFCF          17      CALL    INITINT
0002AC D009 ED7B0600        20      LD  SP,(SYSTEM+1)
0002B0 D00D FB               4      EI
0002B1 D00E 2192EF          10      LD  HL,_KEYD
0002B4 D011 3600            10      LD  (HL),0
0002B6 D013 CD48DC          17      CALL    CHKEY
0002B9 D016 CDA0D8          17      CALL    KEYBC_IFBREAK
0002BC D019 3E04             7      LD  A,4
0002BE D01B CDB3D8          17      CALL    MSG_A
[EOF:M7CCP.ASM:UTF_8]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D01E                     COMMAND:
0002C1 D01E CDD1D0          17      CALL    SETDTA1
0002C4 D021 3A87EF          13      LD  A,(_DVSW)
0002C7 D024 C641             7      ADD A,'A'
0002C9 D026 CDB3D8          17      CALL    MSG_A
0002CC D029 3E3E             7      LD  A,'>'
0002CE D02B CDB3D8          17      CALL    MSG_A
0002D1 D02E 3E50             7      LD  A,80
0002D3 D030 12               7      LD  (DE),A
0002D4 D031 CD13D9          17      CALL    _SYS0A      ;(BDOS)文字列入力
0002D7 D034 CD7BD2          17      CALL    LTNL
                                
0002DA D037 118200          10      LD  DE,DTA1+2
0002DD D03A CDFDEF          17      CALL    _COMANL
0002E0 D03D 30DF            12      JR  NC,COMMAND
0002E2 D03F 1179EF          10      LD  DE,COMERM
0002E5 D042 CDCAD5          17      CALL    _SYS09      ;(BDOS)文字列出力
0002E8 D045 C7              12      RST 0
                                
       D046                     COMANL:
0002E9 D046 CDC1DC          17      CALL    FILE
0002EC D049 3A19EF          13      LD  A,(FNAME+4)
0002EF D04C FE20             7      CP  020H
0002F1 D04E 201C            12      JR  NZ,COMB2
0002F3 D050 D5              11      PUSH    DE
0002F4 D051 1115EF          10      LD  DE,FNAME
0002F7 D054 1A               7      LD  A,(DE)
0002F8 D055 FE20             7      CP  020H
0002FA D057 2844            12      JR  Z,SDVSW
0002FC D059 1B               6      DEC DE
0002FD D05A 1A               7      LD  A,(DE)
0002FE D05B C6FF             7      ADD A,0FFH
000300 D05D 3809            12      JR  C,COMB
000302 D05F 13               6      INC DE
                                
000303 D060 215CD5          10      LD  HL,COMTB
000306 D063 060A             7      LD  B,COMS
000308 D065 CD45DF          17      CALL    CPNAME
       D068                     COMB:
00030B D068 D1              10      POP DE
00030C D069 D20F00          10      JP  NC,JP_HL
       D06C                     COMB2:
00030F D06C EB               4      EX  DE,HL
000310 D06D 2245D1          16      LD  (COMPAT+1),HL
000313 D070 F5              11      PUSH    AF
000314 D071 CDF1D0          17      CALL    CEXE4
000317 D074 F1              10      POP AF
000318 D075 2115EF          10      LD  HL,FNAME
00031B D078 116D00          10      LD  DE,FCB2+1   ;COMMAND NAME
00031E D07B 010B00          10      LD  BC,11
000321 D07E EDB0                    LDIR
000323 D080 11FFD4          10      LD  DE,PATHD
       D083                     CEX1:
000326 D083 1A               7      LD  A,(DE)
000327 D084 FE20             7      CP  020H
000329 D086 D8              11      RET C
00032A D087 CDB6DC          17      CALL    FILEC
00032D D08A D5              11      PUSH    DE
00032E D08B 216D00          10      LD  HL,FCB2+1   ;COMMAND NAME
000331 D08E 1115EF          10      LD  DE,FNAME
000334 D091 010B00          10      LD  BC,11
000337 D094 EDB0                    LDIR
000339 D096 CDF1D0          17      CALL    CEXE4
00033C D099 D1              10      POP DE
00033D D09A 13               6      INC DE
00033E D09B 18E6            12      JR  CEX1
                                
       D09D                     SDVSW:
000340 D09D F1              10      POP AF
000341 D09E 3A14EF          13      LD  A,(FDRV)
000344 D0A1 3D               4      DEC A
000345 D0A2 5F               4      LD  E,A
000346 D0A3 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
000348 D0A5 1831            12      JR  SYSTEM0
                                
       D0A7                     OPEN1:
00034A D0A7 2114EF          10      LD  HL,FDRV
       D0AA                     OPEN:
00034D D0AA 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D0AC                     OPEN3:
00034F D0AC D5              11      PUSH    DE
000350 D0AD 11DAD4          10      LD  DE,DTA_CCP
000353 D0B0 CDCED0          17      CALL    SETDTA
000356 D0B3 EB               4      EX  DE,HL
000357 D0B4 CDD8D0          17      CALL    SYSTEM0
00035A D0B7 D1              10      POP DE
00035B D0B8 C9              10      RET
                                
       D0B9                     OPEN2:
00035C D0B9 0E12             7      LD  C,012H
00035E D0BB 18EF            12      JR  OPEN3
                                
       D0BD                     DEFCB:              ;Z=Ok NZ=Error
000360 D0BD 11DAD4          10      LD  DE,DTA_CCP
000363 D0C0 CDD6D0          17      CALL    SYSC0F
                                
000366 D0C3 11FBD4          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
000369 D0C6 0604             7      LD  B,4
00036B D0C8 CDB9D3          17      CALL    ZERO_MEMORY_DE
00036E D0CB 110001          10      LD  DE,00100H
       D0CE                     SETDTA:
000371 D0CE C3A4D7          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D0D1                     SETDTA1:
000374 D0D1 118000          10      LD  DE,DTA1
000377 D0D4 18F8            12      JR  SETDTA
                                
       D0D6                     SYSC0F:
000379 D0D6 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D0D8                     SYSTEM0:
00037B D0D8 CD0500          17      CALL    SYSTEM
00037E D0DB B7               4      OR  A
00037F D0DC C9              10      RET
                                
       D0DD                     C_CD:
000380 D0DD 0E5A             7      LD  C,5AH
000382 D0DF 18F7            12      JR  SYSTEM0
                                
       D0E1                     S27BUF:
000384 D0E1 3A0700          13      LD  A,(SYSTEM+2)
000387 D0E4 3D               4      DEC A
000388 D0E5 E6F8             7      AND 0F8H
00038A D0E7 67               4      LD  H,A
00038B D0E8 2E00             7      LD  L,0
       D0EA                     S27DTA:
00038D D0EA 11DAD4          10      LD  DE,DTA_CCP
       D0ED                     S27:
000390 D0ED 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
000392 D0EF 18E7            12      JR  SYSTEM0
                                
       D0F1                     CEXE4:
000394 D0F1 3A14EF          13      LD  A,(FDRV)
000397 D0F4 325700          13      LD  (00057H),A
00039A D0F7 2A22EF          16      LD  HL,(FDRV+14)
00039D D0FA 225800          16      LD  (00058H),HL
                                
0003A0 D0FD 211DEF          10      LD  HL,FNAME+8
0003A3 D100 7E               7      LD  A,(HL)
0003A4 D101 FE20             7      CP  020H
0003A6 D103 2007            12      JR  NZ,CEXE7
0003A8 D105 3E3F             7      LD  A,'?'
0003AA D107 77               7      LD  (HL),A
0003AB D108 23               6      INC HL
0003AC D109 77               7      LD  (HL),A
0003AD D10A 23               6      INC HL
0003AE D10B 77               7      LD  (HL),A
       D10C                     CEXE7:
0003AF D10C CDA7D0          17      CALL    OPEN1
       D10F                     CEXE5:
0003B2 D10F C0              11      RET NZ
0003B3 D110 2AE4D4          16      LD  HL,(DTA_CCP+1+9)
0003B6 D113 7C               4      LD  A,H
0003B7 D114 CDCDDF          17      CALL    CAP
0003BA D117 67               4      LD  H,A
0003BB D118 7D               4      LD  A,L
0003BC D119 CDCDDF          17      CALL    CAP
0003BF D11C 6F               4      LD  L,A
0003C0 D11D 3AE3D4          13      LD  A,(DTA_CCP+1+8)
0003C3 D120 CDCDDF          17      CALL    CAP
0003C6 D123 D642             7      SUB 'B'
0003C8 D125 282C            12      JR  Z,C_BAT
0003CA D127 3D               4      DEC A       ;'C'
0003CB D128 2805            12      JR  Z,C_EXE
       D12A                     CEXE6:
0003CD D12A CDB9D0          17      CALL    OPEN2
0003D0 D12D 18E0            12      JR  CEXE5
                                
       D12F                     C_EXE:
0003D2 D12F 7C               4      LD  A,H
0003D3 D130 FE4D             7      CP  'M'
0003D5 D132 20F6            12      JR  NZ,CEXE6
                                
0003D7 D134 CDBDD0          17      CALL    DEFCB
0003DA D137 CDE1D0          17      CALL    S27BUF
0003DD D13A 3D               4      DEC A
0003DE D13B 37               4      SCF
0003DF D13C C0              11      RET NZ
0003E0 D13D 7C               4      LD  A,H
0003E1 D13E B5               4      OR  L
0003E2 D13F 37               4      SCF
0003E3 D140 C8              11      RET Z
0003E4 D141 CDD1D0          17      CALL    SETDTA1
0003E7 D144 110000          10  COMPAT: LD  DE,0                ; self-modifying code
0003EA D147 ED7B0600        20      LD  SP,(SYSTEM+1)
0003EE D14B 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
0003EF D14C 6F               4      LD  L,A
0003F0 D14D E5              11      PUSH    HL              ; push $0000 (reboot address)
0003F1 D14E 24               4      INC H
0003F2 D14F E5              11      PUSH    HL              ; push $0100 (TPA address)
0003F3 D150 C384D3          10      JP  SETFCB              ; and JP $0100
                                
       D153                     C_BAT:
0003F6 D153 114154          10      LD  DE,'A'+'T'*256
0003F9 D156 ED52            15      SBC HL,DE
0003FB D158 20D0            12      JR  NZ,CEXE6
                                
0003FD D15A F1              10      POP AF
0003FE D15B F1              10      POP AF
0003FF D15C CDBDD0          17      CALL    DEFCB
000402 D15F 210002          10      LD  HL,00200H
000405 D162 CDEAD0          17      CALL    S27DTA
000408 D165 C6FE             7      ADD A,0FEH
00040A D167 D8              11      RET C
00040B D168 7D               4      LD  A,L
00040C D169 B7               4      OR  A
00040D D16A 37               4      SCF
00040E D16B C8              11      RET Z
00040F D16C 3C               4      INC A
000410 D16D F5              11      PUSH    AF
                                
000411 D16E CDA3D8          17      CALL    KEYBC
000414 D171 3E06             7      LD  A,6
000416 D173 CDB3D8          17      CALL    MSG_A
000419 D176 C1              10      POP BC
00041A D177 210001          10      LD  HL,00100H
       D17A                     BAT1:
00041D D17A A7               4      AND A
00041E D17B 05               4      DEC B
00041F D17C C8              11      RET Z
000420 D17D 7E               7      LD  A,(HL)
000421 D17E FE25             7      CP  '%'
000423 D180 280C            12      JR  Z,BAT2
       D182                     BAT1X:
000425 D182 7E               7      LD  A,(HL)
000426 D183 23               6      INC HL
000427 D184 FE1A             7      CP  01AH
000429 D186 C8              11      RET Z
00042A D187 FE0A             7      CP  00AH
00042C D189 C488D8          17      CALL    NZ,KEYBS
00042F D18C 18EC            12      JR  BAT1
                                
       D18E                     BAT2:
000431 D18E 23               6      INC HL
000432 D18F 7E               7      LD  A,(HL)
000433 D190 2B               6      DEC HL
000434 D191 D631             7      SUB '1'
000436 D193 38ED            12      JR  C,BAT1X
000438 D195 FE09             7      CP  9
00043A D197 30E9            12      JR  NC,BAT1X
00043C D199 23               6      INC HL
00043D D19A 23               6      INC HL
00043E D19B 3C               4      INC A
00043F D19C 4F               4      LD  C,A
000440 D19D ED5B45D1        20      LD  DE,(COMPAT+1)
       D1A1                     BAT3:
000444 D1A1 1A               7      LD  A,(DE)
000445 D1A2 B7               4      OR  A
000446 D1A3 28D5            12      JR  Z,BAT1
000448 D1A5 CD98DD          17      CALL    SPCUT
00044B D1A8 0D               4      DEC C
00044C D1A9 2808            12      JR  Z,BAT5
       D1AB                     BAT4:
00044E D1AB 1A               7      LD  A,(DE)
00044F D1AC FE21             7      CP  021H
000451 D1AE 38F1            12      JR  C,BAT3
000453 D1B0 13               6      INC DE
000454 D1B1 18F8            12      JR  BAT4
       D1B3                     BAT5:
000456 D1B3 1A               7      LD  A,(DE)
000457 D1B4 FE21             7      CP  021H
000459 D1B6 38C2            12      JR  C,BAT1
00045B D1B8 13               6      INC DE
00045C D1B9 CD88D8          17      CALL    KEYBS
00045F D1BC 18F5            12      JR  BAT5
                                
       D1BE                     C_DEL:
000461 D1BE CD84D3          17      CALL    SETFCB
000464 D1C1 CDC9D8          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
000467 D1C4 0E13             7      LD  C,013H
000469 D1C6 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       D1C8                     C_REN:
00046B D1C8 CD84D3          17      CALL    SETFCB
00046E D1CB 3E10             7      LD  A,010H      ;ディレクトリも対象にする
000470 D1CD 326900          13      LD  (FCB1+13),A ;属性
000473 D1D0 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       D1D2                     CDEL1:
000475 D1D2 115C00          10      LD  DE,FCB1
000478 D1D5 CD0500          17      CALL    SYSTEM
00047B D1D8 C6FF             7      ADD A,0FFH
00047D D1DA C9              10      RET
                                
       D1DB                     C_DIR:
00047E D1DB CDB6DC          17      CALL    FILEC
000481 D1DE 2115EF          10      LD  HL,FDRV+1
000484 D1E1 CDCFD4          17      CALL    CWILD1
000487 D1E4 3EF1             7      LD  A,0F1H
000489 D1E6 3221EF          13      LD  (FDRV+13),A
00048C D1E9 CDA7D0          17      CALL    OPEN1
       D1EC                     CDIR1:
00048F D1EC B7               4      OR  A
000490 D1ED 2008            12      JR  NZ,PDSKF
000492 D1EF CD3AD2          17      CALL    P_NAME
000495 D1F2 CDB9D0          17      CALL    OPEN2
000498 D1F5 18F5            12      JR  CDIR1
                                
       D1F7                     PDSKF:
00049A D1F7 3A14EF          13      LD  A,(FDRV)
00049D D1FA 5F               4      LD  E,A
00049E D1FB 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
0004A0 D1FD CD0500          17      CALL    SYSTEM
0004A3 D200 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
0004A4 D201 C601             7      ADD A,001H
0004A6 D203 D8              11      RET C       ;Aが0FFHだった場合
0004A7 D204 3E06             7      LD  A,8-2
       D206                     PDS1:               ;HL=未使用クラスタの総数
0004A9 D206 3C               4      INC A
0004AA D207 CB19             8      RR  C
0004AC D209 30FB            12      JR  NC,PDS1
       D20B                     PDS2:               ;B←論理セクタのサイズの上位8ビット
0004AE D20B 3C               4      INC A
0004AF D20C CB18             8      RR  B
0004B1 D20E 30FB            12      JR  NC,PDS2
0004B3 D210 47               4      LD  B,A
                                
0004B4 D211 110000          10      LD  DE,0
       D214                     PDS3:
0004B7 D214 29              11      ADD HL,HL
0004B8 D215 EB               4      EX  DE,HL
0004B9 D216 ED6A            15      ADC HL,HL
0004BB D218 EB               4      EX  DE,HL
0004BC D219 10F9            13      DJNZ    PDS3
       D21B                     PDSKF1:
0004BE D21B CDB3D2          17      CALL    PRDEC_DEHL
0004C1 D21E 1140D5          10      LD  DE,FREE
0004C4 D221 CDCAD5          17      CALL    _SYS09      ;(BDOS)文字列出力
0004C7 D224 CDA2D2          17      CALL    PUTDRV
0004CA D227 3E5C             7      LD  A,05CH      ;\
0004CC D229 CDB3D8          17      CALL    MSG_A
0004CF D22C 2A22EF          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
0004D2 D22F AF               4      XOR A
0004D3 D230 11FEFF          10      LD  DE,0-2
0004D6 D233 19              11      ADD HL,DE
0004D7 D234 23               6      INC HL
0004D8 D235 DCAFD2          17      CALL    C,PRDEC_HL
0004DB D238 1841            12      JR  LTNL
                                
       D23A                     P_NAME:
0004DD D23A 3ADBD4          13      LD  A,(DTA_CCP+1)
0004E0 D23D FE2E             7      CP  '.'
0004E2 D23F C8              11      RET Z
0004E3 D240 1158D5          10      LD  DE,DIRHD
0004E6 D243 CDCAD5          17      CALL    _SYS09      ;(BDOS)文字列出力
0004E9 D246 3AE6D4          13      LD  A,(DTA_CCP+1+00BH)
0004EC D249 F5              11      PUSH    AF
0004ED D24A 0F               4      RRCA
0004EE D24B 9F               4      SBC A,A
0004EF D24C E60A             7      AND '*'-020H
0004F1 D24E C620             7      ADD A,020H
0004F3 D250 CDB3D8          17      CALL    MSG_A
0004F6 D253 CDA2D2          17      CALL    PUTDRV
0004F9 D256 21DBD4          10      LD  HL,DTA_CCP+1
0004FC D259 CDF3D2          17      CALL    FPRNT
                                
0004FF D25C F1              10      POP AF
000500 D25D CB67             8      BIT 4,A
000502 D25F 2808            12      JR  Z,DIR3
000504 D261 114DD5          10      LD  DE,DIRMES
000507 D264 CDCAD5          17      CALL    _SYS09      ;(BDOS)文字列出力
00050A D267 180A            12      JR  DIR6
       D269                     DIR3:
00050C D269 ED5BF9D4        20      LD  DE,(DTA_CCP+1+01EH)
000510 D26D 2AF7D4          16      LD  HL,(DTA_CCP+1+01CH)
000513 D270 CDB3D2          17      CALL    PRDEC_DEHL
       D273                     DIR6:
000516 D273 3AB1EF          13      LD  A,(_WIDTH)
000519 D276 FE29             7      CP  40+1
00051B D278 D415D3          17      CALL    NC,PRTTMS
                                
       D27B                     LTNL:
00051E D27B 1E03             7      LD  E,3
000520 D27D C3CDEF          10      JP  _PRINT
                                
       D280                     C_PATH:
000523 D280 CD98DD          17      CALL    SPCUT
000526 D283 21FFD4          10      LD  HL,PATHD
000529 D286 FE21             7      CP  021H
00052B D288 300C            12      JR  NC,CPATH0
       D28A                     CPATHP:
00052D D28A 7E               7      LD  A,(HL)
00052E D28B 23               6      INC HL
00052F D28C FE20             7      CP  020H
000531 D28E 3F               4      CCF
000532 D28F 30EA            12      JR  NC,LTNL
000534 D291 CDB3D8          17      CALL    MSG_A
000537 D294 18F4            12      JR  CPATHP
       D296                     CPATH0:
000539 D296 FE3B             7      CP  ';'
00053B D298 2001            12      JR  NZ,CPATH1
00053D D29A 13               6      INC DE
       D29B                     CPATH1:
00053E D29B EB               4      EX  DE,HL
00053F D29C 014000          10      LD  BC,PATHX
000542 D29F EDB0                    LDIR
000544 D2A1 C9              10      RET
                                
       D2A2                     PUTDRV:
000545 D2A2 3A14EF          13      LD  A,(FDRV)
000548 D2A5 C640             7      ADD A,'A'-1
00054A D2A7 CDB3D8          17      CALL    MSG_A
00054D D2AA 3E3A             7      LD  A,':'
       D2AC                     MSG_AR:
00054F D2AC C3B3D8          10      JP  MSG_A
                                
       D2AF                     PRDEC_HL:
000552 D2AF AF               4      XOR A
       D2B0                     PRDEC_AHL:
000553 D2B0 5F               4      LD  E,A
000554 D2B1 1600             7      LD  D,0
       D2B3                     PRDEC_DEHL:
000556 D2B3 D5              11      PUSH    DE
000557 D2B4 110FEF          10      LD  DE,DECBF
00055A D2B7 0605             7      LD  B,5
00055C D2B9 CDB9D3          17      CALL    ZERO_MEMORY_DE  ;A=0
00055F D2BC D1              10      POP DE
                                
000560 D2BD 0E20             7      LD  C,32
       D2BF                     DEC1:
000562 D2BF 29              11      ADD HL,HL
000563 D2C0 EB               4      EX  DE,HL
000564 D2C1 ED6A            15      ADC HL,HL
000566 D2C3 EB               4      EX  DE,HL
000567 D2C4 E5              11      PUSH    HL
000568 D2C5 2113EF          10      LD  HL,DECBF+4
00056B D2C8 0605             7      LD  B,5
       D2CA                     DEC2:
00056D D2CA 7E               7      LD  A,(HL)
00056E D2CB 8F               4      ADC A,A
00056F D2CC 27               4      DAA
000570 D2CD 77               7      LD  (HL),A
000571 D2CE 2B               6      DEC HL
000572 D2CF 10F9            13      DJNZ    DEC2
000574 D2D1 E1              10      POP HL
000575 D2D2 0D               4      DEC C
000576 D2D3 20EA            12      JR  NZ,DEC1
                                
000578 D2D5 210FEF          10      LD  HL,DECBF
00057B D2D8 3E20             7      LD  A,020H
00057D D2DA 0604             7      LD  B,4
       D2DC                     DEC3:
00057F D2DC CDE9D2          17      CALL    DEC4
000582 D2DF CDE9D2          17      CALL    DEC4
000585 D2E2 23               6      INC HL
000586 D2E3 10F7            13      DJNZ    DEC3
       D2E5                     DECX:
000588 D2E5 CDE9D2          17      CALL    DEC4
00058B D2E8 AF               4      XOR A
       D2E9                     DEC4:
00058C D2E9 ED6F            18      RLD
00058E D2EB FE20             7      CP  020H
000590 D2ED 2802            12      JR  Z,DEC5
000592 D2EF F630             7      OR  030H
       D2F1                     DEC5:
000594 D2F1 18B9            12      JR  MSG_AR
                                
       D2F3                     FPRNT:
000596 D2F3 0608             7      LD  B,8
000598 D2F5 CD06D3          17      CALL    P_N1
00059B D2F8 7E               7      LD  A,(HL)
00059C D2F9 C680             7      ADD A,0A0H-020H
00059E D2FB FEA0             7      CP  0A0H
0005A0 D2FD 2802            12      JR  Z,FPR1
0005A2 D2FF 3E2E             7      LD  A,'.'
       D301                     FPR1:
0005A4 D301 CDB3D8          17      CALL    MSG_A
0005A7 D304 0603             7      LD  B,3
                                
       D306                     P_N1:
0005A9 D306 C5              11      PUSH    BC
0005AA D307 E5              11      PUSH    HL
0005AB D308 7E               7      LD  A,(HL)
0005AC D309 CDD9DF          17      CALL    CAP3
0005AF D30C CDB3D8          17      CALL    MSG_A
0005B2 D30F E1              10      POP HL
0005B3 D310 C1              10      POP BC
0005B4 D311 23               6      INC HL
0005B5 D312 10F2            13      DJNZ    P_N1
0005B7 D314 C9              10      RET
                                
       D315                     PRTTMS:
0005B8 D315 3E20             7      LD  A,020H
0005BA D317 CDB3D8          17      CALL    MSG_A
                                
0005BD D31A 2AF3D4          16      LD  HL,(DTA_CCP+1+24)
0005C0 D31D 7D               4      LD  A,L
0005C1 D31E B7               4      OR  A
0005C2 D31F C8              11      RET Z
0005C3 D320 CB3C             8      SRL H
0005C5 D322 17               4      RLA
0005C6 D323 17               4      RLA
0005C7 D324 17               4      RLA
0005C8 D325 17               4      RLA
0005C9 D326 E60F             7      AND 00FH
0005CB D328 57               4      LD  D,A
0005CC D329 7C               4      LD  A,H
0005CD D32A C650             7      ADD A,80
0005CF D32C CD6FD3          17      CALL    PRDEC_A
0005D2 D32F 3E2D             7      LD  A,'-'
0005D4 D331 CDB3D8          17      CALL    MSG_A
0005D7 D334 7A               4      LD  A,D
0005D8 D335 CD6FD3          17      CALL    PRDEC_A
0005DB D338 3E2D             7      LD  A,'-'
0005DD D33A CDB3D8          17      CALL    MSG_A
0005E0 D33D 7D               4      LD  A,L
0005E1 D33E E61F             7      AND 01FH
0005E3 D340 CD6FD3          17      CALL    PRDEC_A
                                
0005E6 D343 2AF1D4          16      LD  HL,(DTA_CCP+1+22)
                                
0005E9 D346 3E20             7      LD  A,020H
0005EB D348 CDB3D8          17      CALL    MSG_A
0005EE D34B 7C               4      LD  A,H
0005EF D34C 65               4      LD  H,L
0005F0 D34D 0603             7      LD  B,3
       D34F                     PRTTMS1:
0005F2 D34F 1F               4      RRA
0005F3 D350 CB1D             8      RR  L
0005F5 D352 10FB            13      DJNZ    PRTTMS1
0005F7 D354 E61F             7      AND 01FH
0005F9 D356 CD6FD3          17      CALL    PRDEC_A
0005FC D359 3E3A             7      LD  A,':'
0005FE D35B CDB3D8          17      CALL    MSG_A
000601 D35E 7D               4      LD  A,L
000602 D35F 0F               4      RRCA
000603 D360 0F               4      RRCA
000604 D361 E63F             7      AND 03FH
000606 D363 CD6FD3          17      CALL    PRDEC_A
000609 D366 3E3A             7      LD  A,':'
00060B D368 CDB3D8          17      CALL    MSG_A
00060E D36B 7C               4      LD  A,H
00060F D36C E61F             7      AND 01FH
000611 D36E 87               4      ADD A,A
                                
                                ;   PRINT10
                                
       D36F                     PRDEC_A:
000612 D36F E5              11      PUSH    HL
000613 D370 0608             7      LD  B,8
000615 D372 4F               4      LD  C,A
000616 D373 AF               4      XOR A
       D374                     PRTA1:
000617 D374 CB01             4      RLC C
000619 D376 8F               4      ADC A,A
00061A D377 27               4      DAA
00061B D378 10FA            13      DJNZ    PRTA1
00061D D37A 210FEF          10      LD  HL,DECBF
000620 D37D 77               7      LD  (HL),A
000621 D37E AF               4      XOR A
000622 D37F CDE5D2          17      CALL    DECX
000625 D382 E1              10      POP HL
000626 D383 C9              10      RET
                                
       D384                     SETFCB:
000627 D384 CD98DD          17      CALL    SPCUT
00062A D387 1A               7      LD  A,(DE)
00062B D388 FE20             7      CP  020H
00062D D38A 3801            12      JR  C,SETFCBA
00062F D38C 1B               6      DEC DE
       D38D                     SETFCBA:
000630 D38D 0624             7      LD  B,36
000632 D38F 215C00          10      LD  HL,FCB1
000635 D392 E5              11      PUSH    HL
000636 D393 AF               4      XOR A
000637 D394 CD6DDD          17      CALL    FILL_MEMORY
00063A D397 E1              10      POP HL
00063B D398 D5              11      PUSH    DE
00063C D399 CD0AD8          17      CALL    _SYS5C      ;(BDOS)ファイル名の解析
00063F D39C 216C00          10      LD  HL,FCB2
000642 D39F CD0AD8          17      CALL    _SYS5C      ;(BDOS)ファイル名の解析
000645 D3A2 E1              10      POP HL
000646 D3A3 010050          10      LD  BC,05000H
000649 D3A6 118100          10      LD  DE,00081H
       D3A9                     SETFCB1:
00064C D3A9 7E               7      LD  A,(HL)
00064D D3AA 23               6      INC HL
00064E D3AB FE20             7      CP  020H
000650 D3AD 3805            12      JR  C,SETFCB2
000652 D3AF 12               7      LD  (DE),A
000653 D3B0 13               6      INC DE
000654 D3B1 0C               4      INC C
000655 D3B2 10F5            13      DJNZ    SETFCB1
       D3B4                     SETFCB2:
000657 D3B4 79               4      LD  A,C
000658 D3B5 328000          13      LD  (DTA1),A
00065B D3B8 04               4      INC B
       D3B9                     ZERO_MEMORY_DE:
00065C D3B9 AF               4      XOR A
       D3BA                     FILL_MEMORY_DE:
00065D D3BA 12               7      LD  (DE),A
00065E D3BB 13               6      INC DE
00065F D3BC 10FC            13      DJNZ    FILL_MEMORY_DE
000661 D3BE C9              10      RET
                                
       D3BF                     C_COPY:
000662 D3BF CD84D3          17      CALL    SETFCB
                                
000665 D3C2 1161EF          10      LD  DE,ZERO
000668 D3C5 CDB9DC          17      CALL    FILEC2
00066B D3C8 216C00          10      LD  HL,FCB2
00066E D3CB CD11D8          17      CALL    S29X1
                                
000671 D3CE 3E10             7      LD  A,010H
000673 D3D0 326900          13      LD  (FCB1+13),A
000676 D3D3 216D00          10      LD  HL,FCB2+1
000679 D3D6 CDCFD4          17      CALL    CWILD1
       D3D9                     COPY0:
00067C D3D9 CDCCD4          17      CALL    CWILD
00067F D3DC 215C00          10      LD  HL,FCB1
000682 D3DF CDAAD0          17      CALL    OPEN
000685 D3E2 37               4      SCF
       D3E3                     COPY1:
000686 D3E3 C0              11      RET NZ
000687 D3E4 CDBDD0          17      CALL    DEFCB
                                
00068A D3E7 3AE7D4          13      LD  A,(DTA_CCP+13)
00068D D3EA CB67             8      BIT 4,A
00068F D3EC 2821            12      JR  Z,COPY1A
                                
000691 D3EE 215D00          10      LD  HL,FCB1+1
000694 D3F1 CDFCE0          17      CALL    CHKWILD
000697 D3F4 3814            12      JR  C,COPY9
                                
000699 D3F6 3E20             7      LD  A,020H
00069B D3F8 325D00          13      LD  (FCB1+1),A
00069E D3FB 2AF4D4          16      LD  HL,(DTA_CCP+26)
0006A1 D3FE 23               6      INC HL
0006A2 D3FF 226A00          16      LD  (FCB1+14),HL
0006A5 D402 18D5            12      JR  COPY0
                                
       D404                     COPY8:
0006A7 D404 CDCAD5          17      CALL    _SYS09      ;(BDOS)文字列出力
0006AA D407 CD7BD2          17      CALL    LTNL
       D40A                     COPY9:
0006AD D40A CDB9D0          17      CALL    OPEN2
0006B0 D40D 18D4            12      JR  COPY1
                                
       D40F                     COPY1A:
0006B2 D40F 216C00          10      LD  HL,FCB2
0006B5 D412 1114EF          10      LD  DE,FDRV
0006B8 D415 01DCD4          10      LD  BC,DTA_CCP+2
0006BB D418 EDA0            16      LDI
0006BD D41A 3E0B             7      LD  A,11
       D41C                     COPY2:
0006BF D41C F5              11      PUSH    AF
0006C0 D41D 7E               7      LD  A,(HL)
0006C1 D41E FE3F             7      CP  '?'
0006C3 D420 2001            12      JR  NZ,COPY3
0006C5 D422 0A               7      LD  A,(BC)
       D423                     COPY3:
0006C6 D423 12               7      LD  (DE),A
0006C7 D424 03               6      INC BC
0006C8 D425 13               6      INC DE
0006C9 D426 23               6      INC HL
0006CA D427 F1              10      POP AF
0006CB D428 3D               4      DEC A
0006CC D429 20F1            12      JR  NZ,COPY2
0006CE D42B 010500          10      LD  BC,16-11
0006D1 D42E EDB0                    LDIR
       D430                     PUTNAME:
0006D3 D430 215D00          10      LD  HL,FCB1+1
0006D6 D433 CDFCE0          17      CALL    CHKWILD
0006D9 D436 300B            12      JR  NC,PUTN1
0006DB D438 2115EF          10      LD  HL,FDRV+1
0006DE D43B CDF3D2          17      CALL    FPRNT
0006E1 D43E 3E20             7      LD  A,020H
0006E3 D440 CDB3D8          17      CALL    MSG_A
       D443                     PUTN1:
0006E6 D443 1114EF          10      LD  DE,FDRV
0006E9 D446 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
0006EB D448 CDD8D0          17      CALL    SYSTEM0
0006EE D44B 2048            12      JR  NZ,COPYE2
0006F0 D44D 67               4      LD  H,A     ;A=0
0006F1 D44E 6F               4      LD  L,A
0006F2 D44F 2235EF          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
0006F5 D452 2237EF          16      LD  (FDRV+35),HL
       D455                     COPY6:
0006F8 D455 CDE1D0          17      CALL    S27BUF
0006FB D458 47               4      LD  B,A
0006FC D459 3C               4      INC A
0006FD D45A 2831            12      JR  Z,COPYE
0006FF D45C 7C               4      LD  A,H
000700 D45D B5               4      OR  L
000701 D45E 280C            12      JR  Z,COPY7
000703 D460 1114EF          10      LD  DE,FDRV
000706 D463 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
000708 D465 CDD8D0          17      CALL    SYSTEM0
00070B D468 2023            12      JR  NZ,COPYE
00070D D46A 10E9            13      DJNZ    COPY6
       D46C                     COPY7:
00070F D46C 3AE7D4          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
000712 D46F 3221EF          13      LD  (FDRV+13),A
000715 D472 21EED4          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
000718 D475 1128EF          10      LD  DE,FDRV+20
00071B D478 010400          10      LD  BC,4
00071E D47B EDB0                    LDIR
                                
000720 D47D 1114EF          10      LD  DE,FDRV
000723 D480 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
000725 D482 CDD8D0          17      CALL    SYSTEM0
000728 D485 2006            12      JR  NZ,COPYE
                                
00072A D487 1171EF          10      LD  DE,OK
00072D D48A C304D4          10      JP  COPY8
                                
       D48D                     COPYE:
000730 D48D 1114EF          10      LD  DE,FDRV
000733 D490 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
000735 D492 CD0500          17      CALL    SYSTEM
       D495                     COPYE2:
000738 D495 37               4      SCF
000739 D496 C9              10      RET
                                
       D497                     C_TYPE:
00073A D497 CD84D3          17      CALL    SETFCB
00073D D49A 215C00          10      LD  HL,FCB1
000740 D49D CDAAD0          17      CALL    OPEN
000743 D4A0 37               4      SCF
       D4A1                     TYPE1:
000744 D4A1 C0              11      RET NZ
000745 D4A2 CDBDD0          17      CALL    DEFCB
000748 D4A5 3E06             7      LD  A,6
00074A D4A7 CDB3D8          17      CALL    MSG_A
       D4AA                     TYPE2:
00074D D4AA CDE1D0          17      CALL    S27BUF
000750 D4AD C6FE             7      ADD A,0FEH
000752 D4AF D8              11      RET C
000753 D4B0 7C               4      LD  A,H
000754 D4B1 B5               4      OR  L
000755 D4B2 2813            12      JR  Z,TYPEE
000757 D4B4 010001          10      LD  BC,00100H
       D4B7                     TYPE3:
00075A D4B7 0A               7      LD  A,(BC)
00075B D4B8 03               6      INC BC
00075C D4B9 FE1A             7      CP  01AH
00075E D4BB 280A            12      JR  Z,TYPEE
000760 D4BD CDB3D8          17      CALL    MSG_A
000763 D4C0 2B               6      DEC HL
000764 D4C1 7C               4      LD  A,H
000765 D4C2 B5               4      OR  L
000766 D4C3 20F2            12      JR  NZ,TYPE3
000768 D4C5 18E3            12      JR  TYPE2
       D4C7                     TYPEE:
00076A D4C7 CDB9D0          17      CALL    OPEN2
00076D D4CA 18D5            12      JR  TYPE1
                                
       D4CC                     CWILD:
00076F D4CC 215D00          10      LD  HL,FCB1+1
       D4CF                     CWILD1:
000772 D4CF 7E               7      LD  A,(HL)
000773 D4D0 FE20             7      CP  020H
000775 D4D2 C0              11      RET NZ
       D4D3                     CWILD2:
000776 D4D3 3E3F             7      LD  A,'?'
000778 D4D5 060B             7      LD  B,11
00077A D4D7 C36DDD          10      JP  FILL_MEMORY
                                
       D4DA                     DTA_CCP:
00077D D4DA                         DS  37
                                
       0040                     PATHX   EQU 64
0007A2 D4FF                     PATHD:  DS  PATHX
0007E2 D53F 00                  PATHE:  DB  0
                                
0007E3 D540 2062797465732066    FREE:   DB  " bytes free",9,'$'
            7265650924          
0007F0 D54D 20202020203C4449    DIRMES: DB  "     <DIR>$"
            523E24              
0007FB D558 20203A24            DIRHD:  DB  "  :$"
                                
       D55C                     COMTB:
0007FF D55C 44202020                DB  "D   "  ;1
000803 D560 DBD1                    DW  C_DIR
000805 D562 44495220                DB  "DIR "  ;2
000809 D566 DBD1                    DW  C_DIR
00080B D568 434F5059                DB  "COPY"  ;3
00080F D56C BFD3                    DW  C_COPY
000811 D56E 43442020                DB  "CD  "  ;4
000815 D572 DDD0                    DW  C_CD
000817 D574 44454C20                DB  "DEL "  ;5
00081B D578 BED1                    DW  C_DEL
00081D D57A 50415448                DB  "PATH"  ;6
000821 D57E 80D2                    DW  C_PATH
000823 D580 52454E20                DB  "REN "  ;7
000827 D584 C8D1                    DW  C_REN
000829 D586 54595045                DB  "TYPE"  ;8
00082D D58A 97D4                    DW  C_TYPE
00082F D58C 52454D20                DB  "REM "  ;9
000833 D590 C7D5                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP2.ASM"
                                
                                ;   LSX-Dodgers CCP2
                                ;   MZ-700/1500
                                
000835 D592 4D4F4E20                DB  "MON "  ;10
000839 D596 DCCF                    DW  C_MON
[EOF:M7CCP2.ASM:UTF_8]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       D598                     BDOS0:
00083B D598 E5              11      PUSH    HL
00083C D599 79               4      LD  A,C
00083D D59A FE3C             7      CP  03CH
00083F D59C 3802            12      JR  C,DOS1
000841 D59E 3E3C             7      LD  A,03CH
       D5A0                     DOS1:
000843 D5A0 87               4      ADD A,A
000844 D5A1 6F               4      LD  L,A
000845 D5A2 26F0             7      LD  H,STABLE/256
000847 D5A4 7E               7      LD  A,(HL)
000848 D5A5 2C               4      INC L
000849 D5A6 66               7      LD  H,(HL)
00084A D5A7 6F               4      LD  L,A
00084B D5A8 E3              19      EX  (SP),HL
00084C D5A9 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
00084D D5AA C9              10      RET
       D5AB                     _DOS2:
00084E D5AB FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
000850 D5AD CA4ED8          10      JP  Z,_SYS5A
000853 D5B0 FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
000855 D5B2 CA0AD8          10      JP  Z,_SYS5C
000858 D5B5 FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
00085A D5B7 CA2FEA          10      JP  Z,_SYS5F
00085D D5BA FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
00085F D5BC 200A            12      JR  NZ,_ERROR
000861 D5BE 011D01          10      LD  BC,011DH
000864 D5C1 115101          10      LD  DE,VER
000867 D5C4 210100          10      LD  HL,MACD
       D5C7                     C_REM:
00086A D5C7 AF               4      XOR A
       D5C8                     _ERROR:
00086B D5C8 A7               4      AND A
00086C D5C9 C9              10      RET
                                
       D5CA                     _SYS09:     ;文字列出力
00086D D5CA D5              11      PUSH    DE
       D5CB                     _SX09:
00086E D5CB 1A               7      LD  A,(DE)
00086F D5CC 13               6      INC DE
000870 D5CD FE24             7      CP  '$'
000872 D5CF 2831            12      JR  Z,SX0E2
000874 D5D1 CDB3D8          17      CALL    MSG_A
000877 D5D4 18F5            12      JR  _SX09
                                
       D5D6                     MSX1:
000879 D5D6 CDB3D8          17      CALL    MSG_A
       D5D9                     MSX:
00087C D5D9 7E               7      LD  A,(HL)
00087D D5DA 23               6      INC HL
00087E D5DB B7               4      OR  A
00087F D5DC 20F8            12      JR  NZ,MSX1
000881 D5DE C9              10      RET
                                
       D5DF                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000882 D5DF 212200          10      LD  HL,00022H
000885 D5E2 7D               4      LD  A,L
000886 D5E3 C9              10      RET
                                
       D5E4                     _SYS0D:     ;(BDOS)ディスクリセット
000887 D5E4 CDDFEF          17      CALL    _FFLUSH
00088A D5E7 E5              11      PUSH    HL
00088B D5E8 218000          10      LD  HL,00080H
00088E D5EB 228AEF          16      LD  (_DTA),HL
000891 D5EE E1              10      POP HL
000892 D5EF D5              11      PUSH    DE
000893 D5F0 1E00             7      LD  E,0
000895 D5F2 3E                      DB  03EH
                                
       D5F3                     _SYS0E:     ;(BDOS)カレントドライブの設定
000896 D5F3 D5              11      PUSH    DE
000897 D5F4 7B               4      LD  A,E
000898 D5F5 DDE5            15      PUSH    IX
00089A D5F7 CDDCEF          17      CALL    _GETDPB
00089D D5FA DDE1            14      POP IX
00089F D5FC 3804            12      JR  C,SX0E2
0008A1 D5FE 7B               4      LD  A,E
0008A2 D5FF 3287EF          13      LD  (_DVSW),A
       D602                     SX0E2:
0008A5 D602 3E08             7      LD  A,8
0008A7 D604 D1              10      POP DE
0008A8 D605 C9              10      RET
                                
       D606                     _SYS0F:     ;(BDOS)ファイルのオープン
0008A9 D606 CDAADD          17      CALL    SETDRV
0008AC D609 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0008AF D60C C602             7      ADD A,002H      ;Write
0008B1 D60E 2848            12      JR  Z,FEND0F
0008B3 D610 CDF8E0          17      CALL    CHKWILDX
                                
0008B6 D613 D4CADD          17      CALL    NC,SOPENX
       D616                     _S16XX:
0008B9 D616 3840            12      JR  C,FEND0F
                                                ;Directory location
0008BB D618 3A9FEF          13      LD  A,(_FILEN)
0008BE D61B FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
0008C1 D61E 3AA0EF          13      LD  A,(_DIRF)
0008C4 D621 FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
0008C7 D624 FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
0008CA D627 FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
0008CD D62A FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
0008D1 D62E FDE5            15      PUSH    IY
0008D3 D630 D1              10      POP DE
0008D4 D631 13               6      INC DE
0008D5 D632 010B00          10      LD  BC,11
0008D8 D635 EDB0                    LDIR
                                ;               Attribute
0008DA D637 7E               7      LD  A,(HL)
0008DB D638 FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
0008DE D63B 110B00          10      LD  DE,11       ;Reserved
0008E1 D63E 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
0008E2 D63F 11EAF0          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
0008E5 D642 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D644                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
0008E7 D644 1A               7      LD  A,(DE)
0008E8 D645 13               6      INC DE
0008E9 D646 324DD6          13      LD  (S16PAT+2),A
0008EC D649 7E               7      LD  A,(HL)
0008ED D64A 23               6      INC HL
0008EE D64B FD7700          19  S16PAT: LD  (IY+0),A
0008F1 D64E 10F4            13      DJNZ    S16LOOP
                                
0008F3 D650 AF               4      XOR A
0008F4 D651 FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
0008F7 D654 FD22FCD6        20      LD  (OFCB+1),IY
       D658                     FEND0F:
0008FB D658 1845            12      JR  FEND10
                                
       D65A                     _SYS10:     ;(BDOS)ファイルのクローズ
0008FD D65A CDAADD          17      CALL    SETDRV
000900 D65D FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000903 D660 D6FE             7      SUB 0FEH
000905 D662 37               4      SCF
000906 D663 3F               4      CCF
000907 D664 2039            12      JR  NZ,FEND10
       D666                     _S10A:              ;Write
000909 D666 FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
00090C D669 FD770F          19      LD  (IY+15),A
                                
00090F D66C FD341C          23      INC (IY+28)     ;0FEH->0FFH ;オープンモード
000912 D66F CDF0E1          17      CALL    SETTMS
                                
000915 D672 FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000918 D675 32A0EF          13      LD  (_DIRF),A
00091B D678 E67F             7      AND 07FH
00091D D67A 3239E7          13      LD  (_SECPS+1),A
000920 D67D FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
000923 D680 FD561F          19      LD  D,(IY+31)
000926 D683 CDFEDE          17      CALL    READ_DIR
000929 D686 3817            12      JR  C,FEND10
                                
00092B D688 3A28DE          13  SDECM1: LD  A,(SDECPAT+1)   ;1セクタ辺りのディレクトリエントリ数
00092E D68B 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
00092F D68C FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
000932 D68F 6F               4      LD  L,A
000933 D690 2600             7      LD  H,0
000935 D692 29              11      ADD HL,HL       ;*2
000936 D693 29              11      ADD HL,HL       ;*4
000937 D694 29              11      ADD HL,HL       ;*8
000938 D695 29              11      ADD HL,HL       ;*16
000939 D696 29              11      ADD HL,HL       ;*32
00093A D697 ED4B7EF0        20      LD  BC,(_DTBUF)
00093E D69B 09              11      ADD HL,BC
                                
00093F D69C CD08E1          17      CALL    SDIRENT
       D69F                     FEND10:
000942 D69F 1842            12      JR  FEND
                                
       D6A1                     _SYS11:     ;(BDOS)最初のファイルの検索
000944 D6A1 CDAADD          17      CALL    SETDRV
000947 D6A4 CDF7DD          17      CALL    SOPEN
       D6A7                     _S12X1:
00094A D6A7 383A            12      JR  C,FEND
00094C D6A9 CD97DE          17      CALL    SOPENE2
00094F D6AC ED5B8AEF        20      LD  DE,(_DTA)
000953 D6B0 3A88EF          13      LD  A,(_DRV)
000956 D6B3 3C               4      INC A
000957 D6B4 12               7      LD  (DE),A
000958 D6B5 D5              11      PUSH    DE
000959 D6B6 13               6      INC DE
00095A D6B7 012000          10      LD  BC,32
00095D D6BA EDB0                    LDIR
00095F D6BC FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000962 D6BF FD660F          19      LD  H,(IY+15)
000965 D6C2 22F4F0          16      LD  (SCDIR),HL
000968 D6C5 2A9AEF          16      LD  HL,(_FBPS)
00096B D6C8 22F6F0          16      LD  (SFBPS),HL
00096E D6CB 2A9FEF          16      LD  HL,(_FILEN)
000971 D6CE 7C               4      LD  A,H
000972 D6CF B7               4      OR  A
000973 D6D0 2806            12      JR  Z,_S12DIR
000975 D6D2 3A39E7          13      LD  A,(_SECPS+1)
000978 D6D5 F680             7      OR  080H
00097A D6D7 67               4      LD  H,A
       D6D8                     _S12DIR:
00097B D6D8 22F8F0          16      LD  (SFNDF),HL  ;Directory position and Flags
00097E D6DB E1              10      POP HL
00097F D6DC 1139EF          10      LD  DE,SFILE
000982 D6DF 0E21             7      LD  C,33
       D6E1                     _S11B:
000984 D6E1 EDB0                    LDIR
       D6E3                     FEND:
000986 D6E3 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D6E4                     FENDE:
000987 D6E4 FDE1            14      POP IY
000989 D6E6 C1              10      POP BC
00098A D6E7 D1              10      POP DE
00098B D6E8 E1              10      POP HL
00098C D6E9 C9              10      RET
                                
       D6EA                     _SYS12:     ;(BDOS)次のファイルの検索
00098D D6EA E5              11      PUSH    HL
00098E D6EB D5              11      PUSH    DE
00098F D6EC C5              11      PUSH    BC
000990 D6ED FDE5            15      PUSH    IY
000992 D6EF CD5BDE          17      CALL    NOPEN
000995 D6F2 18B3            12      JR  _S12X1
                                
       D6F4                     _S16K:
000997 D6F4 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
00099A D6F7 FEFD             7      CP  0FDH        ;Device(0FDH)
00099C D6F9 37               4      SCF
00099D D6FA C8              11      RET Z
                                
00099E D6FB 110000          10  OFCB:   LD  DE,0
0009A1 D6FE D5              11      PUSH    DE
0009A2 D6FF 061A             7      LD  B,26        ;First cluster
       D701                     S16K1:
0009A4 D701 13               6      INC DE
0009A5 D702 23               6      INC HL
0009A6 D703 10FC            13      DJNZ    S16K1
                                
0009A8 D705 1A               7      LD  A,(DE)
0009A9 D706 BE               7      CP  (HL)
0009AA D707 2013            12      JR  NZ,S16K2
0009AC D709 13               6      INC DE
0009AD D70A 23               6      INC HL
0009AE D70B 1A               7      LD  A,(DE)
0009AF D70C BE               7      CP  (HL)
0009B0 D70D 200D            12      JR  NZ,S16K2
                                
0009B2 D70F E1              10      POP HL
0009B3 D710 FDE5            15      PUSH    IY
0009B5 D712 D1              10      POP DE
0009B6 D713 1A               7      LD  A,(DE)      ;Drive
0009B7 D714 BE               7      CP  (HL)
0009B8 D715 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
0009BA D717 ED52            15      SBC HL,DE       ;CP HL,DE
0009BC D719 37               4      SCF
0009BD D71A C0              11      RET NZ
0009BE D71B E5              11      PUSH    HL
       D71C                     S16K2:
0009BF D71C E1              10      POP HL
       D71D                     S16K3:
0009C0 D71D FDE5            15      PUSH    IY
0009C2 D71F D1              10      POP DE
       D720                     _SYS13:     ;(BDOS)ファイルの削除
0009C3 D720 CDAADD          17      CALL    SETDRV
0009C6 D723 CD28E0          17      CALL    KILL
       D726                     FEND13:
0009C9 D726 18BB            12      JR  FEND
                                
       D728                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0009CB D728 CDAADD          17      CALL    SETDRV
0009CE D72B CD5CE2          17      CALL    INIT_SEQ
       D72E                     SREAD:
0009D1 D72E CDA6E2          17      CALL    RB_READ
                                
0009D4 D731 C601             7      ADD A,001H
0009D6 D733 38AE            12      JR  C,FEND
                                
0009D8 D735 7D               4      LD  A,L
0009D9 D736 D601             7      SUB 001H
       D738                     FENDX:
0009DB D738 9F               4      SBC A,A
0009DC D739 E603             7      AND 3
0009DE D73B 1F               4      RRA
0009DF D73C 18A6            12      JR  FENDE
                                
       D73E                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
0009E1 D73E CDAADD          17      CALL    SETDRV
0009E4 D741 CD5CE2          17      CALL    INIT_SEQ
       D744                     SWRITE:
0009E7 D744 CD9FE2          17      CALL    RB_WRITE
                                
0009EA D747 C6FF             7      ADD A,0FFH
0009EC D749 18ED            12      JR  FENDX
                                
       D74B                     _SYS17:     ;(BDOS)ファイル名の変更
0009EE D74B CDAADD          17      CALL    SETDRV
0009F1 D74E CD7EE0          17      CALL    NAME
0009F4 D751 18D3            12      JR  FEND13
                                
       D753                     _SYS16:     ;(BDOS)ファイルの作成
0009F6 D753 CDAADD          17      CALL    SETDRV
                                
0009F9 D756 CDF8E0          17      CALL    CHKWILDX
0009FC D759 38CB            12      JR  C,FEND13
0009FE D75B FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
000A01 D75E FE05             7      CP  5
000A03 D760 2805            12      JR  Z,_S16X2
000A05 D762 FE21             7      CP  021H
000A07 D764 DA26D7          10      JP  C,FEND13
       D767                     _S16X2:
                                ;               Clear FCB
000A0A D767 FDE5            15      PUSH    IY
000A0C D769 E1              10      POP HL
000A0D D76A 011000          10      LD  BC,16
000A10 D76D 09              11      ADD HL,BC
       D76E                     _S16X1:
000A11 D76E 70               7      LD  (HL),B      ;B=0
000A12 D76F 23               6      INC HL
000A13 D770 0D               4      DEC C
000A14 D771 20FB            12      JR  NZ,_S16X1
                                
000A16 D773 CDF5E1          17      CALL    SETTMSX
000A19 D776 FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000A1D D77A CDCADD          17      CALL    SOPENX
000A20 D77D 3F               4      CCF
000A21 D77E CCF4D6          17      CALL    Z,_S16K
000A24 D781 D4A8DE          17      CALL    NC,COPEN
000A27 D784 D408E1          17      CALL    NC,SDIRENT
000A2A D787 C316D6          10      JP  _S16XX
                                
       D78A                     _SYS21:     ;(BDOS)ランダムな読み出し
000A2D D78A CDAADD          17      CALL    SETDRV
000A30 D78D CD40E2          17      CALL    INIT_RND
000A33 D790 189C            12      JR  SREAD
                                
       D792                     _SYS22:     ;(BDOS)ランダムな書き込み
       D792                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000A35 D792 CDAADD          17      CALL    SETDRV
000A38 D795 CD40E2          17      CALL    INIT_RND
000A3B D798 18AA            12      JR  SWRITE
                                
       D79A                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000A3D D79A 21FF00          10      LD  HL,000FFH
000A40 D79D AF               4      XOR A
000A41 D79E C9              10      RET
                                
       D79F                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000A42 D79F 3A87EF          13      LD  A,(_DVSW)
000A45 D7A2 A7               4      AND A
000A46 D7A3 C9              10      RET
                                
       D7A4                     _SYS1A:     ;(BDOS)DTAの設定
000A47 D7A4 ED538AEF        20      LD  (_DTA),DE
000A4B D7A8 AF               4      XOR A
000A4C D7A9 C9              10      RET
                                
       D7AA                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000A4D D7AA 7B               4      LD  A,E
000A4E D7AB CDBDDD          17      CALL    GETDRV
000A51 D7AE CDDCEF          17      CALL    _GETDPB
000A54 D7B1 D4E2EF          17      CALL    NC,_RDFATX
000A57 D7B4 210000          10      LD  HL,0
000A5A D7B7 D4CEE1          17      CALL    NC,DSKF
                                
000A5D D7BA ED5BCFE1        20      LD  DE,(MAXCLP+1)   ;DPB_08_MAXCL-1
000A61 D7BE 1B               6      DEC DE      ;DE←クラスタの総数
000A62 D7BF FD2A7CF0        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000A66 D7C3 9F               4      SBC A,A
000A67 D7C4 D8              11      RET C
000A68 D7C5 4F               4      LD  C,A     ;C=0
000A69 D7C6 DD7E0F          19      LD  A,(IX+00FH) ;DPB_0F_BPS
000A6C D7C9 E60F             7      AND 00FH
000A6E D7CB 47               4      LD  B,A
000A6F D7CC DD7E07          19      LD  A,(IX+7)    ;DPB_07_SECPCL
000A72 D7CF C9              10      RET
                                
       D7D0                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000A73 D7D0 AF               4      XOR A
000A74 D7D1 67               4      LD  H,A
000A75 D7D2 6F               4      LD  L,A
000A76 D7D3 C9              10      RET
                                
       D7D4                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000A77 D7D4 2100F1          10      LD  HL,DEVICE
000A7A D7D7 7B               4      LD  A,E
000A7B D7D8 C3DCEF          10      JP  _GETDPB
                                
       D7DB                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000A7E D7DB E5              11      PUSH    HL
000A7F D7DC 2A1EF0          16      LD  HL,(STABLE+2*00FH)  ;ファイルのオープン
000A82 D7DF CD0F00          17      CALL    JP_HL
000A85 D7E2 381B            12      JR  C,_S23X1
                                
000A87 D7E4 D5              11      PUSH    DE      ;EX DE,IY
000A88 D7E5 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000A8A D7E7 FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000A8D D7EA FD6E11          19      LD  L,(IY+17)   ;
000A90 D7ED FD6612          19      LD  H,(IY+18)   ;
000A93 D7F0 C5              11      PUSH    BC      ;
000A94 D7F1 FD4613          19      LD  B,(IY+19)   ;
000A97 D7F4 CD32E2          17      CALL    GET_CPM_R_SIZE
000A9A D7F7 C1              10      POP BC
       D7F8                     _S24X1:
000A9B D7F8 CD52E2          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000A9E D7FB FDE3            23      EX  (SP),IY     ;
000AA0 D7FD D1              10      POP DE      ;
                                
000AA1 D7FE AF               4      XOR A
       D7FF                     _S23X1:
000AA2 D7FF E1              10      POP HL
000AA3 D800 C9              10      RET
                                
       D801                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000AA4 D801 E5              11      PUSH    HL
000AA5 D802 D5              11      PUSH    DE      ;EX DE,IY
000AA6 D803 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000AA8 D805 CD64E2          17      CALL    GETSEQ
000AAB D808 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D80A                     _SYS5C:     ;(BDOS)ファイル名の解析
000AAD D80A C5              11      PUSH    BC
000AAE D80B E5              11      PUSH    HL
000AAF D80C CDC1DC          17      CALL    FILE
000AB2 D80F E1              10      POP HL
000AB3 D810 C1              10      POP BC
       D811                     S29X1:
000AB4 D811 C5              11      PUSH    BC
000AB5 D812 D5              11      PUSH    DE
000AB6 D813 E5              11      PUSH    HL
000AB7 D814 EB               4      EX  DE,HL
000AB8 D815 2114EF          10      LD  HL,FDRV
000ABB D818 010D00          10      LD  BC,13
000ABE D81B EDB0                    LDIR
000AC0 D81D 70               7      LD  (HL),B      ;B=0
000AC1 D81E 0E03             7      LD  C,3
000AC3 D820 EDB0                    LDIR
000AC5 D822 E1              10      POP HL
000AC6 D823 D1              10      POP DE
000AC7 D824 C1              10      POP BC
000AC8 D825 AF               4      XOR A
000AC9 D826 C9              10      RET
                                
       D827                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
000ACA D827 C5              11      PUSH    BC
000ACB D828 01D3E8          10      LD  BC,DWT24B
000ACE D82B 1804            12      JR  S2FX
       D82D                     _SYS2F:
000AD0 D82D C5              11      PUSH    BC
000AD1 D82E 01C3E8          10      LD  BC,DRD24B
       D831                     S2FX:
000AD4 D831 ED4347D8        20      LD  (S2FPAT+1),BC
000AD8 D835 CDDFEF          17      CALL    _FFLUSH
                                
000ADB D838 D5              11      PUSH    DE
000ADC D839 E5              11      PUSH    HL
000ADD D83A 7D               4      LD  A,L     ;Drive
000ADE D83B CDD9EF          17      CALL    _CHGDRV
000AE1 D83E 3809            12      JR  C,S30X2
000AE3 D840 44               4      LD  B,H     ;Number of clusters
000AE4 D841 2A8AEF          16      LD  HL,(_DTA)
                                
000AE7 D844 0E00             7      LD  C,0
000AE9 D846 CDC3E8          17  S2FPAT: CALL    DRD24B
       D849                     S30X2:
000AEC D849 E1              10      POP HL
000AED D84A D1              10      POP DE
000AEE D84B C1              10      POP BC
000AEF D84C 9F               4      SBC A,A
000AF0 D84D C9              10      RET
                                
       D84E                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
000AF1 D84E C5              11      PUSH    BC
000AF2 D84F D5              11      PUSH    DE
000AF3 D850 E5              11      PUSH    HL
000AF4 D851 CDB6DC          17      CALL    FILEC
000AF7 D854 210000          10      LD  HL,0
000AFA D857 1114EF          10      LD  DE,FDRV
000AFD D85A 2A4EF0          16      LD  HL,(STABLE+2*027H)  ;ランダムブロック読み込み
000B00 D85D CD0F00          17      CALL    JP_HL
000B03 D860 18E7            12      JR  S30X2
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "M7IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                
       D5C8                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D5C8                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D5C8                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D5C8                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D5C8                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D5C8                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
       D862                     ARWKEY:
000B05 D862 3D               4      DEC A
000B06 D863 3275D8          13      LD  (KEYAR),A
000B09 D866 181D            12      JR  INT8253E
       D868                     SETKEY1:
000B0B D868 3A95EF          13      LD  A,(_KEYSP+1)
000B0E D86B 180C            12      JR  SETKEY
       D86D                     INT8253:
000B10 D86D CD48DC          17      CALL    CHKEY
       D871                     KEYDT   EQU $+1
000B13 D870 FE00             7      CP  0
000B15 D872 20F4            12      JR  NZ,SETKEY1
       D875                     KEYAR   EQU $+1
000B17 D874 3E00             7      LD  A,0
000B19 D876 B7               4      OR  A
000B1A D877 20E9            12      JR  NZ,ARWKEY
       D879                     SETKEY:
000B1C D879 3275D8          13      LD  (KEYAR),A
000B1F D87C 3A92EF          13      LD  A,(_KEYD)
000B22 D87F 3271D8          13      LD  (KEYDT),A
000B25 D882 CD88D8          17      CALL    KEYSET
       D885                     INT8253E:
000B28 D885 F1              10      POP AF
000B29 D886 FB               4      EI
000B2A D887 C9              10      RET
       D888                     KEYSET:
       D888                     KEYBS:
000B2B D888 B7               4      OR  A
000B2C D889 C8              11      RET Z
       D88A                     KEYBS1:
000B2D D88A CDA0D8          17      CALL    KEYBC_IFBREAK
000B30 D88D E5              11      PUSH    HL
000B31 D88E F5              11      PUSH    AF
000B32 D88F 2A90EF          16      LD  HL,(_KEYPS)
000B35 D892 2C               4      INC L
000B36 D893 7D               4      LD  A,L
000B37 D894 BC               4      CP  H
000B38 D895 2815            12      JR  Z,POP_AF_HL_SCF_RET
000B3A D897 3290EF          13      LD  (_KEYPS),A
000B3D D89A 26FE             7      LD  H,KEYBF/256
000B3F D89C F1              10      POP AF
000B40 D89D 77               7      LD  (HL),A
000B41 D89E E1              10      POP HL
000B42 D89F C9              10      RET
       D8A0                     KEYBC_IFBREAK:
000B43 D8A0 FE03             7      CP  3
000B45 D8A2 C0              11      RET NZ
       D8A3                     KEYBC:
000B46 D8A3 E5              11      PUSH    HL
000B47 D8A4 210000          10      LD  HL,0
000B4A D8A7 2290EF          16      LD  (_KEYPS),HL
000B4D D8AA E1              10      POP HL
000B4E D8AB C9              10      RET
                                
       D8AC                     POP_AF_HL_SCF_RET:
000B4F D8AC F1              10      POP AF
000B50 D8AD E1              10      POP HL
000B51 D8AE 37               4      SCF
000B52 D8AF C9              10      RET
                                
       D8B0                     _SYS01:     ;(BDOS)コンソール入力
000B53 D8B0 CD09EF          17      CALL    _SYS07
       D8B3                     MSG_A:
000B56 D8B3 F5              11      PUSH    AF
000B57 D8B4 D5              11      PUSH    DE
000B58 D8B5 5F               4      LD  E,A
000B59 D8B6 CDBCD8          17      CALL    _SYS02
000B5C D8B9 D1              10      POP DE
000B5D D8BA F1              10      POP AF
000B5E D8BB C9              10      RET
                                
       D8BC                     _SYS02:     ;(BDOS)コンソール出力
000B5F D8BC CDCED8          17      CALL    BREAK
000B62 D8BF 1805            12      JR  PRINTX
                                
       D8C1                     _SYS06:     ;(BDOS)コンソール直接入出力
000B64 D8C1 7B               4      LD  A,E
000B65 D8C2 3C               4      INC A
000B66 D8C3 CACAEF          10      JP  Z,_INKEY
       D8C6                     PRINTX:
000B69 D8C6 C3CDEF          10      JP  _PRINT
                                
       D8C9                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000B6C D8C9 CD09EF          17      CALL    _SYS07
000B6F D8CC 1804            12      JR  BREAK1
       D8CE                     BREAK:
000B71 D8CE FB               4      EI
000B72 D8CF 3A92EF          13      LD  A,(_KEYD)
       D8D2                     BREAK1:
000B75 D8D2 FE03             7      CP  3       ;CTRL+C
000B77 D8D4 CA00EF          10      JP  Z,CPM_BOOT
000B7A D8D7 FE13             7      CP  013H        ;CTRL+S
000B7C D8D9 C0              11      RET NZ
                                
       D8DA                     PAUSE:
000B7D D8DA CDA3D8          17      CALL    KEYBC
                                
       D8DD                     FLGET:
000B80 D8DD CDDFEF          17      CALL    _FFLUSH
000B83 D8E0 E5              11      PUSH    HL
000B84 D8E1 2A8EEF          16      LD  HL,(_TXADR)
000B87 D8E4 7C               4      LD  A,H
000B88 D8E5 C6D0             7      ADD A,0D0H
000B8A D8E7 67               4      LD  H,A
000B8B D8E8 CD37CF          17      CALL    RDMMIO
000B8E D8EB 3200D9          13      LD  (FLSMC),A
       D8EE                     FLGET1:
000B91 D8EE CD2DCF          17      CALL    RD556VSYNC
000B94 D8F1 CB77             8      BIT 6,A
000B96 D8F3 3EEF             7      LD  A,0EFH      ;カーソル
000B98 D8F5 200A            12      JR  NZ,FLGET2
000B9A D8F7 3A92EF          13      LD  A,(_KEYD)
000B9D D8FA B7               4      OR  A
000B9E D8FB 3EEF             7      LD  A,0EFH      ;カーソル
000BA0 D8FD 2002            12      JR  NZ,FLGET2
       D900                     FLSMC   EQU $+1
000BA2 D8FF 3E00             7      LD  A,0     ;自己書き換え
       D901                     FLGET2:
000BA4 D901 CD3FCF          17      CALL    WRMMIO
000BA7 D904 CDCAEF          17      CALL    _INKEY
000BAA D907 28E5            12      JR  Z,FLGET1
000BAC D909 F5              11      PUSH    AF
000BAD D90A 3A00D9          13      LD  A,(FLSMC)
000BB0 D90D CD3FCF          17      CALL    WRMMIO
000BB3 D910 F1              10      POP AF
000BB4 D911 E1              10      POP HL
000BB5 D912 C9              10      RET
                                
       D913                     _SYS0A:     ;(BDOS)文字列入力
000BB6 D913 C5              11      PUSH    BC
000BB7 D914 E5              11      PUSH    HL
000BB8 D915 D5              11      PUSH    DE
000BB9 D916 CDA8DB          17      CALL    GETL
000BBC D919 1100FF          10      LD  DE,KBUF
000BBF D91C E1              10      POP HL
000BC0 D91D E5              11      PUSH    HL
000BC1 D91E 0E00             7      LD  C,0
000BC3 D920 3004            12      JR  NC,SAX0
000BC5 D922 23               6      INC HL
000BC6 D923 23               6      INC HL
000BC7 D924 1808            12      JR  SAX4
       D926                     SAX0:
000BC9 D926 46               7      LD  B,(HL)
000BCA D927 23               6      INC HL
       D928                     SAX1:
000BCB D928 23               6      INC HL
000BCC D929 1A               7      LD  A,(DE)
000BCD D92A 13               6      INC DE
000BCE D92B B7               4      OR  A
000BCF D92C 2004            12      JR  NZ,SAX2
       D92E                     SAX4:
000BD1 D92E 360D            10      LD  (HL),00DH
000BD3 D930 1804            12      JR  SAX3
       D932                     SAX2:
000BD5 D932 77               7      LD  (HL),A
000BD6 D933 0C               4      INC C
000BD7 D934 10F2            13      DJNZ    SAX1
       D936                     SAX3:
000BD9 D936 D1              10      POP DE
000BDA D937 79               4      LD  A,C
000BDB D938 13               6      INC DE
000BDC D939 12               7      LD  (DE),A
000BDD D93A 1B               6      DEC DE
000BDE D93B E1              10      POP HL
000BDF D93C C1              10      POP BC
000BE0 D93D A7               4      AND A
000BE1 D93E C9              10      RET
                                
       D93F                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000BE2 D93F CDCED8          17      CALL    BREAK
000BE5 D942 3A92EF          13      LD  A,(_KEYD)
000BE8 D945 B7               4      OR  A
000BE9 D946 C8              11      RET Z
       D947                     CONSTX:
000BEA D947 CDDFEF          17      CALL    _FFLUSH
000BED D94A E5              11      PUSH    HL
000BEE D94B 2A90EF          16      LD  HL,(_KEYPS)
000BF1 D94E 7C               4      LD  A,H
000BF2 D94F AD               4      XOR L
000BF3 D950 E1              10      POP HL
000BF4 D951 C6FF             7      ADD A,0FFH
000BF6 D953 9F               4      SBC A,A
000BF7 D954 C9              10      RET
                                
       D955                     _SYS2A:     ;(BDOS)日付の獲得
000BF8 D955 AF               4      XOR A
000BF9 D956 57               4      LD  D,A
000BFA D957 5F               4      LD  E,A
000BFB D958 67               4      LD  H,A
000BFC D959 6F               4      LD  L,A
000BFD D95A C9              10      RET
                                
       D95B                     _SYS2C:     ;(BDOS)時刻の獲得
000BFE D95B AF               4      XOR A
000BFF D95C 57               4      LD  D,A
000C00 D95D 5F               4      LD  E,A
000C01 D95E 67               4      LD  H,A
000C02 D95F 6F               4      LD  L,A
000C03 D960 C9              10      RET
                                
       D961                     ESC1:
000C04 D961 7B               4      LD  A,E
000C05 D962 FE41             7      CP  'A'
000C07 D964 CA59DA          10      JP  Z,CTRL1E
000C0A D967 FE42             7      CP  'B'
000C0C D969 CA6BDB          10      JP  Z,CTRL1F
000C0F D96C FE43             7      CP  'C'
000C11 D96E CA2CDA          10      JP  Z,CTRL1C
000C14 D971 FE44             7      CP  'D'
000C16 D973 CA50DA          10      JP  Z,CTRL1D
000C19 D976 FE45             7      CP  'E'
000C1B D978 2802            12      JR  Z,CT0CX
000C1D D97A FE6A             7      CP  'j'
       D97C                     CT0CX:
000C1F D97C CA50DB          10      JP  Z,CTRL0C
000C22 D97F FE48             7      CP  'H'
000C24 D981 CACDDA          10      JP  Z,CTRL0B
000C27 D984 FE4A             7      CP  'J'
000C29 D986 CA53DB          10      JP  Z,CTRL06
000C2C D989 FE4B             7      CP  'K'
000C2E D98B CA9FDA          10      JP  Z,CTRL05
000C31 D98E FE4C             7      CP  'L'
000C33 D990 CA7DDB          10      JP  Z,CTRL0E
000C36 D993 FE54             7      CP  'T'
000C38 D995 CA9FDA          10      JP  Z,CTRL05
000C3B D998 FE78             7      CP  'x'
000C3D D99A 2804            12      JR  Z,ESC1X
000C3F D99C FE79             7      CP  'y'
000C41 D99E 2002            12      JR  NZ,ESC1Y
       D9A0                     ESC1X:
000C43 D9A0 3601            10      LD  (HL),1
       D9A2                     ESC1Y:
000C45 D9A2 FE3D             7      CP  '='
000C47 D9A4 2804            12      JR  Z,ESC1W
000C49 D9A6 FE59             7      CP  'Y'
000C4B D9A8 2002            12      JR  NZ,ESC1Z
       D9AA                     ESC1W:
000C4D D9AA 3602            10      LD  (HL),2
       D9AC                     ESC1Z:
000C4F D9AC FE20             7      CP  020H
000C51 D9AE 3802            12      JR  C,ESC1C
000C53 D9B0 87               4      ADD A,A
000C54 D9B1 D0              11      RET NC
       D9B2                     ESC1C:
000C55 D9B2 E1              10      POP HL
000C56 D9B3 1832            12      JR  ANK
                                
       D9B5                     ESC:
000C58 D9B5 2118DA          10      LD  HL,PRINTE5
000C5B D9B8 E5              11      PUSH    HL
000C5C D9B9 21DBD9          10      LD  HL,ESCFLG
000C5F D9BC 3600            10      LD  (HL),0
000C61 D9BE 3D               4      DEC A
000C62 D9BF 28A0            12      JR  Z,ESC1
000C64 D9C1 3D               4      DEC A
000C65 D9C2 2009            12      JR  NZ,ESC2
000C67 D9C4 3603            10      LD  (HL),3
000C69 D9C6 7B               4      LD  A,E
000C6A D9C7 D620             7      SUB 020H
000C6C D9C9 32D0D9          13      LD  (ESCYP+1),A
000C6F D9CC C9              10      RET
       D9CD                     ESC2:
000C70 D9CD 3D               4      DEC A
000C71 D9CE C0              11      RET NZ
000C72 D9CF 2600             7  ESCYP:  LD  H,0
000C74 D9D1 7B               4      LD  A,E
000C75 D9D2 D620             7      SUB 020H
000C77 D9D4 6F               4      LD  L,A
000C78 D9D5 C3D6EF          10      JP  _LOC
                                
       D9D8                     PRINT:
000C7B D9D8 C5              11      PUSH    BC
000C7C D9D9 E5              11      PUSH    HL
       D9DB                     ESCFLG  EQU $+1
000C7D D9DA 3E00             7      LD  A,000H      ;自己書き換え
000C7F D9DC B7               4      OR  A
000C80 D9DD 20D6            12      JR  NZ,ESC
                                
000C82 D9DF 3E1F             7      LD  A,01FH
000C84 D9E1 BB               4      CP  E
000C85 D9E2 3038            12      JR  NC,CTRL
       D9E4                     INSFLG  EQU $
000C87 D9E4 0125DB          10      LD  BC,INSERT   ;自己書き換え
       D9E7                     ANK:
000C8A D9E7 3A96EF          13      LD  A,(_COLORF)
000C8D D9EA 4F               4      LD  C,A
000C8E D9EB 7B               4      LD  A,E
000C8F D9EC FE61             7      CP  'a'     ;英小文字
000C91 D9EE 3806            12      JR  C,PRT1
000C93 D9F0 FE7B             7      CP  'z'+1
000C95 D9F2 3002            12      JR  NC,PRT1
000C97 D9F4 CBF9             8      SET 7,C
       D9F6                     PRT1:
000C99 D9F6 FE86             7      CP  $86     ;ひらがな1(を－そ)
000C9B D9F8 3806            12      JR  C,PRT2
000C9D D9FA FEA0             7      CP  $A0
000C9F D9FC 3002            12      JR  NC,PRT2
000CA1 D9FE CBF9             8      SET 7,C
       DA00                     PRT2:
000CA3 DA00 FEE0             7      CP  $E0     ;ひらがな2(たーん)
000CA5 DA02 3802            12      JR  C,PRT3
000CA7 DA04 CBF9             8      SET 7,C
       DA06                     PRT3:
000CA9 DA06 2A8EEF          16      LD  HL,(_TXADR)
000CAC DA09 7C               4      LD  A,H
000CAD DA0A C6D0             7      ADD A,0D0H
000CAF DA0C 67               4      LD  H,A
000CB0 DA0D 42               4      LD  B,D
000CB1 DA0E 16ED             7      LD  D,CD_TABLE/256
000CB3 DA10 1A               7      LD  A,(DE)
000CB4 DA11 50               4      LD  D,B
000CB5 DA12 CD57CF          17      CALL    IO_PRINT
000CB8 DA15 CD2CDA          17      CALL    CTRL1C
       DA18                     PRINTE5:
000CBB DA18 E1              10      POP HL
000CBC DA19 C1              10      POP BC
000CBD DA1A AF               4      XOR A
000CBE DA1B C9              10      RET
                                
       DA1C                     CTRL:
000CBF DA1C 7B               4      LD  A,E
000CC0 DA1D 87               4      ADD A,A
000CC1 DA1E F680             7      OR  080H
000CC3 DA20 6F               4      LD  L,A
000CC4 DA21 26F0             7      LD  H,CTRLTB/256
000CC6 DA23 7E               7      LD  A,(HL)
000CC7 DA24 2C               4      INC L
000CC8 DA25 66               7      LD  H,(HL)
000CC9 DA26 6F               4      LD  L,A
000CCA DA27 CD0F00          17      CALL    JP_HL
000CCD DA2A 18EC            12      JR  PRINTE5
                                
       DA2C                     CTRL1C:
000CCF DA2C ED4B8EEF        20      LD  BC,(_TXADR)
000CD3 DA30 03               6      INC BC
       DA31                     PRINTE3:
000CD4 DA31 2118FC          10      LD  HL,0-WIDTH*LINE
000CD7 DA34 A7               4      AND A
000CD8 DA35 ED4A            15      ADC HL,BC
       DA37                     PRINTE8:
000CDA DA37 2805            12      JR  Z,PRINT2
000CDC DA39 ED438EEF        20      LD  (_TXADR),BC
       DA3D                     CTRL00:
000CE0 DA3D C9              10      RET
                                
       DA3E                     PRINT2:
000CE1 DA3E CD83DB          17      CALL    SCR
000CE4 DA41 21D8FF          10      LD  HL,0-WIDTH
000CE7 DA44 09              11      ADD HL,BC
       DA45                     SET_TXADR_HL:
000CE8 DA45 228EEF          16      LD  (_TXADR),HL
000CEB DA48 C9              10      RET
                                
       DA49                     CTRL08:
000CEC DA49 3AE4D9          13      LD  A,(INSFLG)
000CEF DA4C FECD             7      CP  0CDH        ;CALL ????
000CF1 DA4E 2823            12      JR  Z,CTRL02
       DA50                     CTRL1D:
000CF3 DA50 2A8EEF          16      LD  HL,(_TXADR)
000CF6 DA53 7C               4      LD  A,H
000CF7 DA54 B5               4      OR  L
000CF8 DA55 C8              11      RET Z
000CF9 DA56 2B               6      DEC HL
000CFA DA57 18EC            12      JR  SET_TXADR_HL
                                
       DA59                     CTRL1E:
000CFC DA59 ED4B8EEF        20      LD  BC,(_TXADR)
000D00 DA5D 21D8FF          10      LD  HL,0-WIDTH
000D03 DA60 09              11      ADD HL,BC
000D04 DA61 D0              11      RET NC
000D05 DA62 18E1            12      JR  SET_TXADR_HL
                                
       DA64                     CTRL09:
000D07 DA64 ED4B8EEF        20      LD  BC,(_TXADR)
000D0B DA68 79               4      LD  A,C
000D0C DA69 E6F8             7      AND 0F8H
000D0E DA6B C608             7      ADD A,8
000D10 DA6D 4F               4      LD  C,A
000D11 DA6E 88               4      ADC A,B
000D12 DA6F 91               4      SUB C
000D13 DA70 47               4      LD  B,A
000D14 DA71 18BE            12      JR  PRINTE3
                                
       DA73                     CTRL02:
000D16 DA73 CD50DA          17      CALL    CTRL1D
000D19 DA76 C8              11      RET Z
000D1A DA77 D5              11      PUSH    DE
000D1B DA78 CDD3EF          17      CALL    _POS
000D1E DA7B 54               4      LD  D,H
000D1F DA7C 3E28             7      LD  A,WIDTH
000D21 DA7E 95               4      SUB L
000D22 DA7F 4F               4      LD  C,A
000D23 DA80 0D               4      DEC C
000D24 DA81 06D0             7      LD  B,0D0H
000D26 DA83 2A8EEF          16      LD  HL,(_TXADR)
000D29 DA86 09              11      ADD HL,BC
000D2A DA87 47               4      LD  B,A
                                
000D2B DA88 3A41DB          13      LD  A,(MULINE)
000D2E DA8B BA               4      CP  D
000D2F DA8C 2007            12      JR  NZ,C02X1
000D31 DA8E 112800          10      LD  DE,WIDTH
000D34 DA91 19              11      ADD HL,DE
000D35 DA92 78               4      LD  A,B
000D36 DA93 83               4      ADD A,E
000D37 DA94 47               4      LD  B,A
       DA95                     C02X1:
000D38 DA95 3A96EF          13      LD  A,(_COLORF) ;C:Color
000D3B DA98 4F               4      LD  C,A
000D3C DA99 AF               4      XOR A       ;A:Text
000D3D DA9A CD9ECF          17      CALL    IO_BS
000D40 DA9D D1              10      POP DE
000D41 DA9E C9              10      RET
                                
       DA9F                     CTRL05:
000D42 DA9F CDD3EF          17      CALL    _POS
000D45 DAA2 3E28             7      LD  A,WIDTH
000D47 DAA4 95               4      SUB L
000D48 DAA5 47               4      LD  B,A
       DAA6                     C08X1:
000D49 DAA6 2A8EEF          16      LD  HL,(_TXADR)
000D4C DAA9 7C               4      LD  A,H
000D4D DAAA C6D0             7      ADD A,0D0H
000D4F DAAC 67               4      LD  H,A
       DAAD                     CLLINE:
000D50 DAAD 3A96EF          13      LD  A,(_COLORF)
000D53 DAB0 4F               4      LD  C,A
000D54 DAB1 AF               4      XOR A
000D55 DAB2 C381CF          10      JP  IO_CLLINE
                                
       DAB5                     CTRL0D:
000D58 DAB5 CDD3EF          17      CALL    _POS
000D5B DAB8 2E00             7      LD  L,0
       DABA                     LOC:
000D5D DABA C5              11      PUSH    BC
000D5E DABB E5              11      PUSH    HL
000D5F DABC CDDADA          17      CALL    LOC1
000D62 DABF 228EEF          16      LD  (_TXADR),HL
000D65 DAC2 E1              10      POP HL
000D66 DAC3 C1              10      POP BC
000D67 DAC4 C9              10      RET
                                
       DAC5                     CTRL12:
000D68 DAC5 21E4D9          10      LD  HL,INSFLG
000D6B DAC8 7E               7      LD  A,(HL)
000D6C DAC9 EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
000D6E DACB 77               7      LD  (HL),A
000D6F DACC C9              10      RET
                                
       DACD                     CTRL0B:
000D70 DACD 210000          10      LD  HL,0
000D73 DAD0 228EEF          16      LD  (_TXADR),HL
000D76 DAD3 C9              10      RET
                                
       DAD4                     CTRL1B:
000D77 DAD4 3E01             7      LD  A,1
000D79 DAD6 32DBD9          13      LD  (ESCFLG),A
000D7C DAD9 C9              10      RET
                                
       DADA                     LOC1:
000D7D DADA D5              11      PUSH    DE
000D7E DADB 4D               4      LD  C,L
000D7F DADC 0608             7      LD  B,8
000D81 DADE 5C               4      LD  E,H
000D82 DADF 210028          10      LD  HL,WIDTH*256
000D85 DAE2 55               4      LD  D,L ;L=0
       DAE3                     LOC2:
000D86 DAE3 29              11      ADD HL,HL
000D87 DAE4 3001            12      JR  NC,LOC3
000D89 DAE6 19              11      ADD HL,DE
       DAE7                     LOC3:
000D8A DAE7 10FA            13      DJNZ    LOC2
000D8C DAE9 09              11      ADD HL,BC
000D8D DAEA D1              10      POP DE
000D8E DAEB C9              10      RET
                                
       DAEC                     CONOUT1:
                                ;   CALL    CURSOR
000D8F DAEC 59               4      LD  E,C
000D90 DAED CDCDEF          17      CALL    _PRINT
000D93 DAF0 7B               4      LD  A,E
000D94 DAF1 FE0A             7      CP  00AH
000D96 DAF3 2006            12      JR  NZ,CURSOR
000D98 DAF5 CDB5DA          17      CALL    CTRL0D
000D9B DAF8 CD9FDA          17      CALL    CTRL05
       DAFB                     CURSOR:
000D9E DAFB C9              10      RET
                                
       DAFC                     CTRL07:
000D9F DAFC 06E0             7      LD  B,0E0H
000DA1 DAFE 2162EF          10      LD  HL,BEEPD+1
       DB01                     C07X0:
000DA4 DB01 4E               7      LD  C,(HL)
000DA5 DB02 23               6      INC HL
000DA6 DB03 7E               7      LD  A,(HL)
000DA7 DB04 23               6      INC HL
000DA8 DB05 CD4FCF          17      CALL    WRMMIO_BC
000DAB DB08 7D               4      LD  A,L
000DAC DB09 FE6A             7      CP  (BEEPD+1+M7BEEPE-M7BEEPD)&255
000DAE DB0B 20F4            12      JR  NZ,C07X0
000DB0 DB0D 0610             7      LD  B,16
       DB0F                     C07X1:
000DB2 DB0F CD2DCF          17      CALL    RD556VSYNC
000DB5 DB12 87               4      ADD A,A
000DB6 DB13 30FA            12      JR  NC,C07X1
       DB15                     C07X2:
000DB8 DB15 CD2DCF          17      CALL    RD556VSYNC
000DBB DB18 87               4      ADD A,A
000DBC DB19 38FA            12      JR  C,C07X2
000DBE DB1B 10F2            13      DJNZ    C07X1
                                
000DC0 DB1D AF               4      XOR A
000DC1 DB1E 2108E0          10      LD  HL,0E008H
000DC4 DB21 CD3FCF          17      CALL    WRMMIO
000DC7 DB24 C9              10      RET
                                
       DB25                     INSERT:
000DC8 DB25 D5              11      PUSH    DE
000DC9 DB26 CDD3EF          17      CALL    _POS
000DCC DB29 54               4      LD  D,H
000DCD DB2A 3E28             7      LD  A,WIDTH
000DCF DB2C 95               4      SUB L
000DD0 DB2D 47               4      LD  B,A
000DD1 DB2E 2A8EEF          16      LD  HL,(_TXADR)
000DD4 DB31 7C               4      LD  A,H
000DD5 DB32 C6D0             7      ADD A,0D0H
000DD7 DB34 67               4      LD  H,A
000DD8 DB35 3A96EF          13      LD  A,(_COLORF) ;C:Color
000DDB DB38 4F               4      LD  C,A
000DDC DB39 AF               4      XOR A       ;A:Text
000DDD DB3A CD91CF          17      CALL    IO_INS
000DE0 DB3D B7               4      OR  A
000DE1 DB3E 2005            12      JR  NZ,INS1
       DB41                     MULINE  EQU $+1
000DE3 DB40 3EFF             7      LD  A,-1
000DE5 DB42 92               4      SUB D
000DE6 DB43 2009            12      JR  NZ,INS2
       DB45                     INS1:
000DE8 DB45 0628             7      LD  B,WIDTH
000DEA DB47 CD91CF          17      CALL    IO_INS
000DED DB4A 7A               4      LD  A,D
000DEE DB4B 3241DB          13      LD  (MULINE),A
       DB4E                     INS2:
000DF1 DB4E D1              10      POP DE
000DF2 DB4F C9              10      RET
                                
       DB50                     CTRL0C:
000DF3 DB50 CDCDDA          17      CALL    CTRL0B
       DB53                     CTRL06:
000DF6 DB53 D5              11      PUSH    DE
000DF7 DB54 E5              11      PUSH    HL
000DF8 DB55 ED5B8EEF        20      LD  DE,(_TXADR)
000DFC DB59 3A96EF          13      LD  A,(_COLORF)
000DFF DB5C 326ECF          13      LD  (ICSMC),A
000E02 DB5F C362CF          10      JP  IO_CLR
                                
       DB62                     CTRL04:
000E05 DB62 CDD3EF          17      CALL    _POS
000E08 DB65 7D               4      LD  A,L
000E09 DB66 B7               4      OR  A
000E0A DB67 C8              11      RET Z
       DB68                     CTRL03:
000E0B DB68 CDB5DA          17      CALL    CTRL0D
       DB6B                     CTRL0A:
       DB6B                     CTRL1F:
000E0E DB6B 2A8EEF          16      LD  HL,(_TXADR)
000E11 DB6E 012800          10      LD  BC,WIDTH
000E14 DB71 09              11      ADD HL,BC
000E15 DB72 44               4      LD  B,H
000E16 DB73 4D               4      LD  C,L
000E17 DB74 2118FC          10      LD  HL,0-WIDTH*LINE
000E1A DB77 09              11      ADD HL,BC
000E1B DB78 3F               4      CCF
000E1C DB79 9F               4      SBC A,A
000E1D DB7A C337DA          10      JP  PRINTE8
                                
       DB7D                     CTRL0E:
000E20 DB7D CDD3EF          17      CALL    _POS
000E23 DB80 7C               4      LD  A,H
000E24 DB81 1804            12      JR  SCR1
       DB83                     SCR:
000E26 DB83 3A97EF          13      LD  A,(_LINE)
000E29 DB86 3D               4      DEC A
       DB87                     SCR1:
000E2A DB87 C5              11      PUSH    BC
000E2B DB88 D5              11      PUSH    DE
000E2C DB89 E5              11      PUSH    HL
000E2D DB8A 1100D0          10      LD  DE,0D000H
000E30 DB8D 2128D0          10      LD  HL,0D000H+WIDTH
                                
000E33 DB90 47               4      LD  B,A
000E34 DB91 B7               4      OR  A
000E35 DB92 C3B6CF          10      JP  IO_SCRUP
                                
       DB95                     POS:
000E38 DB95 2A8EEF          16      LD  HL,(_TXADR)
000E3B DB98 C5              11      PUSH    BC
000E3C DB99 01D8FF          10      LD  BC,0-WIDTH
000E3F DB9C AF               4      XOR A
       DB9D                     POS1:
000E40 DB9D 09              11      ADD HL,BC
000E41 DB9E 3C               4      INC A
000E42 DB9F 38FC            12      JR  C,POS1
000E44 DBA1 ED42            15      SBC HL,BC
000E46 DBA3 3D               4      DEC A
000E47 DBA4 67               4      LD  H,A
000E48 DBA5 C1              10      POP BC
000E49 DBA6 A7               4      AND A
000E4A DBA7 C9              10      RET
                                
       DBA8                     GETL:
000E4B DBA8 CDD3EF          17      CALL    _POS
000E4E DBAB E5              11      PUSH    HL
000E4F DBAC 3ECD             7      LD  A,0CDH      ;CALL ????
000E51 DBAE 32E4D9          13      LD  (INSFLG),A
       DBB1                     GETL1:
000E54 DBB1 CDC9D8          17      CALL    _SYS08
000E57 DBB4 FE09             7      CP  9
000E59 DBB6 2008            12      JR  NZ,GETL1V
000E5B DBB8 2100FF          10      LD  HL,KBUF
000E5E DBBB CDD9D5          17      CALL    MSX
000E61 DBBE 18F1            12      JR  GETL1
       DBC0                     GETL1V:
000E63 DBC0 5F               4      LD  E,A
000E64 DBC1 CDD3EF          17      CALL    _POS
000E67 DBC4 CDCDEF          17      CALL    _PRINT
000E6A DBC7 7B               4      LD  A,E
000E6B DBC8 FE20             7      CP  $20
000E6D DBCA 3809            12      JR  C,GETL1V1
000E6F DBCC 7D               4      LD  A,L
000E70 DBCD FE27             7      CP  WIDTH-1
000E72 DBCF 2004            12      JR  NZ,GETL1V1
000E74 DBD1 7C               4      LD  A,H
000E75 DBD2 3241DB          13      LD  (MULINE),A
       DBD5                     GETL1V1:
000E78 DBD5 7B               4      LD  A,E
000E79 DBD6 FE0D             7      CP  00DH
000E7B DBD8 20D7            12      JR  NZ,GETL1
000E7D DBDA 3E01             7      LD  A,1     ;LD BC,????
000E7F DBDC 32E4D9          13      LD  (INSFLG),A
000E82 DBDF 1100FF          10      LD  DE,KBUF
000E85 DBE2 0628             7      LD  B,WIDTH
000E87 DBE4 CDB9D3          17      CALL    ZERO_MEMORY_DE
                                
000E8A DBE7 D1              10      POP DE
000E8B DBE8 CDD3EF          17      CALL    _POS
000E8E DBEB 6B               4      LD  L,E
000E8F DBEC 3E28             7      LD  A,WIDTH
000E91 DBEE 95               4      SUB L
000E92 DBEF 57               4      LD  D,A
                                
000E93 DBF0 3A41DB          13      LD  A,(MULINE)
000E96 DBF3 94               4      SUB H
000E97 DBF4 2806            12      JR  Z,GL2X
000E99 DBF6 3C               4      INC A
000E9A DBF7 200C            12      JR  NZ,GL3X
000E9C DBF9 25               4      DEC H
000E9D DBFA 1805            12      JR  GL4X
       DBFC                     GL2X:
000E9F DBFC 3E1F             7      LD  A,$1F
000EA1 DBFE CDB3D8          17      CALL    MSG_A
       DC01                     GL4X:
000EA4 DC01 7A               4      LD  A,D
000EA5 DC02 C628             7      ADD A,WIDTH
000EA7 DC04 57               4      LD  D,A
       DC05                     GL3X:
000EA8 DC05 CDDADA          17      CALL    LOC1
000EAB DC08 4D               4      LD  C,L
000EAC DC09 7C               4      LD  A,H
000EAD DC0A C6D0             7      ADD A,0D0H
000EAF DC0C 47               4      LD  B,A
000EB0 DC0D 5A               4      LD  E,D
000EB1 DC0E 2100FF          10      LD  HL,KBUF
       DC11                     GETL2:
000EB4 DC11 CDD0EF          17      CALL    _SCRN
000EB7 DC14 03               6      INC BC
000EB8 DC15 77               7      LD  (HL),A
000EB9 DC16 23               6      INC HL
000EBA DC17 1D               4      DEC E
000EBB DC18 20F7            12      JR  NZ,GETL2
       DC1A                     GETL3:
000EBD DC1A 2B               6      DEC HL
000EBE DC1B 7E               7      LD  A,(HL)
000EBF DC1C FE21             7      CP  021H
000EC1 DC1E D0              11      RET NC
000EC2 DC1F 3600            10      LD  (HL),0
000EC4 DC21 15               4      DEC D
000EC5 DC22 20F6            12      JR  NZ,GETL3
000EC7 DC24 C9              10      RET
                                
       DC25                     INKEY:
000EC8 DC25 FB               4      EI
000EC9 DC26 E5              11      PUSH    HL
000ECA DC27 2A90EF          16      LD  HL,(_KEYPS)
000ECD DC2A 7C               4      LD  A,H
000ECE DC2B AD               4      XOR L
000ECF DC2C 2809            12      JR  Z,INKEY1
000ED1 DC2E 7C               4      LD  A,H
000ED2 DC2F 3C               4      INC A
000ED3 DC30 3291EF          13      LD  (_KEYPS+1),A
000ED6 DC33 6F               4      LD  L,A
000ED7 DC34 26FE             7      LD  H,KEYBF/256
000ED9 DC36 7E               7      LD  A,(HL)
       DC37                     INKEY1:
000EDA DC37 E1              10      POP HL
000EDB DC38 B7               4      OR  A
000EDC DC39 C9              10      RET
                                
       DC3A                     INKEYB:
000EDD DC3A C1              10      POP BC
000EDE DC3B CB47             8      BIT 0,A
000EE0 DC3D 3E08             7      LD  A,8
000EE2 DC3F 2002            12      JR  NZ,INKEYD
000EE4 DC41 3E03             7      LD  A,3
       DC43                     INKEYD:
000EE6 DC43 B7               4      OR  A
000EE7 DC44 3292EF          13      LD  (_KEYD),A
000EEA DC47 C9              10      RET
       DC48                     CHKEY:
000EEB DC48 C5              11      PUSH    BC
000EEC DC49 3E08             7      LD  A,8
000EEE DC4B CD20CF          17      CALL    RDKEYDATA
000EF1 DC4E 3293EF          13      LD  (_KEYD+1),A
000EF4 DC51 CB7F             8      BIT 7,A
000EF6 DC53 28E5            12      JR  Z,INKEYB
000EF8 DC55 E5              11      PUSH    HL
000EF9 DC56 0E07             7      LD  C,7
000EFB DC58 2140EC          10      LD  HL,KEY_TABLE
000EFE DC5B CB47             8      BIT 0,A
000F00 DC5D 2003            12      JR  NZ,CHKEY0
000F02 DC5F 2180EC          10      LD  HL,SHIFT_TABLE
       DC62                     CHKEY0:
000F05 DC62 CB77             8      BIT 6,A
000F07 DC64 2003            12      JR  NZ,CHKEY1
000F09 DC66 21C0EC          10      LD  HL,CTRL_TABLE
       DC69                     CHKEY1:
000F0C DC69 79               4      LD  A,C
000F0D DC6A CD20CF          17      CALL    RDKEYDATA
000F10 DC6D 0608             7      LD  B,8
       DC6F                     CHKEY2:
000F12 DC6F 87               4      ADD A,A
000F13 DC70 3009            12      JR  NC,CHKEY3
000F15 DC72 23               6      INC HL
000F16 DC73 10FA            13      DJNZ    CHKEY2
000F18 DC75 0D               4      DEC C
000F19 DC76 79               4      LD  A,C
000F1A DC77 3C               4      INC A
000F1B DC78 20EF            12      JR  NZ,CHKEY1
000F1D DC7A 06                      DB  $06     ;LD B,?? 次の1バイトを飛ばす
       DC7B                     CHKEY3:
000F1E DC7B 7E               7      LD  A,(HL)
000F1F DC7C E1              10      POP HL
000F20 DC7D C1              10      POP BC
000F21 DC7E 18C3            12      JR  INKEYD
                                
       DC80                     SCRN:
000F23 DC80 E5              11      PUSH    HL
000F24 DC81 CD47CF          17      CALL    RDMMIO_BC
000F27 DC84 6F               4      LD  L,A
000F28 DC85 26EE             7      LD  H,DC_TABLE/256
000F2A DC87 7E               7      LD  A,(HL)
000F2B DC88 FE41             7      CP  'A'     ;英小文字チェック
000F2D DC8A 380E            12      JR  C,SCRN1
000F2F DC8C FE5B             7      CP  'Z'+1
000F31 DC8E DC9CDC          17      CALL    C,SCRNC
000F34 DC91 FEA6             7      CP  $A6     ;ひらがなチェック
000F36 DC93 3805            12      JR  C,SCRN1
000F38 DC95 FEE0             7      CP  $E0
000F3A DC97 DC9CDC          17      CALL    C,SCRNC
       DC9A                     SCRN1:
000F3D DC9A E1              10      POP HL
000F3E DC9B C9              10      RET
                                
       DC9C                     SCRNC:
000F3F DC9C 6F               4      LD  L,A
000F40 DC9D 60               4      LD  H,B
000F41 DC9E CBD8             8      SET 3,B
000F43 DCA0 CD47CF          17      CALL    RDMMIO_BC
000F46 DCA3 44               4      LD  B,H
000F47 DCA4 CB7F             8      BIT 7,A
000F49 DCA6 7D               4      LD  A,L
000F4A DCA7 C8              11      RET Z
000F4B DCA8 FE5B             7      CP  'Z'+1
000F4D DCAA 3804            12      JR  C,SCRNC_ADD
000F4F DCAC FEC0             7      CP  $C0
000F51 DCAE 3803            12      JR  C,SCRNC_SUB
       DCB0                     SCRNC_ADD:
000F53 DCB0 C620             7      ADD A,$20
000F55 DCB2 C9              10      RET
       DCB3                     SCRNC_SUB:
000F56 DCB3 D620             7      SUB $20
000F58 DCB5 C9              10      RET
[EOF:M7IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
       DCB6                     FILEC:
000F59 DCB6 CDC1DC          17      CALL    FILE
       DCB9                     FILEC2:
000F5C DCB9 3A15EF          13      LD  A,(FDRV+1)
000F5F DCBC FE20             7      CP  020H
000F61 DCBE C8              11      RET Z
000F62 DCBF 1839            12      JR  SETDIR1
                                
       DCC1                     FILE:
000F64 DCC1 AF               4      XOR A
000F65 DCC2 3214EF          13      LD  (FDRV),A
000F68 DCC5 67               4      LD  H,A
000F69 DCC6 6F               4      LD  L,A
000F6A DCC7 2222EF          16      LD  (FDRV+14),HL
000F6D DCCA CD98DD          17      CALL    SPCUT
000F70 DCCD CD7DDD          17      CALL    CCHK3
000F73 DCD0 2812            12      JR  Z,DEVI1
000F75 DCD2 13               6      INC DE
000F76 DCD3 1A               7      LD  A,(DE)
000F77 DCD4 1B               6      DEC DE
000F78 DCD5 FE3A             7      CP  ':'
000F7A DCD7 200B            12      JR  NZ,DEVI1
000F7C DCD9 1A               7      LD  A,(DE)      ;DRIVE
000F7D DCDA CDCDDF          17      CALL    CAP
000F80 DCDD D640             7      SUB '@'
000F82 DCDF 13               6      INC DE
000F83 DCE0 13               6      INC DE
000F84 DCE1 3214EF          13      LD  (FDRV),A
       DCE4                     DEVI1:
000F87 DCE4 1A               7      LD  A,(DE)
000F88 DCE5 D65C             7      SUB 05CH        ;\
000F8A DCE7 2009            12      JR  NZ,NOROOT
000F8C DCE9 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
000F8D DCEA 222EEF          16      LD  (FDRV+26),HL
000F90 DCED 2C               4      INC L
000F91 DCEE 2222EF          16      LD  (FDRV+14),HL
000F94 DCF1 13               6      INC DE
       DCF2                     NOROOT:
                                
       DCF2                     SETDIR:
000F95 DCF2 CD1EDD          17      CALL    FILED
000F98 DCF5 1A               7      LD  A,(DE)
000F99 DCF6 FE5C             7      CP  05CH        ;\
000F9B DCF8 C0              11      RET NZ
000F9C DCF9 13               6      INC DE
       DCFA                     SETDIR1:
000F9D DCFA 3E10             7      LD  A,010H      ;Directory
000F9F DCFC 3221EF          13      LD  (FDRV+13),A
000FA2 DCFF D5              11      PUSH    DE
000FA3 DD00 1114EF          10      LD  DE,FDRV
000FA6 DD03 2A1EF0          16      LD  HL,(STABLE+2*00FH)
000FA9 DD06 CD0F00          17      CALL    JP_HL
000FAC DD09 D1              10      POP DE
000FAD DD0A B7               4      OR  A
000FAE DD0B C0              11      RET NZ
                                
000FAF DD0C 3A21EF          13      LD  A,(FDRV+13)
000FB2 DD0F CB67             8      BIT 4,A
000FB4 DD11 C8              11      RET Z
                                
000FB5 DD12 CD65DD          17      CALL    FILEI
000FB8 DD15 2A2EEF          16      LD  HL,(FDRV+26)
000FBB DD18 23               6      INC HL
000FBC DD19 2222EF          16      LD  (FDRV+14),HL
000FBF DD1C 18D4            12      JR  SETDIR
                                
       DD1E                     FILED:
000FC1 DD1E CD65DD          17      CALL    FILEI
000FC4 DD21 2115EF          10      LD  HL,FNAME
                                
000FC7 DD24 0608             7      LD  B,8
       DD26                     FILE2:
000FC9 DD26 CD72DD          17      CALL    CCHKF
000FCC DD29 C8              11      RET Z
000FCD DD2A FE2A             7      CP  '*'
000FCF DD2C 282E            12      JR  Z,FILE9
000FD1 DD2E FE2E             7      CP  '.'
000FD3 DD30 280C            12      JR  Z,FILE4
000FD5 DD32 77               7      LD  (HL),A
000FD6 DD33 23               6      INC HL
000FD7 DD34 10F0            13      DJNZ    FILE2
                                
       DD36                     FILE3:
000FD9 DD36 CD72DD          17      CALL    CCHKF
000FDC DD39 C8              11      RET Z
000FDD DD3A FE2E             7      CP  '.'
000FDF DD3C 20F8            12      JR  NZ,FILE3
                                
       DD3E                     FILE4:
000FE1 DD3E 211DEF          10      LD  HL,FNAME+8
000FE4 DD41 0603             7      LD  B,3
                                
       DD43                     FILE4L:
000FE6 DD43 CD72DD          17      CALL    CCHKF
000FE9 DD46 C8              11      RET Z
000FEA DD47 FE2E             7      CP  '.'
000FEC DD49 2008            12      JR  NZ,FILE12
000FEE DD4B 3215EF          13      LD  (FNAME),A   ;Parent directory(..)
000FF1 DD4E 3216EF          13      LD  (FNAME+1),A
000FF4 DD51 3E20             7      LD  A,020H
       DD53                     FILE12:
000FF6 DD53 FE2A             7      CP  '*'
000FF8 DD55 280A            12      JR  Z,FILE10
000FFA DD57 77               7      LD  (HL),A
000FFB DD58 23               6      INC HL
000FFC DD59 10E8            13      DJNZ    FILE4L
000FFE DD5B C9              10      RET
                                
       DD5C                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000FFF DD5C CD61DD          17      CALL    FILE10
001002 DD5F 18D5            12      JR  FILE3
                                
       DD61                     FILE10:
001004 DD61 3E3F             7      LD  A,'?'
001006 DD63 1808            12      JR  FILL_MEMORY
       DD65                     FILEI:              ;名前＋拡張子をスペースで初期化
001008 DD65 3E20             7      LD  A,020H
00100A DD67 01000B          10      LD  BC,11*256   ;C=0にしておく
00100D DD6A 2115EF          10      LD  HL,FNAME
       DD6D                     FILL_MEMORY:            ;HLからBバイトAで埋める
001010 DD6D 77               7      LD  (HL),A
001011 DD6E 23               6      INC HL
001012 DD6F 10FC            13      DJNZ    FILL_MEMORY
001014 DD71 C9              10      RET
                                
       DD72                     CCHKF:
001015 DD72 1A               7      LD  A,(DE)
001016 DD73 CD7ADD          17      CALL    CCHK2
001019 DD76 C8              11      RET Z
00101A DD77 C3E5E0          10      JP  FKAN
                                
       DD7A                     CCHK2:
00101D DD7A 0C               4      INC C
00101E DD7B 0D               4      DEC C
00101F DD7C C0              11      RET NZ
       DD7D                     CCHK3:              ;ZF=1 で使えない文字
001020 DD7D FE2B             7      CP  '+'
001022 DD7F C8              11      RET Z
001023 DD80 FE2C             7      CP  ','
001025 DD82 C8              11      RET Z
001026 DD83 FE2F             7      CP  '/'
001028 DD85 C8              11      RET Z
001029 DD86 FE3A             7      CP  ':'
00102B DD88 C8              11      RET Z
00102C DD89 FE3B             7      CP  ';'
00102E DD8B C8              11      RET Z
00102F DD8C FE3D             7      CP  '='
001031 DD8E C8              11      RET Z
001032 DD8F FE5C             7      CP  05CH    ;\
001034 DD91 C8              11      RET Z
001035 DD92 FE20             7      CP  020H
001037 DD94 D0              11      RET NC
001038 DD95 BF               4      CP  A       ;Z=1
001039 DD96 C9              10      RET
                                
       DD97                     SS1:
00103A DD97 13               6      INC DE
       DD98                     SPCUT:              ;スペースをカット
00103B DD98 1A               7      LD  A,(DE)
00103C DD99 FE20             7      CP  020H
00103E DD9B 28FA            12      JR  Z,SS1
001040 DD9D C9              10      RET
                                
       DD9E                     SETDRVF:
001041 DD9E 1114EF          10      LD  DE,FDRV
       DDA1                     SETDRV0:
001044 DDA1 CDAADD          17      CALL    SETDRV
001047 DDA4 FDE1            14      POP IY
001049 DDA6 C1              10      POP BC
00104A DDA7 D1              10      POP DE
00104B DDA8 E1              10      POP HL
00104C DDA9 C9              10      RET
                                
       DDAA                     SETDRV:
00104D DDAA E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
00104E DDAB D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
00104F DDAC C5              11      PUSH    BC
001050 DDAD 1A               7      LD  A,(DE)
001051 DDAE D5              11      PUSH    DE
001052 DDAF FDE3            23      EX  (SP),IY
                                
001054 DDB1 CDBDDD          17      CALL    GETDRV
001057 DDB4 3C               4      INC A
001058 DDB5 FD7700          19      LD  (IY+0),A    ;(FCB)ドライブ番号
00105B DDB8 3D               4      DEC A
00105C DDB9 CDD9EF          17      CALL    _CHGDRV
                                
00105F DDBC E9               4      JP  (HL)
                                
       DDBD                     GETDRV:
001060 DDBD E67F             7      AND 07FH
001062 DDBF D601             7      SUB 001H
001064 DDC1 3003            12      JR  NC,GETDRV1
001066 DDC3 3A87EF          13      LD  A,(_DVSW)   ;Current Drive
       DDC6                     GETDRV1:
001069 DDC6 3288EF          13      LD  (_DRV),A
00106C DDC9 C9              10      RET
                                
       DDCA                     SOPENX:
00106D DDCA 1139EF          10      LD  DE,SFILE
001070 DDCD 1A               7      LD  A,(DE)
001071 DDCE FDBE00           7      CP  (IY+0)      ;(FCB)ドライブ番号
001074 DDD1 2024            12      JR  NZ,SOPEN
001076 DDD3 13               6      INC DE
001077 DDD4 FDE5            15      PUSH    IY
001079 DDD6 E1              10      POP HL
00107A DDD7 23               6      INC HL
00107B DDD8 CD65DF          17      CALL    CPFILE
00107E DDDB 201A            12      JR  NZ,SOPEN
                                
001080 DDDD 2AF4F0          16      LD  HL,(SCDIR)
001083 DDE0 FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
001086 DDE3 FD740F          19      LD  (IY+15),H
                                
001089 DDE6 2AF8F0          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
00108C DDE9 229FEF          16      LD  (_FILEN),HL
                                
00108F DDEC ED5BF6F0        20      LD  DE,(SFBPS)
001093 DDF0 2139EF          10      LD  HL,SFILE
001096 DDF3 36FF            10      LD  (HL),0FFH
001098 DDF5 23               6      INC HL
001099 DDF6 C9              10      RET
       DDF7                     SOPEN:
00109A DDF7 210DDF          10      LD  HL,FILESE
       DDFA                     SOPENC:
00109D DDFA 2233DE          16      LD  (OPENPAT+1),HL
                                
0010A0 DDFD CDE2EF          17      CALL    _RDFATX     ;Detect Media
0010A3 DE00 3856            12      JR  C,RDDERR
                                
0010A5 DE02 AF               4      XOR A
0010A6 DE03 329FEF          13      LD  (_FILEN),A
0010A9 DE06 CD12E0          17      CALL    LDDIRX1     ;A=0で呼び出す
0010AC DE09 2818            12      JR  Z,SDIRX1
                                
0010AE DE0B CDFEDE          17      CALL    READ_DIR    ;Sub Directory
0010B1 DE0E 3808            12      JR  C,SDIRX0
0010B3 DE10 2A7EF0          16      LD  HL,(_DTBUF)
0010B6 DE13 7E               7      LD  A,(HL)
0010B7 DE14 FE2E             7      CP  '.'
0010B9 DE16 280F            12      JR  Z,SOPEN1
       DE18                     SDIRX0:
0010BB DE18 AF               4      XOR A
0010BC DE19 32A0EF          13      LD  (_DIRF),A
0010BF DE1C FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
0010C3 DE20 FD770F          19      LD  (IY+15),A
       DE23                     SDIRX1:
0010C6 DE23 ED5BFCF0        20      LD  DE,(_DIRPS) ;Root Directory
       DE27                     SOPEN1:
0010CA DE27 0E20             7  SDECPAT:LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       DE29                     SOPEN1X:
0010CC DE29 CDFEDE          17      CALL    READ_DIR    ;FILE SEARCH
0010CF DE2C 382A            12      JR  C,RDDERR
0010D1 DE2E 2A7EF0          16      LD  HL,(_DTBUF)
       DE31                     SOPEN2:
0010D4 DE31 D5              11      PUSH    DE
0010D5 DE32 CD0DDF          17  OPENPAT:CALL    FILESE      ;(self-modifying code)
0010D8 DE35 D1              10      POP DE
0010D9 DE36 386E            12      JR  C,SOPENE
0010DB DE38 281B            12      JR  Z,SCF_FF_RET
       DE3A                     SOPEN3:
0010DD DE3A 3AA0EF          13      LD  A,(_DIRF)   ;ディレクトリか判別
0010E0 DE3D B7               4      OR  A
0010E1 DE3E 200C            12      JR  NZ,SOPEN5
0010E3 DE40 13               6      INC DE      ;ルートディレクトリ
0010E4 DE41 E5              11      PUSH    HL
0010E5 DE42 210C00          10  MD_PAT: LD  HL,12       ;(self-modifying code)MAXDIR
0010E8 DE45 ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
0010EA DE47 E1              10      POP HL
0010EB DE48 20DD            12      JR  NZ,SOPEN1
0010ED DE4A 1807            12      JR  SOPEN6
       DE4C                     SOPEN5:
0010EF DE4C CD41E7          17      CALL    GNCLX       ;END DIR
0010F2 DE4F D8              11      RET C
0010F3 DE50 CDC5DF          17      CALL    ENDCL
       DE53                     SOPEN6:
0010F6 DE53 38D2            12      JR  C,SOPEN1
       DE55                     SCF_FF_RET:
0010F8 DE55 37               4      SCF         ;CF=1
0010F9 DE56 9F               4      SBC A,A     ;A=0FFH
0010FA DE57 C9              10      RET
                                
       DE58                     RDDERR:
0010FB DE58 BF               4      CP  A       ;READ ERR CF=1 ZF=1
0010FC DE59 37               4      SCF
0010FD DE5A C9              10      RET
                                
       DE5B                     NOPEN:
0010FE DE5B 210DDF          10      LD  HL,FILESE
001101 DE5E 2233DE          16      LD  (OPENPAT+1),HL
001104 DE61 FD2A98EF        20      LD  IY,(_FCB)
001108 DE65 CDF8E0          17      CALL    CHKWILDX
00110B DE68 30EB            12      JR  NC,SCF_FF_RET
00110D DE6A FD7E00          19      LD  A,(IY+0)    ;(FCB)ドライブ番号
001110 DE6D 3D               4      DEC A
001111 DE6E 3288EF          13      LD  (_DRV),A
001114 DE71 CDD9EF          17      CALL    _CHGDRV
001117 DE74 D8              11      RET C
001118 DE75 2AF8F0          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
00111B DE78 229FEF          16      LD  (_FILEN),HL
                                
00111E DE7B CD0DE0          17      CALL    LDDIRX
001121 DE7E ED5B9AEF        20      LD  DE,(_FBPS)
001125 DE82 CDFEDE          17      CALL    READ_DIR
001128 DE85 38D1            12      JR  C,RDDERR
00112A DE87 3A9EEF          13      LD  A,(_FBCNT)
00112D DE8A 3D               4      DEC A
00112E DE8B 28AD            12      JR  Z,SOPEN3
       DE8D                     NOPEN2:
001130 DE8D 2A9CEF          16      LD  HL,(_FBAD)
001133 DE90 012000          10      LD  BC,020H
001136 DE93 09              11      ADD HL,BC
001137 DE94 4F               4      LD  C,A
001138 DE95 189A            12      JR  SOPEN2
                                
       DE97                     SOPENE2:
00113A DE97 229CEF          16      LD  (_FBAD),HL
00113D DE9A 79               4      LD  A,C
00113E DE9B 329EEF          13      LD  (_FBCNT),A
001141 DE9E ED539AEF        20      LD  (_FBPS),DE
001145 DEA2 FD2298EF        20      LD  (_FCB),IY
       DEA6                     SOPENE:
001149 DEA6 AF               4      XOR A
00114A DEA7 C9              10      RET
                                
       DEA8                     COPEN:
00114B DEA8 FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
00114F DEAC 212ADF          10      LD  HL,NEXTSE
001152 DEAF CDFADD          17      CALL    SOPENC
001155 DEB2 D0              11      RET NC
001156 DEB3 C8              11      RET Z
001157 DEB4 3AA0EF          13      LD  A,(_DIRF)   ;ディレクトリか判別
00115A DEB7 B7               4      OR  A
00115B DEB8 37               4      SCF
00115C DEB9 C8              11      RET Z       ;ルートディレクトリ
00115D DEBA 0601             7      LD  B,1
00115F DEBC CD56E1          17      CALL    WRDF
001162 DEBF D8              11      RET C
001163 DEC0 ED5BFEF0        20      LD  DE,(_CLPS)
001167 DEC4 D5              11      PUSH    DE
001168 DEC5 CD8EDF          17      CALL    DCPAT
00116B DEC8 CDCCE5          17      CALL    DRDNX
00116E DECB 2A7EF0          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
001171 DECE 3ACAE4          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
001174 DED1 47               4      LD  B,A
001175 DED2 AF               4      XOR A
001176 DED3 4F               4      LD  C,A
       DED4                     COPENCL:
001177 DED4 77               7      LD  (HL),A
001178 DED5 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
00117A DED7 EAD4DE          10      JP  PE,COPENCL
                                
00117D DEDA 3AACDF          13      LD  A,(SPCPAT+1)    ;1クラスタの論理セクタ数
001180 DEDD 3D               4      DEC A
001181 DEDE 2819            12      JR  Z,COPENE
001183 DEE0 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
001185 DEE2 3239E7          13      LD  (_SECPS+1),A
001188 DEE5 D1              10      POP DE      ;DE=(_CLPS)
001189 DEE6 D5              11      PUSH    DE
       DEE7                     COPEN1:
00118A DEE7 D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
00118B DEE8 C5              11      PUSH    BC
00118C DEE9 2A7EF0          16      LD  HL,(_DTBUF)
00118F DEEC CDA8DF          17      CALL    CLUSTX
001192 DEEF CDD1E8          17      CALL    DWT24
001195 DEF2 C1              10      POP BC
001196 DEF3 D1              10      POP DE
001197 DEF4 CD38E7          17      CALL    NEXTX
00119A DEF7 20EE            12      JR  NZ,COPEN1
       DEF9                     COPENE:
00119C DEF9 2A7EF0          16      LD  HL,(_DTBUF)
00119F DEFC D1              10      POP DE
0011A0 DEFD C9              10      RET
                                
       DEFE                     READ_DIR:
0011A1 DEFE ED53FEF0        20      LD  (_CLPS),DE
0011A5 DF02 C5              11      PUSH    BC
0011A6 DF03 D5              11      PUSH    DE
0011A7 DF04 CD8EDF          17      CALL    DCPAT
0011AA DF07 CDACE5          17      CALL    DRDX
0011AD DF0A D1              10      POP DE
0011AE DF0B C1              10      POP BC
0011AF DF0C C9              10      RET
                                
       DF0D                     FILESE:
0011B0 DF0D 7E               7      LD  A,(HL)
0011B1 DF0E B7               4      OR  A
0011B2 DF0F C8              11      RET Z       ;END:ZF=1 CF=0
0011B3 DF10 FEE5             7      CP  0E5H
0011B5 DF12 280E            12      JR  Z,FILESE1
0011B7 DF14 FDE5            15      PUSH    IY
0011B9 DF16 D1              10      POP DE
0011BA DF17 13               6      INC DE
0011BB DF18 E5              11      PUSH    HL
0011BC DF19 CD65DF          17      CALL    CPFILE
0011BF DF1C CC86DF          17      CALL    Z,CPFILE2
0011C2 DF1F E1              10      POP HL
0011C3 DF20 37               4      SCF
0011C4 DF21 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       DF22                     FILESE1:
0011C5 DF22 CD39DF          17      CALL    FNEXT
0011C8 DF25 20E6            12      JR  NZ,FILESE
       DF27                     ZF0_CF0_AFF_RET:
0011CA DF27 F6FF             7      OR  0FFH        ;ZF=0 CF=0
0011CC DF29 C9              10      RET
                                
       DF2A                     NEXTSE:
0011CD DF2A 7E               7      LD  A,(HL)
0011CE DF2B B7               4      OR  A
0011CF DF2C 37               4      SCF
0011D0 DF2D C8              11      RET Z       ;!!!:ZF=1 CF=1
0011D1 DF2E FEE5             7      CP  0E5H
0011D3 DF30 37               4      SCF
0011D4 DF31 C8              11      RET Z       ;!!!:(ZF=1) CF=1
0011D5 DF32 CD39DF          17      CALL    FNEXT
0011D8 DF35 20F3            12      JR  NZ,NEXTSE
0011DA DF37 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       DF39                     FNEXT:
0011DC DF39 E5              11      PUSH    HL
0011DD DF3A 219FEF          10      LD  HL,_FILEN
0011E0 DF3D 34              11      INC (HL)
0011E1 DF3E E1              10      POP HL
0011E2 DF3F 112000          10      LD  DE,020H
0011E5 DF42 19              11      ADD HL,DE
0011E6 DF43 0D               4      DEC C
0011E7 DF44 C9              10      RET
                                
       DF45                     CPNAME:
0011E8 DF45 C5              11      PUSH    BC
0011E9 DF46 D5              11      PUSH    DE
0011EA DF47 E5              11      PUSH    HL
0011EB DF48 CD5FDF          17      CALL    CPFILE4
0011EE DF4B E1              10      POP HL
0011EF DF4C 23               6      INC HL
0011F0 DF4D 23               6      INC HL
0011F1 DF4E 23               6      INC HL
0011F2 DF4F 23               6      INC HL
0011F3 DF50 D1              10      POP DE
0011F4 DF51 C1              10      POP BC
0011F5 DF52 2005            12      JR  NZ,CPNAME1
0011F7 DF54 7E               7      LD  A,(HL)
0011F8 DF55 23               6      INC HL
0011F9 DF56 66               7      LD  H,(HL)
0011FA DF57 6F               4      LD  L,A
0011FB DF58 C9              10      RET
       DF59                     CPNAME1:
0011FC DF59 23               6      INC HL
0011FD DF5A 23               6      INC HL
0011FE DF5B 10E8            13      DJNZ    CPNAME
001200 DF5D 37               4      SCF
001201 DF5E C9              10      RET
                                
       DF5F                     CPFILE4:
001202 DF5F C5              11      PUSH    BC
001203 DF60 010004          10      LD  BC,00400H
001206 DF63 1804            12      JR  CPSTR1
       DF65                     CPFILE:
001208 DF65 C5              11      PUSH    BC
001209 DF66 01000B          10      LD  BC,00B00H
       DF69                     CPSTR1:
00120C DF69 1A               7      LD  A,(DE)
00120D DF6A FE3F             7      CP  '?'     ;Wild card
00120F DF6C 2812            12      JR  Z,CPSTR2
001211 DF6E 7E               7      LD  A,(HL)
001212 DF6F CDDEE0          17      CALL    FKANC
001215 DF72 E5              11      PUSH    HL
001216 DF73 67               4      LD  H,A
001217 DF74 1A               7      LD  A,(DE)
001218 DF75 CB01             4      RLC C
00121A DF77 CDDEE0          17      CALL    FKANC
00121D DF7A CB09             4      RRC C
00121F DF7C BC               4      CP  H       ;CP (HL),(DE)
001220 DF7D E1              10      POP HL
001221 DF7E 2004            12      JR  NZ,CPSTR3
       DF80                     CPSTR2:
001223 DF80 13               6      INC DE
001224 DF81 23               6      INC HL
001225 DF82 10E5            13      DJNZ    CPSTR1
       DF84                     CPSTR3:
001227 DF84 C1              10      POP BC
001228 DF85 C9              10      RET
                                
       DF86                     CPFILE2:
001229 DF86 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
00122C DF89 F6E1             7      OR  0E1H
00122E DF8B 2F               4      CPL
00122F DF8C A6               7      AND (HL)
001230 DF8D C9              10      RET
                                
       DF8E                     DCPAT:
001231 DF8E 0E00             7      LD  C,0
001233 DF90 2A7EF0          16      LD  HL,(_DTBUF)
001236 DF93 3AA0EF          13      LD  A,(_DIRF)   ;ディレクトリか判別
001239 DF96 B7               4      OR  A
00123A DF97 C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
00123B DF98 3AACDF          13      LD  A,(SPCPAT+1)
00123E DF9B 4F               4      LD  C,A
00123F DF9C 3A39E7          13      LD  A,(_SECPS+1)
001242 DF9F B9               4      CP  C
001243 DFA0 3801            12      JR  C,DC1
001245 DFA2 AF               4      XOR A
       DFA3                     DC1:
001246 DFA3 F680             7      OR  080H
001248 DFA5 32A0EF          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       DFA8                     CLUSTX:
00124B DFA8 E5              11      PUSH    HL
00124C DFA9 EB               4      EX  DE,HL
00124D DFAA AF               4      XOR A
00124E DFAB 0E01             7  SPCPAT: LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       DFAD                     L_CLDBL:
001250 DFAD CB19             8      RR  C       ;->CF
001252 DFAF 3804            12      JR  C,E_CLDBL
001254 DFB1 29              11      ADD HL,HL       ;*2
001255 DFB2 8F               4      ADC A,A
001256 DFB3 18F8            12      JR  L_CLDBL
       DFB5                     E_CLDBL:
001258 DFB5 4F               4      LD  C,A
001259 DFB6 3A39E7          13      LD  A,(_SECPS+1)
00125C DFB9 B5               4      OR  L
00125D DFBA 6F               4      LD  L,A
00125E DFBB 110800          10  CLSPAT: LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
001261 DFBE AF               4      XOR A
001262 DFBF 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
001263 DFC0 89               4      ADC A,C
001264 DFC1 4F               4      LD  C,A
001265 DFC2 EB               4      EX  DE,HL
001266 DFC3 E1              10      POP HL
001267 DFC4 C9              10      RET
                                
       DFC5                     ENDCL:
001268 DFC5 7A               4      LD  A,D ;END CLUSTER
001269 DFC6 FE01             7  CLPAT1: CP  1   ;164=356    (self-modifying code)
00126B DFC8 C0              11      RET NZ
00126C DFC9 7B               4      LD  A,E
00126D DFCA FE64             7  CLPAT2: CP  064H    ;       (self-modifying code)
00126F DFCC C9              10      RET
                                
       DFCD                     CAP:
001270 DFCD FE61             7      CP  'a'
001272 DFCF D8              11      RET C
001273 DFD0 FE7B             7      CP  'z'+1
001275 DFD2 D0              11      RET NC
001276 DFD3 D620             7      SUB 020H
001278 DFD5 C9              10      RET
       DFD6                     CAP2:
001279 DFD6 CDCDDF          17      CALL    CAP
       DFD9                     CAP3:
00127C DFD9 CDE2DF          17      CALL    CAP4
00127F DFDC FE21             7      CP  021H
001281 DFDE D0              11      RET NC
001282 DFDF 3EA0             7      LD  A,0A0H
001284 DFE1 C9              10      RET
       DFE2                     CAP4:
001285 DFE2 FE05             7      CP  5
001287 DFE4 C0              11      RET NZ
001288 DFE5 3EE5             7      LD  A,0E5H
00128A DFE7 C9              10      RET
                                
       DFE8                     CHDIR:
00128B DFE8 CDFFE9          17      CALL    GETDPBD
00128E DFEB 381D            12      JR  C,CHDIR2
001290 DFED DD751A          19      LD  (IX+01AH),L     ;_SDIR_
001293 DFF0 DD741B          19      LD  (IX+01BH),H     ;_SDIR_+1
001296 DFF3 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       DFF5                     LDDIR:
001298 DFF5 CDFFE9          17      CALL    GETDPBD
00129B DFF8 DD5E1A          19      LD  E,(IX+01AH)     ;_SDIR_
00129E DFFB DD561B          19      LD  D,(IX+01BH)     ;_SDIR_+1
0012A1 DFFE 13               6      INC DE
0012A2 DFFF FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0012A5 E002 FD720F          19      LD  (IY+15),D
0012A8 E005 1B               6      DEC DE
0012A9 E006 AF               4      XOR A
0012AA E007 32A0EF          13      LD  (_DIRF),A
       E00A                     CHDIR2:
0012AD E00A DDE1            14      POP IX
0012AF E00C C9              10      RET
                                
       E00D                     LDDIRX:
0012B0 E00D 3AA0EF          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
0012B3 E010 E67F             7      AND 07FH
       E012                     LDDIRX1:
0012B5 E012 3239E7          13      LD  (_SECPS+1),A
0012B8 E015 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0012BB E018 FD560F          19      LD  D,(IY+15)
0012BE E01B 1B               6      DEC DE
0012BF E01C CDC5DF          17      CALL    ENDCL
0012C2 E01F D4F5DF          17      CALL    NC,LDDIR
       E022                     LDDIRS:
0012C5 E022 7A               4      LD  A,D
0012C6 E023 B3               4      OR  E
0012C7 E024 32A0EF          13      LD  (_DIRF),A   ;ディレクトリか判別
0012CA E027 C9              10      RET
                                
       E028                     KILL:
0012CB E028 CDF8E0          17      CALL    CHKWILDX
0012CE E02B 3834            12      JR  C,KILLW
0012D0 E02D CDCADD          17      CALL    SOPENX
       E030                     KILLS:
0012D3 E030 3E1F             7      LD  A,01FH
0012D5 E032 D474E0          17      CALL    NC,CHKATT
0012D8 E035 D8              11      RET C
       E036                     KILLSX:
0012D9 E036 36E5            10      LD  (HL),0E5H   ;DIR
0012DB E038 CDD2E0          17      CALL    WTDB
0012DE E03B 111A00          10      LD  DE,01AH
0012E1 E03E 19              11      ADD HL,DE
0012E2 E03F 5E               7      LD  E,(HL)
0012E3 E040 23               6      INC HL
0012E4 E041 56               7      LD  D,(HL)
       E042                     KILLS1:
0012E5 E042 CDC5DF          17      CALL    ENDCL
0012E8 E045 D0              11      RET NC      ;CF=0
0012E9 E046 21FEFF          10      LD  HL,0-2
0012EC E049 19              11      ADD HL,DE
0012ED E04A D0              11      RET NC      ;DE= 0 or 1
0012EE E04B D5              11      PUSH    DE
0012EF E04C CDF7EF          17      CALL    _GNCL
0012F2 E04F ED53FEF0        20      LD  (_CLPS),DE
0012F6 E053 D1              10      POP DE
0012F7 E054 210000          10      LD  HL,0
0012FA E057 D4FAEF          17      CALL    NC,_SNCL
0012FD E05A D8              11      RET C
0012FE E05B ED5BFEF0        20      LD  DE,(_CLPS)  ;FAT
001302 E05F 18E1            12      JR  KILLS1
                                
       E061                     KILLW:
001304 E061 CDF7DD          17      CALL    SOPEN
       E064                     KILLW1:
001307 E064 380B            12      JR  C,KILLW2
001309 E066 CD97DE          17      CALL    SOPENE2
00130C E069 CD30E0          17      CALL    KILLS
00130F E06C CD5BDE          17      CALL    NOPEN
001312 E06F 18F3            12      JR  KILLW1
       E071                     KILLW2:
001314 E071 C8              11      RET Z
001315 E072 3F               4      CCF
001316 E073 C9              10      RET
                                
       E074                     CHKATT:
001317 E074 E5              11      PUSH    HL
001318 E075 110B00          10      LD  DE,00BH
00131B E078 19              11      ADD HL,DE
00131C E079 A6               7      AND (HL)
00131D E07A E1              10      POP HL
00131E E07B C8              11      RET Z
00131F E07C 37               4      SCF
001320 E07D C9              10      RET
                                
       E07E                     NAME:
001321 E07E CDF8E0          17      CALL    CHKWILDX
001324 E081 D8              11      RET C
001325 E082 110400          10      LD  DE,4
001328 E085 19              11      ADD HL,DE
001329 E086 229EE0          16      LD  (NAMEP+2),HL
00132C E089 23               6      INC HL
00132D E08A CDFCE0          17      CALL    CHKWILD
001330 E08D D8              11      RET C
                                
001331 E08E CDCADD          17      CALL    SOPENX
001334 E091 3E0F             7      LD  A,00FH
001336 E093 D474E0          17      CALL    NC,CHKATT
001339 E096 D8              11      RET C
                                
00133A E097 FD7E00          19      LD  A,(IY+0)
00133D E09A FDE5            15      PUSH    IY
00133F E09C FD210000        14  NAMEP:  LD  IY,0        ;自己書き換え
001343 E0A0 FD7700          19      LD  (IY+0),A
001346 E0A3 CDCADD          17      CALL    SOPENX
001349 E0A6 FDE3            23      EX  (SP),IY
00134B E0A8 3F               4      CCF
00134C E0A9 D4F7DD          17      CALL    NC,SOPEN
00134F E0AC EB               4      EX  DE,HL
001350 E0AD E1              10      POP HL
001351 E0AE D8              11      RET C
                                
       E0AF                     SETNAME:
001352 E0AF 01000B          10      LD  BC,11*256
001355 E0B2 23               6      INC HL
001356 E0B3 7E               7      LD  A,(HL)
001357 E0B4 FEE5             7      CP  0E5H
001359 E0B6 2004            12      JR  NZ,SNAME1
00135B E0B8 3E05             7      LD  A,5
00135D E0BA 180E            12      JR  SNAME3
       E0BC                     SNAME1:
00135F E0BC 7E               7      LD  A,(HL)
001360 E0BD 0C               4      INC C
001361 E0BE 0D               4      DEC C
001362 E0BF 2009            12      JR  NZ,SNAME3
001364 E0C1 CDCDDF          17      CALL    CAP
001367 E0C4 FEA0             7      CP  0A0H
001369 E0C6 2002            12      JR  NZ,SNAME3
00136B E0C8 3E20             7      LD  A,020H
       E0CA                     SNAME3:
00136D E0CA 12               7      LD  (DE),A
00136E E0CB 7E               7      LD  A,(HL)
00136F E0CC 23               6      INC HL
001370 E0CD CDE5E0          17      CALL    FKAN
001373 E0D0 10EA            13      DJNZ    SNAME1
       E0D2                     WTDB:
001375 E0D2 3EFF             7      LD  A,0FFH
001377 E0D4 3239EF          13      LD  (SFILE),A
       E0D7                     SWTDBF:
00137A E0D7 3E01             7      LD  A,1
00137C E0D9 32A4EF          13      LD  (_WTDBF),A
00137F E0DC AF               4      XOR A
001380 E0DD C9              10      RET
                                
       E0DE                     FKANC:
001381 E0DE CB41             8      BIT 0,C
001383 E0E0 CCD6DF          17      CALL    Z,CAP2
001386 E0E3 1801            12      JR  FKANX
       E0E5                     FKAN:           ;漢字チェック
001388 E0E5 13               6      INC DE
       E0E6                     FKANX:
001389 E0E6 CB41             8      BIT 0,C
00138B E0E8 CB81             8      RES 0,C
00138D E0EA C0              11      RET NZ
00138E E0EB FE80             7      CP  080H
001390 E0ED D8              11      RET C
001391 E0EE FEA0             7      CP  0A0H
001393 E0F0 3803            12      JR  C,FKAN1
001395 E0F2 FEE0             7      CP  0E0H
001397 E0F4 D8              11      RET C
       E0F5                     FKAN1:
001398 E0F5 0C               4      INC C
001399 E0F6 A7               4      AND A
00139A E0F7 C9              10      RET
                                
       E0F8                     CHKWILDX:
00139B E0F8 FDE5            15      PUSH    IY
00139D E0FA E1              10      POP HL
00139E E0FB 23               6      INC HL
       E0FC                     CHKWILD:
00139F E0FC 060B             7      LD  B,11
0013A1 E0FE 3E3F             7      LD  A,'?'
       E100                     CHKWIL1:
0013A3 E100 BE               7      CP  (HL)
0013A4 E101 23               6      INC HL
0013A5 E102 37               4      SCF
0013A6 E103 C8              11      RET Z
0013A7 E104 10FA            13      DJNZ    CHKWIL1
0013A9 E106 AF               4      XOR A
0013AA E107 C9              10      RET
                                
       E108                     SDIRENT:        ;IY=FCB HL=DIR
0013AB E108 D5              11      PUSH    DE
0013AC E109 E5              11      PUSH    HL
0013AD E10A FDE5            15      PUSH    IY
0013AF E10C D1              10      POP DE
0013B0 E10D EB               4      EX  DE,HL
0013B1 E10E CDAFE0          17      CALL    SETNAME
                                ;               Attribute
0013B4 E111 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0013B7 E114 12               7      LD  (DE),A
0013B8 E115 13               6      INC DE
                                ;               Reserved
0013B9 E116 AF               4      XOR A
0013BA E117 060A             7      LD  B,10
       E119                     SDE1:
0013BC E119 12               7      LD  (DE),A
0013BD E11A 13               6      INC DE
0013BE E11B 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
0013C0 E11D 21EAF0          10      LD  HL,SDDATA       ;(FCB)更新年月日
0013C3 E120 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       E122                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
0013C5 E122 7E               7      LD  A,(HL)
0013C6 E123 23               6      INC HL
0013C7 E124 3229E1          13      LD  (SDPAT+2),A
0013CA E127 FD7E00          19  SDPAT:  LD  A,(IY+0)    ;LD A,(IY+A)
0013CD E12A 12               7      LD  (DE),A
0013CE E12B 13               6      INC DE
0013CF E12C 10F4            13      DJNZ    SDLOOP
                                
0013D1 E12E AF               4      XOR A
0013D2 E12F E1              10      POP HL
0013D3 E130 D1              10      POP DE
0013D4 E131 C9              10      RET
                                
       E132                     WOPEN:
0013D5 E132 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0013D8 E135 E61F             7      AND 01FH
0013DA E137 37               4      SCF
0013DB E138 C0              11      RET NZ
0013DC E139 FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       E13D                     TOPEN2:
0013E0 E13D AF               4      XOR A
       E13E                     TOPEN:              ;Initializes the time stamp
0013E1 E13E FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
0013E5 E142 C9              10      RET
                                
       E143                     WRDFX:
0013E6 E143 3AACDF          13      LD  A,(SPCPAT+1)    ;1クラスタの論理セクタ
       E146                     L_WRFX:
0013E9 E146 1F               4      RRA         ;->CF
0013EA E147 3806            12      JR  C,E_WRFX
0013EC E149 CB39             8      SRL C
0013EE E14B CB1C             8      RR  H       ;CH=CH/2
0013F0 E14D 18F7            12      JR  L_WRFX
       E14F                     E_WRFX:
0013F2 E14F 44               4      LD  B,H
0013F3 E150 04               4      INC B
0013F4 E151 3E37             7      LD  A,037H      ;SCF
0013F6 E153 32C9E5          13      LD  (DRDN1),A
                                
       E156                     WRDF:               ;Bクラスタ分FATを確保する
0013F9 E156 110200          10      LD  DE,2
0013FC E159 AF               4      XOR A
0013FD E15A 3239E7          13      LD  (_SECPS+1),A
       E15D                     WRDF1:
001400 E15D C5              11      PUSH    BC
001401 E15E D5              11      PUSH    DE
001402 E15F CDF7EF          17      CALL    _GNCL
001405 E162 381C            12      JR  C,WRDF3
001407 E164 7A               4      LD  A,D     ;空いているかチェック
001408 E165 B3               4      OR  E
001409 E166 2027            12      JR  NZ,WRDF4
00140B E168 E1              10      POP HL      ;HL=空いているクラスタ
00140C E169 E5              11      PUSH    HL
00140D E16A ED5BFEF0        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
001411 E16E 22FEF0          16      LD  (_CLPS),HL
001414 E171 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
001415 E172 B3               4      OR  E
001416 E173 2008            12      JR  NZ,WRDF2
001418 E175 FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
00141B E178 FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
00141E E17B 1803            12      JR  WRDF3
       E17D                     WRDF2:
001420 E17D CDFAEF          17      CALL    _SNCL
       E180                     WRDF3:
001423 E180 D1              10      POP DE
001424 E181 C1              10      POP BC
001425 E182 D8              11      RET C
001426 E183 100C            13      DJNZ    WRDF5       ;ここでループカウンタチェック
001428 E185 ED5BFEF0        20      LD  DE,(_CLPS)
00142C E189 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
00142F E18C C3FAEF          10      JP  _SNCL
                                
       E18F                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
001432 E18F D1              10      POP DE
001433 E190 C1              10      POP BC
       E191                     WRDF5:
001434 E191 13               6      INC DE
001435 E192 CDC5DF          17      CALL    ENDCL
001438 E195 38C6            12      JR  C,WRDF1
00143A E197 37               4      SCF
00143B E198 C9              10      RET
                                
       E199                     RWXR:
00143C E199 3ACAE4          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       E19C                     L_RWX:
00143F E19C 1F               4      RRA     ;->CF
001440 E19D 3808            12      JR  C,E_RWX
001442 E19F CB38             8      SRL B   ;BCH=BCH/2
001444 E1A1 CB19             8      RR  C   ;
001446 E1A3 CB1C             8      RR  H   ;
001448 E1A5 18F5            12      JR  L_RWX
       E1A7                     E_RWX:
00144A E1A7 FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
00144D E1AA FD561B          19      LD  D,(IY+27)
001450 E1AD AF               4      XOR A
001451 E1AE 3239E7          13      LD  (_SECPS+1),A
       E1B1                     RWX1:
001454 E1B1 ED53FEF0        20      LD  (_CLPS),DE
001458 E1B5 7A               4      LD  A,D
001459 E1B6 B3               4      OR  E
00145A E1B7 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
00145C E1B9 78               4      LD  A,B
00145D E1BA B1               4      OR  C
00145E E1BB B4               4      OR  H
00145F E1BC C8              11      RET Z       ;RET BCH==0 => CF=0
                                
001460 E1BD CD41E7          17      CALL    GNCLX
001463 E1C0 D8              11      RET C
001464 E1C1 7C               4      LD  A,H     ;
001465 E1C2 25               4      DEC H       ;
001466 E1C3 B7               4      OR  A       ;DEC BCH
001467 E1C4 2001            12      JR  NZ,RWX2     ;
001469 E1C6 0B               6      DEC BC      ;
       E1C7                     RWX2:
00146A E1C7 CDC5DF          17      CALL    ENDCL
00146D E1CA 38E5            12      JR  C,RWX1
       E1CC                     SCF_RET:
00146F E1CC 37               4      SCF
001470 E1CD C9              10      RET
                                
       E1CE                     DSKF:
001471 E1CE 110000          10  MAXCLP: LD  DE,0
001474 E1D1 2AACEF          16      LD  HL,(_FAKEFREE)
001477 E1D4 7C               4      LD  A,H
001478 E1D5 B5               4      OR  L
001479 E1D6 2803            12      JR  Z,DSKF1
00147B E1D8 110100          10      LD  DE,1
       E1DB                     DSKF1:
00147E E1DB D5              11      PUSH    DE
00147F E1DC CDF7EF          17      CALL    _GNCL
001482 E1DF 380C            12      JR  C,POPSCF
001484 E1E1 7A               4      LD  A,D
001485 E1E2 B3               4      OR  E
001486 E1E3 2001            12      JR  NZ,DSKF2
001488 E1E5 23               6      INC HL
       E1E6                     DSKF2:
001489 E1E6 D1              10      POP DE
00148A E1E7 1B               6      DEC DE
00148B E1E8 7A               4      LD  A,D
00148C E1E9 B3               4      OR  E
00148D E1EA 20EF            12      JR  NZ,DSKF1
00148F E1EC C9              10      RET
                                
       E1ED                     POPSCF:
001490 E1ED F1              10      POP AF
001491 E1EE 37               4      SCF
001492 E1EF C9              10      RET
                                
       E1F0                     SETTMS:
001493 E1F0 FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
001496 E1F3 3C               4      INC A
001497 E1F4 C0              11      RET NZ      ;ファイルが更新されていない
       E1F5                     SETTMSX:            ;FCBに日付時刻をセットする
001498 E1F5 CD5BD9          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
00149B E1F8 CB25             8      SLA L       ;   *2
00149D E1FA CB25             8      SLA L       ;   *4
00149F E1FC 29              11      ADD HL,HL       ;*2 *8
0014A0 E1FD 29              11      ADD HL,HL       ;*4 *16
0014A1 E1FE 29              11      ADD HL,HL       ;*8 *32
0014A2 E1FF 7A               4      LD  A,D
0014A3 E200 0F               4      RRCA            ;bit.0->7->->->0->C
0014A4 E201 E61F             7      AND 01FH
0014A6 E203 B5               4      OR  L
0014A7 E204 FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
0014AA E207 FD7417          19      LD  (IY+23),H
                                
0014AD E20A CD55D9          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
0014B0 E20D 0144F8          10      LD  BC,0-1980
0014B3 E210 09              11      ADD HL,BC
0014B4 E211 65               4      LD  H,L
                                
0014B5 E212 7A               4      LD  A,D
0014B6 E213 87               4      ADD A,A     ;*2
0014B7 E214 87               4      ADD A,A     ;*4
0014B8 E215 87               4      ADD A,A     ;*8
0014B9 E216 87               4      ADD A,A     ;*16
0014BA E217 6F               4      LD  L,A
0014BB E218 29              11      ADD HL,HL       ;*32
0014BC E219 7D               4      LD  A,L
0014BD E21A B3               4      OR  E
0014BE E21B FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
0014C1 E21E FD7415          19      LD  (IY+21),H
0014C4 E221 C9              10      RET
                                
       E222                     PUSHRR:
0014C5 E222 32C1E2          13      LD  (SETSEQ_SWC_RND),A
0014C8 E225 22D3E2          16      LD  (SETSEQ_SWC_SEQ_RR),HL
0014CB E228 CD48E2          17      CALL    GET_RR_AHL
0014CE E22B 225AEF          16      LD  (HLBUF),HL
0014D1 E22E 325CEF          13      LD  (HLBUF+2),A
0014D4 E231 C9              10      RET
                                
       E232                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
0014D5 E232 87               4      ADD A,A     ;in BHLA => out AHL
0014D6 E233 ED6A            15      ADC HL,HL
0014D8 E235 CB18             8      RR  B
0014DA E237 B7               4      OR  A
0014DB E238 78               4      LD  A,B     ;ここでフラグは変化しない
0014DC E239 C8              11      RET Z
0014DD E23A 2C               4      INC L       ;INC AHL
0014DE E23B C0              11      RET NZ      ;
0014DF E23C 24               4      INC H       ;
0014E0 E23D C0              11      RET NZ      ;
0014E1 E23E 3C               4      INC A       ;
0014E2 E23F C9              10      RET
                                
       E240                     INIT_RND:
0014E3 E240 3ECD             7      LD  A,0CDH      ;CALL ????
0014E5 E242 2191E2          10      LD  HL,POPRR
0014E8 E245 CD22E2          17      CALL    PUSHRR
       E248                     GET_RR_AHL:
0014EB E248 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
0014EE E24B FD6622          19      LD  H,(IY+34)   ;
0014F1 E24E FD7E23          19      LD  A,(IY+35)   ;
0014F4 E251 C9              10      RET
       E252                     SET_RR_AHL:
0014F5 E252 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
0014F8 E255 FD7422          19      LD  (IY+34),H
0014FB E258 FD7723          19      LD  (IY+35),A
0014FE E25B C9              10      RET
       E25C                     INIT_SEQ:
0014FF E25C 3E01             7      LD  A,1     ;LD BC,????
001501 E25E 218EE2          10      LD  HL,SETSEQ
001504 E261 CD22E2          17      CALL    PUSHRR
       E264                     GETSEQ:
001507 E264 FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
00150A E267 FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
00150D E26A AF               4      XOR A
                                
00150E E26B CB25             8      SLA L   ;L=L*2
                                
001510 E26D CB3C             8      SRL H   ;HL=HL/2
001512 E26F CB1D             8      RR  L   ;
001514 E271 C9              10      RET
                                
       E272                     SETSEQ1:
001515 E272 F5              11      PUSH    AF      
001516 E273 E5              11      PUSH    HL      ;AHL=Random record
001517 E274 FD7E21          19      LD  A,(IY+33)   ;(FCB)ランダムレコード
00151A E277 FD6E22          19      LD  L,(IY+34)
00151D E27A FD6623          19      LD  H,(IY+35)
001520 E27D 0600             7      LD  B,0
                                
001522 E27F CD32E2          17      CALL    GET_CPM_R_SIZE
                                
001525 E282 29              11      ADD HL,HL
001526 E283 CB3D             8      SRL L       ;L=L/2
001528 E285 FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
00152B E288 FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
00152E E28B E1              10      POP HL
00152F E28C F1              10      POP AF
001530 E28D C9              10      RET
       E28E                     SETSEQ:
001531 E28E CD72E2          17      CALL    SETSEQ1
       E291                     POPRR:
001534 E291 F5              11      PUSH    AF
001535 E292 E5              11      PUSH    HL
001536 E293 2A5AEF          16      LD  HL,(HLBUF)
001539 E296 3A5CEF          13      LD  A,(HLBUF+2)
00153C E299 CD52E2          17      CALL    SET_RR_AHL
00153F E29C E1              10      POP HL
001540 E29D F1              10      POP AF
001541 E29E C9              10      RET
                                
       E29F                     RB_WRITE:
001542 E29F C5              11      PUSH    BC
001543 E2A0 ED4B4CF0        20      LD  BC,(STABLE+2*026H)  ;(BDOS)ランダムブロック書き込み
001547 E2A4 1805            12      JR  RBRW
       E2A6                     RB_READ:
001549 E2A6 C5              11      PUSH    BC
00154A E2A7 ED4B4EF0        20      LD  BC,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       E2AB                     RBRW:
00154E E2AB CB3F             8      SRL A   ;AHLA' = HL*128
001550 E2AD CB1C             8      RR  H   ;AHL=AHL/2
001552 E2AF CB1D             8      RR  L   ;
001554 E2B1 3E00             7      LD  A,0
001556 E2B3 1F               4      RRA     ;A'HLA
001557 E2B4 FD7721          19      LD  (IY+33),A   ;(FCB)ランダムレコード
00155A E2B7 FD7522          19      LD  (IY+34),L
00155D E2BA FD7423          19      LD  (IY+35),H
001560 E2BD 218000          10      LD  HL,128
001563 E2C0 C5              11      PUSH    BC
       E2C1                     SETSEQ_SWC_RND:
001564 E2C1 CD72E2          17      CALL    SETSEQ1
001567 E2C4 C1              10      POP BC
001568 E2C5 FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
00156C E2C9 FDE5            15      PUSH    IY
00156E E2CB D1              10      POP DE
00156F E2CC D5              11      PUSH    DE
001570 E2CD CDDBE2          17      CALL    JP_BC
001573 E2D0 FDE1            14      POP IY
       E2D3                     SETSEQ_SWC_SEQ_RR   EQU $+1
001575 E2D2 CD8EE2          17      CALL    SETSEQ
001578 E2D5 FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
00157C E2D9 C1              10      POP BC
00157D E2DA C9              10      RET
       E2DB                     JP_BC:
00157E E2DB C5              11      PUSH    BC
00157F E2DC C9              10      RET
                                
       DE55                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       DE55                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       DE55                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       DE55                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       DE55                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E2DD                     _SYS26:     ;(BDOS)ランダムブロック書き込み
001580 E2DD AF               4      XOR A
001581 E2DE 32C9E5          13      LD  (DRDN1),A   ;NOP
001584 E2E1 220DE5          16      LD  (LEFT+1),HL ;HL←書き込むレコード数
001587 E2E4 225DEF          16      LD  (LEFTX),HL
00158A E2E7 CDAADD          17      CALL    SETDRV
                                
00158D E2EA CD64E4          17      CALL    RBX0
001590 E2ED DA87E3          10      JP  C,RBWERR
001593 E2F0 CD32E1          17      CALL    WOPEN
001596 E2F3 DA87E3          10      JP  C,RBWERR
001599 E2F6 7C               4      LD  A,H
00159A E2F7 B5               4      OR  L
00159B E2F8 CA80E3          10      JP  Z,RBW1
                                
00159E E2FB 2B               6      DEC HL
                                
00159F E2FC CD2FE5          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0015A2 E2FF 19              11      ADD HL,DE       ;BCHL=HL+BCDE
0015A3 E300 3001            12      JR  NC,S26X1    ;
0015A5 E302 03               6      INC BC      ;
       E303                     S26X1:
0015A6 E303 CD99E1          17      CALL    RWXR
0015A9 E306 DC43E1          17      CALL    C,WRDFX
0015AC E309 DA87E3          10      JP  C,RBWERR
                                
0015AF E30C CD93E4          17      CALL    RBX2
0015B2 E30F 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
0015B4 E311 CDB2E4          17      CALL    RBXA
0015B7 E314 3871            12      JR  C,RBWERR
0015B9 E316 EB               4      EX  DE,HL
0015BA E317 C5              11      PUSH    BC
0015BB E318 EDB0                    LDIR
0015BD E31A 225FEF          16      LD  (DTAX),HL
                                
0015C0 E31D CDD7E0          17      CALL    SWTDBF      ;バッファデータは更新された
                                
0015C3 E320 2A5DEF          16      LD  HL,(LEFTX)
0015C6 E323 D1              10      POP DE
0015C7 E324 ED52            15      SBC HL,DE
0015C9 E326 225DEF          16      LD  (LEFTX),HL
0015CC E329 2833            12      JR  Z,RBWEND
                                
       E32B                     RBWB:
0015CE E32B CDE8E4          17      CALL    RBXB
0015D1 E32E 2816            12      JR  Z,RBWC
       E330                     RBWB1:
0015D3 E330 C5              11      PUSH    BC
0015D4 E331 D5              11      PUSH    DE
0015D5 E332 CDA8DF          17      CALL    CLUSTX
0015D8 E335 CD43E5          17      CALL    DWTC
0015DB E338 D1              10      POP DE
0015DC E339 C1              10      POP BC
0015DD E33A 384B            12      JR  C,RBWERR
0015DF E33C CD41E7          17      CALL    GNCLX
0015E2 E33F 3846            12      JR  C,RBWERR
0015E4 E341 10ED            13      DJNZ    RBWB1
0015E6 E343 CD93E5          17      CALL    DRW_FLUSH
       E346                     RBWC:
0015E9 E346 CD00E5          17      CALL    RBXC
0015EC E349 2813            12      JR  Z,RBWEND
0015EE E34B C5              11      PUSH    BC
0015EF E34C CDA8DF          17      CALL    CLUSTX
0015F2 E34F CDC8E5          17      CALL    DRDN
0015F5 E352 C1              10      POP BC
0015F6 E353 3832            12      JR  C,RBWERR
0015F8 E355 ED5B7EF0        20      LD  DE,(_DTBUF)
0015FC E359 EDB0                    LDIR
0015FE E35B CDD7E0          17      CALL    SWTDBF      ;バッファデータは更新された
       E35E                     RBWEND:
001601 E35E CD0CE5          17      CALL    RBXEND
                                
001604 E361 CD73E4          17      CALL    RBX1
001607 E364 301A            12      JR  NC,RBW1
001609 E366 2A0DE5          16      LD  HL,(LEFT+1)
00160C E369 FD5E10          19      LD  E,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
00160F E36C FD5611          19      LD  D,(IY+17)   ;DE=File size
001612 E36F 19              11      ADD HL,DE
001613 E370 FD7510          19      LD  (IY+16),L   ;(FCB)ファイルのサイズ(バイト単位)
001616 E373 FD7411          19      LD  (IY+17),H
001619 E376 3008            12      JR  NC,RBW1
00161B E378 FD3412          23      INC (IY+18)
00161E E37B 2003            12      JR  NZ,RBW1
001620 E37D FD3413          23      INC (IY+19)
       E380                     RBW1:
001623 E380 FDE1            14      POP IY
001625 E382 C1              10      POP BC
001626 E383 D1              10      POP DE
001627 E384 E1              10      POP HL
       E385                     DD_NUL:
001628 E385 AF               4      XOR A
       E386                     DRDF0:
       E386                     DWTF0:
001629 E386 C9              10      RET
                                
       E387                     RBWERR:
00162A E387 FDE5            15      PUSH    IY
00162C E389 D1              10      POP DE
00162D E38A 2A20F0          16      LD  HL,(STABLE+2*010H)
001630 E38D CD0F00          17      CALL    JP_HL
       E390                     RBRERR1:
001633 E390 3E01             7      LD  A,001H
       E392                     RBRERR2:
001635 E392 FDE1            14      POP IY
001637 E394 C1              10      POP BC
001638 E395 D1              10      POP DE
001639 E396 E1              10      POP HL
00163A E397 37               4      SCF
00163B E398 210000          10      LD  HL,0
00163E E39B C9              10      RET
                                
       E39C                     RBRERR:
00163F E39C 3EFF             7      LD  A,0FFH
001641 E39E 18F2            12      JR  RBRERR2
                                
       E3A0                     RBRFL:
001643 E3A0 3E00             7  RBRFLP: LD  A,000H
001645 E3A2 FE0D             7      CP  00DH
001647 E3A4 2005            12      JR  NZ,RBRFL1
001649 E3A6 D5              11      PUSH    DE
00164A E3A7 1E0A             7      LD  E,00AH
00164C E3A9 1805            12      JR  RBRFL2
       E3AB                     RBRFL1:
00164E E3AB D5              11      PUSH    DE
00164F E3AC CD09EF          17      CALL    _SYS07
001652 E3AF 5F               4      LD  E,A
       E3B0                     RBRFL2:
001653 E3B0 CDCDEF          17      CALL    _PRINT
001656 E3B3 7B               4      LD  A,E
001657 E3B4 D1              10      POP DE
001658 E3B5 32A1E3          13      LD  (RBRFLP+1),A
00165B E3B8 C9              10      RET
       E3B9                     DDX:
00165C E3B9 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
00165F E3BC CDCDDF          17      CALL    CAP
001662 E3BF FE41             7      CP  'A'
001664 E3C1 C9              10      RET
                                
                                                ;Read random block
       E3C2                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001665 E3C2 225DEF          16      LD  (LEFTX),HL
001668 E3C5 CDAADD          17      CALL    SETDRV
                                
00166B E3C8 FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
00166F E3CC C252E4          10      JP  NZ,RBRDIR   ;ディレクトリ
001672 E3CF CD64E4          17      CALL    RBX0
001675 E3D2 DA9CE3          10      JP  C,RBRERR
001678 E3D5 CD73E4          17      CALL    RBX1
00167B E3D8 DA90E3          10      JP  C,RBRERR1
00167E E3DB EB               4      EX  DE,HL
00167F E3DC ED52            15      SBC HL,DE       ;CP 00HL,BCDE
001681 E3DE 19              11      ADD HL,DE
001682 E3DF 79               4      LD  A,C
001683 E3E0 DE00             7      SBC A,0
001685 E3E2 78               4      LD  A,B
001686 E3E3 DE00             7      SBC A,0
001688 E3E5 3801            12      JR  C,RBR1
00168A E3E7 EB               4      EX  DE,HL
       E3E8                     RBR1:
00168B E3E8 9F               4      SBC A,A
00168C E3E9 E601             7      AND 1
00168E E3EB 3250E4          13      LD  (RBRAP+1),A
                                
001691 E3EE 7C               4      LD  A,H
001692 E3EF B5               4      OR  L
001693 E3F0 2857            12      JR  Z,RBREND0
                                
001695 E3F2 220DE5          16      LD  (LEFT+1),HL ;Read record byte
001698 E3F5 225DEF          16      LD  (LEFTX),HL
                                
00169B E3F8 CD93E4          17      CALL    RBX2
00169E E3FB 2819            12      JR  Z,RBRB
0016A0 E3FD CDB2E4          17      CALL    RBXA
0016A3 E400 DA9CE3          10      JP  C,RBRERR
0016A6 E403 C5              11      PUSH    BC
0016A7 E404 EDB0                    LDIR
0016A9 E406 ED535FEF        20      LD  (DTAX),DE
0016AD E40A 2A5DEF          16      LD  HL,(LEFTX)
0016B0 E40D D1              10      POP DE
0016B1 E40E A7               4      AND A
0016B2 E40F ED52            15      SBC HL,DE
0016B4 E411 225DEF          16      LD  (LEFTX),HL
0016B7 E414 2830            12      JR  Z,RBREND
                                
       E416                     RBRB:
0016B9 E416 CDE8E4          17      CALL    RBXB
0016BC E419 2815            12      JR  Z,RBRC
       E41B                     RBRB1:
0016BE E41B C5              11      PUSH    BC
0016BF E41C D5              11      PUSH    DE
0016C0 E41D CDA8DF          17      CALL    CLUSTX
0016C3 E420 CD49E5          17      CALL    DRDC
0016C6 E423 D1              10      POP DE
0016C7 E424 C1              10      POP BC
0016C8 E425 D441E7          17      CALL    NC,GNCLX
0016CB E428 DA9CE3          10      JP  C,RBRERR
0016CE E42B 10EE            13      DJNZ    RBRB1
0016D0 E42D CD93E5          17      CALL    DRW_FLUSH
       E430                     RBRC:
0016D3 E430 CD00E5          17      CALL    RBXC
0016D6 E433 2811            12      JR  Z,RBREND
0016D8 E435 C5              11      PUSH    BC
0016D9 E436 CDA8DF          17      CALL    CLUSTX
0016DC E439 CDACE5          17      CALL    DRDX
0016DF E43C C1              10      POP BC
0016E0 E43D DA9CE3          10      JP  C,RBRERR
0016E3 E440 EB               4      EX  DE,HL
0016E4 E441 2A7EF0          16      LD  HL,(_DTBUF)
0016E7 E444 EDB0                    LDIR
       E446                     RBREND:
0016E9 E446 CD0CE5          17      CALL    RBXEND
       E449                     RBREND0:
0016EC E449 FDE1            14      POP IY
0016EE E44B C1              10      POP BC
0016EF E44C D1              10      POP DE
0016F0 E44D F1              10      POP AF  ;(HL)
0016F1 E44E AF               4      XOR A
0016F2 E44F 3E00             7  RBRAP:  LD  A,000H
0016F4 E451 C9              10      RET
                                
       E452                     RBRDIR:
0016F5 E452 FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0016F8 E455 FD661B          19      LD  H,(IY+27)
0016FB E458 CDE8DF          17      CALL    CHDIR
0016FE E45B AF               4      XOR A
0016FF E45C 67               4      LD  H,A
001700 E45D 6F               4      LD  L,A
001701 E45E 3C               4      INC A
001702 E45F 3250E4          13      LD  (RBRAP+1),A
001705 E462 18E5            12      JR  RBREND0
                                
       E464                     RBX0:
001707 E464 2A8AEF          16      LD  HL,(_DTA)
00170A E467 225FEF          16      LD  (DTAX),HL
00170D E46A 2A5DEF          16      LD  HL,(LEFTX)
001710 E46D FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
001713 E470 D6FD             7      SUB 0FDH
001715 E472 C9              10      RET
                                
       E473                     RBX1:
001716 E473 E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
001717 E474 FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
00171A E477 FD6611          19      LD  H,(IY+17)   ;
00171D E47A FD7E12          19      LD  A,(IY+18)   ;
                                
001720 E47D CD2FE5          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
001723 E480 A7               4      AND A
001724 E481 ED52            15      SBC HL,DE
001726 E483 99               4      SBC A,C
001727 E484 4F               4      LD  C,A
001728 E485 FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
00172B E488 98               4      SBC A,B
00172C E489 D1              10      POP DE
                                
00172D E48A D8              11      RET C
00172E E48B 47               4      LD  B,A
00172F E48C B1               4      OR  C
001730 E48D EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
001731 E48E B2               4      OR  D
001732 E48F B3               4      OR  E
001733 E490 C0              11      RET NZ
001734 E491 37               4      SCF
001735 E492 C9              10      RET
                                
       E493                     RBX2:               ;Cluster settings
001736 E493 FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
001739 E496 FD4E23          19      LD  C,(IY+35)
00173C E499 0600             7      LD  B,0
00173E E49B FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001742 E49F 2003            12      JR  NZ,RBX3
001744 E4A1 FD4624          19      LD  B,(IY+36)
       E4A4                     RBX3:
001747 E4A4 CD99E1          17      CALL    RWXR
00174A E4A7 3ACAE4          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
00174D E4AA 3D               4      DEC A
00174E E4AB FDA622          19      AND (IY+34)
001751 E4AE FDB621          19      OR  (IY+33)
001754 E4B1 C9              10      RET
                                
       E4B2                     RBXA:
001755 E4B2 C5              11      PUSH    BC
001756 E4B3 D5              11      PUSH    DE
001757 E4B4 CDA8DF          17      CALL    CLUSTX
00175A E4B7 CDACE5          17      CALL    DRDX
00175D E4BA D1              10      POP DE
00175E E4BB C1              10      POP BC
00175F E4BC D8              11      RET C
001760 E4BD CD41E7          17      CALL    GNCLX
001763 E4C0 D8              11      RET C
001764 E4C1 ED53FEF0        20      LD  (_CLPS),DE
                                
001768 E4C5 FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
00176B E4C8 210004          10  SECSZ:  LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
00176E E4CB 7C               4      LD  A,H
00176F E4CC 3D               4      DEC A       ;1024=3 / 512=1
001770 E4CD FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
001773 E4D0 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
001774 E4D1 ED42            15      SBC HL,BC       ;残りを計算
                                
001776 E4D3 ED5B5DEF        20      LD  DE,(LEFTX)
00177A E4D7 ED52            15      SBC HL,DE       ;CP HL,DE
00177C E4D9 19              11      ADD HL,DE       ;
00177D E4DA 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
00177F E4DC EB               4      EX  DE,HL
       E4DD                     RBXA1:
001780 E4DD E5              11      PUSH    HL
001781 E4DE 2A7EF0          16      LD  HL,(_DTBUF)
001784 E4E1 09              11      ADD HL,BC
001785 E4E2 ED5B5FEF        20      LD  DE,(DTAX)
001789 E4E6 C1              10      POP BC
00178A E4E7 C9              10      RET
                                
       E4E8                     RBXB:
00178B E4E8 2A5FEF          16      LD  HL,(DTAX)
00178E E4EB ED5BFEF0        20      LD  DE,(_CLPS)
001792 E4EF 3A5EEF          13      LD  A,(LEFTX+1)
001795 E4F2 47               4      LD  B,A
001796 E4F3 3ACAE4          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       E4F6                     RBXB1:
001799 E4F6 1F               4      RRA     ;->CF
00179A E4F7 3804            12      JR  C,RBXB2
00179C E4F9 CB38             8      SRL B   ;B=B/2
00179E E4FB 18F9            12      JR  RBXB1
       E4FD                     RBXB2:
0017A0 E4FD 78               4      LD  A,B
0017A1 E4FE B7               4      OR  A
0017A2 E4FF C9              10      RET
                                
       E500                     RBXC:
0017A3 E500 ED4B5DEF        20      LD  BC,(LEFTX)
0017A7 E504 3ACAE4          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
0017AA E507 3D               4      DEC A
0017AB E508 A0               4      AND B
0017AC E509 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
0017AD E50A B1               4      OR  C
0017AE E50B C9              10      RET
                                
       E50C                     RBXEND:
0017AF E50C 110000          10  LEFT:   LD  DE,0
0017B2 E50F AF               4      XOR A
0017B3 E510 FD6E21          19      LD  L,(IY+33)   ;(FCB)ランダムレコード
0017B6 E513 FD6622          19      LD  H,(IY+34)
0017B9 E516 19              11      ADD HL,DE
0017BA E517 FD7521          19      LD  (IY+33),L   ;(FCB)ランダムレコード
0017BD E51A FD7422          19      LD  (IY+34),H
0017C0 E51D 300E            12      JR  NC,RBXEND1
0017C2 E51F FD3423          23      INC (IY+35)
0017C5 E522 2009            12      JR  NZ,RBXEND1
0017C7 E524 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
0017CB E528 2003            12      JR  NZ,RBXEND1
0017CD E52A FD3424          23      INC (IY+36)
       E52D                     RBXEND1:
0017D0 E52D EB               4      EX  DE,HL       ;HL=Read byte
0017D1 E52E C9              10      RET
                                
       E52F                     GET_RR_BCDE:            ;BCDE=Random record
0017D2 E52F FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
0017D5 E532 FD5622          19      LD  D,(IY+34)
0017D8 E535 FD4E23          19      LD  C,(IY+35)
0017DB E538 FD4624          19      LD  B,(IY+36)
0017DE E53B FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
0017E2 E53F C8              11      RET Z
0017E3 E540 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
0017E5 E542 C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E543                     DWTC:
0017E6 E543 E5              11      PUSH    HL
0017E7 E544 21D3E8          10      LD  HL,DWT24B
0017EA E547 1804            12      JR  DWTC1
       E549                     DRDC:
0017EC E549 E5              11      PUSH    HL
0017ED E54A 21C3E8          10      LD  HL,DRD24B
       E54D                     DWTC1:
0017F0 E54D 22A7E5          16      LD  (DRWF_MODE),HL
0017F3 E550 E1              10      POP HL
0017F4 E551 3A97E5          13      LD  A,(DRWF_B)
0017F7 E554 B7               4      OR  A
0017F8 E555 200F            12      JR  NZ,DRDC1
       E557                     SAVE_DRWC:
0017FA E557 0601             7      LD  B,1
0017FC E559 ED4396E5        20      LD  (DRWF_C),BC
001800 E55D ED539DE5        20      LD  (DRWF_E),DE
001804 E561 22A0E5          16      LD  (DRWF_HL),HL
001807 E564 1820            12      JR  INC_HL_DRWC
       E566                     DRDC1:
001809 E566 E5              11      PUSH    HL
00180A E567 219DE5          10      LD  HL,DRWF_E
00180D E56A 86               7      ADD A,(HL)
00180E E56B F5              11      PUSH    AF
00180F E56C BB               4      CP  E
001810 E56D 201D            12      JR  NZ,DRDC2
001812 E56F F1              10      POP AF
001813 E570 23               6      INC HL
001814 E571 7E               7      LD  A,(HL)
001815 E572 CE00             7      ADC A,0
001817 E574 F5              11      PUSH    AF
001818 E575 BA               4      CP  D
001819 E576 2014            12      JR  NZ,DRDC2
00181B E578 F1              10      POP AF
00181C E579 3A96E5          13      LD  A,(DRWF_C)
00181F E57C CE00             7      ADC A,0
001821 E57E B9               4      CP  C
001822 E57F 200C            12      JR  NZ,DRDC3
001824 E581 2197E5          10      LD  HL,DRWF_B
001827 E584 34              11      INC (HL)
001828 E585 E1              10      POP HL
       E586                     INC_HL_DRWC:
001829 E586 3ACAE4          13      LD  A,(SECSZ+2)     ;1セクタのサイズの上位1バイト
00182C E589 84               4      ADD A,H
00182D E58A 67               4      LD  H,A
00182E E58B C9              10      RET
       E58C                     DRDC2:
00182F E58C F1              10      POP AF
       E58D                     DRDC3:
001830 E58D CD93E5          17      CALL    DRW_FLUSH
001833 E590 E1              10      POP HL
001834 E591 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E593                     DRW_FLUSH:
001836 E593 C5              11      PUSH    BC
001837 E594 D5              11      PUSH    DE
       E596                     DRWF_C  EQU $+1
       E597                     DRWF_B  EQU $+2
001838 E595 010000          10      LD  BC,0
00183B E598 78               4      LD  A,B
00183C E599 B7               4      OR  A
00183D E59A 280D            12      JR  Z,DRDF1
       E59D                     DRWF_E  EQU $+1
       E59E                     DRWF_D  EQU $+2
00183F E59C 110000          10      LD  DE,0
       E5A0                     DRWF_HL EQU $+1
001842 E59F 210000          10      LD  HL,0
001845 E5A2 AF               4      XOR A
001846 E5A3 3297E5          13      LD  (DRWF_B),A
       E5A7                     DRWF_MODE   EQU $+1
001849 E5A6 CDC3E8          17      CALL    DRD24B
       E5A9                     DRDF1:
00184C E5A9 D1              10      POP DE
00184D E5AA C1              10      POP BC
00184E E5AB C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E5AC                     DRDX:
00184F E5AC CDEAE5          17      CALL    DRDY
001852 E5AF C8              11      RET Z
001853 E5B0 CDD0E5          17      CALL    DRDX1       ;データバッファの情報を保存
001856 E5B3 D8              11      RET C
001857 E5B4 E5              11      PUSH    HL
001858 E5B5 C5              11      PUSH    BC
001859 E5B6 D5              11      PUSH    DE
00185A E5B7 2A7EF0          16      LD  HL,(_DTBUF)
00185D E5BA 3A13E6          13      LD  A,(_DBS24+1)
001860 E5BD 4F               4      LD  C,A
001861 E5BE CDC1E8          17      CALL    DRD24
001864 E5C1 DCE5E5          17      CALL    C,DRDNE
       E5C4                     POP_DE_BC_HL_RET:
001867 E5C4 D1              10      POP DE
001868 E5C5 C1              10      POP BC
001869 E5C6 E1              10      POP HL
00186A E5C7 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E5C8                     DRDN:
00186B E5C8 AF               4      XOR A
00186C E5C9 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
00186D E5CA 30E0            12      JR  NC,DRDX
       E5CC                     DRDNX:
00186F E5CC CDEAE5          17      CALL    DRDY
001872 E5CF C8              11      RET Z
       E5D0                     DRDX1:
001873 E5D0 CD00E6          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
001876 E5D3 ED53A6EF        20      LD  (_DBSEC),DE
00187A E5D7 79               4      LD  A,C
00187B E5D8 3213E6          13      LD  (_DBS24+1),A
                                
00187E E5DB 3A88EF          13      LD  A,(_DRV)
001881 E5DE 32A5EF          13      LD  (_DBDRV),A
001884 E5E1 CDD9EF          17      CALL    _CHGDRV
001887 E5E4 D0              11      RET NC
       E5E5                     DRDNE:
001888 E5E5 9F               4      SBC A,A     ;CF=1ならばA=0FFH
001889 E5E6 32A5EF          13      LD  (_DBDRV),A
00188C E5E9 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E5EA                     DRDY:
00188D E5EA 3A13E6          13      LD  A,(_DBS24+1)
001890 E5ED B9               4      CP  C
001891 E5EE C0              11      RET NZ
                                
001892 E5EF E5              11      PUSH    HL
001893 E5F0 3A88EF          13      LD  A,(_DRV)
001896 E5F3 21A5EF          10      LD  HL,_DBDRV
001899 E5F6 AE               7      XOR (HL)
00189A E5F7 2005            12      JR  NZ,POP_HL_RET
                                
00189C E5F9 2AA6EF          16      LD  HL,(_DBSEC)
00189F E5FC ED52            15      SBC HL,DE       ;CF=0
       E5FE                     POP_HL_RET:
0018A1 E5FE E1              10      POP HL
0018A2 E5FF C9              10      RET
                                
       E600                     DWTX:
0018A3 E600 3AA4EF          13      LD  A,(_WTDBF)
0018A6 E603 B7               4      OR  A
0018A7 E604 C8              11      RET Z
0018A8 E605 AF               4      XOR A
0018A9 E606 32A4EF          13      LD  (_WTDBF),A
                                
0018AC E609 E5              11      PUSH    HL
0018AD E60A C5              11      PUSH    BC
0018AE E60B D5              11      PUSH    DE
0018AF E60C 3AA5EF          13      LD  A,(_DBDRV)
0018B2 E60F CDD9EF          17      CALL    _CHGDRV
0018B5 E612 0E00             7  _DBS24: LD  C,0
0018B7 E614 ED5BA6EF        20      LD  DE,(_DBSEC)
0018BB E618 2A7EF0          16      LD  HL,(_DTBUF)
0018BE E61B D4D1E8          17      CALL    NC,DWT24
       E61E                     POP_DE_BC_HL_RET2:
0018C1 E61E 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E620                     RDFATX:
0018C3 E620 E5              11      PUSH    HL
0018C4 E621 3A88EF          13      LD  A,(_DRV)
0018C7 E624 21AAEF          10      LD  HL,_FATDRV
0018CA E627 AE               7      XOR (HL)
0018CB E628 28D4            12      JR  Z,POP_HL_RET
                                
0018CD E62A C5              11      PUSH    BC
0018CE E62B D5              11      PUSH    DE
0018CF E62C DDE5            15      PUSH    IX
0018D1 E62E CD4AE6          17      CALL    WTFATX
0018D4 E631 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
0018D6 E633 AF               4      XOR A
0018D7 E634 32ABEF          13      LD  (_FATIX),A
0018DA E637 3A88EF          13      LD  A,(_DRV)
0018DD E63A 32AAEF          13      LD  (_FATDRV),A
0018E0 E63D CDE5EF          17      CALL    _RDFAT
       E640                     RDFATE2:
0018E3 E640 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
0018E5 E642 9F               4      SBC A,A     ;A=0xFF
0018E6 E643 32AAEF          13      LD  (_FATDRV),A
       E646                     POP_IX_DE_BC_HL_RET:
0018E9 E646 DDE1            14      POP IX
0018EB E648 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E64A                     WTFATX:
0018ED E64A 3AA2EF          13      LD  A,(_WTFATF)
0018F0 E64D B7               4      OR  A
0018F1 E64E C8              11      RET Z
0018F2 E64F E5              11      PUSH    HL
0018F3 E650 3AAAEF          13      LD  A,(_FATDRV)
0018F6 E653 21A5EF          10      LD  HL,_DBDRV
0018F9 E656 AE               7      XOR (HL)
0018FA E657 CC00E6          17      CALL    Z,DWTX
0018FD E65A 38A2            12      JR  C,POP_HL_RET
0018FF E65C C5              11      PUSH    BC
001900 E65D D5              11      PUSH    DE
001901 E65E DDE5            15      PUSH    IX
001903 E660 CDDEE8          17      CALL    WTFAT
001906 E663 AF               4      XOR A
001907 E664 32A2EF          13      LD  (_WTFATF),A
00190A E667 18DD            12      JR  POP_IX_DE_BC_HL_RET
                                
       E669                     NCL1:
00190C E669 7A               4      LD  A,D
00190D E66A B3               4      OR  E
00190E E66B 37               4      SCF
00190F E66C C8              11      RET Z
                                
001910 E66D 7A               4      LD  A,D
001911 E66E CB3F             8      SRL A   ;/2
001913 E670 CB3F             8      SRL A   ;/2
                                
001915 E672 E5              11      PUSH    HL
001916 E673 3292E6          13      LD  (NCLPAT+2),A    ;_FATIX
001919 E676 2AAAEF          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
00191C E679 BC               4      CP  H
00191D E67A 3A88EF          13      LD  A,(_DRV)    ;この間でフラグは変化しない
001920 E67D 3291E6          13      LD  (NCLPAT+1),A    ;_FATDRV
001923 E680 2005            12      JR  NZ,NCL2     ;FATIXが違う
001925 E682 BD               4      CP  L
001926 E683 2002            12      JR  NZ,NCL2     ;ドライブが違う
001928 E685 E1              10      POP HL
001929 E686 C9              10      RET
       E687                     NCL2:
00192A E687 C5              11      PUSH    BC
00192B E688 D5              11      PUSH    DE
00192C E689 DDE5            15      PUSH    IX
00192E E68B CD4AE6          17      CALL    WTFATX
001931 E68E 38B6            12      JR  C,POP_IX_DE_BC_HL_RET
001933 E690 010000          10  NCLPAT: LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
001936 E693 ED43AAEF        20      LD  (_FATDRV),BC
00193A E697 CDB3E8          17      CALL    RDFATS
00193D E69A 18A4            12      JR  RDFATE2
                                
       E69C                     NCL3:
00193F E69C CB9A             8      RES 3,D
001941 E69E CB92             8      RES 2,D
001943 E6A0 6B               4      LD  L,E
001944 E6A1 62               4      LD  H,D
001945 E6A2 CB3C             8      SRL H   ;
001947 E6A4 CB1D             8      RR  L   ;HLA=HLA/2
001949 E6A6 1F               4      RRA     ;
00194A E6A7 F5              11      PUSH    AF
00194B E6A8 3AABEF          13      LD  A,(_FATIX)
00194E E6AB 0F               4      RRCA
00194F E6AC 300B            12      JR  NC,NCL3X1
001951 E6AE 3ACAE4          13      LD  A,(SECSZ+2)
001954 E6B1 FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
001956 E6B3 2004            12      JR  NZ,NCL3X1
001958 E6B5 010002          10      LD  BC,512
00195B E6B8 09              11      ADD HL,BC
       E6B9                     NCL3X1:
00195C E6B9 F1              10      POP AF
00195D E6BA ED4B7CF0        20      LD  BC,(_FATBF)
001961 E6BE 19              11      ADD HL,DE
001962 E6BF 09              11      ADD HL,BC
001963 E6C0 17               4      RLA
001964 E6C1 C9              10      RET
                                
       E6C2                     GNCL:
001965 E6C2 CD69E6          17      CALL    NCL1        ;GET NEXT CLUSTER
001968 E6C5 D8              11      RET C
001969 E6C6 C5              11      PUSH    BC
00196A E6C7 E5              11      PUSH    HL
00196B E6C8 CD9CE6          17      CALL    NCL3
00196E E6CB 3809            12      JR  C,GNC1
001970 E6CD 5E               7      LD  E,(HL)
001971 E6CE 23               6      INC HL
001972 E6CF 7E               7      LD  A,(HL)
001973 E6D0 E60F             7      AND 00FH
001975 E6D2 57               4      LD  D,A
001976 E6D3 E1              10      POP HL
001977 E6D4 C1              10      POP BC
001978 E6D5 C9              10      RET
       E6D6                     GNC1:
001979 E6D6 7E               7      LD  A,(HL)
00197A E6D7 23               6      INC HL
00197B E6D8 56               7      LD  D,(HL)
00197C E6D9 0604             7      LD  B,4
       E6DB                     GNC1L:
00197E E6DB CB3A             8      SRL D   ;DA=DA/2
001980 E6DD 1F               4      RRA     ;
001981 E6DE 10FB            13      DJNZ    GNC1L
                                
001983 E6E0 5F               4      LD  E,A
001984 E6E1 E1              10      POP HL
001985 E6E2 C1              10      POP BC
001986 E6E3 A7               4      AND A
001987 E6E4 C9              10      RET
                                
       E6E5                     SNCL:
001988 E6E5 CD69E6          17      CALL    NCL1
00198B E6E8 D8              11      RET C
                                ;               SET NEXT CLUSTER
00198C E6E9 E5              11      PUSH    HL
00198D E6EA C5              11      PUSH    BC
00198E E6EB D5              11      PUSH    DE
00198F E6EC E5              11      PUSH    HL
001990 E6ED CD9CE6          17      CALL    NCL3
001993 E6F0 D1              10      POP DE
                                ;CF=ODD
001994 E6F1 7E               7      LD  A,(HL)
001995 E6F2 73               7      LD  (HL),E
001996 E6F3 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
001998 E6F5 23               6      INC HL
001999 E6F6 ED67            18      RRD     ;M={A[3:0],E[3:0]}
00199B E6F8 7A               4      LD  A,D
00199C E6F9 1804            12      JR  SNC11
       E6FB                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
00199E E6FB ED6F            18      RLD     ;M={D[3:0],E[7:4]}
0019A0 E6FD 23               6      INC HL
0019A1 E6FE 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E6FF                     SNC11:
0019A2 E6FF ED6F            18      RLD     ;M={M[7:4],D[3:0]}
0019A4 E701 B7               4      OR  A
0019A5 E702 D1              10      POP DE
0019A6 E703 C1              10      POP BC
0019A7 E704 E1              10      POP HL
       E705                     FAT_CHANGED:
0019A8 E705 3E01             7      LD  A,1
0019AA E707 32A2EF          13      LD  (_WTFATF),A
0019AD E70A C9              10      RET
                                
       E70B                     N16CL3:
0019AE E70B C5              11      PUSH    BC
0019AF E70C 6B               4      LD  L,E
0019B0 E70D 7A               4      LD  A,D
0019B1 E70E E603             7      AND 3
0019B3 E710 67               4      LD  H,A
0019B4 E711 29              11      ADD HL,HL
0019B5 E712 ED4B7CF0        20      LD  BC,(_FATBF)
0019B9 E716 09              11      ADD HL,BC
0019BA E717 C1              10      POP BC
0019BB E718 C9              10      RET
                                
       E719                     GNCL16:
0019BC E719 CD69E6          17      CALL    NCL1        ;GET NEXT CLUSTER for FAT16
0019BF E71C D8              11      RET C
0019C0 E71D E5              11      PUSH    HL
0019C1 E71E CD0BE7          17      CALL    N16CL3
0019C4 E721 5E               7      LD  E,(HL)
0019C5 E722 23               6      INC HL
0019C6 E723 56               7      LD  D,(HL)
0019C7 E724 E1              10      POP HL
0019C8 E725 C9              10      RET
                                
       E726                     SNCL16:
0019C9 E726 CD69E6          17      CALL    NCL1        ;GET NEXT CLUSTER for FAT16
0019CC E729 D8              11      RET C
0019CD E72A D5              11      PUSH    DE
0019CE E72B E5              11      PUSH    HL
0019CF E72C CD0BE7          17      CALL    N16CL3
0019D2 E72F D1              10      POP DE      ;HL
0019D3 E730 73               7      LD  (HL),E
0019D4 E731 23               6      INC HL
0019D5 E732 72               7      LD  (HL),D
0019D6 E733 6B               4      LD  L,E
0019D7 E734 62               4      LD  H,D
0019D8 E735 D1              10      POP DE
0019D9 E736 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E738                     NEXTX:
0019DB E738 3E00             7  _SECPS: LD  A,0 ;自己書き換え
0019DD E73A 3C               4      INC A
0019DE E73B E600             7  NCPAT:  AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
0019E0 E73D 3239E7          13      LD  (_SECPS+1),A
0019E3 E740 C9              10      RET
                                
       E741                     GNCLX:
0019E4 E741 CD38E7          17      CALL    NEXTX
0019E7 E744 C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
0019E8 E745 C3F7EF          10      JP  _GNCL   ;次のクラスタを探す
                                
       E748                     RDFAT:
0019EB E748 3E80             7      LD  A,080H
0019ED E74A 3270EF          13      LD  (CHECK),A
       E74D                     RDFAT1:
0019F0 E74D 3A88EF          13      LD  A,(_DRV)
0019F3 E750 CD08EA          17      CALL    CHGDRVR
0019F6 E753 D8              11      RET C
0019F7 E754 DD7E12          19      LD  A,(IX+012H) ;DPB_12_DEVICE
0019FA E757 CB6F             8      BIT 5,A
0019FC E759 286B            12      JR  Z,RDFAT0X
0019FE E75B 2170EF          10      LD  HL,CHECK
001A01 E75E A6               7      AND (HL)
001A02 E75F 77               7      LD  (HL),A
001A03 E760 110000          10      LD  DE,0        ;BPB
001A06 E763 2A7CF0          16      LD  HL,(_FATBF)
001A09 E766 CDBFE8          17      CALL    DRD16
001A0C E769 3024            12      JR  NC,GETBPB
001A0E E76B 2170EF          10      LD  HL,CHECK
001A11 E76E CB06            15      RLC (HL)
001A13 E770 3F               4      CCF
001A14 E771 D8              11      RET C
001A15 E772 DDCB0A1E        23      RR  (IX+00AH)   ;DPB_0A_FDMODE
001A19 E776 3F               4      CCF         ;フロッピーディスクのFDモードを切り替える
001A1A E777 DDCB0A16        23      RL  (IX+00AH)   ;DPB_0A_FDMODE
001A1E E77B 3EFF             7      LD  A,0FFH
001A20 E77D 3289EF          13      LD  (_DSK),A
001A23 E780 3A84EF          13      LD  A,(_DRIVE)
001A26 E783 E603             7      AND 3
001A28 E785 F680             7      OR  080H
001A2A E787 6F               4      LD  L,A
001A2B E788 26EF             7      LD  H,_CYL0/256
001A2D E78A 3EFF             7      LD  A,0FFH
001A2F E78C 77               7      LD  (HL),A
001A30 E78D 18BE            12      JR  RDFAT1
       E78F                     GETBPB:
001A32 E78F FDE5            15      PUSH    IY
001A34 E791 FD2A7CF0        20      LD  IY,(_FATBF) ;BPB
001A38 E795 CDF1EF          17      CALL    _BPB2DPB
001A3B E798 FDE1            14      POP IY
001A3D E79A DD7E12          19      LD  A,(IX+012H) ;DPB_12_DEVICE
001A40 E79D 3021            12      JR  NC,GETBPBOK
001A42 E79F E60F             7      AND 00FH
001A44 E7A1 FE07             7      CP  7
001A46 E7A3 37               4      SCF
001A47 E7A4 C0              11      RET NZ
001A48 E7A5 DDCB0A46        20      BIT 0,(IX+00AH) ;DPB_0A_FDMODE
001A4C E7A9 21C0F0          10      LD  HL,M2D
001A4F E7AC 2002            12      JR  NZ,SETFDMODE
001A51 E7AE 2ED2             7      LD  L,M2HD-STABLE
       E7B0                     SETFDMODE:
001A53 E7B0 DDE5            15      PUSH    IX
001A55 E7B2 D1              10      POP DE
001A56 E7B3 EDA0            16      LDI
001A58 E7B5 EDA0            16      LDI
001A5A E7B7 13               6      INC DE
001A5B E7B8 13               6      INC DE
001A5C E7B9 13               6      INC DE
001A5D E7BA 13               6      INC DE
001A5E E7BB 010C00          10      LD  BC,12
001A61 E7BE EDB0                    LDIR
       E7C0                     GETBPBOK:
001A63 E7C0 32CFE7          13      LD  (DEVSWC),A
001A66 E7C3 CD67E9          17      CALL    CHGDRV2
       E7C6                     RDFAT0X:
001A69 E7C6 CDB3E8          17      CALL    RDFATS
001A6C E7C9 D8              11      RET C
001A6D E7CA DDAE06          19      XOR (IX+6)      ;DPB_06_FATID
001A70 E7CD C8              11      RET Z
       E7CF                     DEVSWC  EQU $+1
001A71 E7CE 3E00             7      LD  A,0     ;DPB_12_DEVICE
001A73 E7D0 CB6F             8      BIT 5,A
001A75 E7D2 C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
001A76 E7D3 37               4      SCF
001A77 E7D4 C9              10      RET
                                
       E7D5                     BPB2DPB:
001A78 E7D5 FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
001A7B E7D8 B7               4      OR  A
001A7C E7D9 37               4      SCF
001A7D E7DA C0              11      RET NZ
       E7DB                     BPBOK:
001A7E E7DB FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
001A81 E7DE DD7707          19      LD  (IX+7),A    ;DPB_07_SECPCL
                                
001A84 E7E1 FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
001A87 E7E4 DD7700          19      LD  (IX+0),A    ;DPB_00_FATLN
001A8A E7E7 FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
001A8D E7EA DD7701          19      LD  (IX+1),A    ;DPB_00_FATLN
                                
001A90 E7ED FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
001A93 E7F0 FD660F          19      LD  H,(IY+15)
001A96 E7F3 DD750E          19      LD  (IX+00EH),L ;DPB_0E_FATPS
001A99 E7F6 FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
001A9C E7F9 FD5617          19      LD  D,(IY+23)
001A9F E7FC FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E7FF                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
001AA2 E7FF 19              11      ADD HL,DE
001AA3 E800 10FD            13      DJNZ    BPBDP1
       E802                     BPBDP2:
001AA5 E802 DD7510          19      LD  (IX+010H),L ;DPB_10_DIRPS
001AA8 E805 DD7411          19      LD  (IX+011H),H
001AAB E808 E5              11      PUSH    HL
                                
001AAC E809 FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
001AAF E80C FD6612          19      LD  H,(IY+18)
001AB2 E80F FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001AB5 E812 B7               4      OR  A
001AB6 E813 37               4      SCF
001AB7 E814 C8              11      RET Z
001AB8 E815 0606             7      LD  B,6
       E817                     BPBBPS1:
001ABA E817 05               4      DEC B
001ABB E818 0F               4      RRCA
001ABC E819 30FC            12      JR  NC,BPBBPS1
       E81B                     BPBDE1:
001ABE E81B 29              11      ADD HL,HL
001ABF E81C 10FD            13      DJNZ    BPBDE1
                                
001AC1 E81E 7C               4      LD  A,H
001AC2 E81F DD770B          19      LD  (IX+00BH),A ;DPB_0B_DIRSCNT
                                
001AC5 E822 D1              10      POP DE      ;DPB_10_DIRPS
001AC6 E823 6C               4      LD  L,H
001AC7 E824 2600             7      LD  H,0
001AC9 E826 19              11      ADD HL,DE       ;MAXDIR
001ACA E827 E5              11      PUSH    HL
001ACB E828 FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
001ACE E82B CB21             8      SLA C       ;*2
001AD0 E82D AF               4      XOR A
001AD1 E82E 47               4      LD  B,A
001AD2 E82F ED42            15      SBC HL,BC
001AD4 E831 DD7514          19      LD  (IX+014H),L ;DPB_14_ADDCL16
001AD7 E834 DD7415          19      LD  (IX+015H),H
                                
001ADA E837 D1              10      POP DE      ;DE=DPB_0B_MAXDIR
001ADB E838 FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
001ADE E83B FD6614          19      LD  H,(IY+20)
                                
001AE1 E83E DD7E12          19      LD  A,(IX+012H) ;DPB_12_DEVICE
001AE4 E841 E60F             7      AND 00FH
001AE6 E843 FE07             7      CP  7       ;フロッピー
001AE8 E845 2019            12      JR  NZ,NOT_FD
001AEA E847 E5              11      PUSH    HL
001AEB E848 FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
001AEE E84B DD710D          19      LD  (IX+00DH),C ;DPB_0D_MAXSEC
001AF1 E84E AF               4      XOR A
001AF2 E84F CB21             8      SLA C       ;両面なのでセクタ数を２倍
001AF4 E851 0610             7      LD  B,16
       E853                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
001AF6 E853 29              11      ADD HL,HL
001AF7 E854 17               4      RLA
001AF8 E855 B9               4      CP  C
001AF9 E856 3802            12      JR  C,DIVSEC1
001AFB E858 91               4      SUB C
001AFC E859 2C               4      INC L
       E85A                     DIVSEC1:
001AFD E85A 10F7            13      DJNZ    DIVSEC
001AFF E85C DD750C          19      LD  (IX+00CH),L ;DPB_0C_MAXCYL
001B02 E85F E1              10      POP HL  ;ここまでフロッピー専用
       E860                     NOT_FD:
001B03 E860 7C               4      LD  A,H
001B04 E861 B5               4      OR  L
001B05 E862 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001B07 E864 2010            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001B09 E866 FD7E23          19      LD  A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001B0C E869 B7               4      OR  A
001B0D E86A 37               4      SCF
001B0E E86B C0              11      RET NZ
001B0F E86C FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001B12 E86F FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_07_SECPCL)が最大128なので
001B15 E872 FD7E22          19      LD  A,(IY+34)   ;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
001B18 E875 A7               4      AND A       ;CF=0
       E876                     BPB16BIT:
001B19 E876 ED52            15      SBC HL,DE
001B1B E878 DE00             7      SBC A,0
001B1D E87A FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E87D                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001B20 E87D CB18             8      RR  B       ;->CY
001B22 E87F 3808            12      JR  C,BPBTC2
001B24 E881 CB3F             8      SRL A
001B26 E883 CB1C             8      RR  H       ;AHL=AHL/2
001B28 E885 CB1D             8      RR  L
001B2A E887 18F4            12      JR  BPBTC1
       E889                     BPBTC2:
001B2C E889 B7               4      OR  A
001B2D E88A 37               4      SCF
001B2E E88B C0              11      RET NZ      ;念のため(クラスタ数が16ビットを超える場合)
001B2F E88C 23               6      INC HL
001B30 E88D 23               6      INC HL
001B31 E88E DD7508          19      LD  (IX+8),L    ;DPB_08_MAXCL
001B34 E891 DD7409          19      LD  (IX+9),H
                                
001B37 E894 FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001B3A E897 DD7706          19      LD  (IX+6),A    ;DPB_06_FATID
                                
001B3D E89A FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001B40 E89D C6FE             7      ADD A,0-2       ;>2:CF=1
001B42 E89F FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001B45 E8A2 6F               4      LD  L,A
001B46 E8A3 3002            12      JR  NC,BPBFAT1
001B48 E8A5 F680             7      OR  080H
       E8A7                     BPBFAT1:
001B4A E8A7 DD770F          19      LD  (IX+00FH),A ;DPB_0F_BPS
001B4D E8AA 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001B4E E8AB C8              11      RET Z       ;1セクタ256バイト
001B4F E8AC 2D               4      DEC L
001B50 E8AD C8              11      RET Z       ;1セクタ512バイト
001B51 E8AE 2D               4      DEC L
001B52 E8AF 2D               4      DEC L
001B53 E8B0 C8              11      RET Z       ;1セクタ1024バイト
001B54 E8B1 37               4      SCF
001B55 E8B2 C9              10      RET
                                
       E8B3                     RDFATS:
001B56 E8B3 CDF9E8          17      CALL    FATSETUP
001B59 E8B6 D8              11      RET C
001B5A E8B7 CDC3E8          17      CALL    DRD24B
001B5D E8BA 2A7CF0          16      LD  HL,(_FATBF)
001B60 E8BD 7E               7      LD  A,(HL)
001B61 E8BE C9              10      RET
                                
       E8BF                     DRD16:
001B62 E8BF 0E00             7      LD  C,0
       E8C1                     DRD24:
001B64 E8C1 0601             7      LD  B,1
       E8C3                     DRD24B:
001B66 E8C3 DDE5            15      PUSH    IX
001B68 E8C5 DD2AA8EF        20      LD  IX,(_DPB)
001B6C E8C9 CD52EB          17  DRDPAT: CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E8CC                     POP_IX_RET:
001B6F E8CC DDE1            14      POP IX
001B71 E8CE C9              10      RET
                                
       E8CF                     DWT16:
001B72 E8CF 0E00             7      LD  C,0
       E8D1                     DWT24:
001B74 E8D1 0601             7      LD  B,1
       E8D3                     DWT24B:
001B76 E8D3 DDE5            15      PUSH    IX
001B78 E8D5 DD2AA8EF        20      LD  IX,(_DPB)
001B7C E8D9 CDF8EA          17  DWTPAT: CALL    FDWT        ;自己書き換え（ディスク書き込み）
001B7F E8DC 18EE            12      JR  POP_IX_RET
                                
       E8DE                     WTFAT:
001B81 E8DE CDF9E8          17      CALL    FATSETUP
001B84 E8E1 D4D3E8          17      CALL    NC,DWT24B
001B87 E8E4 D8              11      RET C
001B88 E8E5 DDCB0F7E        20      BIT 7,(IX+00FH) ;DPB_0F_BPS
001B8C E8E9 C8              11      RET Z       ;予備FATが無い
001B8D E8EA CD00E9          17      CALL    FATS2
001B90 E8ED E5              11      PUSH    HL      ;予備FAT
001B91 E8EE DD6E00          19      LD  L,(IX+0)    ;DPB_00_FATLN
001B94 E8F1 DD6601          19      LD  H,(IX+1)
001B97 E8F4 19              11      ADD HL,DE
001B98 E8F5 EB               4      EX  DE,HL
001B99 E8F6 E1              10      POP HL
001B9A E8F7 18DA            12      JR  DWT24B
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ1024毎に2KBを切り替える
                                ;------------------------
       E8F9                     FATSETUP:
001B9C E8F9 3AAAEF          13      LD  A,(_FATDRV)
001B9F E8FC CD08EA          17      CALL    CHGDRVR     ;ドライブ切り替え
001BA2 E8FF D8              11      RET C
       E900                     FATS2:
001BA3 E900 DD7E0F          19      LD  A,(IX+00FH) ;DPB_0F_BPS 512=2 1024=4
001BA6 E903 0F               4      RRCA
001BA7 E904 CD2DE9          17  FATSX:  CALL    FATSETUP12  ;自己書き換え
001BAA E907 210000          10      LD  HL,0
001BAD E90A 4A               4      LD  C,D
001BAE E90B 54               4      LD  D,H
001BAF E90C 3AABEF          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
001BB2 E90F 47               4      LD  B,A
001BB3 E910 04               4      INC B
001BB4 E911 DD7E00          19      LD  A,(IX+0)    ;DPB_00_FATLN
       E914                     FAT_SKP:
001BB7 E914 05               4      DEC B
001BB8 E915 2805            12      JR  Z,FAT1
001BBA E917 19              11      ADD HL,DE
001BBB E918 93               4      SUB E
001BBC E919 30F9            12      JR  NC,FAT_SKP
001BBE E91B C9              10      RET
       E91C                     FAT1:
001BBF E91C EB               4      EX  DE,HL
001BC0 E91D B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001BC1 E91E 3801            12      JR  C,FAT2
001BC3 E920 79               4      LD  A,C
       E921                     FAT2:
001BC4 E921 47               4      LD  B,A
                                
001BC5 E922 2AFAF0          16      LD  HL,(_FATPS) ;fat sector pos
001BC8 E925 19              11      ADD HL,DE
001BC9 E926 EB               4      EX  DE,HL
001BCA E927 2A7CF0          16      LD  HL,(_FATBF)
001BCD E92A AF               4      XOR A       ;CF=0
001BCE E92B 4F               4      LD  C,A
001BCF E92C C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       E92D                     FATSETUP12:
001BD0 E92D 110606          10      LD  DE,0606H    ;256
001BD3 E930 D8              11      RET C
001BD4 E931 110303          10      LD  DE,0303H    ;512
001BD7 E934 0F               4      RRCA
001BD8 E935 D8              11      RET C
001BD9 E936 110102          10      LD  DE,0201H    ;1024
001BDC E939 C9              10      RET
                                
       E93A                     FATSETUP16:
001BDD E93A 110808          10      LD  DE,0808H    ;256
001BE0 E93D D8              11      RET C
001BE1 E93E 110404          10      LD  DE,0404H
001BE4 E941 0F               4      RRCA            ;512
001BE5 E942 D8              11      RET C
001BE6 E943 110202          10      LD  DE,0202H    ;1024
001BE9 E946 C9              10      RET
                                
       E947                     CHGDRV:
001BEA E947 E5              11      PUSH    HL
001BEB E948 2189EF          10      LD  HL,_DSK
001BEE E94B BE               7      CP  (HL)
001BEF E94C 280A            12      JR  Z,CHGDRVE
       E94E                     CHGDRV1:
001BF1 E94E DDE5            15      PUSH    IX
001BF3 E950 CD5AE9          17      CALL    CHGDRV0
001BF6 E953 3A89EF          13      LD  A,(_DSK)
001BF9 E956 DDE1            14      POP IX
       E958                     CHGDRVE:
001BFB E958 E1              10      POP HL
001BFC E959 C9              10      RET
                                
       E95A                     CHGDRV0:
001BFD E95A 6F               4      LD  L,A
001BFE E95B CDDCEF          17      CALL    _GETDPB
001C01 E95E D8              11      RET C
001C02 E95F DD22A8EF        20      LD  (_DPB),IX
001C06 E963 7D               4      LD  A,L
001C07 E964 3289EF          13      LD  (_DSK),A
       E967                     CHGDRV2:
001C0A E967 C5              11      PUSH    BC
001C0B E968 D5              11      PUSH    DE
001C0C E969 ED73BEE9        20      LD  (SPPAT2+1),SP
001C10 E96D F3               4      DI
001C11 E96E DDF9            10      LD  SP,IX
                                
001C13 E970 E1              10      POP HL      ;DPB_00_FATLN
001C14 E971 E1              10      POP HL      ;DPB_02_DRD
001C15 E972 22CAE8          16      LD  (DRDPAT+1),HL
                                
001C18 E975 E1              10      POP HL
001C19 E976 22DAE8          16      LD  (DWTPAT+1),HL   ;DPB_04_DWT
                                
001C1C E979 E1              10      POP HL      ;L=DPB_06_FATID H=DPB_07_SECPCL
001C1D E97A 7C               4      LD  A,H
001C1E E97B 32ACDF          13      LD  (SPCPAT+1),A    ;1クラスタの論理セクタ数
001C21 E97E 3D               4      DEC A
001C22 E97F 323CE7          13      LD  (NCPAT+1),A
                                
001C25 E982 E1              10      POP HL      ;DPB_08_MAXCL
001C26 E983 7D               4      LD  A,L
001C27 E984 32CBDF          13      LD  (CLPAT2+1),A
001C2A E987 7C               4      LD  A,H
001C2B E988 32C7DF          13      LD  (CLPAT1+1),A
001C2E E98B 2B               6      DEC HL
001C2F E98C 22CFE1          16      LD  (MAXCLP+1),HL
                                
001C32 E98F E1              10      POP HL      ;L=DPB_0A_FDMODE H=DPB_0B_DIRSCNT
001C33 E990 7D               4      LD  A,L
001C34 E991 F6FE             7      OR  0FEH
001C36 E993 32B3EF          13      LD  (FDMODE+1),A
001C39 E996 07               4      RLCA
001C3A E997 E603             7      AND 3
001C3C E999 3295EA          13      LD  (FSPAT+1),A
001C3F E99C 4C               4      LD  C,H
                                
001C40 E99D E1              10      POP HL      ;L=DPB_0C_MAXCYL H=DPB_0D_MAXSEC
                                
001C41 E99E E1              10      POP HL      ;L=DPB_0E_FATPS H=DPB_0F_BPS
001C42 E99F 7C               4      LD  A,H     ;DPB_0F_BPS
001C43 E9A0 E607             7      AND 7
001C45 E9A2 32CAE4          13      LD  (SECSZ+2),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98
                                                ;1セクタ256 GRAM/RAMF/CMOS/等
                                                ;1024   512 256
                                                ;4  2   1
001C48 E9A5 87               4      ADD A,A     ;8  4   2
001C49 E9A6 87               4      ADD A,A     ;010H   8   4
001C4A E9A7 87               4      ADD A,A     ;020H   010H    8
001C4B E9A8 3228DE          13      LD  (SDECPAT+1),A   ;1セクタ辺りのディレクトリエントリ数
                                
001C4E E9AB 2600             7      LD  H,0
001C50 E9AD 22FAF0          16      LD  (_FATPS),HL
                                
001C53 E9B0 E1              10      POP HL      ;DPB_10_DIRPS
001C54 E9B1 22FCF0          16      LD  (_DIRPS),HL
                                
001C57 E9B4 E1              10      POP HL      ;L=DPB_12_DEVICE H=DPB_13_UNITNO
001C58 E9B5 7C               4      LD  A,H
001C59 E9B6 3284EF          13      LD  (_DRIVE),A
                                
001C5C E9B9 E1              10      POP HL      ;DPB_14_ADDCL16
001C5D E9BA 22BCDF          16      LD  (CLSPAT+1),HL
                                
001C60 E9BD 310000          10  SPPAT2: LD  SP,0        ;元のSPを復元
001C63 E9C0 FB               4      EI
001C64 E9C1 2AFCF0          16      LD  HL,(_DIRPS)
001C67 E9C4 0600             7      LD  B,0
001C69 E9C6 09              11      ADD HL,BC       ;C=DPB_0B_DIRSCNT
001C6A E9C7 2243DE          16      LD  (MD_PAT+1),HL
                                
001C6D E9CA 2ACFE1          16      LD  HL,(MAXCLP+1);
001C70 E9CD 11F60F          10      LD  DE,4086     ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001C73 E9D0 ED52            15      SBC HL,DE       ;CF=0のはず
001C75 E9D2 300F            12      JR  NC,SETFAT16
001C77 E9D4 21C2E6          10      LD  HL,GNCL     ;FAT12
001C7A E9D7 11E5E6          10      LD  DE,SNCL
001C7D E9DA 012DE9          10      LD  BC,FATSETUP12
001C80 E9DD DDCB0FAE        23      RES 5,(IX+00FH) ;DPB_0F_BPS(FAT12)
001C84 E9E1 180D            12      JR  EXTRA1
       E9E3                     SETFAT16:
001C86 E9E3 2119E7          10      LD  HL,GNCL16   ;FAT16
001C89 E9E6 1126E7          10      LD  DE,SNCL16
001C8C E9E9 013AE9          10      LD  BC,FATSETUP16
001C8F E9EC DDCB0FEE        23      SET 5,(IX+00FH) ;DPB_0F_BPS(FAT16)
       E9F0                     EXTRA1:
001C93 E9F0 22F8EF          16      LD  (GNCPAT+1),HL
001C96 E9F3 ED53FBEF        20      LD  (SNCPAT+1),DE
001C9A E9F7 ED4305E9        20      LD  (FATSX+1),BC
001C9E E9FB D1              10      POP DE
001C9F E9FC C1              10      POP BC
001CA0 E9FD AF               4      XOR A
001CA1 E9FE C9              10      RET
                                
       E9FF                     GETDPBD:
001CA2 E9FF DDE3            23      EX  (SP),IX
001CA4 EA01 DDE5            15      PUSH    IX
001CA6 EA03 3A88EF          13      LD  A,(_DRV)
001CA9 EA06 1807            12      JR  GETDPB1
                                
       EA08                     CHGDRVR:
001CAB EA08 CDD9EF          17      CALL    _CHGDRV
001CAE EA0B D8              11      RET C
001CAF EA0C 3A89EF          13      LD  A,(_DSK)
       EA0F                     GETDPB1:
001CB2 EA0F C3DCEF          10      JP  _GETDPB
                                
       EA12                     GETDPB:
001CB5 EA12 FE08             7      CP  8
001CB7 EA14 3F               4      CCF
001CB8 EA15 D8              11      RET C
001CB9 EA16 0F               4      RRCA
001CBA EA17 0F               4      RRCA
001CBB EA18 0F               4      RRCA
001CBC EA19 DD                      DB  0DDH        ;Z80未定義命令
001CBD EA1A 6F               4      LD  L,A     ;LD IXL,A
001CBE EA1B DD                      DB  0DDH        ;Z80未定義命令
001CBF EA1C 26F1             7      LD  H,DEVICE/256    ;LD IXH,DEVICE/256
001CC1 EA1E DD7E00          19      LD  A,(IX+0)    ;DPB_00_FATLN
001CC4 EA21 A7               4      AND A       ;CF=0の為
001CC5 EA22 DDCB0F6E        20      BIT 5,(IX+00FH) ;DPB_0F_BPS
001CC9 EA26 C0              11      RET NZ      ;FAT16
001CCA EA27 DDCB126E        20      BIT 5,(IX+012H) ;DPB_12_DEVICE
001CCE EA2B C0              11      RET NZ      ;BPB
001CCF EA2C FE01             7      CP  001H        ;A=0 THEN CF=1
001CD1 EA2E C9              10      RET
                                
       EA2F                     _SYS5F:
001CD2 EA2F AF               4      XOR A
       EA30                     FFLUSH:
001CD3 EA30 F5              11      PUSH    AF
001CD4 EA31 3EFF             7      LD  A,0FFH
001CD6 EA33 3239EF          13      LD  (SFILE),A
001CD9 EA36 CD00E6          17      CALL    DWTX
001CDC EA39 3EFF             7      LD  A,0FFH
001CDE EA3B 32A5EF          13      LD  (_DBDRV),A
001CE1 EA3E CD4AE6          17      CALL    WTFATX
001CE4 EA41 AF               4      XOR A
001CE5 EA42 32ABEF          13      LD  (_FATIX),A
001CE8 EA45 2F               4      CPL         ;0FFH
001CE9 EA46 32AAEF          13      LD  (_FATDRV),A
001CEC EA49 F1              10      POP AF
001CED EA4A C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   MZ-700/1500
                                
       EA4B                     SEEK:
001CEE EA4B 0610             7      LD  B,16
001CF0 EA4D DD4E0D          19  MAXSEC: LD  C,(IX+0DH)  ;DPB_0D_MAXSEC
001CF3 EA50 AF               4      XOR A
001CF4 EA51 EB               4      EX  DE,HL
       EA52                     DIV1:
001CF5 EA52 29              11      ADD HL,HL
001CF6 EA53 8F               4      ADC A,A
001CF7 EA54 B9               4      CP  C
001CF8 EA55 3802            12      JR  C,DIV2
001CFA EA57 91               4      SUB C
001CFB EA58 2C               4      INC L
       EA59                     DIV2:
001CFC EA59 10F7            13      DJNZ    DIV1
                                
001CFE EA5B 3C               4      INC A   ;最小のセクタは１固定
001CFF EA5C 55               4      LD  D,L ;TRACK
001D00 EA5D 5F               4      LD  E,A ;SECTOR
                                
001D01 EA5E 3A84EF          13      LD  A,(_DRIVE)
001D04 EA61 FE04             7      CP  4
001D06 EA63 3F               4      CCF
001D07 EA64 D8              11      RET C
001D08 EA65 F684             7      OR  084H        ;Motor on + ドライブセレクト有効
001D0A EA67 D3DC            11      OUT (0DCH),A
001D0C EA69 CB3A             8      SRL D       ;CYLINDER
001D0E EA6B 9F               4      SBC A,A
001D0F EA6C D3DD            11      OUT (0DDH),A    ;SIDE
                                
001D11 EA6E CDABEA          17      CALL    SETMODE
001D14 EA71 D8              11      RET C
                                
001D15 EA72 CDE2EA          17      CALL    DRIVE
001D18 EA75 FEFF             7      CP  0FFH        ;A=0FFH Unknown CYLINDER
001D1A EA77 CCC7EA          17      CALL    Z,FDCRES    ;Restore
001D1D EA7A 2F               4      CPL         ;データバスが負論理
001D1E EA7B D3D9            11      OUT (0D9H),A    ;Currrent CYLINDER
001D20 EA7D 2F               4      CPL         ;データバスが負論理
001D21 EA7E 92               4      SUB D
001D22 EA7F C8              11      RET Z       ;No seek
                                
001D23 EA80 3A86EF          13      LD  A,(_ISEEK)
001D26 EA83 4F               4      LD  C,A
                                
001D27 EA84 DD7E0C          19      LD  A,(IX+00CH) ;DPB_0C_MAXCYL
001D2A EA87 3D               4      DEC A
001D2B EA88 BA               4      CP  D       ;Over CYLINDER
001D2C EA89 D8              11      RET C
                                
001D2D EA8A 7A               4      LD  A,D
001D2E EA8B 2F               4      CPL         ;データバスが負論理
001D2F EA8C D3DB            11      OUT (0DBH),A
001D31 EA8E 72               7      LD  (HL),D
                                
001D32 EA8F 0E18             7      LD  C,018H      ;Seek
       EA91                     FDCCMD2:
001D34 EA91 3A85EF          13      LD  A,(_SEEKSP)
001D37 EA94 E6FF             7  FSPAT:  AND 0FFH
001D39 EA96 B1               4      OR  C
                                
       EA97                     FDCCMD:
001D3A EA97 CDD9EA          17      CALL    COMSET
       EA9B                     FDCSMC  EQU $+1
001D3D EA9A 3E80             7      LD  A,080H      ;FDC COMMAND(Self-modifying code)
001D3F EA9C E620             7      AND 020H        ;Write data Write track
001D41 EA9E 3C               4      INC A
                                
       EA9F                     SST:
001D42 EA9F 0E00             7      LD  C,0
       EAA1                     SST1:
001D44 EAA1 0D               4      DEC C       ; 4
001D45 EAA2 20FD            12      JR  NZ,SST1     ;12 * 256 / 4 = About 1ms
001D47 EAA4 3D               4      DEC A
001D48 EAA5 20FA            12      JR  NZ,SST1
                                
001D4A EAA7 3C               4      INC A       ;A=1
001D4B EAA8 CDB0EA          17      CALL    READY
       EAAB                     SETMODE:
001D4E EAAB CDDCEA          17      CALL    DELAY0      ;Head select time
001D51 EAAE 3E81             7      LD  A,081H
       EAB0                     READY:
001D53 EAB0 32BAEA          13      LD  (WAITA),A
001D56 EAB3 E5              11      PUSH    HL
001D57 EAB4 26F8             7      LD  H,0F8H
       EAB6                     READY2:
001D59 EAB6 DBD8            11      IN  A,(0D8H)
001D5B EAB8 2F               4      CPL         ;データバスが負論理
       EABA                     WAITA   EQU $+1
001D5C EAB9 E681             7      AND 081H        ;NOT READY,BUSY
001D5E EABB 2808            12      JR  Z,READYE
001D60 EABD E3              19      EX  (SP),HL     ;wait 19clock
001D61 EABE E3              19      EX  (SP),HL     ; //
001D62 EABF 2B               6      DEC HL
001D63 EAC0 7C               4      LD  A,H
001D64 EAC1 B5               4      OR  L
001D65 EAC2 20F2            12      JR  NZ,READY2
001D67 EAC4 37               4      SCF
       EAC5                     READYE:
001D68 EAC5 E1              10      POP HL
001D69 EAC6 C9              10      RET
                                
       EAC7                     FDCRES:
001D6A EAC7 3600            10      LD  (HL),0
001D6C EAC9 0E08             7      LD  C,8
001D6E EACB 18C4            12      JR  FDCCMD2
                                
       EACD                     FDMOFF:
001D70 EACD F5              11      PUSH    AF
001D71 EACE AF               4      XOR A       ;Motor off(ドライブセレクト無効)
001D72 EACF D3DC            11      OUT (0DCH),A
001D74 EAD1 F1              10      POP AF
001D75 EAD2 C9              10      RET
                                
       EAD3                     SECSET:
001D76 EAD3 F5              11      PUSH    AF
001D77 EAD4 7B               4      LD  A,E
001D78 EAD5 2F               4      CPL         ;データバスが負論理
001D79 EAD6 D3DA            11      OUT (0DAH),A
001D7B EAD8 F1              10      POP AF
       EAD9                     COMSET:
001D7C EAD9 2F               4      CPL         ;データバスが負論理
001D7D EADA D3D8            11      OUT (0D8H),A
       EADC                     DELAY0:
001D7F EADC 3E1A             7      LD  A,26
       EADE                     DELAY:
001D81 EADE 3D               4      DEC A
001D82 EADF 20FD            12      JR  NZ,DELAY
001D84 EAE1 C9              10      RET
                                
       EAE2                     DRIVE:
001D85 EAE2 2A84EF          16      LD  HL,(_DRIVE)
001D88 EAE5 26EF             7      LD  H,_CYL0/256
001D8A EAE7 CBFD             8      SET 7,L
001D8C EAE9 7E               7      LD  A,(HL)
001D8D EAEA C9              10      RET
                                
       EAEB                     RNF:
001D8E EAEB CDE2EA          17      CALL    DRIVE
001D91 EAEE 36FF            10      LD  (HL),0FFH
001D93 EAF0 C9              10      RET
                                
001D94 EAF1 02                  RETRY:  DB  2
                                
                                
                                ;   FLOPPY DISK DRIVER
                                
       EAF2                     WTTRK:
001D95 EAF2 0601             7      LD  B,1
001D97 EAF4 3EF4             7      LD  A,0F4H
001D99 EAF6 1802            12      JR  WTTRK1
       EAF8                     FDWT:
001D9B EAF8 3EA0             7      LD  A,0A0H
       EAFA                     WTTRK1:
001D9D EAFA 329BEA          13      LD  (FDCSMC),A
       EAFD                     DWTBL:
001DA0 EAFD 78               4      LD  A,B
001DA1 EAFE 323DEB          13      LD  (WTBSMC),A
001DA4 EB01 3E02             7      LD  A,2     ;Retry count
001DA6 EB03 32F1EA          13      LD  (RETRY),A
                                
       EB06                     DWT0:
001DA9 EB06 D5              11      PUSH    DE
001DAA EB07 E5              11      PUSH    HL
001DAB EB08 CD4BEA          17      CALL    SEEK        ;Write disk
001DAE EB0B E1              10      POP HL
001DAF EB0C 383A            12      JR  C,ERRDW
001DB1 EB0E F3               4      DI
001DB2 EB0F 3A9BEA          13      LD  A,(FDCSMC)
001DB5 EB12 CDD3EA          17      CALL    SECSET
001DB8 EB15 0EDB             7      LD  C,0DBH
       EB17                     DWT1:
001DBA EB17 7E               7      LD  A,(HL)
001DBB EB18 2F               4      CPL         ;データバスが負論理
001DBC EB19 57               4      LD  D,A
                                
       EB1A                     DWT2:
001DBD EB1A DBD8            11      IN  A,(0D8H)
001DBF EB1C 2F               4      CPL         ;データバスが負論理
001DC0 EB1D 0F               4      RRCA
001DC1 EB1E 3008            12      JR  NC,DWT4
001DC3 EB20 0F               4      RRCA
001DC4 EB21 30F7            12      JR  NC,DWT2
       EB23                     DWT3:
001DC6 EB23 ED51            12      OUT (C),D
001DC8 EB25 23               6      INC HL
001DC9 EB26 18EF            12      JR  DWT1
                                
       EB28                     DWT4:
001DCB EB28 3D               4      DEC A
001DCC EB29 28F8            12      JR  Z,DWT3
001DCE EB2B 3C               4      INC A
001DCF EB2C FB               4      EI
001DD0 EB2D D1              10      POP DE
001DD1 EB2E 13               6      INC DE
001DD2 EB2F CDCDEA          17      CALL    FDMOFF
001DD5 EB32 2808            12      JR  Z,DISKOK_WT
001DD7 EB34 CD9FEB          17      CALL    DISKC
001DDA EB37 20CD            12      JR  NZ,DWT0
001DDC EB39 B7               4      OR  A
001DDD EB3A 2005            12      JR  NZ,ERRW
                                
       EB3C                     DISKOK_WT:
       EB3D                     WTBSMC  EQU $+1
001DDF EB3C 0601             7      LD  B,1
001DE1 EB3E 10BD            13      DJNZ    DWTBL
001DE3 EB40 C9              10      RET
                                
       EB41                     ERRW:
001DE4 EB41 3EFF             7      LD  A,0FFH
       EB43                     ERRZ:
001DE6 EB43 BF               4      CP  A
001DE7 EB44 37               4      SCF
001DE8 EB45 C3CDEA          10      JP  FDMOFF
                                
       EB48                     ERRDW:
001DEB EB48 D1              10      POP DE
001DEC EB49 CDB0EB          17      CALL    DELP
001DEF EB4C 20B8            12      JR  NZ,DWT0
001DF1 EB4E B7               4      OR  A
001DF2 EB4F 20F0            12      JR  NZ,ERRW
001DF4 EB51 C9              10      RET
                                
       EB52                     FDRD:
001DF5 EB52 3E80             7      LD  A,080H
001DF7 EB54 329BEA          13      LD  (FDCSMC),A
       EB57                     DRDBL:
001DFA EB57 78               4      LD  A,B
001DFB EB58 3291EB          13      LD  (RDBSMC),A
001DFE EB5B 3E02             7      LD  A,2     ;Retry count
001E00 EB5D 32F1EA          13      LD  (RETRY),A
       EB60                     DRD0:
001E03 EB60 D5              11      PUSH    DE
001E04 EB61 E5              11      PUSH    HL
001E05 EB62 CD4BEA          17      CALL    SEEK        ;Read disk
001E08 EB65 E1              10      POP HL
001E09 EB66 382D            12      JR  C,ERRDR
001E0B EB68 F3               4      DI
001E0C EB69 3A9BEA          13      LD  A,(FDCSMC)
001E0F EB6C CDD3EA          17      CALL    SECSET
       EB6F                     DRD1:
001E12 EB6F DBD8            11      IN  A,(0D8H)
001E14 EB71 2F               4      CPL         ;データバスが負論理
001E15 EB72 0F               4      RRCA
001E16 EB73 300A            12      JR  NC,DRD3
001E18 EB75 0F               4      RRCA
001E19 EB76 30F7            12      JR  NC,DRD1
001E1B EB78 DBDB            11      IN  A,(0DBH)
001E1D EB7A 2F               4      CPL         ;データバスが負論理
001E1E EB7B 77               7      LD  (HL),A
001E1F EB7C 23               6      INC HL
001E20 EB7D 18F0            12      JR  DRD1
                                
       EB7F                     DRD3:
001E22 EB7F B7               4      OR  A
001E23 EB80 FB               4      EI
001E24 EB81 D1              10      POP DE
001E25 EB82 13               6      INC DE
001E26 EB83 CDCDEA          17      CALL    FDMOFF
001E29 EB86 2808            12      JR  Z,DISKOK_RD
001E2B EB88 CD9FEB          17      CALL    DISKC
001E2E EB8B 20D3            12      JR  NZ,DRD0
001E30 EB8D B7               4      OR  A
001E31 EB8E 20B1            12      JR  NZ,ERRW
                                
       EB90                     DISKOK_RD:
       EB91                     RDBSMC  EQU $+1
001E33 EB90 0601             7      LD  B,1
001E35 EB92 10C3            13      DJNZ    DRDBL
001E37 EB94 C9              10      RET
                                
       EB95                     ERRDR:
001E38 EB95 D1              10      POP DE
001E39 EB96 CDB0EB          17      CALL    DELP
001E3C EB99 20C5            12      JR  NZ,DRD0
001E3E EB9B B7               4      OR  A
001E3F EB9C 20A3            12      JR  NZ,ERRW
001E41 EB9E C9              10      RET
       EB9F                     DISKC:
001E42 EB9F 1B               6      DEC DE
001E43 EBA0 CB5F             8      BIT 3,A
001E45 EBA2 C4EBEA          17      CALL    NZ,RNF
       EBA5                     DISKD:
001E48 EBA5 E5              11      PUSH    HL
001E49 EBA6 21F1EA          10      LD  HL,RETRY
001E4C EBA9 35              11      DEC (HL)
001E4D EBAA E1              10      POP HL
001E4E EBAB 200C            12      JR  NZ,ERR      ;Retry
001E50 EBAD B7               4      OR  A
001E51 EBAE 2809            12      JR  Z,ERR       ;Error
                                
       EBB0                     DELP:
001E53 EBB0 CDEBEA          17      CALL    RNF
001E56 EBB3 CDCDEA          17      CALL    FDMOFF
001E59 EBB6 3EFF             7      LD  A,0FFH
       EBB8                     AERRZ:
001E5B EBB8 BF               4      CP  A
       EBB9                     ERR:
001E5C EBB9 3EFF             7      LD  A,0FFH
001E5E EBBB C9              10      RET
                                
       EFB2                     FDMODE  EQU TVRAMTOP
[EOF:M7DISK.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   MZ-700/1500
                                
                                ;   EMM DRIVER
                                ;   1セクタ可変(256/512/1024)
                                
       EBBC                     EDWT:
001E5F EBBC F5              11      PUSH    AF
001E60 EBBD CDDBEB          17      CALL    EADR
001E63 EBC0 0600             7      LD  B,0
       EBC2                     EDWT1:
001E65 EBC2 EDB3                    OTIR
001E67 EBC4 3D               4      DEC A
001E68 EBC5 20FB            12      JR  NZ,EDWT1
001E6A EBC7 180B            12      JR  EDRW1
                                
       EBC9                     EDRD:
001E6C EBC9 C5              11      PUSH    BC
001E6D EBCA CDDBEB          17      CALL    EADR
001E70 EBCD 0600             7      LD  B,0
       EBCF                     EDRD1:
001E72 EBCF EDB2                    INIR
001E74 EBD1 3D               4      DEC A
001E75 EBD2 20FB            12      JR  NZ,EDRD1
       EBD4                     EDRW1:
001E77 EBD4 F1              10      POP AF
001E78 EBD5 83               4      ADD A,E ;セクタを進める
001E79 EBD6 5F               4      LD  E,A
001E7A EBD7 8A               4      ADC A,D
001E7B EBD8 93               4      SUB E
001E7C EBD9 57               4      LD  D,A
001E7D EBDA C9              10      RET
                                
       EBDB                     EADR:
001E7E EBDB C5              11      PUSH    BC
001E7F EBDC D5              11      PUSH    DE
001E80 EBDD EB               4      EX  DE,HL
001E81 EBDE 29              11      ADD HL,HL
001E82 EBDF DD4E0D          19      LD  C,(IX+00DH) ;DPB_0D_MAXSEC
001E85 EBE2 DD460C          19      LD  B,(IX+00CH) ;DPB_0C_MAXCYL
001E88 EBE5 09              11      ADD HL,BC
001E89 EBE6 DD4E13          19      LD  C,(IX+013H) ;DPB_13_UNITNO
001E8C EBE9 ED49            12      OUT (C),C
001E8E EBEB 0C               4      INC C
001E8F EBEC ED69            12      OUT (C),L
001E91 EBEE 0C               4      INC C
001E92 EBEF ED61            12      OUT (C),H
001E94 EBF1 0C               4      INC C
001E95 EBF2 EB               4      EX  DE,HL
001E96 EBF3 D1              10      POP DE
001E97 EBF4 DD460F          19      LD  B,(IX+00FH) ;DPB_0F_BPS
001E9A EBF7 F1              10      POP AF
       EBF8                     EADR1:              ;読み込むセクタ数と1クラスタのセクタ数を掛ける
001E9B EBF8 CB18             8      RR  B
001E9D EBFA D8              11      RET C
001E9E EBFB 87               4      ADD A,A
001E9F EBFC 18FA            12      JR  EADR1
                                
                                ;   CMOS BACKUP MEMORY DRIVER(32KB)
                                ;   1セクタ256
                                
       EBFE                     CDWT:
001EA1 EBFE 78               4      LD  A,B
001EA2 EBFF DD4E13          19      LD  C,(IX+013H) ;DPB_13_UNITNO
001EA5 EC02 ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001EA7 EC04 ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001EA9 EC06 01FA00          10      LD  BC,000FAH
       EC09                     CDWT1:
001EAC EC09 EDB3                    OTIR            ;W)データ書き込み・アドレスカウンタ+1
001EAE EC0B 13               6      INC DE
001EAF EC0C 3D               4      DEC A
001EB0 EC0D 20FA            12      JR  NZ,CDWT1
001EB2 EC0F A7               4      AND A
001EB3 EC10 C9              10      RET
                                
       EC11                     CDRD:
001EB4 EC11 78               4      LD  A,B
001EB5 EC12 DD4E13          19      LD  C,(IX+013H) ;DPB_13_UNITNO
001EB8 EC15 ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001EBA EC17 ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001EBC EC19 01F900          10      LD  BC,000F9H
       EC1C                     CDRD1:
001EBF EC1C EDB2                    INIR            ;R)データ読み出し・アドレスカウンタ+1
001EC1 EC1E 13               6      INC DE
001EC2 EC1F 3D               4      DEC A
001EC3 EC20 20FA            12      JR  NZ,CDRD1
001EC5 EC22 A7               4      AND A
001EC6 EC23 C9              10      RET
                                
                                ;   RAM DISK DRIVER (64KB)
                                ;   1セクタ256
                                
       EC24                     RDWT:
001EC7 EC24 3EB3             7      LD  A,0B3H      ;OTIR
001EC9 EC26 1802            12      JR  RDRW
       EC28                     RDRD:
001ECB EC28 3EB2             7      LD  A,0B2H      ;INIR
       EC2A                     RDRW:
001ECD EC2A 3237EC          13      LD  (RDRW1+1),A
                                
001ED0 EC2D 78               4      LD  A,B
001ED1 EC2E 43               4      LD  B,E     ;B=アドレスカウンタ上位(X1の様な16bitのI/Oアクセス)
001ED2 EC2F 0EEB             7      LD  C,0EBH
001ED4 EC31 ED71            12      OUT (C),0       ;0=アドレスカウンタ下位
001ED6 EC33 0D               4      DEC C       ;EA(R)データ読み出し・アドレスカウンタ+1
001ED7 EC34 0600             7      LD  B,0
       EC36                     RDRW1:
001ED9 EC36 EDB2                    INIR            ;自己書き換え(INIR/OTIR)
001EDB EC38 13               6      INC DE
001EDC EC39 3D               4      DEC A
001EDD EC3A 20FA            12      JR  NZ,RDRW1
001EDF EC3C A7               4      AND A
001EE0 EC3D C9              10      RET
[EOF:M7DISK2.ASM:UTF_8]
                                
                                    INCLUDE "M7TABLE.ASM"
                                
                                ;   LSX-Dodgers TABLE 表示関連のテーブル
                                ;   MZ-700/1500
                                
       EC3E                     AT_TABLE:
001EE1 EC3E                         DS  TABLEAD-AT_TABLE
                                
       EC40                     KEY_TABLE:
001EE3 EC40 12081E1F1C1D5C2F        DB  12H,08H,1EH,1FH,1CH,1DH,5CH,'/'
001EEB EC48 5C5E2D2030392C2E        DB  5CH,'^','-',20H,'0','9',',','.'
001EF3 EC50 3132333435363738        DB  '1','2','3','4','5','6','7','8'
001EFB EC58 6162636465666768        DB  'a','b','c','d','e','f','g','h'
001F03 EC60 696A6B6C6D6E6F70        DB  'i','j','k','l','m','n','o','p'
001F0B EC68 7172737475767778        DB  'q','r','s','t','u','v','w','x'
001F13 EC70 797A405B5D000000        DB  'y','z','@','[',']',00H,00H,00H
001F1B EC78 001B3D09003B3A0D        DB  00H,1BH,'=',09H,00H,';',':',0DH
       EC80                     SHIFT_TABLE:
001F23 EC80 12081E1F1C1D5F3F        DB  12H,08H,1EH,1FH,1CH,1DH,'_','?'
001F2B EC88 7C7E3D2030293C3E        DB  '|','~','=',20H,'0',')','<','>'
001F33 EC90 2122232425262728        DB  '!','"','#','$','%','&',27H,'('
001F3B EC98 4142434445464748        DB  'A','B','C','D','E','F','G','H'
001F43 ECA0 494A4B4C4D4E4F50        DB  'I','J','K','L','M','N','O','P'
001F4B ECA8 5152535455565758        DB  'Q','R','S','T','U','V','W','X'
001F53 ECB0 595A607B7D000000        DB  'Y','Z','`','{','}',00H,00H,00H
001F5B ECB8 00003D09002B2A0D        DB  00H,00H,'=',09H,00H,'+','*',0DH
       ECC0                     CTRL_TABLE:
001F63 ECC0 12081E1F1C1D3F2F        DB  12H,08H,1EH,1FH,1CH,1DH,'?','/'
001F6B ECC8 2A2B2D2030392C2E        DB  '*','+','-',20H,'0','9',',','.'
001F73 ECD0 3132333435363738        DB  '1','2','3','4','5','6','7','8'
001F7B ECD8 0102030405060708        DB  01H,02H,03H,04H,05H,06H,07H,08H
001F83 ECE0 090A0B0C0D0E0F10        DB  09H,0AH,0BH,0CH,0DH,0EH,0FH,10H
001F8B ECE8 1112131415161718        DB  11H,12H,13H,14H,15H,16H,17H,18H
001F93 ECF0 191A1B5B5D000000        DB  19H,1AH,1BH,'[',']',00H,00H,00H
001F9B ECF8 00003D09003B3A0D        DB  00H,00H,'=',09H,00H,';',':',0DH
                                
                                ;   アドレス下位1バイトが0になるように
       ED00                     CD_TABLE:
001FA3 ED00 00D1D2D3D4D5D6D0        DB  $00,$D1,$D2,$D3,$D4,$D5,$D6,$D0 ;月火水木金土日
001FAB ED08 D8DCD9DADBD7CFCE        DB  $D8,$DC,$D9,$DA,$DB,$D7,$CF,$CE ;年円時分秒
001FB3 ED10 601F5F5E1E1B7978        DB  $60,$1F,$5F,$5E,$1E,$1B,$79,$78 ;
001FBB ED18 5C5D1C1D6DCACDC7        DB  $5C,$5D,$1C,$1D,$6D,$CA,$CD,$C7 ;
001FC3 ED20 0061626364656667        DB  $00,$61,$62,$63,$64,$65,$66,$67 ; !"#$%&'
001FCB ED28 68696B6A2F2A2E2D        DB  $68,$69,$6B,$6A,$2F,$2A,$2E,$2D ;()*+,-./
001FD3 ED30 2021222324252627        DB  $20,$21,$22,$23,$24,$25,$26,$27 ;01234567
001FDB ED38 28294F2C512B5749        DB  $28,$29,$4F,$2C,$51,$2B,$57,$49 ;89:;<=>?
001FE3 ED40 5501020304050607        DB  $55,$01,$02,$03,$04,$05,$06,$07 ;@ABCDEFG
001FEB ED48 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;HIJKLMNO
001FF3 ED50 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;PQRSTUVW
001FFB ED58 18191A52DD54507C        DB  $18,$19,$1A,$52,$DD,$54,$50,$7C ;XYZ[\]^_
002003 ED60 5901020304050607        DB  $59,$01,$02,$03,$04,$05,$06,$07 ;`abcdefg   ATB:1
00200B ED68 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;hijklmno   ATB:1
002013 ED70 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;pqrstuvw   ATB:1
00201B ED78 18191ACB35CC705A        DB  $18,$19,$1A,$CB,$35,$CC,$70,$5A ;xyz{|}~    ATB:1
002023 ED80 415346444847B49E        DB  $41,$53,$46,$44,$48,$47,$B4,$9E ;トランプ〇●をぁ   ATB:1
00202B ED88 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ぃぅぇぉゃゅょっ   ATB:1
002033 ED90 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーあいうえおかき   ATB:1
00203B ED98 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;くけこさしすせそ   ATB:1
002043 EDA0 F0BD9DB1B5B9B49E        DB  $F0,$BD,$9D,$B1,$B5,$B9,$B4,$9E ;　。「」、・ヲァ
00204B EDA8 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ィゥェォャョュッ
002053 EDB0 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーアイウエオカキ
00205B EDB8 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;クケコサシスセソ
002063 EDC0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;タチツテトナニヌ
00206B EDC8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ネノハヒフヘホマ
002073 EDD0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;ミムメモヤユヨラ
00207B EDD8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;リルレロワン゛゜
002083 EDE0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;たちつてとねにぬ   ATB:1
00208B EDE8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ねのはひふへほま   ATB:1
002093 EDF0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;みむめもやゆよら   ATB:1
00209B EDF8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;りるれろわん゛゜   ATB:1
       EE00                     DC_TABLE:
0020A3 EE00 2041424344454647        DB  $20,$41,$42,$43,$44,$45,$46,$47 ;0
0020AB EE08 48494A4B4C4D4E4F        DB  $48,$49,$4A,$4B,$4C,$4D,$4E,$4F
0020B3 EE10 5051525354555657        DB  $50,$51,$52,$53,$54,$55,$56,$57 ;1
0020BB EE18 58595A151A1B1411        DB  $58,$59,$5A,$15,$1A,$1B,$14,$11
0020C3 EE20 3031323334353637        DB  $30,$31,$32,$33,$34,$35,$36,$37 ;2
0020CB EE28 38392D3D3B2F2E2C        DB  $38,$39,$2D,$3D,$3B,$2F,$2E,$2C
0020D3 EE30 00000000007C0000        DB  $00,$00,$00,$00,$00,$7C,$00,$00 ;3
0020DB EE38 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
0020E3 EE40 0080000083008285        DB  $00,$80,$00,$00,$83,$00,$82,$85 ;4
0020EB EE48 843F00000000003A        DB  $84,$3F,$00,$00,$00,$00,$00,$3A
0020F3 EE50 5E3C5B815D40003E        DB  $5E,$3C,$5B,$81,$5D,$40,$00,$3E ;5
0020FB EE58 00607F0018191312        DB  $00,$60,$7F,$00,$18,$19,$13,$12
002103 EE60 1021222324252627        DB  $10,$21,$22,$23,$24,$25,$26,$27 ;6
00210B EE68 28292B2A001C0000        DB  $28,$29,$2B,$2A,$00,$1C,$00,$00
002113 EE70 7E00000000000000        DB  $7E,$00,$00,$00,$00,$00,$00,$00 ;7
00211B EE78 171600005F000000        DB  $17,$16,$00,$00,$5F,$00,$00,$00
002123 EE80 00C19A9F9C92CA97        DB  $00,$C1,$9A,$9F,$9C,$92,$CA,$97 ;8
00212B EE88 98C6CFC9D8D3D0D7        DB  $98,$C6,$CF,$C9,$D8,$D3,$D0,$D7
002133 EE90 9EC09DC496C5CBC3        DB  $9E,$C0,$9D,$C4,$96,$C5,$CB,$C3 ;9
00213B EE98 9BDDC2DB99A2878C        DB  $9B,$DD,$C2,$DB,$99,$A2,$87,$8C
002143 EEA0 DCC7CC91939495D4        DB  $DC,$C7,$CC,$91,$93,$94,$95,$D4 ;A
00214B EEA8 D5D6CECDDAD2D9C8        DB  $D5,$D6,$CE,$CD,$DA,$D2,$D9,$C8
002153 EEB0 D1A3888D86A4898E        DB  $D1,$A3,$88,$8D,$86,$A4,$89,$8E ;B
00215B EEB8 DFA58A8FDEA18B90        DB  $DF,$A5,$8A,$8F,$DE,$A1,$8B,$90
002163 EEC0 000000000000001F        DB  $00,$00,$00,$00,$00,$00,$00,$1F ;C
00216B EEC8 00001D7B7D1E0F0E        DB  $00,$00,$1D,$7B,$7D,$1E,$0F,$0E
002173 EED0 070102030405060D        DB  $07,$01,$02,$03,$04,$05,$06,$0D ;D
00217B EED8 080A0B0C095C0000        DB  $08,$0A,$0B,$0C,$09,$5C,$00,$00
002183 EEE0 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00 ;E
00218B EEE8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
002193 EEF0 A000000000000000        DB  $A0,$00,$00,$00,$00,$00,$00,$00 ;F
00219B EEF8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
[EOF:M7TABLE.ASM:SHIFT_JIS]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
       EF00                     AT_WORK:
0021A3 EF00                         DS  WORKAD-AT_WORK
                                
       EF00                     CPM_BOOT:
0021A3 EF00 C30000          10      JP  0
       EF03                     _SYS00:     ;(BDOS)プログラム終了
       EF03                     CPM_WBOOT:
0021A6 EF03 C3FECF          10      JP  WBOOT1
       EF06                     CPM_CONST:
0021A9 EF06 C347D9          10      JP  CONSTX
       EF09                     _SYS07:     ;(BDOS)コンソール直接入力
       EF09                     CPM_CONIN:
0021AC EF09 C3DDD8          10      JP  FLGET
       EF0C                     CPM_CONOUT:
0021AF EF0C C3ECDA          10      JP  CONOUT1
                                
       EF0F                     DECBF:
0021B2 EF0F                         DS  5
0021B7 EF14 00                  FDRV    DB  0
0021B8 EF15                     FNAME   DS  36
0021DC EF39                     SFILE:  DS  33      ;DRV FILENAME
0021FD EF5A                     HLBUF:  DS  3       ;Random record buffer
                                
002200 EF5D 0000                LEFTX:  DW  0
002202 EF5F 0000                DTAX:   DW  0
                                
       EF61                     ZERO:
       EF61                     BEEPD:
002204 EF61 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
00220C EF69 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
       EF62                     RTC_YY  EQU BEEPD+1
       EF63                     RTC_MW  EQU BEEPD+2
       EF64                     RTC_DD  EQU BEEPD+3
       EF65                     RTC_TT  EQU BEEPD+4
       EF66                     RTC_MM  EQU BEEPD+5
       EF67                     RTC_SS  EQU BEEPD+6
                                
002213 EF70 00                  CHECK:  DB  0
                                
002214 EF71 4F4B24              OK: DB  "OK$"
002217 EF74                         DS  5
00221C EF79 4572726F722124      COMERM: DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
002223 EF80 FF                  _CYL0:  DB  0FFH    ;Cylinder
002224 EF81 FF                  _CYL1:  DB  0FFH    ;Cylinder
002225 EF82 FF                  _CYL2:  DB  0FFH    ;Cylinder
002226 EF83 FF                  _CYL3:  DB  0FFH    ;Cylinder
002227 EF84 00                  _DRIVE: DB  0   ;unit number
002228 EF85 00                  _SEEKSP:DB  0   ;Seek speed
002229 EF86 FF                  _ISEEK: DB  0FFH    ;
00222A EF87 00                  _DVSW:  DB  0
00222B EF88 00                  _DRV:   DB  0
00222C EF89 FF                  _DSK:   DB  0FFH
00222D EF8A 8000                _DTA:   DW  00080H
00222F EF8C 0000                _CTC:   DW  0
002231 EF8E 0000                _TXADR: DW  0
002233 EF90 0000                _KEYPS: DW  0
002235 EF92 00FF                _KEYD:  DW  0FF00H  ;キーデータ
002237 EF94 8310                _KEYSP: DB  KEYSP_L,KEYSP_H ;オートリピートの速度
002239 EF96 71                  _COLORF:DB  COLORF  ;色
00223A EF97 19                  _LINE:  DB  LINE
                                
00223B EF98 0000                _FCB:   DW  0   ;SEARCH FILES
00223D EF9A 0000                _FBPS:  DW  0   ;    //
00223F EF9C 0000                _FBAD:  DW  0   ;    //
002241 EF9E 00                  _FBCNT: DB  0   ;    //
002242 EF9F 00                  _FILEN: DB  0   ;    //
002243 EFA0 00                  _DIRF:  DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
002244 EFA1                         DS  1
002245 EFA2 00                  _WTFATF:DB  0   ;FATバッファの更新フラグ
002246 EFA3                         DS  1
002247 EFA4 00                  _WTDBF: DB  0   ;データバッファの更新フラグ
002248 EFA5 FF                  _DBDRV: DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
002249 EFA6 0000                _DBSEC: DW  0   ;データバッファにあるデータを読み込んだセクタ番号
00224B EFA8 0000                _DPB:   DW  0
       EFAA                     _FATDRV:
00224D EFAA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
00224E EFAB 00                  _FATIX: DB  0   ;FATバッファに読み込んでいるインデックス
       EFAC                     _FAKEFREE:
00224F EFAC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
002251 EFAE                         DS  2
                                
       EFB0                     CRTCD:  
002253 EFB0 6F                      DB  06FH
       EFB1                     _WIDTH: 
002254 EFB1 28                      DB  WIDTH
       EFB2                     TVRAMTOP:
002255 EFB2 5938                    DB  059H,038H
002257 EFB4 1F02                    DB  01FH,002H
       EFB6                     _LINE2:
002259 EFB6 19                      DB  019H
       EFB7                     WKE4:
00225A EFB7 1C                      DB  01CH
       EFB8                     WKE6:
00225B EFB8 00                      DB  000H
       EFB9                     WK40:
00225C EFB9 07                      DB  007H
       EFBA                     _PAGE_MINUS:
00225D EFBA 18FC                    DW  0-WIDTH*LINE
       EFBC                     _WIDTH_MINUS:
00225F EFBC D8FF                    DW  0-WIDTH
       EFBE                     WK30:
002261 EFBE 0C                      DB  00CH
       EFBF                     WK31:
       EFBF                     WK1FD0:
002262 EFBF 20                      DB  020H
                                
002263 EFC0 0000                CTC0:   DW  INTCTCE
002265 EFC2 0000                CTC1:   DW  INTCTCE
002267 EFC4 0000                CTC2:   DW  INTCTC2
002269 EFC6 0000                CTC3:   DW  INTCTCE
00226B EFC8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
00226D EFCA C325DC          10  _INKEY: JP  INKEY
002270 EFCD C3D8D9          10  _PRINT: JP  PRINT
002273 EFD0 C380DC          10  _SCRN:  JP  SCRN
002276 EFD3 C395DB          10  _POS:   JP  POS
002279 EFD6 C3BADA          10  _LOC:   JP  LOC
       EFD9                     _CHGDRV:
00227C EFD9 C347E9          10      JP  CHGDRV
       EFDC                     _GETDPB:
00227F EFDC C312EA          10      JP  GETDPB
       EFDF                     _FFLUSH:
002282 EFDF C330EA          10      JP  FFLUSH
       EFE2                     _RDFATX:
002285 EFE2 C320E6          10      JP  RDFATX
002288 EFE5 C348E7          10  _RDFAT: JP  RDFAT
00228B EFE8 C3F2EA          10  _WTTRK: JP  WTTRK
00228E EFEB C352EB          10  _FDRD:  JP  FDRD
002291 EFEE C3F8EA          10  _FDWT:  JP  FDWT
       EFF1                     _BPB2DPB:
002294 EFF1 C3D5E7          10      JP  BPB2DPB
002297 EFF4                         DS  3
       EFF7                     _GNCL:
00229A EFF7 C3C2E6          10  GNCPAT: JP  GNCL        ; self-modifying code
       EFFA                     _SNCL:
00229D EFFA C3E5E6          10  SNCPAT: JP  SNCL        ; self-modifying code
0022A0 EFFD C346D0          10  _COMANL:JP  COMANL
                                
       F000                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       F000                     STABLE:
                                ;0
0022A3 F000 03EFB0D8BCD855DE        DW  _SYS00,_SYS01,_SYS02,_SYS03
0022AB F008 C8D5C8D5C1D809EF        DW  _SYS04,_SYS05,_SYS06,_SYS07
0022B3 F010 C9D8CAD513D93FD9        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
0022BB F018 DFD5E4D5F3D506D6        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
0022C3 F020 5AD6A1D6EAD620D7        DW  _SYS10,_SYS11,_SYS12,_SYS13
0022CB F028 28D73ED753D74BD7        DW  _SYS14,_SYS15,_SYS16,_SYS17
0022D3 F030 9AD79FD7A4D7AAD7        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
0022DB F038 C8D5D0D7C8D5D4D7        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
0022E3 F040 C8D58AD792D7DBD7        DW  _SYS20,_SYS21,_SYS22,_SYS23
0022EB F048 01D8C8D5DDE2C2E3        DW  _SYS24,_ERROR,_SYS26,_SYS27
0022F3 F050 92D70AD855D955DE        DW  _SYS28,_SYS5C,_SYS2A,_SYS2B
0022FB F058 5BD955DEC8D52DD8        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
002303 F060 27D8C8D5C8D5C8D5        DW  _SYS30,_ERROR,_ERROR,_ERROR
00230B F068 C8D5C8D5C8D5C8D5        DW  _ERROR,_ERROR,_ERROR,_ERROR
002313 F070 C8D555DE55DE4ED8        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
00231B F078 ABD5                    DW  _DOS2
                                
00231D F07A                         DS  2
00231F F07C 00F2                _FATBF: DW  FATBF
002321 F07E 00FA                _DTBUF: DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       F080                     CTRLTB:
002323 F080 3DDA3DDA73DA68DB        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
00232B F088 62DB9FDA53DBFCDA        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
002333 F090 49DA64DA6BDBCDDA        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
00233B F098 50DBB5DA7DDB3DDA        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
002343 F0A0 3DDA3DDAC5DA3DDA        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
00234B F0A8 3DDA3DDA3DDA3DDA        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
002353 F0B0 3DDA3DDA50DBD4DA        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
00235B F0B8 2CDA50DA59DA6BDB        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
002363 F0C0 0200                M2D:    DW  2
002365 F0C2 FD02                    DB  0FDH,2
002367 F0C4 6401                    DW  356
002369 F0C6 FF0728090182            DB  0FFH,7,40,9,1,082H
00236F F0CC 0500A7000800            DW  5,0A7H,8
                                
002375 F0D2 0200                M2HD:   DW  2
002377 F0D4 FE01                    DB  0FEH,1
002379 F0D6 C704                    DW  1223
00237B F0D8 FE064D080184            DB  0FEH,6,77,8,1,084H
002381 F0DE 0500A7000900            DW  5,0A7H,9
                                
002387 F0E4                         DS  6
                                
00238D F0EA 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
00238F F0EC 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
002391 F0EE 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
002393 F0F0 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       F0F4                     SDDATAE:
                                
002397 F0F4                     SCDIR:  DS  2       ;+14 +15
002399 F0F6                     SFBPS:  DS  2       ;FBPS
00239B F0F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
00239D F0FA 0000                _FATPS: DW  0
00239F F0FC 0000                _DIRPS: DW  0
0023A1 F0FE 0000                _CLPS:  DW  0
                                
       F100                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "M7DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   MZ-700/1500
                                
       F100                     DEVICE:
                                
                                ;   A:
                                
0023A3 F100 0200                    DW  2   ;DPB_00_FATLN
0023A5 F102 EBEF                    DW  _FDRD   ;DPB_02_DRD
0023A7 F104 EEEF                    DW  _FDWT   ;DPB_04_DWT
0023A9 F106 FD                      DB  0FDH    ;DPB_06_FATID
0023AA F107 02                      DB  2   ;DPB_07_SECPCL
0023AB F108 6401                    DW  356 ;DPB_08_MAXCL
0023AD F10A FF                      DB  0FFH    ;DPB_0A_FDMODE  0FFH=2D / 0FEH=2HD
0023AE F10B 07                      DB  7   ;DPB_0B_DIRSCNT
0023AF F10C 28                      DB  40  ;DPB_0C_MAXCYL
0023B0 F10D 09                      DB  9   ;DPB_0D_MAXSEC  Number of sectors
0023B1 F10E 01                      DB  1   ;DPB_0E_FATPS
0023B2 F10F 82                      DB  082H    ;DPB_0F_BPS
0023B3 F110 0500                    DW  5   ;DPB_10_DIRPS
0023B5 F112 27                      DB  027H    ;DPB_12_DEVICE  Device Number
0023B6 F113 00                      DB  0   ;DPB_13_UNITNO
0023B7 F114 0800                    DW  8   ;DPB_14_ADDCL16
0023B9 F116 0000                    DW  0   ;DPB_16
0023BB F118 0000                    DW  0   ;DPB_18
0023BD F11A 0000                    DW  0   ;DPB_1A_SDIR
0023BF F11C 46444430                DB  "FDD0"  ;DPB_1C_NAME
                                
                                ;   B:
                                
0023C3 F120 0200                    DW  2   ;DPB_00_FATLN
0023C5 F122 EBEF                    DW  _FDRD   ;DPB_02_DRD
0023C7 F124 EEEF                    DW  _FDWT   ;DPB_04_DWT
0023C9 F126 FD                      DB  0FDH    ;DPB_06_FATID
0023CA F127 02                      DB  2   ;DPB_07_SECPCL
0023CB F128 6401                    DW  356 ;DPB_08_MAXCL
0023CD F12A FF                      DB  0FFH    ;DPB_0A_FDMODE  0FFH=2D / 0FEH=2HD
0023CE F12B 07                      DB  7   ;DPB_0B_DIRSCNT
0023CF F12C 28                      DB  40  ;DPB_0C_MAXCYL
0023D0 F12D 09                      DB  9   ;DPB_0D_MAXSEC  Number of sectors
0023D1 F12E 01                      DB  1   ;DPB_0E_FATPS
0023D2 F12F 82                      DB  082H    ;DPB_0F_BPS
0023D3 F130 0500                    DW  5   ;DPB_10_DIRPS
0023D5 F132 27                      DB  027H    ;DPB_12_DEVICE  Device Number
0023D6 F133 01                      DB  1   ;DPB_13_UNITNO
0023D7 F134 0800                    DW  8   ;DPB_14_ADDCL16
0023D9 F136 0000                    DW  0   ;DPB_16
0023DB F138 0000                    DW  0   ;DPB_18
0023DD F13A 0000                    DW  0   ;DPB_1A_SDIR
0023DF F13C 46444431                DB  "FDD1"  ;DPB_1C_NAME
                                
                                ;   C:
                                
0023E3 F140 0100                    DW  1   ;DPB_00_FATLN
0023E5 F142 11EC                    DW  CDRD    ;DPB_02_DRD
0023E7 F144 FEEB                    DW  CDWT    ;DPB_04_DWT
0023E9 F146 FA                      DB  0FAH    ;DPB_06_FATID
0023EA F147 01                      DB  1   ;DPB_07_SECPCL
0023EB F148 7A00                    DW  122 ;DPB_08_MAXCL
0023ED F14A 00                      DB  0   ;DPB_0A_FDMODE
0023EE F14B 06                      DB  6   ;DPB_0B_DIRSCNT
0023EF F14C 00                      DB  0   ;DPB_0C_MAXCYL
0023F0 F14D 00                      DB  0   ;DPB_0D_MAXSEC
0023F1 F14E 01                      DB  1   ;DPB_0E_FATPS
0023F2 F14F 01                      DB  1   ;DPB_0F_BPS
0023F3 F150 0200                    DW  2   ;DPB_10_DIRPS
0023F5 F152 0C                      DB  00CH    ;DPB_12_DEVICE
0023F6 F153 F8                      DB  0F8H    ;DPB_13_UNITNO
0023F7 F154 0600                    DW  6   ;DPB_14_ADDCL16
0023F9 F156 0000                    DW  0   ;DPB_16
0023FB F158 0000                    DW  0   ;DPB_18
0023FD F15A 0000                    DW  0   ;DPB_1A_SDIR
0023FF F15C 434D4F53                DB  "CMOS"  ;DPB_1C_NAME
                                
                                ;   D:
                                
002403 F160                         DS  32
                                
                                ;   E:
                                
002423 F180 0000                    DW  0   ;DPB_00_FATLN
002425 F182 C9EB                    DW  EDRD    ;DPB_02_DRD
002427 F184 BCEB                    DW  EDWT    ;DPB_04_DWT
002429 F186 FA                      DB  0FAH    ;DPB_06_FATID
00242A F187 02                      DB  2   ;DPB_07_SECPCL
00242B F188 0000                    DW  0   ;DPB_08_MAXCL
00242D F18A 00                      DB  0   ;DPB_0A_FDMODE
00242E F18B 10                      DB  16  ;DPB_0B_DIRSCNT
00242F F18C 00                      DB  0   ;DPB_0C_MAXCYL
002430 F18D 00                      DB  0   ;DPB_0D_MAXSEC
002431 F18E 01                      DB  1   ;DPB_0E_FATPS
002432 F18F 01                      DB  1   ;DPB_0F_BPS
002433 F190 0000                    DW  0   ;DPB_10_DIRPS
002435 F192 26                      DB  026H    ;DPB_12_DEVICE
002436 F193 00                      DB  0   ;DPB_13_UNITNO
002437 F194 0000                    DW  0   ;DPB_14_ADDCL16
002439 F196 0000                    DW  0   ;DPB_16
00243B F198 0000                    DW  0   ;DPB_18
00243D F19A 0000                    DW  0   ;DPB_1A_SDIR
00243F F19C 454D4D30                DB  "EMM0"  ;DPB_1C_NAME
                                
                                ;   F:
                                
002443 F1A0 0200                    DW  2   ;DPB_00_FATLN
002445 F1A2 28EC                    DW  RDRD    ;DPB_02_DRD
002447 F1A4 24EC                    DW  RDWT    ;DPB_04_DWT
002449 F1A6 FA                      DB  0FAH    ;DPB_06_FATID
00244A F1A7 01                      DB  1   ;DPB_07_SECPCL
00244B F1A8 F600                    DW  246 ;DPB_08_MAXCL
00244D F1AA 00                      DB  0   ;DPB_0A_FDMODE
00244E F1AB 09                      DB  9   ;DPB_0B_DIRSCNT
00244F F1AC 00                      DB  0   ;DPB_0C_MAXCYL
002450 F1AD 00                      DB  0   ;DPB_0D_MAXSEC
002451 F1AE 01                      DB  1   ;DPB_0E_FATPS
002452 F1AF 01                      DB  1   ;DPB_0F_BPS
002453 F1B0 0300                    DW  3   ;DPB_10_DIRPS
002455 F1B2 0F                      DB  00FH    ;DPB_12_DEVICE
002456 F1B3 00                      DB  0   ;DPB_13_UNITNO
002457 F1B4 0A00                    DW  10  ;DPB_14_ADDCL16
002459 F1B6 0000                    DW  0   ;DPB_16
00245B F1B8 0000                    DW  0   ;DPB_18
00245D F1BA 0000                    DW  0   ;DPB_1A_SDIR
00245F F1BC 52414D46                DB  "RAMF"  ;DPB_1C_NAME
                                
                                ;   G:
                                
002463 F1C0                         DS  32
                                
                                ;   H:
002483 F1E0                         DS  3
002486 F1E3 00                      DB  0
[EOF:M7DPB.ASM:UTF_8]
                                
       A487                         ORG $$+OFFSET   ;$DEPHASE
       A487                     LAST_ADR:
                                
                                    END
[EOF:M7.ASM:UTF_8]
