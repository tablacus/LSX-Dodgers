                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   LSX-Dodgers for MZ-700/1500
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "M7DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MZ-700/1500
                                
       0001                     MAC EQU 1   ;MZ-700/1500
       0000                     DEV EQU 0
                                
       011D                     VER_6F  EQU 0011DH
                                
       8080                     RUN EQU 08080H
       8000                     OFFSET  EQU RUN-128
       CF06                     BDOS    EQU 0CF06H
       F000                     WORKAD  EQU 0F000H
       ED40                     TABLEAD EQU 0ED40H
       F300                     KEYBF   EQU 0F300H
       F330                     FATBF   EQU 0F330H
       FB30                     DTBUF   EQU 0FB30H
       FF30                     KBUF    EQU 0FF30H
       FFD9                     TRAP38  EQU 0FFD9H
       0028                     WIDTH   EQU 40
       0019                     LINE    EQU 25
       0070                     COLORF  EQU 070H
       0014                     KEYSP_H EQU 20
       0083                     KEYSP_L EQU 131
       0009                     COMS    EQU 9
       0004                     MAX_SEC_SZ_H    EQU 4       ;1セクタ1024バイトのサポート(2:off 4:on)
       0100                     BUFFER  EQU 00100H
       D0E4                     S27BUF_COM  EQU S27BUF
[EOF:M7DEF.ASM:SHIFT_JIS]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0006                     VER_2   EQU 6
       0001                     VER_3   EQU 1
       1D01                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0001                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0161                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0004                     _DVSW   EQU 00004H
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       F323                     DISKVE  EQU 0F323H
       F325                     BREAKV  EQU 0F325H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 8000                         ORG OFFSET
                                                    ;MZTヘッダ128バイト
000000 8000 01                      DB  1           ;ファイルモード
000001 8001 4C44202020202020        DB  "LD           "     ;ファイル名(13)
            2020202020          
00000E 800E 535953                  DB  "SYS"           ;拡張子(3)
000011 8011 0D                      DB  $0D
000012 8012 4625                    DW  LAST_ADR-RUN        ;サイズ
000014 8014 8080                    DW  RUN         ;開始アドレス
000016 8016 8080                    DW  RUN         ;実行アドレス
000018 8018                         DS  104
                                
                                    INCLUDE "M7INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   MZ-700/1500
                                
000080 8080 C38780          10      JP  START
000083 8083 011D                    DW  MACW
000085 8085 6101                    DW  VER
                                
       8087                     START:
000087 8087 F3               4      DI
000088 8088 ED56             8      IM  1
00008A 808A 318780          10      LD  SP,START
00008D 808D CD9B80          17      CALL    INIT        ;NZならAUTOEXECを実行
000090 8090 210000          10      LD  HL,0
000093 8093 E5              11      PUSH    HL
000094 8094 C8              11      RET Z
000095 8095 118081          10      LD  DE,AUTOD
000098 8098 C3FDF0          10      JP  _COMANL
                                
       809B                     INIT:
00009B 809B D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFFH)
00009D 809D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00009F 809F 21E881          10      LD  HL,INITE
0000A2 80A2 1106CF          10      LD  DE,BDOS
0000A5 80A5 01DE23          10      LD  BC,LAST_ADR-INITE
0000A8 80A8 EDB0                    LDIR
0000AA 80AA 21B781          10      LD  HL,M7BEEPD
0000AD 80AD 1162F0          10      LD  DE,BEEPD+1
0000B0 80B0 010A00          10      LD  BC,M7BEEPE-M7BEEPD
0000B3 80B3 EDB0                    LDIR
                                
0000B5 80B5 210000          10      LD  HL,0
0000B8 80B8 065C             7      LD  B,05CH
0000BA 80BA 3E                      DB  03EH    ;LD A,??
0000BB 80BB EF              12      RST 28H
0000BC 80BC CD68DC          17      CALL    FILL_MEMORY
0000BF 80BF 06A4             7      LD  B,0A4H
0000C1 80C1 AF               4      XOR A
0000C2 80C2 320400          13      LD  (_DVSW),A
0000C5 80C5 CD68DC          17      CALL    FILL_MEMORY
                                
0000C8 80C8 3EC3             7      LD  A,0C3H      ;JP
0000CA 80CA 2103F0          10      LD  HL,CPM_WBOOT
0000CD 80CD 320000          13      LD  (00000H),A
0000D0 80D0 220100          16      LD  (00001H),HL ;IPL
                                
0000D3 80D3 2106CF          10      LD  HL,BDOS
0000D6 80D6 320500          13      LD  (00005H),A
0000D9 80D9 220600          16      LD  (00006H),HL ;BDOS
                                
0000DC 80DC 21D9FF          10      LD  HL,TRAP38   ;TRAP38
0000DF 80DF 322800          13      LD  (00028H),A
0000E2 80E2 222900          16      LD  (00029H),HL ;RST 028H
                                
0000E5 80E5 323800          13      LD  (00038H),A
0000E8 80E8 210ECF          10      LD  HL,IO_INT8253
0000EB 80EB 223900          16      LD  (00039H),HL
                                
0000EE 80EE 215BF0          10      LD  HL,_DISKE+1
0000F1 80F1 2223F3          16      LD  (DISKVE),HL
0000F4 80F4 21F5F0          10      LD  HL,_BREAK+1
0000F7 80F7 2225F3          16      LD  (BREAKV),HL
                                
0000FA 80FA 3EF0             7      LD  A,CPM_BOOT/256
0000FC 80FC 320B00          13      LD  (0000BH),A
                                
0000FF 80FF 3EE9             7      LD  A,0E9H      ;JP (HL)
000101 8101 320F00          13      LD  (0000FH),A
                                                ;CHECK PCG(MZ-1500)
000104 8104 2100E8          10      LD  HL,0E800H
000107 8107 46               7      LD  B,(HL)
000108 8108 F3               4      DI
000109 8109 3E01             7      LD  A,1
00010B 810B D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00010D 810D 4E               7      LD  C,(HL)
00010E 810E 79               4      LD  A,C
00010F 810F C6A5             7      ADD A,0A5H
000111 8111 5F               4      LD  E,A
000112 8112 73               7      LD  (HL),E
000113 8113 D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
000115 8115 71               7      LD  (HL),C
000116 8116 3E01             7      LD  A,1
000118 8118 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00011A 811A 7E               7      LD  A,(HL)
00011B 811B BB               4      CP  E
00011C 811C D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
00011E 811E 70               7      LD  (HL),B
00011F 811F FB               4      EI
000120 8120 2804            12      JR  Z,MZ1500
000122 8122 AF               4      XOR A       ;MZ-700はPCGバンクが存在しない
000123 8123 32C0F2          13      LD  (GRAMFL),A
       8126                     MZ1500:
000126 8126 DD2180F2        14      LD  IX,EMMFL
00012A 812A CD7581          17      CALL    CHECK_EMM_BPB
00012D 812D FEEB             7      CP  0EBH
00012F 812F 2817            12      JR  Z,EMM_BPB
000131 8131 DD360D02        19      LD  (IX+DPB_MAXSEC),2   ;BPBが512バイト目から始まる場合を調べる
000135 8135 CD7581          17      CALL    CHECK_EMM_BPB
000138 8138 DDBE06          19      CP  (IX+DPB_FATID)
00013B 813B 200B            12      JR  NZ,EMM_BPB
00013D 813D DD360D00        19      LD  (IX+DPB_MAXSEC),0   ;BPBが先頭の場合に戻す
                                
000141 8141 2103E0          10      LD  HL,0E003H       ;SOUND MASK (MZ-1500)
000144 8144 AF               4      XOR A
000145 8145 CD3FCF          17      CALL    WRMMIO
       8148                     EMM_BPB:
000148 8148 218C81          10      LD  HL,INIMES
00014B 814B CD88D4          17      CALL    MSX
       814E                     INIT1:
00014E 814E F3               4      DI
00014F 814F 1100FF          10      LD  DE,0FF00H
000152 8152 0600             7      LD  B,0
000154 8154 CD26D3          17      CALL    ZERO_MEMORY_DE
000157 8157 21CAFF          10      LD  HL,EXTBIO
00015A 815A 36C9            10      LD  (HL),0C9H   ;RET
00015C 815C 23               6      INC HL
00015D 815D 060E             7      LD  B,TRAP38-EXTBIO-1
00015F 815F 3E                      DB  03EH    ;LD A,??
000160 8160 EF              12      RST 28H
000161 8161 CD68DC          17      CALL    FILL_MEMORY
000164 8164 21C181          10      LD  HL,AT_TRAP38
000167 8167 11D9FF          10      LD  DE,TRAP38
00016A 816A 012700          10      LD  BC,AT_TRAPE-AT_TRAP38
00016D 816D EDB0                    LDIR
                                
00016F 816F CD1FDB          17      CALL    CHKEY
000172 8172 FE03             7      CP  3
000174 8174 C9              10      RET
                                
       8175                     CHECK_EMM_BPB:
000175 8175 D5              11      PUSH    DE
000176 8176 110000          10      LD  DE,0
000179 8179 CD92EA          17      CALL    EADR
00017C 817C D1              10      POP DE
00017D 817D ED78            12      IN  A,(C)
00017F 817F C9              10      RET
                                
000180 8180 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
000189 8189 413A00              AUTODV: DB  "A:",0
                                
00018C 818C 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for MZ-700/1500 v"
            6765727320666F72    
            204D5A2D3730302F    
            313530302076        
0001AA 81AA 312E                    DB  030H + VER_1, '.'
0001AC 81AC 3631                    DB  030H + VER_2 ,030H + VER_3
0001AE 81AE 67                      DB  'g'
0001AF 81AF 2047616B750D0A          DB  " Gaku",0DH,0AH
0001B6 81B6 00                      DB  0
                                
       81B7                     M7BEEPD:
0001B7 81B7 0801                    DB  8,1
0001B9 81B9 0736                    DB  7,036H
0001BB 81BB 04F9                    DB  4,0F9H
0001BD 81BD 0403                    DB  4,3
0001BF 81BF 0301                    DB  3,1         ;SOUND MASK(MZ-1500)
       81C1                     M7BEEPE:
                                
       81C1                     AT_TRAP38:
0001C1 FFD9                         ORG TRAP38,AT_TRAP38-OFFSET
0001C1 FFD9 210000          10      LD  HL,0
0001C4 FFDC E3              19      EX  (SP),HL
0001C5 FFDD 3E24             7      LD  A,'$'
0001C7 FFDF CD79D7          17      CALL    MSG_A
0001CA FFE2 2B               6      DEC HL
0001CB FFE3 7C               4      LD  A,H
0001CC FFE4 CDE8FF          17      CALL    PRHX
0001CF FFE7 7D               4      LD  A,L
       FFE8                     PRHX:
0001D0 FFE8 F5              11      PUSH    AF
0001D1 FFE9 07               4      RLCA
0001D2 FFEA 07               4      RLCA
0001D3 FFEB 07               4      RLCA
0001D4 FFEC 07               4      RLCA
0001D5 FFED CDF1FF          17      CALL    PRHX2
0001D8 FFF0 F1              10      POP AF
       FFF1                     PRHX2:
0001D9 FFF1 E60F             7      AND 00FH
0001DB FFF3 FE0A             7      CP  10
0001DD FFF5 3F               4      CCF
0001DE FFF6 CE30             7      ADC A,'0'
0001E0 FFF8 27               4      DAA
0001E1 FFF9 C379D7          10      JP  MSG_A
0001E4 FFFC                         DS  4
0001E8 81E8                         ORG $$+OFFSET,$$    ;$DEPHASE
       81E8                     AT_TRAPE:
                                
       81E8                     INITE:
0001E8 CF06                         ORG BDOS,INITE-OFFSET
                                
0001E8 CF06 C309CF          10      JP  IO_BDOS
[EOF:M7INIT.ASM:SHIFT_JIS]
                                    INCLUDE "M7BANK.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                ;   VRAM/KEY/TIMER(0D000H-0EFFFH)にアクセスするので0D000H-0FFFFHに置けない部分
                                ;
                                
       CF09                     IO_BDOS:
0001EB CF09 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001ED CF0B C348D4          10      JP  BDOS0
                                
       CF0E                     IO_INT8253:
0001F0 CF0E F3               4      DI
0001F1 CF0F F5              11      PUSH    AF
0001F2 CF10 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001F4 CF12 3E01             7      LD  A,1
0001F6 CF14 3206E0          13      LD  (0E006H),A  ;8253 Ch.2 カウンタ
0001F9 CF17 AF               4      XOR A
0001FA CF18 3206E0          13      LD  (0E006H),A  ;8253 Ch.2 カウンタ
0001FD CF1B D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001FF CF1D C323D7          10      JP  INT8253
                                
       CF20                     RDKEYDATA:
000202 CF20 F3               4      DI
000203 CF21 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000205 CF23 3200E0          13      LD  (0E000H),A
000208 CF26 3A01E0          13      LD  A,(E001H)
00020B CF29 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00020D CF2B FB               4      EI
00020E CF2C C9              10      RET
                                
       CF2D                     RD556VSYNC:
00020F CF2D F3               4      DI
000210 CF2E D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000212 CF30 3A02E0          13      LD  A,(0E002H)
000215 CF33 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000217 CF35 FB               4      EI
000218 CF36 C9              10      RET
                                
       CF37                     RDMMIO:
000219 CF37 F3               4      DI
00021A CF38 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00021C CF3A 7E               7      LD  A,(HL)
00021D CF3B D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00021F CF3D FB               4      EI
000220 CF3E C9              10      RET
                                
       CF3F                     WRMMIO:
000221 CF3F F3               4      DI
000222 CF40 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000224 CF42 77               7      LD  (HL),A
000225 CF43 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000227 CF45 FB               4      EI
000228 CF46 C9              10      RET
                                
       CF47                     RDMMIO_BC:
000229 CF47 F3               4      DI
00022A CF48 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00022C CF4A 0A               7      LD  A,(BC)
00022D CF4B D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00022F CF4D FB               4      EI
000230 CF4E C9              10      RET
                                
       CF4F                     WRMMIO_BC:
000231 CF4F F3               4      DI
000232 CF50 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000234 CF52 02               7      LD  (BC),A
000235 CF53 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000237 CF55 FB               4      EI
000238 CF56 C9              10      RET
                                
       CF57                     IO_PRINT:
000239 CF57 F3               4      DI
00023A CF58 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00023C CF5A 77               7      LD  (HL),A
00023D CF5B CBDC             8      SET 3,H
00023F CF5D 71               7      LD  (HL),C
000240 CF5E D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000242 CF60 FB               4      EI
000243 CF61 C9              10      RET
                                
       CF62                     IO_CLR:
000244 CF62 F3               4      DI
000245 CF63 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF65                     C1AX1:
000247 CF65 7A               4      LD  A,D
000248 CF66 C6D0             7      ADD A,0D0H
00024A CF68 57               4      LD  D,A
00024B CF69 AF               4      XOR A
00024C CF6A 12               7      LD  (DE),A      ;Text
00024D CF6B CBDA             8      SET 3,D
       CF6E                     ICSMC   EQU $+1
00024F CF6D 3E00             7      LD  A,0     ;自己書き換え
000251 CF6F 12               7      LD  (DE),A      ;Color
000252 CF70 13               6      INC DE
000253 CF71 7A               4      LD  A,D
000254 CF72 D6D8             7      SUB 0D8H
000256 CF74 57               4      LD  D,A
000257 CF75 2118FC          10      LD  HL,0-WIDTH*LINE
00025A CF78 19              11      ADD HL,DE
00025B CF79 30EA            12      JR  NC,C1AX1
00025D CF7B E1              10      POP HL
00025E CF7C D1              10      POP DE
00025F CF7D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000261 CF7F FB               4      EI
000262 CF80 C9              10      RET
                                
       CF81                     IO_CLLINE:
000263 CF81 F3               4      DI
000264 CF82 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF84                     CLLINE1:
000266 CF84 CB9C             8      RES 3,H
000268 CF86 77               7      LD  (HL),A      ;Text
000269 CF87 CBDC             8      SET 3,H
00026B CF89 71               7      LD  (HL),C      ;Color
00026C CF8A 23               6      INC HL
00026D CF8B 10F7            13      DJNZ    CLLINE1
00026F CF8D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000271 CF8F FB               4      EI
000272 CF90 C9              10      RET
                                
       CF91                     IO_INSBS:
000273 CF91 F3               4      DI
000274 CF92 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF94                     IO_INSBS1:
000276 CF94 CB9C             8      RES 3,H
000278 CF96 5E               7      LD  E,(HL)
000279 CF97 77               7      LD  (HL),A
00027A CF98 7B               4      LD  A,E
00027B CF99 CBDC             8      SET 3,H
00027D CF9B 5E               7      LD  E,(HL)
00027E CF9C 71               7      LD  (HL),C
00027F CF9D 4B               4      LD  C,E
       CF9E                     IO_INCDEC   EQU $   ; 自己書き換え
000280 CF9E 23               6      INC HL      ;INS->INC HL or BS->DEC HL
000281 CF9F 10F3            13      DJNZ    IO_INSBS1
000283 CFA1 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000285 CFA3 FB               4      EI
000286 CFA4 C9              10      RET
                                
       CFA5                     IO_SCRUP:
000287 CFA5 F3               4      DI
000288 CFA6 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CFA8                     SCRUP1:
00028A CFA8 2815            12      JR  Z,SCRCL
00028C CFAA D5              11      PUSH    DE
00028D CFAB E5              11      PUSH    HL
00028E CFAC CBDA             8      SET 3,D
000290 CFAE CBDC             8      SET 3,H
000292 CFB0 012800          10      LD  BC,WIDTH
000295 CFB3 EDB0                    LDIR
000297 CFB5 E1              10      POP HL
000298 CFB6 D1              10      POP DE
000299 CFB7 012800          10      LD  BC,WIDTH
00029C CFBA EDB0                    LDIR
00029E CFBC 3D               4      DEC A
00029F CFBD 18E9            12      JR  SCRUP1
                                
       CFBF                     SCRCL:
0002A1 CFBF 0628             7      LD  B,WIDTH
0002A3 CFC1 EB               4      EX  DE,HL
0002A4 CFC2 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0002A6 CFC4 CD72D9          17      CALL    CLLINE
0002A9 CFC7 E1              10      POP HL
0002AA CFC8 D1              10      POP DE
0002AB CFC9 C1              10      POP BC
0002AC CFCA C9              10      RET
                                
       CFCB                     RD_PCG:
0002AD CFCB F3               4      DI
0002AE CFCC D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
0002B0 CFCE 4E               7      LD  C,(HL)
       CFCF                     RW_PCG:
0002B1 CFCF D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
0002B3 CFD1 FB               4      EI
0002B4 CFD2 C9              10      RET
                                
       CFD3                     WR_PCG:
0002B5 CFD3 F3               4      DI
0002B6 CFD4 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
0002B8 CFD6 71               7      LD  (HL),C
0002B9 CFD7 18F6            12      JR  RW_PCG
                                
       CFD9                     IO_MON:
0002BB CFD9 D3E4            11      OUT (0E4H),A    ;MONITOR ROM(0000H-0FFFH) & VRAM/KEY/TIMER(D000H-FFFFH)
0002BD CFDB C7              12      RST 0
                                
       CFDC                     INITINT:
0002BE CFDC D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0002C0 CFDE 2107E0          10      LD  HL,0E007H   ;HL=0E007H 8253 コントロール
0002C3 CFE1 36B0            10      LD  (HL),0B0H   ;Ch.2 カウンタの下位バイト→上位バイトの順に連続してアクセス Mode 0 16ビットバイナリ
0002C5 CFE3 3674            10      LD  (HL),074H   ;Ch.1 カウンタの下位バイト→上位バイトの順に連続してアクセス Mode 2 16ビットバイナリ
0002C7 CFE5 2D               4      DEC L       ;0E006H 8253 Ch.2 カウンタ
0002C8 CFE6 3602            10      LD  (HL),2
0002CA CFE8 3600            10      LD  (HL),0
0002CC CFEA 2D               4      DEC L       ;0E005H 8253 Ch.1 カウンタ
0002CD CFEB 77               7      LD  (HL),A
0002CE CFEC 3600            10      LD  (HL),0
0002D0 CFEE 7D               4      LD  A,L     ;L=5
0002D1 CFEF 3203E0          13      LD  (0E003H),A  ;8255 コントロールポートでポートC(0E002H)のINTMSKを1にする
0002D4 CFF2 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0002D6 CFF4 C9              10      RET
                                
       CFF5                     BANKE:
0002D7 CFF5                         DS  0CFFEH-BANKE
[EOF:M7BANK.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   MZ-700/1500
                                
       CFFE                     WBOOT1:
0002E0 CFFE D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)　ここは0CFFEH
0002E2 D000 D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFHH)
0002E4 D002 F3               4      DI
0002E5 D003 3A94F0          13      LD  A,(_KEYSP_L)
0002E8 D006 CDDCCF          17      CALL    INITINT
0002EB D009 ED7B0600        20      LD  SP,(SYSTEM+1)
0002EF D00D FB               4      EI
0002F0 D00E 2192F0          10      LD  HL,_KEYD
0002F3 D011 3600            10      LD  (HL),0
0002F5 D013 CD1FDB          17      CALL    CHKEY
0002F8 D016 CD66D7          17      CALL    KEYBC_IFBREAK
0002FB D019 3E04             7      LD  A,4
0002FD D01B CD79D7          17      CALL    MSG_A
[EOF:M7CCP.ASM:UTF_8]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D01E                     COMMAND:
000300 D01E 3A90EB          13      LD  A,(FCB_BAT)
000303 D021 B7               4      OR  A
000304 D022 C260D1          10      JP  NZ,C_BAT1
000307 D025 CDD4D0          17      CALL    SETDTA1
00030A D028 3A0400          13      LD  A,(_DVSW)
00030D D02B C641             7      ADD A,'A'
00030F D02D CD79D7          17      CALL    MSG_A
000312 D030 3E3E             7      LD  A,'>'
000314 D032 CD79D7          17      CALL    MSG_A
000317 D035 3E50             7      LD  A,80
000319 D037 12               7      LD  (DE),A
00031A D038 CDD9D7          17      CALL    _SYS0A      ;(BDOS)文字列入力
00031D D03B CD55D2          17      CALL    LTNL
       D03E                     COMMAND2:
000320 D03E 118200          10      LD  DE,DTA1+2
000323 D041 CDFDF0          17      CALL    _COMANL
000326 D044 DC0CD7          17      CALL    C,SHOW_ERROR
000329 D047 18D5            12      JR  COMMAND
                                
       D049                     COMANL:
00032B D049 CDBDDB          17      CALL    FILE
00032E D04C 3A19F0          13      LD  A,(FNAME+4)
000331 D04F FE20             7      CP  020H
000333 D051 201C            12      JR  NZ,COMB2
000335 D053 D5              11      PUSH    DE
000336 D054 1115F0          10      LD  DE,FNAME
000339 D057 1A               7      LD  A,(DE)
00033A D058 FE20             7      CP  020H
00033C D05A 2844            12      JR  Z,SDVSW
00033E D05C 1B               6      DEC DE
00033F D05D 1A               7      LD  A,(DE)
000340 D05E C6FF             7      ADD A,0FFH
000342 D060 3809            12      JR  C,COMB
000344 D062 13               6      INC DE
                                
000345 D063 2112D4          10      LD  HL,COMTB
000348 D066 0609             7      LD  B,COMS
00034A D068 CD4ADE          17      CALL    CPNAME
       D06B                     COMB:
00034D D06B D1              10      POP DE
00034E D06C D20BD7          10      JP  NC,JPHL
       D06F                     COMB2:
000351 D06F EB               4      EX  DE,HL
000352 D070 223DD1          16      LD  (COMSWC),HL
000355 D073 F5              11      PUSH    AF
000356 D074 CDF5D0          17      CALL    CEXE4
000359 D077 F1              10      POP AF
00035A D078 2115F0          10      LD  HL,FNAME
00035D D07B 116D00          10      LD  DE,FCB2FN   ;COMMAND NAME
000360 D07E 010B00          10      LD  BC,11
000363 D081 EDB0                    LDIR
000365 D083 112FEB          10      LD  DE,PATHD
       D086                     CEX1:
000368 D086 1A               7      LD  A,(DE)
000369 D087 FE20             7      CP  020H
00036B D089 D8              11      RET C
00036C D08A CDB2DB          17      CALL    FILEC
00036F D08D D5              11      PUSH    DE
000370 D08E 216D00          10      LD  HL,FCB2FN   ;COMMAND NAME
000373 D091 1115F0          10      LD  DE,FNAME
000376 D094 010B00          10      LD  BC,11
000379 D097 EDB0                    LDIR
00037B D099 CDF5D0          17      CALL    CEXE4
00037E D09C D1              10      POP DE
00037F D09D 13               6      INC DE
000380 D09E 18E6            12      JR  CEX1
                                
       D0A0                     SDVSW:
000382 D0A0 F1              10      POP AF
000383 D0A1 3A14F0          13      LD  A,(FDRV)
000386 D0A4 3D               4      DEC A
000387 D0A5 5F               4      LD  E,A
000388 D0A6 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
00038A D0A8 1831            12      JR  SYSTEM0
                                
       D0AA                     OPEN1:
00038C D0AA 2114F0          10      LD  HL,FDRV
       D0AD                     OPEN:
00038F D0AD 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D0AF                     OPEN3:
000391 D0AF D5              11      PUSH    DE
000392 D0B0 116BEB          10      LD  DE,DTA_CCP
000395 D0B3 CDD1D0          17      CALL    SETDTA
000398 D0B6 EB               4      EX  DE,HL
000399 D0B7 CDDBD0          17      CALL    SYSTEM0
00039C D0BA D1              10      POP DE
00039D D0BB C9              10      RET
                                
       D0BC                     OPEN2:
00039E D0BC 0E12             7      LD  C,012H
0003A0 D0BE 18EF            12      JR  OPEN3
                                
       D0C0                     DEFCB:              ;Z=Ok NZ=Error
0003A2 D0C0 116BEB          10      LD  DE,DTA_CCP
0003A5 D0C3 CDD9D0          17      CALL    SYSC0F
                                
0003A8 D0C6 118CEB          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
0003AB D0C9 0604             7      LD  B,4
0003AD D0CB CD26D3          17      CALL    ZERO_MEMORY_DE
       D0CE                     SETDTA100:
0003B0 D0CE 110001          10      LD  DE,BUFFER
       D0D1                     SETDTA:
0003B3 D0D1 C34CD6          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D0D4                     SETDTA1:
0003B6 D0D4 118000          10      LD  DE,DTA1
0003B9 D0D7 18F8            12      JR  SETDTA
                                
       D0D9                     SYSC0F:
0003BB D0D9 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D0DB                     SYSTEM0:
0003BD D0DB CD0500          17      CALL    SYSTEM
0003C0 D0DE B7               4      OR  A
0003C1 D0DF C9              10      RET
                                
       D0E0                     C_CD:
0003C2 D0E0 0E5A             7      LD  C,05AH
0003C4 D0E2 18F7            12      JR  SYSTEM0
                                
       D0E4                     S27BUF:
0003C6 D0E4 2100FE          10      LD  HL,0-BUFFER-00100H  ;バッファー+スタック予備(0100H)
       D0E7                     S27BUF2:
0003C9 D0E7 39              11      ADD HL,SP
0003CA D0E8 2E00             7      LD  L,0
0003CC D0EA 7C               4      LD  A,H
0003CD D0EB E6F8             7      AND 0F8H
0003CF D0ED 67               4      LD  H,A
       D0EE                     S27DTA:
0003D0 D0EE 116BEB          10      LD  DE,DTA_CCP
       D0F1                     S27:
0003D3 D0F1 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
0003D5 D0F3 18E6            12      JR  SYSTEM0
                                
       D0F5                     CEXE4:
0003D7 D0F5 211DF0          10      LD  HL,FNAME+8
0003DA D0F8 7E               7      LD  A,(HL)
0003DB D0F9 FE20             7      CP  020H
0003DD D0FB 2007            12      JR  NZ,CEXE7
0003DF D0FD 3E3F             7      LD  A,'?'
0003E1 D0FF 77               7      LD  (HL),A
0003E2 D100 23               6      INC HL
0003E3 D101 77               7      LD  (HL),A
0003E4 D102 23               6      INC HL
0003E5 D103 77               7      LD  (HL),A
       D104                     CEXE7:
0003E6 D104 CDAAD0          17      CALL    OPEN1
       D107                     CEXE5:
0003E9 D107 C0              11      RET NZ
0003EA D108 2A75EB          16      LD  HL,(DTA_CCP+1+9)
0003ED D10B 7C               4      LD  A,H
0003EE D10C CDD9DE          17      CALL    CAP
0003F1 D10F 67               4      LD  H,A
0003F2 D110 7D               4      LD  A,L
0003F3 D111 CDD9DE          17      CALL    CAP
0003F6 D114 6F               4      LD  L,A
0003F7 D115 3A74EB          13      LD  A,(DTA_CCP+1+8)
0003FA D118 CDD9DE          17      CALL    CAP
0003FD D11B D642             7      SUB 'B'
0003FF D11D 282C            12      JR  Z,C_BAT
000401 D11F 3D               4      DEC A       ;'C'
000402 D120 2805            12      JR  Z,C_EXE
       D122                     CEXE6:
000404 D122 CDBCD0          17      CALL    OPEN2
000407 D125 18E0            12      JR  CEXE5
                                
       D127                     C_EXE:
000409 D127 7C               4      LD  A,H
00040A D128 FE4D             7      CP  'M'
00040C D12A 20F6            12      JR  NZ,CEXE6
                                
00040E D12C CDC0D0          17      CALL    DEFCB
000411 D12F CDE4D0          17      CALL    S27BUF_COM
000414 D132 3D               4      DEC A
000415 D133 37               4      SCF
000416 D134 C0              11      RET NZ
000417 D135 7C               4      LD  A,H
000418 D136 B5               4      OR  L
000419 D137 37               4      SCF
00041A D138 C8              11      RET Z
00041B D139 CDD4D0          17      CALL    SETDTA1
00041E D13C 110000          10      LD  DE,0                ; self-modifying code
       D13D                     COMSWC  EQU $-2
000421 D13F ED7B0600        20      LD  SP,(SYSTEM+1)
000425 D143 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
000426 D144 6F               4      LD  L,A
000427 D145 E5              11      PUSH    HL              ; push $0000 (reboot address)
000428 D146 24               4      INC H
000429 D147 E5              11      PUSH    HL              ; push $0100 (TPA address)
00042A D148 C3F1D2          10      JP  SETFCB              ; and JP $0100
                                
       D14B                     C_BAT:
00042D D14B 114154          10      LD  DE,'A'+'T'*256
000430 D14E ED52            15      SBC HL,DE
000432 D150 20D0            12      JR  NZ,CEXE6
                                
000434 D152 CDC0D0          17      CALL    DEFCB
                                
000437 D155 216BEB          10      LD  HL,DTA_CCP
00043A D158 1190EB          10      LD  DE,FCB_BAT
00043D D15B 012500          10      LD  BC,37
000440 D15E EDB0                    LDIR
       D160                     C_BAT1:
000442 D160 CDCED0          17      CALL    SETDTA100
000445 D163 CD97D1          17      CALL    FGETC_BAT
000448 D166 218100          10      LD  HL,DTA1+1
00044B D169 2025            12      JR  NZ,END_BATCH
00044D D16B FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
00044F D16D 38F1            12      JR  C,C_BAT1
000451 D16F 3620            10      LD  (HL),' '
000453 D171 23               6      INC HL
       D172                     C_BAT2:
000454 D172 77               7      LD  (HL),A
000455 D173 23               6      INC HL
000456 D174 7D               4      LD  A,L
000457 D175 3C               4      INC A       ;L==0FFH
000458 D176 2809            12      JR  Z,RUN_BATCH
00045A D178 CD97D1          17      CALL    FGETC_BAT
00045D D17B 2004            12      JR  NZ,RUN_BATCH
00045F D17D FE20             7      CP  020H
000461 D17F 30F1            12      JR  NC,C_BAT2
       D181                     RUN_BATCH:
000463 D181 7D               4      LD  A,L
000464 D182 D67F             7      SUB DTA1-1
000466 D184 328000          13      LD  (DTA1),A
000469 D187 FE04             7      CP  4
00046B D189 3805            12      JR  C,END_BATCH
00046D D18B 3600            10      LD  (HL),0
00046F D18D C33ED0          10      JP  COMMAND2
       D190                     END_BATCH:
000472 D190 AF               4      XOR A       ;バッチファイルを閉じる
000473 D191 3290EB          13      LD  (FCB_BAT),A
000476 D194 C300F0          10      JP  CPM_BOOT
                                
       D197                     FGETC_BAT:
000479 D197 1190EB          10      LD  DE,FCB_BAT
       D19A                     FGETC:              ;1文字ずつ読み込む
00047C D19A E5              11      PUSH    HL      ;Z:成功
00047D D19B 210100          10      LD  HL,1
000480 D19E CDF1D0          17      CALL    S27
000483 D1A1 E1              10      POP HL
000484 D1A2 3A0001          13      LD  A,(BUFFER)
000487 D1A5 C9              10      RET
                                
       D1A6                     C_DEL:
000488 D1A6 CDF1D2          17      CALL    SETFCB
00048B D1A9 CD8FD7          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
00048E D1AC 0E13             7      LD  C,013H
000490 D1AE 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       D1B0                     C_REN:
000492 D1B0 CDF1D2          17      CALL    SETFCB
000495 D1B3 3E10             7      LD  A,010H      ;ディレクトリも対象にする
000497 D1B5 326900          13      LD  (FCB1+13),A ;属性
00049A D1B8 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       D1BA                     CDEL1:
00049C D1BA 115C00          10      LD  DE,FCB1
00049F D1BD CD0500          17      CALL    SYSTEM
0004A2 D1C0 C6FF             7      ADD A,0FFH
0004A4 D1C2 C9              10      RET
                                
       D1C3                     C_DIR:
0004A5 D1C3 CDB2DB          17      CALL    FILEC
0004A8 D1C6 2115F0          10      LD  HL,FDRV+1
0004AB D1C9 CD07D4          17      CALL    CWILD1
0004AE D1CC 3EF1             7      LD  A,0F1H
0004B0 D1CE 3221F0          13      LD  (FDRV+13),A
0004B3 D1D1 CDAAD0          17      CALL    OPEN1
       D1D4                     CDIR1:
0004B6 D1D4 B7               4      OR  A
0004B7 D1D5 2008            12      JR  NZ,PDSKF
0004B9 D1D7 CD22D2          17      CALL    P_NAME
0004BC D1DA CDBCD0          17      CALL    OPEN2
0004BF D1DD 18F5            12      JR  CDIR1
       D1DF                     PDSKF:
0004C1 D1DF 3A14F0          13      LD  A,(FDRV)
0004C4 D1E2 5F               4      LD  E,A
0004C5 D1E3 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
0004C7 D1E5 CD0500          17      CALL    SYSTEM
0004CA D1E8 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
0004CB D1E9 C601             7      ADD A,001H
0004CD D1EB D8              11      RET C       ;Aが0FFHだった場合
0004CE D1EC 3E06             7      LD  A,8-2
       D1EE                     PDS1:               ;HL=未使用クラスタの総数
0004D0 D1EE 3C               4      INC A
0004D1 D1EF CB19             8      RR  C
0004D3 D1F1 30FB            12      JR  NC,PDS1
       D1F3                     PDS2:               ;B←論理セクタのサイズの上位8ビット
0004D5 D1F3 3C               4      INC A
0004D6 D1F4 CB18             8      RR  B
0004D8 D1F6 30FB            12      JR  NC,PDS2
0004DA D1F8 47               4      LD  B,A
                                
0004DB D1F9 110000          10      LD  DE,0
       D1FC                     PDS3:
0004DE D1FC 29              11      ADD HL,HL
0004DF D1FD EB               4      EX  DE,HL
0004E0 D1FE ED6A            15      ADC HL,HL
0004E2 D200 EB               4      EX  DE,HL
0004E3 D201 10F9            13      DJNZ    PDS3
       D203                     PDSKF1:
0004E5 D203 CD8FD2          17      CALL    PRDEC_DEHL
0004E8 D206 11C0EB          10      LD  DE,FREE
0004EB D209 CD79D4          17      CALL    _SYS09      ;(BDOS)文字列出力
0004EE D20C CD7CD2          17      CALL    PUTDRV
0004F1 D20F 3E5C             7      LD  A,05CH      ;\
0004F3 D211 CD79D7          17      CALL    MSG_A
0004F6 D214 2A22F0          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
0004F9 D217 AF               4      XOR A
0004FA D218 11FEFF          10      LD  DE,0-2
0004FD D21B 19              11      ADD HL,DE
0004FE D21C 23               6      INC HL
0004FF D21D DC8CD2          17      CALL    C,PRDEC_HL
000502 D220 1833            12      JR  LTNL
                                
       D222                     P_NAME:
000504 D222 3A6CEB          13      LD  A,(DTA_CCP+1)
000507 D225 FE2E             7      CP  '.'
000509 D227 C8              11      RET Z
                                
00050A D228 3A77EB          13      LD  A,(DTA_CCP+1+00BH)
00050D D22B F5              11      PUSH    AF
00050E D22C CB67             8      BIT 4,A
000510 D22E 2808            12      JR  Z,DIR3
000512 D230 11B5EB          10      LD  DE,DIRMES
000515 D233 CD79D4          17      CALL    _SYS09      ;(BDOS)文字列出力
000518 D236 180A            12      JR  DIR6
       D238                     DIR3:
00051A D238 ED5B8AEB        20      LD  DE,(DTA_CCP+1+01EH)
00051E D23C 2A88EB          16      LD  HL,(DTA_CCP+1+01CH)
000521 D23F CD8FD2          17      CALL    PRDEC_DEHL
       D242                     DIR6:
000524 D242 F1              10      POP AF
000525 D243 0F               4      RRCA
000526 D244 9F               4      SBC A,A
000527 D245 E60A             7      AND '*'-020H
000529 D247 C620             7      ADD A,020H
00052B D249 CD79D7          17      CALL    MSG_A
00052E D24C CD7CD2          17      CALL    PUTDRV
000531 D24F 216CEB          10      LD  HL,DTA_CCP+1
000534 D252 CDCFD2          17      CALL    FPRNT
                                
       D255                     LTNL:
000537 D255 1E03             7      LD  E,3
000539 D257 C3CDF0          10      JP  _PRINT
                                
       D25A                     C_PATH:
00053C D25A CD93DC          17      CALL    SPCUT
00053F D25D 212FEB          10      LD  HL,PATHD
000542 D260 FE21             7      CP  021H
000544 D262 300C            12      JR  NC,CPATH0
       D264                     CPATHP:
000546 D264 7E               7      LD  A,(HL)
000547 D265 23               6      INC HL
000548 D266 FE20             7      CP  020H
00054A D268 3F               4      CCF
00054B D269 30EA            12      JR  NC,LTNL
00054D D26B CD79D7          17      CALL    MSG_A
000550 D26E 18F4            12      JR  CPATHP
       D270                     CPATH0:
000552 D270 FE3B             7      CP  ';'
000554 D272 2001            12      JR  NZ,CPATH1
000556 D274 13               6      INC DE
       D275                     CPATH1:
000557 D275 EB               4      EX  DE,HL
000558 D276 013B00          10      LD  BC,PATHX
00055B D279 EDB0                    LDIR
00055D D27B C9              10      RET
                                
       D27C                     PUTDRV:
00055E D27C 3A14F0          13      LD  A,(FDRV)
000561 D27F CDC6DC          17      CALL    GETDRV1
000564 D282 C641             7      ADD A,'A'
000566 D284 CD79D7          17      CALL    MSG_A
000569 D287 3E3A             7      LD  A,':'
       D289                     MSG_AR:
00056B D289 C379D7          10      JP  MSG_A
                                
       D28C                     PRDEC_HL:
00056E D28C AF               4      XOR A
00056F D28D 5F               4      LD  E,A
000570 D28E 57               4      LD  D,A
       D28F                     PRDEC_DEHL:
000571 D28F D5              11      PUSH    DE
000572 D290 110FF0          10      LD  DE,DECBF
000575 D293 0605             7      LD  B,5
000577 D295 CD26D3          17      CALL    ZERO_MEMORY_DE  ;A=0
00057A D298 D1              10      POP DE
                                
00057B D299 0E20             7      LD  C,32
       D29B                     DEC1:
00057D D29B 29              11      ADD HL,HL
00057E D29C EB               4      EX  DE,HL
00057F D29D ED6A            15      ADC HL,HL
000581 D29F EB               4      EX  DE,HL
000582 D2A0 E5              11      PUSH    HL
000583 D2A1 2113F0          10      LD  HL,DECBF+4
000586 D2A4 0605             7      LD  B,5
       D2A6                     DEC2:
000588 D2A6 7E               7      LD  A,(HL)
000589 D2A7 8F               4      ADC A,A
00058A D2A8 27               4      DAA
00058B D2A9 77               7      LD  (HL),A
00058C D2AA 2B               6      DEC HL
00058D D2AB 10F9            13      DJNZ    DEC2
00058F D2AD E1              10      POP HL
000590 D2AE 0D               4      DEC C
000591 D2AF 20EA            12      JR  NZ,DEC1
                                
000593 D2B1 210FF0          10      LD  HL,DECBF
000596 D2B4 3E20             7      LD  A,020H
000598 D2B6 0604             7      LD  B,4
       D2B8                     DEC3:
00059A D2B8 CDC5D2          17      CALL    DEC4
00059D D2BB CDC5D2          17      CALL    DEC4
0005A0 D2BE 23               6      INC HL
0005A1 D2BF 10F7            13      DJNZ    DEC3
       D2C1                     DECX:
0005A3 D2C1 CDC5D2          17      CALL    DEC4
0005A6 D2C4 AF               4      XOR A
       D2C5                     DEC4:
0005A7 D2C5 ED6F            18      RLD
0005A9 D2C7 FE20             7      CP  020H
0005AB D2C9 2802            12      JR  Z,DEC5
0005AD D2CB F630             7      OR  030H
       D2CD                     DEC5:
0005AF D2CD 18BA            12      JR  MSG_AR
                                
       D2CF                     FPRNT:
0005B1 D2CF 0608             7      LD  B,8 ;ファイル名を表示
0005B3 D2D1 CDE0D2          17      CALL    P_N1
0005B6 D2D4 7E               7      LD  A,(HL)
0005B7 D2D5 CDE5DE          17      CALL    CAP3
0005BA D2D8 D8              11      RET C   ;拡張子が無い
                                
0005BB D2D9 3E2E             7      LD  A,'.'
0005BD D2DB CD79D7          17      CALL    MSG_A
0005C0 D2DE 0603             7      LD  B,3 ;拡張子を表示
       D2E0                     P_N1:
0005C2 D2E0 7E               7      LD  A,(HL)
0005C3 D2E1 CDE5DE          17      CALL    CAP3
0005C6 D2E4 3807            12      JR  C,P_N2
0005C8 D2E6 CD79D7          17      CALL    MSG_A
0005CB D2E9 23               6      INC HL
0005CC D2EA 10F4            13      DJNZ    P_N1
0005CE D2EC C9              10      RET
       D2ED                     P_N2:
0005CF D2ED 23               6      INC HL
0005D0 D2EE 10FD            13      DJNZ    P_N2
0005D2 D2F0 C9              10      RET
                                
       D2F1                     SETFCB:
0005D3 D2F1 CD93DC          17      CALL    SPCUT
0005D6 D2F4 1A               7      LD  A,(DE)
0005D7 D2F5 FE20             7      CP  020H
0005D9 D2F7 3801            12      JR  C,SETFCBA
0005DB D2F9 1B               6      DEC DE
       D2FA                     SETFCBA:
0005DC D2FA 0624             7      LD  B,36
0005DE D2FC 215C00          10      LD  HL,FCB1
0005E1 D2FF E5              11      PUSH    HL
0005E2 D300 AF               4      XOR A
0005E3 D301 CD68DC          17      CALL    FILL_MEMORY
0005E6 D304 E1              10      POP HL
0005E7 D305 D5              11      PUSH    DE
0005E8 D306 CDB2D6          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0005EB D309 216C00          10      LD  HL,FCB2
0005EE D30C CDB2D6          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0005F1 D30F E1              10      POP HL
0005F2 D310 010050          10      LD  BC,05000H
0005F5 D313 118100          10      LD  DE,00081H
       D316                     SETFCB1:
0005F8 D316 7E               7      LD  A,(HL)
0005F9 D317 23               6      INC HL
0005FA D318 FE20             7      CP  020H
0005FC D31A 3805            12      JR  C,SETFCB2
0005FE D31C 12               7      LD  (DE),A
0005FF D31D 13               6      INC DE
000600 D31E 0C               4      INC C
000601 D31F 10F5            13      DJNZ    SETFCB1
       D321                     SETFCB2:
000603 D321 79               4      LD  A,C
000604 D322 328000          13      LD  (DTA1),A
000607 D325 04               4      INC B
       D326                     ZERO_MEMORY_DE:
000608 D326 AF               4      XOR A
       D327                     FILL_MEMORY_DE:
000609 D327 12               7      LD  (DE),A
00060A D328 13               6      INC DE
00060B D329 10FC            13      DJNZ    FILL_MEMORY_DE
00060D D32B C9              10      RET
                                
       D32C                     C_COPY:
00060E D32C CDF1D2          17      CALL    SETFCB
                                
000611 D32F 1161F0          10      LD  DE,ZERO
000614 D332 CDB5DB          17      CALL    FILEC2
000617 D335 216C00          10      LD  HL,FCB2
00061A D338 CDB9D6          17      CALL    S29X1
                                
00061D D33B 3E10             7      LD  A,010H
00061F D33D 326900          13      LD  (FCB1+13),A
000622 D340 216D00          10      LD  HL,FCB2FN
000625 D343 CD07D4          17      CALL    CWILD1
       D346                     COPY0:
000628 D346 CD04D4          17      CALL    CWILD
00062B D349 215C00          10      LD  HL,FCB1
00062E D34C CDADD0          17      CALL    OPEN
000631 D34F 37               4      SCF
       D350                     COPY1:
000632 D350 C0              11      RET NZ
000633 D351 CDC0D0          17      CALL    DEFCB
                                
000636 D354 3A78EB          13      LD  A,(DTA_CCP+13)
000639 D357 CB67             8      BIT 4,A
00063B D359 2821            12      JR  Z,COPY1A
                                
00063D D35B 215D00          10      LD  HL,FCB1FN
000640 D35E CDF8DF          17      CALL    CHKWILD
000643 D361 3814            12      JR  C,COPY9
                                
000645 D363 3E20             7      LD  A,020H
000647 D365 325D00          13      LD  (FCB1FN),A
00064A D368 2A85EB          16      LD  HL,(DTA_CCP+26)
00064D D36B 23               6      INC HL
00064E D36C 226A00          16      LD  (FCB1+14),HL
000651 D36F 18D5            12      JR  COPY0
                                
       D371                     COPY8:
000653 D371 CD79D4          17      CALL    _SYS09      ;(BDOS)文字列出力
000656 D374 CD55D2          17      CALL    LTNL
       D377                     COPY9:
000659 D377 CDBCD0          17      CALL    OPEN2
00065C D37A 18D4            12      JR  COPY1
                                
       D37C                     COPY1A:
00065E D37C 216C00          10      LD  HL,FCB2
000661 D37F 1114F0          10      LD  DE,FDRV
000664 D382 016DEB          10      LD  BC,DTA_CCP+2
000667 D385 EDA0            16      LDI
000669 D387 3E0B             7      LD  A,11
       D389                     COPY2:
00066B D389 F5              11      PUSH    AF
00066C D38A 7E               7      LD  A,(HL)
00066D D38B FE3F             7      CP  '?'
00066F D38D 2001            12      JR  NZ,COPY3
000671 D38F 0A               7      LD  A,(BC)
       D390                     COPY3:
000672 D390 12               7      LD  (DE),A
000673 D391 03               6      INC BC
000674 D392 13               6      INC DE
000675 D393 23               6      INC HL
000676 D394 F1              10      POP AF
000677 D395 3D               4      DEC A
000678 D396 20F1            12      JR  NZ,COPY2
00067A D398 010500          10      LD  BC,16-11
00067D D39B EDB0                    LDIR
       D39D                     PUTNAME:
00067F D39D 215D00          10      LD  HL,FCB1FN
000682 D3A0 CDF8DF          17      CALL    CHKWILD
000685 D3A3 300B            12      JR  NC,PUTN1
000687 D3A5 2115F0          10      LD  HL,FDRV+1
00068A D3A8 CDCFD2          17      CALL    FPRNT
00068D D3AB 3E20             7      LD  A,020H
00068F D3AD CD79D7          17      CALL    MSG_A
       D3B0                     PUTN1:
000692 D3B0 1114F0          10      LD  DE,FDRV
000695 D3B3 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
000697 D3B5 CDDBD0          17      CALL    SYSTEM0
00069A D3B8 2048            12      JR  NZ,COPYE2
00069C D3BA 67               4      LD  H,A     ;A=0
00069D D3BB 6F               4      LD  L,A
00069E D3BC 2235F0          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
0006A1 D3BF 2237F0          16      LD  (FDRV+35),HL
       D3C2                     COPY6:
0006A4 D3C2 CDE4D0          17      CALL    S27BUF
0006A7 D3C5 47               4      LD  B,A
0006A8 D3C6 3C               4      INC A
0006A9 D3C7 2831            12      JR  Z,COPYE
0006AB D3C9 7C               4      LD  A,H
0006AC D3CA B5               4      OR  L
0006AD D3CB 280C            12      JR  Z,COPY7
0006AF D3CD 1114F0          10      LD  DE,FDRV
0006B2 D3D0 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0006B4 D3D2 CDDBD0          17      CALL    SYSTEM0
0006B7 D3D5 2023            12      JR  NZ,COPYE
0006B9 D3D7 10E9            13      DJNZ    COPY6
       D3D9                     COPY7:
0006BB D3D9 3A78EB          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
0006BE D3DC 3221F0          13      LD  (FDRV+13),A
0006C1 D3DF 217FEB          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
0006C4 D3E2 1128F0          10      LD  DE,FDRV+20
0006C7 D3E5 010400          10      LD  BC,4
0006CA D3E8 EDB0                    LDIR
                                
0006CC D3EA 1114F0          10      LD  DE,FDRV
0006CF D3ED 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
0006D1 D3EF CDDBD0          17      CALL    SYSTEM0
0006D4 D3F2 2006            12      JR  NZ,COPYE
                                
0006D6 D3F4 1171F0          10      LD  DE,OK
0006D9 D3F7 C371D3          10      JP  COPY8
                                
       D3FA                     COPYE:
0006DC D3FA 1114F0          10      LD  DE,FDRV
0006DF D3FD 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
0006E1 D3FF CD0500          17      CALL    SYSTEM
       D402                     COPYE2:
0006E4 D402 37               4      SCF
0006E5 D403 C9              10      RET
                                
       D404                     CWILD:
0006E6 D404 215D00          10      LD  HL,FCB1FN
       D407                     CWILD1:
0006E9 D407 7E               7      LD  A,(HL)
0006EA D408 FE20             7      CP  020H
0006EC D40A C0              11      RET NZ
       D40B                     CWILD2:
0006ED D40B 3E3F             7      LD  A,'?'
0006EF D40D 060B             7      LD  B,11
0006F1 D40F C368DC          10      JP  FILL_MEMORY
                                
       D412                     COMTB:
0006F4 D412 44202020                DB  "D   "  ;1
0006F8 D416 C3D1                    DW  C_DIR
0006FA D418 44495220                DB  "DIR "  ;2
0006FE D41C C3D1                    DW  C_DIR
000700 D41E 434F5059                DB  "COPY"  ;3
000704 D422 2CD3                    DW  C_COPY
000706 D424 43442020                DB  "CD  "  ;4
00070A D428 E0D0                    DW  C_CD
00070C D42A 44454C20                DB  "DEL "  ;5
000710 D42E A6D1                    DW  C_DEL
000712 D430 50415448                DB  "PATH"  ;6
000716 D434 5AD2                    DW  C_PATH
000718 D436 52454E20                DB  "REN "  ;7
00071C D43A B0D1                    DW  C_REN
00071E D43C 52454D20                DB  "REM "  ;8
000722 D440 76D4                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP2.ASM"
                                
                                ;   LSX-Dodgers CCP2
                                ;   MZ-700/1500
                                
000724 D442 4D4F4E20                DB  "MON "  ;9
000728 D446 A2DB                    DW  C_MON
[EOF:M7CCP2.ASM:UTF_8]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       D448                     BDOS0:
00072A D448 E5              11      PUSH    HL
00072B D449 79               4      LD  A,C
00072C D44A FE3C             7      CP  03CH
00072E D44C 3802            12      JR  C,DOS1
000730 D44E 3E3C             7      LD  A,03CH
       D450                     DOS1:
000732 D450 87               4      ADD A,A
000733 D451 3255D4          13      LD  (DOS1_SWC),A
000736 D454 2A00F1          16      LD  HL,(STABLE)
       D455                     DOS1_SWC    EQU $-2
000739 D457 E3              19      EX  (SP),HL
00073A D458 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
00073B D459 C9              10      RET
       D45A                     _DOS2:
00073C D45A FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
00073E D45C CAF4D6          10      JP  Z,_SYS5A
000741 D45F FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
000743 D461 CAB1D6          10      JP  Z,_SYS5C
000746 D464 FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
000748 D466 CAF3E8          10      JP  Z,_SYS5F
00074B D469 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
00074D D46B 200A            12      JR  NZ,_ERROR
00074F D46D 011D01          10      LD  BC,VER_6F
000752 D470 116101          10      LD  DE,VER
000755 D473 210100          10      LD  HL,MACD
       D476                     C_REM:
000758 D476 AF               4      XOR A
       D477                     _ERROR:
000759 D477 A7               4      AND A
00075A D478 C9              10      RET
                                
       D479                     _SYS09:     ;文字列出力
00075B D479 D5              11      PUSH    DE
       D47A                     _SX09:
00075C D47A 1A               7      LD  A,(DE)
00075D D47B 13               6      INC DE
00075E D47C FE24             7      CP  '$'
000760 D47E 2831            12      JR  Z,SX0E2
000762 D480 CD79D7          17      CALL    MSG_A
000765 D483 18F5            12      JR  _SX09
                                
       D485                     MSX1:
000767 D485 CD79D7          17      CALL    MSG_A
       D488                     MSX:
00076A D488 7E               7      LD  A,(HL)
00076B D489 23               6      INC HL
00076C D48A B7               4      OR  A
00076D D48B 20F8            12      JR  NZ,MSX1
00076F D48D C9              10      RET
                                
       D48E                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000770 D48E 212200          10      LD  HL,00022H
000773 D491 7D               4      LD  A,L
000774 D492 C9              10      RET
                                
       D493                     _SYS0D:     ;(BDOS)ディスクリセット
000775 D493 CDDFF0          17      CALL    _FFLUSH
000778 D496 E5              11      PUSH    HL
000779 D497 218000          10      LD  HL,00080H
00077C D49A 228AF0          16      LD  (_DTA),HL
00077F D49D E1              10      POP HL
000780 D49E D5              11      PUSH    DE
000781 D49F 1E00             7      LD  E,0
000783 D4A1 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       D4A2                     _SYS0E:     ;(BDOS)カレントドライブの設定
000784 D4A2 D5              11      PUSH    DE
000785 D4A3 7B               4      LD  A,E
000786 D4A4 DDE5            15      PUSH    IX
000788 D4A6 CDDCF0          17      CALL    _GETDPB
00078B D4A9 DDE1            14      POP IX
00078D D4AB 3804            12      JR  C,SX0E2
00078F D4AD 7B               4      LD  A,E
000790 D4AE 320400          13      LD  (_DVSW),A
       D4B1                     SX0E2:
000793 D4B1 D1              10      POP DE
000794 D4B2 C9              10      RET
                                
       D4B3                     _SYS0F:     ;(BDOS)ファイルのオープン
000795 D4B3 CDA5DC          17      CALL    SETDRV
000798 D4B6 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
00079B D4B9 C602             7      ADD A,002H      ;Write
00079D D4BB 2848            12      JR  Z,FEND0F
00079F D4BD CDF4DF          17      CALL    CHKWILDX
                                
0007A2 D4C0 D4CFDC          17      CALL    NC,SOPENX
       D4C3                     _S16XX:
0007A5 D4C3 3840            12      JR  C,FEND0F
                                                ;Directory location
0007A7 D4C5 3A9FF0          13      LD  A,(_FILEN)
0007AA D4C8 FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
0007AD D4CB 3AA0F0          13      LD  A,(_DIRF)
0007B0 D4CE FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
0007B3 D4D1 FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
0007B6 D4D4 FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
0007B9 D4D7 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
0007BD D4DB FDE5            15      PUSH    IY
0007BF D4DD D1              10      POP DE
0007C0 D4DE 13               6      INC DE
0007C1 D4DF 010B00          10      LD  BC,11
0007C4 D4E2 EDB0                    LDIR
                                ;               Attribute
0007C6 D4E4 7E               7      LD  A,(HL)
0007C7 D4E5 FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
0007CA D4E8 110B00          10      LD  DE,11       ;Reserved
0007CD D4EB 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
0007CE D4EC 11E4F1          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
0007D1 D4EF 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D4F1                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
0007D3 D4F1 1A               7      LD  A,(DE)
0007D4 D4F2 13               6      INC DE
0007D5 D4F3 32FAD4          13      LD  (S16PAT),A
0007D8 D4F6 7E               7      LD  A,(HL)
0007D9 D4F7 23               6      INC HL
0007DA D4F8 FD7700          19      LD  (IY+0),A
       D4FA                     S16PAT  EQU $-1
0007DD D4FB 10F4            13      DJNZ    S16LOOP
                                
0007DF D4FD AF               4      XOR A
0007E0 D4FE FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
0007E3 D501 FD22A2D5        20      LD  (OFCB_SWC),IY
       D505                     FEND0F:
0007E7 D505 1845            12      JR  FEND10
                                
       D507                     _SYS10:     ;(BDOS)ファイルのクローズ
0007E9 D507 CDA5DC          17      CALL    SETDRV
0007EC D50A FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0007EF D50D D6FE             7      SUB 0FEH
0007F1 D50F 37               4      SCF
0007F2 D510 3F               4      CCF
0007F3 D511 2039            12      JR  NZ,FEND10
       D513                     _S10A:              ;Write
0007F5 D513 FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
0007F8 D516 FD770F          19      LD  (IY+15),A
                                
0007FB D519 FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
0007FE D51C CDF0E0          17      CALL    SETTMS
                                
000801 D51F FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000804 D522 32A0F0          13      LD  (_DIRF),A
000807 D525 E67F             7      AND 07FH
000809 D527 3215E6          13      LD  (_SECPS),A
00080C D52A FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
00080F D52D FD561F          19      LD  D,(IY+31)
000812 D530 CD03DE          17      CALL    READ_DIR
000815 D533 3817            12      JR  C,FEND10
                                
000817 D535 3A2FDD          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
00081A D538 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
00081B D539 FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
00081E D53C 6F               4      LD  L,A
00081F D53D 2600             7      LD  H,0
000821 D53F 29              11      ADD HL,HL       ;*2
000822 D540 29              11      ADD HL,HL       ;*4
000823 D541 29              11      ADD HL,HL       ;*8
000824 D542 29              11      ADD HL,HL       ;*16
000825 D543 29              11      ADD HL,HL       ;*32
000826 D544 ED4B7EF1        20      LD  BC,(_DTBUF)
00082A D548 09              11      ADD HL,BC
                                
00082B D549 CD04E0          17      CALL    SDIRENT
       D54C                     FEND10:
00082E D54C 1842            12      JR  FEND
                                
       D54E                     _SYS11:     ;(BDOS)最初のファイルの検索
000830 D54E CDA5DC          17      CALL    SETDRV
000833 D551 CDFEDC          17      CALL    SOPEN
       D554                     _S12X1:
000836 D554 383A            12      JR  C,FEND
000838 D556 CD9DDD          17      CALL    SOPENE2
00083B D559 ED5B8AF0        20      LD  DE,(_DTA)
00083F D55D 3A88F0          13      LD  A,(_DRV)
000842 D560 3C               4      INC A
000843 D561 12               7      LD  (DE),A
000844 D562 D5              11      PUSH    DE
000845 D563 13               6      INC DE
000846 D564 012000          10      LD  BC,32
000849 D567 EDB0                    LDIR
00084B D569 FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
00084E D56C FD660F          19      LD  H,(IY+15)
000851 D56F 22F4F1          16      LD  (SCDIR),HL
000854 D572 2A9AF0          16      LD  HL,(_FBPS)
000857 D575 22F6F1          16      LD  (SFBPS),HL
00085A D578 2A9FF0          16      LD  HL,(_FILEN)
00085D D57B 7C               4      LD  A,H
00085E D57C B7               4      OR  A
00085F D57D 2806            12      JR  Z,_S12DIR
000861 D57F 3A15E6          13      LD  A,(_SECPS)
000864 D582 F680             7      OR  080H
000866 D584 67               4      LD  H,A
       D585                     _S12DIR:
000867 D585 22F8F1          16      LD  (SFNDF),HL  ;Directory position and Flags
00086A D588 E1              10      POP HL
00086B D589 1139F0          10      LD  DE,SFILE
00086E D58C 0E21             7      LD  C,33
       D58E                     _S11B:
000870 D58E EDB0                    LDIR
       D590                     FEND:
000872 D590 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D591                     FENDE:
000873 D591 FDE1            14      POP IY
000875 D593 C1              10      POP BC
000876 D594 D1              10      POP DE
000877 D595 E1              10      POP HL
000878 D596 C9              10      RET
                                
       D597                     _SYS12:     ;(BDOS)次のファイルの検索
000879 D597 E5              11      PUSH    HL
00087A D598 D5              11      PUSH    DE
00087B D599 C5              11      PUSH    BC
00087C D59A FDE5            15      PUSH    IY
00087E D59C CD62DD          17      CALL    NOPEN
000881 D59F 18B3            12      JR  _S12X1
                                
       D5A1                     _S16K:
000883 D5A1 110000          10      LD  DE,0
       D5A2                     OFCB_SWC    EQU $-2
000886 D5A4 D5              11      PUSH    DE
000887 D5A5 061A             7      LD  B,26        ;First cluster
       D5A7                     S16K1:
000889 D5A7 13               6      INC DE
00088A D5A8 23               6      INC HL
00088B D5A9 10FC            13      DJNZ    S16K1
                                
00088D D5AB 1A               7      LD  A,(DE)
00088E D5AC BE               7      CP  (HL)
00088F D5AD 2015            12      JR  NZ,S16K2
000891 D5AF 13               6      INC DE
000892 D5B0 23               6      INC HL
000893 D5B1 1A               7      LD  A,(DE)
000894 D5B2 BE               7      CP  (HL)
000895 D5B3 200F            12      JR  NZ,S16K2
                                
000897 D5B5 E1              10      POP HL
000898 D5B6 FDE5            15      PUSH    IY
00089A D5B8 D1              10      POP DE
00089B D5B9 7E               7      LD  A,(HL)
00089C D5BA CDBADC          17      CALL    IS_SAME_DRV_A_DE
00089F D5BD 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
0008A1 D5BF ED52            15      SBC HL,DE       ;CP HL,DE
0008A3 D5C1 37               4      SCF
0008A4 D5C2 C0              11      RET NZ
0008A5 D5C3 E5              11      PUSH    HL
       D5C4                     S16K2:
0008A6 D5C4 E1              10      POP HL
       D5C5                     S16K3:
0008A7 D5C5 FDE5            15      PUSH    IY
0008A9 D5C7 D1              10      POP DE
       D5C8                     _SYS13:     ;(BDOS)ファイルの削除
0008AA D5C8 CDA5DC          17      CALL    SETDRV
0008AD D5CB CD2CDF          17      CALL    KILL
       D5CE                     FEND13:
0008B0 D5CE 18C0            12      JR  FEND
                                
       D5D0                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0008B2 D5D0 CDA5DC          17      CALL    SETDRV
0008B5 D5D3 CD68E4          17      CALL    INIT_SEQ
       D5D6                     SREAD:
0008B8 D5D6 CD3AE4          17      CALL    RB_READ
                                
0008BB D5D9 C601             7      ADD A,001H
0008BD D5DB 38B3            12      JR  C,FEND
                                
0008BF D5DD 7D               4      LD  A,L
0008C0 D5DE D601             7      SUB 001H
       D5E0                     FENDX:
0008C2 D5E0 9F               4      SBC A,A
0008C3 D5E1 E603             7      AND 3
0008C5 D5E3 1F               4      RRA
0008C6 D5E4 18AB            12      JR  FENDE
                                
       D5E6                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
0008C8 D5E6 CDA5DC          17      CALL    SETDRV
0008CB D5E9 CD68E4          17      CALL    INIT_SEQ
       D5EC                     SWRITE:
0008CE D5EC CD35E4          17      CALL    RB_WRITE
                                
0008D1 D5EF C6FF             7      ADD A,0FFH
0008D3 D5F1 18ED            12      JR  FENDX
                                
       D5F3                     _SYS17:     ;(BDOS)ファイル名の変更
0008D5 D5F3 CDA5DC          17      CALL    SETDRV
0008D8 D5F6 CD82DF          17      CALL    NAME
0008DB D5F9 18D3            12      JR  FEND13
                                
       D5FB                     _SYS16:     ;(BDOS)ファイルの作成
0008DD D5FB CDA5DC          17      CALL    SETDRV
                                
0008E0 D5FE CDF4DF          17      CALL    CHKWILDX
0008E3 D601 38CB            12      JR  C,FEND13
0008E5 D603 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
0008E8 D606 FE05             7      CP  5
0008EA D608 2805            12      JR  Z,_S16X2
0008EC D60A FE21             7      CP  021H
0008EE D60C DACED5          10      JP  C,FEND13
       D60F                     _S16X2:
                                ;               Clear FCB
0008F1 D60F FDE5            15      PUSH    IY
0008F3 D611 E1              10      POP HL
0008F4 D612 011000          10      LD  BC,16
0008F7 D615 09              11      ADD HL,BC
       D616                     _S16X1:
0008F8 D616 70               7      LD  (HL),B      ;B=0
0008F9 D617 23               6      INC HL
0008FA D618 0D               4      DEC C
0008FB D619 20FB            12      JR  NZ,_S16X1
                                
0008FD D61B CDF5E0          17      CALL    SETTMSX
000900 D61E FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000904 D622 CDCFDC          17      CALL    SOPENX
000907 D625 3F               4      CCF
000908 D626 CCA1D5          17      CALL    Z,_S16K
00090B D629 D4AEDD          17      CALL    NC,COPEN
00090E D62C D404E0          17      CALL    NC,SDIRENT
000911 D62F C3C3D4          10      JP  _S16XX
                                
       D632                     _SYS21:     ;(BDOS)ランダムな読み出し
000914 D632 CDA5DC          17      CALL    SETDRV
000917 D635 CD40E1          17      CALL    INIT_RND
00091A D638 189C            12      JR  SREAD
                                
       D63A                     _SYS22:     ;(BDOS)ランダムな書き込み
       D63A                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
00091C D63A CDA5DC          17      CALL    SETDRV
00091F D63D CD40E1          17      CALL    INIT_RND
000922 D640 18AA            12      JR  SWRITE
                                
       D642                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000924 D642 21FF00          10      LD  HL,000FFH
000927 D645 AF               4      XOR A
000928 D646 C9              10      RET
                                
       D647                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000929 D647 3A0400          13      LD  A,(_DVSW)   ;from LDOS
00092C D64A A7               4      AND A
00092D D64B C9              10      RET
                                
       D64C                     _SYS1A:     ;(BDOS)DTAの設定
00092E D64C ED538AF0        20      LD  (_DTA),DE
000932 D650 AF               4      XOR A
000933 D651 C9              10      RET
                                
       D652                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000934 D652 7B               4      LD  A,E
000935 D653 CDB3DC          17      CALL    GETDRV
000938 D656 CDDCF0          17      CALL    _GETDPB
00093B D659 D4E2F0          17      CALL    NC,_RDFATX
00093E D65C 210000          10      LD  HL,0
000941 D65F D4CEE0          17      CALL    NC,DSKF
                                
000944 D662 ED5BCFE0        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
000948 D666 1B               6      DEC DE      ;DE←クラスタの総数
000949 D667 FD2A7CF1        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
00094D D66B 9F               4      SBC A,A
00094E D66C D8              11      RET C
00094F D66D 4F               4      LD  C,A     ;C=0
000950 D66E DD7E0F          19      LD  A,(IX+DPB_BPS)
000953 D671 E607             7      AND 7
000955 D673 47               4      LD  B,A
000956 D674 DD7E07          19      LD  A,(IX+DPB_SECPCL)
000959 D677 C9              10      RET
                                
       D678                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
00095A D678 AF               4      XOR A
00095B D679 67               4      LD  H,A
00095C D67A 6F               4      LD  L,A
00095D D67B C9              10      RET
                                
       D67C                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
00095E D67C 2100F2          10      LD  HL,_DEVICE
000961 D67F 7B               4      LD  A,E
000962 D680 C3DCF0          10      JP  _GETDPB
                                
       D683                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000965 D683 E5              11      PUSH    HL
000966 D684 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
000968 D686 CD48D4          17      CALL    BDOS0
00096B D689 381B            12      JR  C,_S23X1
                                
00096D D68B D5              11      PUSH    DE      ;EX DE,IY
00096E D68C FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000970 D68E FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000973 D691 FD6E11          19      LD  L,(IY+17)   ;
000976 D694 FD6612          19      LD  H,(IY+18)   ;
000979 D697 C5              11      PUSH    BC      ;
00097A D698 FD4613          19      LD  B,(IY+19)   ;
00097D D69B CD32E1          17      CALL    GET_CPM_R_SIZE
000980 D69E C1              10      POP BC
       D69F                     _S24X1:
000981 D69F CD52E1          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000984 D6A2 FDE3            23      EX  (SP),IY     ;
000986 D6A4 D1              10      POP DE      ;
                                
000987 D6A5 AF               4      XOR A
       D6A6                     _S23X1:
000988 D6A6 E1              10      POP HL
000989 D6A7 C9              10      RET
                                
       D6A8                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
00098A D6A8 E5              11      PUSH    HL
00098B D6A9 D5              11      PUSH    DE      ;EX DE,IY
00098C D6AA FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
00098E D6AC CD70E4          17      CALL    GETSEQ
000991 D6AF 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D6B1                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
000993 D6B1 2B               6      DEC HL
       D6B2                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000994 D6B2 C5              11      PUSH    BC
000995 D6B3 E5              11      PUSH    HL
000996 D6B4 CDBDDB          17      CALL    FILE
000999 D6B7 E1              10      POP HL
00099A D6B8 C1              10      POP BC
       D6B9                     S29X1:
00099B D6B9 C5              11      PUSH    BC
00099C D6BA D5              11      PUSH    DE
00099D D6BB E5              11      PUSH    HL
00099E D6BC EB               4      EX  DE,HL
00099F D6BD AF               4      XOR A
0009A0 D6BE 3221F0          13      LD  (FDRV+13),A
0009A3 D6C1 2114F0          10      LD  HL,FDRV
0009A6 D6C4 011000          10      LD  BC,16
0009A9 D6C7 EDB0                    LDIR
0009AB D6C9 E1              10      POP HL
0009AC D6CA D1              10      POP DE
0009AD D6CB C1              10      POP BC
0009AE D6CC C9              10      RET
                                
       D6CD                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
0009AF D6CD C5              11      PUSH    BC
0009B0 D6CE 01B4E7          10      LD  BC,DWT24B
0009B3 D6D1 1804            12      JR  S2FX
       D6D3                     _SYS2F:
0009B5 D6D3 C5              11      PUSH    BC
0009B6 D6D4 01A6E7          10      LD  BC,DRD24B
       D6D7                     S2FX:
0009B9 D6D7 ED43EDD6        20      LD  (S2F_SWC),BC
0009BD D6DB CDDFF0          17      CALL    _FFLUSH
                                
0009C0 D6DE D5              11      PUSH    DE
0009C1 D6DF E5              11      PUSH    HL
0009C2 D6E0 7D               4      LD  A,L     ;Drive
0009C3 D6E1 CDD9F0          17      CALL    _CHGDRV
0009C6 D6E4 3809            12      JR  C,POP_HL_DE_BC_SBCAA_RET
0009C8 D6E6 44               4      LD  B,H     ;Number of clusters
0009C9 D6E7 2A8AF0          16      LD  HL,(_DTA)
                                
0009CC D6EA 0E00             7      LD  C,0
0009CE D6EC CDA6E7          17      CALL    DRD24B
       D6ED                     S2F_SWC EQU $-2
       D6EF                     POP_HL_DE_BC_SBCAA_RET:
0009D1 D6EF E1              10      POP HL
0009D2 D6F0 D1              10      POP DE
0009D3 D6F1 C1              10      POP BC
0009D4 D6F2 9F               4      SBC A,A
0009D5 D6F3 C9              10      RET
                                
       D6F4                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
0009D6 D6F4 C5              11      PUSH    BC
0009D7 D6F5 D5              11      PUSH    DE
0009D8 D6F6 E5              11      PUSH    HL
0009D9 D6F7 CDB2DB          17      CALL    FILEC
0009DC D6FA 21EFD6          10      LD  HL,POP_HL_DE_BC_SBCAA_RET
0009DF D6FD E5              11      PUSH    HL
0009E0 D6FE 3A21F0          13      LD  A,(FDRV+13) ;(FCB)属性(アトリビュート))
0009E3 D701 E610             7      AND 010H        ;ディレクトリ
0009E5 D703 37               4      SCF
0009E6 D704 C8              11      RET Z
0009E7 D705 1114F0          10      LD  DE,FDRV
0009EA D708 2A4EF1          16      LD  HL,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       D70B                     JPHL:
0009ED D70B E9               4      JP  (HL)
                                
       D70C                     SHOW_ERROR:         ;(9)
0009EE D70C 1179F0          10      LD  DE,COMERM
0009F1 D70F CD79D4          17      CALL    _SYS09      ;(BDOS)文字列出力
0009F4 D712 C300F0          10      JP  CPM_BOOT
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "M7IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                
       D477                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D477                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D477                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D477                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D477                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D477                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
       D715                     ARWKEY:
0009F7 D715 3D               4      DEC A
0009F8 D716 3239D7          13      LD  (KEYAR),A
0009FB D719 182E            12      JR  INT8253E
       D71B                     SETKEY1:
0009FD D71B B7               4      OR  A
       D71C                     SETKEY1_SWC:
0009FE D71C 202B            12      JR  NZ,INT8253E
000A00 D71E 3A95F0          13      LD  A,(_KEYSP_H)
000A03 D721 181A            12      JR  SETKEY
       D723                     INT8253:
000A05 D723 CD1FDB          17      CALL    CHKEY
000A08 D726 FE00             7      CP  0
       D727                     KEYDT   EQU $-1
000A0A D728 20F1            12      JR  NZ,SETKEY1
000A0C D72A 3E3E             7      LD  A,03EH      ;LD A,?
000A0E D72C 321CD7          13      LD  (SETKEY1_SWC),A
000A11 D72F E5              11      PUSH    HL
000A12 D730 2A90F0          16      LD  HL,(_KEYPS)
000A15 D733 7C               4      LD  A,H
000A16 D734 AD               4      XOR L
000A17 D735 E1              10      POP HL
000A18 D736 2011            12      JR  NZ,INT8253E
000A1A D738 3E00             7      LD  A,0
       D739                     KEYAR   EQU $-1
000A1C D73A B7               4      OR  A
000A1D D73B 20D8            12      JR  NZ,ARWKEY
       D73D                     SETKEY:
000A1F D73D 3239D7          13      LD  (KEYAR),A
000A22 D740 3A92F0          13      LD  A,(_KEYD)
000A25 D743 3227D7          13      LD  (KEYDT),A
000A28 D746 CD4CD7          17      CALL    KEYSET
       D749                     INT8253E:
000A2B D749 F1              10      POP AF
000A2C D74A FB               4      EI
000A2D D74B C9              10      RET
       D74C                     KEYSET:
       D74C                     KEYBS:
000A2E D74C B7               4      OR  A
000A2F D74D C8              11      RET Z
       D74E                     KEYBS1:
000A30 D74E CD66D7          17      CALL    KEYBC_IFBREAK
000A33 D751 E5              11      PUSH    HL
000A34 D752 F5              11      PUSH    AF
000A35 D753 2A90F0          16      LD  HL,(_KEYPS)
000A38 D756 2C               4      INC L
000A39 D757 CBAD             8      RES 5,L
000A3B D759 7D               4      LD  A,L
000A3C D75A BC               4      CP  H
000A3D D75B 2815            12      JR  Z,POP_AF_HL_SCF_RET
000A3F D75D 3290F0          13      LD  (_KEYPS),A
000A42 D760 26F3             7      LD  H,HIGH KEYBF
000A44 D762 F1              10      POP AF
000A45 D763 77               7      LD  (HL),A
000A46 D764 E1              10      POP HL
000A47 D765 C9              10      RET
       D766                     KEYBC_IFBREAK:
000A48 D766 FE03             7      CP  3
000A4A D768 C0              11      RET NZ
       D769                     KEYBC:
000A4B D769 E5              11      PUSH    HL
000A4C D76A 210000          10      LD  HL,0
000A4F D76D 2290F0          16      LD  (_KEYPS),HL
000A52 D770 E1              10      POP HL
000A53 D771 C9              10      RET
                                
       D772                     POP_AF_HL_SCF_RET:
000A54 D772 F1              10      POP AF
000A55 D773 E1              10      POP HL
000A56 D774 37               4      SCF
000A57 D775 C9              10      RET
                                
       D776                     _SYS01:     ;(BDOS)コンソール入力
000A58 D776 CD09F0          17      CALL    _SYS07
       D779                     MSG_A:
000A5B D779 F5              11      PUSH    AF
000A5C D77A D5              11      PUSH    DE
000A5D D77B 5F               4      LD  E,A
000A5E D77C CD82D7          17      CALL    _SYS02
000A61 D77F D1              10      POP DE
000A62 D780 F1              10      POP AF
000A63 D781 C9              10      RET
                                
       D782                     _SYS02:     ;(BDOS)コンソール出力
000A64 D782 CD94D7          17      CALL    BREAK
000A67 D785 1805            12      JR  PRINTX
                                
       D787                     _SYS06:     ;(BDOS)コンソール直接入出力
000A69 D787 7B               4      LD  A,E
000A6A D788 3C               4      INC A
000A6B D789 CACAF0          10      JP  Z,_INKEY
       D78C                     PRINTX:
000A6E D78C C3CDF0          10      JP  _PRINT
                                
       D78F                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000A71 D78F CD09F0          17      CALL    _SYS07
000A74 D792 1804            12      JR  BREAK1
       D794                     BREAK:
000A76 D794 FB               4      EI
000A77 D795 3A92F0          13      LD  A,(_KEYD)
       D798                     BREAK1:
000A7A D798 FE03             7      CP  3       ;CTRL+C
000A7C D79A CCF4F0          17      CALL    Z,_BREAK
000A7F D79D FE13             7      CP  013H        ;CTRL+S
000A81 D79F C0              11      RET NZ
                                
       D7A0                     PAUSE:
000A82 D7A0 CD69D7          17      CALL    KEYBC
                                
       D7A3                     FLGET:
000A85 D7A3 CDDFF0          17      CALL    _FFLUSH
000A88 D7A6 E5              11      PUSH    HL
000A89 D7A7 2A8EF0          16      LD  HL,(_TXADR)
000A8C D7AA 7C               4      LD  A,H
000A8D D7AB C6D0             7      ADD A,0D0H
000A8F D7AD 67               4      LD  H,A
000A90 D7AE CD37CF          17      CALL    RDMMIO
000A93 D7B1 32C6D7          13      LD  (FLSMC),A
       D7B4                     FLGET1:
000A96 D7B4 CD2DCF          17      CALL    RD556VSYNC
000A99 D7B7 CB77             8      BIT 6,A
000A9B D7B9 3EEF             7      LD  A,0EFH      ;カーソル
000A9D D7BB 280A            12      JR  Z,FLGET2
000A9F D7BD 3A92F0          13      LD  A,(_KEYD)
000AA2 D7C0 B7               4      OR  A
000AA3 D7C1 3EEF             7      LD  A,0EFH      ;カーソル
000AA5 D7C3 2002            12      JR  NZ,FLGET2
000AA7 D7C5 3E00             7      LD  A,0     ;自己書き換え
       D7C6                     FLSMC   EQU $-1
       D7C7                     FLGET2:
000AA9 D7C7 CD3FCF          17      CALL    WRMMIO
000AAC D7CA CDCAF0          17      CALL    _INKEY
000AAF D7CD 28E5            12      JR  Z,FLGET1
000AB1 D7CF F5              11      PUSH    AF
000AB2 D7D0 3AC6D7          13      LD  A,(FLSMC)
000AB5 D7D3 CD3FCF          17      CALL    WRMMIO
000AB8 D7D6 F1              10      POP AF
000AB9 D7D7 E1              10      POP HL
000ABA D7D8 C9              10      RET
                                
       D7D9                     _SYS0A:     ;(BDOS)文字列入力
000ABB D7D9 C5              11      PUSH    BC
000ABC D7DA E5              11      PUSH    HL
000ABD D7DB D5              11      PUSH    DE
000ABE D7DC CD7DDA          17      CALL    GETL
000AC1 D7DF 1130FF          10      LD  DE,KBUF
000AC4 D7E2 E1              10      POP HL
000AC5 D7E3 E5              11      PUSH    HL
000AC6 D7E4 0E00             7      LD  C,0
000AC8 D7E6 3004            12      JR  NC,SAX0
000ACA D7E8 23               6      INC HL
000ACB D7E9 23               6      INC HL
000ACC D7EA 1808            12      JR  SAX4
       D7EC                     SAX0:
000ACE D7EC 46               7      LD  B,(HL)
000ACF D7ED 23               6      INC HL
       D7EE                     SAX1:
000AD0 D7EE 23               6      INC HL
000AD1 D7EF 1A               7      LD  A,(DE)
000AD2 D7F0 13               6      INC DE
000AD3 D7F1 B7               4      OR  A
000AD4 D7F2 2004            12      JR  NZ,SAX2
       D7F4                     SAX4:
000AD6 D7F4 360D            10      LD  (HL),00DH
000AD8 D7F6 1804            12      JR  SAX3
       D7F8                     SAX2:
000ADA D7F8 77               7      LD  (HL),A
000ADB D7F9 0C               4      INC C
000ADC D7FA 10F2            13      DJNZ    SAX1
       D7FC                     SAX3:
000ADE D7FC D1              10      POP DE
000ADF D7FD 79               4      LD  A,C
000AE0 D7FE 13               6      INC DE
000AE1 D7FF 12               7      LD  (DE),A
000AE2 D800 1B               6      DEC DE
000AE3 D801 E1              10      POP HL
000AE4 D802 C1              10      POP BC
000AE5 D803 A7               4      AND A
000AE6 D804 C9              10      RET
                                
       D805                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000AE7 D805 CD94D7          17      CALL    BREAK
000AEA D808 3A92F0          13      LD  A,(_KEYD)
000AED D80B B7               4      OR  A
000AEE D80C C8              11      RET Z
       D80D                     CONSTX:
000AEF D80D CDDFF0          17      CALL    _FFLUSH
000AF2 D810 E5              11      PUSH    HL
000AF3 D811 2A90F0          16      LD  HL,(_KEYPS)
000AF6 D814 7C               4      LD  A,H
000AF7 D815 AD               4      XOR L
000AF8 D816 E1              10      POP HL
000AF9 D817 C6FF             7      ADD A,0FFH
000AFB D819 9F               4      SBC A,A
000AFC D81A C9              10      RET
                                
       D81B                     _SYS2A:     ;(BDOS)日付の獲得
       D81B                     _SYS2C:     ;(BDOS)時刻の獲得
000AFD D81B AF               4      XOR A
000AFE D81C 57               4      LD  D,A
000AFF D81D 5F               4      LD  E,A
000B00 D81E 67               4      LD  H,A
000B01 D81F 6F               4      LD  L,A
000B02 D820 C9              10      RET
                                
       D821                     ESC1:
000B03 D821 7B               4      LD  A,E
000B04 D822 FE41             7      CP  'A'
000B06 D824 CA19D9          10      JP  Z,CTRL1E
000B09 D827 FE42             7      CP  'B'
000B0B D829 CA40DA          10      JP  Z,CTRL1F
000B0E D82C FE43             7      CP  'C'
000B10 D82E CAECD8          10      JP  Z,CTRL1C
000B13 D831 FE44             7      CP  'D'
000B15 D833 CA10D9          10      JP  Z,CTRL1D
000B18 D836 FE45             7      CP  'E'
000B1A D838 2802            12      JR  Z,CT0CX
000B1C D83A FE6A             7      CP  'j'
       D83C                     CT0CX:
000B1E D83C CA25DA          10      JP  Z,CTRL0C
000B21 D83F FE48             7      CP  'H'
000B23 D841 CA92D9          10      JP  Z,CTRL0B
000B26 D844 FE4A             7      CP  'J'
000B28 D846 CA28DA          10      JP  Z,CTRL06
000B2B D849 FE4B             7      CP  'K'
000B2D D84B CA64D9          10      JP  Z,CTRL05
000B30 D84E FE4C             7      CP  'L'
000B32 D850 CA52DA          10      JP  Z,CTRL0E
000B35 D853 FE54             7      CP  'T'
000B37 D855 CA64D9          10      JP  Z,CTRL05
000B3A D858 FE78             7      CP  'x'
000B3C D85A 2804            12      JR  Z,ESC1X
000B3E D85C FE79             7      CP  'y'
000B40 D85E 2002            12      JR  NZ,ESC1Y
       D860                     ESC1X:
000B42 D860 3601            10      LD  (HL),1
       D862                     ESC1Y:
000B44 D862 FE3D             7      CP  '='
000B46 D864 2804            12      JR  Z,ESC1W
000B48 D866 FE59             7      CP  'Y'
000B4A D868 2002            12      JR  NZ,ESC1Z
       D86A                     ESC1W:
000B4C D86A 3602            10      LD  (HL),2
       D86C                     ESC1Z:
000B4E D86C FE20             7      CP  020H
000B50 D86E 3802            12      JR  C,ESC1C
000B52 D870 87               4      ADD A,A
000B53 D871 D0              11      RET NC
       D872                     ESC1C:
000B54 D872 E1              10      POP HL
000B55 D873 1832            12      JR  ANK
                                
       D875                     ESC:
000B57 D875 21D8D8          10      LD  HL,PRINTE5
000B5A D878 E5              11      PUSH    HL
000B5B D879 219BD8          10      LD  HL,ESCFLG
000B5E D87C 3600            10      LD  (HL),0
000B60 D87E 3D               4      DEC A
000B61 D87F 28A0            12      JR  Z,ESC1
000B63 D881 3D               4      DEC A
000B64 D882 2009            12      JR  NZ,ESC2
000B66 D884 3603            10      LD  (HL),3
000B68 D886 7B               4      LD  A,E
000B69 D887 D620             7      SUB 020H
000B6B D889 3290D8          13      LD  (ESCYP+1),A
000B6E D88C C9              10      RET
       D88D                     ESC2:
000B6F D88D 3D               4      DEC A
000B70 D88E C0              11      RET NZ
000B71 D88F 2600             7  ESCYP:  LD  H,0
000B73 D891 7B               4      LD  A,E
000B74 D892 D620             7      SUB 020H
000B76 D894 6F               4      LD  L,A
000B77 D895 C3D6F0          10      JP  _LOC
                                
       D898                     PRINT:
000B7A D898 C5              11      PUSH    BC
000B7B D899 E5              11      PUSH    HL
000B7C D89A 3E00             7      LD  A,000H      ;自己書き換え
       D89B                     ESCFLG  EQU $-1
000B7E D89C B7               4      OR  A
000B7F D89D 20D6            12      JR  NZ,ESC
                                
000B81 D89F 3E1F             7      LD  A,01FH
000B83 D8A1 BB               4      CP  E
000B84 D8A2 3038            12      JR  NC,CTRL
       D8A4                     INSFLG  EQU $
000B86 D8A4 01EED9          10      LD  BC,INSERT   ;自己書き換え
       D8A7                     ANK:
000B89 D8A7 3A96F0          13      LD  A,(_COLORF)
000B8C D8AA 4F               4      LD  C,A
000B8D D8AB 7B               4      LD  A,E
000B8E D8AC FE61             7      CP  'a'     ;英小文字
000B90 D8AE 3806            12      JR  C,PRT1
000B92 D8B0 FE7B             7      CP  'z'+1
000B94 D8B2 3002            12      JR  NC,PRT1
000B96 D8B4 CBF9             8      SET 7,C
       D8B6                     PRT1:
000B98 D8B6 FE86             7      CP  $86     ;ひらがな1(を－そ)
000B9A D8B8 3806            12      JR  C,PRT2
000B9C D8BA FEA0             7      CP  $A0
000B9E D8BC 3002            12      JR  NC,PRT2
000BA0 D8BE CBF9             8      SET 7,C
       D8C0                     PRT2:
000BA2 D8C0 FEE0             7      CP  $E0     ;ひらがな2(たーん)
000BA4 D8C2 3802            12      JR  C,PRT3
000BA6 D8C4 CBF9             8      SET 7,C
       D8C6                     PRT3:
000BA8 D8C6 2A8EF0          16      LD  HL,(_TXADR)
000BAB D8C9 7C               4      LD  A,H
000BAC D8CA C6D0             7      ADD A,0D0H
000BAE D8CC 67               4      LD  H,A
000BAF D8CD 42               4      LD  B,D
000BB0 D8CE 16EE             7      LD  D,HIGH CD_TABLE
000BB2 D8D0 1A               7      LD  A,(DE)
000BB3 D8D1 50               4      LD  D,B
000BB4 D8D2 CD57CF          17      CALL    IO_PRINT
000BB7 D8D5 CDECD8          17      CALL    CTRL1C
       D8D8                     PRINTE5:
000BBA D8D8 E1              10      POP HL
000BBB D8D9 C1              10      POP BC
000BBC D8DA AF               4      XOR A
000BBD D8DB C9              10      RET
                                
       D8DC                     CTRL:
000BBE D8DC 7B               4      LD  A,E
000BBF D8DD 87               4      ADD A,A
000BC0 D8DE F680             7      OR  080H
000BC2 D8E0 6F               4      LD  L,A
000BC3 D8E1 26F1             7      LD  H,HIGH CTRLTB
000BC5 D8E3 7E               7      LD  A,(HL)
000BC6 D8E4 2C               4      INC L
000BC7 D8E5 66               7      LD  H,(HL)
000BC8 D8E6 6F               4      LD  L,A
000BC9 D8E7 CD0BD7          17      CALL    JPHL
000BCC D8EA 18EC            12      JR  PRINTE5
                                
       D8EC                     CTRL1C:
000BCE D8EC ED4B8EF0        20      LD  BC,(_TXADR)
000BD2 D8F0 03               6      INC BC
       D8F1                     PRINTE3:
000BD3 D8F1 2118FC          10      LD  HL,0-WIDTH*LINE
000BD6 D8F4 A7               4      AND A
000BD7 D8F5 ED4A            15      ADC HL,BC
       D8F7                     PRINTE8:
000BD9 D8F7 2805            12      JR  Z,PRINT2
000BDB D8F9 ED438EF0        20      LD  (_TXADR),BC
       D8FD                     CTRL00:
000BDF D8FD C9              10      RET
                                
       D8FE                     PRINT2:
000BE0 D8FE CD58DA          17      CALL    SCR
000BE3 D901 21D8FF          10      LD  HL,0-WIDTH
000BE6 D904 09              11      ADD HL,BC
       D905                     SET_TXADR_HL:
000BE7 D905 228EF0          16      LD  (_TXADR),HL
000BEA D908 C9              10      RET
                                
       D909                     CTRL08:
000BEB D909 3AA4D8          13      LD  A,(INSFLG)
000BEE D90C FECD             7      CP  0CDH        ;CALL ????
000BF0 D90E 2823            12      JR  Z,CTRL02
       D910                     CTRL1D:
000BF2 D910 2A8EF0          16      LD  HL,(_TXADR)
000BF5 D913 7C               4      LD  A,H
000BF6 D914 B5               4      OR  L
000BF7 D915 C8              11      RET Z
000BF8 D916 2B               6      DEC HL
000BF9 D917 18EC            12      JR  SET_TXADR_HL
                                
       D919                     CTRL1E:
000BFB D919 ED4B8EF0        20      LD  BC,(_TXADR)
000BFF D91D 21D8FF          10      LD  HL,0-WIDTH
000C02 D920 09              11      ADD HL,BC
000C03 D921 D0              11      RET NC
000C04 D922 18E1            12      JR  SET_TXADR_HL
                                
       D924                     CTRL09:
000C06 D924 ED4B8EF0        20      LD  BC,(_TXADR)
000C0A D928 79               4      LD  A,C
000C0B D929 E6F8             7      AND 0F8H
000C0D D92B C608             7      ADD A,8
000C0F D92D 4F               4      LD  C,A
000C10 D92E 88               4      ADC A,B
000C11 D92F 91               4      SUB C
000C12 D930 47               4      LD  B,A
000C13 D931 18BE            12      JR  PRINTE3
                                
       D933                     CTRL02:
000C15 D933 CD10D9          17      CALL    CTRL1D
000C18 D936 C8              11      RET Z
000C19 D937 D5              11      PUSH    DE
000C1A D938 CDD3F0          17      CALL    _POS
000C1D D93B 54               4      LD  D,H
000C1E D93C 3E28             7      LD  A,WIDTH
000C20 D93E 95               4      SUB L
000C21 D93F 4F               4      LD  C,A
000C22 D940 0D               4      DEC C
000C23 D941 06D0             7      LD  B,0D0H
000C25 D943 2A8EF0          16      LD  HL,(_TXADR)
000C28 D946 09              11      ADD HL,BC
000C29 D947 47               4      LD  B,A
                                
000C2A D948 3A0FDA          13      LD  A,(MULINE)
000C2D D94B BA               4      CP  D
000C2E D94C 2007            12      JR  NZ,C02X1
000C30 D94E 112800          10      LD  DE,WIDTH
000C33 D951 19              11      ADD HL,DE
000C34 D952 78               4      LD  A,B
000C35 D953 83               4      ADD A,E
000C36 D954 47               4      LD  B,A
       D955                     C02X1:
000C37 D955 3A96F0          13      LD  A,(_COLORF) ;C:Color
000C3A D958 4F               4      LD  C,A
000C3B D959 3E                      DB  03EH        ;LD A,?
000C3C D95A 2B               6      DEC HL
000C3D D95B 329ECF          13      LD  (IO_INCDEC),A
000C40 D95E AF               4      XOR A       ;A:Text
000C41 D95F CD91CF          17      CALL    IO_INSBS
000C44 D962 D1              10      POP DE
000C45 D963 C9              10      RET
                                
       D964                     CTRL05:
000C46 D964 CDD3F0          17      CALL    _POS
000C49 D967 3E28             7      LD  A,WIDTH
000C4B D969 95               4      SUB L
000C4C D96A 47               4      LD  B,A
       D96B                     C08X1:
000C4D D96B 2A8EF0          16      LD  HL,(_TXADR)
000C50 D96E 7C               4      LD  A,H
000C51 D96F C6D0             7      ADD A,0D0H
000C53 D971 67               4      LD  H,A
       D972                     CLLINE:
000C54 D972 3A96F0          13      LD  A,(_COLORF)
000C57 D975 4F               4      LD  C,A
000C58 D976 AF               4      XOR A
000C59 D977 C381CF          10      JP  IO_CLLINE
                                
       D97A                     CTRL0D:
000C5C D97A CDD3F0          17      CALL    _POS
000C5F D97D 2E00             7      LD  L,0
       D97F                     LOC:
000C61 D97F C5              11      PUSH    BC
000C62 D980 E5              11      PUSH    HL
000C63 D981 CD9FD9          17      CALL    LOC1
000C66 D984 228EF0          16      LD  (_TXADR),HL
000C69 D987 E1              10      POP HL
000C6A D988 C1              10      POP BC
000C6B D989 C9              10      RET
                                
       D98A                     CTRL12:
000C6C D98A 21A4D8          10      LD  HL,INSFLG
000C6F D98D 7E               7      LD  A,(HL)
000C70 D98E EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
000C72 D990 77               7      LD  (HL),A
000C73 D991 C9              10      RET
                                
       D992                     CTRL0B:
000C74 D992 210000          10      LD  HL,0
000C77 D995 228EF0          16      LD  (_TXADR),HL
000C7A D998 C9              10      RET
                                
       D999                     CTRL1B:
000C7B D999 3E01             7      LD  A,1
000C7D D99B 329BD8          13      LD  (ESCFLG),A
000C80 D99E C9              10      RET
                                
       D99F                     LOC1:
000C81 D99F D5              11      PUSH    DE
000C82 D9A0 4D               4      LD  C,L
000C83 D9A1 0608             7      LD  B,8
000C85 D9A3 5C               4      LD  E,H
000C86 D9A4 210028          10      LD  HL,WIDTH*256
000C89 D9A7 55               4      LD  D,L ;L=0
       D9A8                     LOC2:
000C8A D9A8 29              11      ADD HL,HL
000C8B D9A9 3001            12      JR  NC,LOC3
000C8D D9AB 19              11      ADD HL,DE
       D9AC                     LOC3:
000C8E D9AC 10FA            13      DJNZ    LOC2
000C90 D9AE 09              11      ADD HL,BC
000C91 D9AF D1              10      POP DE
000C92 D9B0 C9              10      RET
                                
       D9B1                     CONOUT1:
                                ;   CALL    CURSOR
000C93 D9B1 59               4      LD  E,C
000C94 D9B2 CDCDF0          17      CALL    _PRINT
000C97 D9B5 7B               4      LD  A,E
000C98 D9B6 FE0A             7      CP  00AH
000C9A D9B8 2006            12      JR  NZ,CURSOR
000C9C D9BA CD7AD9          17      CALL    CTRL0D
000C9F D9BD CD64D9          17      CALL    CTRL05
       D9C0                     CURSOR:
000CA2 D9C0 C9              10      RET
                                
       D9C1                     CTRL07:
000CA3 D9C1 06E0             7      LD  B,0E0H
000CA5 D9C3 2162F0          10      LD  HL,BEEPD+1
       D9C6                     C07X0:
000CA8 D9C6 4E               7      LD  C,(HL)
000CA9 D9C7 23               6      INC HL
000CAA D9C8 7E               7      LD  A,(HL)
000CAB D9C9 23               6      INC HL
000CAC D9CA CD4FCF          17      CALL    WRMMIO_BC
000CAF D9CD 7D               4      LD  A,L
000CB0 D9CE FE6C             7      CP  (BEEPD+1+M7BEEPE-M7BEEPD)&255
000CB2 D9D0 20F4            12      JR  NZ,C07X0
000CB4 D9D2 0610             7      LD  B,16
       D9D4                     C07X1:
000CB6 D9D4 CD2DCF          17      CALL    RD556VSYNC
000CB9 D9D7 87               4      ADD A,A
000CBA D9D8 30FA            12      JR  NC,C07X1
       D9DA                     C07X2:
000CBC D9DA CD2DCF          17      CALL    RD556VSYNC
000CBF D9DD 87               4      ADD A,A
000CC0 D9DE 38FA            12      JR  C,C07X2
000CC2 D9E0 10F2            13      DJNZ    C07X1
                                
000CC4 D9E2 AF               4      XOR A
000CC5 D9E3 2108E0          10      LD  HL,0E008H
000CC8 D9E6 CD3FCF          17      CALL    WRMMIO
000CCB D9E9 2E03             7      LD  L,003H      ;SOUND MASK (MZ-1500)
000CCD D9EB C33FCF          10      JP  WRMMIO
                                
       D9EE                     INSERT:
000CD0 D9EE D5              11      PUSH    DE
000CD1 D9EF CDD3F0          17      CALL    _POS
000CD4 D9F2 54               4      LD  D,H
000CD5 D9F3 3E28             7      LD  A,WIDTH
000CD7 D9F5 95               4      SUB L
000CD8 D9F6 47               4      LD  B,A
000CD9 D9F7 2A8EF0          16      LD  HL,(_TXADR)
000CDC D9FA 7C               4      LD  A,H
000CDD D9FB C6D0             7      ADD A,0D0H
000CDF D9FD 67               4      LD  H,A
000CE0 D9FE 3A96F0          13      LD  A,(_COLORF) ;C:Color
000CE3 DA01 4F               4      LD  C,A
000CE4 DA02 3E                      DB  03EH        ;LD A,?
000CE5 DA03 23               6      INC HL
000CE6 DA04 329ECF          13      LD  (IO_INCDEC),A
000CE9 DA07 AF               4      XOR A       ;A:Text
000CEA DA08 CD91CF          17      CALL    IO_INSBS
000CED DA0B B7               4      OR  A
000CEE DA0C 2005            12      JR  NZ,INS1
       DA0F                     MULINE  EQU $+1
000CF0 DA0E 3EFF             7      LD  A,-1
000CF2 DA10 92               4      SUB D
000CF3 DA11 2010            12      JR  NZ,INS2
       DA13                     INS1:
000CF5 DA13 0628             7      LD  B,WIDTH
000CF7 DA15 F5              11      PUSH    AF
000CF8 DA16 3E                      DB  03EH        ;LD A,?
000CF9 DA17 23               6      INC HL
000CFA DA18 329ECF          13      LD  (IO_INCDEC),A
000CFD DA1B F1              10      POP AF
000CFE DA1C CD91CF          17      CALL    IO_INSBS
000D01 DA1F 7A               4      LD  A,D
000D02 DA20 320FDA          13      LD  (MULINE),A
       DA23                     INS2:
000D05 DA23 D1              10      POP DE
000D06 DA24 C9              10      RET
                                
       DA25                     CTRL0C:
000D07 DA25 CD92D9          17      CALL    CTRL0B
       DA28                     CTRL06:
000D0A DA28 D5              11      PUSH    DE
000D0B DA29 E5              11      PUSH    HL
000D0C DA2A ED5B8EF0        20      LD  DE,(_TXADR)
000D10 DA2E 3A96F0          13      LD  A,(_COLORF)
000D13 DA31 326ECF          13      LD  (ICSMC),A
000D16 DA34 C362CF          10      JP  IO_CLR
                                
       DA37                     CTRL04:
000D19 DA37 CDD3F0          17      CALL    _POS
000D1C DA3A 7D               4      LD  A,L
000D1D DA3B B7               4      OR  A
000D1E DA3C C8              11      RET Z
       DA3D                     CTRL03:
000D1F DA3D CD7AD9          17      CALL    CTRL0D
       DA40                     CTRL0A:
       DA40                     CTRL1F:
000D22 DA40 2A8EF0          16      LD  HL,(_TXADR)
000D25 DA43 012800          10      LD  BC,WIDTH
000D28 DA46 09              11      ADD HL,BC
000D29 DA47 44               4      LD  B,H
000D2A DA48 4D               4      LD  C,L
000D2B DA49 2118FC          10      LD  HL,0-WIDTH*LINE
000D2E DA4C 09              11      ADD HL,BC
000D2F DA4D 3F               4      CCF
000D30 DA4E 9F               4      SBC A,A
000D31 DA4F C3F7D8          10      JP  PRINTE8
                                
       DA52                     CTRL0E:
000D34 DA52 CDD3F0          17      CALL    _POS
000D37 DA55 7C               4      LD  A,H
000D38 DA56 1804            12      JR  SCR1
       DA58                     SCR:
000D3A DA58 3A97F0          13      LD  A,(_LINE)
000D3D DA5B 3D               4      DEC A
       DA5C                     SCR1:
000D3E DA5C C5              11      PUSH    BC
000D3F DA5D D5              11      PUSH    DE
000D40 DA5E E5              11      PUSH    HL
000D41 DA5F 1100D0          10      LD  DE,0D000H
000D44 DA62 2128D0          10      LD  HL,0D000H+WIDTH
                                
000D47 DA65 47               4      LD  B,A
000D48 DA66 B7               4      OR  A
000D49 DA67 C3A5CF          10      JP  IO_SCRUP
                                
       DA6A                     POS:
000D4C DA6A 2A8EF0          16      LD  HL,(_TXADR)
000D4F DA6D C5              11      PUSH    BC
000D50 DA6E 01D8FF          10      LD  BC,0-WIDTH
000D53 DA71 AF               4      XOR A
       DA72                     POS1:
000D54 DA72 09              11      ADD HL,BC
000D55 DA73 3C               4      INC A
000D56 DA74 38FC            12      JR  C,POS1
000D58 DA76 ED42            15      SBC HL,BC
000D5A DA78 3D               4      DEC A
000D5B DA79 67               4      LD  H,A
000D5C DA7A C1              10      POP BC
000D5D DA7B A7               4      AND A
000D5E DA7C C9              10      RET
                                
       DA7D                     GETL:
000D5F DA7D CDD3F0          17      CALL    _POS
000D62 DA80 E5              11      PUSH    HL
000D63 DA81 3ECD             7      LD  A,0CDH      ;CALL ????
000D65 DA83 32A4D8          13      LD  (INSFLG),A
       DA86                     GETL1:
000D68 DA86 CD8FD7          17      CALL    _SYS08
000D6B DA89 FE09             7      CP  9
000D6D DA8B 2008            12      JR  NZ,GETL1V
000D6F DA8D 2130FF          10      LD  HL,KBUF
000D72 DA90 CD88D4          17      CALL    MSX
000D75 DA93 18F1            12      JR  GETL1
       DA95                     GETL1V:
000D77 DA95 5F               4      LD  E,A
000D78 DA96 CDD3F0          17      CALL    _POS
000D7B DA99 CDCDF0          17      CALL    _PRINT
000D7E DA9C 7B               4      LD  A,E
000D7F DA9D FE20             7      CP  $20
000D81 DA9F 3809            12      JR  C,GETL1V1
000D83 DAA1 7D               4      LD  A,L
000D84 DAA2 FE27             7      CP  WIDTH-1
000D86 DAA4 2004            12      JR  NZ,GETL1V1
000D88 DAA6 7C               4      LD  A,H
000D89 DAA7 320FDA          13      LD  (MULINE),A
       DAAA                     GETL1V1:
000D8C DAAA 7B               4      LD  A,E
000D8D DAAB FE0D             7      CP  00DH
000D8F DAAD 20D7            12      JR  NZ,GETL1
000D91 DAAF 3E01             7      LD  A,1     ;LD BC,????
000D93 DAB1 32A4D8          13      LD  (INSFLG),A
000D96 DAB4 1130FF          10      LD  DE,KBUF
000D99 DAB7 0628             7      LD  B,WIDTH
000D9B DAB9 CD26D3          17      CALL    ZERO_MEMORY_DE
                                
000D9E DABC D1              10      POP DE
000D9F DABD CDD3F0          17      CALL    _POS
000DA2 DAC0 6B               4      LD  L,E
000DA3 DAC1 3E28             7      LD  A,WIDTH
000DA5 DAC3 95               4      SUB L
000DA6 DAC4 57               4      LD  D,A
                                
000DA7 DAC5 3A0FDA          13      LD  A,(MULINE)
000DAA DAC8 94               4      SUB H
000DAB DAC9 2806            12      JR  Z,GL2X
000DAD DACB 3C               4      INC A
000DAE DACC 200C            12      JR  NZ,GL3X
000DB0 DACE 25               4      DEC H
000DB1 DACF 1805            12      JR  GL4X
       DAD1                     GL2X:
000DB3 DAD1 3E1F             7      LD  A,$1F
000DB5 DAD3 CD79D7          17      CALL    MSG_A
       DAD6                     GL4X:
000DB8 DAD6 7A               4      LD  A,D
000DB9 DAD7 C628             7      ADD A,WIDTH
000DBB DAD9 57               4      LD  D,A
       DADA                     GL3X:
000DBC DADA CD9FD9          17      CALL    LOC1
000DBF DADD 4D               4      LD  C,L
000DC0 DADE 7C               4      LD  A,H
000DC1 DADF C6D0             7      ADD A,0D0H
000DC3 DAE1 47               4      LD  B,A
000DC4 DAE2 5A               4      LD  E,D
000DC5 DAE3 2130FF          10      LD  HL,KBUF
       DAE6                     GETL2:
000DC8 DAE6 CDD0F0          17      CALL    _SCRN
000DCB DAE9 03               6      INC BC
000DCC DAEA 77               7      LD  (HL),A
000DCD DAEB 23               6      INC HL
000DCE DAEC 1D               4      DEC E
000DCF DAED 20F7            12      JR  NZ,GETL2
       DAEF                     GETL3:
000DD1 DAEF 2B               6      DEC HL
000DD2 DAF0 7E               7      LD  A,(HL)
000DD3 DAF1 FE21             7      CP  021H
000DD5 DAF3 D0              11      RET NC
000DD6 DAF4 3600            10      LD  (HL),0
000DD8 DAF6 15               4      DEC D
000DD9 DAF7 20F6            12      JR  NZ,GETL3
000DDB DAF9 C9              10      RET
                                
       DAFA                     INKEY:
000DDC DAFA FB               4      EI
000DDD DAFB E5              11      PUSH    HL
000DDE DAFC 2A90F0          16      LD  HL,(_KEYPS)
000DE1 DAFF 7C               4      LD  A,H
000DE2 DB00 AD               4      XOR L
000DE3 DB01 280B            12      JR  Z,INKEY1
000DE5 DB03 7C               4      LD  A,H
000DE6 DB04 3C               4      INC A
000DE7 DB05 E61F             7      AND 01FH
000DE9 DB07 3291F0          13      LD  (_KEYPS+1),A
000DEC DB0A 6F               4      LD  L,A
000DED DB0B 26F3             7      LD  H,HIGH KEYBF
000DEF DB0D 7E               7      LD  A,(HL)
       DB0E                     INKEY1:
000DF0 DB0E E1              10      POP HL
000DF1 DB0F B7               4      OR  A
000DF2 DB10 C9              10      RET
                                
       DB11                     INKEYB:
000DF3 DB11 C1              10      POP BC
000DF4 DB12 CB47             8      BIT 0,A
000DF6 DB14 3E08             7      LD  A,8
000DF8 DB16 2002            12      JR  NZ,INKEYD
000DFA DB18 3E03             7      LD  A,3
       DB1A                     INKEYD:
000DFC DB1A 3292F0          13      LD  (_KEYD),A
000DFF DB1D B7               4      OR  A
000E00 DB1E C9              10      RET
                                
       DB1F                     CHKEY:
000E01 DB1F C5              11      PUSH    BC
000E02 DB20 3E88             7      LD  A,$88
000E04 DB22 CD20CF          17      CALL    RDKEYDATA
000E07 DB25 4F               4      LD  C,A
000E08 DB26 3A93F0          13      LD  A,(_KEYST)
000E0B DB29 B9               4      CP  C
000E0C DB2A 79               4      LD  A,C
000E0D DB2B 3293F0          13      LD  (_KEYST),A
000E10 DB2E 280C            12      JR  Z,KEYST2
000E12 DB30 3A92F0          13      LD  A,(_KEYD)
000E15 DB33 B7               4      OR  A
000E16 DB34 2805            12      JR  Z,KEYST1
000E18 DB36 3E20             7      LD  A,020H      ;JR NZ,?
000E1A DB38 321CD7          13      LD  (SETKEY1_SWC),A
       DB3B                     KEYST1:
000E1D DB3B 79               4      LD  A,C
       DB3C                     KEYST2:
000E1E DB3C CB7F             8      BIT 7,A
000E20 DB3E 28D1            12      JR  Z,INKEYB
000E22 DB40 E5              11      PUSH    HL
000E23 DB41 0E87             7      LD  C,$87
000E25 DB43 2140ED          10      LD  HL,KEY_TABLE
000E28 DB46 CB47             8      BIT 0,A
000E2A DB48 2003            12      JR  NZ,CHKEY0
000E2C DB4A 2180ED          10      LD  HL,SHIFT_TABLE
       DB4D                     CHKEY0:
000E2F DB4D CB77             8      BIT 6,A
000E31 DB4F 2003            12      JR  NZ,CHKEY1
000E33 DB51 21C0ED          10      LD  HL,CTRL_TABLE
       DB54                     CHKEY1:
000E36 DB54 79               4      LD  A,C
000E37 DB55 CD20CF          17      CALL    RDKEYDATA
000E3A DB58 0608             7      LD  B,8
       DB5A                     CHKEY2:
000E3C DB5A 87               4      ADD A,A
000E3D DB5B 300A            12      JR  NC,CHKEY3
000E3F DB5D 23               6      INC HL
000E40 DB5E 10FA            13      DJNZ    CHKEY2
000E42 DB60 0D               4      DEC C
000E43 DB61 CB79             8      BIT 7,C
000E45 DB63 20EF            12      JR  NZ,CHKEY1
000E47 DB65 AF               4      XOR A
000E48 DB66 06                      DB  $06     ;LD B,?? 次の1バイトを飛ばす
       DB67                     CHKEY3:
000E49 DB67 7E               7      LD  A,(HL)
000E4A DB68 E1              10      POP HL
000E4B DB69 C1              10      POP BC
000E4C DB6A 18AE            12      JR  INKEYD
                                
       DB6C                     SCRN:
000E4E DB6C E5              11      PUSH    HL
000E4F DB6D CD47CF          17      CALL    RDMMIO_BC
000E52 DB70 6F               4      LD  L,A
000E53 DB71 26EF             7      LD  H,HIGH DC_TABLE
000E55 DB73 7E               7      LD  A,(HL)
000E56 DB74 FE41             7      CP  'A'     ;英小文字チェック
000E58 DB76 380E            12      JR  C,SCRN1
000E5A DB78 FE5B             7      CP  'Z'+1
000E5C DB7A DC88DB          17      CALL    C,SCRNC
000E5F DB7D FEA6             7      CP  $A6     ;ひらがなチェック
000E61 DB7F 3805            12      JR  C,SCRN1
000E63 DB81 FEE0             7      CP  $E0
000E65 DB83 DC88DB          17      CALL    C,SCRNC
       DB86                     SCRN1:
000E68 DB86 E1              10      POP HL
000E69 DB87 C9              10      RET
                                
       DB88                     SCRNC:
000E6A DB88 6F               4      LD  L,A
000E6B DB89 60               4      LD  H,B
000E6C DB8A CBD8             8      SET 3,B
000E6E DB8C CD47CF          17      CALL    RDMMIO_BC
000E71 DB8F 44               4      LD  B,H
000E72 DB90 CB7F             8      BIT 7,A
000E74 DB92 7D               4      LD  A,L
000E75 DB93 C8              11      RET Z
000E76 DB94 FE5B             7      CP  'Z'+1
000E78 DB96 3804            12      JR  C,SCRNC_ADD
000E7A DB98 FEC0             7      CP  $C0
000E7C DB9A 3803            12      JR  C,SCRNC_SUB
       DB9C                     SCRNC_ADD:
000E7E DB9C C620             7      ADD A,$20
000E80 DB9E C9              10      RET
       DB9F                     SCRNC_SUB:
000E81 DB9F D620             7      SUB $20
000E83 DBA1 C9              10      RET
       DBA2                     C_MON:
000E84 DBA2 2100D8          10      LD  HL,0D800H
       DBA5                     MON1:
000E87 DBA5 3E71             7      LD  A,071H
000E89 DBA7 CD3FCF          17      CALL    WRMMIO
000E8C DBAA 23               6      INC HL
000E8D DBAB CB54             8      BIT 2,H
000E8F DBAD 28F6            12      JR  Z,MON1
000E91 DBAF C3D9CF          10      JP  IO_MON
[EOF:M7IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
                                ;   【注意】バイナリサイズを下位1バイトを0丁度に調整する必要あり(X1/88)
       0000                     CHECK_FILE_SIZE EQU (FILEC-FILE_E) & 0FFH
       DBB2                     FILEC:
000E94 DBB2 CDBDDB          17      CALL    FILE
       DBB5                     FILEC2:
000E97 DBB5 3A15F0          13      LD  A,(FDRV+1)
000E9A DBB8 FE20             7      CP  020H
000E9C DBBA C8              11      RET Z
000E9D DBBB 1839            12      JR  SETDIR1
                                
       DBBD                     FILE:
000E9F DBBD AF               4      XOR A
000EA0 DBBE 3214F0          13      LD  (FDRV),A
000EA3 DBC1 67               4      LD  H,A
000EA4 DBC2 6F               4      LD  L,A
000EA5 DBC3 2222F0          16      LD  (FDRV+14),HL
000EA8 DBC6 CD93DC          17      CALL    SPCUT
000EAB DBC9 CD78DC          17      CALL    CCHK3
000EAE DBCC 2812            12      JR  Z,DEVI1
000EB0 DBCE 13               6      INC DE
000EB1 DBCF 1A               7      LD  A,(DE)
000EB2 DBD0 1B               6      DEC DE
000EB3 DBD1 FE3A             7      CP  ':'
000EB5 DBD3 200B            12      JR  NZ,DEVI1
000EB7 DBD5 1A               7      LD  A,(DE)      ;DRIVE
000EB8 DBD6 CDD9DE          17      CALL    CAP
000EBB DBD9 D640             7      SUB '@'
000EBD DBDB 13               6      INC DE
000EBE DBDC 13               6      INC DE
000EBF DBDD 3214F0          13      LD  (FDRV),A
       DBE0                     DEVI1:
000EC2 DBE0 1A               7      LD  A,(DE)
000EC3 DBE1 D65C             7      SUB 05CH        ;\
000EC5 DBE3 2009            12      JR  NZ,NOROOT
000EC7 DBE5 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
000EC8 DBE6 222EF0          16      LD  (FDRV+26),HL
000ECB DBE9 2C               4      INC L
000ECC DBEA 2222F0          16      LD  (FDRV+14),HL
000ECF DBED 13               6      INC DE
       DBEE                     NOROOT:
                                
       DBEE                     SETDIR:
000ED0 DBEE CD19DC          17      CALL    FILED
000ED3 DBF1 1A               7      LD  A,(DE)
000ED4 DBF2 FE5C             7      CP  05CH        ;\
000ED6 DBF4 C0              11      RET NZ
000ED7 DBF5 13               6      INC DE
       DBF6                     SETDIR1:
000ED8 DBF6 3E10             7      LD  A,010H      ;Directory
000EDA DBF8 3221F0          13      LD  (FDRV+13),A
000EDD DBFB D5              11      PUSH    DE
000EDE DBFC 1114F0          10      LD  DE,FDRV
000EE1 DBFF 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
000EE3 DC01 CD48D4          17      CALL    BDOS0
000EE6 DC04 D1              10      POP DE
000EE7 DC05 B7               4      OR  A
000EE8 DC06 C0              11      RET NZ
                                
000EE9 DC07 3A21F0          13      LD  A,(FDRV+13)
000EEC DC0A E610             7      AND 010H        ;ディレクトリ
000EEE DC0C C8              11      RET Z
                                
000EEF DC0D CD60DC          17      CALL    FILEI
000EF2 DC10 2A2EF0          16      LD  HL,(FDRV+26)
000EF5 DC13 23               6      INC HL
000EF6 DC14 2222F0          16      LD  (FDRV+14),HL
000EF9 DC17 18D5            12      JR  SETDIR
                                
       DC19                     FILED:
000EFB DC19 CD60DC          17      CALL    FILEI
000EFE DC1C 2115F0          10      LD  HL,FNAME
                                
000F01 DC1F 0608             7      LD  B,8
       DC21                     FILE2:
000F03 DC21 CD6DDC          17      CALL    CCHKF
000F06 DC24 C8              11      RET Z
000F07 DC25 FE2A             7      CP  '*'
000F09 DC27 282E            12      JR  Z,FILE9
000F0B DC29 FE2E             7      CP  '.'
000F0D DC2B 280C            12      JR  Z,FILE4
000F0F DC2D 77               7      LD  (HL),A
000F10 DC2E 23               6      INC HL
000F11 DC2F 10F0            13      DJNZ    FILE2
                                
       DC31                     FILE3:
000F13 DC31 CD6DDC          17      CALL    CCHKF
000F16 DC34 C8              11      RET Z
000F17 DC35 FE2E             7      CP  '.'
000F19 DC37 20F8            12      JR  NZ,FILE3
                                
       DC39                     FILE4:
000F1B DC39 211DF0          10      LD  HL,FNAME+8
000F1E DC3C 0603             7      LD  B,3
                                
       DC3E                     FILE4L:
000F20 DC3E CD6DDC          17      CALL    CCHKF
000F23 DC41 C8              11      RET Z
000F24 DC42 FE2E             7      CP  '.'
000F26 DC44 2008            12      JR  NZ,FILE12
000F28 DC46 3215F0          13      LD  (FNAME),A   ;Parent directory(..)
000F2B DC49 3216F0          13      LD  (FNAME+1),A
000F2E DC4C 3E20             7      LD  A,020H
       DC4E                     FILE12:
000F30 DC4E FE2A             7      CP  '*'
000F32 DC50 280A            12      JR  Z,FILE10
000F34 DC52 77               7      LD  (HL),A
000F35 DC53 23               6      INC HL
000F36 DC54 10E8            13      DJNZ    FILE4L
000F38 DC56 C9              10      RET
                                
       DC57                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000F39 DC57 CD5CDC          17      CALL    FILE10
000F3C DC5A 18D5            12      JR  FILE3
                                
       DC5C                     FILE10:
000F3E DC5C 3E3F             7      LD  A,'?'
000F40 DC5E 1808            12      JR  FILL_MEMORY
       DC60                     FILEI:              ;名前＋拡張子をスペースで初期化
000F42 DC60 3E20             7      LD  A,020H
000F44 DC62 01000B          10      LD  BC,11*256   ;C=0にしておく
000F47 DC65 2115F0          10      LD  HL,FNAME
       DC68                     FILL_MEMORY:            ;HLからBバイトAで埋める
000F4A DC68 77               7      LD  (HL),A
000F4B DC69 23               6      INC HL
000F4C DC6A 10FC            13      DJNZ    FILL_MEMORY
000F4E DC6C C9              10      RET
                                
       DC6D                     CCHKF:
000F4F DC6D 1A               7      LD  A,(DE)
000F50 DC6E CD75DC          17      CALL    CCHK2
000F53 DC71 C8              11      RET Z
000F54 DC72 C3E1DF          10      JP  FKAN
                                
       DC75                     CCHK2:
000F57 DC75 0C               4      INC C
000F58 DC76 0D               4      DEC C
000F59 DC77 C0              11      RET NZ
       DC78                     CCHK3:              ;ZF=1 で使えない文字
000F5A DC78 FE2B             7      CP  '+'
000F5C DC7A C8              11      RET Z
000F5D DC7B FE2C             7      CP  ','
000F5F DC7D C8              11      RET Z
000F60 DC7E FE2F             7      CP  '/'
000F62 DC80 C8              11      RET Z
000F63 DC81 FE3A             7      CP  ':'
000F65 DC83 C8              11      RET Z
000F66 DC84 FE3B             7      CP  ';'
000F68 DC86 C8              11      RET Z
000F69 DC87 FE3D             7      CP  '='
000F6B DC89 C8              11      RET Z
000F6C DC8A FE5C             7      CP  05CH    ;\
000F6E DC8C C8              11      RET Z
000F6F DC8D FE20             7      CP  020H
000F71 DC8F D0              11      RET NC
000F72 DC90 BF               4      CP  A       ;Z=1
000F73 DC91 C9              10      RET
                                
       DC92                     SS1:
000F74 DC92 13               6      INC DE
       DC93                     SPCUT:              ;スペースをカット
000F75 DC93 1A               7      LD  A,(DE)
000F76 DC94 FE20             7      CP  020H
000F78 DC96 28FA            12      JR  Z,SS1
000F7A DC98 C9              10      RET
                                
       DC99                     SETDRVF:
000F7B DC99 1114F0          10      LD  DE,FDRV
       DC9C                     SETDRV0:
000F7E DC9C CDA5DC          17      CALL    SETDRV
000F81 DC9F FDE1            14      POP IY
000F83 DCA1 C1              10      POP BC
000F84 DCA2 D1              10      POP DE
000F85 DCA3 E1              10      POP HL
000F86 DCA4 C9              10      RET
                                
       DCA5                     SETDRV:
000F87 DCA5 E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
000F88 DCA6 D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
000F89 DCA7 C5              11      PUSH    BC
000F8A DCA8 1A               7      LD  A,(DE)
000F8B DCA9 D5              11      PUSH    DE
000F8C DCAA FDE3            23      EX  (SP),IY
                                
000F8E DCAC CDB3DC          17      CALL    GETDRV
000F91 DCAF CDD9F0          17      CALL    _CHGDRV
                                
000F94 DCB2 E9               4      JP  (HL)
                                
       DCB3                     GETDRV:
000F95 DCB3 CDC6DC          17      CALL    GETDRV1
000F98 DCB6 3288F0          13      LD  (_DRV),A
000F9B DCB9 C9              10      RET
                                
       DCBA                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
000F9C DCBA CDC6DC          17      CALL    GETDRV1
000F9F DCBD C5              11      PUSH    BC
000FA0 DCBE 4F               4      LD  C,A
000FA1 DCBF 1A               7      LD  A,(DE)
000FA2 DCC0 CDC6DC          17      CALL    GETDRV1
000FA5 DCC3 A9               4      XOR C
000FA6 DCC4 C1              10      POP BC
000FA7 DCC5 C9              10      RET
       DCC6                     GETDRV1:
000FA8 DCC6 E67F             7      AND 07FH
000FAA DCC8 D601             7      SUB 001H
000FAC DCCA D0              11      RET NC
000FAD DCCB 3A0400          13      LD  A,(_DVSW)   ;Current Drive
000FB0 DCCE C9              10      RET
                                
       DCCF                     SOPENX:
000FB1 DCCF 1139F0          10      LD  DE,SFILE
000FB4 DCD2 FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
000FB7 DCD5 CDBADC          17      CALL    IS_SAME_DRV_A_DE
000FBA DCD8 2024            12      JR  NZ,SOPEN
000FBC DCDA 13               6      INC DE
000FBD DCDB FDE5            15      PUSH    IY
000FBF DCDD E1              10      POP HL
000FC0 DCDE 23               6      INC HL
000FC1 DCDF CD6ADE          17      CALL    CPFILE
000FC4 DCE2 201A            12      JR  NZ,SOPEN
                                
000FC6 DCE4 2AF4F1          16      LD  HL,(SCDIR)
000FC9 DCE7 FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
000FCC DCEA FD740F          19      LD  (IY+15),H
                                
000FCF DCED 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
000FD2 DCF0 229FF0          16      LD  (_FILEN),HL
                                
000FD5 DCF3 ED5BF6F1        20      LD  DE,(SFBPS)
000FD9 DCF7 2139F0          10      LD  HL,SFILE
000FDC DCFA 36FF            10      LD  (HL),0FFH
000FDE DCFC 23               6      INC HL
000FDF DCFD C9              10      RET
       DCFE                     SOPEN:
000FE0 DCFE 2112DE          10      LD  HL,FILESE
       DD01                     SOPENC:
000FE3 DD01 223ADD          16      LD  (OPENPAT),HL
                                
000FE6 DD04 CDE2F0          17      CALL    _RDFATX     ;Detect Media
000FE9 DD07 3856            12      JR  C,RDDERR
                                
000FEB DD09 AF               4      XOR A
000FEC DD0A 329FF0          13      LD  (_FILEN),A
000FEF DD0D CD16DF          17      CALL    LDDIRX1     ;A=0で呼び出す
000FF2 DD10 2818            12      JR  Z,SDIRX1
                                
000FF4 DD12 CD03DE          17      CALL    READ_DIR    ;Sub Directory
000FF7 DD15 3808            12      JR  C,SDIRX0
000FF9 DD17 2A7EF1          16      LD  HL,(_DTBUF)
000FFC DD1A 7E               7      LD  A,(HL)
000FFD DD1B FE2E             7      CP  '.'
000FFF DD1D 280F            12      JR  Z,SOPEN1
       DD1F                     SDIRX0:
001001 DD1F AF               4      XOR A
001002 DD20 32A0F0          13      LD  (_DIRF),A
001005 DD23 FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
001009 DD27 FD770F          19      LD  (IY+15),A
       DD2A                     SDIRX1:
00100C DD2A ED5BFCF1        20      LD  DE,(_DIRPS) ;Root Directory
       DD2E                     SOPEN1:
001010 DD2E 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       DD2F                     SDECPAT EQU $-1
       DD30                     SOPEN1X:
001012 DD30 CD03DE          17      CALL    READ_DIR    ;FILE SEARCH
001015 DD33 382A            12      JR  C,RDDERR
001017 DD35 2A7EF1          16      LD  HL,(_DTBUF)
       DD38                     SOPEN2:
00101A DD38 D5              11      PUSH    DE
00101B DD39 CD12DE          17      CALL    FILESE      ;(self-modifying code)
       DD3A                     OPENPAT EQU $-2
00101E DD3C D1              10      POP DE
00101F DD3D 386D            12      JR  C,SOPENE
001021 DD3F 281B            12      JR  Z,SCF_FF_RET
       DD41                     SOPEN3:
001023 DD41 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
001026 DD44 B7               4      OR  A
001027 DD45 200C            12      JR  NZ,SOPEN5
001029 DD47 13               6      INC DE      ;ルートディレクトリ
00102A DD48 E5              11      PUSH    HL
00102B DD49 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       DD4A                     MD_PAT  EQU $-2
00102E DD4C ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
001030 DD4E E1              10      POP HL
001031 DD4F 20DD            12      JR  NZ,SOPEN1
001033 DD51 1807            12      JR  SOPEN6
       DD53                     SOPEN5:
001035 DD53 CD1DE6          17      CALL    GNCLX       ;END DIR
001038 DD56 D8              11      RET C
001039 DD57 CDCADE          17      CALL    ENDCL
       DD5A                     SOPEN6:
00103C DD5A 38D2            12      JR  C,SOPEN1
       DD5C                     SCF_FF_RET:
00103E DD5C 37               4      SCF         ;CF=1
00103F DD5D 9F               4      SBC A,A     ;A=0FFH
001040 DD5E C9              10      RET
                                
       DD5F                     RDDERR:
001041 DD5F BF               4      CP  A       ;READ ERR CF=1 ZF=1
001042 DD60 37               4      SCF
001043 DD61 C9              10      RET
                                
       DD62                     NOPEN:
001044 DD62 2112DE          10      LD  HL,FILESE
001047 DD65 223ADD          16      LD  (OPENPAT),HL
00104A DD68 FD2A98F0        20      LD  IY,(_FCB)
00104E DD6C CDF4DF          17      CALL    CHKWILDX
001051 DD6F 30EB            12      JR  NC,SCF_FF_RET
001053 DD71 FD7E00          19      LD  A,(IY+0)
001056 DD74 CDB3DC          17      CALL    GETDRV
001059 DD77 CDD9F0          17      CALL    _CHGDRV
00105C DD7A D8              11      RET C
00105D DD7B 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
001060 DD7E 229FF0          16      LD  (_FILEN),HL
                                
001063 DD81 CD11DF          17      CALL    LDDIRX
001066 DD84 ED5B9AF0        20      LD  DE,(_FBPS)
00106A DD88 CD03DE          17      CALL    READ_DIR
00106D DD8B 38D2            12      JR  C,RDDERR
00106F DD8D 3A9EF0          13      LD  A,(_FBCNT)
001072 DD90 3D               4      DEC A
001073 DD91 28AE            12      JR  Z,SOPEN3
       DD93                     NOPEN2:
001075 DD93 2A9CF0          16      LD  HL,(_FBAD)
001078 DD96 012000          10      LD  BC,020H
00107B DD99 09              11      ADD HL,BC
00107C DD9A 4F               4      LD  C,A
00107D DD9B 189B            12      JR  SOPEN2
                                
       DD9D                     SOPENE2:
00107F DD9D 229CF0          16      LD  (_FBAD),HL
001082 DDA0 79               4      LD  A,C
001083 DDA1 329EF0          13      LD  (_FBCNT),A
001086 DDA4 ED539AF0        20      LD  (_FBPS),DE
00108A DDA8 FD2298F0        20      LD  (_FCB),IY
       DDAC                     SOPENE:
00108E DDAC AF               4      XOR A
00108F DDAD C9              10      RET
                                
       DDAE                     COPEN:
001090 DDAE FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
001094 DDB2 212FDE          10      LD  HL,NEXTSE
001097 DDB5 CD01DD          17      CALL    SOPENC
00109A DDB8 D0              11      RET NC
00109B DDB9 C8              11      RET Z
00109C DDBA 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
00109F DDBD B7               4      OR  A
0010A0 DDBE 37               4      SCF
0010A1 DDBF C8              11      RET Z       ;ルートディレクトリ
0010A2 DDC0 0601             7      LD  B,1
0010A4 DDC2 CD53E0          17      CALL    WRDF
0010A7 DDC5 D8              11      RET C
0010A8 DDC6 ED5BFEF1        20      LD  DE,(_CLPS)
0010AC DDCA D5              11      PUSH    DE
0010AD DDCB CD93DE          17      CALL    DCPAT
0010B0 DDCE CD9EE4          17      CALL    DRDNX
0010B3 DDD1 2A7EF1          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
0010B6 DDD4 ED4B89E3        20      LD  BC,(SECSZ)  ;1セクタのサイズ
0010BA DDD8 AF               4      XOR A
       DDD9                     COPENCL:
0010BB DDD9 77               7      LD  (HL),A
0010BC DDDA EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0010BE DDDC EAD9DD          10      JP  PE,COPENCL
                                
0010C1 DDDF 3AB1DE          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
0010C4 DDE2 3D               4      DEC A
0010C5 DDE3 2819            12      JR  Z,COPENE
0010C7 DDE5 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
0010C9 DDE7 3215E6          13      LD  (_SECPS),A
0010CC DDEA D1              10      POP DE      ;DE=(_CLPS)
0010CD DDEB D5              11      PUSH    DE
       DDEC                     COPEN1:
0010CE DDEC D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
0010CF DDED C5              11      PUSH    BC
0010D0 DDEE 2A7EF1          16      LD  HL,(_DTBUF)
0010D3 DDF1 CDADDE          17      CALL    CLUSTX
0010D6 DDF4 CDB2E7          17      CALL    DWT24
0010D9 DDF7 C1              10      POP BC
0010DA DDF8 D1              10      POP DE
0010DB DDF9 CD14E6          17      CALL    NEXTX
0010DE DDFC 20EE            12      JR  NZ,COPEN1
       DDFE                     COPENE:
0010E0 DDFE 2A7EF1          16      LD  HL,(_DTBUF)
0010E3 DE01 D1              10      POP DE
0010E4 DE02 C9              10      RET
                                
       DE03                     READ_DIR:
0010E5 DE03 ED53FEF1        20      LD  (_CLPS),DE
0010E9 DE07 C5              11      PUSH    BC
0010EA DE08 D5              11      PUSH    DE
0010EB DE09 CD93DE          17      CALL    DCPAT
0010EE DE0C CD7EE4          17      CALL    DRDX
0010F1 DE0F D1              10      POP DE
0010F2 DE10 C1              10      POP BC
0010F3 DE11 C9              10      RET
                                
       DE12                     FILESE:
0010F4 DE12 7E               7      LD  A,(HL)
0010F5 DE13 B7               4      OR  A
0010F6 DE14 C8              11      RET Z       ;END:ZF=1 CF=0
0010F7 DE15 FEE5             7      CP  0E5H
0010F9 DE17 280E            12      JR  Z,FILESE1
0010FB DE19 FDE5            15      PUSH    IY
0010FD DE1B D1              10      POP DE
0010FE DE1C 13               6      INC DE
0010FF DE1D E5              11      PUSH    HL
001100 DE1E CD6ADE          17      CALL    CPFILE
001103 DE21 CC8BDE          17      CALL    Z,CPFILE2
001106 DE24 E1              10      POP HL
001107 DE25 37               4      SCF
001108 DE26 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       DE27                     FILESE1:
001109 DE27 CD3EDE          17      CALL    FNEXT
00110C DE2A 20E6            12      JR  NZ,FILESE
       DE2C                     ZF0_CF0_AFF_RET:
00110E DE2C F6FF             7      OR  0FFH        ;ZF=0 CF=0
001110 DE2E C9              10      RET
                                
       DE2F                     NEXTSE:
001111 DE2F 7E               7      LD  A,(HL)
001112 DE30 B7               4      OR  A
001113 DE31 37               4      SCF
001114 DE32 C8              11      RET Z       ;!!!:ZF=1 CF=1
001115 DE33 FEE5             7      CP  0E5H
001117 DE35 37               4      SCF
001118 DE36 C8              11      RET Z       ;!!!:(ZF=1) CF=1
001119 DE37 CD3EDE          17      CALL    FNEXT
00111C DE3A 20F3            12      JR  NZ,NEXTSE
00111E DE3C 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       DE3E                     FNEXT:
001120 DE3E E5              11      PUSH    HL
001121 DE3F 219FF0          10      LD  HL,_FILEN
001124 DE42 34              11      INC (HL)
001125 DE43 E1              10      POP HL
001126 DE44 112000          10      LD  DE,020H
001129 DE47 19              11      ADD HL,DE
00112A DE48 0D               4      DEC C
00112B DE49 C9              10      RET
                                
       DE4A                     CPNAME:
00112C DE4A C5              11      PUSH    BC
00112D DE4B D5              11      PUSH    DE
00112E DE4C E5              11      PUSH    HL
00112F DE4D CD64DE          17      CALL    CPFILE4
001132 DE50 E1              10      POP HL
001133 DE51 23               6      INC HL
001134 DE52 23               6      INC HL
001135 DE53 23               6      INC HL
001136 DE54 23               6      INC HL
001137 DE55 D1              10      POP DE
001138 DE56 C1              10      POP BC
001139 DE57 2005            12      JR  NZ,CPNAME1
00113B DE59 7E               7      LD  A,(HL)
00113C DE5A 23               6      INC HL
00113D DE5B 66               7      LD  H,(HL)
00113E DE5C 6F               4      LD  L,A
00113F DE5D C9              10      RET
       DE5E                     CPNAME1:
001140 DE5E 23               6      INC HL
001141 DE5F 23               6      INC HL
001142 DE60 10E8            13      DJNZ    CPNAME
001144 DE62 37               4      SCF
001145 DE63 C9              10      RET
                                
       DE64                     CPFILE4:
001146 DE64 C5              11      PUSH    BC
001147 DE65 010004          10      LD  BC,00400H
00114A DE68 1804            12      JR  CPSTR1
       DE6A                     CPFILE:
00114C DE6A C5              11      PUSH    BC
00114D DE6B 01000B          10      LD  BC,00B00H
       DE6E                     CPSTR1:
001150 DE6E 1A               7      LD  A,(DE)
001151 DE6F FE3F             7      CP  '?'     ;Wild card
001153 DE71 2812            12      JR  Z,CPSTR2
001155 DE73 7E               7      LD  A,(HL)
001156 DE74 CDDADF          17      CALL    FKANC
001159 DE77 E5              11      PUSH    HL
00115A DE78 67               4      LD  H,A
00115B DE79 1A               7      LD  A,(DE)
00115C DE7A CB01             8      RLC C
00115E DE7C CDDADF          17      CALL    FKANC
001161 DE7F CB09             8      RRC C
001163 DE81 BC               4      CP  H       ;CP (HL),(DE)
001164 DE82 E1              10      POP HL
001165 DE83 2004            12      JR  NZ,CPSTR3
       DE85                     CPSTR2:
001167 DE85 13               6      INC DE
001168 DE86 23               6      INC HL
001169 DE87 10E5            13      DJNZ    CPSTR1
       DE89                     CPSTR3:
00116B DE89 C1              10      POP BC
00116C DE8A C9              10      RET
                                
       DE8B                     CPFILE2:
00116D DE8B FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001170 DE8E F6E1             7      OR  0E1H
001172 DE90 2F               4      CPL
001173 DE91 A6               7      AND (HL)
001174 DE92 C9              10      RET
                                
       DE93                     DCPAT:
001175 DE93 0E00             7      LD  C,0
001177 DE95 2A7EF1          16      LD  HL,(_DTBUF)
00117A DE98 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
00117D DE9B B7               4      OR  A
00117E DE9C C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
00117F DE9D 3AB1DE          13      LD  A,(SPCPAT)
001182 DEA0 4F               4      LD  C,A
001183 DEA1 3A15E6          13      LD  A,(_SECPS)
001186 DEA4 B9               4      CP  C
001187 DEA5 3801            12      JR  C,DC1
001189 DEA7 AF               4      XOR A
       DEA8                     DC1:
00118A DEA8 F680             7      OR  080H
00118C DEAA 32A0F0          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       DEAD                     CLUSTX:
00118F DEAD E5              11      PUSH    HL
001190 DEAE EB               4      EX  DE,HL
001191 DEAF AF               4      XOR A
001192 DEB0 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       DEB1                     SPCPAT  EQU $-1
       DEB2                     L_CLDBL:
001194 DEB2 CB19             8      RR  C       ;->CF
001196 DEB4 3804            12      JR  C,E_CLDBL
001198 DEB6 29              11      ADD HL,HL       ;*2
001199 DEB7 8F               4      ADC A,A
00119A DEB8 18F8            12      JR  L_CLDBL
       DEBA                     E_CLDBL:
00119C DEBA 4F               4      LD  C,A
00119D DEBB 3A15E6          13      LD  A,(_SECPS)
0011A0 DEBE B5               4      OR  L
0011A1 DEBF 6F               4      LD  L,A
0011A2 DEC0 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       DEC1                     CLSPAT  EQU $-2
0011A5 DEC3 AF               4      XOR A
0011A6 DEC4 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
0011A7 DEC5 89               4      ADC A,C
0011A8 DEC6 4F               4      LD  C,A
0011A9 DEC7 EB               4      EX  DE,HL
0011AA DEC8 E1              10      POP HL
0011AB DEC9 C9              10      RET
                                ;(8)
       DECA                     ENDCL:
0011AC DECA 7A               4      LD  A,D ;END CLUSTER
0011AD DECB FE01             7      CP  1   ;164=356    (self-modifying code)
       DECC                     CLPAT1  EQU $-1
0011AF DECD C0              11      RET NZ
0011B0 DECE 7B               4      LD  A,E
0011B1 DECF FE64             7      CP  064H    ;       (self-modifying code)
       DED0                     CLPAT2  EQU $-1
0011B3 DED1 C9              10      RET
                                ;(3)
       DED2                     CAP4:
0011B4 DED2 3EE5             7      LD  A,0E5H
0011B6 DED4 C9              10      RET
                                                    ;for X1/88 ワークエリア
0011B7 DED5 5BF0                    DW  _DISKE+1        ;DISKVE($F323)
0011B9 DED7 F5F0                    DW  _BREAK+1        ;BREAKV($F325)
                                
       DED9                     CAP:            ;(9)
0011BB DED9 FE61             7      CP  'a'
0011BD DEDB D8              11      RET C
0011BE DEDC FE7B             7      CP  'z'+1
0011C0 DEDE D0              11      RET NC
0011C1 DEDF D620             7      SUB 020H
0011C3 DEE1 C9              10      RET
                                ;(10)
       DEE2                     CAP2:
0011C4 DEE2 CDD9DE          17      CALL    CAP
       DEE5                     CAP3:               ;
0011C7 DEE5 FE05             7      CP  5
0011C9 DEE7 28E9            12      JR  Z,CAP4
0011CB DEE9 FE21             7      CP  021H
0011CD DEEB C9              10      RET
                                                    ;
       DEEC                     CHDIR:
0011CE DEEC CDC3E8          17      CALL    GETDPBD
0011D1 DEEF 381D            12      JR  C,CHDIR2
0011D3 DEF1 DD751A          19      LD  (IX+DPB_SDIR),L
0011D6 DEF4 DD741B          19      LD  (IX+DPB_SDIR+1),H
0011D9 DEF7 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       DEF9                     LDDIR:
0011DB DEF9 CDC3E8          17      CALL    GETDPBD
0011DE DEFC DD5E1A          19      LD  E,(IX+DPB_SDIR)
0011E1 DEFF DD561B          19      LD  D,(IX+DPB_SDIR+1)
0011E4 DF02 13               6      INC DE
0011E5 DF03 FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0011E8 DF06 FD720F          19      LD  (IY+15),D
0011EB DF09 1B               6      DEC DE
0011EC DF0A AF               4      XOR A
0011ED DF0B 32A0F0          13      LD  (_DIRF),A
       DF0E                     CHDIR2:
0011F0 DF0E DDE1            14      POP IX
0011F2 DF10 C9              10      RET
                                
       DF11                     LDDIRX:
0011F3 DF11 3AA0F0          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
0011F6 DF14 E67F             7      AND 07FH
       DF16                     LDDIRX1:
0011F8 DF16 3215E6          13      LD  (_SECPS),A
0011FB DF19 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0011FE DF1C FD560F          19      LD  D,(IY+15)
001201 DF1F 1B               6      DEC DE
001202 DF20 CDCADE          17      CALL    ENDCL
001205 DF23 D4F9DE          17      CALL    NC,LDDIR
       DF26                     LDDIRS:
001208 DF26 7A               4      LD  A,D
001209 DF27 B3               4      OR  E
00120A DF28 32A0F0          13      LD  (_DIRF),A   ;ディレクトリか判別
00120D DF2B C9              10      RET
                                
       DF2C                     KILL:
00120E DF2C CDF4DF          17      CALL    CHKWILDX
001211 DF2F 3834            12      JR  C,KILLW
001213 DF31 CDCFDC          17      CALL    SOPENX
       DF34                     KILLS:
001216 DF34 3E1F             7      LD  A,01FH
001218 DF36 D478DF          17      CALL    NC,CHKATT
00121B DF39 D8              11      RET C
       DF3A                     KILLSX:
00121C DF3A 36E5            10      LD  (HL),0E5H   ;DIR
00121E DF3C CDD0DF          17      CALL    WTDB
001221 DF3F 111A00          10      LD  DE,01AH
001224 DF42 19              11      ADD HL,DE
001225 DF43 5E               7      LD  E,(HL)
001226 DF44 23               6      INC HL
001227 DF45 56               7      LD  D,(HL)
       DF46                     KILLS1:
001228 DF46 CDCADE          17      CALL    ENDCL
00122B DF49 D0              11      RET NC      ;CF=0
00122C DF4A 21FEFF          10      LD  HL,0-2
00122F DF4D 19              11      ADD HL,DE
001230 DF4E D0              11      RET NC      ;DE= 0 or 1
001231 DF4F D5              11      PUSH    DE
001232 DF50 CDF7F0          17      CALL    _GNCL
001235 DF53 ED53FEF1        20      LD  (_CLPS),DE
001239 DF57 D1              10      POP DE
00123A DF58 210000          10      LD  HL,0
00123D DF5B D4FAF0          17      CALL    NC,_SNCL
001240 DF5E D8              11      RET C
001241 DF5F ED5BFEF1        20      LD  DE,(_CLPS)  ;FAT
001245 DF63 18E1            12      JR  KILLS1
                                
       DF65                     KILLW:
001247 DF65 CDFEDC          17      CALL    SOPEN
       DF68                     KILLW1:
00124A DF68 380B            12      JR  C,KILLW2
00124C DF6A CD9DDD          17      CALL    SOPENE2
00124F DF6D CD34DF          17      CALL    KILLS
001252 DF70 CD62DD          17      CALL    NOPEN
001255 DF73 18F3            12      JR  KILLW1
       DF75                     KILLW2:
001257 DF75 C8              11      RET Z
001258 DF76 3F               4      CCF
001259 DF77 C9              10      RET
                                
       DF78                     CHKATT:
00125A DF78 E5              11      PUSH    HL
00125B DF79 110B00          10      LD  DE,00BH
00125E DF7C 19              11      ADD HL,DE
00125F DF7D A6               7      AND (HL)
001260 DF7E E1              10      POP HL
001261 DF7F C8              11      RET Z
001262 DF80 37               4      SCF
001263 DF81 C9              10      RET
                                
       DF82                     NAME:
001264 DF82 CDF4DF          17      CALL    CHKWILDX
001267 DF85 D8              11      RET C
001268 DF86 110400          10      LD  DE,4
00126B DF89 19              11      ADD HL,DE
00126C DF8A 229FDF          16      LD  (NAMEP),HL
00126F DF8D 23               6      INC HL
001270 DF8E CDF8DF          17      CALL    CHKWILD
001273 DF91 D8              11      RET C
                                
001274 DF92 CDCFDC          17      CALL    SOPENX
001277 DF95 3E0F             7      LD  A,00FH
001279 DF97 D478DF          17      CALL    NC,CHKATT
00127C DF9A D8              11      RET C
                                
00127D DF9B FDE5            15      PUSH    IY
00127F DF9D FD210000        14      LD  IY,0        ;自己書き換え
       DF9F                     NAMEP   EQU $-2
001283 DFA1 CDCFDC          17      CALL    SOPENX
001286 DFA4 FDE3            23      EX  (SP),IY
001288 DFA6 3F               4      CCF
001289 DFA7 D4FEDC          17      CALL    NC,SOPEN
00128C DFAA EB               4      EX  DE,HL
00128D DFAB E1              10      POP HL
00128E DFAC D8              11      RET C
                                
       DFAD                     SETNAME:
00128F DFAD 01000B          10      LD  BC,11*256
001292 DFB0 23               6      INC HL
001293 DFB1 7E               7      LD  A,(HL)
001294 DFB2 FEE5             7      CP  0E5H
001296 DFB4 2004            12      JR  NZ,SNAME1
001298 DFB6 3E05             7      LD  A,5
00129A DFB8 180E            12      JR  SNAME3
       DFBA                     SNAME1:
00129C DFBA 7E               7      LD  A,(HL)
00129D DFBB 0C               4      INC C
00129E DFBC 0D               4      DEC C
00129F DFBD 2009            12      JR  NZ,SNAME3
0012A1 DFBF CDD9DE          17      CALL    CAP
0012A4 DFC2 FEA0             7      CP  0A0H
0012A6 DFC4 2002            12      JR  NZ,SNAME3
0012A8 DFC6 3E20             7      LD  A,020H
       DFC8                     SNAME3:
0012AA DFC8 12               7      LD  (DE),A
0012AB DFC9 7E               7      LD  A,(HL)
0012AC DFCA 23               6      INC HL
0012AD DFCB CDE1DF          17      CALL    FKAN
0012B0 DFCE 10EA            13      DJNZ    SNAME1
       DFD0                     WTDB:               ;バッファデータが更新された
0012B2 DFD0 3EFF             7      LD  A,0FFH
0012B4 DFD2 3239F0          13      LD  (SFILE),A
0012B7 DFD5 32A4F0          13      LD  (_WTDBF),A
0012BA DFD8 AF               4      XOR A
0012BB DFD9 C9              10      RET
                                
       DFDA                     FKANC:
0012BC DFDA CB41             8      BIT 0,C
0012BE DFDC CCE2DE          17      CALL    Z,CAP2
0012C1 DFDF 1801            12      JR  FKANX
       DFE1                     FKAN:           ;漢字チェック
0012C3 DFE1 13               6      INC DE
       DFE2                     FKANX:
0012C4 DFE2 CB41             8      BIT 0,C
0012C6 DFE4 CB81             8      RES 0,C
0012C8 DFE6 C0              11      RET NZ
0012C9 DFE7 FE80             7      CP  080H
0012CB DFE9 D8              11      RET C
0012CC DFEA FEA0             7      CP  0A0H
0012CE DFEC 3803            12      JR  C,FKAN1
0012D0 DFEE FEE0             7      CP  0E0H
0012D2 DFF0 D8              11      RET C
       DFF1                     FKAN1:
0012D3 DFF1 0C               4      INC C
0012D4 DFF2 A7               4      AND A
0012D5 DFF3 C9              10      RET
                                
       DFF4                     CHKWILDX:
0012D6 DFF4 FDE5            15      PUSH    IY
0012D8 DFF6 E1              10      POP HL
0012D9 DFF7 23               6      INC HL
       DFF8                     CHKWILD:
0012DA DFF8 060B             7      LD  B,11
0012DC DFFA 3E3F             7      LD  A,'?'
       DFFC                     CHKWIL1:
0012DE DFFC BE               7      CP  (HL)
0012DF DFFD 23               6      INC HL
0012E0 DFFE 37               4      SCF
0012E1 DFFF C8              11      RET Z
0012E2 E000 10FA            13      DJNZ    CHKWIL1
0012E4 E002 AF               4      XOR A
0012E5 E003 C9              10      RET
                                
       E004                     SDIRENT:        ;IY=FCB HL=DIR
0012E6 E004 D5              11      PUSH    DE
0012E7 E005 E5              11      PUSH    HL
0012E8 E006 FDE5            15      PUSH    IY
0012EA E008 D1              10      POP DE
0012EB E009 EB               4      EX  DE,HL
0012EC E00A CDADDF          17      CALL    SETNAME
                                ;               Attribute
0012EF E00D FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0012F2 E010 12               7      LD  (DE),A
0012F3 E011 13               6      INC DE
                                ;               Reserved
0012F4 E012 AF               4      XOR A
0012F5 E013 060A             7      LD  B,10
       E015                     SDE1:
0012F7 E015 12               7      LD  (DE),A
0012F8 E016 13               6      INC DE
0012F9 E017 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
0012FB E019 21E4F1          10      LD  HL,SDDATA       ;(FCB)更新年月日
0012FE E01C 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       E01E                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
001300 E01E 7E               7      LD  A,(HL)
001301 E01F 23               6      INC HL
001302 E020 3225E0          13      LD  (SDPAT),A
001305 E023 FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       E025                     SDPAT   EQU $-1
001308 E026 12               7      LD  (DE),A
001309 E027 13               6      INC DE
00130A E028 10F4            13      DJNZ    SDLOOP
                                
00130C E02A AF               4      XOR A
00130D E02B E1              10      POP HL
00130E E02C D1              10      POP DE
00130F E02D C9              10      RET
                                
       E02E                     WOPEN:
001310 E02E FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001313 E031 E61F             7      AND 01FH
001315 E033 37               4      SCF
001316 E034 C0              11      RET NZ
001317 E035 FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       E039                     TOPEN2:
00131B E039 AF               4      XOR A
       E03A                     TOPEN:              ;Initializes the time stamp
00131C E03A FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
001320 E03E C9              10      RET
                                
       E03F                     WRDFX:
001321 E03F 3AB1DE          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       E042                     L_WRFX:
001324 E042 1F               4      RRA         ;->CF
001325 E043 3806            12      JR  C,E_WRFX
001327 E045 CB39             8      SRL C
001329 E047 CB1C             8      RR  H       ;CH=CH/2
00132B E049 18F7            12      JR  L_WRFX
       E04B                     E_WRFX:
00132D E04B 41               4      LD  B,C
00132E E04C 4C               4      LD  C,H
00132F E04D 03               6      INC BC
001330 E04E 3E37             7      LD  A,037H      ;SCF
001332 E050 329BE4          13      LD  (DRDN1),A
                                
       E053                     WRDF:               ;BCクラスタ分FATを確保する
001335 E053 110200          10      LD  DE,2
001338 E056 AF               4      XOR A
001339 E057 3215E6          13      LD  (_SECPS),A
       E05A                     WRDF1:
00133C E05A C5              11      PUSH    BC
00133D E05B D5              11      PUSH    DE
00133E E05C CDF7F0          17      CALL    _GNCL
001341 E05F 381C            12      JR  C,WRDF3
001343 E061 7A               4      LD  A,D     ;空いているかチェック
001344 E062 B3               4      OR  E
001345 E063 202A            12      JR  NZ,WRDF4
001347 E065 E1              10      POP HL      ;HL=空いているクラスタ
001348 E066 E5              11      PUSH    HL
001349 E067 ED5BFEF1        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
00134D E06B 22FEF1          16      LD  (_CLPS),HL
001350 E06E 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
001351 E06F B3               4      OR  E
001352 E070 2008            12      JR  NZ,WRDF2
001354 E072 FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
001357 E075 FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
00135A E078 1803            12      JR  WRDF3
       E07A                     WRDF2:
00135C E07A CDFAF0          17      CALL    _SNCL
       E07D                     WRDF3:
00135F E07D D1              10      POP DE
001360 E07E C1              10      POP BC
001361 E07F D8              11      RET C
001362 E080 0B               6      DEC BC
001363 E081 78               4      LD  A,B
001364 E082 B1               4      OR  C
001365 E083 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
001367 E085 ED5BFEF1        20      LD  DE,(_CLPS)
00136B E089 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
00136E E08C C3FAF0          10      JP  _SNCL
                                
       E08F                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
001371 E08F D1              10      POP DE
001372 E090 C1              10      POP BC
       E091                     WRDF5:
001373 E091 13               6      INC DE
001374 E092 CDCADE          17      CALL    ENDCL
001377 E095 38C3            12      JR  C,WRDF1
001379 E097 37               4      SCF
00137A E098 C9              10      RET
                                
       E099                     RWXR:
00137B E099 3A8AE3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E09C                     L_RWX:
00137E E09C 1F               4      RRA     ;->CF
00137F E09D 3808            12      JR  C,E_RWX
001381 E09F CB38             8      SRL B   ;BCH=BCH/2
001383 E0A1 CB19             8      RR  C   ;
001385 E0A3 CB1C             8      RR  H   ;
001387 E0A5 18F5            12      JR  L_RWX
       E0A7                     E_RWX:
001389 E0A7 FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
00138C E0AA FD561B          19      LD  D,(IY+27)
00138F E0AD AF               4      XOR A
001390 E0AE 3215E6          13      LD  (_SECPS),A
       E0B1                     RWX1:
001393 E0B1 ED53FEF1        20      LD  (_CLPS),DE
001397 E0B5 7A               4      LD  A,D
001398 E0B6 B3               4      OR  E
001399 E0B7 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
00139B E0B9 78               4      LD  A,B
00139C E0BA B1               4      OR  C
00139D E0BB B4               4      OR  H
00139E E0BC C8              11      RET Z       ;RET BCH==0 => CF=0
                                
00139F E0BD CD1DE6          17      CALL    GNCLX
0013A2 E0C0 D8              11      RET C
0013A3 E0C1 7C               4      LD  A,H     ;
0013A4 E0C2 25               4      DEC H       ;
0013A5 E0C3 B7               4      OR  A       ;DEC BCH
0013A6 E0C4 2001            12      JR  NZ,RWX2     ;
0013A8 E0C6 0B               6      DEC BC      ;
       E0C7                     RWX2:
0013A9 E0C7 CDCADE          17      CALL    ENDCL
0013AC E0CA 38E5            12      JR  C,RWX1
       E0CC                     SCF_RET:
0013AE E0CC 37               4      SCF
0013AF E0CD C9              10      RET
                                
       E0CE                     DSKF:
0013B0 E0CE 110000          10      LD  DE,0
       E0CF                     MAXCLP  EQU $-2
0013B3 E0D1 2AACF0          16      LD  HL,(_FAKEFREE)
0013B6 E0D4 7C               4      LD  A,H
0013B7 E0D5 B5               4      OR  L
0013B8 E0D6 2803            12      JR  Z,DSKF1
0013BA E0D8 110100          10      LD  DE,1
       E0DB                     DSKF1:
0013BD E0DB D5              11      PUSH    DE
0013BE E0DC CDF7F0          17      CALL    _GNCL
0013C1 E0DF 380C            12      JR  C,POPSCF
0013C3 E0E1 7A               4      LD  A,D
0013C4 E0E2 B3               4      OR  E
0013C5 E0E3 2001            12      JR  NZ,DSKF2
0013C7 E0E5 23               6      INC HL
       E0E6                     DSKF2:
0013C8 E0E6 D1              10      POP DE
0013C9 E0E7 1B               6      DEC DE
0013CA E0E8 7A               4      LD  A,D
0013CB E0E9 B3               4      OR  E
0013CC E0EA 20EF            12      JR  NZ,DSKF1
0013CE E0EC C9              10      RET
                                
       E0ED                     POPSCF:
0013CF E0ED F1              10      POP AF
0013D0 E0EE 37               4      SCF
0013D1 E0EF C9              10      RET
                                
       E0F0                     SETTMS:
0013D2 E0F0 FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
0013D5 E0F3 3C               4      INC A
0013D6 E0F4 C0              11      RET NZ      ;ファイルが更新されていない
       E0F5                     SETTMSX:            ;FCBに日付時刻をセットする
0013D7 E0F5 CD1BD8          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
0013DA E0F8 CB25             8      SLA L       ;   *2
0013DC E0FA CB25             8      SLA L       ;   *4
0013DE E0FC 29              11      ADD HL,HL       ;*2 *8
0013DF E0FD 29              11      ADD HL,HL       ;*4 *16
0013E0 E0FE 29              11      ADD HL,HL       ;*8 *32
0013E1 E0FF 7A               4      LD  A,D
0013E2 E100 0F               4      RRCA            ;bit.0->7->->->0->C
0013E3 E101 E61F             7      AND 01FH
0013E5 E103 B5               4      OR  L
0013E6 E104 FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
0013E9 E107 FD7417          19      LD  (IY+23),H
                                
0013EC E10A CD1BD8          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
0013EF E10D 0144F8          10      LD  BC,0-1980
0013F2 E110 09              11      ADD HL,BC
0013F3 E111 65               4      LD  H,L
                                
0013F4 E112 7A               4      LD  A,D
0013F5 E113 87               4      ADD A,A     ;*2
0013F6 E114 87               4      ADD A,A     ;*4
0013F7 E115 87               4      ADD A,A     ;*8
0013F8 E116 87               4      ADD A,A     ;*16
0013F9 E117 6F               4      LD  L,A
0013FA E118 29              11      ADD HL,HL       ;*32
0013FB E119 7D               4      LD  A,L
0013FC E11A B3               4      OR  E
0013FD E11B FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
001400 E11E FD7415          19      LD  (IY+21),H
001403 E121 C9              10      RET
                                ;(16)
       E122                     PUSHRR:
001404 E122 324EE4          13      LD  (SETSEQ_SWC_RND),A
001407 E125 2260E4          16      LD  (SETSEQ_SWC_SEQ_RR),HL
00140A E128 CD48E1          17      CALL    GET_RR_AHL
00140D E12B 220FF0          16      LD  (RR_BUF_HL),HL
001410 E12E 3211F0          13      LD  (RR_BUF_A),A
001413 E131 C9              10      RET
                                ;(14)
       E132                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
001414 E132 87               4      ADD A,A     ;in BHLA => out AHL
001415 E133 ED6A            15      ADC HL,HL
001417 E135 CB18             8      RR  B
001419 E137 B7               4      OR  A
00141A E138 78               4      LD  A,B     ;ここでフラグは変化しない
00141B E139 C8              11      RET Z
00141C E13A 2C               4      INC L       ;INC AHL
00141D E13B C0              11      RET NZ      ;
00141E E13C 24               4      INC H       ;
00141F E13D C0              11      RET NZ      ;
001420 E13E 3C               4      INC A       ;
001421 E13F C9              10      RET
                                ;(18)
       E140                     INIT_RND:
001422 E140 3ECD             7      LD  A,0CDH      ;CALL ????
001424 E142 215FE1          10      LD  HL,POPRR
001427 E145 CD22E1          17      CALL    PUSHRR
       E148                     GET_RR_AHL:
00142A E148 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
00142D E14B FD6622          19      LD  H,(IY+34)   ;
001430 E14E FD7E23          19      LD  A,(IY+35)   ;
001433 E151 C9              10      RET
                                ;(10)
       E152                     SET_RR_AHL:
001434 E152 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001437 E155 FD7422          19      LD  (IY+34),H   ;
00143A E158 FD7723          19      LD  (IY+35),A   ;
00143D E15B C9              10      RET
                                ;(17)
       E15C                     SETSEQ:
00143E E15C CD81E1          17      CALL    SETSEQ1
       E15F                     POPRR:
001441 E15F F5              11      PUSH    AF
001442 E160 E5              11      PUSH    HL
001443 E161 2A0FF0          16      LD  HL,(RR_BUF_HL)
001446 E164 3A11F0          13      LD  A,(RR_BUF_A)
001449 E167 CD52E1          17      CALL    SET_RR_AHL
00144C E16A E1              10      POP HL
00144D E16B F1              10      POP AF
00144E E16C C9              10      RET
                                ;(20)
       E16D                     GET_RR_BCDE:            ;BCDE=Random record
00144F E16D FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
001452 E170 FD5622          19      LD  D,(IY+34)
001455 E173 FD4E23          19      LD  C,(IY+35)
001458 E176 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
00145A E178 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00145E E17C C0              11      RET NZ
00145F E17D FD4624          19      LD  B,(IY+36)
001462 E180 C9              10      RET
                                
       E181                     SETSEQ1:
001463 E181 F5              11      PUSH    AF
001464 E182 E5              11      PUSH    HL      ;AHL=Random record
001465 E183 CD48E1          17      CALL    GET_RR_AHL
001468 E186 47               4      LD  B,A     ;AHL→HLA
001469 E187 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
00146A E188 6C               4      LD  L,H     ;(IY+34)
00146B E189 60               4      LD  H,B     ;(IY+35)
00146C E18A 0600             7      LD  B,0
                                
00146E E18C CD32E1          17      CALL    GET_CPM_R_SIZE
                                
001471 E18F 29              11      ADD HL,HL
001472 E190 CB3D             8      SRL L       ;L=L/2
001474 E192 FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
001477 E195 FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
00147A E198 E1              10      POP HL
00147B E199 F1              10      POP AF
00147C E19A C9              10      RET
                                
                                ;(23)
       E19B                     RBXEND:             ;レコード数だけランダムレコードを進める
00147D E19B 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       E19C                     RBSIZE  EQU $-2
001480 E19E CD48E1          17      CALL    GET_RR_AHL
001483 E1A1 19              11      ADD HL,DE
001484 E1A2 CE00             7      ADC A,0
001486 E1A4 CD52E1          17      CALL    SET_RR_AHL
001489 E1A7 EB               4      EX  DE,HL       ;HL=進めるレコード数
00148A E1A8 D0              11      RET NC
00148B E1A9 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00148F E1AD C0              11      RET NZ
001490 E1AE FD3424          23      INC (IY+36)
001493 E1B1 C9              10      RET
       E1B2                     FILE_E:
                                
       DD5C                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       DD5C                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       DD5C                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       DD5C                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       DD5C                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E1B2                     _SYS26:     ;(BDOS)ランダムブロック書き込み
001494 E1B2 AF               4      XOR A
001495 E1B3 329BE4          13      LD  (DRDN1),A   ;NOP
001498 E1B6 229CE1          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
00149B E1B9 225DF0          16      LD  (LEFTX),HL
00149E E1BC CDA5DC          17      CALL    SETDRV
                                
0014A1 E1BF CD25E3          17      CALL    RBX0
0014A4 E1C2 DA4FE2          10      JP  C,RBWERR
0014A7 E1C5 CD2EE0          17      CALL    WOPEN
0014AA E1C8 DA4FE2          10      JP  C,RBWERR
0014AD E1CB 7C               4      LD  A,H
0014AE E1CC B5               4      OR  L
0014AF E1CD CA48E2          10      JP  Z,RBW1
                                
0014B2 E1D0 2B               6      DEC HL
                                
0014B3 E1D1 CD6DE1          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0014B6 E1D4 19              11      ADD HL,DE       ;BCHL=HL+BCDE
0014B7 E1D5 3001            12      JR  NC,S26X1    ;
0014B9 E1D7 03               6      INC BC      ;
       E1D8                     S26X1:
0014BA E1D8 CD99E0          17      CALL    RWXR
0014BD E1DB DC3FE0          17      CALL    C,WRDFX
0014C0 E1DE DA4FE2          10      JP  C,RBWERR
                                
0014C3 E1E1 CD54E3          17      CALL    RBX2
0014C6 E1E4 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
0014C8 E1E6 CD73E3          17      CALL    RBXA
0014CB E1E9 3864            12      JR  C,RBWERR
0014CD E1EB EB               4      EX  DE,HL
0014CE E1EC C5              11      PUSH    BC
0014CF E1ED EDB0                    LDIR
0014D1 E1EF 225FF0          16      LD  (DTAX),HL
                                
0014D4 E1F2 CDD0DF          17      CALL    WTDB        ;バッファデータは更新された
                                
0014D7 E1F5 2A5DF0          16      LD  HL,(LEFTX)
0014DA E1F8 D1              10      POP DE
0014DB E1F9 ED52            15      SBC HL,DE
0014DD E1FB 225DF0          16      LD  (LEFTX),HL
0014E0 E1FE 2831            12      JR  Z,RBWEND
                                
       E200                     RBWB:
0014E2 E200 CDA8E3          17      CALL    RBXB
0014E5 E203 2814            12      JR  Z,RBWC
       E205                     RBWB1:
0014E7 E205 C5              11      PUSH    BC
0014E8 E206 D5              11      PUSH    DE
0014E9 E207 CDADDE          17      CALL    CLUSTX
0014EC E20A CDCCE3          17      CALL    DWTC
0014EF E20D D1              10      POP DE
0014F0 E20E C1              10      POP BC
0014F1 E20F D41DE6          17      CALL    NC,GNCLX
0014F4 E212 383B            12      JR  C,RBWERR
0014F6 E214 10EF            13      DJNZ    RBWB1
0014F8 E216 CD1CE4          17      CALL    DRW_FLUSH
       E219                     RBWC:
0014FB E219 CDC0E3          17      CALL    RBXC
0014FE E21C 2813            12      JR  Z,RBWEND
001500 E21E C5              11      PUSH    BC
001501 E21F CDADDE          17      CALL    CLUSTX
001504 E222 CD9AE4          17      CALL    DRDN
001507 E225 C1              10      POP BC
001508 E226 3827            12      JR  C,RBWERR
00150A E228 ED5B7EF1        20      LD  DE,(_DTBUF)
00150E E22C EDB0                    LDIR
001510 E22E CDD0DF          17      CALL    WTDB        ;バッファデータは更新された
       E231                     RBWEND:
001513 E231 CD9BE1          17      CALL    RBXEND
                                
001516 E234 CD34E3          17      CALL    RBX1
001519 E237 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
00151B E239 CD6DE1          17      CALL    GET_RR_BCDE ;BCDE=Random record
00151E E23C FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
001521 E23F FD7211          19      LD  (IY+17),D   ;
001524 E242 FD7112          19      LD  (IY+18),C   ;
001527 E245 FD7013          19      LD  (IY+19),B   ;
       E248                     RBW1:
00152A E248 FDE1            14      POP IY
00152C E24A C1              10      POP BC
00152D E24B D1              10      POP DE
00152E E24C E1              10      POP HL
       E24D                     DD_NUL:
00152F E24D AF               4      XOR A
       E24E                     DRDF0:
       E24E                     DWTF0:
001530 E24E C9              10      RET
                                
       E24F                     RBWERR:
001531 E24F FDE5            15      PUSH    IY
001533 E251 D1              10      POP DE
001534 E252 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
001536 E254 CD48D4          17      CALL    BDOS0
       E257                     RBRERR1:
001539 E257 3E01             7      LD  A,001H
       E259                     RBRERR2:
00153B E259 FDE1            14      POP IY
00153D E25B C1              10      POP BC
00153E E25C D1              10      POP DE
00153F E25D E1              10      POP HL
001540 E25E 37               4      SCF
001541 E25F 210000          10      LD  HL,0
001544 E262 C9              10      RET
                                
       E263                     RBRERR:
001545 E263 3EFF             7      LD  A,0FFH
001547 E265 18F2            12      JR  RBRERR2
                                
       E267                     RBRFL:
001549 E267 3E00             7  RBRFLP: LD  A,000H
00154B E269 FE0D             7      CP  00DH
00154D E26B 2005            12      JR  NZ,RBRFL1
00154F E26D D5              11      PUSH    DE
001550 E26E 1E0A             7      LD  E,00AH
001552 E270 1805            12      JR  RBRFL2
       E272                     RBRFL1:
001554 E272 D5              11      PUSH    DE
001555 E273 CD09F0          17      CALL    _SYS07
001558 E276 5F               4      LD  E,A
       E277                     RBRFL2:
001559 E277 CDCDF0          17      CALL    _PRINT
00155C E27A 7B               4      LD  A,E
00155D E27B D1              10      POP DE
00155E E27C 3268E2          13      LD  (RBRFLP+1),A
001561 E27F C9              10      RET
                                
                                                ;Read random block
       E280                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001562 E280 225DF0          16      LD  (LEFTX),HL
001565 E283 CDA5DC          17      CALL    SETDRV
                                
001568 E286 FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
00156C E28A C213E3          10      JP  NZ,RBRDIR   ;ディレクトリ
00156F E28D CD25E3          17      CALL    RBX0
001572 E290 DA63E2          10      JP  C,RBRERR
001575 E293 CD34E3          17      CALL    RBX1
001578 E296 D44CE3          17      CALL    NC,RBX1R
00157B E299 DA57E2          10      JP  C,RBRERR1
00157E E29C EB               4      EX  DE,HL
00157F E29D ED52            15      SBC HL,DE       ;CP 00HL,BCDE
001581 E29F 19              11      ADD HL,DE
001582 E2A0 79               4      LD  A,C
001583 E2A1 DE00             7      SBC A,0
001585 E2A3 78               4      LD  A,B
001586 E2A4 DE00             7      SBC A,0
001588 E2A6 3801            12      JR  C,RBR1
00158A E2A8 EB               4      EX  DE,HL
       E2A9                     RBR1:
00158B E2A9 9F               4      SBC A,A
00158C E2AA E601             7      AND 1
00158E E2AC 3211E3          13      LD  (RBRA_SWC),A
                                
001591 E2AF 7C               4      LD  A,H
001592 E2B0 B5               4      OR  L
001593 E2B1 2857            12      JR  Z,RBREND0
                                
001595 E2B3 229CE1          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
001598 E2B6 225DF0          16      LD  (LEFTX),HL
                                
00159B E2B9 CD54E3          17      CALL    RBX2
00159E E2BC 2819            12      JR  Z,RBRB
0015A0 E2BE CD73E3          17      CALL    RBXA
0015A3 E2C1 DA63E2          10      JP  C,RBRERR
0015A6 E2C4 C5              11      PUSH    BC
0015A7 E2C5 EDB0                    LDIR
0015A9 E2C7 ED535FF0        20      LD  (DTAX),DE
0015AD E2CB 2A5DF0          16      LD  HL,(LEFTX)
0015B0 E2CE D1              10      POP DE
0015B1 E2CF A7               4      AND A
0015B2 E2D0 ED52            15      SBC HL,DE
0015B4 E2D2 225DF0          16      LD  (LEFTX),HL
0015B7 E2D5 2830            12      JR  Z,RBREND
                                
       E2D7                     RBRB:
0015B9 E2D7 CDA8E3          17      CALL    RBXB
0015BC E2DA 2815            12      JR  Z,RBRC
       E2DC                     RBRB1:
0015BE E2DC C5              11      PUSH    BC
0015BF E2DD D5              11      PUSH    DE
0015C0 E2DE CDADDE          17      CALL    CLUSTX
0015C3 E2E1 CDD2E3          17      CALL    DRDC
0015C6 E2E4 D1              10      POP DE
0015C7 E2E5 C1              10      POP BC
0015C8 E2E6 D41DE6          17      CALL    NC,GNCLX
0015CB E2E9 DA63E2          10      JP  C,RBRERR
0015CE E2EC 10EE            13      DJNZ    RBRB1
0015D0 E2EE CD1CE4          17      CALL    DRW_FLUSH
       E2F1                     RBRC:
0015D3 E2F1 CDC0E3          17      CALL    RBXC
0015D6 E2F4 2811            12      JR  Z,RBREND
0015D8 E2F6 C5              11      PUSH    BC
0015D9 E2F7 CDADDE          17      CALL    CLUSTX
0015DC E2FA CD7EE4          17      CALL    DRDX
0015DF E2FD C1              10      POP BC
0015E0 E2FE DA63E2          10      JP  C,RBRERR
0015E3 E301 EB               4      EX  DE,HL
0015E4 E302 2A7EF1          16      LD  HL,(_DTBUF)
0015E7 E305 EDB0                    LDIR
       E307                     RBREND:
0015E9 E307 CD9BE1          17      CALL    RBXEND
       E30A                     RBREND0:
0015EC E30A FDE1            14      POP IY
0015EE E30C C1              10      POP BC
0015EF E30D D1              10      POP DE
0015F0 E30E F1              10      POP AF  ;(HL)
0015F1 E30F AF               4      XOR A
0015F2 E310 3E00             7      LD  A,000H
       E311                     RBRA_SWC    EQU $-1
0015F4 E312 C9              10      RET
                                
       E313                     RBRDIR:
0015F5 E313 FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0015F8 E316 FD661B          19      LD  H,(IY+27)
0015FB E319 CDECDE          17      CALL    CHDIR
0015FE E31C AF               4      XOR A
0015FF E31D 67               4      LD  H,A
001600 E31E 6F               4      LD  L,A
001601 E31F 3C               4      INC A
001602 E320 3211E3          13      LD  (RBRA_SWC),A
001605 E323 18E5            12      JR  RBREND0
                                ;(15)
       E325                     RBX0:
001607 E325 2A8AF0          16      LD  HL,(_DTA)
00160A E328 225FF0          16      LD  (DTAX),HL
00160D E32B 2A5DF0          16      LD  HL,(LEFTX)
001610 E32E FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
001613 E331 D6FD             7      SUB 0FDH
001615 E333 C9              10      RET
                                
       E334                     RBX1:               ;ファイルサイズとランダムレコードを比べる
001616 E334 E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
001617 E335 FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
00161A E338 FD6611          19      LD  H,(IY+17)   ;
00161D E33B FD7E12          19      LD  A,(IY+18)   ;
                                
001620 E33E CD6DE1          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
001623 E341 A7               4      AND A
001624 E342 ED52            15      SBC HL,DE
001626 E344 99               4      SBC A,C
001627 E345 4F               4      LD  C,A
001628 E346 FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
00162B E349 98               4      SBC A,B
00162C E34A D1              10      POP DE
00162D E34B C9              10      RET
       E34C                     RBX1R:              ;(8)
00162E E34C 47               4      LD  B,A
00162F E34D B1               4      OR  C
001630 E34E EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
001631 E34F B2               4      OR  D
001632 E350 B3               4      OR  E
001633 E351 C0              11      RET NZ
001634 E352 37               4      SCF
001635 E353 C9              10      RET
                                
       E354                     RBX2:               ;Cluster settings
001636 E354 FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
001639 E357 FD4E23          19      LD  C,(IY+35)
00163C E35A 0600             7      LD  B,0
00163E E35C FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001642 E360 2003            12      JR  NZ,RBX3
001644 E362 FD4624          19      LD  B,(IY+36)
       E365                     RBX3:
001647 E365 CD99E0          17      CALL    RWXR
00164A E368 3A8AE3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
00164D E36B 3D               4      DEC A
00164E E36C FDA622          19      AND (IY+34)
001651 E36F FDB621          19      OR  (IY+33)
001654 E372 C9              10      RET
                                
       E373                     RBXA:
001655 E373 C5              11      PUSH    BC
001656 E374 D5              11      PUSH    DE
001657 E375 CDADDE          17      CALL    CLUSTX
00165A E378 CD7EE4          17      CALL    DRDX
00165D E37B D1              10      POP DE
00165E E37C C1              10      POP BC
00165F E37D D41DE6          17      CALL    NC,GNCLX
001662 E380 D8              11      RET C
001663 E381 ED53FEF1        20      LD  (_CLPS),DE
                                
001667 E385 FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
00166A E388 210004          10      LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
       E389                     SECSZ   EQU $-2
       E38A                     SECSZ_H EQU $-1
00166D E38B 7C               4      LD  A,H
00166E E38C 3D               4      DEC A       ;1024=3 / 512=1
00166F E38D FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
001672 E390 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
001673 E391 ED42            15      SBC HL,BC       ;残りを計算
                                
001675 E393 ED5B5DF0        20      LD  DE,(LEFTX)
001679 E397 ED52            15      SBC HL,DE       ;CP HL,DE
00167B E399 19              11      ADD HL,DE       ;
00167C E39A 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
00167E E39C EB               4      EX  DE,HL
       E39D                     RBXA1:
00167F E39D E5              11      PUSH    HL
001680 E39E 2A7EF1          16      LD  HL,(_DTBUF)
001683 E3A1 09              11      ADD HL,BC
001684 E3A2 ED5B5FF0        20      LD  DE,(DTAX)
001688 E3A6 C1              10      POP BC
001689 E3A7 C9              10      RET
                                
       E3A8                     RBXB:
00168A E3A8 2A5FF0          16      LD  HL,(DTAX)
00168D E3AB ED5BFEF1        20      LD  DE,(_CLPS)
001691 E3AF 3A5EF0          13      LD  A,(LEFTX+1)
001694 E3B2 47               4      LD  B,A
001695 E3B3 3A8AE3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E3B6                     RBXB1:
001698 E3B6 1F               4      RRA     ;->CF
001699 E3B7 3804            12      JR  C,RBXB2
00169B E3B9 CB38             8      SRL B   ;B=B/2
00169D E3BB 18F9            12      JR  RBXB1
       E3BD                     RBXB2:
00169F E3BD 78               4      LD  A,B
0016A0 E3BE B7               4      OR  A
0016A1 E3BF C9              10      RET
                                ;(12)
       E3C0                     RBXC:
0016A2 E3C0 ED4B5DF0        20      LD  BC,(LEFTX)
0016A6 E3C4 3A8AE3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
0016A9 E3C7 3D               4      DEC A
0016AA E3C8 A0               4      AND B
0016AB E3C9 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
0016AC E3CA B1               4      OR  C
0016AD E3CB C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E3CC                     DWTC:
0016AE E3CC E5              11      PUSH    HL
0016AF E3CD 21B4E7          10      LD  HL,DWT24B
0016B2 E3D0 1804            12      JR  DWTC1
       E3D2                     DRDC:
0016B4 E3D2 E5              11      PUSH    HL
0016B5 E3D3 21A6E7          10      LD  HL,DRD24B
       E3D6                     DWTC1:
0016B8 E3D6 2230E4          16      LD  (DRWF_MODE),HL
0016BB E3D9 E1              10      POP HL
0016BC E3DA 3A20E4          13      LD  A,(DRWF_B)
0016BF E3DD B7               4      OR  A
0016C0 E3DE 200F            12      JR  NZ,DRDC1
       E3E0                     SAVE_DRWC:
0016C2 E3E0 0601             7      LD  B,1
0016C4 E3E2 ED431FE4        20      LD  (DRWF_C),BC
0016C8 E3E6 ED5326E4        20      LD  (DRWF_E),DE
0016CC E3EA 2229E4          16      LD  (DRWF_HL),HL
0016CF E3ED 1820            12      JR  INC_HL_DRWC
       E3EF                     DRDC1:
0016D1 E3EF E5              11      PUSH    HL
0016D2 E3F0 2126E4          10      LD  HL,DRWF_E
0016D5 E3F3 86               7      ADD A,(HL)
0016D6 E3F4 F5              11      PUSH    AF
0016D7 E3F5 BB               4      CP  E
0016D8 E3F6 201D            12      JR  NZ,DRDC2
0016DA E3F8 F1              10      POP AF
0016DB E3F9 23               6      INC HL
0016DC E3FA 7E               7      LD  A,(HL)
0016DD E3FB CE00             7      ADC A,0
0016DF E3FD F5              11      PUSH    AF
0016E0 E3FE BA               4      CP  D
0016E1 E3FF 2014            12      JR  NZ,DRDC2
0016E3 E401 F1              10      POP AF
0016E4 E402 3A1FE4          13      LD  A,(DRWF_C)
0016E7 E405 CE00             7      ADC A,0
0016E9 E407 B9               4      CP  C
0016EA E408 200C            12      JR  NZ,DRDC3
0016EC E40A 2120E4          10      LD  HL,DRWF_B
0016EF E40D 34              11      INC (HL)
0016F0 E40E E1              10      POP HL
       E40F                     INC_HL_DRWC:
0016F1 E40F 3A8AE3          13      LD  A,(SECSZ_H)     ;1セクタのサイズの上位1バイト
0016F4 E412 84               4      ADD A,H
0016F5 E413 67               4      LD  H,A
0016F6 E414 C9              10      RET
       E415                     DRDC2:
0016F7 E415 F1              10      POP AF
       E416                     DRDC3:
0016F8 E416 CD1CE4          17      CALL    DRW_FLUSH
0016FB E419 E1              10      POP HL
0016FC E41A 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E41C                     DRW_FLUSH:
0016FE E41C C5              11      PUSH    BC
0016FF E41D D5              11      PUSH    DE
001700 E41E 010000          10      LD  BC,0
       E41F                     DRWF_C  EQU $-2
       E420                     DRWF_B  EQU $-1
001703 E421 78               4      LD  A,B
001704 E422 B7               4      OR  A
001705 E423 280D            12      JR  Z,DRDF1
001707 E425 110000          10      LD  DE,0
       E426                     DRWF_E  EQU $-2
       E427                     DRWF_D  EQU $-1
00170A E428 210000          10      LD  HL,0
       E429                     DRWF_HL EQU $-2
00170D E42B AF               4      XOR A
00170E E42C 3220E4          13      LD  (DRWF_B),A
001711 E42F CDA6E7          17      CALL    DRD24B
       E430                     DRWF_MODE   EQU $-2
       E432                     DRDF1:
001714 E432 D1              10      POP DE
001715 E433 C1              10      POP BC
001716 E434 C9              10      RET
                                
       E435                     RB_WRITE:
001717 E435 C5              11      PUSH    BC
001718 E436 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
00171A E438 1803            12      JR  RBRW
       E43A                     RB_READ:
00171C E43A C5              11      PUSH    BC
00171D E43B 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
       E43D                     RBRW:
00171F E43D 1F               4      RRA     ;AHL = AHL*128
001720 E43E 7C               4      LD  A,H ;AHL = AHL0/2
001721 E43F 1F               4      RRA     ;A
001722 E440 65               4      LD  H,L ;
001723 E441 CB1C             8      RR  H   ;H
001725 E443 2E00             7      LD  L,0 ;
001727 E445 CB1D             8      RR  L   ;L
001729 E447 CD52E1          17      CALL    SET_RR_AHL
00172C E44A 218000          10      LD  HL,128
00172F E44D C5              11      PUSH    BC
       E44E                     SETSEQ_SWC_RND:
001730 E44E CD81E1          17      CALL    SETSEQ1     ;CALL SETSEQ1 or LD BC,SETSEQ1
001733 E451 C1              10      POP BC
001734 E452 FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
001738 E456 FDE5            15      PUSH    IY
00173A E458 D1              10      POP DE
00173B E459 D5              11      PUSH    DE
00173C E45A CD48D4          17      CALL    BDOS0
00173F E45D FDE1            14      POP IY
001741 E45F CD5CE1          17      CALL    SETSEQ      ;SETSEQ or POPRR
       E460                     SETSEQ_SWC_SEQ_RR   EQU $-2
001744 E462 FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
001748 E466 C1              10      POP BC
001749 E467 C9              10      RET
                                
                                ;(22)
       E468                     INIT_SEQ:
00174A E468 3E01             7      LD  A,1     ;LD BC,????
00174C E46A 215CE1          10      LD  HL,SETSEQ
00174F E46D CD22E1          17      CALL    PUSHRR
       E470                     GETSEQ:
001752 E470 FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
001755 E473 FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
001758 E476 AF               4      XOR A
                                
001759 E477 CB25             8      SLA L   ;L=L*2
                                
00175B E479 CB3C             8      SRL H   ;HL=HL/2
00175D E47B CB1D             8      RR  L   ;
00175F E47D C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E47E                     DRDX:
001760 E47E CDBCE4          17      CALL    DRDY
001763 E481 C8              11      RET Z
001764 E482 CDA2E4          17      CALL    DRDX1       ;データバッファの情報を保存
001767 E485 D8              11      RET C
001768 E486 E5              11      PUSH    HL
001769 E487 C5              11      PUSH    BC
00176A E488 D5              11      PUSH    DE
00176B E489 2A7EF1          16      LD  HL,(_DTBUF)
00176E E48C 3AE5E4          13      LD  A,(_DBS24)
001771 E48F 4F               4      LD  C,A
001772 E490 CDA4E7          17      CALL    DRD24
001775 E493 DCB7E4          17      CALL    C,DRDNE
       E496                     POP_DE_BC_HL_RET:
001778 E496 D1              10      POP DE
001779 E497 C1              10      POP BC
00177A E498 E1              10      POP HL
00177B E499 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E49A                     DRDN:
00177C E49A AF               4      XOR A
00177D E49B 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
00177E E49C 30E0            12      JR  NC,DRDX
       E49E                     DRDNX:
001780 E49E CDBCE4          17      CALL    DRDY
001783 E4A1 C8              11      RET Z
       E4A2                     DRDX1:
001784 E4A2 CDD2E4          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
001787 E4A5 ED53A6F0        20      LD  (_DBSEC),DE
00178B E4A9 79               4      LD  A,C
00178C E4AA 32E5E4          13      LD  (_DBS24),A
                                
00178F E4AD 3A88F0          13      LD  A,(_DRV)
001792 E4B0 32A5F0          13      LD  (_DBDRV),A
001795 E4B3 CDD9F0          17      CALL    _CHGDRV
001798 E4B6 D0              11      RET NC
       E4B7                     DRDNE:
001799 E4B7 9F               4      SBC A,A     ;CF=1ならばA=0FFH
00179A E4B8 32A5F0          13      LD  (_DBDRV),A
00179D E4BB C9              10      RET
                                
                                ;   CDE:セクタ番号
       E4BC                     DRDY:
00179E E4BC 3AE5E4          13      LD  A,(_DBS24)
0017A1 E4BF B9               4      CP  C
0017A2 E4C0 C0              11      RET NZ
                                
0017A3 E4C1 E5              11      PUSH    HL
0017A4 E4C2 3A88F0          13      LD  A,(_DRV)
0017A7 E4C5 21A5F0          10      LD  HL,_DBDRV
0017AA E4C8 AE               7      XOR (HL)
0017AB E4C9 2005            12      JR  NZ,POP_HL_RET
                                
0017AD E4CB 2AA6F0          16      LD  HL,(_DBSEC)
0017B0 E4CE ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E4D0                     POP_HL_RET:
0017B2 E4D0 E1              10      POP HL
0017B3 E4D1 C9              10      RET
                                
       E4D2                     DWTX:
0017B4 E4D2 3AA4F0          13      LD  A,(_WTDBF)
0017B7 E4D5 B7               4      OR  A
0017B8 E4D6 C8              11      RET Z
0017B9 E4D7 AF               4      XOR A
0017BA E4D8 32A4F0          13      LD  (_WTDBF),A
                                
0017BD E4DB E5              11      PUSH    HL
0017BE E4DC C5              11      PUSH    BC
0017BF E4DD D5              11      PUSH    DE
0017C0 E4DE 3AA5F0          13      LD  A,(_DBDRV)
0017C3 E4E1 CDD9F0          17      CALL    _CHGDRV
0017C6 E4E4 0E00             7      LD  C,0
       E4E5                     _DBS24  EQU $-1
0017C8 E4E6 ED5BA6F0        20      LD  DE,(_DBSEC)
0017CC E4EA 2A7EF1          16      LD  HL,(_DTBUF)
0017CF E4ED D4B2E7          17      CALL    NC,DWT24
       E4F0                     POP_DE_BC_HL_RET2:
0017D2 E4F0 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E4F2                     RDFATX:
0017D4 E4F2 E5              11      PUSH    HL
0017D5 E4F3 3A88F0          13      LD  A,(_DRV)
0017D8 E4F6 21AAF0          10      LD  HL,_FATDRV
0017DB E4F9 AE               7      XOR (HL)
0017DC E4FA 28D4            12      JR  Z,POP_HL_RET
                                
0017DE E4FC C5              11      PUSH    BC
0017DF E4FD D5              11      PUSH    DE
0017E0 E4FE DDE5            15      PUSH    IX
0017E2 E500 CD1CE5          17      CALL    WTFATX
0017E5 E503 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
0017E7 E505 AF               4      XOR A
0017E8 E506 32ABF0          13      LD  (_FATIX),A
0017EB E509 3A88F0          13      LD  A,(_DRV)
0017EE E50C 32AAF0          13      LD  (_FATDRV),A
0017F1 E50F CDE5F0          17      CALL    _RDFAT
       E512                     RDFATE2:
0017F4 E512 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
0017F6 E514 9F               4      SBC A,A     ;A=0xFF
0017F7 E515 32AAF0          13      LD  (_FATDRV),A
       E518                     POP_IX_DE_BC_HL_RET:
0017FA E518 DDE1            14      POP IX
0017FC E51A 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E51C                     WTFATX:
0017FE E51C 3AA2F0          13      LD  A,(_WTFATF)
001801 E51F B7               4      OR  A
001802 E520 C8              11      RET Z
001803 E521 AF               4      XOR A
001804 E522 32A2F0          13      LD  (_WTFATF),A
                                
001807 E525 E5              11      PUSH    HL
001808 E526 3AAAF0          13      LD  A,(_FATDRV)
00180B E529 21A5F0          10      LD  HL,_DBDRV
00180E E52C AE               7      XOR (HL)
00180F E52D CCD2E4          17      CALL    Z,DWTX
001812 E530 389E            12      JR  C,POP_HL_RET
001814 E532 C5              11      PUSH    BC
001815 E533 D5              11      PUSH    DE
001816 E534 DDE5            15      PUSH    IX
001818 E536 CDC3E7          17      CALL    FATSETUP
00181B E539 D4B4E7          17      CALL    NC,DWT24B
00181E E53C 18DA            12      JR  POP_IX_DE_BC_HL_RET
                                
       E53E                     N16CL1:
001820 E53E 7A               4      LD  A,D
001821 E53F B3               4      OR  E
001822 E540 37               4      SCF
001823 E541 C8              11      RET Z
                                
001824 E542 7A               4      LD  A,D
001825 E543 1807            12      JR  NCL1X
       E545                     NCL1:
001827 E545 7A               4      LD  A,D
001828 E546 B3               4      OR  E
001829 E547 37               4      SCF
00182A E548 C8              11      RET Z
                                
00182B E549 7A               4      LD  A,D
00182C E54A CB3F             8      SRL A   ;/2
       E54C                     NCL1X:
00182E E54C CB3F             8      SRL A   ;/2
                                
001830 E54E E5              11      PUSH    HL
001831 E54F 326EE5          13      LD  (NCLPAT_FATIX),A    ;_FATIX
001834 E552 2AAAF0          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
001837 E555 BC               4      CP  H
001838 E556 3A88F0          13      LD  A,(_DRV)    ;LDではフラグは変化しない
00183B E559 326DE5          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
00183E E55C 2005            12      JR  NZ,NCL2     ;FATIXが違う
001840 E55E BD               4      CP  L
001841 E55F 2002            12      JR  NZ,NCL2     ;ドライブが違う
001843 E561 E1              10      POP HL
001844 E562 C9              10      RET
       E563                     NCL2:
001845 E563 C5              11      PUSH    BC
001846 E564 D5              11      PUSH    DE
001847 E565 DDE5            15      PUSH    IX
001849 E567 CD1CE5          17      CALL    WTFATX
00184C E56A 38AC            12      JR  C,POP_IX_DE_BC_HL_RET
00184E E56C 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E56E                     NCLPAT_FATIX    EQU $-1
       E56D                     NCLPAT_FATDRV   EQU $-2
001851 E56F ED43AAF0        20      LD  (_FATDRV),BC
001855 E573 CD98E7          17      CALL    RDFATS
001858 E576 189A            12      JR  RDFATE2
                                
       E578                     NCL3:
00185A E578 CB9A             8      RES 3,D
00185C E57A CB92             8      RES 2,D
00185E E57C 6B               4      LD  L,E
00185F E57D 62               4      LD  H,D
001860 E57E CB3C             8      SRL H   ;
001862 E580 CB1D             8      RR  L   ;HLA=HLA/2
001864 E582 1F               4      RRA     ;
001865 E583 F5              11      PUSH    AF
001866 E584 3AABF0          13      LD  A,(_FATIX)
001869 E587 0F               4      RRCA
00186A E588 300B            12      JR  NC,NCL3X1
00186C E58A 3A8AE3          13      LD  A,(SECSZ_H)
00186F E58D FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの際に先頭を512バイトずらす
001871 E58F 2004            12      JR  NZ,NCL3X1
001873 E591 010002          10      LD  BC,512
001876 E594 09              11      ADD HL,BC
       E595                     NCL3X1:
001877 E595 F1              10      POP AF
001878 E596 ED4B7CF1        20      LD  BC,(_FATBF)
00187C E59A 19              11      ADD HL,DE
00187D E59B 09              11      ADD HL,BC
00187E E59C 17               4      RLA
00187F E59D C9              10      RET
                                
       E59E                     GNCL:
001880 E59E CD45E5          17      CALL    NCL1        ;GET NEXT CLUSTER
001883 E5A1 D8              11      RET C
001884 E5A2 C5              11      PUSH    BC
001885 E5A3 E5              11      PUSH    HL
001886 E5A4 CD78E5          17      CALL    NCL3
001889 E5A7 3809            12      JR  C,GNC1
00188B E5A9 5E               7      LD  E,(HL)
00188C E5AA 23               6      INC HL
00188D E5AB 7E               7      LD  A,(HL)
00188E E5AC E60F             7      AND 00FH
001890 E5AE 57               4      LD  D,A
001891 E5AF E1              10      POP HL
001892 E5B0 C1              10      POP BC
001893 E5B1 C9              10      RET
       E5B2                     GNC1:
001894 E5B2 7E               7      LD  A,(HL)
001895 E5B3 23               6      INC HL
001896 E5B4 56               7      LD  D,(HL)
001897 E5B5 0604             7      LD  B,4
       E5B7                     GNC1L:
001899 E5B7 CB3A             8      SRL D   ;DA=DA/2
00189B E5B9 1F               4      RRA     ;
00189C E5BA 10FB            13      DJNZ    GNC1L
                                
00189E E5BC 5F               4      LD  E,A
00189F E5BD E1              10      POP HL
0018A0 E5BE C1              10      POP BC
0018A1 E5BF A7               4      AND A
0018A2 E5C0 C9              10      RET
                                
       E5C1                     SNCL:
0018A3 E5C1 CD45E5          17      CALL    NCL1
0018A6 E5C4 D8              11      RET C
                                ;               SET NEXT CLUSTER
0018A7 E5C5 E5              11      PUSH    HL
0018A8 E5C6 C5              11      PUSH    BC
0018A9 E5C7 D5              11      PUSH    DE
0018AA E5C8 E5              11      PUSH    HL
0018AB E5C9 CD78E5          17      CALL    NCL3
0018AE E5CC D1              10      POP DE
                                ;CF=ODD
0018AF E5CD 7E               7      LD  A,(HL)
0018B0 E5CE 73               7      LD  (HL),E
0018B1 E5CF 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
0018B3 E5D1 23               6      INC HL
0018B4 E5D2 ED67            18      RRD     ;M={A[3:0],E[3:0]}
0018B6 E5D4 7A               4      LD  A,D
0018B7 E5D5 1804            12      JR  SNC11
       E5D7                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
0018B9 E5D7 ED6F            18      RLD     ;M={D[3:0],E[7:4]}
0018BB E5D9 23               6      INC HL
0018BC E5DA 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E5DB                     SNC11:
0018BD E5DB ED6F            18      RLD     ;M={M[7:4],D[3:0]}
0018BF E5DD B7               4      OR  A
0018C0 E5DE D1              10      POP DE
0018C1 E5DF C1              10      POP BC
0018C2 E5E0 E1              10      POP HL
       E5E1                     FAT_CHANGED:
0018C3 E5E1 3EFF             7      LD  A,0FFH
0018C5 E5E3 32A2F0          13      LD  (_WTFATF),A
0018C8 E5E6 C9              10      RET
                                
       E5E7                     N16CL3:
0018C9 E5E7 C5              11      PUSH    BC
0018CA E5E8 6B               4      LD  L,E
0018CB E5E9 7A               4      LD  A,D
0018CC E5EA E601             7      AND 1
0018CE E5EC 67               4      LD  H,A
0018CF E5ED 29              11      ADD HL,HL
0018D0 E5EE ED4B7CF1        20      LD  BC,(_FATBF)
0018D4 E5F2 09              11      ADD HL,BC
0018D5 E5F3 C1              10      POP BC
0018D6 E5F4 C9              10      RET
                                
       E5F5                     GNCL16:
0018D7 E5F5 CD3EE5          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
0018DA E5F8 D8              11      RET C
0018DB E5F9 E5              11      PUSH    HL
0018DC E5FA CDE7E5          17      CALL    N16CL3
0018DF E5FD 5E               7      LD  E,(HL)
0018E0 E5FE 23               6      INC HL
0018E1 E5FF 56               7      LD  D,(HL)
0018E2 E600 E1              10      POP HL
0018E3 E601 C9              10      RET
                                
       E602                     SNCL16:
0018E4 E602 CD3EE5          17      CALL    N16CL1      ;SET NEXT CLUSTER for FAT16
0018E7 E605 D8              11      RET C
0018E8 E606 D5              11      PUSH    DE
0018E9 E607 E5              11      PUSH    HL
0018EA E608 CDE7E5          17      CALL    N16CL3
0018ED E60B D1              10      POP DE      ;HL
0018EE E60C 73               7      LD  (HL),E
0018EF E60D 23               6      INC HL
0018F0 E60E 72               7      LD  (HL),D
0018F1 E60F 6B               4      LD  L,E
0018F2 E610 62               4      LD  H,D
0018F3 E611 D1              10      POP DE
0018F4 E612 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E614                     NEXTX:
0018F6 E614 3E00             7      LD  A,0 ;自己書き換え
       E615                     _SECPS  EQU $-1
0018F8 E616 3C               4      INC A
0018F9 E617 E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E618                     _NCPAT  EQU $-1
0018FB E619 3215E6          13      LD  (_SECPS),A
0018FE E61C C9              10      RET
                                
       E61D                     GNCLX:
0018FF E61D CD14E6          17      CALL    NEXTX
001902 E620 C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
001903 E621 C3F7F0          10      JP  _GNCL   ;次のクラスタを探す
                                
       E624                     RDFAT:
001906 E624 3E80             7      LD  A,080H
001908 E626 3270F0          13      LD  (CHECK),A
       E629                     RDFAT1:
00190B E629 3A88F0          13      LD  A,(_DRV)
00190E E62C CDCCE8          17      CALL    CHGDRVR
001911 E62F D8              11      RET C
001912 E630 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001915 E633 CB6F             8      BIT 5,A
001917 E635 286C            12      JR  Z,RDFAT0X
001919 E637 2170F0          10      LD  HL,CHECK
00191C E63A A6               7      AND (HL)
00191D E63B 77               7      LD  (HL),A
00191E E63C 110000          10      LD  DE,0        ;BPB
001921 E63F 2A7CF1          16      LD  HL,(_FATBF)
001924 E642 0E00             7      LD  C,0
001926 E644 CDA4E7          17      CALL    DRD24
001929 E647 3022            12      JR  NC,GETBPB
00192B E649 2170F0          10      LD  HL,CHECK
00192E E64C CB06            15      RLC (HL)
001930 E64E 3F               4      CCF
001931 E64F D8              11      RET C
001932 E650 DDCB0A1E        23      RR  (IX+DPB_FDMODE)
001936 E654 3F               4      CCF         ;フロッピーディスクのFDモード(2D/2HD)を切り替える
001937 E655 DDCB0A16        23      RL  (IX+DPB_FDMODE)
00193B E659 3A84F0          13      LD  A,(_DRIVE)
00193E E65C E603             7      AND 3
001940 E65E F680             7      OR  080H
001942 E660 6F               4      LD  L,A
001943 E661 26F0             7      LD  H,_CYL0/256
001945 E663 3EFF             7      LD  A,0FFH
001947 E665 3289F0          13      LD  (_DSK),A
00194A E668 77               7      LD  (HL),A
00194B E669 18BE            12      JR  RDFAT1
       E66B                     GETBPB:
00194D E66B FDE5            15      PUSH    IY
00194F E66D FD2A7CF1        20      LD  IY,(_FATBF) ;BPB
001953 E671 CDF1F0          17      CALL    _BPB2DPB
001956 E674 FDE1            14      POP IY
001958 E676 DD7E12          19      LD  A,(IX+DPB_DEVICE)
00195B E679 3025            12      JR  NC,GETBPBOK
00195D E67B E60F             7      AND 00FH
00195F E67D FE07             7      CP  7
001961 E67F 37               4      SCF
001962 E680 C0              11      RET NZ
001963 E681 DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
001967 E685 21C0F1          10      LD  HL,M2D
00196A E688 2006            12      JR  NZ,SETFDMODE
00196C E68A CD7DE7          17      CALL    CHECK1024
00196F E68D D8              11      RET C
001970 E68E 2ED2             7      LD  L,M2HD-STABLE
       E690                     SETFDMODE:
001972 E690 DDE5            15      PUSH    IX
001974 E692 D1              10      POP DE
001975 E693 EDA0            16      LDI
001977 E695 EDA0            16      LDI
001979 E697 13               6      INC DE
00197A E698 13               6      INC DE
00197B E699 13               6      INC DE
00197C E69A 13               6      INC DE
00197D E69B 010C00          10      LD  BC,12
001980 E69E EDB0                    LDIR
       E6A0                     GETBPBOK:
001982 E6A0 CD38E8          17      CALL    CHGDRV2
       E6A3                     RDFAT0X:
001985 E6A3 CD98E7          17      CALL    RDFATS
001988 E6A6 D8              11      RET C
001989 E6A7 DDAE06          19      XOR (IX+DPB_FATID)
00198C E6AA C8              11      RET Z
00198D E6AB DD7E12          19      LD  A,(IX+DPB_DEVICE)
001990 E6AE CB5F             8      BIT 3,A
001992 E6B0 2803            12      JR  Z,RDFAT0X1
001994 E6B2 CB6F             8      BIT 5,A
001996 E6B4 C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
       E6B5                     RDFAT0X1:
001997 E6B5 37               4      SCF
001998 E6B6 C9              10      RET
                                
       E6B7                     POP_HL_SCF_RET:
001999 E6B7 E1              10      POP HL
00199A E6B8 37               4      SCF
00199B E6B9 C9              10      RET
                                
       E6BA                     BPB2DPB:
00199C E6BA FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
00199F E6BD B7               4      OR  A
0019A0 E6BE 37               4      SCF
0019A1 E6BF C0              11      RET NZ
       E6C0                     BPBOK:
0019A2 E6C0 FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
0019A5 E6C3 DD7707          19      LD  (IX+DPB_SECPCL),A
                                
0019A8 E6C6 FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
0019AB E6C9 DD7700          19      LD  (IX+DPB_FATLN),A
0019AE E6CC FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
0019B1 E6CF DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
0019B4 E6D2 FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
0019B7 E6D5 FD660F          19      LD  H,(IY+15)
0019BA E6D8 DD750E          19      LD  (IX+DPB_FATPS),L
0019BD E6DB FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
0019C0 E6DE FD5617          19      LD  D,(IY+23)
0019C3 E6E1 FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E6E4                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
0019C6 E6E4 19              11      ADD HL,DE
0019C7 E6E5 10FD            13      DJNZ    BPBDP1
       E6E7                     BPBDP2:
0019C9 E6E7 DD7510          19      LD  (IX+DPB_DIRPS),L
0019CC E6EA DD7411          19      LD  (IX+DPB_DIRPS+1),H
0019CF E6ED E5              11      PUSH    HL
                                
0019D0 E6EE FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
0019D3 E6F1 FD6612          19      LD  H,(IY+18)
0019D6 E6F4 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
0019D9 E6F7 B7               4      OR  A
0019DA E6F8 28BD            12      JR  Z,POP_HL_SCF_RET
0019DC E6FA 0606             7      LD  B,6
       E6FC                     BPBBPS1:
0019DE E6FC 05               4      DEC B
0019DF E6FD 0F               4      RRCA
0019E0 E6FE 30FC            12      JR  NC,BPBBPS1
       E700                     BPBDE1:
0019E2 E700 29              11      ADD HL,HL
0019E3 E701 10FD            13      DJNZ    BPBDE1
                                
0019E5 E703 7C               4      LD  A,H
0019E6 E704 DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
0019E9 E707 D1              10      POP DE      ;DPB_DIRPS
0019EA E708 6C               4      LD  L,H
0019EB E709 2600             7      LD  H,0
0019ED E70B 19              11      ADD HL,DE       ;MAXDIR
0019EE E70C E5              11      PUSH    HL
0019EF E70D FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
0019F2 E710 CB21             8      SLA C       ;*2
0019F4 E712 AF               4      XOR A
0019F5 E713 47               4      LD  B,A
0019F6 E714 ED42            15      SBC HL,BC
0019F8 E716 DD7514          19      LD  (IX+DPB_ADDCL),L
0019FB E719 DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
0019FE E71C D1              10      POP DE      ;DE=DPB_MAXDIR
0019FF E71D FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
001A02 E720 FD6614          19      LD  H,(IY+20)
                                
001A05 E723 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001A08 E726 E60F             7      AND 00FH
001A0A E728 FE07             7      CP  7       ;フロッピー
001A0C E72A 2019            12      JR  NZ,NOT_FD
001A0E E72C E5              11      PUSH    HL
001A0F E72D FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
001A12 E730 DD710D          19      LD  (IX+DPB_MAXSEC),C
001A15 E733 AF               4      XOR A
001A16 E734 CB21             8      SLA C       ;両面なのでセクタ数を２倍
001A18 E736 0610             7      LD  B,16
       E738                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
001A1A E738 29              11      ADD HL,HL
001A1B E739 17               4      RLA
001A1C E73A B9               4      CP  C
001A1D E73B 3802            12      JR  C,DIVSEC1
001A1F E73D 91               4      SUB C
001A20 E73E 2C               4      INC L
       E73F                     DIVSEC1:
001A21 E73F 10F7            13      DJNZ    DIVSEC
001A23 E741 DD750C          19      LD  (IX+DPB_MAXCYL),L
001A26 E744 E1              10      POP HL  ;ここまでフロッピー専用
       E745                     NOT_FD:
001A27 E745 7C               4      LD  A,H
001A28 E746 B5               4      OR  L
001A29 E747 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001A2B E749 200E            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001A2D E74B 2F               4      CPL         ;A=0FFH
001A2E E74C FD8623          19      ADD A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001A31 E74F D8              11      RET C
001A32 E750 FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001A35 E753 FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので、
001A38 E756 FD7E22          19      LD  A,(IY+34)   ;FAT12,FAT16では総セクタ数が24ビットを超えることは無い
       E759                     BPB16BIT:
001A3B E759 ED52            15      SBC HL,DE       ;DE=DPB_MAXDIR
001A3D E75B DE00             7      SBC A,0
001A3F E75D FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E760                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001A42 E760 CB18             8      RR  B       ;->CY
001A44 E762 3808            12      JR  C,BPBTC2
001A46 E764 CB3F             8      SRL A
001A48 E766 CB1C             8      RR  H       ;AHL=AHL/2
001A4A E768 CB1D             8      RR  L
001A4C E76A 18F4            12      JR  BPBTC1
       E76C                     BPBTC2:
001A4E E76C C6FF             7      ADD A,0FFH
001A50 E76E D8              11      RET C       ;念のため(クラスタ数が16ビットを超える場合)
001A51 E76F 23               6      INC HL
001A52 E770 23               6      INC HL
001A53 E771 DD7508          19      LD  (IX+DPB_MAXCL),L
001A56 E774 DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001A59 E777 FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001A5C E77A DD7706          19      LD  (IX+DPB_FATID),A
       E77D                     CHECK1024:
001A5F E77D FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001A62 E780 C6FE             7      ADD A,0-2       ;>2:CF=1
001A64 E782 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001A67 E785 6F               4      LD  L,A
001A68 E786 3002            12      JR  NC,BPBFAT1
001A6A E788 F680             7      OR  080H
       E78A                     BPBFAT1:            ;ここではCF=0
001A6C E78A DD770F          19      LD  (IX+DPB_BPS),A
001A6F E78D 3A7BF1          13      LD  A,(_MAX_SEC_SZ_H)
001A72 E790 BD               4      CP  L
001A73 E791 C8              11      RET Z       ;1セクタ1024バイト
001A74 E792 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001A75 E793 C8              11      RET Z       ;1セクタ256バイト
001A76 E794 2D               4      DEC L
001A77 E795 C8              11      RET Z       ;1セクタ512バイト
001A78 E796 37               4      SCF
001A79 E797 C9              10      RET
                                
       E798                     RDFATS:
001A7A E798 CDC3E7          17      CALL    FATSETUP
001A7D E79B D8              11      RET C
001A7E E79C CDA6E7          17      CALL    DRD24B
001A81 E79F 2A7CF1          16      LD  HL,(_FATBF)
001A84 E7A2 7E               7      LD  A,(HL)
001A85 E7A3 C9              10      RET
                                
       E7A4                     DRD24:
001A86 E7A4 0601             7      LD  B,1
       E7A6                     DRD24B:
001A88 E7A6 DDE5            15      PUSH    IX
001A8A E7A8 DD2AA8F0        20      LD  IX,(_DPB)
001A8E E7AC CD0CEA          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E7AD                     DRDPAT  EQU $-2
001A91 E7AF DDE1            14      POP IX
001A93 E7B1 C9              10      RET
                                
       E7B2                     DWT24:
001A94 E7B2 0601             7      LD  B,1
       E7B4                     DWT24B:
001A96 E7B4 DDE5            15      PUSH    IX
001A98 E7B6 DD2AA8F0        20      LD  IX,(_DPB)
001A9C E7BA CDB5E9          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       E7BB                     DWTPAT  EQU $-2
001A9F E7BD DDE1            14      POP IX
001AA1 E7BF D0              11      RET NC
001AA2 E7C0 C35AF0          10      JP  _DISKE
                                
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ512毎に1KBを切り替える
                                ;------------------------
       E7C3                     FATSETUP:
001AA5 E7C3 3AAAF0          13      LD  A,(_FATDRV)
001AA8 E7C6 CDCCE8          17      CALL    CHGDRVR     ;ドライブ切り替え
001AAB E7C9 D8              11      RET C
       E7CA                     FATS2:
001AAC E7CA DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001AAF E7CD 0F               4      RRCA
001AB0 E7CE CDFEE7          17      CALL    FATSETUP12  ;自己書き換え
       E7CF                     FATSX   EQU $-2
001AB3 E7D1 210000          10      LD  HL,0
001AB6 E7D4 4A               4      LD  C,D
001AB7 E7D5 54               4      LD  D,H
001AB8 E7D6 3AABF0          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-127(0-07FH):65535*2/1024
001ABB E7D9 47               4      LD  B,A
001ABC E7DA 04               4      INC B
001ABD E7DB DD7E00          19      LD  A,(IX+DPB_FATLN)
       E7DE                     FAT_SKP:
001AC0 E7DE 05               4      DEC B
001AC1 E7DF 2809            12      JR  Z,FAT1
001AC3 E7E1 19              11      ADD HL,DE
001AC4 E7E2 93               4      SUB E
001AC5 E7E3 30F9            12      JR  NC,FAT_SKP
001AC7 E7E5 DDCB0146        20      BIT 0,(IX+DPB_FATLN+1)  ;FATサイズが0100H(256)の場合
001ACB E7E9 C8              11      RET Z
       E7EA                     FAT1:
001ACC E7EA EB               4      EX  DE,HL
001ACD E7EB B7               4      OR  A       ;0の場合は0100Hとして扱う
001ACE E7EC 2803            12      JR  Z,FAT3
001AD0 E7EE B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001AD1 E7EF 3801            12      JR  C,FAT2
       E7F1                     FAT3:
001AD3 E7F1 79               4      LD  A,C
       E7F2                     FAT2:
001AD4 E7F2 47               4      LD  B,A
                                
001AD5 E7F3 2AFAF1          16      LD  HL,(_FATPS) ;fat sector pos
001AD8 E7F6 19              11      ADD HL,DE
001AD9 E7F7 EB               4      EX  DE,HL
001ADA E7F8 2A7CF1          16      LD  HL,(_FATBF)
001ADD E7FB AF               4      XOR A       ;CF=0
001ADE E7FC 4F               4      LD  C,A
001ADF E7FD C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       E7FE                     FATSETUP12:
001AE0 E7FE 110606          10      LD  DE,0606H    ;256
001AE3 E801 D8              11      RET C
001AE4 E802 110303          10      LD  DE,0303H    ;512
001AE7 E805 0F               4      RRCA
001AE8 E806 D8              11      RET C
001AE9 E807 110102          10      LD  DE,0201H    ;1024
001AEC E80A C9              10      RET
                                
       E80B                     FATSETUP16:
001AED E80B 110404          10      LD  DE,0404H    ;256
001AF0 E80E D8              11      RET C
001AF1 E80F 110202          10      LD  DE,0202H    ;512
001AF4 E812 0F               4      RRCA
001AF5 E813 D8              11      RET C
001AF6 E814 110101          10      LD  DE,0101H    ;1024
001AF9 E817 C9              10      RET
                                
       E818                     CHGDRV:
001AFA E818 E5              11      PUSH    HL
001AFB E819 2189F0          10      LD  HL,_DSK
001AFE E81C BE               7      CP  (HL)
001AFF E81D 280A            12      JR  Z,CHGDRVE
       E81F                     CHGDRV1:
001B01 E81F DDE5            15      PUSH    IX
001B03 E821 CD2BE8          17      CALL    CHGDRV0
001B06 E824 3A89F0          13      LD  A,(_DSK)
001B09 E827 DDE1            14      POP IX
       E829                     CHGDRVE:
001B0B E829 E1              10      POP HL
001B0C E82A C9              10      RET
                                
       E82B                     CHGDRV0:
001B0D E82B 6F               4      LD  L,A
001B0E E82C CDDCF0          17      CALL    _GETDPB
001B11 E82F D8              11      RET C
001B12 E830 DD22A8F0        20      LD  (_DPB),IX
001B16 E834 7D               4      LD  A,L
001B17 E835 3289F0          13      LD  (_DSK),A
       E838                     CHGDRV2:
001B1A E838 C5              11      PUSH    BC
001B1B E839 D5              11      PUSH    DE
001B1C E83A ED7383E8        20      LD  (SPPAT2),SP
001B20 E83E F3               4      DI
001B21 E83F DDF9            10      LD  SP,IX
                                
001B23 E841 E1              10      POP HL      ;00:DPB_FATLN
001B24 E842 E1              10      POP HL      ;02:DPB_DRD
001B25 E843 22ADE7          16      LD  (DRDPAT),HL
                                
001B28 E846 E1              10      POP HL
001B29 E847 22BBE7          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001B2C E84A E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001B2D E84B 7C               4      LD  A,H
001B2E E84C 32B1DE          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001B31 E84F 3D               4      DEC A
001B32 E850 3218E6          13      LD  (_NCPAT),A
                                
001B35 E853 E1              10      POP HL      ;08:DPB_MAXCL
001B36 E854 7D               4      LD  A,L
001B37 E855 32D0DE          13      LD  (CLPAT2),A
001B3A E858 7C               4      LD  A,H
001B3B E859 32CCDE          13      LD  (CLPAT1),A
001B3E E85C 2B               6      DEC HL
001B3F E85D 22CFE0          16      LD  (MAXCLP),HL
                                
001B42 E860 E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001B43 E861 4C               4      LD  C,H
                                
001B44 E862 E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001B45 E863 E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001B46 E864 7C               4      LD  A,H     ;DPB_BPS
001B47 E865 E607             7      AND 7
001B49 E867 328AE3          13      LD  (SECSZ_H),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98等
                                                ;1セクタ256 GRAM/RAMF/CMOS等
                                                ;1024   512 256
                                                ;4  2   1
001B4C E86A 87               4      ADD A,A     ;8  4   2
001B4D E86B 87               4      ADD A,A     ;010H   8   4
001B4E E86C 87               4      ADD A,A     ;020H   010H    8
001B4F E86D 322FDD          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001B52 E870 2600             7      LD  H,0
001B54 E872 22FAF1          16      LD  (_FATPS),HL
                                
001B57 E875 E1              10      POP HL      ;10:DPB_DIRPS
001B58 E876 22FCF1          16      LD  (_DIRPS),HL
                                
001B5B E879 E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001B5C E87A 7C               4      LD  A,H
001B5D E87B 3284F0          13      LD  (_DRIVE),A
                                
001B60 E87E E1              10      POP HL      ;14:DPB_ADDCL
001B61 E87F 22C1DE          16      LD  (CLSPAT),HL
                                
001B64 E882 310000          10      LD  SP,0        ;元のSPを復元
       E883                     SPPAT2  EQU $-2
001B67 E885 FB               4      EI
001B68 E886 2AFCF1          16      LD  HL,(_DIRPS)
001B6B E889 0600             7      LD  B,0
001B6D E88B 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001B6E E88C 224ADD          16      LD  (MD_PAT),HL
                                
001B71 E88F 2ACFE0          16      LD  HL,(MAXCLP)
001B74 E892 110AF0          10      LD  DE,0-4086   ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001B77 E895 19              11      ADD HL,DE
001B78 E896 380F            12      JR  C,SETFAT16
001B7A E898 219EE5          10      LD  HL,GNCL     ;FAT12
001B7D E89B 11C1E5          10      LD  DE,SNCL
001B80 E89E 01FEE7          10      LD  BC,FATSETUP12
001B83 E8A1 DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001B87 E8A5 180D            12      JR  EXTRA1
       E8A7                     SETFAT16:
001B89 E8A7 21F5E5          10      LD  HL,GNCL16   ;FAT16
001B8C E8AA 1102E6          10      LD  DE,SNCL16
001B8F E8AD 010BE8          10      LD  BC,FATSETUP16
001B92 E8B0 DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       E8B4                     EXTRA1:
001B96 E8B4 22F8F0          16      LD  (GNCPAT),HL
001B99 E8B7 ED53FBF0        20      LD  (SNCPAT),DE
001B9D E8BB ED43CFE7        20      LD  (FATSX),BC
001BA1 E8BF D1              10      POP DE
001BA2 E8C0 C1              10      POP BC
001BA3 E8C1 AF               4      XOR A
001BA4 E8C2 C9              10      RET
                                
       E8C3                     GETDPBD:
001BA5 E8C3 DDE3            23      EX  (SP),IX
001BA7 E8C5 DDE5            15      PUSH    IX
001BA9 E8C7 3A88F0          13      LD  A,(_DRV)
001BAC E8CA 1807            12      JR  GETDPB1
                                
       E8CC                     CHGDRVR:
001BAE E8CC CDD9F0          17      CALL    _CHGDRV
001BB1 E8CF D8              11      RET C
001BB2 E8D0 3A89F0          13      LD  A,(_DSK)
       E8D3                     GETDPB1:
001BB5 E8D3 C3DCF0          10      JP  _GETDPB
                                
       E8D6                     GETDPB:
001BB8 E8D6 FE08             7      CP  8
001BBA E8D8 3F               4      CCF
001BBB E8D9 D8              11      RET C
001BBC E8DA 0F               4      RRCA
001BBD E8DB 0F               4      RRCA
001BBE E8DC 0F               4      RRCA
001BBF E8DD DD                      DB  0DDH        ;Z80未定義命令
001BC0 E8DE 6F               4      LD  L,A     ;LD IXL,A
001BC1 E8DF DD                      DB  0DDH        ;Z80未定義命令
001BC2 E8E0 26F2             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
001BC4 E8E2 DD7E00          19      LD  A,(IX+DPB_FATLN)
001BC7 E8E5 A7               4      AND A       ;CF=0の為
001BC8 E8E6 DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
001BCC E8EA C0              11      RET NZ      ;FAT16
001BCD E8EB DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001BD1 E8EF C0              11      RET NZ      ;BPB
001BD2 E8F0 FE01             7      CP  001H        ;A=0 THEN CF=1
001BD4 E8F2 C9              10      RET
                                
       E8F3                     _SYS5F:
001BD5 E8F3 AF               4      XOR A
       E8F4                     FFLUSH:
001BD6 E8F4 F5              11      PUSH    AF
001BD7 E8F5 CD1CE5          17      CALL    WTFATX
001BDA E8F8 AF               4      XOR A
001BDB E8F9 32ABF0          13      LD  (_FATIX),A
001BDE E8FC 2F               4      CPL         ;0FFH
001BDF E8FD 32AAF0          13      LD  (_FATDRV),A
001BE2 E900 3E                      DB  03EH        ;次のPUSH AFをスキップ
       E901                     FFLUSHBUF:
001BE3 E901 F5              11      PUSH    AF
001BE4 E902 CDD2E4          17      CALL    DWTX
001BE7 E905 3EFF             7      LD  A,0FFH
001BE9 E907 3239F0          13      LD  (SFILE),A
001BEC E90A 32A5F0          13      LD  (_DBDRV),A
001BEF E90D F1              10      POP AF
001BF0 E90E C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   MZ-700/1500
                                
       E90F                     SEEK:
001BF1 E90F 0610             7      LD  B,16
001BF3 E911 DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001BF6 E914 AF               4      XOR A
001BF7 E915 EB               4      EX  DE,HL
       E916                     DIV1:
001BF8 E916 29              11      ADD HL,HL
001BF9 E917 8F               4      ADC A,A
001BFA E918 B9               4      CP  C
001BFB E919 3802            12      JR  C,DIV2
001BFD E91B 91               4      SUB C
001BFE E91C 2C               4      INC L
       E91D                     DIV2:
001BFF E91D 10F7            13      DJNZ    DIV1
                                
001C01 E91F 3C               4      INC A   ;最小のセクタは１固定
001C02 E920 55               4      LD  D,L ;TRACK
001C03 E921 5F               4      LD  E,A ;SECTOR
                                
001C04 E922 3A84F0          13      LD  A,(_DRIVE)
001C07 E925 FE04             7      CP  4
001C09 E927 3F               4      CCF
001C0A E928 D8              11      RET C
001C0B E929 F684             7      OR  084H        ;Motor on + ドライブセレクト有効
001C0D E92B D3DC            11      OUT (0DCH),A    ;モータ/ドライブセレクト制御レジスタ
001C0F E92D CB3A             8      SRL D       ;CYLINDER
001C11 E92F 9F               4      SBC A,A
001C12 E930 D3DD            11      OUT (0DDH),A    ;ヘッドセレクト制御レジスタ
                                
001C14 E932 CD6AE9          17      CALL    SETMODE
001C17 E935 D8              11      RET C
                                
001C18 E936 CD9FE9          17      CALL    DRIVE
001C1B E939 FEFF             7      CP  0FFH        ;A=0FFH Unknown CYLINDER
001C1D E93B CC81E9          17      CALL    Z,FDCRES    ;Restore
001C20 E93E 2F               4      CPL         ;データバスが負論理
001C21 E93F D3D9            11      OUT (0D9H),A    ;MB8876 トラックレジスタ
001C23 E941 2F               4      CPL         ;データバスが負論理
001C24 E942 92               4      SUB D
001C25 E943 C8              11      RET Z       ;No seek
                                
001C26 E944 DD7E0C          19      LD  A,(IX+DPB_MAXCYL)
001C29 E947 3D               4      DEC A
001C2A E948 BA               4      CP  D       ;Over CYLINDER
001C2B E949 D8              11      RET C
                                
001C2C E94A 7A               4      LD  A,D
001C2D E94B 2F               4      CPL         ;データバスが負論理
001C2E E94C D3DB            11      OUT (0DBH),A    ;MB8876 データレジスタ
001C30 E94E 72               7      LD  (HL),D
                                
001C31 E94F 0E18             7      LD  C,018H      ;FDC TypeIコマンド Seek
       E951                     FDCCMD2:
001C33 E951 3A85F0          13      LD  A,(_SEEKSP)
001C36 E954 B1               4      OR  C
                                
       E955                     FDCCMD:
001C37 E955 CD96E9          17      CALL    COMSET
001C3A E958 3E80             7      LD  A,080H      ;FDC COMMAND(Self-modifying code)
       E959                     FDCSMC  EQU $-1
001C3C E95A E620             7      AND 020H        ;Write data Write track
001C3E E95C 3C               4      INC A
                                
       E95D                     SST:
001C3F E95D 0E00             7      LD  C,0
       E95F                     SST1:
001C41 E95F 0D               4      DEC C       ; 4
001C42 E960 20FD            12      JR  NZ,SST1     ;12 * 256 / 4 = About 1ms
001C44 E962 3D               4      DEC A
001C45 E963 20FA            12      JR  NZ,SST1
                                
001C47 E965 0E01             7      LD  C,1
001C49 E967 CD6FE9          17      CALL    READY
       E96A                     SETMODE:
001C4C E96A CD99E9          17      CALL    DELAY0      ;Head select time
001C4F E96D 0E81             7      LD  C,081H
       E96F                     READY:
001C51 E96F 0680             7      LD  B,128
       E971                     READY2:
001C53 E971 DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001C55 E973 2F               4      CPL         ;データバスが負論理
001C56 E974 A1               4      AND C       ;NOT READY,BUSY
001C57 E975 C8              11      RET Z
001C58 E976 CD2DCF          17      CALL    RD556VSYNC
001C5B E979 07               4      RLCA
001C5C E97A A8               4      XOR B
001C5D E97B 0F               4      RRCA
001C5E E97C 30F3            12      JR  NC,READY2
001C60 E97E 10F1            13      DJNZ    READY2
001C62 E980 C9              10      RET
                                
       E981                     FDCRES:
001C63 E981 3600            10      LD  (HL),0
001C65 E983 0E08             7      LD  C,8     ;FDC TypeIコマンド Restore
001C67 E985 18CA            12      JR  FDCCMD2
                                
       E987                     FDMOFF:
001C69 E987 F5              11      PUSH    AF
001C6A E988 AF               4      XOR A       ;Motor off(ドライブセレクト無効)
001C6B E989 D3DC            11      OUT (0DCH),A    ;モータ/ドライブセレクト制御レジスタ
001C6D E98B F1              10      POP AF
001C6E E98C C9              10      RET
                                
       E98D                     SECSET_FDCCMD:
001C6F E98D 3A59E9          13      LD  A,(FDCSMC)
       E990                     SECSET:
001C72 E990 F5              11      PUSH    AF
001C73 E991 7B               4      LD  A,E
001C74 E992 2F               4      CPL         ;データバスが負論理
001C75 E993 D3DA            11      OUT (0DAH),A    ;MB8876 セクタレジスタ
001C77 E995 F1              10      POP AF
       E996                     COMSET:
001C78 E996 2F               4      CPL         ;データバスが負論理
001C79 E997 D3D8            11      OUT (0D8H),A    ;MB8876 ステータス/コマンドレジスタ
       E999                     DELAY0:
001C7B E999 3E1A             7      LD  A,26
       E99B                     DELAY:
001C7D E99B 3D               4      DEC A
001C7E E99C 20FD            12      JR  NZ,DELAY
001C80 E99E C9              10      RET
                                
       E99F                     DRIVE:                  ;ドライブのシリンダを得る
001C81 E99F 2A84F0          16      LD  HL,(_DRIVE)
001C84 E9A2 26F0             7      LD  H,_CYL0/256
001C86 E9A4 CBFD             8      SET 7,L
001C88 E9A6 7E               7      LD  A,(HL)
001C89 E9A7 C9              10      RET
                                
       E9A8                     RNF:                    ;ドライブのシリンダをリセット
001C8A E9A8 CD9FE9          17      CALL    DRIVE
001C8D E9AB 36FF            10      LD  (HL),0FFH
001C8F E9AD C9              10      RET
                                
001C90 E9AE 02                  RETRY:  DB  2
                                
                                
                                ;   FLOPPY DISK DRIVER
                                
       E9AF                     WTTRK:
001C91 E9AF 0601             7      LD  B,1
001C93 E9B1 3EF4             7      LD  A,0F4H      ;FDC TypeIIIコマンド Write Track
001C95 E9B3 1802            12      JR  WTTRK1
       E9B5                     FDWT:
001C97 E9B5 3EA0             7      LD  A,0A0H      ;FDC TypeIIコマンド Write Sector
       E9B7                     WTTRK1:
001C99 E9B7 3259E9          13      LD  (FDCSMC),A
       E9BA                     DWTBL:
001C9C E9BA 78               4      LD  A,B
001C9D E9BB 32F7E9          13      LD  (WTBSMC),A
001CA0 E9BE 3E02             7      LD  A,2     ;Retry count
001CA2 E9C0 32AEE9          13      LD  (RETRY),A
                                
       E9C3                     DWT0:
001CA5 E9C3 D5              11      PUSH    DE
001CA6 E9C4 E5              11      PUSH    HL
001CA7 E9C5 CD0FE9          17      CALL    SEEK        ;Write disk
001CAA E9C8 E1              10      POP HL
001CAB E9C9 3837            12      JR  C,ERRDW
001CAD E9CB F3               4      DI
001CAE E9CC CD8DE9          17      CALL    SECSET_FDCCMD
001CB1 E9CF 0EDB             7      LD  C,0DBH      ;MB8876 データレジスタ
       E9D1                     DWT1:
001CB3 E9D1 7E               7      LD  A,(HL)
001CB4 E9D2 2F               4      CPL         ;データバスが負論理
001CB5 E9D3 57               4      LD  D,A
                                
       E9D4                     DWT2:
001CB6 E9D4 DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001CB8 E9D6 2F               4      CPL         ;データバスが負論理
001CB9 E9D7 0F               4      RRCA
001CBA E9D8 3008            12      JR  NC,DWT4
001CBC E9DA 0F               4      RRCA
001CBD E9DB 30F7            12      JR  NC,DWT2
       E9DD                     DWT3:
001CBF E9DD ED51            12      OUT (C),D       ;MB8876 データレジスタ
001CC1 E9DF 23               6      INC HL
001CC2 E9E0 18EF            12      JR  DWT1
                                
       E9E2                     DWT4:
001CC4 E9E2 3D               4      DEC A
001CC5 E9E3 28F8            12      JR  Z,DWT3
001CC7 E9E5 3C               4      INC A
001CC8 E9E6 FB               4      EI
001CC9 E9E7 D1              10      POP DE
001CCA E9E8 13               6      INC DE
001CCB E9E9 CD87E9          17      CALL    FDMOFF
001CCE E9EC 2808            12      JR  Z,DISKOK_WT
001CD0 E9EE CD56EA          17      CALL    DISKC
001CD3 E9F1 20D0            12      JR  NZ,DWT0
001CD5 E9F3 B7               4      OR  A
001CD6 E9F4 2005            12      JR  NZ,ERRW
                                
       E9F6                     DISKOK_WT:
001CD8 E9F6 0601             7      LD  B,1
       E9F7                     WTBSMC  EQU $-1
001CDA E9F8 10C0            13      DJNZ    DWTBL
001CDC E9FA C9              10      RET
                                
       E9FB                     ERRW:
001CDD E9FB 3EFF             7      LD  A,0FFH
       E9FD                     ERRZ:
001CDF E9FD BF               4      CP  A       ;ZF=1
001CE0 E9FE 37               4      SCF
001CE1 E9FF C387E9          10      JP  FDMOFF
                                
       EA02                     ERRDW:
001CE4 EA02 D1              10      POP DE
001CE5 EA03 CD67EA          17      CALL    DELP
001CE8 EA06 20BB            12      JR  NZ,DWT0
001CEA EA08 B7               4      OR  A
001CEB EA09 20F0            12      JR  NZ,ERRW
001CED EA0B C9              10      RET
                                
       EA0C                     FDRD:
001CEE EA0C 3E80             7      LD  A,080H      ;FDC TypeIIコマンド Read Sector
001CF0 EA0E 3259E9          13      LD  (FDCSMC),A
       EA11                     DRDBL:
001CF3 EA11 78               4      LD  A,B
001CF4 EA12 3248EA          13      LD  (RDBSMC),A
001CF7 EA15 3E02             7      LD  A,2     ;Retry count
001CF9 EA17 32AEE9          13      LD  (RETRY),A
       EA1A                     DRD0:
001CFC EA1A D5              11      PUSH    DE
001CFD EA1B E5              11      PUSH    HL
001CFE EA1C CD0FE9          17      CALL    SEEK        ;Read disk
001D01 EA1F E1              10      POP HL
001D02 EA20 382A            12      JR  C,ERRDR
001D04 EA22 F3               4      DI
001D05 EA23 CD8DE9          17      CALL    SECSET_FDCCMD
       EA26                     DRD1:
001D08 EA26 DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001D0A EA28 2F               4      CPL         ;データバスが負論理
001D0B EA29 0F               4      RRCA
001D0C EA2A 300A            12      JR  NC,DRD3
001D0E EA2C 0F               4      RRCA
001D0F EA2D 30F7            12      JR  NC,DRD1
001D11 EA2F DBDB            11      IN  A,(0DBH)    ;MB8876 データレジスタ
001D13 EA31 2F               4      CPL         ;データバスが負論理
001D14 EA32 77               7      LD  (HL),A
001D15 EA33 23               6      INC HL
001D16 EA34 18F0            12      JR  DRD1
                                
       EA36                     DRD3:
001D18 EA36 B7               4      OR  A
001D19 EA37 FB               4      EI
001D1A EA38 D1              10      POP DE
001D1B EA39 13               6      INC DE
001D1C EA3A CD87E9          17      CALL    FDMOFF
001D1F EA3D 2808            12      JR  Z,DISKOK_RD
001D21 EA3F CD56EA          17      CALL    DISKC
001D24 EA42 20D6            12      JR  NZ,DRD0
001D26 EA44 B7               4      OR  A
001D27 EA45 20B4            12      JR  NZ,ERRW
                                
       EA47                     DISKOK_RD:
001D29 EA47 0601             7      LD  B,1
       EA48                     RDBSMC  EQU $-1
001D2B EA49 10C6            13      DJNZ    DRDBL
001D2D EA4B C9              10      RET
                                
       EA4C                     ERRDR:
001D2E EA4C D1              10      POP DE
001D2F EA4D CD67EA          17      CALL    DELP
001D32 EA50 20C8            12      JR  NZ,DRD0
001D34 EA52 B7               4      OR  A
001D35 EA53 20A6            12      JR  NZ,ERRW
001D37 EA55 C9              10      RET
       EA56                     DISKC:
001D38 EA56 1B               6      DEC DE
001D39 EA57 CB5F             8      BIT 3,A
001D3B EA59 C4A8E9          17      CALL    NZ,RNF
       EA5C                     DISKD:
001D3E EA5C E5              11      PUSH    HL
001D3F EA5D 21AEE9          10      LD  HL,RETRY
001D42 EA60 35              11      DEC (HL)
001D43 EA61 E1              10      POP HL
001D44 EA62 200C            12      JR  NZ,ERR      ;Retry
001D46 EA64 B7               4      OR  A
001D47 EA65 2809            12      JR  Z,ERR       ;Error
                                
       EA67                     DELP:
001D49 EA67 CDA8E9          17      CALL    RNF
001D4C EA6A CD87E9          17      CALL    FDMOFF
001D4F EA6D 3EFF             7      LD  A,0FFH
       EA6F                     AERRZ:
001D51 EA6F BF               4      CP  A
       EA70                     ERR:
001D52 EA70 3EFF             7      LD  A,0FFH
001D54 EA72 C9              10      RET
[EOF:M7DISK.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   MZ-700/1500
                                
                                ;   EMM DRIVER
                                ;   1セクタ可変(256/512/1024)
                                
       EA73                     EDWT:
001D55 EA73 F5              11      PUSH    AF
001D56 EA74 CD92EA          17      CALL    EADR
001D59 EA77 0600             7      LD  B,0
       EA79                     EDWT1:
001D5B EA79 EDB3                    OTIR
001D5D EA7B 3D               4      DEC A
001D5E EA7C 20FB            12      JR  NZ,EDWT1
001D60 EA7E 180B            12      JR  EDRW1
                                
       EA80                     EDRD:
001D62 EA80 C5              11      PUSH    BC
001D63 EA81 CD92EA          17      CALL    EADR
001D66 EA84 0600             7      LD  B,0
       EA86                     EDRD1:
001D68 EA86 EDB2                    INIR
001D6A EA88 3D               4      DEC A
001D6B EA89 20FB            12      JR  NZ,EDRD1
       EA8B                     EDRW1:
001D6D EA8B F1              10      POP AF
001D6E EA8C 83               4      ADD A,E ;セクタを進める
001D6F EA8D 5F               4      LD  E,A
001D70 EA8E 8A               4      ADC A,D
001D71 EA8F 93               4      SUB E
001D72 EA90 57               4      LD  D,A
001D73 EA91 C9              10      RET
                                
       EA92                     EADR:
001D74 EA92 D5              11      PUSH    DE
001D75 EA93 EB               4      EX  DE,HL
001D76 EA94 78               4      LD  A,B
001D77 EA95 DD460F          19      LD  B,(IX+DPB_BPS)
       EA98                     EADR1:              ;読み込むセクタ数と1クラスタのセクタ数を掛ける
001D7A EA98 CB18             8      RR  B
001D7C EA9A 3804            12      JR  C,EADR2
001D7E EA9C 87               4      ADD A,A
001D7F EA9D 29              11      ADD HL,HL
001D80 EA9E 18F8            12      JR  EADR1
       EAA0                     EADR2:
001D82 EAA0 DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001D85 EAA3 DD460C          19      LD  B,(IX+DPB_MAXCYL)
001D88 EAA6 09              11      ADD HL,BC
001D89 EAA7 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001D8C EAAA ED71            12      OUT (C),0       ;Z80未定義命令
001D8E EAAC 0C               4      INC C
001D8F EAAD ED69            12      OUT (C),L
001D91 EAAF 0C               4      INC C
001D92 EAB0 ED61            12      OUT (C),H
001D94 EAB2 0C               4      INC C
001D95 EAB3 EB               4      EX  DE,HL
001D96 EAB4 D1              10      POP DE
001D97 EAB5 C9              10      RET
                                
                                ;   CMOS BACKUP MEMORY DRIVER(32KB)
                                ;   1セクタ256
                                
       EAB6                     CDWT:
001D98 EAB6 78               4      LD  A,B
001D99 EAB7 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001D9C EABA ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001D9E EABC ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001DA0 EABE 01FA00          10      LD  BC,000FAH
       EAC1                     CDWT1:
001DA3 EAC1 EDB3                    OTIR            ;W)データ書き込み・アドレスカウンタ+1
001DA5 EAC3 13               6      INC DE
001DA6 EAC4 3D               4      DEC A
001DA7 EAC5 20FA            12      JR  NZ,CDWT1
001DA9 EAC7 A7               4      AND A
001DAA EAC8 C9              10      RET
                                
       EAC9                     CDRD:
001DAB EAC9 78               4      LD  A,B
001DAC EACA DD4E13          19      LD  C,(IX+DPB_UNITNO)
001DAF EACD ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001DB1 EACF ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001DB3 EAD1 01F900          10      LD  BC,000F9H
       EAD4                     CDRD1:
001DB6 EAD4 EDB2                    INIR            ;R)データ読み出し・アドレスカウンタ+1
001DB8 EAD6 13               6      INC DE
001DB9 EAD7 3D               4      DEC A
001DBA EAD8 20FA            12      JR  NZ,CDRD1
001DBC EADA A7               4      AND A
001DBD EADB C9              10      RET
                                
                                ;   RAM DISK DRIVER (64KB)
                                ;   1セクタ256
                                
       EADC                     RDWT:
001DBE EADC 3EB3             7      LD  A,0B3H      ;OTIR
001DC0 EADE 1802            12      JR  RDRW
       EAE0                     RDRD:
001DC2 EAE0 3EB2             7      LD  A,0B2H      ;INIR
       EAE2                     RDRW:
001DC4 EAE2 32EFEA          13      LD  (RDRW_SWC),A
                                
001DC7 EAE5 78               4      LD  A,B
001DC8 EAE6 43               4      LD  B,E     ;B=アドレスカウンタ上位(X1の様な16bitのI/Oアクセス)
001DC9 EAE7 0EEB             7      LD  C,0EBH
001DCB EAE9 ED71            12      OUT (C),0       ;0=アドレスカウンタ下位
001DCD EAEB 0D               4      DEC C       ;EA(R)データ読み出し・アドレスカウンタ+1
001DCE EAEC 0600             7      LD  B,0
       EAEE                     RDRW1:
001DD0 EAEE EDB2                    INIR            ;自己書き換え(INIR/OTIR)
       EAEF                     RDRW_SWC    EQU $-1
001DD2 EAF0 13               6      INC DE
001DD3 EAF1 3D               4      DEC A
001DD4 EAF2 20FA            12      JR  NZ,RDRW1
001DD6 EAF4 A7               4      AND A
001DD7 EAF5 C9              10      RET
                                
                                ;   G-RAM(PCG) DISK DRIVER (24KB)
                                ;   1セクタ256
                                
       EAF6                     GDWT:
001DD8 EAF6 C5              11      PUSH    BC
001DD9 EAF7 D5              11      PUSH    DE
001DDA EAF8 CD20EB          17      CALL    GADR
       EAFB                     GDWT2:
001DDD EAFB 4E               7      LD  C,(HL)
001DDE EAFC 23               6      INC HL
001DDF EAFD EB               4      EX  DE,HL   ;HL=PCG,DE=メモリ
001DE0 EAFE CDD3CF          17      CALL    WR_PCG
001DE3 EB01 23               6      INC HL
001DE4 EB02 EB               4      EX  DE,HL   ;HL=メモリ,DE=PCG
001DE5 EB03 10F6            13      DJNZ    GDWT2
001DE7 EB05 D1              10      POP DE
001DE8 EB06 1C               4      INC E
001DE9 EB07 C1              10      POP BC
001DEA EB08 10EC            13      DJNZ    GDWT
001DEC EB0A C9              10      RET
       EB0B                     GDRD:
001DED EB0B C5              11      PUSH    BC
001DEE EB0C D5              11      PUSH    DE
001DEF EB0D CD20EB          17      CALL    GADR
       EB10                     GDRD2:
001DF2 EB10 EB               4      EX  DE,HL   ;HL=PCG,DE=メモリ
001DF3 EB11 CDCBCF          17      CALL    RD_PCG
001DF6 EB14 23               6      INC HL
001DF7 EB15 EB               4      EX  DE,HL   ;HL=メモリ,DE=PCG
001DF8 EB16 71               7      LD  (HL),C
001DF9 EB17 23               6      INC HL
001DFA EB18 10F6            13      DJNZ    GDRD2
001DFC EB1A D1              10      POP DE
001DFD EB1B 1C               4      INC E
001DFE EB1C C1              10      POP BC
001DFF EB1D 10EC            13      DJNZ    GDRD
001E01 EB1F C9              10      RET
                                
       EB20                     GADR:
001E02 EB20 7B               4      LD  A,E
001E03 EB21 E61F             7      AND 01FH
001E05 EB23 C6D0             7      ADD A,0D0H
001E07 EB25 57               4      LD  D,A
001E08 EB26 7B               4      LD  A,E
001E09 EB27 07               4      RLCA
001E0A EB28 07               4      RLCA
001E0B EB29 07               4      RLCA
001E0C EB2A 3C               4      INC A
001E0D EB2B 0600             7      LD  B,0
001E0F EB2D 58               4      LD  E,B
001E10 EB2E C9              10      RET
[EOF:M7DISK2.ASM:UTF_8]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
001E11 EB2F                     PATHD:  DS  PATHX
001E4C EB6A 00                  PATHE:  DB  0
                                
       EB6B                     DTA_CCP:
001E4D EB6B                         DS  37
                                
       EB90                     FCB_BAT:
001E72 EB90                         DS  37
                                
001E97 EBB5 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
001EA2 EBC0 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "M7TABLE.ASM"
                                
                                ;   LSX-Dodgers TABLE 表示関連のテーブル
                                ;   MZ-700/1500
                                
       EBC7                     AT_TABLE:
001EA9 EBC7                         DS  TABLEAD-AT_TABLE
                                
       ED40                     KEY_TABLE:
002022 ED40 12081E1F1C1D5C2F        DB  12H,08H,1EH,1FH,1CH,1DH,5CH,'/'
00202A ED48 5C5E2D2030392C2E        DB  5CH,'^','-',20H,'0','9',',','.'
002032 ED50 3132333435363738        DB  '1','2','3','4','5','6','7','8'
00203A ED58 6162636465666768        DB  'a','b','c','d','e','f','g','h'
002042 ED60 696A6B6C6D6E6F70        DB  'i','j','k','l','m','n','o','p'
00204A ED68 7172737475767778        DB  'q','r','s','t','u','v','w','x'
002052 ED70 797A405B5D000000        DB  'y','z','@','[',']',00H,00H,00H
00205A ED78 001B3D09003B3A0D        DB  00H,1BH,'=',09H,00H,';',':',0DH
       ED80                     SHIFT_TABLE:
002062 ED80 12081E1F1C1D5F3F        DB  12H,08H,1EH,1FH,1CH,1DH,'_','?'
00206A ED88 7C7E3D2030293C3E        DB  '|','~','=',20H,'0',')','<','>'
002072 ED90 2122232425262728        DB  '!','"','#','$','%','&',27H,'('
00207A ED98 4142434445464748        DB  'A','B','C','D','E','F','G','H'
002082 EDA0 494A4B4C4D4E4F50        DB  'I','J','K','L','M','N','O','P'
00208A EDA8 5152535455565758        DB  'Q','R','S','T','U','V','W','X'
002092 EDB0 595A607B7D000000        DB  'Y','Z','`','{','}',00H,00H,00H
00209A EDB8 00003D09002B2A0D        DB  00H,00H,'=',09H,00H,'+','*',0DH
       EDC0                     CTRL_TABLE:
0020A2 EDC0 12081E1F1C1D3F2F        DB  12H,08H,1EH,1FH,1CH,1DH,'?','/'
0020AA EDC8 2A2B2D2030392C2E        DB  '*','+','-',20H,'0','9',',','.'
0020B2 EDD0 3132333435363738        DB  '1','2','3','4','5','6','7','8'
0020BA EDD8 0102030405060708        DB  01H,02H,03H,04H,05H,06H,07H,08H
0020C2 EDE0 090A0B0C0D0E0F10        DB  09H,0AH,0BH,0CH,0DH,0EH,0FH,10H
0020CA EDE8 1112131415161718        DB  11H,12H,13H,14H,15H,16H,17H,18H
0020D2 EDF0 191A1B5B5D000000        DB  19H,1AH,1BH,'[',']',00H,00H,00H
0020DA EDF8 00003D09003B3A0D        DB  00H,00H,'=',09H,00H,';',':',0DH
                                
                                ;   アドレス下位1バイトが0になるように
       EE00                     CD_TABLE:
0020E2 EE00 00D1D2D3D4D5D6D0        DB  $00,$D1,$D2,$D3,$D4,$D5,$D6,$D0 ;月火水木金土日
0020EA EE08 D8DCD9DADBD7CFCE        DB  $D8,$DC,$D9,$DA,$DB,$D7,$CF,$CE ;年円時分秒
0020F2 EE10 601F5F5E1E1B7978        DB  $60,$1F,$5F,$5E,$1E,$1B,$79,$78 ;
0020FA EE18 5C5D1C1D6DCACDC7        DB  $5C,$5D,$1C,$1D,$6D,$CA,$CD,$C7 ;
002102 EE20 0061626364656667        DB  $00,$61,$62,$63,$64,$65,$66,$67 ; !"#$%&'
00210A EE28 68696B6A2F2A2E2D        DB  $68,$69,$6B,$6A,$2F,$2A,$2E,$2D ;()*+,-./
002112 EE30 2021222324252627        DB  $20,$21,$22,$23,$24,$25,$26,$27 ;01234567
00211A EE38 28294F2C512B5749        DB  $28,$29,$4F,$2C,$51,$2B,$57,$49 ;89:;<=>?
002122 EE40 5501020304050607        DB  $55,$01,$02,$03,$04,$05,$06,$07 ;@ABCDEFG
00212A EE48 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;HIJKLMNO
002132 EE50 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;PQRSTUVW
00213A EE58 18191A52DD54E37C        DB  $18,$19,$1A,$52,$DD,$54,$E3,$7C ;XYZ[\]^_
002142 EE60 5901020304050607        DB  $59,$01,$02,$03,$04,$05,$06,$07 ;`abcdefg   ATB:1
00214A EE68 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;hijklmno   ATB:1
002152 EE70 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;pqrstuvw   ATB:1
00215A EE78 18191ACB35CC705A        DB  $18,$19,$1A,$CB,$35,$CC,$70,$5A ;xyz{|}~    ATB:1
002162 EE80 415346444847B49E        DB  $41,$53,$46,$44,$48,$47,$B4,$9E ;トランプ〇●をぁ   ATB:1
00216A EE88 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ぃぅぇぉゃゅょっ   ATB:1
002172 EE90 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーあいうえおかき   ATB:1
00217A EE98 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;くけこさしすせそ   ATB:1
002182 EEA0 F0BD9DB1B5B9B49E        DB  $F0,$BD,$9D,$B1,$B5,$B9,$B4,$9E ;　。「」、・ヲァ
00218A EEA8 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ィゥェォャョュッ
002192 EEB0 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーアイウエオカキ
00219A EEB8 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;クケコサシスセソ
0021A2 EEC0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;タチツテトナニヌ
0021AA EEC8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ネノハヒフヘホマ
0021B2 EED0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;ミムメモヤユヨラ
0021BA EED8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;リルレロワン゛゜
0021C2 EEE0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;たちつてとねにぬ   ATB:1
0021CA EEE8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ねのはひふへほま   ATB:1
0021D2 EEF0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;みむめもやゆよら   ATB:1
0021DA EEF8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;りるれろわん゛゜   ATB:1
       EF00                     DC_TABLE:
0021E2 EF00 2041424344454647        DB  $20,$41,$42,$43,$44,$45,$46,$47 ;0
0021EA EF08 48494A4B4C4D4E4F        DB  $48,$49,$4A,$4B,$4C,$4D,$4E,$4F
0021F2 EF10 5051525354555657        DB  $50,$51,$52,$53,$54,$55,$56,$57 ;1
0021FA EF18 58595A151A1B1411        DB  $58,$59,$5A,$15,$1A,$1B,$14,$11
002202 EF20 3031323334353637        DB  $30,$31,$32,$33,$34,$35,$36,$37 ;2
00220A EF28 38392D3D3B2F2E2C        DB  $38,$39,$2D,$3D,$3B,$2F,$2E,$2C
002212 EF30 00000000007C0000        DB  $00,$00,$00,$00,$00,$7C,$00,$00 ;3
00221A EF38 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
002222 EF40 0080000083008285        DB  $00,$80,$00,$00,$83,$00,$82,$85 ;4
00222A EF48 843F00000000003A        DB  $84,$3F,$00,$00,$00,$00,$00,$3A
002232 EF50 5E3C5B815D40003E        DB  $5E,$3C,$5B,$81,$5D,$40,$00,$3E ;5
00223A EF58 00607F0018191312        DB  $00,$60,$7F,$00,$18,$19,$13,$12
002242 EF60 1021222324252627        DB  $10,$21,$22,$23,$24,$25,$26,$27 ;6
00224A EF68 28292B2A001C0000        DB  $28,$29,$2B,$2A,$00,$1C,$00,$00
002252 EF70 7E00000000000000        DB  $7E,$00,$00,$00,$00,$00,$00,$00 ;7
00225A EF78 171600005F000000        DB  $17,$16,$00,$00,$5F,$00,$00,$00
002262 EF80 00C19A9F9C92CA97        DB  $00,$C1,$9A,$9F,$9C,$92,$CA,$97 ;8
00226A EF88 98C6CFC9D8D3D0D7        DB  $98,$C6,$CF,$C9,$D8,$D3,$D0,$D7
002272 EF90 9EC09DC496C5CBC3        DB  $9E,$C0,$9D,$C4,$96,$C5,$CB,$C3 ;9
00227A EF98 9BDDC2DB99A2878C        DB  $9B,$DD,$C2,$DB,$99,$A2,$87,$8C
002282 EFA0 DCC7CC91939495D4        DB  $DC,$C7,$CC,$91,$93,$94,$95,$D4 ;A
00228A EFA8 D5D6CECDDAD2D9C8        DB  $D5,$D6,$CE,$CD,$DA,$D2,$D9,$C8
002292 EFB0 D1A3888D86A4898E        DB  $D1,$A3,$88,$8D,$86,$A4,$89,$8E ;B
00229A EFB8 DFA58A8FDEA18B90        DB  $DF,$A5,$8A,$8F,$DE,$A1,$8B,$90
0022A2 EFC0 000000000000001F        DB  $00,$00,$00,$00,$00,$00,$00,$1F ;C
0022AA EFC8 00001D7B7D1E0F0E        DB  $00,$00,$1D,$7B,$7D,$1E,$0F,$0E
0022B2 EFD0 070102030405060D        DB  $07,$01,$02,$03,$04,$05,$06,$0D ;D
0022BA EFD8 080A0B0C095C0000        DB  $08,$0A,$0B,$0C,$09,$5C,$00,$00
0022C2 EFE0 0000005E00000000        DB  $00,$00,$00,$5E,$00,$00,$00,$00 ;E
0022CA EFE8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
0022D2 EFF0 A000000000000000        DB  $A0,$00,$00,$00,$00,$00,$00,$00 ;F
0022DA EFF8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
[EOF:M7TABLE.ASM:SHIFT_JIS]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
                                ;   ALIGN   256
       F000                     AT_WORK:
0022E2 F000                         DS  WORKAD-AT_WORK
                                
       F000                     CPM_BOOT:
0022E2 F000 C30000          10      JP  0
       F003                     _SYS00:     ;(BDOS)プログラム終了
       F003                     CPM_WBOOT:
0022E5 F003 C3FECF          10      JP  WBOOT1
       F006                     CPM_CONST:
0022E8 F006 C30DD8          10      JP  CONSTX
       F009                     _SYS07:     ;(BDOS)コンソール直接入力
       F009                     CPM_CONIN:
0022EB F009 C3A3D7          10      JP  FLGET
       F00C                     CPM_CONOUT:
0022EE F00C C3B1D9          10      JP  CONOUT1
                                
       F00F                     DECBF:              ;10進数表示時のバッファ(5バイト)
0022F1 F00F                         DS  5
       F00F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       F011                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
       F014                     FDRV:
0022F6 F014 00                      DB  0
       F015                     FNAME:
0022F7 F015                         DS  36
       F039                     SFILE:
00231B F039                         DS  33      ;DRV FILENAME
       F05A                     _DISKE:
00233C F05A C30CD7          10      JP  SHOW_ERROR
                                
00233F F05D 0000                LEFTX:  DW  0
002341 F05F 0000                DTAX:   DW  0
                                
                                ;   PSGのビープ音のデータ(X1)
       F061                     BEEPD:
002343 F061 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
00234B F069 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
                                ;
       F062                     RTC_YY  EQU BEEPD+1 ;RTCのバッファ年(88)
       F063                     RTC_MW  EQU BEEPD+2 ;RTCのバッファ月(88)
       F064                     RTC_DD  EQU BEEPD+3 ;RTCのバッファ日(88)
       F065                     RTC_TT  EQU BEEPD+4 ;RTCのバッファ時(88)
       F066                     RTC_MM  EQU BEEPD+5 ;RTCのバッファ分(88)
       F067                     RTC_SS  EQU BEEPD+6 ;RTCのバッファ秒(88)
       F062                     ROM_SLT EQU BEEPD+1 ;ROMのスロット(MSX)
       F061                     ZERO    EQU BEEPD
                                
       F070                     CHECK:
002352 F070 00                      DB  0
                                
       F071                     OK:
002353 F071 4F4B24                  DB  "OK$"
002356 F074                         DS  5
       F079                     COMERM:
00235B F079 4572726F722124          DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
       F080                     _CYL0:
002362 F080 FF                      DB  0FFH    ;Cylinder
       F081                     _CYL1:
002363 F081 FF                      DB  0FFH    ;Cylinder
       F082                     _CYL2:
002364 F082 FF                      DB  0FFH    ;Cylinder
       F083                     _CYL3:
002365 F083 FF                      DB  0FFH    ;Cylinder
       F084                     _DRIVE:
002366 F084 00                      DB  0   ;unit number
       F085                     _SEEKSP:
002367 F085 00                      DB  0   ;Seek speed
       F086                     _ISEEK:
002368 F086 32                      DB  50  ;
002369 F087                         DS  1
       F088                     _DRV:
00236A F088 00                      DB  0
       F089                     _DSK:
00236B F089 FF                      DB  0FFH
       F08A                     _DTA:
00236C F08A 8000                    DW  00080H
       F08C                     _CTC:
00236E F08C 0000                    DW  0
       F08E                     _TXADR:
002370 F08E 0000                    DW  0
       F090                     _KEYPS:
002372 F090 0000                    DW  0
       F092                     _KEYD:
002374 F092 00                      DB  000H    ;キーデータ
       F093                     _KEYST:
002375 F093 FF                      DB  0FFH    ;キーステータス(SHIFT,CTRLの状態)
       F094                     _KEYSP_L:
002376 F094 83                      DB  KEYSP_L ;オートリピートの速度
       F095                     _KEYSP_H:
002377 F095 14                      DB  KEYSP_H ;オートリピートの速度
       F096                     _COLORF:
002378 F096 70                      DB  COLORF  ;色
       F097                     _LINE:
002379 F097 19                      DB  LINE
                                
                                            ;次のファイルの検索(C=12)で使用するFCB
       F098                     _FCB:
00237A F098 0000                    DW  0   ;SEARCH FILES
       F09A                     _FBPS:
00237C F09A 0000                    DW  0   ;    //
       F09C                     _FBAD:
00237E F09C 0000                    DW  0   ;    //
       F09E                     _FBCNT:
002380 F09E 00                      DB  0   ;    //
       F09F                     _FILEN:
002381 F09F 00                      DB  0   ;    //
       F0A0                     _DIRF:
002382 F0A0 00                      DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
002383 F0A1                         DS  1
       F0A2                     _WTFATF:
002384 F0A2 00                      DB  0   ;FATバッファの更新フラグ
002385 F0A3                         DS  1
       F0A4                     _WTDBF:
002386 F0A4 00                      DB  0   ;データバッファの更新フラグ
       F0A5                     _DBDRV:
002387 F0A5 FF                      DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
       F0A6                     _DBSEC:
002388 F0A6 0000                    DW  0   ;データバッファにあるデータを読み込んだセクタ番号
       F0A8                     _DPB:
00238A F0A8 0000                    DW  0
       F0AA                     _FATDRV:
00238C F0AA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
       F0AB                     _FATIX:
00238D F0AB 00                      DB  0   ;FATバッファに読み込んでいるインデックス
       F0AC                     _FAKEFREE:
00238E F0AC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
002390 F0AE                         DS  2
                                ;   画面周りのデータ
       F0B0                     CRTCD:
002392 F0B0 6F                      DB  06FH
       F0B1                     _WIDTH:
002393 F0B1 28                      DB  WIDTH
       F0B2                     TVRAMTOP:
002394 F0B2 5938                    DB  059H,038H
002396 F0B4 1F02                    DB  01FH,002H
       F0B6                     _LINE2:
002398 F0B6 19                      DB  019H
       F0B7                     WKE4:
002399 F0B7 1C                      DB  01CH
       F0B8                     WKE6:
00239A F0B8 00                      DB  000H
       F0B9                     WK40:
00239B F0B9 07                      DB  007H
       F0BA                     _PAGE_MINUS:
00239C F0BA 18FC                    DW  0-WIDTH*LINE
       F0BC                     _WIDTH_MINUS:
00239E F0BC D8FF                    DW  0-WIDTH
       F0BE                     WK30:
0023A0 F0BE 0C                      DB  00CH
       F0BF                     WK31:
       F0BF                     WK1FD0:
0023A1 F0BF 20                      DB  020H
                                
                                ;   割り込みベクタ(X1)
0023A2 F0C0 0000                CTC0:   DW  INTCTCE
0023A4 F0C2 0000                CTC1:   DW  INTCTCE
0023A6 F0C4 0000                CTC2:   DW  INTCTCE
0023A8 F0C6 0000                CTC3:   DW  INTCTCE
0023AA F0C8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
0023AC F0CA C3FADA          10  _INKEY: JP  INKEY
0023AF F0CD C398D8          10  _PRINT: JP  PRINT
0023B2 F0D0 C36CDB          10  _SCRN:  JP  SCRN
0023B5 F0D3 C36ADA          10  _POS:   JP  POS
0023B8 F0D6 C37FD9          10  _LOC:   JP  LOC
       F0D9                     _CHGDRV:
0023BB F0D9 C318E8          10      JP  CHGDRV
       F0DC                     _GETDPB:
0023BE F0DC C3D6E8          10      JP  GETDPB
       F0DF                     _FFLUSH:
0023C1 F0DF C3F4E8          10      JP  FFLUSH
       F0E2                     _RDFATX:
0023C4 F0E2 C3F2E4          10      JP  RDFATX
0023C7 F0E5 C324E6          10  _RDFAT: JP  RDFAT
0023CA F0E8 C3AFE9          10  _WTTRK: JP  WTTRK
0023CD F0EB C30CEA          10  _FDRD:  JP  FDRD
0023D0 F0EE C3B5E9          10  _FDWT:  JP  FDWT
       F0F1                     _BPB2DPB:
0023D3 F0F1 C3BAE6          10      JP  BPB2DPB
       F0F4                     _BREAK:
0023D6 F0F4 C390D1          10      JP  END_BATCH
       F0F7                     _GNCL:
0023D9 F0F7 C39EE5          10      JP  GNCL        ; self-modifying code
       F0F8                     GNCPAT  EQU $-2
       F0FA                     _SNCL:
0023DC F0FA C3C1E5          10      JP  SNCL        ; self-modifying code
       F0FB                     SNCPAT  EQU $-2
       F0FD                     _COMANL:
0023DF F0FD C349D0          10      JP  COMANL
                                
       F100                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       F100                     STABLE:
                                ;0
0023E2 F100 03F076D782D75CDD        DW  _SYS00,_SYS01,_SYS02,_SYS03
0023EA F108 77D477D487D709F0        DW  _SYS04,_SYS05,_SYS06,_SYS07
0023F2 F110 8FD779D4D9D705D8        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
0023FA F118 8ED493D4A2D4B3D4        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
002402 F120 07D54ED597D5C8D5        DW  _SYS10,_SYS11,_SYS12,_SYS13
00240A F128 D0D5E6D5FBD5F3D5        DW  _SYS14,_SYS15,_SYS16,_SYS17
002412 F130 42D647D64CD652D6        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
00241A F138 77D478D677D47CD6        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
002422 F140 77D432D63AD683D6        DW  _SYS20,_SYS21,_SYS22,_SYS23
00242A F148 A8D677D4B2E180E2        DW  _SYS24,_ERROR,_SYS26,_SYS27
002432 F150 3AD6B2D61BD85CDD        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
00243A F158 1BD85CDD77D4D3D6        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
002442 F160 CDD677D477D477D4        DW  _SYS30,_ERROR,_ERROR,_ERROR
00244A F168 77D477D477D477D4        DW  _ERROR,_ERROR,_ERROR,_ERROR
002452 F170 77D45CDD5CDDF4D6        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
00245A F178 5AD4                    DW  _DOS2
                                
00245C F17A                         DS  1
       F17B                     _MAX_SEC_SZ_H:
00245D F17B 04                      DB  MAX_SEC_SZ_H
                                
                                ;   FATバッファのアドレス
       F17C                     _FATBF:
00245E F17C 30F3                    DW  FATBF
                                
                                ;   データバッファのアドレス
       F17E                     _DTBUF:
002460 F17E 30FB                    DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       F180                     CTRLTB:
002462 F180 FDD8FDD833D93DDA        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
00246A F188 37DA64D928DAC1D9        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
002472 F190 09D924D940DA92D9        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
00247A F198 25DA7AD952DAFDD8        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
002482 F1A0 FDD8FDD88AD9FDD8        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
00248A F1A8 FDD8FDD8FDD8FDD8        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
002492 F1B0 FDD8FDD825DA99D9        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
00249A F1B8 ECD810D919D940DA        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
                                ;   2D/2DDでBPBがない場合のデフォルト値(2D/360KB/9セクタ1024バイト)
0024A2 F1C0 0200                M2D:    DW  2
0024A4 F1C2 FD02                    DB  0FDH,2
0024A6 F1C4 6401                    DW  356
0024A8 F1C6 FF0728090182            DB  0FFH,7,40,9,1,082H
0024AE F1CC 0500A7000800            DW  5,0A7H,8
                                
                                ;   2HDでBPBがない場合のデフォルト値(2HD/1.23MB/8セクタ1024バイト)
0024B4 F1D2 0200                M2HD:   DW  2
0024B6 F1D4 FE01                    DB  0FEH,1
0024B8 F1D6 C704                    DW  1223
0024BA F1D8 FE064D080184            DB  0FEH,6,77,8,1,084H
0024C0 F1DE 0500A7000900            DW  5,0A7H,9
                                
                                ;   ディレクトリエントリとFCBの変換テーブル(日付+時刻+サイズ)
0024C6 F1E4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
0024C8 F1E6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
0024CA F1E8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
0024CC F1EA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       F1EE                     SDDATAE:
                                
0024D0 F1EE                         DS  2
                                
                                ;   バッチファイルのFCB
       F1F0                     _FCB_BAT:
0024D2 F1F0 90EB                    DW  FCB_BAT
       F1F2                     _PATH:
0024D4 F1F2 2FEB                    DW  PATHD
                                
0024D6 F1F4                     SCDIR:  DS  2       ;+14 +15
0024D8 F1F6                     SFBPS:  DS  2       ;FBPS
0024DA F1F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
0024DC F1FA 0000                _FATPS: DW  0
0024DE F1FC 0000                _DIRPS: DW  0
0024E0 F1FE 0000                _CLPS:  DW  0
                                
       F200                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "M7DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   MZ-700/1500
                                
       F200                     _DEVICE:
                                
                                ;   A:
                                
0024E2 F200 0200                    DW  2   ;DPB_FATLN
0024E4 F202 EBF0                    DW  _FDRD   ;DPB_DRD
0024E6 F204 EEF0                    DW  _FDWT   ;DPB_DWT
0024E8 F206 FD                      DB  0FDH    ;DPB_FATID
0024E9 F207 02                      DB  2   ;DPB_SECPCL
0024EA F208 6401                    DW  356 ;DPB_MAXCL
0024EC F20A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
0024ED F20B 07                      DB  7   ;DPB_DIRSCNT
0024EE F20C 28                      DB  40  ;DPB_MAXCYL
0024EF F20D 09                      DB  9   ;DPB_MAXSEC Number of sectors
0024F0 F20E 01                      DB  1   ;DPB_FATPS
0024F1 F20F 82                      DB  082H    ;DPB_BPS
0024F2 F210 0500                    DW  5   ;DPB_DIRPS
0024F4 F212 27                      DB  027H    ;DPB_DEVICE Device Number
0024F5 F213 00                      DB  0   ;DPB_UNITNO
0024F6 F214 0800                    DW  8   ;DPB_ADDCL
0024F8 F216 0000                    DW  0   ;DPB_16
0024FA F218 0000                    DW  0   ;DPB_18
0024FC F21A 0000                    DW  0   ;DPB_SDIR
0024FE F21C 46444430                DB  "FDD0"  ;DPB_NAME
                                
                                ;   B:
                                
002502 F220 0200                    DW  2   ;DPB_FATLN
002504 F222 EBF0                    DW  _FDRD   ;DPB_DRD
002506 F224 EEF0                    DW  _FDWT   ;DPB_DWT
002508 F226 FD                      DB  0FDH    ;DPB_FATID
002509 F227 02                      DB  2   ;DPB_SECPCL
00250A F228 6401                    DW  356 ;DPB_MAXCL
00250C F22A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
00250D F22B 07                      DB  7   ;DPB_DIRSCNT
00250E F22C 28                      DB  40  ;DPB_MAXCYL
00250F F22D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002510 F22E 01                      DB  1   ;DPB_FATPS
002511 F22F 82                      DB  082H    ;DPB_BPS
002512 F230 0500                    DW  5   ;DPB_DIRPS
002514 F232 27                      DB  027H    ;DPB_DEVICE Device Number
002515 F233 01                      DB  1   ;DPB_UNITNO
002516 F234 0800                    DW  8   ;DPB_ADDCL
002518 F236 0000                    DW  0   ;DPB_16
00251A F238 0000                    DW  0   ;DPB_18
00251C F23A 0000                    DW  0   ;DPB_SDIR
00251E F23C 46444431                DB  "FDD1"  ;DPB_NAME
                                
                                ;   C:
                                
002522 F240 0100                    DW  1   ;DPB_FATLN
002524 F242 C9EA                    DW  CDRD    ;DPB_DRD
002526 F244 B6EA                    DW  CDWT    ;DPB_DWT
002528 F246 FA                      DB  0FAH    ;DPB_FATID
002529 F247 01                      DB  1   ;DPB_SECPCL
00252A F248 7A00                    DW  122 ;DPB_MAXCL
00252C F24A 00                      DB  0   ;DPB_FDMODE
00252D F24B 06                      DB  6   ;DPB_DIRSCNT
00252E F24C 00                      DB  0   ;DPB_MAXCYL
00252F F24D 00                      DB  0   ;DPB_MAXSEC
002530 F24E 01                      DB  1   ;DPB_FATPS
002531 F24F 01                      DB  1   ;DPB_BPS
002532 F250 0200                    DW  2   ;DPB_DIRPS
002534 F252 0C                      DB  00CH    ;DPB_DEVICE
002535 F253 F8                      DB  0F8H    ;DPB_UNITNO
002536 F254 0600                    DW  6   ;DPB_ADDCL
002538 F256 0000                    DW  0   ;DPB_16
00253A F258 0000                    DW  0   ;DPB_18
00253C F25A 0000                    DW  0   ;DPB_SDIR
00253E F25C 434D4F53                DB  "CMOS"  ;DPB_NAME
                                
                                ;   D:
                                
002542 F260                         DS  32
                                
                                ;   E:
                                
       F280                     EMMFL:
002562 F280 0000                    DW  0   ;DPB_FATLN
002564 F282 80EA                    DW  EDRD    ;DPB_DRD
002566 F284 73EA                    DW  EDWT    ;DPB_DWT
002568 F286 FA                      DB  0FAH    ;DPB_FATID
002569 F287 02                      DB  2   ;DPB_SECPCL
00256A F288 0000                    DW  0   ;DPB_MAXCL
00256C F28A 00                      DB  0   ;DPB_FDMODE
00256D F28B 10                      DB  16  ;DPB_DIRSCNT
00256E F28C 00                      DB  0   ;DPB_MAXCYL
00256F F28D 00                      DB  0   ;DPB_MAXSEC
002570 F28E 01                      DB  1   ;DPB_FATPS
002571 F28F 01                      DB  1   ;DPB_BPS
002572 F290 0000                    DW  0   ;DPB_DIRPS
002574 F292 26                      DB  026H    ;DPB_DEVICE
002575 F293 00                      DB  0   ;DPB_UNITNO
002576 F294 0000                    DW  0   ;DPB_ADDCL
002578 F296 0000                    DW  0   ;DPB_16
00257A F298 0000                    DW  0   ;DPB_18
00257C F29A 0000                    DW  0   ;DPB_SDIR
00257E F29C 454D4D30                DB  "EMM0"  ;DPB_NAME
                                
                                ;   F:
                                
002582 F2A0 0200                    DW  2   ;DPB_FATLN
002584 F2A2 E0EA                    DW  RDRD    ;DPB_DRD
002586 F2A4 DCEA                    DW  RDWT    ;DPB_DWT
002588 F2A6 FA                      DB  0FAH    ;DPB_FATID
002589 F2A7 01                      DB  1   ;DPB_SECPCL
00258A F2A8 F600                    DW  246 ;DPB_MAXCL
00258C F2AA 00                      DB  0   ;DPB_FDMODE
00258D F2AB 09                      DB  9   ;DPB_DIRSCNT
00258E F2AC 00                      DB  0   ;DPB_MAXCYL
00258F F2AD 00                      DB  0   ;DPB_MAXSEC
002590 F2AE 01                      DB  1   ;DPB_FATPS
002591 F2AF 01                      DB  1   ;DPB_BPS
002592 F2B0 0300                    DW  3   ;DPB_DIRPS
002594 F2B2 0F                      DB  00FH    ;DPB_DEVICE
002595 F2B3 00                      DB  0   ;DPB_UNITNO
002596 F2B4 0A00                    DW  10  ;DPB_ADDCL
002598 F2B6 0000                    DW  0   ;DPB_16
00259A F2B8 0000                    DW  0   ;DPB_18
00259C F2BA 0000                    DW  0   ;DPB_SDIR
00259E F2BC 52414D46                DB  "RAMF"  ;DPB_NAME
                                
                                ;   G:
       F2C0                     GRAMFL:
0025A2 F2C0 0100                    DW  1   ;DPB_FATLN
0025A4 F2C2 0BEB                    DW  GDRD    ;DPB_DRD
0025A6 F2C4 F6EA                    DW  GDWT    ;DPB_DWT
0025A8 F2C6 FA                      DB  0FAH    ;DPB_FATID
0025A9 F2C7 01                      DB  1   ;DPB_SECPCL
0025AA F2C8 5A00                    DW  90  ;DPB_MAXCL
0025AC F2CA 00                      DB  0   ;DPB_FDMODE
0025AD F2CB 06                      DB  6   ;DPB_DIRSCNT
0025AE F2CC 00                      DB  0   ;DPB_MAXCYL
0025AF F2CD 00                      DB  0   ;DPB_MAXSEC
0025B0 F2CE 01                      DB  1   ;DPB_FATPS
0025B1 F2CF 01                      DB  1   ;DPB_BPS
0025B2 F2D0 0200                    DW  2   ;DPB_DIRPS
0025B4 F2D2 05                      DB  005H    ;DPB_DEVICE
0025B5 F2D3 F8                      DB  0F8H    ;DPB_UNITNO
0025B6 F2D4 0600                    DW  6   ;DPB_ADDCL
0025B8 F2D6 0000                    DW  0   ;DPB_16
0025BA F2D8 0000                    DW  0   ;DPB_18
0025BC F2DA 0000                    DW  0   ;DPB_SDIR
0025BE F2DC 4752414D                DB  "GRAM"  ;DPB_NAME
                                
                                ;   H:
0025C2 F2E0                         DS  3
0025C5 F2E3 00                      DB  0
[EOF:M7DPB.ASM:UTF_8]
                                
       A5C6                     LAST_ADR    EQU $$+OFFSET
                                
                                    END
[EOF:M7.ASM:UTF_8]
