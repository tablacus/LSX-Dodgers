                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.13.0, LST:Full:4
                                ;   LSX-Dodgers for MZ-700/1500
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "M7DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MZ-700/1500
                                
       0001                     MAC EQU 1   ;MZ-700/1500
       0000                     DEV EQU 0
                                
       011D                     VER_6F  EQU 0011DH
                                
       8080                     RUN EQU 08080H
       8000                     OFFSET  EQU RUN-128
       CF06                     BDOS    EQU 0CF06H
       ED40                     TABLEAD EQU 0ED40H
       F000                     WORKAD  EQU 0F000H
       F330                     FATBF   EQU 0F330H
       FB30                     DTBUF   EQU 0FB30H
       FF30                     KBUF    EQU 0FF30H
       FFD9                     TRAP38  EQU 0FFD9H
       0028                     WIDTH   EQU 40
       0019                     LINE    EQU 25
       0070                     COLORF  EQU 070H
       0010                     KEYSP_H EQU 16
       0083                     KEYSP_L EQU 131
       0009                     COMS    EQU 9
       0004                     MAX_SEC_SZ_H    EQU 4       ;1セクタ1024バイトのサポート(2:off 4:on)
       0100                     BUFFER  EQU 00100H
       D0E1                     S27BUF_COM  EQU S27BUF
[EOF:M7DEF.ASM:UTF_8]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0006                     VER_2   EQU 6
       0001                     VER_3   EQU 1
       1D01                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0001                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0161                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0004                     _DVSW   EQU 00004H
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       F323                     DISKVE  EQU 0F323H
       F325                     BREAKV  EQU 0F325H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 8000                         ORG OFFSET
                                                    ;MZTヘッダ128バイト
000000 8000 01                      DB  1           ;ファイルモード
000001 8001 4C44202020202020        DB  "LD           "     ;ファイル名(13)
            2020202020          
00000E 800E 535953                  DB  "SYS"           ;拡張子(3)
000011 8011 0D                      DB  $0D
000012 8012 3D25                    DW  LAST_ADR-RUN        ;サイズ
000014 8014 8080                    DW  RUN         ;開始アドレス
000016 8016 8080                    DW  RUN         ;実行アドレス
000018 8018                         DS  104
                                
                                    INCLUDE "M7INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   MZ-700/1500
                                
000080 8080 C38780          10      JP  START
000083 8083 011D                    DW  MACW
000085 8085 6101                    DW  VER
                                
       8087                     START:
000087 8087 F3               4      DI
000088 8088 ED56             8      IM  1
00008A 808A 318780          10      LD  SP,START
00008D 808D CD9B80          17      CALL    INIT        ;NZならAUTOEXECを実行
000090 8090 210000          10      LD  HL,0
000093 8093 E5              11      PUSH    HL
000094 8094 C8              11      RET Z
000095 8095 117981          10      LD  DE,AUTOD
000098 8098 C3FDF0          10      JP  _COMANL
                                
       809B                     INIT:
00009B 809B D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFFH)
00009D 809D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00009F 809F 21DF81          10      LD  HL,INITE
0000A2 80A2 1106CF          10      LD  DE,BDOS
0000A5 80A5 01DE23          10      LD  BC,LAST_ADR-INITE
0000A8 80A8 EDB0                    LDIR
0000AA 80AA 21B081          10      LD  HL,M7BEEPD
0000AD 80AD 1162F0          10      LD  DE,BEEPD+1
0000B0 80B0 010800          10      LD  BC,M7BEEPE-M7BEEPD
0000B3 80B3 EDB0                    LDIR
                                
0000B5 80B5 210000          10      LD  HL,0
0000B8 80B8 065C             7      LD  B,05CH
0000BA 80BA 3E                      DB  03EH    ;LD A,??
0000BB 80BB EF              12      RST 28H
0000BC 80BC CDF0DB          17      CALL    FILL_MEMORY
0000BF 80BF 06A4             7      LD  B,0A4H
0000C1 80C1 AF               4      XOR A
0000C2 80C2 320400          13      LD  (_DVSW),A
0000C5 80C5 CDF0DB          17      CALL    FILL_MEMORY
                                
0000C8 80C8 3EC3             7      LD  A,0C3H      ;JP
0000CA 80CA 2103F0          10      LD  HL,CPM_WBOOT
0000CD 80CD 320000          13      LD  (00000H),A
0000D0 80D0 220100          16      LD  (00001H),HL ;IPL
                                
0000D3 80D3 2106CF          10      LD  HL,BDOS
0000D6 80D6 320500          13      LD  (00005H),A
0000D9 80D9 220600          16      LD  (00006H),HL ;BDOS
                                
0000DC 80DC 21D9FF          10      LD  HL,TRAP38   ;TRAP38
0000DF 80DF 322800          13      LD  (00028H),A
0000E2 80E2 222900          16      LD  (00029H),HL ;RST 028H
                                
0000E5 80E5 323800          13      LD  (00038H),A
0000E8 80E8 211ACF          10      LD  HL,IO_INT8253
0000EB 80EB 223900          16      LD  (00039H),HL
                                
0000EE 80EE 215BF0          10      LD  HL,_DISKE+1
0000F1 80F1 2223F3          16      LD  (DISKVE),HL
0000F4 80F4 21F5F0          10      LD  HL,_BREAK+1
0000F7 80F7 2225F3          16      LD  (BREAKV),HL
                                
0000FA 80FA 3EF0             7      LD  A,CPM_BOOT/256
0000FC 80FC 320B00          13      LD  (0000BH),A
                                
0000FF 80FF 3EE9             7      LD  A,0E9H      ;JP (HL)
000101 8101 320F00          13      LD  (0000FH),A
                                                ;CHECK PCG(MZ-1500)
000104 8104 2100E8          10      LD  HL,0E800H
000107 8107 46               7      LD  B,(HL)
000108 8108 F3               4      DI
000109 8109 3E01             7      LD  A,1
00010B 810B D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00010D 810D 4E               7      LD  C,(HL)
00010E 810E 79               4      LD  A,C
00010F 810F C6A5             7      ADD A,0A5H
000111 8111 5F               4      LD  E,A
000112 8112 73               7      LD  (HL),E
000113 8113 D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
000115 8115 71               7      LD  (HL),C
000116 8116 3E01             7      LD  A,1
000118 8118 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00011A 811A 7E               7      LD  A,(HL)
00011B 811B BB               4      CP  E
00011C 811C D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
00011E 811E 70               7      LD  (HL),B
00011F 811F FB               4      EI
000120 8120 2804            12      JR  Z,MZ1500
000122 8122 AF               4      XOR A       ;MZ-700はPCGバンクが存在しない
000123 8123 32C0F2          13      LD  (GRAMFL),A
       8126                     MZ1500:
000126 8126 DD2180F2        14      LD  IX,EMMFL
00012A 812A CD6E81          17      CALL    CHECK_EMM_BPB
00012D 812D FEEB             7      CP  0EBH
00012F 812F 2810            12      JR  Z,EMM_BPB
000131 8131 DD360D02        19      LD  (IX+DPB_MAXSEC),2   ;BPBが512バイト目から始まる場合を調べる
000135 8135 CD6E81          17      CALL    CHECK_EMM_BPB
000138 8138 DDBE06           7      CP  (IX+DPB_FATID)
00013B 813B 2004            12      JR  NZ,EMM_BPB
00013D 813D DD360D00        19      LD  (IX+DPB_MAXSEC),0   ;BPBが先頭の場合に戻す
       8141                     EMM_BPB:
000141 8141 218581          10      LD  HL,INIMES
000144 8144 CD85D4          17      CALL    MSX
       8147                     INIT1:
000147 8147 F3               4      DI
000148 8148 1100FF          10      LD  DE,0FF00H
00014B 814B 0600             7      LD  B,0
00014D 814D CD23D3          17      CALL    ZERO_MEMORY_DE
000150 8150 21CAFF          10      LD  HL,EXTBIO
000153 8153 36C9            10      LD  (HL),0C9H   ;RET
000155 8155 23               6      INC HL
000156 8156 060E             7      LD  B,TRAP38-EXTBIO-1
000158 8158 3E                      DB  03EH    ;LD A,??
000159 8159 EF              12      RST 28H
00015A 815A CDF0DB          17      CALL    FILL_MEMORY
00015D 815D 21B881          10      LD  HL,AT_TRAP38
000160 8160 11D9FF          10      LD  DE,TRAP38
000163 8163 012700          10      LD  BC,AT_TRAPE-AT_TRAP38
000166 8166 EDB0                    LDIR
                                
000168 8168 CDCCDA          17      CALL    CHKEY
00016B 816B FE03             7      CP  3
00016D 816D C9              10      RET
                                
       816E                     CHECK_EMM_BPB:
00016E 816E D5              11      PUSH    DE
00016F 816F 110000          10      LD  DE,0
000172 8172 CD1CEA          17      CALL    EADR
000175 8175 D1              10      POP DE
000176 8176 ED78            12      IN  A,(C)
000178 8178 C9              10      RET
                                
000179 8179 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
000182 8182 413A00              AUTODV: DB  "A:",0
                                
000185 8185 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for MZ-700/1500 v"
            6765727320666F72    
            204D5A2D3730302F    
            313530302076        
0001A3 81A3 312E                    DB  030H + VER_1, '.'
0001A5 81A5 3631                    DB  030H + VER_2 ,030H + VER_3
0001A7 81A7 63                      DB  'c'
0001A8 81A8 2047616B750D0A          DB  " Gaku",0DH,0AH
0001AF 81AF 00                      DB  0
                                
       81B0                     M7BEEPD:
0001B0 81B0 0801                    DB  8,1
0001B2 81B2 0736                    DB  7,036H
0001B4 81B4 04F9                    DB  4,0F9H
0001B6 81B6 0403                    DB  4,3
       81B8                     M7BEEPE:
                                
       81B8                     AT_TRAP38:
0001B8 FFD9                         ORG TRAP38,AT_TRAP38-OFFSET
0001B8 FFD9 210000          10      LD  HL,0
0001BB FFDC E3              19      EX  (SP),HL
0001BC FFDD 3E24             7      LD  A,'$'
0001BE FFDF CD19D7          17      CALL    MSG_A
0001C1 FFE2 2B               6      DEC HL
0001C2 FFE3 7C               4      LD  A,H
0001C3 FFE4 CDE8FF          17      CALL    PRHX
0001C6 FFE7 7D               4      LD  A,L
       FFE8                     PRHX:
0001C7 FFE8 F5              11      PUSH    AF
0001C8 FFE9 07               4      RLCA
0001C9 FFEA 07               4      RLCA
0001CA FFEB 07               4      RLCA
0001CB FFEC 07               4      RLCA
0001CC FFED CDF1FF          17      CALL    PRHX2
0001CF FFF0 F1              10      POP AF
       FFF1                     PRHX2:
0001D0 FFF1 E60F             7      AND 00FH
0001D2 FFF3 FE0A             7      CP  10
0001D4 FFF5 3F               4      CCF
0001D5 FFF6 CE30             7      ADC A,'0'
0001D7 FFF8 27               4      DAA
0001D8 FFF9 C319D7          10      JP  MSG_A
0001DB FFFC                         DS  4
0001DF 81DF                         ORG $$+OFFSET,$$    ;$DEPHASE
       81DF                     AT_TRAPE:
                                
       81DF                     INITE:
0001DF CF06                         ORG BDOS,INITE-OFFSET
                                
0001DF CF06 C309CF          10      JP  IO_BDOS
[EOF:M7INIT.ASM:SHIFT_JIS]
                                    INCLUDE "M7BANK.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                ;   VRAM/KEY/TIMER(0D000H-0EFFFH)にアクセスするので0D000H-0FFFFHに置けない部分
                                ;
                                
       CF09                     IO_BDOS:
0001E2 CF09 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001E4 CF0B C345D4          10      JP  BDOS0
                                
       CF0E                     RDKEYDATA:
0001E7 CF0E F3               4      DI
0001E8 CF0F D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001EA CF11 3200E0          13      LD  (0E000H),A
0001ED CF14 3A01E0          13      LD  A,(E001H)
0001F0 CF17 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001F2 CF19 FB               4      EI
       CF1A                     IO_INT8253:
0001F3 CF1A C9              10      RET
                                
       CF1B                     RD556VSYNC:
0001F4 CF1B F3               4      DI
0001F5 CF1C D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001F7 CF1E 3A02E0          13      LD  A,(0E002H)
0001FA CF21 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001FC CF23 FB               4      EI
0001FD CF24 C9              10      RET
                                
       CF25                     RDMMIO:
0001FE CF25 F3               4      DI
0001FF CF26 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000201 CF28 7E               7      LD  A,(HL)
000202 CF29 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000204 CF2B FB               4      EI
000205 CF2C C9              10      RET
                                
       CF2D                     WRMMIO:
000206 CF2D F3               4      DI
000207 CF2E D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000209 CF30 77               7      LD  (HL),A
00020A CF31 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00020C CF33 FB               4      EI
00020D CF34 C9              10      RET
                                
       CF35                     RDMMIO_BC:
00020E CF35 F3               4      DI
00020F CF36 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000211 CF38 0A               7      LD  A,(BC)
000212 CF39 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000214 CF3B FB               4      EI
000215 CF3C C9              10      RET
                                
       CF3D                     WRMMIO_BC:
000216 CF3D F3               4      DI
000217 CF3E D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000219 CF40 02               7      LD  (BC),A
00021A CF41 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00021C CF43 FB               4      EI
00021D CF44 C9              10      RET
                                
       CF45                     IO_PRINT:
00021E CF45 F3               4      DI
00021F CF46 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000221 CF48 77               7      LD  (HL),A
000222 CF49 CBDC             8      SET 3,H
000224 CF4B 71               7      LD  (HL),C
000225 CF4C D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000227 CF4E FB               4      EI
000228 CF4F C9              10      RET
                                
       CF50                     IO_CLR:
000229 CF50 F3               4      DI
00022A CF51 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF53                     C1AX1:
00022C CF53 7A               4      LD  A,D
00022D CF54 C6D0             7      ADD A,0D0H
00022F CF56 57               4      LD  D,A
000230 CF57 AF               4      XOR A
000231 CF58 12               7      LD  (DE),A      ;Text
000232 CF59 CBDA             8      SET 3,D
       CF5C                     ICSMC   EQU $+1
000234 CF5B 3E00             7      LD  A,0     ;自己書き換え
000236 CF5D 12               7      LD  (DE),A      ;Color
000237 CF5E 13               6      INC DE
000238 CF5F 7A               4      LD  A,D
000239 CF60 D6D8             7      SUB 0D8H
00023B CF62 57               4      LD  D,A
00023C CF63 2118FC          10      LD  HL,0-WIDTH*LINE
00023F CF66 19              11      ADD HL,DE
000240 CF67 30EA            12      JR  NC,C1AX1
000242 CF69 E1              10      POP HL
000243 CF6A D1              10      POP DE
000244 CF6B D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000246 CF6D FB               4      EI
000247 CF6E C9              10      RET
                                
       CF6F                     IO_CLLINE:
000248 CF6F F3               4      DI
000249 CF70 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF72                     CLLINE1:
00024B CF72 CB9C             8      RES 3,H
00024D CF74 77               7      LD  (HL),A      ;Text
00024E CF75 CBDC             8      SET 3,H
000250 CF77 71               7      LD  (HL),C      ;Color
000251 CF78 23               6      INC HL
000252 CF79 10F7            13      DJNZ    CLLINE1
000254 CF7B D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000256 CF7D FB               4      EI
000257 CF7E C9              10      RET
                                
       CF7F                     IO_INS:
000258 CF7F F3               4      DI
000259 CF80 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF82                     IO_INS1:
00025B CF82 CD99CF          17      CALL    C12S
00025E CF85 23               6      INC HL
00025F CF86 10FA            13      DJNZ    IO_INS1
000261 CF88 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000263 CF8A FB               4      EI
000264 CF8B C9              10      RET
                                
       CF8C                     IO_BS:
000265 CF8C F3               4      DI
000266 CF8D D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF8F                     IO_BS1:
000268 CF8F CD99CF          17      CALL    C12S
00026B CF92 2B               6      DEC HL
00026C CF93 10F7            13      DJNZ    IO_BS
00026E CF95 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000270 CF97 FB               4      EI
000271 CF98 C9              10      RET
                                
       CF99                     C12S:
000272 CF99 CB9C             8      RES 3,H
000274 CF9B 5E               7      LD  E,(HL)
000275 CF9C 77               7      LD  (HL),A
000276 CF9D 7B               4      LD  A,E
000277 CF9E CBDC             8      SET 3,H
000279 CFA0 5E               7      LD  E,(HL)
00027A CFA1 71               7      LD  (HL),C
00027B CFA2 4B               4      LD  C,E
00027C CFA3 C9              10      RET
                                
       CFA4                     IO_SCRUP:
00027D CFA4 F3               4      DI
00027E CFA5 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CFA7                     SCRUP1:
000280 CFA7 2815            12      JR  Z,SCRCL
000282 CFA9 D5              11      PUSH    DE
000283 CFAA E5              11      PUSH    HL
000284 CFAB CBDA             8      SET 3,D
000286 CFAD CBDC             8      SET 3,H
000288 CFAF 012800          10      LD  BC,WIDTH
00028B CFB2 EDB0                    LDIR
00028D CFB4 E1              10      POP HL
00028E CFB5 D1              10      POP DE
00028F CFB6 012800          10      LD  BC,WIDTH
000292 CFB9 EDB0                    LDIR
000294 CFBB 3D               4      DEC A
000295 CFBC 18E9            12      JR  SCRUP1
                                
       CFBE                     SCRCL:
000297 CFBE 0628             7      LD  B,WIDTH
000299 CFC0 EB               4      EX  DE,HL
00029A CFC1 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00029C CFC3 CD0AD9          17      CALL    CLLINE
00029F CFC6 E1              10      POP HL
0002A0 CFC7 D1              10      POP DE
0002A1 CFC8 C1              10      POP BC
0002A2 CFC9 C9              10      RET
                                
       CFCA                     RD_PCG:
0002A3 CFCA F3               4      DI
0002A4 CFCB D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
0002A6 CFCD 4E               7      LD  C,(HL)
       CFCE                     RW_PCG:
0002A7 CFCE D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
0002A9 CFD0 FB               4      EI
0002AA CFD1 C9              10      RET
                                
       CFD2                     WR_PCG:
0002AB CFD2 F3               4      DI
0002AC CFD3 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
0002AE CFD5 71               7      LD  (HL),C
0002AF CFD6 18F6            12      JR  RW_PCG
                                
       CFD8                     C_MON:
0002B1 CFD8 D3E4            11      OUT (0E4H),A    ;MONITOR ROM(0000H-0FFFH) & VRAM/KEY/TIMER(D000H-FFFFH)
0002B3 CFDA C7              12      RST 0
                                
       CFDB                     BANKE:
0002B4 CFDB                         DS  0CFFEH-BANKE
[EOF:M7BANK.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   MZ-700/1500
                                
       CFFE                     WBOOT1:
0002D7 CFFE D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)　ここは0CFFEH
0002D9 D000 D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFHH)
0002DB D002 F3               4      DI
0002DC D003 3A94F0          13      LD  A,(_KEYSP)
0002DF D006 ED7B0600        20      LD  SP,(SYSTEM+1)
0002E3 D00A FB               4      EI
0002E4 D00B 2192F0          10      LD  HL,_KEYD
0002E7 D00E 3600            10      LD  (HL),0
0002E9 D010 CDCCDA          17      CALL    CHKEY
0002EC D013 CD15D7          17      CALL    KEYBC_IFBREAK
0002EF D016 3E04             7      LD  A,4
0002F1 D018 CD19D7          17      CALL    MSG_A
[EOF:M7CCP.ASM:UTF_8]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D01B                     COMMAND:
0002F4 D01B 3A1AEB          13      LD  A,(FCB_BAT)
0002F7 D01E B7               4      OR  A
0002F8 D01F C25DD1          10      JP  NZ,C_BAT1
0002FB D022 CDD1D0          17      CALL    SETDTA1
0002FE D025 3A0400          13      LD  A,(_DVSW)
000301 D028 C641             7      ADD A,'A'
000303 D02A CD19D7          17      CALL    MSG_A
000306 D02D 3E3E             7      LD  A,'>'
000308 D02F CD19D7          17      CALL    MSG_A
00030B D032 3E50             7      LD  A,80
00030D D034 12               7      LD  (DE),A
00030E D035 CD75D7          17      CALL    _SYS0A      ;(BDOS)文字列入力
000311 D038 CD52D2          17      CALL    LTNL
       D03B                     COMMAND2:
000314 D03B 118200          10      LD  DE,DTA1+2
000317 D03E CDFDF0          17      CALL    _COMANL
00031A D041 DC09D7          17      CALL    C,SHOW_ERROR
00031D D044 18D5            12      JR  COMMAND
                                
       D046                     COMANL:
00031F D046 CD45DB          17      CALL    FILE
000322 D049 3A19F0          13      LD  A,(FNAME+4)
000325 D04C FE20             7      CP  020H
000327 D04E 201C            12      JR  NZ,COMB2
000329 D050 D5              11      PUSH    DE
00032A D051 1115F0          10      LD  DE,FNAME
00032D D054 1A               7      LD  A,(DE)
00032E D055 FE20             7      CP  020H
000330 D057 2844            12      JR  Z,SDVSW
000332 D059 1B               6      DEC DE
000333 D05A 1A               7      LD  A,(DE)
000334 D05B C6FF             7      ADD A,0FFH
000336 D05D 3809            12      JR  C,COMB
000338 D05F 13               6      INC DE
                                
000339 D060 210FD4          10      LD  HL,COMTB
00033C D063 0609             7      LD  B,COMS
00033E D065 CDD2DD          17      CALL    CPNAME
       D068                     COMB:
000341 D068 D1              10      POP DE
000342 D069 D208D7          10      JP  NC,JPHL
       D06C                     COMB2:
000345 D06C EB               4      EX  DE,HL
000346 D06D 223AD1          16      LD  (COMSWC),HL
000349 D070 F5              11      PUSH    AF
00034A D071 CDF2D0          17      CALL    CEXE4
00034D D074 F1              10      POP AF
00034E D075 2115F0          10      LD  HL,FNAME
000351 D078 116D00          10      LD  DE,FCB2FN   ;COMMAND NAME
000354 D07B 010B00          10      LD  BC,11
000357 D07E EDB0                    LDIR
000359 D080 11B9EA          10      LD  DE,PATHD
       D083                     CEX1:
00035C D083 1A               7      LD  A,(DE)
00035D D084 FE20             7      CP  020H
00035F D086 D8              11      RET C
000360 D087 CD3ADB          17      CALL    FILEC
000363 D08A D5              11      PUSH    DE
000364 D08B 216D00          10      LD  HL,FCB2FN   ;COMMAND NAME
000367 D08E 1115F0          10      LD  DE,FNAME
00036A D091 010B00          10      LD  BC,11
00036D D094 EDB0                    LDIR
00036F D096 CDF2D0          17      CALL    CEXE4
000372 D099 D1              10      POP DE
000373 D09A 13               6      INC DE
000374 D09B 18E6            12      JR  CEX1
                                
       D09D                     SDVSW:
000376 D09D F1              10      POP AF
000377 D09E 3A14F0          13      LD  A,(FDRV)
00037A D0A1 3D               4      DEC A
00037B D0A2 5F               4      LD  E,A
00037C D0A3 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
00037E D0A5 1831            12      JR  SYSTEM0
                                
       D0A7                     OPEN1:
000380 D0A7 2114F0          10      LD  HL,FDRV
       D0AA                     OPEN:
000383 D0AA 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D0AC                     OPEN3:
000385 D0AC D5              11      PUSH    DE
000386 D0AD 11F5EA          10      LD  DE,DTA_CCP
000389 D0B0 CDCED0          17      CALL    SETDTA
00038C D0B3 EB               4      EX  DE,HL
00038D D0B4 CDD8D0          17      CALL    SYSTEM0
000390 D0B7 D1              10      POP DE
000391 D0B8 C9              10      RET
                                
       D0B9                     OPEN2:
000392 D0B9 0E12             7      LD  C,012H
000394 D0BB 18EF            12      JR  OPEN3
                                
       D0BD                     DEFCB:              ;Z=Ok NZ=Error
000396 D0BD 11F5EA          10      LD  DE,DTA_CCP
000399 D0C0 CDD6D0          17      CALL    SYSC0F
                                
00039C D0C3 1116EB          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
00039F D0C6 0604             7      LD  B,4
0003A1 D0C8 CD23D3          17      CALL    ZERO_MEMORY_DE
       D0CB                     SETDTA100:
0003A4 D0CB 110001          10      LD  DE,BUFFER
       D0CE                     SETDTA:
0003A7 D0CE C349D6          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D0D1                     SETDTA1:
0003AA D0D1 118000          10      LD  DE,DTA1
0003AD D0D4 18F8            12      JR  SETDTA
                                
       D0D6                     SYSC0F:
0003AF D0D6 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D0D8                     SYSTEM0:
0003B1 D0D8 CD0500          17      CALL    SYSTEM
0003B4 D0DB B7               4      OR  A
0003B5 D0DC C9              10      RET
                                
       D0DD                     C_CD:
0003B6 D0DD 0E5A             7      LD  C,05AH
0003B8 D0DF 18F7            12      JR  SYSTEM0
                                
       D0E1                     S27BUF:
0003BA D0E1 2100FE          10      LD  HL,0-BUFFER-00100H  ;バッファー+スタック予備(0100H)
       D0E4                     S27BUF2:
0003BD D0E4 39              11      ADD HL,SP
0003BE D0E5 2E00             7      LD  L,0
0003C0 D0E7 7C               4      LD  A,H
0003C1 D0E8 E6F8             7      AND 0F8H
0003C3 D0EA 67               4      LD  H,A
       D0EB                     S27DTA:
0003C4 D0EB 11F5EA          10      LD  DE,DTA_CCP
       D0EE                     S27:
0003C7 D0EE 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
0003C9 D0F0 18E6            12      JR  SYSTEM0
                                
       D0F2                     CEXE4:
0003CB D0F2 211DF0          10      LD  HL,FNAME+8
0003CE D0F5 7E               7      LD  A,(HL)
0003CF D0F6 FE20             7      CP  020H
0003D1 D0F8 2007            12      JR  NZ,CEXE7
0003D3 D0FA 3E3F             7      LD  A,'?'
0003D5 D0FC 77               7      LD  (HL),A
0003D6 D0FD 23               6      INC HL
0003D7 D0FE 77               7      LD  (HL),A
0003D8 D0FF 23               6      INC HL
0003D9 D100 77               7      LD  (HL),A
       D101                     CEXE7:
0003DA D101 CDA7D0          17      CALL    OPEN1
       D104                     CEXE5:
0003DD D104 C0              11      RET NZ
0003DE D105 2AFFEA          16      LD  HL,(DTA_CCP+1+9)
0003E1 D108 7C               4      LD  A,H
0003E2 D109 CD61DE          17      CALL    CAP
0003E5 D10C 67               4      LD  H,A
0003E6 D10D 7D               4      LD  A,L
0003E7 D10E CD61DE          17      CALL    CAP
0003EA D111 6F               4      LD  L,A
0003EB D112 3AFEEA          13      LD  A,(DTA_CCP+1+8)
0003EE D115 CD61DE          17      CALL    CAP
0003F1 D118 D642             7      SUB 'B'
0003F3 D11A 282C            12      JR  Z,C_BAT
0003F5 D11C 3D               4      DEC A       ;'C'
0003F6 D11D 2805            12      JR  Z,C_EXE
       D11F                     CEXE6:
0003F8 D11F CDB9D0          17      CALL    OPEN2
0003FB D122 18E0            12      JR  CEXE5
                                
       D124                     C_EXE:
0003FD D124 7C               4      LD  A,H
0003FE D125 FE4D             7      CP  'M'
000400 D127 20F6            12      JR  NZ,CEXE6
                                
000402 D129 CDBDD0          17      CALL    DEFCB
000405 D12C CDE1D0          17      CALL    S27BUF_COM
000408 D12F 3D               4      DEC A
000409 D130 37               4      SCF
00040A D131 C0              11      RET NZ
00040B D132 7C               4      LD  A,H
00040C D133 B5               4      OR  L
00040D D134 37               4      SCF
00040E D135 C8              11      RET Z
00040F D136 CDD1D0          17      CALL    SETDTA1
000412 D139 110000          10      LD  DE,0                ; self-modifying code
       D13A                     COMSWC  EQU $-2
000415 D13C ED7B0600        20      LD  SP,(SYSTEM+1)
000419 D140 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
00041A D141 6F               4      LD  L,A
00041B D142 E5              11      PUSH    HL              ; push $0000 (reboot address)
00041C D143 24               4      INC H
00041D D144 E5              11      PUSH    HL              ; push $0100 (TPA address)
00041E D145 C3EED2          10      JP  SETFCB              ; and JP $0100
                                
       D148                     C_BAT:
000421 D148 114154          10      LD  DE,'A'+'T'*256
000424 D14B ED52            15      SBC HL,DE
000426 D14D 20D0            12      JR  NZ,CEXE6
                                
000428 D14F CDBDD0          17      CALL    DEFCB
                                
00042B D152 21F5EA          10      LD  HL,DTA_CCP
00042E D155 111AEB          10      LD  DE,FCB_BAT
000431 D158 012500          10      LD  BC,37
000434 D15B EDB0                    LDIR
       D15D                     C_BAT1:
000436 D15D CDCBD0          17      CALL    SETDTA100
000439 D160 CD94D1          17      CALL    FGETC_BAT
00043C D163 218100          10      LD  HL,DTA1+1
00043F D166 2025            12      JR  NZ,END_BATCH
000441 D168 FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
000443 D16A 38F1            12      JR  C,C_BAT1
000445 D16C 3620            10      LD  (HL),' '
000447 D16E 23               6      INC HL
       D16F                     C_BAT2:
000448 D16F 77               7      LD  (HL),A
000449 D170 23               6      INC HL
00044A D171 7D               4      LD  A,L
00044B D172 3C               4      INC A       ;L==0FFH
00044C D173 2809            12      JR  Z,RUN_BATCH
00044E D175 CD94D1          17      CALL    FGETC_BAT
000451 D178 2004            12      JR  NZ,RUN_BATCH
000453 D17A FE20             7      CP  020H
000455 D17C 30F1            12      JR  NC,C_BAT2
       D17E                     RUN_BATCH:
000457 D17E 7D               4      LD  A,L
000458 D17F D67F             7      SUB DTA1-1
00045A D181 328000          13      LD  (DTA1),A
00045D D184 FE04             7      CP  4
00045F D186 3805            12      JR  C,END_BATCH
000461 D188 3600            10      LD  (HL),0
000463 D18A C33BD0          10      JP  COMMAND2
       D18D                     END_BATCH:
000466 D18D AF               4      XOR A       ;バッチファイルを閉じる
000467 D18E 321AEB          13      LD  (FCB_BAT),A
00046A D191 C300F0          10      JP  CPM_BOOT
                                
       D194                     FGETC_BAT:
00046D D194 111AEB          10      LD  DE,FCB_BAT
       D197                     FGETC:              ;1文字ずつ読み込む
000470 D197 E5              11      PUSH    HL      ;Z:成功
000471 D198 210100          10      LD  HL,1
000474 D19B CDEED0          17      CALL    S27
000477 D19E E1              10      POP HL
000478 D19F 3A0001          13      LD  A,(BUFFER)
00047B D1A2 C9              10      RET
                                
       D1A3                     C_DEL:
00047C D1A3 CDEED2          17      CALL    SETFCB
00047F D1A6 CD2FD7          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
000482 D1A9 0E13             7      LD  C,013H
000484 D1AB 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       D1AD                     C_REN:
000486 D1AD CDEED2          17      CALL    SETFCB
000489 D1B0 3E10             7      LD  A,010H      ;ディレクトリも対象にする
00048B D1B2 326900          13      LD  (FCB1+13),A ;属性
00048E D1B5 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       D1B7                     CDEL1:
000490 D1B7 115C00          10      LD  DE,FCB1
000493 D1BA CD0500          17      CALL    SYSTEM
000496 D1BD C6FF             7      ADD A,0FFH
000498 D1BF C9              10      RET
                                
       D1C0                     C_DIR:
000499 D1C0 CD3ADB          17      CALL    FILEC
00049C D1C3 2115F0          10      LD  HL,FDRV+1
00049F D1C6 CD04D4          17      CALL    CWILD1
0004A2 D1C9 3EF1             7      LD  A,0F1H
0004A4 D1CB 3221F0          13      LD  (FDRV+13),A
0004A7 D1CE CDA7D0          17      CALL    OPEN1
       D1D1                     CDIR1:
0004AA D1D1 B7               4      OR  A
0004AB D1D2 2008            12      JR  NZ,PDSKF
0004AD D1D4 CD1FD2          17      CALL    P_NAME
0004B0 D1D7 CDB9D0          17      CALL    OPEN2
0004B3 D1DA 18F5            12      JR  CDIR1
       D1DC                     PDSKF:
0004B5 D1DC 3A14F0          13      LD  A,(FDRV)
0004B8 D1DF 5F               4      LD  E,A
0004B9 D1E0 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
0004BB D1E2 CD0500          17      CALL    SYSTEM
0004BE D1E5 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
0004BF D1E6 C601             7      ADD A,001H
0004C1 D1E8 D8              11      RET C       ;Aが0FFHだった場合
0004C2 D1E9 3E06             7      LD  A,8-2
       D1EB                     PDS1:               ;HL=未使用クラスタの総数
0004C4 D1EB 3C               4      INC A
0004C5 D1EC CB19             8      RR  C
0004C7 D1EE 30FB            12      JR  NC,PDS1
       D1F0                     PDS2:               ;B←論理セクタのサイズの上位8ビット
0004C9 D1F0 3C               4      INC A
0004CA D1F1 CB18             8      RR  B
0004CC D1F3 30FB            12      JR  NC,PDS2
0004CE D1F5 47               4      LD  B,A
                                
0004CF D1F6 110000          10      LD  DE,0
       D1F9                     PDS3:
0004D2 D1F9 29              11      ADD HL,HL
0004D3 D1FA EB               4      EX  DE,HL
0004D4 D1FB ED6A            15      ADC HL,HL
0004D6 D1FD EB               4      EX  DE,HL
0004D7 D1FE 10F9            13      DJNZ    PDS3
       D200                     PDSKF1:
0004D9 D200 CD8CD2          17      CALL    PRDEC_DEHL
0004DC D203 114AEB          10      LD  DE,FREE
0004DF D206 CD76D4          17      CALL    _SYS09      ;(BDOS)文字列出力
0004E2 D209 CD79D2          17      CALL    PUTDRV
0004E5 D20C 3E5C             7      LD  A,05CH      ;\
0004E7 D20E CD19D7          17      CALL    MSG_A
0004EA D211 2A22F0          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
0004ED D214 AF               4      XOR A
0004EE D215 11FEFF          10      LD  DE,0-2
0004F1 D218 19              11      ADD HL,DE
0004F2 D219 23               6      INC HL
0004F3 D21A DC89D2          17      CALL    C,PRDEC_HL
0004F6 D21D 1833            12      JR  LTNL
                                
       D21F                     P_NAME:
0004F8 D21F 3AF6EA          13      LD  A,(DTA_CCP+1)
0004FB D222 FE2E             7      CP  '.'
0004FD D224 C8              11      RET Z
                                
0004FE D225 3A01EB          13      LD  A,(DTA_CCP+1+00BH)
000501 D228 F5              11      PUSH    AF
000502 D229 CB67             8      BIT 4,A
000504 D22B 2808            12      JR  Z,DIR3
000506 D22D 113FEB          10      LD  DE,DIRMES
000509 D230 CD76D4          17      CALL    _SYS09      ;(BDOS)文字列出力
00050C D233 180A            12      JR  DIR6
       D235                     DIR3:
00050E D235 ED5B14EB        20      LD  DE,(DTA_CCP+1+01EH)
000512 D239 2A12EB          16      LD  HL,(DTA_CCP+1+01CH)
000515 D23C CD8CD2          17      CALL    PRDEC_DEHL
       D23F                     DIR6:
000518 D23F F1              10      POP AF
000519 D240 0F               4      RRCA
00051A D241 9F               4      SBC A,A
00051B D242 E60A             7      AND '*'-020H
00051D D244 C620             7      ADD A,020H
00051F D246 CD19D7          17      CALL    MSG_A
000522 D249 CD79D2          17      CALL    PUTDRV
000525 D24C 21F6EA          10      LD  HL,DTA_CCP+1
000528 D24F CDCCD2          17      CALL    FPRNT
                                
       D252                     LTNL:
00052B D252 1E03             7      LD  E,3
00052D D254 C3CDF0          10      JP  _PRINT
                                
       D257                     C_PATH:
000530 D257 CD1BDC          17      CALL    SPCUT
000533 D25A 21B9EA          10      LD  HL,PATHD
000536 D25D FE21             7      CP  021H
000538 D25F 300C            12      JR  NC,CPATH0
       D261                     CPATHP:
00053A D261 7E               7      LD  A,(HL)
00053B D262 23               6      INC HL
00053C D263 FE20             7      CP  020H
00053E D265 3F               4      CCF
00053F D266 30EA            12      JR  NC,LTNL
000541 D268 CD19D7          17      CALL    MSG_A
000544 D26B 18F4            12      JR  CPATHP
       D26D                     CPATH0:
000546 D26D FE3B             7      CP  ';'
000548 D26F 2001            12      JR  NZ,CPATH1
00054A D271 13               6      INC DE
       D272                     CPATH1:
00054B D272 EB               4      EX  DE,HL
00054C D273 013B00          10      LD  BC,PATHX
00054F D276 EDB0                    LDIR
000551 D278 C9              10      RET
                                
       D279                     PUTDRV:
000552 D279 3A14F0          13      LD  A,(FDRV)
000555 D27C CD4EDC          17      CALL    GETDRV1
000558 D27F C641             7      ADD A,'A'
00055A D281 CD19D7          17      CALL    MSG_A
00055D D284 3E3A             7      LD  A,':'
       D286                     MSG_AR:
00055F D286 C319D7          10      JP  MSG_A
                                
       D289                     PRDEC_HL:
000562 D289 AF               4      XOR A
000563 D28A 5F               4      LD  E,A
000564 D28B 57               4      LD  D,A
       D28C                     PRDEC_DEHL:
000565 D28C D5              11      PUSH    DE
000566 D28D 110FF0          10      LD  DE,DECBF
000569 D290 0605             7      LD  B,5
00056B D292 CD23D3          17      CALL    ZERO_MEMORY_DE  ;A=0
00056E D295 D1              10      POP DE
                                
00056F D296 0E20             7      LD  C,32
       D298                     DEC1:
000571 D298 29              11      ADD HL,HL
000572 D299 EB               4      EX  DE,HL
000573 D29A ED6A            15      ADC HL,HL
000575 D29C EB               4      EX  DE,HL
000576 D29D E5              11      PUSH    HL
000577 D29E 2113F0          10      LD  HL,DECBF+4
00057A D2A1 0605             7      LD  B,5
       D2A3                     DEC2:
00057C D2A3 7E               7      LD  A,(HL)
00057D D2A4 8F               4      ADC A,A
00057E D2A5 27               4      DAA
00057F D2A6 77               7      LD  (HL),A
000580 D2A7 2B               6      DEC HL
000581 D2A8 10F9            13      DJNZ    DEC2
000583 D2AA E1              10      POP HL
000584 D2AB 0D               4      DEC C
000585 D2AC 20EA            12      JR  NZ,DEC1
                                
000587 D2AE 210FF0          10      LD  HL,DECBF
00058A D2B1 3E20             7      LD  A,020H
00058C D2B3 0604             7      LD  B,4
       D2B5                     DEC3:
00058E D2B5 CDC2D2          17      CALL    DEC4
000591 D2B8 CDC2D2          17      CALL    DEC4
000594 D2BB 23               6      INC HL
000595 D2BC 10F7            13      DJNZ    DEC3
       D2BE                     DECX:
000597 D2BE CDC2D2          17      CALL    DEC4
00059A D2C1 AF               4      XOR A
       D2C2                     DEC4:
00059B D2C2 ED6F            18      RLD
00059D D2C4 FE20             7      CP  020H
00059F D2C6 2802            12      JR  Z,DEC5
0005A1 D2C8 F630             7      OR  030H
       D2CA                     DEC5:
0005A3 D2CA 18BA            12      JR  MSG_AR
                                
       D2CC                     FPRNT:
0005A5 D2CC 0608             7      LD  B,8 ;ファイル名を表示
0005A7 D2CE CDDDD2          17      CALL    P_N1
0005AA D2D1 7E               7      LD  A,(HL)
0005AB D2D2 CD6DDE          17      CALL    CAP3
0005AE D2D5 D8              11      RET C   ;拡張子が無い
                                
0005AF D2D6 3E2E             7      LD  A,'.'
0005B1 D2D8 CD19D7          17      CALL    MSG_A
0005B4 D2DB 0603             7      LD  B,3 ;拡張子を表示
       D2DD                     P_N1:
0005B6 D2DD 7E               7      LD  A,(HL)
0005B7 D2DE CD6DDE          17      CALL    CAP3
0005BA D2E1 3807            12      JR  C,P_N2
0005BC D2E3 CD19D7          17      CALL    MSG_A
0005BF D2E6 23               6      INC HL
0005C0 D2E7 10F4            13      DJNZ    P_N1
0005C2 D2E9 C9              10      RET
       D2EA                     P_N2:
0005C3 D2EA 23               6      INC HL
0005C4 D2EB 10FD            13      DJNZ    P_N2
0005C6 D2ED C9              10      RET
                                
       D2EE                     SETFCB:
0005C7 D2EE CD1BDC          17      CALL    SPCUT
0005CA D2F1 1A               7      LD  A,(DE)
0005CB D2F2 FE20             7      CP  020H
0005CD D2F4 3801            12      JR  C,SETFCBA
0005CF D2F6 1B               6      DEC DE
       D2F7                     SETFCBA:
0005D0 D2F7 0624             7      LD  B,36
0005D2 D2F9 215C00          10      LD  HL,FCB1
0005D5 D2FC E5              11      PUSH    HL
0005D6 D2FD AF               4      XOR A
0005D7 D2FE CDF0DB          17      CALL    FILL_MEMORY
0005DA D301 E1              10      POP HL
0005DB D302 D5              11      PUSH    DE
0005DC D303 CDAFD6          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0005DF D306 216C00          10      LD  HL,FCB2
0005E2 D309 CDAFD6          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0005E5 D30C E1              10      POP HL
0005E6 D30D 010050          10      LD  BC,05000H
0005E9 D310 118100          10      LD  DE,00081H
       D313                     SETFCB1:
0005EC D313 7E               7      LD  A,(HL)
0005ED D314 23               6      INC HL
0005EE D315 FE20             7      CP  020H
0005F0 D317 3805            12      JR  C,SETFCB2
0005F2 D319 12               7      LD  (DE),A
0005F3 D31A 13               6      INC DE
0005F4 D31B 0C               4      INC C
0005F5 D31C 10F5            13      DJNZ    SETFCB1
       D31E                     SETFCB2:
0005F7 D31E 79               4      LD  A,C
0005F8 D31F 328000          13      LD  (DTA1),A
0005FB D322 04               4      INC B
       D323                     ZERO_MEMORY_DE:
0005FC D323 AF               4      XOR A
       D324                     FILL_MEMORY_DE:
0005FD D324 12               7      LD  (DE),A
0005FE D325 13               6      INC DE
0005FF D326 10FC            13      DJNZ    FILL_MEMORY_DE
000601 D328 C9              10      RET
                                
       D329                     C_COPY:
000602 D329 CDEED2          17      CALL    SETFCB
                                
000605 D32C 1161F0          10      LD  DE,ZERO
000608 D32F CD3DDB          17      CALL    FILEC2
00060B D332 216C00          10      LD  HL,FCB2
00060E D335 CDB6D6          17      CALL    S29X1
                                
000611 D338 3E10             7      LD  A,010H
000613 D33A 326900          13      LD  (FCB1+13),A
000616 D33D 216D00          10      LD  HL,FCB2FN
000619 D340 CD04D4          17      CALL    CWILD1
       D343                     COPY0:
00061C D343 CD01D4          17      CALL    CWILD
00061F D346 215C00          10      LD  HL,FCB1
000622 D349 CDAAD0          17      CALL    OPEN
000625 D34C 37               4      SCF
       D34D                     COPY1:
000626 D34D C0              11      RET NZ
000627 D34E CDBDD0          17      CALL    DEFCB
                                
00062A D351 3A02EB          13      LD  A,(DTA_CCP+13)
00062D D354 CB67             8      BIT 4,A
00062F D356 2821            12      JR  Z,COPY1A
                                
000631 D358 215D00          10      LD  HL,FCB1FN
000634 D35B CD80DF          17      CALL    CHKWILD
000637 D35E 3814            12      JR  C,COPY9
                                
000639 D360 3E20             7      LD  A,020H
00063B D362 325D00          13      LD  (FCB1FN),A
00063E D365 2A0FEB          16      LD  HL,(DTA_CCP+26)
000641 D368 23               6      INC HL
000642 D369 226A00          16      LD  (FCB1+14),HL
000645 D36C 18D5            12      JR  COPY0
                                
       D36E                     COPY8:
000647 D36E CD76D4          17      CALL    _SYS09      ;(BDOS)文字列出力
00064A D371 CD52D2          17      CALL    LTNL
       D374                     COPY9:
00064D D374 CDB9D0          17      CALL    OPEN2
000650 D377 18D4            12      JR  COPY1
                                
       D379                     COPY1A:
000652 D379 216C00          10      LD  HL,FCB2
000655 D37C 1114F0          10      LD  DE,FDRV
000658 D37F 01F7EA          10      LD  BC,DTA_CCP+2
00065B D382 EDA0            16      LDI
00065D D384 3E0B             7      LD  A,11
       D386                     COPY2:
00065F D386 F5              11      PUSH    AF
000660 D387 7E               7      LD  A,(HL)
000661 D388 FE3F             7      CP  '?'
000663 D38A 2001            12      JR  NZ,COPY3
000665 D38C 0A               7      LD  A,(BC)
       D38D                     COPY3:
000666 D38D 12               7      LD  (DE),A
000667 D38E 03               6      INC BC
000668 D38F 13               6      INC DE
000669 D390 23               6      INC HL
00066A D391 F1              10      POP AF
00066B D392 3D               4      DEC A
00066C D393 20F1            12      JR  NZ,COPY2
00066E D395 010500          10      LD  BC,16-11
000671 D398 EDB0                    LDIR
       D39A                     PUTNAME:
000673 D39A 215D00          10      LD  HL,FCB1FN
000676 D39D CD80DF          17      CALL    CHKWILD
000679 D3A0 300B            12      JR  NC,PUTN1
00067B D3A2 2115F0          10      LD  HL,FDRV+1
00067E D3A5 CDCCD2          17      CALL    FPRNT
000681 D3A8 3E20             7      LD  A,020H
000683 D3AA CD19D7          17      CALL    MSG_A
       D3AD                     PUTN1:
000686 D3AD 1114F0          10      LD  DE,FDRV
000689 D3B0 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
00068B D3B2 CDD8D0          17      CALL    SYSTEM0
00068E D3B5 2048            12      JR  NZ,COPYE2
000690 D3B7 67               4      LD  H,A     ;A=0
000691 D3B8 6F               4      LD  L,A
000692 D3B9 2235F0          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
000695 D3BC 2237F0          16      LD  (FDRV+35),HL
       D3BF                     COPY6:
000698 D3BF CDE1D0          17      CALL    S27BUF
00069B D3C2 47               4      LD  B,A
00069C D3C3 3C               4      INC A
00069D D3C4 2831            12      JR  Z,COPYE
00069F D3C6 7C               4      LD  A,H
0006A0 D3C7 B5               4      OR  L
0006A1 D3C8 280C            12      JR  Z,COPY7
0006A3 D3CA 1114F0          10      LD  DE,FDRV
0006A6 D3CD 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0006A8 D3CF CDD8D0          17      CALL    SYSTEM0
0006AB D3D2 2023            12      JR  NZ,COPYE
0006AD D3D4 10E9            13      DJNZ    COPY6
       D3D6                     COPY7:
0006AF D3D6 3A02EB          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
0006B2 D3D9 3221F0          13      LD  (FDRV+13),A
0006B5 D3DC 2109EB          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
0006B8 D3DF 1128F0          10      LD  DE,FDRV+20
0006BB D3E2 010400          10      LD  BC,4
0006BE D3E5 EDB0                    LDIR
                                
0006C0 D3E7 1114F0          10      LD  DE,FDRV
0006C3 D3EA 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
0006C5 D3EC CDD8D0          17      CALL    SYSTEM0
0006C8 D3EF 2006            12      JR  NZ,COPYE
                                
0006CA D3F1 1171F0          10      LD  DE,OK
0006CD D3F4 C36ED3          10      JP  COPY8
                                
       D3F7                     COPYE:
0006D0 D3F7 1114F0          10      LD  DE,FDRV
0006D3 D3FA 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
0006D5 D3FC CD0500          17      CALL    SYSTEM
       D3FF                     COPYE2:
0006D8 D3FF 37               4      SCF
0006D9 D400 C9              10      RET
                                
       D401                     CWILD:
0006DA D401 215D00          10      LD  HL,FCB1FN
       D404                     CWILD1:
0006DD D404 7E               7      LD  A,(HL)
0006DE D405 FE20             7      CP  020H
0006E0 D407 C0              11      RET NZ
       D408                     CWILD2:
0006E1 D408 3E3F             7      LD  A,'?'
0006E3 D40A 060B             7      LD  B,11
0006E5 D40C C3F0DB          10      JP  FILL_MEMORY
                                
       D40F                     COMTB:
0006E8 D40F 44202020                DB  "D   "  ;1
0006EC D413 C0D1                    DW  C_DIR
0006EE D415 44495220                DB  "DIR "  ;2
0006F2 D419 C0D1                    DW  C_DIR
0006F4 D41B 434F5059                DB  "COPY"  ;3
0006F8 D41F 29D3                    DW  C_COPY
0006FA D421 43442020                DB  "CD  "  ;4
0006FE D425 DDD0                    DW  C_CD
000700 D427 44454C20                DB  "DEL "  ;5
000704 D42B A3D1                    DW  C_DEL
000706 D42D 50415448                DB  "PATH"  ;6
00070A D431 57D2                    DW  C_PATH
00070C D433 52454E20                DB  "REN "  ;7
000710 D437 ADD1                    DW  C_REN
000712 D439 52454D20                DB  "REM "  ;8
000716 D43D 73D4                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP2.ASM"
                                
                                ;   LSX-Dodgers CCP2
                                ;   MZ-700/1500
                                
000718 D43F 4D4F4E20                DB  "MON "  ;10
00071C D443 D8CF                    DW  C_MON
[EOF:M7CCP2.ASM:UTF_8]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       D445                     BDOS0:
00071E D445 E5              11      PUSH    HL
00071F D446 79               4      LD  A,C
000720 D447 FE3C             7      CP  03CH
000722 D449 3802            12      JR  C,DOS1
000724 D44B 3E3C             7      LD  A,03CH
       D44D                     DOS1:
000726 D44D 87               4      ADD A,A
000727 D44E 3252D4          13      LD  (DOS1_SWC),A
00072A D451 2A00F1          16      LD  HL,(STABLE)
       D452                     DOS1_SWC    EQU $-2
00072D D454 E3              19      EX  (SP),HL
00072E D455 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
00072F D456 C9              10      RET
       D457                     _DOS2:
000730 D457 FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
000732 D459 CAF1D6          10      JP  Z,_SYS5A
000735 D45C FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
000737 D45E CAAED6          10      JP  Z,_SYS5C
00073A D461 FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
00073C D463 CA7DE8          10      JP  Z,_SYS5F
00073F D466 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
000741 D468 200A            12      JR  NZ,_ERROR
000743 D46A 011D01          10      LD  BC,VER_6F
000746 D46D 116101          10      LD  DE,VER
000749 D470 210100          10      LD  HL,MACD
       D473                     C_REM:
00074C D473 AF               4      XOR A
       D474                     _ERROR:
00074D D474 A7               4      AND A
00074E D475 C9              10      RET
                                
       D476                     _SYS09:     ;文字列出力
00074F D476 D5              11      PUSH    DE
       D477                     _SX09:
000750 D477 1A               7      LD  A,(DE)
000751 D478 13               6      INC DE
000752 D479 FE24             7      CP  '$'
000754 D47B 2831            12      JR  Z,SX0E2
000756 D47D CD19D7          17      CALL    MSG_A
000759 D480 18F5            12      JR  _SX09
                                
       D482                     MSX1:
00075B D482 CD19D7          17      CALL    MSG_A
       D485                     MSX:
00075E D485 7E               7      LD  A,(HL)
00075F D486 23               6      INC HL
000760 D487 B7               4      OR  A
000761 D488 20F8            12      JR  NZ,MSX1
000763 D48A C9              10      RET
                                
       D48B                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000764 D48B 212200          10      LD  HL,00022H
000767 D48E 7D               4      LD  A,L
000768 D48F C9              10      RET
                                
       D490                     _SYS0D:     ;(BDOS)ディスクリセット
000769 D490 CDDFF0          17      CALL    _FFLUSH
00076C D493 E5              11      PUSH    HL
00076D D494 218000          10      LD  HL,00080H
000770 D497 228AF0          16      LD  (_DTA),HL
000773 D49A E1              10      POP HL
000774 D49B D5              11      PUSH    DE
000775 D49C 1E00             7      LD  E,0
000777 D49E 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       D49F                     _SYS0E:     ;(BDOS)カレントドライブの設定
000778 D49F D5              11      PUSH    DE
000779 D4A0 7B               4      LD  A,E
00077A D4A1 DDE5            15      PUSH    IX
00077C D4A3 CDDCF0          17      CALL    _GETDPB
00077F D4A6 DDE1            14      POP IX
000781 D4A8 3804            12      JR  C,SX0E2
000783 D4AA 7B               4      LD  A,E
000784 D4AB 320400          13      LD  (_DVSW),A
       D4AE                     SX0E2:
000787 D4AE D1              10      POP DE
000788 D4AF C9              10      RET
                                
       D4B0                     _SYS0F:     ;(BDOS)ファイルのオープン
000789 D4B0 CD2DDC          17      CALL    SETDRV
00078C D4B3 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
00078F D4B6 C602             7      ADD A,002H      ;Write
000791 D4B8 2848            12      JR  Z,FEND0F
000793 D4BA CD7CDF          17      CALL    CHKWILDX
                                
000796 D4BD D457DC          17      CALL    NC,SOPENX
       D4C0                     _S16XX:
000799 D4C0 3840            12      JR  C,FEND0F
                                                ;Directory location
00079B D4C2 3A9FF0          13      LD  A,(_FILEN)
00079E D4C5 FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
0007A1 D4C8 3AA0F0          13      LD  A,(_DIRF)
0007A4 D4CB FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
0007A7 D4CE FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
0007AA D4D1 FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
0007AD D4D4 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
0007B1 D4D8 FDE5            15      PUSH    IY
0007B3 D4DA D1              10      POP DE
0007B4 D4DB 13               6      INC DE
0007B5 D4DC 010B00          10      LD  BC,11
0007B8 D4DF EDB0                    LDIR
                                ;               Attribute
0007BA D4E1 7E               7      LD  A,(HL)
0007BB D4E2 FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
0007BE D4E5 110B00          10      LD  DE,11       ;Reserved
0007C1 D4E8 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
0007C2 D4E9 11E4F1          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
0007C5 D4EC 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D4EE                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
0007C7 D4EE 1A               7      LD  A,(DE)
0007C8 D4EF 13               6      INC DE
0007C9 D4F0 32F7D4          13      LD  (S16PAT),A
0007CC D4F3 7E               7      LD  A,(HL)
0007CD D4F4 23               6      INC HL
0007CE D4F5 FD7700          19      LD  (IY+0),A
       D4F7                     S16PAT  EQU $-1
0007D1 D4F8 10F4            13      DJNZ    S16LOOP
                                
0007D3 D4FA AF               4      XOR A
0007D4 D4FB FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
0007D7 D4FE FD229FD5        20      LD  (OFCB_SWC),IY
       D502                     FEND0F:
0007DB D502 1845            12      JR  FEND10
                                
       D504                     _SYS10:     ;(BDOS)ファイルのクローズ
0007DD D504 CD2DDC          17      CALL    SETDRV
0007E0 D507 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0007E3 D50A D6FE             7      SUB 0FEH
0007E5 D50C 37               4      SCF
0007E6 D50D 3F               4      CCF
0007E7 D50E 2039            12      JR  NZ,FEND10
       D510                     _S10A:              ;Write
0007E9 D510 FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
0007EC D513 FD770F          19      LD  (IY+15),A
                                
0007EF D516 FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
0007F2 D519 CD78E0          17      CALL    SETTMS
                                
0007F5 D51C FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
0007F8 D51F 32A0F0          13      LD  (_DIRF),A
0007FB D522 E67F             7      AND 07FH
0007FD D524 329DE5          13      LD  (_SECPS),A
000800 D527 FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
000803 D52A FD561F          19      LD  D,(IY+31)
000806 D52D CD8BDD          17      CALL    READ_DIR
000809 D530 3817            12      JR  C,FEND10
                                
00080B D532 3AB7DC          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
00080E D535 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
00080F D536 FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
000812 D539 6F               4      LD  L,A
000813 D53A 2600             7      LD  H,0
000815 D53C 29              11      ADD HL,HL       ;*2
000816 D53D 29              11      ADD HL,HL       ;*4
000817 D53E 29              11      ADD HL,HL       ;*8
000818 D53F 29              11      ADD HL,HL       ;*16
000819 D540 29              11      ADD HL,HL       ;*32
00081A D541 ED4B7EF1        20      LD  BC,(_DTBUF)
00081E D545 09              11      ADD HL,BC
                                
00081F D546 CD8CDF          17      CALL    SDIRENT
       D549                     FEND10:
000822 D549 1842            12      JR  FEND
                                
       D54B                     _SYS11:     ;(BDOS)最初のファイルの検索
000824 D54B CD2DDC          17      CALL    SETDRV
000827 D54E CD86DC          17      CALL    SOPEN
       D551                     _S12X1:
00082A D551 383A            12      JR  C,FEND
00082C D553 CD25DD          17      CALL    SOPENE2
00082F D556 ED5B8AF0        20      LD  DE,(_DTA)
000833 D55A 3A88F0          13      LD  A,(_DRV)
000836 D55D 3C               4      INC A
000837 D55E 12               7      LD  (DE),A
000838 D55F D5              11      PUSH    DE
000839 D560 13               6      INC DE
00083A D561 012000          10      LD  BC,32
00083D D564 EDB0                    LDIR
00083F D566 FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000842 D569 FD660F          19      LD  H,(IY+15)
000845 D56C 22F4F1          16      LD  (SCDIR),HL
000848 D56F 2A9AF0          16      LD  HL,(_FBPS)
00084B D572 22F6F1          16      LD  (SFBPS),HL
00084E D575 2A9FF0          16      LD  HL,(_FILEN)
000851 D578 7C               4      LD  A,H
000852 D579 B7               4      OR  A
000853 D57A 2806            12      JR  Z,_S12DIR
000855 D57C 3A9DE5          13      LD  A,(_SECPS)
000858 D57F F680             7      OR  080H
00085A D581 67               4      LD  H,A
       D582                     _S12DIR:
00085B D582 22F8F1          16      LD  (SFNDF),HL  ;Directory position and Flags
00085E D585 E1              10      POP HL
00085F D586 1139F0          10      LD  DE,SFILE
000862 D589 0E21             7      LD  C,33
       D58B                     _S11B:
000864 D58B EDB0                    LDIR
       D58D                     FEND:
000866 D58D 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D58E                     FENDE:
000867 D58E FDE1            14      POP IY
000869 D590 C1              10      POP BC
00086A D591 D1              10      POP DE
00086B D592 E1              10      POP HL
00086C D593 C9              10      RET
                                
       D594                     _SYS12:     ;(BDOS)次のファイルの検索
00086D D594 E5              11      PUSH    HL
00086E D595 D5              11      PUSH    DE
00086F D596 C5              11      PUSH    BC
000870 D597 FDE5            15      PUSH    IY
000872 D599 CDEADC          17      CALL    NOPEN
000875 D59C 18B3            12      JR  _S12X1
                                
       D59E                     _S16K:
000877 D59E 110000          10      LD  DE,0
       D59F                     OFCB_SWC    EQU $-2
00087A D5A1 D5              11      PUSH    DE
00087B D5A2 061A             7      LD  B,26        ;First cluster
       D5A4                     S16K1:
00087D D5A4 13               6      INC DE
00087E D5A5 23               6      INC HL
00087F D5A6 10FC            13      DJNZ    S16K1
                                
000881 D5A8 1A               7      LD  A,(DE)
000882 D5A9 BE               7      CP  (HL)
000883 D5AA 2015            12      JR  NZ,S16K2
000885 D5AC 13               6      INC DE
000886 D5AD 23               6      INC HL
000887 D5AE 1A               7      LD  A,(DE)
000888 D5AF BE               7      CP  (HL)
000889 D5B0 200F            12      JR  NZ,S16K2
                                
00088B D5B2 E1              10      POP HL
00088C D5B3 FDE5            15      PUSH    IY
00088E D5B5 D1              10      POP DE
00088F D5B6 7E               7      LD  A,(HL)
000890 D5B7 CD42DC          17      CALL    IS_SAME_DRV_A_DE
000893 D5BA 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
000895 D5BC ED52            15      SBC HL,DE       ;CP HL,DE
000897 D5BE 37               4      SCF
000898 D5BF C0              11      RET NZ
000899 D5C0 E5              11      PUSH    HL
       D5C1                     S16K2:
00089A D5C1 E1              10      POP HL
       D5C2                     S16K3:
00089B D5C2 FDE5            15      PUSH    IY
00089D D5C4 D1              10      POP DE
       D5C5                     _SYS13:     ;(BDOS)ファイルの削除
00089E D5C5 CD2DDC          17      CALL    SETDRV
0008A1 D5C8 CDB4DE          17      CALL    KILL
       D5CB                     FEND13:
0008A4 D5CB 18C0            12      JR  FEND
                                
       D5CD                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0008A6 D5CD CD2DDC          17      CALL    SETDRV
0008A9 D5D0 CDF0E3          17      CALL    INIT_SEQ
       D5D3                     SREAD:
0008AC D5D3 CDC2E3          17      CALL    RB_READ
                                
0008AF D5D6 C601             7      ADD A,001H
0008B1 D5D8 38B3            12      JR  C,FEND
                                
0008B3 D5DA 7D               4      LD  A,L
0008B4 D5DB D601             7      SUB 001H
       D5DD                     FENDX:
0008B6 D5DD 9F               4      SBC A,A
0008B7 D5DE E603             7      AND 3
0008B9 D5E0 1F               4      RRA
0008BA D5E1 18AB            12      JR  FENDE
                                
       D5E3                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
0008BC D5E3 CD2DDC          17      CALL    SETDRV
0008BF D5E6 CDF0E3          17      CALL    INIT_SEQ
       D5E9                     SWRITE:
0008C2 D5E9 CDBDE3          17      CALL    RB_WRITE
                                
0008C5 D5EC C6FF             7      ADD A,0FFH
0008C7 D5EE 18ED            12      JR  FENDX
                                
       D5F0                     _SYS17:     ;(BDOS)ファイル名の変更
0008C9 D5F0 CD2DDC          17      CALL    SETDRV
0008CC D5F3 CD0ADF          17      CALL    NAME
0008CF D5F6 18D3            12      JR  FEND13
                                
       D5F8                     _SYS16:     ;(BDOS)ファイルの作成
0008D1 D5F8 CD2DDC          17      CALL    SETDRV
                                
0008D4 D5FB CD7CDF          17      CALL    CHKWILDX
0008D7 D5FE 38CB            12      JR  C,FEND13
0008D9 D600 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
0008DC D603 FE05             7      CP  5
0008DE D605 2805            12      JR  Z,_S16X2
0008E0 D607 FE21             7      CP  021H
0008E2 D609 DACBD5          10      JP  C,FEND13
       D60C                     _S16X2:
                                ;               Clear FCB
0008E5 D60C FDE5            15      PUSH    IY
0008E7 D60E E1              10      POP HL
0008E8 D60F 011000          10      LD  BC,16
0008EB D612 09              11      ADD HL,BC
       D613                     _S16X1:
0008EC D613 70               7      LD  (HL),B      ;B=0
0008ED D614 23               6      INC HL
0008EE D615 0D               4      DEC C
0008EF D616 20FB            12      JR  NZ,_S16X1
                                
0008F1 D618 CD7DE0          17      CALL    SETTMSX
0008F4 D61B FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
0008F8 D61F CD57DC          17      CALL    SOPENX
0008FB D622 3F               4      CCF
0008FC D623 CC9ED5          17      CALL    Z,_S16K
0008FF D626 D436DD          17      CALL    NC,COPEN
000902 D629 D48CDF          17      CALL    NC,SDIRENT
000905 D62C C3C0D4          10      JP  _S16XX
                                
       D62F                     _SYS21:     ;(BDOS)ランダムな読み出し
000908 D62F CD2DDC          17      CALL    SETDRV
00090B D632 CDC8E0          17      CALL    INIT_RND
00090E D635 189C            12      JR  SREAD
                                
       D637                     _SYS22:     ;(BDOS)ランダムな書き込み
       D637                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000910 D637 CD2DDC          17      CALL    SETDRV
000913 D63A CDC8E0          17      CALL    INIT_RND
000916 D63D 18AA            12      JR  SWRITE
                                
       D63F                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000918 D63F 21FF00          10      LD  HL,000FFH
00091B D642 AF               4      XOR A
00091C D643 C9              10      RET
                                
       D644                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
00091D D644 3A0400          13      LD  A,(_DVSW)   ;from LDOS
000920 D647 A7               4      AND A
000921 D648 C9              10      RET
                                
       D649                     _SYS1A:     ;(BDOS)DTAの設定
000922 D649 ED538AF0        20      LD  (_DTA),DE
000926 D64D AF               4      XOR A
000927 D64E C9              10      RET
                                
       D64F                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000928 D64F 7B               4      LD  A,E
000929 D650 CD3BDC          17      CALL    GETDRV
00092C D653 CDDCF0          17      CALL    _GETDPB
00092F D656 D4E2F0          17      CALL    NC,_RDFATX
000932 D659 210000          10      LD  HL,0
000935 D65C D456E0          17      CALL    NC,DSKF
                                
000938 D65F ED5B57E0        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
00093C D663 1B               6      DEC DE      ;DE←クラスタの総数
00093D D664 FD2A7CF1        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000941 D668 9F               4      SBC A,A
000942 D669 D8              11      RET C
000943 D66A 4F               4      LD  C,A     ;C=0
000944 D66B DD7E0F          19      LD  A,(IX+DPB_BPS)
000947 D66E E607             7      AND 7
000949 D670 47               4      LD  B,A
00094A D671 DD7E07          19      LD  A,(IX+DPB_SECPCL)
00094D D674 C9              10      RET
                                
       D675                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
00094E D675 AF               4      XOR A
00094F D676 67               4      LD  H,A
000950 D677 6F               4      LD  L,A
000951 D678 C9              10      RET
                                
       D679                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000952 D679 2100F2          10      LD  HL,_DEVICE
000955 D67C 7B               4      LD  A,E
000956 D67D C3DCF0          10      JP  _GETDPB
                                
       D680                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000959 D680 E5              11      PUSH    HL
00095A D681 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
00095C D683 CD45D4          17      CALL    BDOS0
00095F D686 381B            12      JR  C,_S23X1
                                
000961 D688 D5              11      PUSH    DE      ;EX DE,IY
000962 D689 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000964 D68B FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000967 D68E FD6E11          19      LD  L,(IY+17)   ;
00096A D691 FD6612          19      LD  H,(IY+18)   ;
00096D D694 C5              11      PUSH    BC      ;
00096E D695 FD4613          19      LD  B,(IY+19)   ;
000971 D698 CDBAE0          17      CALL    GET_CPM_R_SIZE
000974 D69B C1              10      POP BC
       D69C                     _S24X1:
000975 D69C CDDAE0          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000978 D69F FDE3            23      EX  (SP),IY     ;
00097A D6A1 D1              10      POP DE      ;
                                
00097B D6A2 AF               4      XOR A
       D6A3                     _S23X1:
00097C D6A3 E1              10      POP HL
00097D D6A4 C9              10      RET
                                
       D6A5                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
00097E D6A5 E5              11      PUSH    HL
00097F D6A6 D5              11      PUSH    DE      ;EX DE,IY
000980 D6A7 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000982 D6A9 CDF8E3          17      CALL    GETSEQ
000985 D6AC 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D6AE                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
000987 D6AE 2B               6      DEC HL
       D6AF                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000988 D6AF C5              11      PUSH    BC
000989 D6B0 E5              11      PUSH    HL
00098A D6B1 CD45DB          17      CALL    FILE
00098D D6B4 E1              10      POP HL
00098E D6B5 C1              10      POP BC
       D6B6                     S29X1:
00098F D6B6 C5              11      PUSH    BC
000990 D6B7 D5              11      PUSH    DE
000991 D6B8 E5              11      PUSH    HL
000992 D6B9 EB               4      EX  DE,HL
000993 D6BA AF               4      XOR A
000994 D6BB 3221F0          13      LD  (FDRV+13),A
000997 D6BE 2114F0          10      LD  HL,FDRV
00099A D6C1 011000          10      LD  BC,16
00099D D6C4 EDB0                    LDIR
00099F D6C6 E1              10      POP HL
0009A0 D6C7 D1              10      POP DE
0009A1 D6C8 C1              10      POP BC
0009A2 D6C9 C9              10      RET
                                
       D6CA                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
0009A3 D6CA C5              11      PUSH    BC
0009A4 D6CB 013EE7          10      LD  BC,DWT24B
0009A7 D6CE 1804            12      JR  S2FX
       D6D0                     _SYS2F:
0009A9 D6D0 C5              11      PUSH    BC
0009AA D6D1 0130E7          10      LD  BC,DRD24B
       D6D4                     S2FX:
0009AD D6D4 ED43EAD6        20      LD  (S2F_SWC),BC
0009B1 D6D8 CDDFF0          17      CALL    _FFLUSH
                                
0009B4 D6DB D5              11      PUSH    DE
0009B5 D6DC E5              11      PUSH    HL
0009B6 D6DD 7D               4      LD  A,L     ;Drive
0009B7 D6DE CDD9F0          17      CALL    _CHGDRV
0009BA D6E1 3809            12      JR  C,POP_HL_DE_BC_SBCAA_RET
0009BC D6E3 44               4      LD  B,H     ;Number of clusters
0009BD D6E4 2A8AF0          16      LD  HL,(_DTA)
                                
0009C0 D6E7 0E00             7      LD  C,0
0009C2 D6E9 CD30E7          17      CALL    DRD24B
       D6EA                     S2F_SWC EQU $-2
       D6EC                     POP_HL_DE_BC_SBCAA_RET:
0009C5 D6EC E1              10      POP HL
0009C6 D6ED D1              10      POP DE
0009C7 D6EE C1              10      POP BC
0009C8 D6EF 9F               4      SBC A,A
0009C9 D6F0 C9              10      RET
                                
       D6F1                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
0009CA D6F1 C5              11      PUSH    BC
0009CB D6F2 D5              11      PUSH    DE
0009CC D6F3 E5              11      PUSH    HL
0009CD D6F4 CD3ADB          17      CALL    FILEC
0009D0 D6F7 21ECD6          10      LD  HL,POP_HL_DE_BC_SBCAA_RET
0009D3 D6FA E5              11      PUSH    HL
0009D4 D6FB 3A21F0          13      LD  A,(FDRV+13) ;(FCB)属性(アトリビュート))
0009D7 D6FE E610             7      AND 010H        ;ディレクトリ
0009D9 D700 37               4      SCF
0009DA D701 C8              11      RET Z
0009DB D702 1114F0          10      LD  DE,FDRV
0009DE D705 2A4EF1          16      LD  HL,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       D708                     JPHL:
0009E1 D708 E9               4      JP  (HL)
                                
       D709                     SHOW_ERROR:         ;(9)
0009E2 D709 1179F0          10      LD  DE,COMERM
0009E5 D70C CD76D4          17      CALL    _SYS09      ;(BDOS)文字列出力
0009E8 D70F C300F0          10      JP  CPM_BOOT
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "M7IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                
       D474                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D474                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D474                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D474                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D474                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D474                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
       D712                     POP_AF_HL_SCF_RET:
0009EB D712 F1              10      POP AF
0009EC D713 E1              10      POP HL
0009ED D714 37               4      SCF
       D715                     KEYBC_IFBREAK:
0009EE D715 C9              10      RET
                                
       D716                     _SYS01:     ;(BDOS)コンソール入力
0009EF D716 CD09F0          17      CALL    _SYS07
       D719                     MSG_A:
0009F2 D719 F5              11      PUSH    AF
0009F3 D71A D5              11      PUSH    DE
0009F4 D71B 5F               4      LD  E,A
0009F5 D71C CD22D7          17      CALL    _SYS02
0009F8 D71F D1              10      POP DE
0009F9 D720 F1              10      POP AF
0009FA D721 C9              10      RET
                                
       D722                     _SYS02:     ;(BDOS)コンソール出力
0009FB D722 CD34D7          17      CALL    BREAK
0009FE D725 1805            12      JR  PRINTX
                                
       D727                     _SYS06:     ;(BDOS)コンソール直接入出力
000A00 D727 7B               4      LD  A,E
000A01 D728 3C               4      INC A
000A02 D729 CACAF0          10      JP  Z,_INKEY
       D72C                     PRINTX:
000A05 D72C C3CDF0          10      JP  _PRINT
                                
       D72F                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000A08 D72F CD09F0          17      CALL    _SYS07
000A0B D732 1803            12      JR  BREAK1
       D734                     BREAK:
000A0D D734 CDCCDA          17      CALL    CHKEY
       D737                     BREAK1:
000A10 D737 FE03             7      CP  3       ;CTRL+C
000A12 D739 CCF4F0          17      CALL    Z,_BREAK
000A15 D73C FE13             7      CP  013H        ;CTRL+S
000A17 D73E C0              11      RET NZ
                                
       D73F                     PAUSE:
       D73F                     FLGET:
000A18 D73F CDDFF0          17      CALL    _FFLUSH
000A1B D742 E5              11      PUSH    HL
000A1C D743 2A8EF0          16      LD  HL,(_TXADR)
000A1F D746 7C               4      LD  A,H
000A20 D747 C6D0             7      ADD A,0D0H
000A22 D749 67               4      LD  H,A
000A23 D74A CD25CF          17      CALL    RDMMIO
000A26 D74D 3262D7          13      LD  (FLSMC),A
       D750                     FLGET1:
000A29 D750 CD1BCF          17      CALL    RD556VSYNC
000A2C D753 CB77             8      BIT 6,A
000A2E D755 3EEF             7      LD  A,0EFH      ;カーソル
000A30 D757 200A            12      JR  NZ,FLGET2
000A32 D759 3A92F0          13      LD  A,(_KEYD)
000A35 D75C B7               4      OR  A
000A36 D75D 3EEF             7      LD  A,0EFH      ;カーソル
000A38 D75F 2002            12      JR  NZ,FLGET2
000A3A D761 3E00             7      LD  A,0     ;自己書き換え
       D762                     FLSMC   EQU $-1
       D763                     FLGET2:
000A3C D763 CD2DCF          17      CALL    WRMMIO
000A3F D766 CDCAF0          17      CALL    _INKEY
000A42 D769 28E5            12      JR  Z,FLGET1
000A44 D76B F5              11      PUSH    AF
000A45 D76C 3A62D7          13      LD  A,(FLSMC)
000A48 D76F CD2DCF          17      CALL    WRMMIO
000A4B D772 F1              10      POP AF
000A4C D773 E1              10      POP HL
000A4D D774 C9              10      RET
                                
       D775                     _SYS0A:     ;(BDOS)文字列入力
000A4E D775 C5              11      PUSH    BC
000A4F D776 E5              11      PUSH    HL
000A50 D777 D5              11      PUSH    DE
000A51 D778 CD05DA          17      CALL    GETL
000A54 D77B 1130FF          10      LD  DE,KBUF
000A57 D77E E1              10      POP HL
000A58 D77F E5              11      PUSH    HL
000A59 D780 0E00             7      LD  C,0
000A5B D782 3004            12      JR  NC,SAX0
000A5D D784 23               6      INC HL
000A5E D785 23               6      INC HL
000A5F D786 1808            12      JR  SAX4
       D788                     SAX0:
000A61 D788 46               7      LD  B,(HL)
000A62 D789 23               6      INC HL
       D78A                     SAX1:
000A63 D78A 23               6      INC HL
000A64 D78B 1A               7      LD  A,(DE)
000A65 D78C 13               6      INC DE
000A66 D78D B7               4      OR  A
000A67 D78E 2004            12      JR  NZ,SAX2
       D790                     SAX4:
000A69 D790 360D            10      LD  (HL),00DH
000A6B D792 1804            12      JR  SAX3
       D794                     SAX2:
000A6D D794 77               7      LD  (HL),A
000A6E D795 0C               4      INC C
000A6F D796 10F2            13      DJNZ    SAX1
       D798                     SAX3:
000A71 D798 D1              10      POP DE
000A72 D799 79               4      LD  A,C
000A73 D79A 13               6      INC DE
000A74 D79B 12               7      LD  (DE),A
000A75 D79C 1B               6      DEC DE
000A76 D79D E1              10      POP HL
000A77 D79E C1              10      POP BC
000A78 D79F A7               4      AND A
000A79 D7A0 C9              10      RET
                                
       D7A1                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000A7A D7A1 CD34D7          17      CALL    BREAK
       D7A4                     CONSTX:
000A7D D7A4 AF               4      XOR A
000A7E D7A5 3299DA          13      LD  (SKIP_KEYWAIT),A
000A81 D7A8 CDCCDA          17      CALL    CHKEY
000A84 D7AB C8              11      RET Z
000A85 D7AC CDDFF0          17      CALL    _FFLUSH
000A88 D7AF 37               4      SCF
000A89 D7B0 9F               4      SBC A,A
000A8A D7B1 C9              10      RET
                                
       D7B2                     _SYS2A:     ;(BDOS)日付の獲得
000A8B D7B2 AF               4      XOR A
000A8C D7B3 57               4      LD  D,A
000A8D D7B4 5F               4      LD  E,A
000A8E D7B5 67               4      LD  H,A
000A8F D7B6 6F               4      LD  L,A
000A90 D7B7 C9              10      RET
                                
       D7B8                     _SYS2C:     ;(BDOS)時刻の獲得
000A91 D7B8 AF               4      XOR A
000A92 D7B9 57               4      LD  D,A
000A93 D7BA 5F               4      LD  E,A
000A94 D7BB 67               4      LD  H,A
000A95 D7BC 6F               4      LD  L,A
000A96 D7BD C9              10      RET
                                
       D7BE                     ESC1:
000A97 D7BE 7B               4      LD  A,E
000A98 D7BF FE41             7      CP  'A'
000A9A D7C1 CAB6D8          10      JP  Z,CTRL1E
000A9D D7C4 FE42             7      CP  'B'
000A9F D7C6 CAC8D9          10      JP  Z,CTRL1F
000AA2 D7C9 FE43             7      CP  'C'
000AA4 D7CB CA89D8          10      JP  Z,CTRL1C
000AA7 D7CE FE44             7      CP  'D'
000AA9 D7D0 CAADD8          10      JP  Z,CTRL1D
000AAC D7D3 FE45             7      CP  'E'
000AAE D7D5 2802            12      JR  Z,CT0CX
000AB0 D7D7 FE6A             7      CP  'j'
       D7D9                     CT0CX:
000AB2 D7D9 CAADD9          10      JP  Z,CTRL0C
000AB5 D7DC FE48             7      CP  'H'
000AB7 D7DE CA2AD9          10      JP  Z,CTRL0B
000ABA D7E1 FE4A             7      CP  'J'
000ABC D7E3 CAB0D9          10      JP  Z,CTRL06
000ABF D7E6 FE4B             7      CP  'K'
000AC1 D7E8 CAFCD8          10      JP  Z,CTRL05
000AC4 D7EB FE4C             7      CP  'L'
000AC6 D7ED CADAD9          10      JP  Z,CTRL0E
000AC9 D7F0 FE54             7      CP  'T'
000ACB D7F2 CAFCD8          10      JP  Z,CTRL05
000ACE D7F5 FE78             7      CP  'x'
000AD0 D7F7 2804            12      JR  Z,ESC1X
000AD2 D7F9 FE79             7      CP  'y'
000AD4 D7FB 2002            12      JR  NZ,ESC1Y
       D7FD                     ESC1X:
000AD6 D7FD 3601            10      LD  (HL),1
       D7FF                     ESC1Y:
000AD8 D7FF FE3D             7      CP  '='
000ADA D801 2804            12      JR  Z,ESC1W
000ADC D803 FE59             7      CP  'Y'
000ADE D805 2002            12      JR  NZ,ESC1Z
       D807                     ESC1W:
000AE0 D807 3602            10      LD  (HL),2
       D809                     ESC1Z:
000AE2 D809 FE20             7      CP  020H
000AE4 D80B 3802            12      JR  C,ESC1C
000AE6 D80D 87               4      ADD A,A
000AE7 D80E D0              11      RET NC
       D80F                     ESC1C:
000AE8 D80F E1              10      POP HL
000AE9 D810 1832            12      JR  ANK
                                
       D812                     ESC:
000AEB D812 2175D8          10      LD  HL,PRINTE5
000AEE D815 E5              11      PUSH    HL
000AEF D816 2138D8          10      LD  HL,ESCFLG
000AF2 D819 3600            10      LD  (HL),0
000AF4 D81B 3D               4      DEC A
000AF5 D81C 28A0            12      JR  Z,ESC1
000AF7 D81E 3D               4      DEC A
000AF8 D81F 2009            12      JR  NZ,ESC2
000AFA D821 3603            10      LD  (HL),3
000AFC D823 7B               4      LD  A,E
000AFD D824 D620             7      SUB 020H
000AFF D826 322DD8          13      LD  (ESCYP+1),A
000B02 D829 C9              10      RET
       D82A                     ESC2:
000B03 D82A 3D               4      DEC A
000B04 D82B C0              11      RET NZ
000B05 D82C 2600             7  ESCYP:  LD  H,0
000B07 D82E 7B               4      LD  A,E
000B08 D82F D620             7      SUB 020H
000B0A D831 6F               4      LD  L,A
000B0B D832 C3D6F0          10      JP  _LOC
                                
       D835                     PRINT:
000B0E D835 C5              11      PUSH    BC
000B0F D836 E5              11      PUSH    HL
000B10 D837 3E00             7      LD  A,000H      ;自己書き換え
       D838                     ESCFLG  EQU $-1
000B12 D839 B7               4      OR  A
000B13 D83A 20D6            12      JR  NZ,ESC
                                
000B15 D83C 3E1F             7      LD  A,01FH
000B17 D83E BB               4      CP  E
000B18 D83F 3038            12      JR  NC,CTRL
       D841                     INSFLG  EQU $
000B1A D841 0182D9          10      LD  BC,INSERT   ;自己書き換え
       D844                     ANK:
000B1D D844 3A96F0          13      LD  A,(_COLORF)
000B20 D847 4F               4      LD  C,A
000B21 D848 7B               4      LD  A,E
000B22 D849 FE61             7      CP  'a'     ;英小文字
000B24 D84B 3806            12      JR  C,PRT1
000B26 D84D FE7B             7      CP  'z'+1
000B28 D84F 3002            12      JR  NC,PRT1
000B2A D851 CBF9             8      SET 7,C
       D853                     PRT1:
000B2C D853 FE86             7      CP  $86     ;ひらがな1(を－そ)
000B2E D855 3806            12      JR  C,PRT2
000B30 D857 FEA0             7      CP  $A0
000B32 D859 3002            12      JR  NC,PRT2
000B34 D85B CBF9             8      SET 7,C
       D85D                     PRT2:
000B36 D85D FEE0             7      CP  $E0     ;ひらがな2(たーん)
000B38 D85F 3802            12      JR  C,PRT3
000B3A D861 CBF9             8      SET 7,C
       D863                     PRT3:
000B3C D863 2A8EF0          16      LD  HL,(_TXADR)
000B3F D866 7C               4      LD  A,H
000B40 D867 C6D0             7      ADD A,0D0H
000B42 D869 67               4      LD  H,A
000B43 D86A 42               4      LD  B,D
000B44 D86B 16EE             7      LD  D,CD_TABLE/256
000B46 D86D 1A               7      LD  A,(DE)
000B47 D86E 50               4      LD  D,B
000B48 D86F CD45CF          17      CALL    IO_PRINT
000B4B D872 CD89D8          17      CALL    CTRL1C
       D875                     PRINTE5:
000B4E D875 E1              10      POP HL
000B4F D876 C1              10      POP BC
000B50 D877 AF               4      XOR A
000B51 D878 C9              10      RET
                                
       D879                     CTRL:
000B52 D879 7B               4      LD  A,E
000B53 D87A 87               4      ADD A,A
000B54 D87B F680             7      OR  080H
000B56 D87D 6F               4      LD  L,A
000B57 D87E 26F1             7      LD  H,CTRLTB/256
000B59 D880 7E               7      LD  A,(HL)
000B5A D881 2C               4      INC L
000B5B D882 66               7      LD  H,(HL)
000B5C D883 6F               4      LD  L,A
000B5D D884 CD08D7          17      CALL    JPHL
000B60 D887 18EC            12      JR  PRINTE5
                                
       D889                     CTRL1C:
000B62 D889 ED4B8EF0        20      LD  BC,(_TXADR)
000B66 D88D 03               6      INC BC
       D88E                     PRINTE3:
000B67 D88E 2118FC          10      LD  HL,0-WIDTH*LINE
000B6A D891 A7               4      AND A
000B6B D892 ED4A            15      ADC HL,BC
       D894                     PRINTE8:
000B6D D894 2805            12      JR  Z,PRINT2
000B6F D896 ED438EF0        20      LD  (_TXADR),BC
       D89A                     CTRL00:
000B73 D89A C9              10      RET
                                
       D89B                     PRINT2:
000B74 D89B CDE0D9          17      CALL    SCR
000B77 D89E 21D8FF          10      LD  HL,0-WIDTH
000B7A D8A1 09              11      ADD HL,BC
       D8A2                     SET_TXADR_HL:
000B7B D8A2 228EF0          16      LD  (_TXADR),HL
000B7E D8A5 C9              10      RET
                                
       D8A6                     CTRL08:
000B7F D8A6 3A41D8          13      LD  A,(INSFLG)
000B82 D8A9 FECD             7      CP  0CDH        ;CALL ????
000B84 D8AB 2823            12      JR  Z,CTRL02
       D8AD                     CTRL1D:
000B86 D8AD 2A8EF0          16      LD  HL,(_TXADR)
000B89 D8B0 7C               4      LD  A,H
000B8A D8B1 B5               4      OR  L
000B8B D8B2 C8              11      RET Z
000B8C D8B3 2B               6      DEC HL
000B8D D8B4 18EC            12      JR  SET_TXADR_HL
                                
       D8B6                     CTRL1E:
000B8F D8B6 ED4B8EF0        20      LD  BC,(_TXADR)
000B93 D8BA 21D8FF          10      LD  HL,0-WIDTH
000B96 D8BD 09              11      ADD HL,BC
000B97 D8BE D0              11      RET NC
000B98 D8BF 18E1            12      JR  SET_TXADR_HL
                                
       D8C1                     CTRL09:
000B9A D8C1 ED4B8EF0        20      LD  BC,(_TXADR)
000B9E D8C5 79               4      LD  A,C
000B9F D8C6 E6F8             7      AND 0F8H
000BA1 D8C8 C608             7      ADD A,8
000BA3 D8CA 4F               4      LD  C,A
000BA4 D8CB 88               4      ADC A,B
000BA5 D8CC 91               4      SUB C
000BA6 D8CD 47               4      LD  B,A
000BA7 D8CE 18BE            12      JR  PRINTE3
                                
       D8D0                     CTRL02:
000BA9 D8D0 CDADD8          17      CALL    CTRL1D
000BAC D8D3 C8              11      RET Z
000BAD D8D4 D5              11      PUSH    DE
000BAE D8D5 CDD3F0          17      CALL    _POS
000BB1 D8D8 54               4      LD  D,H
000BB2 D8D9 3E28             7      LD  A,WIDTH
000BB4 D8DB 95               4      SUB L
000BB5 D8DC 4F               4      LD  C,A
000BB6 D8DD 0D               4      DEC C
000BB7 D8DE 06D0             7      LD  B,0D0H
000BB9 D8E0 2A8EF0          16      LD  HL,(_TXADR)
000BBC D8E3 09              11      ADD HL,BC
000BBD D8E4 47               4      LD  B,A
                                
000BBE D8E5 3A9ED9          13      LD  A,(MULINE)
000BC1 D8E8 BA               4      CP  D
000BC2 D8E9 2007            12      JR  NZ,C02X1
000BC4 D8EB 112800          10      LD  DE,WIDTH
000BC7 D8EE 19              11      ADD HL,DE
000BC8 D8EF 78               4      LD  A,B
000BC9 D8F0 83               4      ADD A,E
000BCA D8F1 47               4      LD  B,A
       D8F2                     C02X1:
000BCB D8F2 3A96F0          13      LD  A,(_COLORF) ;C:Color
000BCE D8F5 4F               4      LD  C,A
000BCF D8F6 AF               4      XOR A       ;A:Text
000BD0 D8F7 CD8CCF          17      CALL    IO_BS
000BD3 D8FA D1              10      POP DE
000BD4 D8FB C9              10      RET
                                
       D8FC                     CTRL05:
000BD5 D8FC CDD3F0          17      CALL    _POS
000BD8 D8FF 3E28             7      LD  A,WIDTH
000BDA D901 95               4      SUB L
000BDB D902 47               4      LD  B,A
       D903                     C08X1:
000BDC D903 2A8EF0          16      LD  HL,(_TXADR)
000BDF D906 7C               4      LD  A,H
000BE0 D907 C6D0             7      ADD A,0D0H
000BE2 D909 67               4      LD  H,A
       D90A                     CLLINE:
000BE3 D90A 3A96F0          13      LD  A,(_COLORF)
000BE6 D90D 4F               4      LD  C,A
000BE7 D90E AF               4      XOR A
000BE8 D90F C36FCF          10      JP  IO_CLLINE
                                
       D912                     CTRL0D:
000BEB D912 CDD3F0          17      CALL    _POS
000BEE D915 2E00             7      LD  L,0
       D917                     LOC:
000BF0 D917 C5              11      PUSH    BC
000BF1 D918 E5              11      PUSH    HL
000BF2 D919 CD37D9          17      CALL    LOC1
000BF5 D91C 228EF0          16      LD  (_TXADR),HL
000BF8 D91F E1              10      POP HL
000BF9 D920 C1              10      POP BC
000BFA D921 C9              10      RET
                                
       D922                     CTRL12:
000BFB D922 2141D8          10      LD  HL,INSFLG
000BFE D925 7E               7      LD  A,(HL)
000BFF D926 EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
000C01 D928 77               7      LD  (HL),A
000C02 D929 C9              10      RET
                                
       D92A                     CTRL0B:
000C03 D92A 210000          10      LD  HL,0
000C06 D92D 228EF0          16      LD  (_TXADR),HL
000C09 D930 C9              10      RET
                                
       D931                     CTRL1B:
000C0A D931 3E01             7      LD  A,1
000C0C D933 3238D8          13      LD  (ESCFLG),A
000C0F D936 C9              10      RET
                                
       D937                     LOC1:
000C10 D937 D5              11      PUSH    DE
000C11 D938 4D               4      LD  C,L
000C12 D939 0608             7      LD  B,8
000C14 D93B 5C               4      LD  E,H
000C15 D93C 210028          10      LD  HL,WIDTH*256
000C18 D93F 55               4      LD  D,L ;L=0
       D940                     LOC2:
000C19 D940 29              11      ADD HL,HL
000C1A D941 3001            12      JR  NC,LOC3
000C1C D943 19              11      ADD HL,DE
       D944                     LOC3:
000C1D D944 10FA            13      DJNZ    LOC2
000C1F D946 09              11      ADD HL,BC
000C20 D947 D1              10      POP DE
000C21 D948 C9              10      RET
                                
       D949                     CONOUT1:
                                ;   CALL    CURSOR
000C22 D949 59               4      LD  E,C
000C23 D94A CDCDF0          17      CALL    _PRINT
000C26 D94D 7B               4      LD  A,E
000C27 D94E FE0A             7      CP  00AH
000C29 D950 2006            12      JR  NZ,CURSOR
000C2B D952 CD12D9          17      CALL    CTRL0D
000C2E D955 CDFCD8          17      CALL    CTRL05
       D958                     CURSOR:
000C31 D958 C9              10      RET
                                
       D959                     CTRL07:
000C32 D959 06E0             7      LD  B,0E0H
000C34 D95B 2162F0          10      LD  HL,BEEPD+1
       D95E                     C07X0:
000C37 D95E 4E               7      LD  C,(HL)
000C38 D95F 23               6      INC HL
000C39 D960 7E               7      LD  A,(HL)
000C3A D961 23               6      INC HL
000C3B D962 CD3DCF          17      CALL    WRMMIO_BC
000C3E D965 7D               4      LD  A,L
000C3F D966 FE6A             7      CP  (BEEPD+1+M7BEEPE-M7BEEPD)&255
000C41 D968 20F4            12      JR  NZ,C07X0
000C43 D96A 0610             7      LD  B,16
       D96C                     C07X1:
000C45 D96C CD1BCF          17      CALL    RD556VSYNC
000C48 D96F 87               4      ADD A,A
000C49 D970 30FA            12      JR  NC,C07X1
       D972                     C07X2:
000C4B D972 CD1BCF          17      CALL    RD556VSYNC
000C4E D975 87               4      ADD A,A
000C4F D976 38FA            12      JR  C,C07X2
000C51 D978 10F2            13      DJNZ    C07X1
                                
000C53 D97A AF               4      XOR A
000C54 D97B 2108E0          10      LD  HL,0E008H
000C57 D97E CD2DCF          17      CALL    WRMMIO
000C5A D981 C9              10      RET
                                
       D982                     INSERT:
000C5B D982 D5              11      PUSH    DE
000C5C D983 CDD3F0          17      CALL    _POS
000C5F D986 54               4      LD  D,H
000C60 D987 3E28             7      LD  A,WIDTH
000C62 D989 95               4      SUB L
000C63 D98A 47               4      LD  B,A
000C64 D98B 2A8EF0          16      LD  HL,(_TXADR)
000C67 D98E 7C               4      LD  A,H
000C68 D98F C6D0             7      ADD A,0D0H
000C6A D991 67               4      LD  H,A
000C6B D992 3A96F0          13      LD  A,(_COLORF) ;C:Color
000C6E D995 4F               4      LD  C,A
000C6F D996 AF               4      XOR A       ;A:Text
000C70 D997 CD7FCF          17      CALL    IO_INS
000C73 D99A B7               4      OR  A
000C74 D99B 2005            12      JR  NZ,INS1
       D99E                     MULINE  EQU $+1
000C76 D99D 3EFF             7      LD  A,-1
000C78 D99F 92               4      SUB D
000C79 D9A0 2009            12      JR  NZ,INS2
       D9A2                     INS1:
000C7B D9A2 0628             7      LD  B,WIDTH
000C7D D9A4 CD7FCF          17      CALL    IO_INS
000C80 D9A7 7A               4      LD  A,D
000C81 D9A8 329ED9          13      LD  (MULINE),A
       D9AB                     INS2:
000C84 D9AB D1              10      POP DE
000C85 D9AC C9              10      RET
                                
       D9AD                     CTRL0C:
000C86 D9AD CD2AD9          17      CALL    CTRL0B
       D9B0                     CTRL06:
000C89 D9B0 D5              11      PUSH    DE
000C8A D9B1 E5              11      PUSH    HL
000C8B D9B2 ED5B8EF0        20      LD  DE,(_TXADR)
000C8F D9B6 3A96F0          13      LD  A,(_COLORF)
000C92 D9B9 325CCF          13      LD  (ICSMC),A
000C95 D9BC C350CF          10      JP  IO_CLR
                                
       D9BF                     CTRL04:
000C98 D9BF CDD3F0          17      CALL    _POS
000C9B D9C2 7D               4      LD  A,L
000C9C D9C3 B7               4      OR  A
000C9D D9C4 C8              11      RET Z
       D9C5                     CTRL03:
000C9E D9C5 CD12D9          17      CALL    CTRL0D
       D9C8                     CTRL0A:
       D9C8                     CTRL1F:
000CA1 D9C8 2A8EF0          16      LD  HL,(_TXADR)
000CA4 D9CB 012800          10      LD  BC,WIDTH
000CA7 D9CE 09              11      ADD HL,BC
000CA8 D9CF 44               4      LD  B,H
000CA9 D9D0 4D               4      LD  C,L
000CAA D9D1 2118FC          10      LD  HL,0-WIDTH*LINE
000CAD D9D4 09              11      ADD HL,BC
000CAE D9D5 3F               4      CCF
000CAF D9D6 9F               4      SBC A,A
000CB0 D9D7 C394D8          10      JP  PRINTE8
                                
       D9DA                     CTRL0E:
000CB3 D9DA CDD3F0          17      CALL    _POS
000CB6 D9DD 7C               4      LD  A,H
000CB7 D9DE 1804            12      JR  SCR1
       D9E0                     SCR:
000CB9 D9E0 3A97F0          13      LD  A,(_LINE)
000CBC D9E3 3D               4      DEC A
       D9E4                     SCR1:
000CBD D9E4 C5              11      PUSH    BC
000CBE D9E5 D5              11      PUSH    DE
000CBF D9E6 E5              11      PUSH    HL
000CC0 D9E7 1100D0          10      LD  DE,0D000H
000CC3 D9EA 2128D0          10      LD  HL,0D000H+WIDTH
                                
000CC6 D9ED 47               4      LD  B,A
000CC7 D9EE B7               4      OR  A
000CC8 D9EF C3A4CF          10      JP  IO_SCRUP
                                
       D9F2                     POS:
000CCB D9F2 2A8EF0          16      LD  HL,(_TXADR)
000CCE D9F5 C5              11      PUSH    BC
000CCF D9F6 01D8FF          10      LD  BC,0-WIDTH
000CD2 D9F9 AF               4      XOR A
       D9FA                     POS1:
000CD3 D9FA 09              11      ADD HL,BC
000CD4 D9FB 3C               4      INC A
000CD5 D9FC 38FC            12      JR  C,POS1
000CD7 D9FE ED42            15      SBC HL,BC
000CD9 DA00 3D               4      DEC A
000CDA DA01 67               4      LD  H,A
000CDB DA02 C1              10      POP BC
000CDC DA03 A7               4      AND A
000CDD DA04 C9              10      RET
                                
       DA05                     GETL:
000CDE DA05 CDD3F0          17      CALL    _POS
000CE1 DA08 E5              11      PUSH    HL
000CE2 DA09 3ECD             7      LD  A,0CDH      ;CALL ????
000CE4 DA0B 3241D8          13      LD  (INSFLG),A
       DA0E                     GETL1:
000CE7 DA0E CD2FD7          17      CALL    _SYS08
000CEA DA11 FE09             7      CP  9
000CEC DA13 2008            12      JR  NZ,GETL1V
000CEE DA15 2130FF          10      LD  HL,KBUF
000CF1 DA18 CD85D4          17      CALL    MSX
000CF4 DA1B 18F1            12      JR  GETL1
       DA1D                     GETL1V:
000CF6 DA1D 5F               4      LD  E,A
000CF7 DA1E CDD3F0          17      CALL    _POS
000CFA DA21 CDCDF0          17      CALL    _PRINT
000CFD DA24 7B               4      LD  A,E
000CFE DA25 FE20             7      CP  $20
000D00 DA27 3809            12      JR  C,GETL1V1
000D02 DA29 7D               4      LD  A,L
000D03 DA2A FE27             7      CP  WIDTH-1
000D05 DA2C 2004            12      JR  NZ,GETL1V1
000D07 DA2E 7C               4      LD  A,H
000D08 DA2F 329ED9          13      LD  (MULINE),A
       DA32                     GETL1V1:
000D0B DA32 7B               4      LD  A,E
000D0C DA33 FE0D             7      CP  00DH
000D0E DA35 20D7            12      JR  NZ,GETL1
000D10 DA37 3E01             7      LD  A,1     ;LD BC,????
000D12 DA39 3241D8          13      LD  (INSFLG),A
000D15 DA3C 1130FF          10      LD  DE,KBUF
000D18 DA3F 0628             7      LD  B,WIDTH
000D1A DA41 CD23D3          17      CALL    ZERO_MEMORY_DE
                                
000D1D DA44 D1              10      POP DE
000D1E DA45 CDD3F0          17      CALL    _POS
000D21 DA48 6B               4      LD  L,E
000D22 DA49 3E28             7      LD  A,WIDTH
000D24 DA4B 95               4      SUB L
000D25 DA4C 57               4      LD  D,A
                                
000D26 DA4D 3A9ED9          13      LD  A,(MULINE)
000D29 DA50 94               4      SUB H
000D2A DA51 2806            12      JR  Z,GL2X
000D2C DA53 3C               4      INC A
000D2D DA54 200C            12      JR  NZ,GL3X
000D2F DA56 25               4      DEC H
000D30 DA57 1805            12      JR  GL4X
       DA59                     GL2X:
000D32 DA59 3E1F             7      LD  A,$1F
000D34 DA5B CD19D7          17      CALL    MSG_A
       DA5E                     GL4X:
000D37 DA5E 7A               4      LD  A,D
000D38 DA5F C628             7      ADD A,WIDTH
000D3A DA61 57               4      LD  D,A
       DA62                     GL3X:
000D3B DA62 CD37D9          17      CALL    LOC1
000D3E DA65 4D               4      LD  C,L
000D3F DA66 7C               4      LD  A,H
000D40 DA67 C6D0             7      ADD A,0D0H
000D42 DA69 47               4      LD  B,A
000D43 DA6A 5A               4      LD  E,D
000D44 DA6B 2130FF          10      LD  HL,KBUF
       DA6E                     GETL2:
000D47 DA6E CDD0F0          17      CALL    _SCRN
000D4A DA71 03               6      INC BC
000D4B DA72 77               7      LD  (HL),A
000D4C DA73 23               6      INC HL
000D4D DA74 1D               4      DEC E
000D4E DA75 20F7            12      JR  NZ,GETL2
       DA77                     GETL3:
000D50 DA77 2B               6      DEC HL
000D51 DA78 7E               7      LD  A,(HL)
000D52 DA79 FE21             7      CP  021H
000D54 DA7B D0              11      RET NC
000D55 DA7C 3600            10      LD  (HL),0
000D57 DA7E 15               4      DEC D
000D58 DA7F 20F6            12      JR  NZ,GETL3
000D5A DA81 C9              10      RET
                                
       DA82                     INKEYB:
000D5B DA82 C1              10      POP BC
000D5C DA83 CB47             8      BIT 0,A
000D5E DA85 3E08             7      LD  A,8
000D60 DA87 2002            12      JR  NZ,INKEYD
000D62 DA89 3E03             7      LD  A,3
       DA8B                     INKEYD:
000D64 DA8B 3292F0          13      LD  (_KEYD),A
000D67 DA8E B7               4      OR  A
000D68 DA8F C9              10      RET
       DA90                     INKEY:
000D69 DA90 E5              11      PUSH    HL
       DA91                     GETKEY:
000D6A DA91 3A92F0          13      LD  A,(_KEYD)
000D6D DA94 B7               4      OR  A
000D6E DA95 6F               4      LD  L,A
000D6F DA96 2610             7      LD  H,16
       DA97                     GKSMC   EQU $-1
       DA98                     GETKEY1:
000D71 DA98 3E01             7      LD  A,1
       DA99                     SKIP_KEYWAIT:   EQU $-1
000D73 DA9A B7               4      OR  A
000D74 DA9B C4CCDA          17      CALL    NZ,CHKEY    ;キーを離すまで待つ
000D77 DA9E 281E            12      JR  Z,GETKEY2
000D79 DAA0 BD               4      CP  L
000D7A DAA1 201B            12      JR  NZ,GETKEY2
000D7C DAA3 CD1BCF          17      CALL    RD556VSYNC
000D7F DAA6 87               4      ADD A,A
000D80 DAA7 30EF            12      JR  NC,GETKEY1
       DAA9                     GETKEY1X:
000D82 DAA9 CDCCDA          17      CALL    CHKEY       ;キーを離すまで待つ
000D85 DAAC 2810            12      JR  Z,GETKEY2
000D87 DAAE BD               4      CP  L
000D88 DAAF 200D            12      JR  NZ,GETKEY2
000D8A DAB1 CD1BCF          17      CALL    RD556VSYNC
000D8D DAB4 87               4      ADD A,A
000D8E DAB5 38F2            12      JR  C,GETKEY1X
000D90 DAB7 25               4      DEC H
000D91 DAB8 20DE            12      JR  NZ,GETKEY1
000D93 DABA 3E01             7      LD  A,1
000D95 DABC 1805            12      JR  GETKEY3
       DABE                     GETKEY2:
000D97 DABE 3E10             7      LD  A,16
000D99 DAC0 3299DA          13      LD  (SKIP_KEYWAIT),A
       DAC3                     GETKEY3:
000D9C DAC3 3297DA          13      LD  (GKSMC),A
000D9F DAC6 3A92F0          13      LD  A,(_KEYD)
000DA2 DAC9 B7               4      OR  A
000DA3 DACA E1              10      POP HL
000DA4 DACB C0              11      RET NZ
       DACC                     CHKEY:
000DA5 DACC C5              11      PUSH    BC
000DA6 DACD 3E08             7      LD  A,8
000DA8 DACF CD0ECF          17      CALL    RDKEYDATA
000DAB DAD2 3293F0          13      LD  (_KEYD+1),A
000DAE DAD5 CB7F             8      BIT 7,A
000DB0 DAD7 28A9            12      JR  Z,INKEYB
000DB2 DAD9 E5              11      PUSH    HL
000DB3 DADA 0E07             7      LD  C,7
000DB5 DADC 2140ED          10      LD  HL,KEY_TABLE
000DB8 DADF CB47             8      BIT 0,A
000DBA DAE1 2003            12      JR  NZ,CHKEY0
000DBC DAE3 2180ED          10      LD  HL,SHIFT_TABLE
       DAE6                     CHKEY0:
000DBF DAE6 CB77             8      BIT 6,A
000DC1 DAE8 2003            12      JR  NZ,CHKEY1
000DC3 DAEA 21C0ED          10      LD  HL,CTRL_TABLE
       DAED                     CHKEY1:
000DC6 DAED 79               4      LD  A,C
000DC7 DAEE CD0ECF          17      CALL    RDKEYDATA
000DCA DAF1 0608             7      LD  B,8
       DAF3                     CHKEY2:
000DCC DAF3 87               4      ADD A,A
000DCD DAF4 3009            12      JR  NC,CHKEY3
000DCF DAF6 23               6      INC HL
000DD0 DAF7 10FA            13      DJNZ    CHKEY2
000DD2 DAF9 0D               4      DEC C
000DD3 DAFA 79               4      LD  A,C
000DD4 DAFB 3C               4      INC A
000DD5 DAFC 20EF            12      JR  NZ,CHKEY1
000DD7 DAFE 06                      DB  $06     ;LD B,?? 次の1バイトを飛ばす
       DAFF                     CHKEY3:
000DD8 DAFF 7E               7      LD  A,(HL)
000DD9 DB00 E1              10      POP HL
000DDA DB01 C1              10      POP BC
000DDB DB02 1887            12      JR  INKEYD
                                
       DB04                     SCRN:
000DDD DB04 E5              11      PUSH    HL
000DDE DB05 CD35CF          17      CALL    RDMMIO_BC
000DE1 DB08 6F               4      LD  L,A
000DE2 DB09 26EF             7      LD  H,DC_TABLE/256
000DE4 DB0B 7E               7      LD  A,(HL)
000DE5 DB0C FE41             7      CP  'A'     ;英小文字チェック
000DE7 DB0E 380E            12      JR  C,SCRN1
000DE9 DB10 FE5B             7      CP  'Z'+1
000DEB DB12 DC20DB          17      CALL    C,SCRNC
000DEE DB15 FEA6             7      CP  $A6     ;ひらがなチェック
000DF0 DB17 3805            12      JR  C,SCRN1
000DF2 DB19 FEE0             7      CP  $E0
000DF4 DB1B DC20DB          17      CALL    C,SCRNC
       DB1E                     SCRN1:
000DF7 DB1E E1              10      POP HL
000DF8 DB1F C9              10      RET
                                
       DB20                     SCRNC:
000DF9 DB20 6F               4      LD  L,A
000DFA DB21 60               4      LD  H,B
000DFB DB22 CBD8             8      SET 3,B
000DFD DB24 CD35CF          17      CALL    RDMMIO_BC
000E00 DB27 44               4      LD  B,H
000E01 DB28 CB7F             8      BIT 7,A
000E03 DB2A 7D               4      LD  A,L
000E04 DB2B C8              11      RET Z
000E05 DB2C FE5B             7      CP  'Z'+1
000E07 DB2E 3804            12      JR  C,SCRNC_ADD
000E09 DB30 FEC0             7      CP  $C0
000E0B DB32 3803            12      JR  C,SCRNC_SUB
       DB34                     SCRNC_ADD:
000E0D DB34 C620             7      ADD A,$20
000E0F DB36 C9              10      RET
       DB37                     SCRNC_SUB:
000E10 DB37 D620             7      SUB $20
000E12 DB39 C9              10      RET
[EOF:M7IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
                                ;   【注意】バイナリサイズを下位1バイトを0丁度に調整する必要あり(X1/88)
       0000                     CHECK_FILE_SIZE EQU (FILEC-FILE_E) & 0FFH
       DB3A                     FILEC:
000E13 DB3A CD45DB          17      CALL    FILE
       DB3D                     FILEC2:
000E16 DB3D 3A15F0          13      LD  A,(FDRV+1)
000E19 DB40 FE20             7      CP  020H
000E1B DB42 C8              11      RET Z
000E1C DB43 1839            12      JR  SETDIR1
                                
       DB45                     FILE:
000E1E DB45 AF               4      XOR A
000E1F DB46 3214F0          13      LD  (FDRV),A
000E22 DB49 67               4      LD  H,A
000E23 DB4A 6F               4      LD  L,A
000E24 DB4B 2222F0          16      LD  (FDRV+14),HL
000E27 DB4E CD1BDC          17      CALL    SPCUT
000E2A DB51 CD00DC          17      CALL    CCHK3
000E2D DB54 2812            12      JR  Z,DEVI1
000E2F DB56 13               6      INC DE
000E30 DB57 1A               7      LD  A,(DE)
000E31 DB58 1B               6      DEC DE
000E32 DB59 FE3A             7      CP  ':'
000E34 DB5B 200B            12      JR  NZ,DEVI1
000E36 DB5D 1A               7      LD  A,(DE)      ;DRIVE
000E37 DB5E CD61DE          17      CALL    CAP
000E3A DB61 D640             7      SUB '@'
000E3C DB63 13               6      INC DE
000E3D DB64 13               6      INC DE
000E3E DB65 3214F0          13      LD  (FDRV),A
       DB68                     DEVI1:
000E41 DB68 1A               7      LD  A,(DE)
000E42 DB69 D65C             7      SUB 05CH        ;\
000E44 DB6B 2009            12      JR  NZ,NOROOT
000E46 DB6D 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
000E47 DB6E 222EF0          16      LD  (FDRV+26),HL
000E4A DB71 2C               4      INC L
000E4B DB72 2222F0          16      LD  (FDRV+14),HL
000E4E DB75 13               6      INC DE
       DB76                     NOROOT:
                                
       DB76                     SETDIR:
000E4F DB76 CDA1DB          17      CALL    FILED
000E52 DB79 1A               7      LD  A,(DE)
000E53 DB7A FE5C             7      CP  05CH        ;\
000E55 DB7C C0              11      RET NZ
000E56 DB7D 13               6      INC DE
       DB7E                     SETDIR1:
000E57 DB7E 3E10             7      LD  A,010H      ;Directory
000E59 DB80 3221F0          13      LD  (FDRV+13),A
000E5C DB83 D5              11      PUSH    DE
000E5D DB84 1114F0          10      LD  DE,FDRV
000E60 DB87 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
000E62 DB89 CD45D4          17      CALL    BDOS0
000E65 DB8C D1              10      POP DE
000E66 DB8D B7               4      OR  A
000E67 DB8E C0              11      RET NZ
                                
000E68 DB8F 3A21F0          13      LD  A,(FDRV+13)
000E6B DB92 E610             7      AND 010H        ;ディレクトリ
000E6D DB94 C8              11      RET Z
                                
000E6E DB95 CDE8DB          17      CALL    FILEI
000E71 DB98 2A2EF0          16      LD  HL,(FDRV+26)
000E74 DB9B 23               6      INC HL
000E75 DB9C 2222F0          16      LD  (FDRV+14),HL
000E78 DB9F 18D5            12      JR  SETDIR
                                
       DBA1                     FILED:
000E7A DBA1 CDE8DB          17      CALL    FILEI
000E7D DBA4 2115F0          10      LD  HL,FNAME
                                
000E80 DBA7 0608             7      LD  B,8
       DBA9                     FILE2:
000E82 DBA9 CDF5DB          17      CALL    CCHKF
000E85 DBAC C8              11      RET Z
000E86 DBAD FE2A             7      CP  '*'
000E88 DBAF 282E            12      JR  Z,FILE9
000E8A DBB1 FE2E             7      CP  '.'
000E8C DBB3 280C            12      JR  Z,FILE4
000E8E DBB5 77               7      LD  (HL),A
000E8F DBB6 23               6      INC HL
000E90 DBB7 10F0            13      DJNZ    FILE2
                                
       DBB9                     FILE3:
000E92 DBB9 CDF5DB          17      CALL    CCHKF
000E95 DBBC C8              11      RET Z
000E96 DBBD FE2E             7      CP  '.'
000E98 DBBF 20F8            12      JR  NZ,FILE3
                                
       DBC1                     FILE4:
000E9A DBC1 211DF0          10      LD  HL,FNAME+8
000E9D DBC4 0603             7      LD  B,3
                                
       DBC6                     FILE4L:
000E9F DBC6 CDF5DB          17      CALL    CCHKF
000EA2 DBC9 C8              11      RET Z
000EA3 DBCA FE2E             7      CP  '.'
000EA5 DBCC 2008            12      JR  NZ,FILE12
000EA7 DBCE 3215F0          13      LD  (FNAME),A   ;Parent directory(..)
000EAA DBD1 3216F0          13      LD  (FNAME+1),A
000EAD DBD4 3E20             7      LD  A,020H
       DBD6                     FILE12:
000EAF DBD6 FE2A             7      CP  '*'
000EB1 DBD8 280A            12      JR  Z,FILE10
000EB3 DBDA 77               7      LD  (HL),A
000EB4 DBDB 23               6      INC HL
000EB5 DBDC 10E8            13      DJNZ    FILE4L
000EB7 DBDE C9              10      RET
                                
       DBDF                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000EB8 DBDF CDE4DB          17      CALL    FILE10
000EBB DBE2 18D5            12      JR  FILE3
                                
       DBE4                     FILE10:
000EBD DBE4 3E3F             7      LD  A,'?'
000EBF DBE6 1808            12      JR  FILL_MEMORY
       DBE8                     FILEI:              ;名前＋拡張子をスペースで初期化
000EC1 DBE8 3E20             7      LD  A,020H
000EC3 DBEA 01000B          10      LD  BC,11*256   ;C=0にしておく
000EC6 DBED 2115F0          10      LD  HL,FNAME
       DBF0                     FILL_MEMORY:            ;HLからBバイトAで埋める
000EC9 DBF0 77               7      LD  (HL),A
000ECA DBF1 23               6      INC HL
000ECB DBF2 10FC            13      DJNZ    FILL_MEMORY
000ECD DBF4 C9              10      RET
                                
       DBF5                     CCHKF:
000ECE DBF5 1A               7      LD  A,(DE)
000ECF DBF6 CDFDDB          17      CALL    CCHK2
000ED2 DBF9 C8              11      RET Z
000ED3 DBFA C369DF          10      JP  FKAN
                                
       DBFD                     CCHK2:
000ED6 DBFD 0C               4      INC C
000ED7 DBFE 0D               4      DEC C
000ED8 DBFF C0              11      RET NZ
       DC00                     CCHK3:              ;ZF=1 で使えない文字
000ED9 DC00 FE2B             7      CP  '+'
000EDB DC02 C8              11      RET Z
000EDC DC03 FE2C             7      CP  ','
000EDE DC05 C8              11      RET Z
000EDF DC06 FE2F             7      CP  '/'
000EE1 DC08 C8              11      RET Z
000EE2 DC09 FE3A             7      CP  ':'
000EE4 DC0B C8              11      RET Z
000EE5 DC0C FE3B             7      CP  ';'
000EE7 DC0E C8              11      RET Z
000EE8 DC0F FE3D             7      CP  '='
000EEA DC11 C8              11      RET Z
000EEB DC12 FE5C             7      CP  05CH    ;\
000EED DC14 C8              11      RET Z
000EEE DC15 FE20             7      CP  020H
000EF0 DC17 D0              11      RET NC
000EF1 DC18 BF               4      CP  A       ;Z=1
000EF2 DC19 C9              10      RET
                                
       DC1A                     SS1:
000EF3 DC1A 13               6      INC DE
       DC1B                     SPCUT:              ;スペースをカット
000EF4 DC1B 1A               7      LD  A,(DE)
000EF5 DC1C FE20             7      CP  020H
000EF7 DC1E 28FA            12      JR  Z,SS1
000EF9 DC20 C9              10      RET
                                
       DC21                     SETDRVF:
000EFA DC21 1114F0          10      LD  DE,FDRV
       DC24                     SETDRV0:
000EFD DC24 CD2DDC          17      CALL    SETDRV
000F00 DC27 FDE1            14      POP IY
000F02 DC29 C1              10      POP BC
000F03 DC2A D1              10      POP DE
000F04 DC2B E1              10      POP HL
000F05 DC2C C9              10      RET
                                
       DC2D                     SETDRV:
000F06 DC2D E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
000F07 DC2E D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
000F08 DC2F C5              11      PUSH    BC
000F09 DC30 1A               7      LD  A,(DE)
000F0A DC31 D5              11      PUSH    DE
000F0B DC32 FDE3            23      EX  (SP),IY
                                
000F0D DC34 CD3BDC          17      CALL    GETDRV
000F10 DC37 CDD9F0          17      CALL    _CHGDRV
                                
000F13 DC3A E9               4      JP  (HL)
                                
       DC3B                     GETDRV:
000F14 DC3B CD4EDC          17      CALL    GETDRV1
000F17 DC3E 3288F0          13      LD  (_DRV),A
000F1A DC41 C9              10      RET
                                
       DC42                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
000F1B DC42 CD4EDC          17      CALL    GETDRV1
000F1E DC45 C5              11      PUSH    BC
000F1F DC46 4F               4      LD  C,A
000F20 DC47 1A               7      LD  A,(DE)
000F21 DC48 CD4EDC          17      CALL    GETDRV1
000F24 DC4B A9               4      XOR C
000F25 DC4C C1              10      POP BC
000F26 DC4D C9              10      RET
       DC4E                     GETDRV1:
000F27 DC4E E67F             7      AND 07FH
000F29 DC50 D601             7      SUB 001H
000F2B DC52 D0              11      RET NC
000F2C DC53 3A0400          13      LD  A,(_DVSW)   ;Current Drive
000F2F DC56 C9              10      RET
                                
       DC57                     SOPENX:
000F30 DC57 1139F0          10      LD  DE,SFILE
000F33 DC5A FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
000F36 DC5D CD42DC          17      CALL    IS_SAME_DRV_A_DE
000F39 DC60 2024            12      JR  NZ,SOPEN
000F3B DC62 13               6      INC DE
000F3C DC63 FDE5            15      PUSH    IY
000F3E DC65 E1              10      POP HL
000F3F DC66 23               6      INC HL
000F40 DC67 CDF2DD          17      CALL    CPFILE
000F43 DC6A 201A            12      JR  NZ,SOPEN
                                
000F45 DC6C 2AF4F1          16      LD  HL,(SCDIR)
000F48 DC6F FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
000F4B DC72 FD740F          19      LD  (IY+15),H
                                
000F4E DC75 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
000F51 DC78 229FF0          16      LD  (_FILEN),HL
                                
000F54 DC7B ED5BF6F1        20      LD  DE,(SFBPS)
000F58 DC7F 2139F0          10      LD  HL,SFILE
000F5B DC82 36FF            10      LD  (HL),0FFH
000F5D DC84 23               6      INC HL
000F5E DC85 C9              10      RET
       DC86                     SOPEN:
000F5F DC86 219ADD          10      LD  HL,FILESE
       DC89                     SOPENC:
000F62 DC89 22C2DC          16      LD  (OPENPAT),HL
                                
000F65 DC8C CDE2F0          17      CALL    _RDFATX     ;Detect Media
000F68 DC8F 3856            12      JR  C,RDDERR
                                
000F6A DC91 AF               4      XOR A
000F6B DC92 329FF0          13      LD  (_FILEN),A
000F6E DC95 CD9EDE          17      CALL    LDDIRX1     ;A=0で呼び出す
000F71 DC98 2818            12      JR  Z,SDIRX1
                                
000F73 DC9A CD8BDD          17      CALL    READ_DIR    ;Sub Directory
000F76 DC9D 3808            12      JR  C,SDIRX0
000F78 DC9F 2A7EF1          16      LD  HL,(_DTBUF)
000F7B DCA2 7E               7      LD  A,(HL)
000F7C DCA3 FE2E             7      CP  '.'
000F7E DCA5 280F            12      JR  Z,SOPEN1
       DCA7                     SDIRX0:
000F80 DCA7 AF               4      XOR A
000F81 DCA8 32A0F0          13      LD  (_DIRF),A
000F84 DCAB FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
000F88 DCAF FD770F          19      LD  (IY+15),A
       DCB2                     SDIRX1:
000F8B DCB2 ED5BFCF1        20      LD  DE,(_DIRPS) ;Root Directory
       DCB6                     SOPEN1:
000F8F DCB6 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       DCB7                     SDECPAT EQU $-1
       DCB8                     SOPEN1X:
000F91 DCB8 CD8BDD          17      CALL    READ_DIR    ;FILE SEARCH
000F94 DCBB 382A            12      JR  C,RDDERR
000F96 DCBD 2A7EF1          16      LD  HL,(_DTBUF)
       DCC0                     SOPEN2:
000F99 DCC0 D5              11      PUSH    DE
000F9A DCC1 CD9ADD          17      CALL    FILESE      ;(self-modifying code)
       DCC2                     OPENPAT EQU $-2
000F9D DCC4 D1              10      POP DE
000F9E DCC5 386D            12      JR  C,SOPENE
000FA0 DCC7 281B            12      JR  Z,SCF_FF_RET
       DCC9                     SOPEN3:
000FA2 DCC9 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
000FA5 DCCC B7               4      OR  A
000FA6 DCCD 200C            12      JR  NZ,SOPEN5
000FA8 DCCF 13               6      INC DE      ;ルートディレクトリ
000FA9 DCD0 E5              11      PUSH    HL
000FAA DCD1 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       DCD2                     MD_PAT  EQU $-2
000FAD DCD4 ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
000FAF DCD6 E1              10      POP HL
000FB0 DCD7 20DD            12      JR  NZ,SOPEN1
000FB2 DCD9 1807            12      JR  SOPEN6
       DCDB                     SOPEN5:
000FB4 DCDB CDA5E5          17      CALL    GNCLX       ;END DIR
000FB7 DCDE D8              11      RET C
000FB8 DCDF CD52DE          17      CALL    ENDCL
       DCE2                     SOPEN6:
000FBB DCE2 38D2            12      JR  C,SOPEN1
       DCE4                     SCF_FF_RET:
000FBD DCE4 37               4      SCF         ;CF=1
000FBE DCE5 9F               4      SBC A,A     ;A=0FFH
000FBF DCE6 C9              10      RET
                                
       DCE7                     RDDERR:
000FC0 DCE7 BF               4      CP  A       ;READ ERR CF=1 ZF=1
000FC1 DCE8 37               4      SCF
000FC2 DCE9 C9              10      RET
                                
       DCEA                     NOPEN:
000FC3 DCEA 219ADD          10      LD  HL,FILESE
000FC6 DCED 22C2DC          16      LD  (OPENPAT),HL
000FC9 DCF0 FD2A98F0        20      LD  IY,(_FCB)
000FCD DCF4 CD7CDF          17      CALL    CHKWILDX
000FD0 DCF7 30EB            12      JR  NC,SCF_FF_RET
000FD2 DCF9 FD7E00          19      LD  A,(IY+0)
000FD5 DCFC CD3BDC          17      CALL    GETDRV
000FD8 DCFF CDD9F0          17      CALL    _CHGDRV
000FDB DD02 D8              11      RET C
000FDC DD03 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
000FDF DD06 229FF0          16      LD  (_FILEN),HL
                                
000FE2 DD09 CD99DE          17      CALL    LDDIRX
000FE5 DD0C ED5B9AF0        20      LD  DE,(_FBPS)
000FE9 DD10 CD8BDD          17      CALL    READ_DIR
000FEC DD13 38D2            12      JR  C,RDDERR
000FEE DD15 3A9EF0          13      LD  A,(_FBCNT)
000FF1 DD18 3D               4      DEC A
000FF2 DD19 28AE            12      JR  Z,SOPEN3
       DD1B                     NOPEN2:
000FF4 DD1B 2A9CF0          16      LD  HL,(_FBAD)
000FF7 DD1E 012000          10      LD  BC,020H
000FFA DD21 09              11      ADD HL,BC
000FFB DD22 4F               4      LD  C,A
000FFC DD23 189B            12      JR  SOPEN2
                                
       DD25                     SOPENE2:
000FFE DD25 229CF0          16      LD  (_FBAD),HL
001001 DD28 79               4      LD  A,C
001002 DD29 329EF0          13      LD  (_FBCNT),A
001005 DD2C ED539AF0        20      LD  (_FBPS),DE
001009 DD30 FD2298F0        20      LD  (_FCB),IY
       DD34                     SOPENE:
00100D DD34 AF               4      XOR A
00100E DD35 C9              10      RET
                                
       DD36                     COPEN:
00100F DD36 FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
001013 DD3A 21B7DD          10      LD  HL,NEXTSE
001016 DD3D CD89DC          17      CALL    SOPENC
001019 DD40 D0              11      RET NC
00101A DD41 C8              11      RET Z
00101B DD42 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
00101E DD45 B7               4      OR  A
00101F DD46 37               4      SCF
001020 DD47 C8              11      RET Z       ;ルートディレクトリ
001021 DD48 0601             7      LD  B,1
001023 DD4A CDDBDF          17      CALL    WRDF
001026 DD4D D8              11      RET C
001027 DD4E ED5BFEF1        20      LD  DE,(_CLPS)
00102B DD52 D5              11      PUSH    DE
00102C DD53 CD1BDE          17      CALL    DCPAT
00102F DD56 CD26E4          17      CALL    DRDNX
001032 DD59 2A7EF1          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
001035 DD5C ED4B11E3        20      LD  BC,(SECSZ)  ;1セクタのサイズ
001039 DD60 AF               4      XOR A
       DD61                     COPENCL:
00103A DD61 77               7      LD  (HL),A
00103B DD62 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
00103D DD64 EA61DD          10      JP  PE,COPENCL
                                
001040 DD67 3A39DE          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
001043 DD6A 3D               4      DEC A
001044 DD6B 2819            12      JR  Z,COPENE
001046 DD6D 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
001048 DD6F 329DE5          13      LD  (_SECPS),A
00104B DD72 D1              10      POP DE      ;DE=(_CLPS)
00104C DD73 D5              11      PUSH    DE
       DD74                     COPEN1:
00104D DD74 D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
00104E DD75 C5              11      PUSH    BC
00104F DD76 2A7EF1          16      LD  HL,(_DTBUF)
001052 DD79 CD35DE          17      CALL    CLUSTX
001055 DD7C CD3CE7          17      CALL    DWT24
001058 DD7F C1              10      POP BC
001059 DD80 D1              10      POP DE
00105A DD81 CD9CE5          17      CALL    NEXTX
00105D DD84 20EE            12      JR  NZ,COPEN1
       DD86                     COPENE:
00105F DD86 2A7EF1          16      LD  HL,(_DTBUF)
001062 DD89 D1              10      POP DE
001063 DD8A C9              10      RET
                                
       DD8B                     READ_DIR:
001064 DD8B ED53FEF1        20      LD  (_CLPS),DE
001068 DD8F C5              11      PUSH    BC
001069 DD90 D5              11      PUSH    DE
00106A DD91 CD1BDE          17      CALL    DCPAT
00106D DD94 CD06E4          17      CALL    DRDX
001070 DD97 D1              10      POP DE
001071 DD98 C1              10      POP BC
001072 DD99 C9              10      RET
                                
       DD9A                     FILESE:
001073 DD9A 7E               7      LD  A,(HL)
001074 DD9B B7               4      OR  A
001075 DD9C C8              11      RET Z       ;END:ZF=1 CF=0
001076 DD9D FEE5             7      CP  0E5H
001078 DD9F 280E            12      JR  Z,FILESE1
00107A DDA1 FDE5            15      PUSH    IY
00107C DDA3 D1              10      POP DE
00107D DDA4 13               6      INC DE
00107E DDA5 E5              11      PUSH    HL
00107F DDA6 CDF2DD          17      CALL    CPFILE
001082 DDA9 CC13DE          17      CALL    Z,CPFILE2
001085 DDAC E1              10      POP HL
001086 DDAD 37               4      SCF
001087 DDAE C8              11      RET Z       ;!!!:(ZF=1) CF=1
       DDAF                     FILESE1:
001088 DDAF CDC6DD          17      CALL    FNEXT
00108B DDB2 20E6            12      JR  NZ,FILESE
       DDB4                     ZF0_CF0_AFF_RET:
00108D DDB4 F6FF             7      OR  0FFH        ;ZF=0 CF=0
00108F DDB6 C9              10      RET
                                
       DDB7                     NEXTSE:
001090 DDB7 7E               7      LD  A,(HL)
001091 DDB8 B7               4      OR  A
001092 DDB9 37               4      SCF
001093 DDBA C8              11      RET Z       ;!!!:ZF=1 CF=1
001094 DDBB FEE5             7      CP  0E5H
001096 DDBD 37               4      SCF
001097 DDBE C8              11      RET Z       ;!!!:(ZF=1) CF=1
001098 DDBF CDC6DD          17      CALL    FNEXT
00109B DDC2 20F3            12      JR  NZ,NEXTSE
00109D DDC4 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       DDC6                     FNEXT:
00109F DDC6 E5              11      PUSH    HL
0010A0 DDC7 219FF0          10      LD  HL,_FILEN
0010A3 DDCA 34              11      INC (HL)
0010A4 DDCB E1              10      POP HL
0010A5 DDCC 112000          10      LD  DE,020H
0010A8 DDCF 19              11      ADD HL,DE
0010A9 DDD0 0D               4      DEC C
0010AA DDD1 C9              10      RET
                                
       DDD2                     CPNAME:
0010AB DDD2 C5              11      PUSH    BC
0010AC DDD3 D5              11      PUSH    DE
0010AD DDD4 E5              11      PUSH    HL
0010AE DDD5 CDECDD          17      CALL    CPFILE4
0010B1 DDD8 E1              10      POP HL
0010B2 DDD9 23               6      INC HL
0010B3 DDDA 23               6      INC HL
0010B4 DDDB 23               6      INC HL
0010B5 DDDC 23               6      INC HL
0010B6 DDDD D1              10      POP DE
0010B7 DDDE C1              10      POP BC
0010B8 DDDF 2005            12      JR  NZ,CPNAME1
0010BA DDE1 7E               7      LD  A,(HL)
0010BB DDE2 23               6      INC HL
0010BC DDE3 66               7      LD  H,(HL)
0010BD DDE4 6F               4      LD  L,A
0010BE DDE5 C9              10      RET
       DDE6                     CPNAME1:
0010BF DDE6 23               6      INC HL
0010C0 DDE7 23               6      INC HL
0010C1 DDE8 10E8            13      DJNZ    CPNAME
0010C3 DDEA 37               4      SCF
0010C4 DDEB C9              10      RET
                                
       DDEC                     CPFILE4:
0010C5 DDEC C5              11      PUSH    BC
0010C6 DDED 010004          10      LD  BC,00400H
0010C9 DDF0 1804            12      JR  CPSTR1
       DDF2                     CPFILE:
0010CB DDF2 C5              11      PUSH    BC
0010CC DDF3 01000B          10      LD  BC,00B00H
       DDF6                     CPSTR1:
0010CF DDF6 1A               7      LD  A,(DE)
0010D0 DDF7 FE3F             7      CP  '?'     ;Wild card
0010D2 DDF9 2812            12      JR  Z,CPSTR2
0010D4 DDFB 7E               7      LD  A,(HL)
0010D5 DDFC CD62DF          17      CALL    FKANC
0010D8 DDFF E5              11      PUSH    HL
0010D9 DE00 67               4      LD  H,A
0010DA DE01 1A               7      LD  A,(DE)
0010DB DE02 CB01             4      RLC C
0010DD DE04 CD62DF          17      CALL    FKANC
0010E0 DE07 CB09             4      RRC C
0010E2 DE09 BC               4      CP  H       ;CP (HL),(DE)
0010E3 DE0A E1              10      POP HL
0010E4 DE0B 2004            12      JR  NZ,CPSTR3
       DE0D                     CPSTR2:
0010E6 DE0D 13               6      INC DE
0010E7 DE0E 23               6      INC HL
0010E8 DE0F 10E5            13      DJNZ    CPSTR1
       DE11                     CPSTR3:
0010EA DE11 C1              10      POP BC
0010EB DE12 C9              10      RET
                                
       DE13                     CPFILE2:
0010EC DE13 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0010EF DE16 F6E1             7      OR  0E1H
0010F1 DE18 2F               4      CPL
0010F2 DE19 A6               7      AND (HL)
0010F3 DE1A C9              10      RET
                                
       DE1B                     DCPAT:
0010F4 DE1B 0E00             7      LD  C,0
0010F6 DE1D 2A7EF1          16      LD  HL,(_DTBUF)
0010F9 DE20 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
0010FC DE23 B7               4      OR  A
0010FD DE24 C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
0010FE DE25 3A39DE          13      LD  A,(SPCPAT)
001101 DE28 4F               4      LD  C,A
001102 DE29 3A9DE5          13      LD  A,(_SECPS)
001105 DE2C B9               4      CP  C
001106 DE2D 3801            12      JR  C,DC1
001108 DE2F AF               4      XOR A
       DE30                     DC1:
001109 DE30 F680             7      OR  080H
00110B DE32 32A0F0          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       DE35                     CLUSTX:
00110E DE35 E5              11      PUSH    HL
00110F DE36 EB               4      EX  DE,HL
001110 DE37 AF               4      XOR A
001111 DE38 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       DE39                     SPCPAT  EQU $-1
       DE3A                     L_CLDBL:
001113 DE3A CB19             8      RR  C       ;->CF
001115 DE3C 3804            12      JR  C,E_CLDBL
001117 DE3E 29              11      ADD HL,HL       ;*2
001118 DE3F 8F               4      ADC A,A
001119 DE40 18F8            12      JR  L_CLDBL
       DE42                     E_CLDBL:
00111B DE42 4F               4      LD  C,A
00111C DE43 3A9DE5          13      LD  A,(_SECPS)
00111F DE46 B5               4      OR  L
001120 DE47 6F               4      LD  L,A
001121 DE48 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       DE49                     CLSPAT  EQU $-2
001124 DE4B AF               4      XOR A
001125 DE4C 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
001126 DE4D 89               4      ADC A,C
001127 DE4E 4F               4      LD  C,A
001128 DE4F EB               4      EX  DE,HL
001129 DE50 E1              10      POP HL
00112A DE51 C9              10      RET
                                ;(8)
       DE52                     ENDCL:
00112B DE52 7A               4      LD  A,D ;END CLUSTER
00112C DE53 FE01             7      CP  1   ;164=356    (self-modifying code)
       DE54                     CLPAT1  EQU $-1
00112E DE55 C0              11      RET NZ
00112F DE56 7B               4      LD  A,E
001130 DE57 FE64             7      CP  064H    ;       (self-modifying code)
       DE58                     CLPAT2  EQU $-1
001132 DE59 C9              10      RET
                                ;(3)
       DE5A                     CAP4:
001133 DE5A 3EE5             7      LD  A,0E5H
001135 DE5C C9              10      RET
                                                    ;for X1/88 ワークエリア
001136 DE5D 5BF0                    DW  _DISKE+1        ;DISKVE($F323)
001138 DE5F F5F0                    DW  _BREAK+1        ;BREAKV($F325)
                                
       DE61                     CAP:            ;(9)
00113A DE61 FE61             7      CP  'a'
00113C DE63 D8              11      RET C
00113D DE64 FE7B             7      CP  'z'+1
00113F DE66 D0              11      RET NC
001140 DE67 D620             7      SUB 020H
001142 DE69 C9              10      RET
                                ;(10)
       DE6A                     CAP2:
001143 DE6A CD61DE          17      CALL    CAP
       DE6D                     CAP3:               ;
001146 DE6D FE05             7      CP  5
001148 DE6F 28E9            12      JR  Z,CAP4
00114A DE71 FE21             7      CP  021H
00114C DE73 C9              10      RET
                                                    ;
       DE74                     CHDIR:
00114D DE74 CD4DE8          17      CALL    GETDPBD
001150 DE77 381D            12      JR  C,CHDIR2
001152 DE79 DD751A          19      LD  (IX+DPB_SDIR),L
001155 DE7C DD741B          19      LD  (IX+DPB_SDIR+1),H
001158 DE7F 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       DE81                     LDDIR:
00115A DE81 CD4DE8          17      CALL    GETDPBD
00115D DE84 DD5E1A          19      LD  E,(IX+DPB_SDIR)
001160 DE87 DD561B          19      LD  D,(IX+DPB_SDIR+1)
001163 DE8A 13               6      INC DE
001164 DE8B FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
001167 DE8E FD720F          19      LD  (IY+15),D
00116A DE91 1B               6      DEC DE
00116B DE92 AF               4      XOR A
00116C DE93 32A0F0          13      LD  (_DIRF),A
       DE96                     CHDIR2:
00116F DE96 DDE1            14      POP IX
001171 DE98 C9              10      RET
                                
       DE99                     LDDIRX:
001172 DE99 3AA0F0          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
001175 DE9C E67F             7      AND 07FH
       DE9E                     LDDIRX1:
001177 DE9E 329DE5          13      LD  (_SECPS),A
00117A DEA1 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
00117D DEA4 FD560F          19      LD  D,(IY+15)
001180 DEA7 1B               6      DEC DE
001181 DEA8 CD52DE          17      CALL    ENDCL
001184 DEAB D481DE          17      CALL    NC,LDDIR
       DEAE                     LDDIRS:
001187 DEAE 7A               4      LD  A,D
001188 DEAF B3               4      OR  E
001189 DEB0 32A0F0          13      LD  (_DIRF),A   ;ディレクトリか判別
00118C DEB3 C9              10      RET
                                
       DEB4                     KILL:
00118D DEB4 CD7CDF          17      CALL    CHKWILDX
001190 DEB7 3834            12      JR  C,KILLW
001192 DEB9 CD57DC          17      CALL    SOPENX
       DEBC                     KILLS:
001195 DEBC 3E1F             7      LD  A,01FH
001197 DEBE D400DF          17      CALL    NC,CHKATT
00119A DEC1 D8              11      RET C
       DEC2                     KILLSX:
00119B DEC2 36E5            10      LD  (HL),0E5H   ;DIR
00119D DEC4 CD58DF          17      CALL    WTDB
0011A0 DEC7 111A00          10      LD  DE,01AH
0011A3 DECA 19              11      ADD HL,DE
0011A4 DECB 5E               7      LD  E,(HL)
0011A5 DECC 23               6      INC HL
0011A6 DECD 56               7      LD  D,(HL)
       DECE                     KILLS1:
0011A7 DECE CD52DE          17      CALL    ENDCL
0011AA DED1 D0              11      RET NC      ;CF=0
0011AB DED2 21FEFF          10      LD  HL,0-2
0011AE DED5 19              11      ADD HL,DE
0011AF DED6 D0              11      RET NC      ;DE= 0 or 1
0011B0 DED7 D5              11      PUSH    DE
0011B1 DED8 CDF7F0          17      CALL    _GNCL
0011B4 DEDB ED53FEF1        20      LD  (_CLPS),DE
0011B8 DEDF D1              10      POP DE
0011B9 DEE0 210000          10      LD  HL,0
0011BC DEE3 D4FAF0          17      CALL    NC,_SNCL
0011BF DEE6 D8              11      RET C
0011C0 DEE7 ED5BFEF1        20      LD  DE,(_CLPS)  ;FAT
0011C4 DEEB 18E1            12      JR  KILLS1
                                
       DEED                     KILLW:
0011C6 DEED CD86DC          17      CALL    SOPEN
       DEF0                     KILLW1:
0011C9 DEF0 380B            12      JR  C,KILLW2
0011CB DEF2 CD25DD          17      CALL    SOPENE2
0011CE DEF5 CDBCDE          17      CALL    KILLS
0011D1 DEF8 CDEADC          17      CALL    NOPEN
0011D4 DEFB 18F3            12      JR  KILLW1
       DEFD                     KILLW2:
0011D6 DEFD C8              11      RET Z
0011D7 DEFE 3F               4      CCF
0011D8 DEFF C9              10      RET
                                
       DF00                     CHKATT:
0011D9 DF00 E5              11      PUSH    HL
0011DA DF01 110B00          10      LD  DE,00BH
0011DD DF04 19              11      ADD HL,DE
0011DE DF05 A6               7      AND (HL)
0011DF DF06 E1              10      POP HL
0011E0 DF07 C8              11      RET Z
0011E1 DF08 37               4      SCF
0011E2 DF09 C9              10      RET
                                
       DF0A                     NAME:
0011E3 DF0A CD7CDF          17      CALL    CHKWILDX
0011E6 DF0D D8              11      RET C
0011E7 DF0E 110400          10      LD  DE,4
0011EA DF11 19              11      ADD HL,DE
0011EB DF12 2227DF          16      LD  (NAMEP),HL
0011EE DF15 23               6      INC HL
0011EF DF16 CD80DF          17      CALL    CHKWILD
0011F2 DF19 D8              11      RET C
                                
0011F3 DF1A CD57DC          17      CALL    SOPENX
0011F6 DF1D 3E0F             7      LD  A,00FH
0011F8 DF1F D400DF          17      CALL    NC,CHKATT
0011FB DF22 D8              11      RET C
                                
0011FC DF23 FDE5            15      PUSH    IY
0011FE DF25 FD210000        14      LD  IY,0        ;自己書き換え
       DF27                     NAMEP   EQU $-2
001202 DF29 CD57DC          17      CALL    SOPENX
001205 DF2C FDE3            23      EX  (SP),IY
001207 DF2E 3F               4      CCF
001208 DF2F D486DC          17      CALL    NC,SOPEN
00120B DF32 EB               4      EX  DE,HL
00120C DF33 E1              10      POP HL
00120D DF34 D8              11      RET C
                                
       DF35                     SETNAME:
00120E DF35 01000B          10      LD  BC,11*256
001211 DF38 23               6      INC HL
001212 DF39 7E               7      LD  A,(HL)
001213 DF3A FEE5             7      CP  0E5H
001215 DF3C 2004            12      JR  NZ,SNAME1
001217 DF3E 3E05             7      LD  A,5
001219 DF40 180E            12      JR  SNAME3
       DF42                     SNAME1:
00121B DF42 7E               7      LD  A,(HL)
00121C DF43 0C               4      INC C
00121D DF44 0D               4      DEC C
00121E DF45 2009            12      JR  NZ,SNAME3
001220 DF47 CD61DE          17      CALL    CAP
001223 DF4A FEA0             7      CP  0A0H
001225 DF4C 2002            12      JR  NZ,SNAME3
001227 DF4E 3E20             7      LD  A,020H
       DF50                     SNAME3:
001229 DF50 12               7      LD  (DE),A
00122A DF51 7E               7      LD  A,(HL)
00122B DF52 23               6      INC HL
00122C DF53 CD69DF          17      CALL    FKAN
00122F DF56 10EA            13      DJNZ    SNAME1
       DF58                     WTDB:               ;バッファデータが更新された
001231 DF58 3EFF             7      LD  A,0FFH
001233 DF5A 3239F0          13      LD  (SFILE),A
001236 DF5D 32A4F0          13      LD  (_WTDBF),A
001239 DF60 AF               4      XOR A
00123A DF61 C9              10      RET
                                
       DF62                     FKANC:
00123B DF62 CB41             8      BIT 0,C
00123D DF64 CC6ADE          17      CALL    Z,CAP2
001240 DF67 1801            12      JR  FKANX
       DF69                     FKAN:           ;漢字チェック
001242 DF69 13               6      INC DE
       DF6A                     FKANX:
001243 DF6A CB41             8      BIT 0,C
001245 DF6C CB81             8      RES 0,C
001247 DF6E C0              11      RET NZ
001248 DF6F FE80             7      CP  080H
00124A DF71 D8              11      RET C
00124B DF72 FEA0             7      CP  0A0H
00124D DF74 3803            12      JR  C,FKAN1
00124F DF76 FEE0             7      CP  0E0H
001251 DF78 D8              11      RET C
       DF79                     FKAN1:
001252 DF79 0C               4      INC C
001253 DF7A A7               4      AND A
001254 DF7B C9              10      RET
                                
       DF7C                     CHKWILDX:
001255 DF7C FDE5            15      PUSH    IY
001257 DF7E E1              10      POP HL
001258 DF7F 23               6      INC HL
       DF80                     CHKWILD:
001259 DF80 060B             7      LD  B,11
00125B DF82 3E3F             7      LD  A,'?'
       DF84                     CHKWIL1:
00125D DF84 BE               7      CP  (HL)
00125E DF85 23               6      INC HL
00125F DF86 37               4      SCF
001260 DF87 C8              11      RET Z
001261 DF88 10FA            13      DJNZ    CHKWIL1
001263 DF8A AF               4      XOR A
001264 DF8B C9              10      RET
                                
       DF8C                     SDIRENT:        ;IY=FCB HL=DIR
001265 DF8C D5              11      PUSH    DE
001266 DF8D E5              11      PUSH    HL
001267 DF8E FDE5            15      PUSH    IY
001269 DF90 D1              10      POP DE
00126A DF91 EB               4      EX  DE,HL
00126B DF92 CD35DF          17      CALL    SETNAME
                                ;               Attribute
00126E DF95 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001271 DF98 12               7      LD  (DE),A
001272 DF99 13               6      INC DE
                                ;               Reserved
001273 DF9A AF               4      XOR A
001274 DF9B 060A             7      LD  B,10
       DF9D                     SDE1:
001276 DF9D 12               7      LD  (DE),A
001277 DF9E 13               6      INC DE
001278 DF9F 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
00127A DFA1 21E4F1          10      LD  HL,SDDATA       ;(FCB)更新年月日
00127D DFA4 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       DFA6                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
00127F DFA6 7E               7      LD  A,(HL)
001280 DFA7 23               6      INC HL
001281 DFA8 32ADDF          13      LD  (SDPAT),A
001284 DFAB FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       DFAD                     SDPAT   EQU $-1
001287 DFAE 12               7      LD  (DE),A
001288 DFAF 13               6      INC DE
001289 DFB0 10F4            13      DJNZ    SDLOOP
                                
00128B DFB2 AF               4      XOR A
00128C DFB3 E1              10      POP HL
00128D DFB4 D1              10      POP DE
00128E DFB5 C9              10      RET
                                
       DFB6                     WOPEN:
00128F DFB6 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001292 DFB9 E61F             7      AND 01FH
001294 DFBB 37               4      SCF
001295 DFBC C0              11      RET NZ
001296 DFBD FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       DFC1                     TOPEN2:
00129A DFC1 AF               4      XOR A
       DFC2                     TOPEN:              ;Initializes the time stamp
00129B DFC2 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
00129F DFC6 C9              10      RET
                                
       DFC7                     WRDFX:
0012A0 DFC7 3A39DE          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       DFCA                     L_WRFX:
0012A3 DFCA 1F               4      RRA         ;->CF
0012A4 DFCB 3806            12      JR  C,E_WRFX
0012A6 DFCD CB39             8      SRL C
0012A8 DFCF CB1C             8      RR  H       ;CH=CH/2
0012AA DFD1 18F7            12      JR  L_WRFX
       DFD3                     E_WRFX:
0012AC DFD3 41               4      LD  B,C
0012AD DFD4 4C               4      LD  C,H
0012AE DFD5 03               6      INC BC
0012AF DFD6 3E37             7      LD  A,037H      ;SCF
0012B1 DFD8 3223E4          13      LD  (DRDN1),A
                                
       DFDB                     WRDF:               ;BCクラスタ分FATを確保する
0012B4 DFDB 110200          10      LD  DE,2
0012B7 DFDE AF               4      XOR A
0012B8 DFDF 329DE5          13      LD  (_SECPS),A
       DFE2                     WRDF1:
0012BB DFE2 C5              11      PUSH    BC
0012BC DFE3 D5              11      PUSH    DE
0012BD DFE4 CDF7F0          17      CALL    _GNCL
0012C0 DFE7 381C            12      JR  C,WRDF3
0012C2 DFE9 7A               4      LD  A,D     ;空いているかチェック
0012C3 DFEA B3               4      OR  E
0012C4 DFEB 202A            12      JR  NZ,WRDF4
0012C6 DFED E1              10      POP HL      ;HL=空いているクラスタ
0012C7 DFEE E5              11      PUSH    HL
0012C8 DFEF ED5BFEF1        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
0012CC DFF3 22FEF1          16      LD  (_CLPS),HL
0012CF DFF6 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
0012D0 DFF7 B3               4      OR  E
0012D1 DFF8 2008            12      JR  NZ,WRDF2
0012D3 DFFA FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
0012D6 DFFD FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
0012D9 E000 1803            12      JR  WRDF3
       E002                     WRDF2:
0012DB E002 CDFAF0          17      CALL    _SNCL
       E005                     WRDF3:
0012DE E005 D1              10      POP DE
0012DF E006 C1              10      POP BC
0012E0 E007 D8              11      RET C
0012E1 E008 0B               6      DEC BC
0012E2 E009 78               4      LD  A,B
0012E3 E00A B1               4      OR  C
0012E4 E00B 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
0012E6 E00D ED5BFEF1        20      LD  DE,(_CLPS)
0012EA E011 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
0012ED E014 C3FAF0          10      JP  _SNCL
                                
       E017                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
0012F0 E017 D1              10      POP DE
0012F1 E018 C1              10      POP BC
       E019                     WRDF5:
0012F2 E019 13               6      INC DE
0012F3 E01A CD52DE          17      CALL    ENDCL
0012F6 E01D 38C3            12      JR  C,WRDF1
0012F8 E01F 37               4      SCF
0012F9 E020 C9              10      RET
                                
       E021                     RWXR:
0012FA E021 3A12E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E024                     L_RWX:
0012FD E024 1F               4      RRA     ;->CF
0012FE E025 3808            12      JR  C,E_RWX
001300 E027 CB38             8      SRL B   ;BCH=BCH/2
001302 E029 CB19             8      RR  C   ;
001304 E02B CB1C             8      RR  H   ;
001306 E02D 18F5            12      JR  L_RWX
       E02F                     E_RWX:
001308 E02F FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
00130B E032 FD561B          19      LD  D,(IY+27)
00130E E035 AF               4      XOR A
00130F E036 329DE5          13      LD  (_SECPS),A
       E039                     RWX1:
001312 E039 ED53FEF1        20      LD  (_CLPS),DE
001316 E03D 7A               4      LD  A,D
001317 E03E B3               4      OR  E
001318 E03F 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
00131A E041 78               4      LD  A,B
00131B E042 B1               4      OR  C
00131C E043 B4               4      OR  H
00131D E044 C8              11      RET Z       ;RET BCH==0 => CF=0
                                
00131E E045 CDA5E5          17      CALL    GNCLX
001321 E048 D8              11      RET C
001322 E049 7C               4      LD  A,H     ;
001323 E04A 25               4      DEC H       ;
001324 E04B B7               4      OR  A       ;DEC BCH
001325 E04C 2001            12      JR  NZ,RWX2     ;
001327 E04E 0B               6      DEC BC      ;
       E04F                     RWX2:
001328 E04F CD52DE          17      CALL    ENDCL
00132B E052 38E5            12      JR  C,RWX1
       E054                     SCF_RET:
00132D E054 37               4      SCF
00132E E055 C9              10      RET
                                
       E056                     DSKF:
00132F E056 110000          10      LD  DE,0
       E057                     MAXCLP  EQU $-2
001332 E059 2AACF0          16      LD  HL,(_FAKEFREE)
001335 E05C 7C               4      LD  A,H
001336 E05D B5               4      OR  L
001337 E05E 2803            12      JR  Z,DSKF1
001339 E060 110100          10      LD  DE,1
       E063                     DSKF1:
00133C E063 D5              11      PUSH    DE
00133D E064 CDF7F0          17      CALL    _GNCL
001340 E067 380C            12      JR  C,POPSCF
001342 E069 7A               4      LD  A,D
001343 E06A B3               4      OR  E
001344 E06B 2001            12      JR  NZ,DSKF2
001346 E06D 23               6      INC HL
       E06E                     DSKF2:
001347 E06E D1              10      POP DE
001348 E06F 1B               6      DEC DE
001349 E070 7A               4      LD  A,D
00134A E071 B3               4      OR  E
00134B E072 20EF            12      JR  NZ,DSKF1
00134D E074 C9              10      RET
                                
       E075                     POPSCF:
00134E E075 F1              10      POP AF
00134F E076 37               4      SCF
001350 E077 C9              10      RET
                                
       E078                     SETTMS:
001351 E078 FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
001354 E07B 3C               4      INC A
001355 E07C C0              11      RET NZ      ;ファイルが更新されていない
       E07D                     SETTMSX:            ;FCBに日付時刻をセットする
001356 E07D CDB8D7          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
001359 E080 CB25             8      SLA L       ;   *2
00135B E082 CB25             8      SLA L       ;   *4
00135D E084 29              11      ADD HL,HL       ;*2 *8
00135E E085 29              11      ADD HL,HL       ;*4 *16
00135F E086 29              11      ADD HL,HL       ;*8 *32
001360 E087 7A               4      LD  A,D
001361 E088 0F               4      RRCA            ;bit.0->7->->->0->C
001362 E089 E61F             7      AND 01FH
001364 E08B B5               4      OR  L
001365 E08C FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
001368 E08F FD7417          19      LD  (IY+23),H
                                
00136B E092 CDB2D7          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
00136E E095 0144F8          10      LD  BC,0-1980
001371 E098 09              11      ADD HL,BC
001372 E099 65               4      LD  H,L
                                
001373 E09A 7A               4      LD  A,D
001374 E09B 87               4      ADD A,A     ;*2
001375 E09C 87               4      ADD A,A     ;*4
001376 E09D 87               4      ADD A,A     ;*8
001377 E09E 87               4      ADD A,A     ;*16
001378 E09F 6F               4      LD  L,A
001379 E0A0 29              11      ADD HL,HL       ;*32
00137A E0A1 7D               4      LD  A,L
00137B E0A2 B3               4      OR  E
00137C E0A3 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
00137F E0A6 FD7415          19      LD  (IY+21),H
001382 E0A9 C9              10      RET
                                ;(16)
       E0AA                     PUSHRR:
001383 E0AA 32D6E3          13      LD  (SETSEQ_SWC_RND),A
001386 E0AD 22E8E3          16      LD  (SETSEQ_SWC_SEQ_RR),HL
001389 E0B0 CDD0E0          17      CALL    GET_RR_AHL
00138C E0B3 220FF0          16      LD  (RR_BUF_HL),HL
00138F E0B6 3211F0          13      LD  (RR_BUF_A),A
001392 E0B9 C9              10      RET
                                ;(14)
       E0BA                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
001393 E0BA 87               4      ADD A,A     ;in BHLA => out AHL
001394 E0BB ED6A            15      ADC HL,HL
001396 E0BD CB18             8      RR  B
001398 E0BF B7               4      OR  A
001399 E0C0 78               4      LD  A,B     ;ここでフラグは変化しない
00139A E0C1 C8              11      RET Z
00139B E0C2 2C               4      INC L       ;INC AHL
00139C E0C3 C0              11      RET NZ      ;
00139D E0C4 24               4      INC H       ;
00139E E0C5 C0              11      RET NZ      ;
00139F E0C6 3C               4      INC A       ;
0013A0 E0C7 C9              10      RET
                                ;(18)
       E0C8                     INIT_RND:
0013A1 E0C8 3ECD             7      LD  A,0CDH      ;CALL ????
0013A3 E0CA 21E7E0          10      LD  HL,POPRR
0013A6 E0CD CDAAE0          17      CALL    PUSHRR
       E0D0                     GET_RR_AHL:
0013A9 E0D0 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
0013AC E0D3 FD6622          19      LD  H,(IY+34)   ;
0013AF E0D6 FD7E23          19      LD  A,(IY+35)   ;
0013B2 E0D9 C9              10      RET
                                ;(10)
       E0DA                     SET_RR_AHL:
0013B3 E0DA FD7521          19      LD  (IY+33),L   ;(FCB)Random record
0013B6 E0DD FD7422          19      LD  (IY+34),H   ;
0013B9 E0E0 FD7723          19      LD  (IY+35),A   ;
0013BC E0E3 C9              10      RET
                                ;(17)
       E0E4                     SETSEQ:
0013BD E0E4 CD09E1          17      CALL    SETSEQ1
       E0E7                     POPRR:
0013C0 E0E7 F5              11      PUSH    AF
0013C1 E0E8 E5              11      PUSH    HL
0013C2 E0E9 2A0FF0          16      LD  HL,(RR_BUF_HL)
0013C5 E0EC 3A11F0          13      LD  A,(RR_BUF_A)
0013C8 E0EF CDDAE0          17      CALL    SET_RR_AHL
0013CB E0F2 E1              10      POP HL
0013CC E0F3 F1              10      POP AF
0013CD E0F4 C9              10      RET
                                ;(20)
       E0F5                     GET_RR_BCDE:            ;BCDE=Random record
0013CE E0F5 FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
0013D1 E0F8 FD5622          19      LD  D,(IY+34)
0013D4 E0FB FD4E23          19      LD  C,(IY+35)
0013D7 E0FE 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
0013D9 E100 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
0013DD E104 C0              11      RET NZ
0013DE E105 FD4624          19      LD  B,(IY+36)
0013E1 E108 C9              10      RET
                                
       E109                     SETSEQ1:
0013E2 E109 F5              11      PUSH    AF
0013E3 E10A E5              11      PUSH    HL      ;AHL=Random record
0013E4 E10B CDD0E0          17      CALL    GET_RR_AHL
0013E7 E10E 47               4      LD  B,A     ;AHL→HLA
0013E8 E10F 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
0013E9 E110 6C               4      LD  L,H     ;(IY+34)
0013EA E111 60               4      LD  H,B     ;(IY+35)
0013EB E112 0600             7      LD  B,0
                                
0013ED E114 CDBAE0          17      CALL    GET_CPM_R_SIZE
                                
0013F0 E117 29              11      ADD HL,HL
0013F1 E118 CB3D             8      SRL L       ;L=L/2
0013F3 E11A FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
0013F6 E11D FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
0013F9 E120 E1              10      POP HL
0013FA E121 F1              10      POP AF
0013FB E122 C9              10      RET
                                
                                ;(23)
       E123                     RBXEND:             ;レコード数だけランダムレコードを進める
0013FC E123 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       E124                     RBSIZE  EQU $-2
0013FF E126 CDD0E0          17      CALL    GET_RR_AHL
001402 E129 19              11      ADD HL,DE
001403 E12A CE00             7      ADC A,0
001405 E12C CDDAE0          17      CALL    SET_RR_AHL
001408 E12F EB               4      EX  DE,HL       ;HL=進めるレコード数
001409 E130 D0              11      RET NC
00140A E131 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00140E E135 C0              11      RET NZ
00140F E136 FD3424          23      INC (IY+36)
001412 E139 C9              10      RET
       E13A                     FILE_E:
                                
       DCE4                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       DCE4                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       DCE4                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       DCE4                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       DCE4                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E13A                     _SYS26:     ;(BDOS)ランダムブロック書き込み
001413 E13A AF               4      XOR A
001414 E13B 3223E4          13      LD  (DRDN1),A   ;NOP
001417 E13E 2224E1          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
00141A E141 225DF0          16      LD  (LEFTX),HL
00141D E144 CD2DDC          17      CALL    SETDRV
                                
001420 E147 CDADE2          17      CALL    RBX0
001423 E14A DAD7E1          10      JP  C,RBWERR
001426 E14D CDB6DF          17      CALL    WOPEN
001429 E150 DAD7E1          10      JP  C,RBWERR
00142C E153 7C               4      LD  A,H
00142D E154 B5               4      OR  L
00142E E155 CAD0E1          10      JP  Z,RBW1
                                
001431 E158 2B               6      DEC HL
                                
001432 E159 CDF5E0          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
001435 E15C 19              11      ADD HL,DE       ;BCHL=HL+BCDE
001436 E15D 3001            12      JR  NC,S26X1    ;
001438 E15F 03               6      INC BC      ;
       E160                     S26X1:
001439 E160 CD21E0          17      CALL    RWXR
00143C E163 DCC7DF          17      CALL    C,WRDFX
00143F E166 DAD7E1          10      JP  C,RBWERR
                                
001442 E169 CDDCE2          17      CALL    RBX2
001445 E16C 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
001447 E16E CDFBE2          17      CALL    RBXA
00144A E171 3864            12      JR  C,RBWERR
00144C E173 EB               4      EX  DE,HL
00144D E174 C5              11      PUSH    BC
00144E E175 EDB0                    LDIR
001450 E177 225FF0          16      LD  (DTAX),HL
                                
001453 E17A CD58DF          17      CALL    WTDB        ;バッファデータは更新された
                                
001456 E17D 2A5DF0          16      LD  HL,(LEFTX)
001459 E180 D1              10      POP DE
00145A E181 ED52            15      SBC HL,DE
00145C E183 225DF0          16      LD  (LEFTX),HL
00145F E186 2831            12      JR  Z,RBWEND
                                
       E188                     RBWB:
001461 E188 CD30E3          17      CALL    RBXB
001464 E18B 2814            12      JR  Z,RBWC
       E18D                     RBWB1:
001466 E18D C5              11      PUSH    BC
001467 E18E D5              11      PUSH    DE
001468 E18F CD35DE          17      CALL    CLUSTX
00146B E192 CD54E3          17      CALL    DWTC
00146E E195 D1              10      POP DE
00146F E196 C1              10      POP BC
001470 E197 D4A5E5          17      CALL    NC,GNCLX
001473 E19A 383B            12      JR  C,RBWERR
001475 E19C 10EF            13      DJNZ    RBWB1
001477 E19E CDA4E3          17      CALL    DRW_FLUSH
       E1A1                     RBWC:
00147A E1A1 CD48E3          17      CALL    RBXC
00147D E1A4 2813            12      JR  Z,RBWEND
00147F E1A6 C5              11      PUSH    BC
001480 E1A7 CD35DE          17      CALL    CLUSTX
001483 E1AA CD22E4          17      CALL    DRDN
001486 E1AD C1              10      POP BC
001487 E1AE 3827            12      JR  C,RBWERR
001489 E1B0 ED5B7EF1        20      LD  DE,(_DTBUF)
00148D E1B4 EDB0                    LDIR
00148F E1B6 CD58DF          17      CALL    WTDB        ;バッファデータは更新された
       E1B9                     RBWEND:
001492 E1B9 CD23E1          17      CALL    RBXEND
                                
001495 E1BC CDBCE2          17      CALL    RBX1
001498 E1BF 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
00149A E1C1 CDF5E0          17      CALL    GET_RR_BCDE ;BCDE=Random record
00149D E1C4 FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
0014A0 E1C7 FD7211          19      LD  (IY+17),D   ;
0014A3 E1CA FD7112          19      LD  (IY+18),C   ;
0014A6 E1CD FD7013          19      LD  (IY+19),B   ;
       E1D0                     RBW1:
0014A9 E1D0 FDE1            14      POP IY
0014AB E1D2 C1              10      POP BC
0014AC E1D3 D1              10      POP DE
0014AD E1D4 E1              10      POP HL
       E1D5                     DD_NUL:
0014AE E1D5 AF               4      XOR A
       E1D6                     DRDF0:
       E1D6                     DWTF0:
0014AF E1D6 C9              10      RET
                                
       E1D7                     RBWERR:
0014B0 E1D7 FDE5            15      PUSH    IY
0014B2 E1D9 D1              10      POP DE
0014B3 E1DA 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
0014B5 E1DC CD45D4          17      CALL    BDOS0
       E1DF                     RBRERR1:
0014B8 E1DF 3E01             7      LD  A,001H
       E1E1                     RBRERR2:
0014BA E1E1 FDE1            14      POP IY
0014BC E1E3 C1              10      POP BC
0014BD E1E4 D1              10      POP DE
0014BE E1E5 E1              10      POP HL
0014BF E1E6 37               4      SCF
0014C0 E1E7 210000          10      LD  HL,0
0014C3 E1EA C9              10      RET
                                
       E1EB                     RBRERR:
0014C4 E1EB 3EFF             7      LD  A,0FFH
0014C6 E1ED 18F2            12      JR  RBRERR2
                                
       E1EF                     RBRFL:
0014C8 E1EF 3E00             7  RBRFLP: LD  A,000H
0014CA E1F1 FE0D             7      CP  00DH
0014CC E1F3 2005            12      JR  NZ,RBRFL1
0014CE E1F5 D5              11      PUSH    DE
0014CF E1F6 1E0A             7      LD  E,00AH
0014D1 E1F8 1805            12      JR  RBRFL2
       E1FA                     RBRFL1:
0014D3 E1FA D5              11      PUSH    DE
0014D4 E1FB CD09F0          17      CALL    _SYS07
0014D7 E1FE 5F               4      LD  E,A
       E1FF                     RBRFL2:
0014D8 E1FF CDCDF0          17      CALL    _PRINT
0014DB E202 7B               4      LD  A,E
0014DC E203 D1              10      POP DE
0014DD E204 32F0E1          13      LD  (RBRFLP+1),A
0014E0 E207 C9              10      RET
                                
                                                ;Read random block
       E208                     _SYS27:     ;(BDOS)ランダムブロック読み込み
0014E1 E208 225DF0          16      LD  (LEFTX),HL
0014E4 E20B CD2DDC          17      CALL    SETDRV
                                
0014E7 E20E FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
0014EB E212 C29BE2          10      JP  NZ,RBRDIR   ;ディレクトリ
0014EE E215 CDADE2          17      CALL    RBX0
0014F1 E218 DAEBE1          10      JP  C,RBRERR
0014F4 E21B CDBCE2          17      CALL    RBX1
0014F7 E21E D4D4E2          17      CALL    NC,RBX1R
0014FA E221 DADFE1          10      JP  C,RBRERR1
0014FD E224 EB               4      EX  DE,HL
0014FE E225 ED52            15      SBC HL,DE       ;CP 00HL,BCDE
001500 E227 19              11      ADD HL,DE
001501 E228 79               4      LD  A,C
001502 E229 DE00             7      SBC A,0
001504 E22B 78               4      LD  A,B
001505 E22C DE00             7      SBC A,0
001507 E22E 3801            12      JR  C,RBR1
001509 E230 EB               4      EX  DE,HL
       E231                     RBR1:
00150A E231 9F               4      SBC A,A
00150B E232 E601             7      AND 1
00150D E234 3299E2          13      LD  (RBRA_SWC),A
                                
001510 E237 7C               4      LD  A,H
001511 E238 B5               4      OR  L
001512 E239 2857            12      JR  Z,RBREND0
                                
001514 E23B 2224E1          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
001517 E23E 225DF0          16      LD  (LEFTX),HL
                                
00151A E241 CDDCE2          17      CALL    RBX2
00151D E244 2819            12      JR  Z,RBRB
00151F E246 CDFBE2          17      CALL    RBXA
001522 E249 DAEBE1          10      JP  C,RBRERR
001525 E24C C5              11      PUSH    BC
001526 E24D EDB0                    LDIR
001528 E24F ED535FF0        20      LD  (DTAX),DE
00152C E253 2A5DF0          16      LD  HL,(LEFTX)
00152F E256 D1              10      POP DE
001530 E257 A7               4      AND A
001531 E258 ED52            15      SBC HL,DE
001533 E25A 225DF0          16      LD  (LEFTX),HL
001536 E25D 2830            12      JR  Z,RBREND
                                
       E25F                     RBRB:
001538 E25F CD30E3          17      CALL    RBXB
00153B E262 2815            12      JR  Z,RBRC
       E264                     RBRB1:
00153D E264 C5              11      PUSH    BC
00153E E265 D5              11      PUSH    DE
00153F E266 CD35DE          17      CALL    CLUSTX
001542 E269 CD5AE3          17      CALL    DRDC
001545 E26C D1              10      POP DE
001546 E26D C1              10      POP BC
001547 E26E D4A5E5          17      CALL    NC,GNCLX
00154A E271 DAEBE1          10      JP  C,RBRERR
00154D E274 10EE            13      DJNZ    RBRB1
00154F E276 CDA4E3          17      CALL    DRW_FLUSH
       E279                     RBRC:
001552 E279 CD48E3          17      CALL    RBXC
001555 E27C 2811            12      JR  Z,RBREND
001557 E27E C5              11      PUSH    BC
001558 E27F CD35DE          17      CALL    CLUSTX
00155B E282 CD06E4          17      CALL    DRDX
00155E E285 C1              10      POP BC
00155F E286 DAEBE1          10      JP  C,RBRERR
001562 E289 EB               4      EX  DE,HL
001563 E28A 2A7EF1          16      LD  HL,(_DTBUF)
001566 E28D EDB0                    LDIR
       E28F                     RBREND:
001568 E28F CD23E1          17      CALL    RBXEND
       E292                     RBREND0:
00156B E292 FDE1            14      POP IY
00156D E294 C1              10      POP BC
00156E E295 D1              10      POP DE
00156F E296 F1              10      POP AF  ;(HL)
001570 E297 AF               4      XOR A
001571 E298 3E00             7      LD  A,000H
       E299                     RBRA_SWC    EQU $-1
001573 E29A C9              10      RET
                                
       E29B                     RBRDIR:
001574 E29B FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001577 E29E FD661B          19      LD  H,(IY+27)
00157A E2A1 CD74DE          17      CALL    CHDIR
00157D E2A4 AF               4      XOR A
00157E E2A5 67               4      LD  H,A
00157F E2A6 6F               4      LD  L,A
001580 E2A7 3C               4      INC A
001581 E2A8 3299E2          13      LD  (RBRA_SWC),A
001584 E2AB 18E5            12      JR  RBREND0
                                ;(15)
       E2AD                     RBX0:
001586 E2AD 2A8AF0          16      LD  HL,(_DTA)
001589 E2B0 225FF0          16      LD  (DTAX),HL
00158C E2B3 2A5DF0          16      LD  HL,(LEFTX)
00158F E2B6 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
001592 E2B9 D6FD             7      SUB 0FDH
001594 E2BB C9              10      RET
                                
       E2BC                     RBX1:               ;ファイルサイズとランダムレコードを比べる
001595 E2BC E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
001596 E2BD FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
001599 E2C0 FD6611          19      LD  H,(IY+17)   ;
00159C E2C3 FD7E12          19      LD  A,(IY+18)   ;
                                
00159F E2C6 CDF5E0          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0015A2 E2C9 A7               4      AND A
0015A3 E2CA ED52            15      SBC HL,DE
0015A5 E2CC 99               4      SBC A,C
0015A6 E2CD 4F               4      LD  C,A
0015A7 E2CE FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
0015AA E2D1 98               4      SBC A,B
0015AB E2D2 D1              10      POP DE
0015AC E2D3 C9              10      RET
       E2D4                     RBX1R:              ;(8)
0015AD E2D4 47               4      LD  B,A
0015AE E2D5 B1               4      OR  C
0015AF E2D6 EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
0015B0 E2D7 B2               4      OR  D
0015B1 E2D8 B3               4      OR  E
0015B2 E2D9 C0              11      RET NZ
0015B3 E2DA 37               4      SCF
0015B4 E2DB C9              10      RET
                                
       E2DC                     RBX2:               ;Cluster settings
0015B5 E2DC FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
0015B8 E2DF FD4E23          19      LD  C,(IY+35)
0015BB E2E2 0600             7      LD  B,0
0015BD E2E4 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
0015C1 E2E8 2003            12      JR  NZ,RBX3
0015C3 E2EA FD4624          19      LD  B,(IY+36)
       E2ED                     RBX3:
0015C6 E2ED CD21E0          17      CALL    RWXR
0015C9 E2F0 3A12E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
0015CC E2F3 3D               4      DEC A
0015CD E2F4 FDA622          19      AND (IY+34)
0015D0 E2F7 FDB621          19      OR  (IY+33)
0015D3 E2FA C9              10      RET
                                
       E2FB                     RBXA:
0015D4 E2FB C5              11      PUSH    BC
0015D5 E2FC D5              11      PUSH    DE
0015D6 E2FD CD35DE          17      CALL    CLUSTX
0015D9 E300 CD06E4          17      CALL    DRDX
0015DC E303 D1              10      POP DE
0015DD E304 C1              10      POP BC
0015DE E305 D4A5E5          17      CALL    NC,GNCLX
0015E1 E308 D8              11      RET C
0015E2 E309 ED53FEF1        20      LD  (_CLPS),DE
                                
0015E6 E30D FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
0015E9 E310 210004          10      LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
       E311                     SECSZ   EQU $-2
       E312                     SECSZ_H EQU $-1
0015EC E313 7C               4      LD  A,H
0015ED E314 3D               4      DEC A       ;1024=3 / 512=1
0015EE E315 FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
0015F1 E318 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
0015F2 E319 ED42            15      SBC HL,BC       ;残りを計算
                                
0015F4 E31B ED5B5DF0        20      LD  DE,(LEFTX)
0015F8 E31F ED52            15      SBC HL,DE       ;CP HL,DE
0015FA E321 19              11      ADD HL,DE       ;
0015FB E322 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
0015FD E324 EB               4      EX  DE,HL
       E325                     RBXA1:
0015FE E325 E5              11      PUSH    HL
0015FF E326 2A7EF1          16      LD  HL,(_DTBUF)
001602 E329 09              11      ADD HL,BC
001603 E32A ED5B5FF0        20      LD  DE,(DTAX)
001607 E32E C1              10      POP BC
001608 E32F C9              10      RET
                                
       E330                     RBXB:
001609 E330 2A5FF0          16      LD  HL,(DTAX)
00160C E333 ED5BFEF1        20      LD  DE,(_CLPS)
001610 E337 3A5EF0          13      LD  A,(LEFTX+1)
001613 E33A 47               4      LD  B,A
001614 E33B 3A12E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E33E                     RBXB1:
001617 E33E 1F               4      RRA     ;->CF
001618 E33F 3804            12      JR  C,RBXB2
00161A E341 CB38             8      SRL B   ;B=B/2
00161C E343 18F9            12      JR  RBXB1
       E345                     RBXB2:
00161E E345 78               4      LD  A,B
00161F E346 B7               4      OR  A
001620 E347 C9              10      RET
                                ;(12)
       E348                     RBXC:
001621 E348 ED4B5DF0        20      LD  BC,(LEFTX)
001625 E34C 3A12E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
001628 E34F 3D               4      DEC A
001629 E350 A0               4      AND B
00162A E351 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
00162B E352 B1               4      OR  C
00162C E353 C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E354                     DWTC:
00162D E354 E5              11      PUSH    HL
00162E E355 213EE7          10      LD  HL,DWT24B
001631 E358 1804            12      JR  DWTC1
       E35A                     DRDC:
001633 E35A E5              11      PUSH    HL
001634 E35B 2130E7          10      LD  HL,DRD24B
       E35E                     DWTC1:
001637 E35E 22B8E3          16      LD  (DRWF_MODE),HL
00163A E361 E1              10      POP HL
00163B E362 3AA8E3          13      LD  A,(DRWF_B)
00163E E365 B7               4      OR  A
00163F E366 200F            12      JR  NZ,DRDC1
       E368                     SAVE_DRWC:
001641 E368 0601             7      LD  B,1
001643 E36A ED43A7E3        20      LD  (DRWF_C),BC
001647 E36E ED53AEE3        20      LD  (DRWF_E),DE
00164B E372 22B1E3          16      LD  (DRWF_HL),HL
00164E E375 1820            12      JR  INC_HL_DRWC
       E377                     DRDC1:
001650 E377 E5              11      PUSH    HL
001651 E378 21AEE3          10      LD  HL,DRWF_E
001654 E37B 86               7      ADD A,(HL)
001655 E37C F5              11      PUSH    AF
001656 E37D BB               4      CP  E
001657 E37E 201D            12      JR  NZ,DRDC2
001659 E380 F1              10      POP AF
00165A E381 23               6      INC HL
00165B E382 7E               7      LD  A,(HL)
00165C E383 CE00             7      ADC A,0
00165E E385 F5              11      PUSH    AF
00165F E386 BA               4      CP  D
001660 E387 2014            12      JR  NZ,DRDC2
001662 E389 F1              10      POP AF
001663 E38A 3AA7E3          13      LD  A,(DRWF_C)
001666 E38D CE00             7      ADC A,0
001668 E38F B9               4      CP  C
001669 E390 200C            12      JR  NZ,DRDC3
00166B E392 21A8E3          10      LD  HL,DRWF_B
00166E E395 34              11      INC (HL)
00166F E396 E1              10      POP HL
       E397                     INC_HL_DRWC:
001670 E397 3A12E3          13      LD  A,(SECSZ_H)     ;1セクタのサイズの上位1バイト
001673 E39A 84               4      ADD A,H
001674 E39B 67               4      LD  H,A
001675 E39C C9              10      RET
       E39D                     DRDC2:
001676 E39D F1              10      POP AF
       E39E                     DRDC3:
001677 E39E CDA4E3          17      CALL    DRW_FLUSH
00167A E3A1 E1              10      POP HL
00167B E3A2 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E3A4                     DRW_FLUSH:
00167D E3A4 C5              11      PUSH    BC
00167E E3A5 D5              11      PUSH    DE
00167F E3A6 010000          10      LD  BC,0
       E3A7                     DRWF_C  EQU $-2
       E3A8                     DRWF_B  EQU $-1
001682 E3A9 78               4      LD  A,B
001683 E3AA B7               4      OR  A
001684 E3AB 280D            12      JR  Z,DRDF1
001686 E3AD 110000          10      LD  DE,0
       E3AE                     DRWF_E  EQU $-2
       E3AF                     DRWF_D  EQU $-1
001689 E3B0 210000          10      LD  HL,0
       E3B1                     DRWF_HL EQU $-2
00168C E3B3 AF               4      XOR A
00168D E3B4 32A8E3          13      LD  (DRWF_B),A
001690 E3B7 CD30E7          17      CALL    DRD24B
       E3B8                     DRWF_MODE   EQU $-2
       E3BA                     DRDF1:
001693 E3BA D1              10      POP DE
001694 E3BB C1              10      POP BC
001695 E3BC C9              10      RET
                                
       E3BD                     RB_WRITE:
001696 E3BD C5              11      PUSH    BC
001697 E3BE 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
001699 E3C0 1803            12      JR  RBRW
       E3C2                     RB_READ:
00169B E3C2 C5              11      PUSH    BC
00169C E3C3 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
       E3C5                     RBRW:
00169E E3C5 1F               4      RRA     ;AHL = AHL*128
00169F E3C6 7C               4      LD  A,H ;AHL = AHL0/2
0016A0 E3C7 1F               4      RRA     ;A
0016A1 E3C8 65               4      LD  H,L ;
0016A2 E3C9 CB1C             8      RR  H   ;H
0016A4 E3CB 2E00             7      LD  L,0 ;
0016A6 E3CD CB1D             8      RR  L   ;L
0016A8 E3CF CDDAE0          17      CALL    SET_RR_AHL
0016AB E3D2 218000          10      LD  HL,128
0016AE E3D5 C5              11      PUSH    BC
       E3D6                     SETSEQ_SWC_RND:
0016AF E3D6 CD09E1          17      CALL    SETSEQ1     ;CALL SETSEQ1 or LD BC,SETSEQ1
0016B2 E3D9 C1              10      POP BC
0016B3 E3DA FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
0016B7 E3DE FDE5            15      PUSH    IY
0016B9 E3E0 D1              10      POP DE
0016BA E3E1 D5              11      PUSH    DE
0016BB E3E2 CD45D4          17      CALL    BDOS0
0016BE E3E5 FDE1            14      POP IY
0016C0 E3E7 CDE4E0          17      CALL    SETSEQ      ;SETSEQ or POPRR
       E3E8                     SETSEQ_SWC_SEQ_RR   EQU $-2
0016C3 E3EA FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
0016C7 E3EE C1              10      POP BC
0016C8 E3EF C9              10      RET
                                
                                ;(22)
       E3F0                     INIT_SEQ:
0016C9 E3F0 3E01             7      LD  A,1     ;LD BC,????
0016CB E3F2 21E4E0          10      LD  HL,SETSEQ
0016CE E3F5 CDAAE0          17      CALL    PUSHRR
       E3F8                     GETSEQ:
0016D1 E3F8 FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
0016D4 E3FB FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
0016D7 E3FE AF               4      XOR A
                                
0016D8 E3FF CB25             8      SLA L   ;L=L*2
                                
0016DA E401 CB3C             8      SRL H   ;HL=HL/2
0016DC E403 CB1D             8      RR  L   ;
0016DE E405 C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E406                     DRDX:
0016DF E406 CD44E4          17      CALL    DRDY
0016E2 E409 C8              11      RET Z
0016E3 E40A CD2AE4          17      CALL    DRDX1       ;データバッファの情報を保存
0016E6 E40D D8              11      RET C
0016E7 E40E E5              11      PUSH    HL
0016E8 E40F C5              11      PUSH    BC
0016E9 E410 D5              11      PUSH    DE
0016EA E411 2A7EF1          16      LD  HL,(_DTBUF)
0016ED E414 3A6DE4          13      LD  A,(_DBS24)
0016F0 E417 4F               4      LD  C,A
0016F1 E418 CD2EE7          17      CALL    DRD24
0016F4 E41B DC3FE4          17      CALL    C,DRDNE
       E41E                     POP_DE_BC_HL_RET:
0016F7 E41E D1              10      POP DE
0016F8 E41F C1              10      POP BC
0016F9 E420 E1              10      POP HL
0016FA E421 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E422                     DRDN:
0016FB E422 AF               4      XOR A
0016FC E423 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
0016FD E424 30E0            12      JR  NC,DRDX
       E426                     DRDNX:
0016FF E426 CD44E4          17      CALL    DRDY
001702 E429 C8              11      RET Z
       E42A                     DRDX1:
001703 E42A CD5AE4          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
001706 E42D ED53A6F0        20      LD  (_DBSEC),DE
00170A E431 79               4      LD  A,C
00170B E432 326DE4          13      LD  (_DBS24),A
                                
00170E E435 3A88F0          13      LD  A,(_DRV)
001711 E438 32A5F0          13      LD  (_DBDRV),A
001714 E43B CDD9F0          17      CALL    _CHGDRV
001717 E43E D0              11      RET NC
       E43F                     DRDNE:
001718 E43F 9F               4      SBC A,A     ;CF=1ならばA=0FFH
001719 E440 32A5F0          13      LD  (_DBDRV),A
00171C E443 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E444                     DRDY:
00171D E444 3A6DE4          13      LD  A,(_DBS24)
001720 E447 B9               4      CP  C
001721 E448 C0              11      RET NZ
                                
001722 E449 E5              11      PUSH    HL
001723 E44A 3A88F0          13      LD  A,(_DRV)
001726 E44D 21A5F0          10      LD  HL,_DBDRV
001729 E450 AE               7      XOR (HL)
00172A E451 2005            12      JR  NZ,POP_HL_RET
                                
00172C E453 2AA6F0          16      LD  HL,(_DBSEC)
00172F E456 ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E458                     POP_HL_RET:
001731 E458 E1              10      POP HL
001732 E459 C9              10      RET
                                
       E45A                     DWTX:
001733 E45A 3AA4F0          13      LD  A,(_WTDBF)
001736 E45D B7               4      OR  A
001737 E45E C8              11      RET Z
001738 E45F AF               4      XOR A
001739 E460 32A4F0          13      LD  (_WTDBF),A
                                
00173C E463 E5              11      PUSH    HL
00173D E464 C5              11      PUSH    BC
00173E E465 D5              11      PUSH    DE
00173F E466 3AA5F0          13      LD  A,(_DBDRV)
001742 E469 CDD9F0          17      CALL    _CHGDRV
001745 E46C 0E00             7      LD  C,0
       E46D                     _DBS24  EQU $-1
001747 E46E ED5BA6F0        20      LD  DE,(_DBSEC)
00174B E472 2A7EF1          16      LD  HL,(_DTBUF)
00174E E475 D43CE7          17      CALL    NC,DWT24
       E478                     POP_DE_BC_HL_RET2:
001751 E478 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E47A                     RDFATX:
001753 E47A E5              11      PUSH    HL
001754 E47B 3A88F0          13      LD  A,(_DRV)
001757 E47E 21AAF0          10      LD  HL,_FATDRV
00175A E481 AE               7      XOR (HL)
00175B E482 28D4            12      JR  Z,POP_HL_RET
                                
00175D E484 C5              11      PUSH    BC
00175E E485 D5              11      PUSH    DE
00175F E486 DDE5            15      PUSH    IX
001761 E488 CDA4E4          17      CALL    WTFATX
001764 E48B 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
001766 E48D AF               4      XOR A
001767 E48E 32ABF0          13      LD  (_FATIX),A
00176A E491 3A88F0          13      LD  A,(_DRV)
00176D E494 32AAF0          13      LD  (_FATDRV),A
001770 E497 CDE5F0          17      CALL    _RDFAT
       E49A                     RDFATE2:
001773 E49A 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
001775 E49C 9F               4      SBC A,A     ;A=0xFF
001776 E49D 32AAF0          13      LD  (_FATDRV),A
       E4A0                     POP_IX_DE_BC_HL_RET:
001779 E4A0 DDE1            14      POP IX
00177B E4A2 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E4A4                     WTFATX:
00177D E4A4 3AA2F0          13      LD  A,(_WTFATF)
001780 E4A7 B7               4      OR  A
001781 E4A8 C8              11      RET Z
001782 E4A9 AF               4      XOR A
001783 E4AA 32A2F0          13      LD  (_WTFATF),A
                                
001786 E4AD E5              11      PUSH    HL
001787 E4AE 3AAAF0          13      LD  A,(_FATDRV)
00178A E4B1 21A5F0          10      LD  HL,_DBDRV
00178D E4B4 AE               7      XOR (HL)
00178E E4B5 CC5AE4          17      CALL    Z,DWTX
001791 E4B8 389E            12      JR  C,POP_HL_RET
001793 E4BA C5              11      PUSH    BC
001794 E4BB D5              11      PUSH    DE
001795 E4BC DDE5            15      PUSH    IX
001797 E4BE CD4DE7          17      CALL    FATSETUP
00179A E4C1 D43EE7          17      CALL    NC,DWT24B
00179D E4C4 18DA            12      JR  POP_IX_DE_BC_HL_RET
                                
       E4C6                     N16CL1:
00179F E4C6 7A               4      LD  A,D
0017A0 E4C7 B3               4      OR  E
0017A1 E4C8 37               4      SCF
0017A2 E4C9 C8              11      RET Z
                                
0017A3 E4CA 7A               4      LD  A,D
0017A4 E4CB 1807            12      JR  NCL1X
       E4CD                     NCL1:
0017A6 E4CD 7A               4      LD  A,D
0017A7 E4CE B3               4      OR  E
0017A8 E4CF 37               4      SCF
0017A9 E4D0 C8              11      RET Z
                                
0017AA E4D1 7A               4      LD  A,D
0017AB E4D2 CB3F             8      SRL A   ;/2
       E4D4                     NCL1X:
0017AD E4D4 CB3F             8      SRL A   ;/2
                                
0017AF E4D6 E5              11      PUSH    HL
0017B0 E4D7 32F6E4          13      LD  (NCLPAT_FATIX),A    ;_FATIX
0017B3 E4DA 2AAAF0          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
0017B6 E4DD BC               4      CP  H
0017B7 E4DE 3A88F0          13      LD  A,(_DRV)    ;LDではフラグは変化しない
0017BA E4E1 32F5E4          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
0017BD E4E4 2005            12      JR  NZ,NCL2     ;FATIXが違う
0017BF E4E6 BD               4      CP  L
0017C0 E4E7 2002            12      JR  NZ,NCL2     ;ドライブが違う
0017C2 E4E9 E1              10      POP HL
0017C3 E4EA C9              10      RET
       E4EB                     NCL2:
0017C4 E4EB C5              11      PUSH    BC
0017C5 E4EC D5              11      PUSH    DE
0017C6 E4ED DDE5            15      PUSH    IX
0017C8 E4EF CDA4E4          17      CALL    WTFATX
0017CB E4F2 38AC            12      JR  C,POP_IX_DE_BC_HL_RET
0017CD E4F4 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E4F6                     NCLPAT_FATIX    EQU $-1
       E4F5                     NCLPAT_FATDRV   EQU $-2
0017D0 E4F7 ED43AAF0        20      LD  (_FATDRV),BC
0017D4 E4FB CD22E7          17      CALL    RDFATS
0017D7 E4FE 189A            12      JR  RDFATE2
                                
       E500                     NCL3:
0017D9 E500 CB9A             8      RES 3,D
0017DB E502 CB92             8      RES 2,D
0017DD E504 6B               4      LD  L,E
0017DE E505 62               4      LD  H,D
0017DF E506 CB3C             8      SRL H   ;
0017E1 E508 CB1D             8      RR  L   ;HLA=HLA/2
0017E3 E50A 1F               4      RRA     ;
0017E4 E50B F5              11      PUSH    AF
0017E5 E50C 3AABF0          13      LD  A,(_FATIX)
0017E8 E50F 0F               4      RRCA
0017E9 E510 300B            12      JR  NC,NCL3X1
0017EB E512 3A12E3          13      LD  A,(SECSZ_H)
0017EE E515 FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
0017F0 E517 2004            12      JR  NZ,NCL3X1
0017F2 E519 010002          10      LD  BC,512
0017F5 E51C 09              11      ADD HL,BC
       E51D                     NCL3X1:
0017F6 E51D F1              10      POP AF
0017F7 E51E ED4B7CF1        20      LD  BC,(_FATBF)
0017FB E522 19              11      ADD HL,DE
0017FC E523 09              11      ADD HL,BC
0017FD E524 17               4      RLA
0017FE E525 C9              10      RET
                                
       E526                     GNCL:
0017FF E526 CDCDE4          17      CALL    NCL1        ;GET NEXT CLUSTER
001802 E529 D8              11      RET C
001803 E52A C5              11      PUSH    BC
001804 E52B E5              11      PUSH    HL
001805 E52C CD00E5          17      CALL    NCL3
001808 E52F 3809            12      JR  C,GNC1
00180A E531 5E               7      LD  E,(HL)
00180B E532 23               6      INC HL
00180C E533 7E               7      LD  A,(HL)
00180D E534 E60F             7      AND 00FH
00180F E536 57               4      LD  D,A
001810 E537 E1              10      POP HL
001811 E538 C1              10      POP BC
001812 E539 C9              10      RET
       E53A                     GNC1:
001813 E53A 7E               7      LD  A,(HL)
001814 E53B 23               6      INC HL
001815 E53C 56               7      LD  D,(HL)
001816 E53D 0604             7      LD  B,4
       E53F                     GNC1L:
001818 E53F CB3A             8      SRL D   ;DA=DA/2
00181A E541 1F               4      RRA     ;
00181B E542 10FB            13      DJNZ    GNC1L
                                
00181D E544 5F               4      LD  E,A
00181E E545 E1              10      POP HL
00181F E546 C1              10      POP BC
001820 E547 A7               4      AND A
001821 E548 C9              10      RET
                                
       E549                     SNCL:
001822 E549 CDCDE4          17      CALL    NCL1
001825 E54C D8              11      RET C
                                ;               SET NEXT CLUSTER
001826 E54D E5              11      PUSH    HL
001827 E54E C5              11      PUSH    BC
001828 E54F D5              11      PUSH    DE
001829 E550 E5              11      PUSH    HL
00182A E551 CD00E5          17      CALL    NCL3
00182D E554 D1              10      POP DE
                                ;CF=ODD
00182E E555 7E               7      LD  A,(HL)
00182F E556 73               7      LD  (HL),E
001830 E557 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
001832 E559 23               6      INC HL
001833 E55A ED67            18      RRD     ;M={A[3:0],E[3:0]}
001835 E55C 7A               4      LD  A,D
001836 E55D 1804            12      JR  SNC11
       E55F                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
001838 E55F ED6F            18      RLD     ;M={D[3:0],E[7:4]}
00183A E561 23               6      INC HL
00183B E562 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E563                     SNC11:
00183C E563 ED6F            18      RLD     ;M={M[7:4],D[3:0]}
00183E E565 B7               4      OR  A
00183F E566 D1              10      POP DE
001840 E567 C1              10      POP BC
001841 E568 E1              10      POP HL
       E569                     FAT_CHANGED:
001842 E569 3EFF             7      LD  A,0FFH
001844 E56B 32A2F0          13      LD  (_WTFATF),A
001847 E56E C9              10      RET
                                
       E56F                     N16CL3:
001848 E56F C5              11      PUSH    BC
001849 E570 6B               4      LD  L,E
00184A E571 7A               4      LD  A,D
00184B E572 E601             7      AND 1
00184D E574 67               4      LD  H,A
00184E E575 29              11      ADD HL,HL
00184F E576 ED4B7CF1        20      LD  BC,(_FATBF)
001853 E57A 09              11      ADD HL,BC
001854 E57B C1              10      POP BC
001855 E57C C9              10      RET
                                
       E57D                     GNCL16:
001856 E57D CDC6E4          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
001859 E580 D8              11      RET C
00185A E581 E5              11      PUSH    HL
00185B E582 CD6FE5          17      CALL    N16CL3
00185E E585 5E               7      LD  E,(HL)
00185F E586 23               6      INC HL
001860 E587 56               7      LD  D,(HL)
001861 E588 E1              10      POP HL
001862 E589 C9              10      RET
                                
       E58A                     SNCL16:
001863 E58A CDC6E4          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
001866 E58D D8              11      RET C
001867 E58E D5              11      PUSH    DE
001868 E58F E5              11      PUSH    HL
001869 E590 CD6FE5          17      CALL    N16CL3
00186C E593 D1              10      POP DE      ;HL
00186D E594 73               7      LD  (HL),E
00186E E595 23               6      INC HL
00186F E596 72               7      LD  (HL),D
001870 E597 6B               4      LD  L,E
001871 E598 62               4      LD  H,D
001872 E599 D1              10      POP DE
001873 E59A 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E59C                     NEXTX:
001875 E59C 3E00             7      LD  A,0 ;自己書き換え
       E59D                     _SECPS  EQU $-1
001877 E59E 3C               4      INC A
001878 E59F E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E5A0                     _NCPAT  EQU $-1
00187A E5A1 329DE5          13      LD  (_SECPS),A
00187D E5A4 C9              10      RET
                                
       E5A5                     GNCLX:
00187E E5A5 CD9CE5          17      CALL    NEXTX
001881 E5A8 C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
001882 E5A9 C3F7F0          10      JP  _GNCL   ;次のクラスタを探す
                                
       E5AC                     RDFAT:
001885 E5AC 3E80             7      LD  A,080H
001887 E5AE 3270F0          13      LD  (CHECK),A
       E5B1                     RDFAT1:
00188A E5B1 3A88F0          13      LD  A,(_DRV)
00188D E5B4 CD56E8          17      CALL    CHGDRVR
001890 E5B7 D8              11      RET C
001891 E5B8 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001894 E5BB CB6F             8      BIT 5,A
001896 E5BD 286E            12      JR  Z,RDFAT0X
001898 E5BF 2170F0          10      LD  HL,CHECK
00189B E5C2 A6               7      AND (HL)
00189C E5C3 77               7      LD  (HL),A
00189D E5C4 110000          10      LD  DE,0        ;BPB
0018A0 E5C7 2A7CF1          16      LD  HL,(_FATBF)
0018A3 E5CA 0E00             7      LD  C,0
0018A5 E5CC CD2EE7          17      CALL    DRD24
0018A8 E5CF 3024            12      JR  NC,GETBPB
0018AA E5D1 2170F0          10      LD  HL,CHECK
0018AD E5D4 CB06            15      RLC (HL)
0018AF E5D6 3F               4      CCF
0018B0 E5D7 D8              11      RET C
0018B1 E5D8 DDCB0A1E        23      RR  (IX+DPB_FDMODE)
0018B5 E5DC 3F               4      CCF         ;フロッピーディスクのFDモードを切り替える
0018B6 E5DD DDCB0A16        23      RL  (IX+DPB_FDMODE)
0018BA E5E1 3EFF             7      LD  A,0FFH
0018BC E5E3 3289F0          13      LD  (_DSK),A
0018BF E5E6 3A84F0          13      LD  A,(_DRIVE)
0018C2 E5E9 E603             7      AND 3
0018C4 E5EB F680             7      OR  080H
0018C6 E5ED 6F               4      LD  L,A
0018C7 E5EE 26F0             7      LD  H,_CYL0/256
0018C9 E5F0 3EFF             7      LD  A,0FFH
0018CB E5F2 77               7      LD  (HL),A
0018CC E5F3 18BC            12      JR  RDFAT1
       E5F5                     GETBPB:
0018CE E5F5 FDE5            15      PUSH    IY
0018D0 E5F7 FD2A7CF1        20      LD  IY,(_FATBF) ;BPB
0018D4 E5FB CDF1F0          17      CALL    _BPB2DPB
0018D7 E5FE FDE1            14      POP IY
0018D9 E600 DD7E12          19      LD  A,(IX+DPB_DEVICE)
0018DC E603 3025            12      JR  NC,GETBPBOK
0018DE E605 E60F             7      AND 00FH
0018E0 E607 FE07             7      CP  7
0018E2 E609 37               4      SCF
0018E3 E60A C0              11      RET NZ
0018E4 E60B DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
0018E8 E60F 21C0F1          10      LD  HL,M2D
0018EB E612 2006            12      JR  NZ,SETFDMODE
0018ED E614 CD07E7          17      CALL    CHECK1024
0018F0 E617 D8              11      RET C
0018F1 E618 2ED2             7      LD  L,M2HD-STABLE
       E61A                     SETFDMODE:
0018F3 E61A DDE5            15      PUSH    IX
0018F5 E61C D1              10      POP DE
0018F6 E61D EDA0            16      LDI
0018F8 E61F EDA0            16      LDI
0018FA E621 13               6      INC DE
0018FB E622 13               6      INC DE
0018FC E623 13               6      INC DE
0018FD E624 13               6      INC DE
0018FE E625 010C00          10      LD  BC,12
001901 E628 EDB0                    LDIR
       E62A                     GETBPBOK:
001903 E62A CDC2E7          17      CALL    CHGDRV2
       E62D                     RDFAT0X:
001906 E62D CD22E7          17      CALL    RDFATS
001909 E630 D8              11      RET C
00190A E631 DDAE06          19      XOR (IX+DPB_FATID)
00190D E634 C8              11      RET Z
00190E E635 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001911 E638 CB5F             8      BIT 3,A
001913 E63A 2803            12      JR  Z,RDFAT0X1
001915 E63C CB6F             8      BIT 5,A
001917 E63E C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
       E63F                     RDFAT0X1:
001918 E63F 37               4      SCF
001919 E640 C9              10      RET
                                
       E641                     POP_HL_SCF_RET:
00191A E641 E1              10      POP HL
00191B E642 37               4      SCF
00191C E643 C9              10      RET
                                
       E644                     BPB2DPB:
00191D E644 FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
001920 E647 B7               4      OR  A
001921 E648 37               4      SCF
001922 E649 C0              11      RET NZ
       E64A                     BPBOK:
001923 E64A FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
001926 E64D DD7707          19      LD  (IX+DPB_SECPCL),A
                                
001929 E650 FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
00192C E653 DD7700          19      LD  (IX+DPB_FATLN),A
00192F E656 FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
001932 E659 DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
001935 E65C FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
001938 E65F FD660F          19      LD  H,(IY+15)
00193B E662 DD750E          19      LD  (IX+DPB_FATPS),L
00193E E665 FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
001941 E668 FD5617          19      LD  D,(IY+23)
001944 E66B FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E66E                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
001947 E66E 19              11      ADD HL,DE
001948 E66F 10FD            13      DJNZ    BPBDP1
       E671                     BPBDP2:
00194A E671 DD7510          19      LD  (IX+DPB_DIRPS),L
00194D E674 DD7411          19      LD  (IX+DPB_DIRPS+1),H
001950 E677 E5              11      PUSH    HL
                                
001951 E678 FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
001954 E67B FD6612          19      LD  H,(IY+18)
001957 E67E FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
00195A E681 B7               4      OR  A
00195B E682 28BD            12      JR  Z,POP_HL_SCF_RET
00195D E684 0606             7      LD  B,6
       E686                     BPBBPS1:
00195F E686 05               4      DEC B
001960 E687 0F               4      RRCA
001961 E688 30FC            12      JR  NC,BPBBPS1
       E68A                     BPBDE1:
001963 E68A 29              11      ADD HL,HL
001964 E68B 10FD            13      DJNZ    BPBDE1
                                
001966 E68D 7C               4      LD  A,H
001967 E68E DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
00196A E691 D1              10      POP DE      ;DPB_DIRPS
00196B E692 6C               4      LD  L,H
00196C E693 2600             7      LD  H,0
00196E E695 19              11      ADD HL,DE       ;MAXDIR
00196F E696 E5              11      PUSH    HL
001970 E697 FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
001973 E69A CB21             8      SLA C       ;*2
001975 E69C AF               4      XOR A
001976 E69D 47               4      LD  B,A
001977 E69E ED42            15      SBC HL,BC
001979 E6A0 DD7514          19      LD  (IX+DPB_ADDCL),L
00197C E6A3 DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
00197F E6A6 D1              10      POP DE      ;DE=DPB_MAXDIR
001980 E6A7 FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
001983 E6AA FD6614          19      LD  H,(IY+20)
                                
001986 E6AD DD7E12          19      LD  A,(IX+DPB_DEVICE)
001989 E6B0 E60F             7      AND 00FH
00198B E6B2 FE07             7      CP  7       ;フロッピー
00198D E6B4 2019            12      JR  NZ,NOT_FD
00198F E6B6 E5              11      PUSH    HL
001990 E6B7 FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
001993 E6BA DD710D          19      LD  (IX+DPB_MAXSEC),C
001996 E6BD AF               4      XOR A
001997 E6BE CB21             8      SLA C       ;両面なのでセクタ数を２倍
001999 E6C0 0610             7      LD  B,16
       E6C2                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
00199B E6C2 29              11      ADD HL,HL
00199C E6C3 17               4      RLA
00199D E6C4 B9               4      CP  C
00199E E6C5 3802            12      JR  C,DIVSEC1
0019A0 E6C7 91               4      SUB C
0019A1 E6C8 2C               4      INC L
       E6C9                     DIVSEC1:
0019A2 E6C9 10F7            13      DJNZ    DIVSEC
0019A4 E6CB DD750C          19      LD  (IX+DPB_MAXCYL),L
0019A7 E6CE E1              10      POP HL  ;ここまでフロッピー専用
       E6CF                     NOT_FD:
0019A8 E6CF 7C               4      LD  A,H
0019A9 E6D0 B5               4      OR  L
0019AA E6D1 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
0019AC E6D3 200E            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
0019AE E6D5 2F               4      CPL         ;A=0FFH
0019AF E6D6 FD8623          19      ADD A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
0019B2 E6D9 D8              11      RET C
0019B3 E6DA FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
0019B6 E6DD FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので、
0019B9 E6E0 FD7E22          19      LD  A,(IY+34)   ;FAT12,FAT16では総セクタ数が24ビットを超えることは無い
       E6E3                     BPB16BIT:
0019BC E6E3 ED52            15      SBC HL,DE       ;DE=DPB_MAXDIR
0019BE E6E5 DE00             7      SBC A,0
0019C0 E6E7 FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E6EA                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
0019C3 E6EA CB18             8      RR  B       ;->CY
0019C5 E6EC 3808            12      JR  C,BPBTC2
0019C7 E6EE CB3F             8      SRL A
0019C9 E6F0 CB1C             8      RR  H       ;AHL=AHL/2
0019CB E6F2 CB1D             8      RR  L
0019CD E6F4 18F4            12      JR  BPBTC1
       E6F6                     BPBTC2:
0019CF E6F6 C6FF             7      ADD A,0FFH
0019D1 E6F8 D8              11      RET C       ;念のため(クラスタ数が16ビットを超える場合)
0019D2 E6F9 23               6      INC HL
0019D3 E6FA 23               6      INC HL
0019D4 E6FB DD7508          19      LD  (IX+DPB_MAXCL),L
0019D7 E6FE DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
0019DA E701 FD7E15          19      LD  A,(IY+21)   ;BPB_Media
0019DD E704 DD7706          19      LD  (IX+DPB_FATID),A
       E707                     CHECK1024:
0019E0 E707 FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
0019E3 E70A C6FE             7      ADD A,0-2       ;>2:CF=1
0019E5 E70C FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
0019E8 E70F 6F               4      LD  L,A
0019E9 E710 3002            12      JR  NC,BPBFAT1
0019EB E712 F680             7      OR  080H
       E714                     BPBFAT1:            ;ここではCF=0
0019ED E714 DD770F          19      LD  (IX+DPB_BPS),A
0019F0 E717 3A7BF1          13      LD  A,(_MAX_SEC_SZ_H)
0019F3 E71A BD               4      CP  L
0019F4 E71B C8              11      RET Z       ;1セクタ1024バイト
0019F5 E71C 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
0019F6 E71D C8              11      RET Z       ;1セクタ256バイト
0019F7 E71E 2D               4      DEC L
0019F8 E71F C8              11      RET Z       ;1セクタ512バイト
0019F9 E720 37               4      SCF
0019FA E721 C9              10      RET
                                
       E722                     RDFATS:
0019FB E722 CD4DE7          17      CALL    FATSETUP
0019FE E725 D8              11      RET C
0019FF E726 CD30E7          17      CALL    DRD24B
001A02 E729 2A7CF1          16      LD  HL,(_FATBF)
001A05 E72C 7E               7      LD  A,(HL)
001A06 E72D C9              10      RET
                                
       E72E                     DRD24:
001A07 E72E 0601             7      LD  B,1
       E730                     DRD24B:
001A09 E730 DDE5            15      PUSH    IX
001A0B E732 DD2AA8F0        20      LD  IX,(_DPB)
001A0F E736 CD96E9          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E737                     DRDPAT  EQU $-2
001A12 E739 DDE1            14      POP IX
001A14 E73B C9              10      RET
                                
       E73C                     DWT24:
001A15 E73C 0601             7      LD  B,1
       E73E                     DWT24B:
001A17 E73E DDE5            15      PUSH    IX
001A19 E740 DD2AA8F0        20      LD  IX,(_DPB)
001A1D E744 CD3FE9          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       E745                     DWTPAT  EQU $-2
001A20 E747 DDE1            14      POP IX
001A22 E749 D0              11      RET NC
001A23 E74A C35AF0          10      JP  _DISKE
                                
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ512毎に1KBを切り替える
                                ;------------------------
       E74D                     FATSETUP:
001A26 E74D 3AAAF0          13      LD  A,(_FATDRV)
001A29 E750 CD56E8          17      CALL    CHGDRVR     ;ドライブ切り替え
001A2C E753 D8              11      RET C
       E754                     FATS2:
001A2D E754 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001A30 E757 0F               4      RRCA
001A31 E758 CD88E7          17      CALL    FATSETUP12  ;自己書き換え
       E759                     FATSX   EQU $-2
001A34 E75B 210000          10      LD  HL,0
001A37 E75E 4A               4      LD  C,D
001A38 E75F 54               4      LD  D,H
001A39 E760 3AABF0          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-127(0-07FH):65535*2/1024
001A3C E763 47               4      LD  B,A
001A3D E764 04               4      INC B
001A3E E765 DD7E00          19      LD  A,(IX+DPB_FATLN)
       E768                     FAT_SKP:
001A41 E768 05               4      DEC B
001A42 E769 2809            12      JR  Z,FAT1
001A44 E76B 19              11      ADD HL,DE
001A45 E76C 93               4      SUB E
001A46 E76D 30F9            12      JR  NC,FAT_SKP
001A48 E76F DDCB0146        20      BIT 0,(IX+DPB_FATLN+1)  ;FATサイズが0100H(256)の場合
001A4C E773 C8              11      RET Z
       E774                     FAT1:
001A4D E774 EB               4      EX  DE,HL
001A4E E775 B7               4      OR  A       ;0の場合は0100Hとして扱う
001A4F E776 2803            12      JR  Z,FAT3
001A51 E778 B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001A52 E779 3801            12      JR  C,FAT2
       E77B                     FAT3:
001A54 E77B 79               4      LD  A,C
       E77C                     FAT2:
001A55 E77C 47               4      LD  B,A
                                
001A56 E77D 2AFAF1          16      LD  HL,(_FATPS) ;fat sector pos
001A59 E780 19              11      ADD HL,DE
001A5A E781 EB               4      EX  DE,HL
001A5B E782 2A7CF1          16      LD  HL,(_FATBF)
001A5E E785 AF               4      XOR A       ;CF=0
001A5F E786 4F               4      LD  C,A
001A60 E787 C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       E788                     FATSETUP12:
001A61 E788 110606          10      LD  DE,0606H    ;256
001A64 E78B D8              11      RET C
001A65 E78C 110303          10      LD  DE,0303H    ;512
001A68 E78F 0F               4      RRCA
001A69 E790 D8              11      RET C
001A6A E791 110102          10      LD  DE,0201H    ;1024
001A6D E794 C9              10      RET
                                
       E795                     FATSETUP16:
001A6E E795 110404          10      LD  DE,0404H    ;256
001A71 E798 D8              11      RET C
001A72 E799 110202          10      LD  DE,0202H    ;512
001A75 E79C 0F               4      RRCA
001A76 E79D D8              11      RET C
001A77 E79E 110101          10      LD  DE,0101H    ;1024
001A7A E7A1 C9              10      RET
                                
       E7A2                     CHGDRV:
001A7B E7A2 E5              11      PUSH    HL
001A7C E7A3 2189F0          10      LD  HL,_DSK
001A7F E7A6 BE               7      CP  (HL)
001A80 E7A7 280A            12      JR  Z,CHGDRVE
       E7A9                     CHGDRV1:
001A82 E7A9 DDE5            15      PUSH    IX
001A84 E7AB CDB5E7          17      CALL    CHGDRV0
001A87 E7AE 3A89F0          13      LD  A,(_DSK)
001A8A E7B1 DDE1            14      POP IX
       E7B3                     CHGDRVE:
001A8C E7B3 E1              10      POP HL
001A8D E7B4 C9              10      RET
                                
       E7B5                     CHGDRV0:
001A8E E7B5 6F               4      LD  L,A
001A8F E7B6 CDDCF0          17      CALL    _GETDPB
001A92 E7B9 D8              11      RET C
001A93 E7BA DD22A8F0        20      LD  (_DPB),IX
001A97 E7BE 7D               4      LD  A,L
001A98 E7BF 3289F0          13      LD  (_DSK),A
       E7C2                     CHGDRV2:
001A9B E7C2 C5              11      PUSH    BC
001A9C E7C3 D5              11      PUSH    DE
001A9D E7C4 ED730DE8        20      LD  (SPPAT2),SP
001AA1 E7C8 F3               4      DI
001AA2 E7C9 DDF9            10      LD  SP,IX
                                
001AA4 E7CB E1              10      POP HL      ;00:DPB_FATLN
001AA5 E7CC E1              10      POP HL      ;02:DPB_DRD
001AA6 E7CD 2237E7          16      LD  (DRDPAT),HL
                                
001AA9 E7D0 E1              10      POP HL
001AAA E7D1 2245E7          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001AAD E7D4 E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001AAE E7D5 7C               4      LD  A,H
001AAF E7D6 3239DE          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001AB2 E7D9 3D               4      DEC A
001AB3 E7DA 32A0E5          13      LD  (_NCPAT),A
                                
001AB6 E7DD E1              10      POP HL      ;08:DPB_MAXCL
001AB7 E7DE 7D               4      LD  A,L
001AB8 E7DF 3258DE          13      LD  (CLPAT2),A
001ABB E7E2 7C               4      LD  A,H
001ABC E7E3 3254DE          13      LD  (CLPAT1),A
001ABF E7E6 2B               6      DEC HL
001AC0 E7E7 2257E0          16      LD  (MAXCLP),HL
                                
001AC3 E7EA E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001AC4 E7EB 4C               4      LD  C,H
                                
001AC5 E7EC E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001AC6 E7ED E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001AC7 E7EE 7C               4      LD  A,H     ;DPB_BPS
001AC8 E7EF E607             7      AND 7
001ACA E7F1 3212E3          13      LD  (SECSZ_H),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98等
                                                ;1セクタ256 GRAM/RAMF/CMOS等
                                                ;1024   512 256
                                                ;4  2   1
001ACD E7F4 87               4      ADD A,A     ;8  4   2
001ACE E7F5 87               4      ADD A,A     ;010H   8   4
001ACF E7F6 87               4      ADD A,A     ;020H   010H    8
001AD0 E7F7 32B7DC          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001AD3 E7FA 2600             7      LD  H,0
001AD5 E7FC 22FAF1          16      LD  (_FATPS),HL
                                
001AD8 E7FF E1              10      POP HL      ;10:DPB_DIRPS
001AD9 E800 22FCF1          16      LD  (_DIRPS),HL
                                
001ADC E803 E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001ADD E804 7C               4      LD  A,H
001ADE E805 3284F0          13      LD  (_DRIVE),A
                                
001AE1 E808 E1              10      POP HL      ;14:DPB_ADDCL
001AE2 E809 2249DE          16      LD  (CLSPAT),HL
                                
001AE5 E80C 310000          10      LD  SP,0        ;元のSPを復元
       E80D                     SPPAT2  EQU $-2
001AE8 E80F FB               4      EI
001AE9 E810 2AFCF1          16      LD  HL,(_DIRPS)
001AEC E813 0600             7      LD  B,0
001AEE E815 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001AEF E816 22D2DC          16      LD  (MD_PAT),HL
                                
001AF2 E819 2A57E0          16      LD  HL,(MAXCLP)
001AF5 E81C 110AF0          10      LD  DE,0-4086   ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001AF8 E81F 19              11      ADD HL,DE
001AF9 E820 380F            12      JR  C,SETFAT16
001AFB E822 2126E5          10      LD  HL,GNCL     ;FAT12
001AFE E825 1149E5          10      LD  DE,SNCL
001B01 E828 0188E7          10      LD  BC,FATSETUP12
001B04 E82B DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001B08 E82F 180D            12      JR  EXTRA1
       E831                     SETFAT16:
001B0A E831 217DE5          10      LD  HL,GNCL16   ;FAT16
001B0D E834 118AE5          10      LD  DE,SNCL16
001B10 E837 0195E7          10      LD  BC,FATSETUP16
001B13 E83A DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       E83E                     EXTRA1:
001B17 E83E 22F8F0          16      LD  (GNCPAT),HL
001B1A E841 ED53FBF0        20      LD  (SNCPAT),DE
001B1E E845 ED4359E7        20      LD  (FATSX),BC
001B22 E849 D1              10      POP DE
001B23 E84A C1              10      POP BC
001B24 E84B AF               4      XOR A
001B25 E84C C9              10      RET
                                
       E84D                     GETDPBD:
001B26 E84D DDE3            23      EX  (SP),IX
001B28 E84F DDE5            15      PUSH    IX
001B2A E851 3A88F0          13      LD  A,(_DRV)
001B2D E854 1807            12      JR  GETDPB1
                                
       E856                     CHGDRVR:
001B2F E856 CDD9F0          17      CALL    _CHGDRV
001B32 E859 D8              11      RET C
001B33 E85A 3A89F0          13      LD  A,(_DSK)
       E85D                     GETDPB1:
001B36 E85D C3DCF0          10      JP  _GETDPB
                                
       E860                     GETDPB:
001B39 E860 FE08             7      CP  8
001B3B E862 3F               4      CCF
001B3C E863 D8              11      RET C
001B3D E864 0F               4      RRCA
001B3E E865 0F               4      RRCA
001B3F E866 0F               4      RRCA
001B40 E867 DD                      DB  0DDH        ;Z80未定義命令
001B41 E868 6F               4      LD  L,A     ;LD IXL,A
001B42 E869 DD                      DB  0DDH        ;Z80未定義命令
001B43 E86A 26F2             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
001B45 E86C DD7E00          19      LD  A,(IX+DPB_FATLN)
001B48 E86F A7               4      AND A       ;CF=0の為
001B49 E870 DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
001B4D E874 C0              11      RET NZ      ;FAT16
001B4E E875 DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001B52 E879 C0              11      RET NZ      ;BPB
001B53 E87A FE01             7      CP  001H        ;A=0 THEN CF=1
001B55 E87C C9              10      RET
                                
       E87D                     _SYS5F:
001B56 E87D AF               4      XOR A
       E87E                     FFLUSH:
001B57 E87E F5              11      PUSH    AF
001B58 E87F CDA4E4          17      CALL    WTFATX
001B5B E882 AF               4      XOR A
001B5C E883 32ABF0          13      LD  (_FATIX),A
001B5F E886 2F               4      CPL         ;0FFH
001B60 E887 32AAF0          13      LD  (_FATDRV),A
001B63 E88A 3E                      DB  03EH        ;次のPUSH AFをスキップ
       E88B                     FFLUSHBUF:
001B64 E88B F5              11      PUSH    AF
001B65 E88C CD5AE4          17      CALL    DWTX
001B68 E88F 3EFF             7      LD  A,0FFH
001B6A E891 3239F0          13      LD  (SFILE),A
001B6D E894 32A5F0          13      LD  (_DBDRV),A
001B70 E897 F1              10      POP AF
001B71 E898 C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   MZ-700/1500
                                
       E899                     SEEK:
001B72 E899 0610             7      LD  B,16
001B74 E89B DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001B77 E89E AF               4      XOR A
001B78 E89F EB               4      EX  DE,HL
       E8A0                     DIV1:
001B79 E8A0 29              11      ADD HL,HL
001B7A E8A1 8F               4      ADC A,A
001B7B E8A2 B9               4      CP  C
001B7C E8A3 3802            12      JR  C,DIV2
001B7E E8A5 91               4      SUB C
001B7F E8A6 2C               4      INC L
       E8A7                     DIV2:
001B80 E8A7 10F7            13      DJNZ    DIV1
                                
001B82 E8A9 3C               4      INC A   ;最小のセクタは１固定
001B83 E8AA 55               4      LD  D,L ;TRACK
001B84 E8AB 5F               4      LD  E,A ;SECTOR
                                
001B85 E8AC 3A84F0          13      LD  A,(_DRIVE)
001B88 E8AF FE04             7      CP  4
001B8A E8B1 3F               4      CCF
001B8B E8B2 D8              11      RET C
001B8C E8B3 F684             7      OR  084H        ;Motor on + ドライブセレクト有効
001B8E E8B5 D3DC            11      OUT (0DCH),A    ;モータ/ドライブセレクト制御レジスタ
001B90 E8B7 CB3A             8      SRL D       ;CYLINDER
001B92 E8B9 9F               4      SBC A,A
001B93 E8BA D3DD            11      OUT (0DDH),A    ;ヘッドセレクト制御レジスタ
                                
001B95 E8BC CDF4E8          17      CALL    SETMODE
001B98 E8BF D8              11      RET C
                                
001B99 E8C0 CD29E9          17      CALL    DRIVE
001B9C E8C3 FEFF             7      CP  0FFH        ;A=0FFH Unknown CYLINDER
001B9E E8C5 CC0BE9          17      CALL    Z,FDCRES    ;Restore
001BA1 E8C8 2F               4      CPL         ;データバスが負論理
001BA2 E8C9 D3D9            11      OUT (0D9H),A    ;MB8876 トラックレジスタ
001BA4 E8CB 2F               4      CPL         ;データバスが負論理
001BA5 E8CC 92               4      SUB D
001BA6 E8CD C8              11      RET Z       ;No seek
                                
001BA7 E8CE DD7E0C          19      LD  A,(IX+DPB_MAXCYL)
001BAA E8D1 3D               4      DEC A
001BAB E8D2 BA               4      CP  D       ;Over CYLINDER
001BAC E8D3 D8              11      RET C
                                
001BAD E8D4 7A               4      LD  A,D
001BAE E8D5 2F               4      CPL         ;データバスが負論理
001BAF E8D6 D3DB            11      OUT (0DBH),A    ;MB8876 データレジスタ
001BB1 E8D8 72               7      LD  (HL),D
                                
001BB2 E8D9 0E18             7      LD  C,018H      ;FDC TypeIコマンド Seek
       E8DB                     FDCCMD2:
001BB4 E8DB 3A85F0          13      LD  A,(_SEEKSP)
001BB7 E8DE B1               4      OR  C
                                
       E8DF                     FDCCMD:
001BB8 E8DF CD20E9          17      CALL    COMSET
001BBB E8E2 3E80             7      LD  A,080H      ;FDC COMMAND(Self-modifying code)
       E8E3                     FDCSMC  EQU $-1
001BBD E8E4 E620             7      AND 020H        ;Write data Write track
001BBF E8E6 3C               4      INC A
                                
       E8E7                     SST:
001BC0 E8E7 0E00             7      LD  C,0
       E8E9                     SST1:
001BC2 E8E9 0D               4      DEC C       ; 4
001BC3 E8EA 20FD            12      JR  NZ,SST1     ;12 * 256 / 4 = About 1ms
001BC5 E8EC 3D               4      DEC A
001BC6 E8ED 20FA            12      JR  NZ,SST1
                                
001BC8 E8EF 0E01             7      LD  C,1
001BCA E8F1 CDF9E8          17      CALL    READY
       E8F4                     SETMODE:
001BCD E8F4 CD23E9          17      CALL    DELAY0      ;Head select time
001BD0 E8F7 0E81             7      LD  C,081H
       E8F9                     READY:
001BD2 E8F9 0680             7      LD  B,128
       E8FB                     READY2:
001BD4 E8FB DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001BD6 E8FD 2F               4      CPL         ;データバスが負論理
001BD7 E8FE A1               4      AND C       ;NOT READY,BUSY
001BD8 E8FF C8              11      RET Z
001BD9 E900 CD1BCF          17      CALL    RD556VSYNC
001BDC E903 07               4      RLCA
001BDD E904 A8               4      XOR B
001BDE E905 0F               4      RRCA
001BDF E906 30F3            12      JR  NC,READY2
001BE1 E908 10F1            13      DJNZ    READY2
001BE3 E90A C9              10      RET
                                
       E90B                     FDCRES:
001BE4 E90B 3600            10      LD  (HL),0
001BE6 E90D 0E08             7      LD  C,8     ;FDC TypeIコマンド Restore
001BE8 E90F 18CA            12      JR  FDCCMD2
                                
       E911                     FDMOFF:
001BEA E911 F5              11      PUSH    AF
001BEB E912 AF               4      XOR A       ;Motor off(ドライブセレクト無効)
001BEC E913 D3DC            11      OUT (0DCH),A    ;モータ/ドライブセレクト制御レジスタ
001BEE E915 F1              10      POP AF
001BEF E916 C9              10      RET
                                
       E917                     SECSET_FDCCMD:
001BF0 E917 3AE3E8          13      LD  A,(FDCSMC)
       E91A                     SECSET:
001BF3 E91A F5              11      PUSH    AF
001BF4 E91B 7B               4      LD  A,E
001BF5 E91C 2F               4      CPL         ;データバスが負論理
001BF6 E91D D3DA            11      OUT (0DAH),A    ;MB8876 セクタレジスタ
001BF8 E91F F1              10      POP AF
       E920                     COMSET:
001BF9 E920 2F               4      CPL         ;データバスが負論理
001BFA E921 D3D8            11      OUT (0D8H),A    ;MB8876 ステータス/コマンドレジスタ
       E923                     DELAY0:
001BFC E923 3E1A             7      LD  A,26
       E925                     DELAY:
001BFE E925 3D               4      DEC A
001BFF E926 20FD            12      JR  NZ,DELAY
001C01 E928 C9              10      RET
                                
       E929                     DRIVE:                  ;ドライブのシリンダを得る
001C02 E929 2A84F0          16      LD  HL,(_DRIVE)
001C05 E92C 26F0             7      LD  H,_CYL0/256
001C07 E92E CBFD             8      SET 7,L
001C09 E930 7E               7      LD  A,(HL)
001C0A E931 C9              10      RET
                                
       E932                     RNF:                    ;ドライブのシリンダをリセット
001C0B E932 CD29E9          17      CALL    DRIVE
001C0E E935 36FF            10      LD  (HL),0FFH
001C10 E937 C9              10      RET
                                
001C11 E938 02                  RETRY:  DB  2
                                
                                
                                ;   FLOPPY DISK DRIVER
                                
       E939                     WTTRK:
001C12 E939 0601             7      LD  B,1
001C14 E93B 3EF4             7      LD  A,0F4H      ;FDC TypeIIIコマンド Write Track
001C16 E93D 1802            12      JR  WTTRK1
       E93F                     FDWT:
001C18 E93F 3EA0             7      LD  A,0A0H      ;FDC TypeIIコマンド Write Sector
       E941                     WTTRK1:
001C1A E941 32E3E8          13      LD  (FDCSMC),A
       E944                     DWTBL:
001C1D E944 78               4      LD  A,B
001C1E E945 3281E9          13      LD  (WTBSMC),A
001C21 E948 3E02             7      LD  A,2     ;Retry count
001C23 E94A 3238E9          13      LD  (RETRY),A
                                
       E94D                     DWT0:
001C26 E94D D5              11      PUSH    DE
001C27 E94E E5              11      PUSH    HL
001C28 E94F CD99E8          17      CALL    SEEK        ;Write disk
001C2B E952 E1              10      POP HL
001C2C E953 3837            12      JR  C,ERRDW
001C2E E955 F3               4      DI
001C2F E956 CD17E9          17      CALL    SECSET_FDCCMD
001C32 E959 0EDB             7      LD  C,0DBH      ;MB8876 データレジスタ
       E95B                     DWT1:
001C34 E95B 7E               7      LD  A,(HL)
001C35 E95C 2F               4      CPL         ;データバスが負論理
001C36 E95D 57               4      LD  D,A
                                
       E95E                     DWT2:
001C37 E95E DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001C39 E960 2F               4      CPL         ;データバスが負論理
001C3A E961 0F               4      RRCA
001C3B E962 3008            12      JR  NC,DWT4
001C3D E964 0F               4      RRCA
001C3E E965 30F7            12      JR  NC,DWT2
       E967                     DWT3:
001C40 E967 ED51            12      OUT (C),D       ;MB8876 データレジスタ
001C42 E969 23               6      INC HL
001C43 E96A 18EF            12      JR  DWT1
                                
       E96C                     DWT4:
001C45 E96C 3D               4      DEC A
001C46 E96D 28F8            12      JR  Z,DWT3
001C48 E96F 3C               4      INC A
001C49 E970 FB               4      EI
001C4A E971 D1              10      POP DE
001C4B E972 13               6      INC DE
001C4C E973 CD11E9          17      CALL    FDMOFF
001C4F E976 2808            12      JR  Z,DISKOK_WT
001C51 E978 CDE0E9          17      CALL    DISKC
001C54 E97B 20D0            12      JR  NZ,DWT0
001C56 E97D B7               4      OR  A
001C57 E97E 2005            12      JR  NZ,ERRW
                                
       E980                     DISKOK_WT:
001C59 E980 0601             7      LD  B,1
       E981                     WTBSMC  EQU $-1
001C5B E982 10C0            13      DJNZ    DWTBL
001C5D E984 C9              10      RET
                                
       E985                     ERRW:
001C5E E985 3EFF             7      LD  A,0FFH
       E987                     ERRZ:
001C60 E987 BF               4      CP  A       ;ZF=1
001C61 E988 37               4      SCF
001C62 E989 C311E9          10      JP  FDMOFF
                                
       E98C                     ERRDW:
001C65 E98C D1              10      POP DE
001C66 E98D CDF1E9          17      CALL    DELP
001C69 E990 20BB            12      JR  NZ,DWT0
001C6B E992 B7               4      OR  A
001C6C E993 20F0            12      JR  NZ,ERRW
001C6E E995 C9              10      RET
                                
       E996                     FDRD:
001C6F E996 3E80             7      LD  A,080H      ;FDC TypeIIコマンド Read Sector
001C71 E998 32E3E8          13      LD  (FDCSMC),A
       E99B                     DRDBL:
001C74 E99B 78               4      LD  A,B
001C75 E99C 32D2E9          13      LD  (RDBSMC),A
001C78 E99F 3E02             7      LD  A,2     ;Retry count
001C7A E9A1 3238E9          13      LD  (RETRY),A
       E9A4                     DRD0:
001C7D E9A4 D5              11      PUSH    DE
001C7E E9A5 E5              11      PUSH    HL
001C7F E9A6 CD99E8          17      CALL    SEEK        ;Read disk
001C82 E9A9 E1              10      POP HL
001C83 E9AA 382A            12      JR  C,ERRDR
001C85 E9AC F3               4      DI
001C86 E9AD CD17E9          17      CALL    SECSET_FDCCMD
       E9B0                     DRD1:
001C89 E9B0 DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001C8B E9B2 2F               4      CPL         ;データバスが負論理
001C8C E9B3 0F               4      RRCA
001C8D E9B4 300A            12      JR  NC,DRD3
001C8F E9B6 0F               4      RRCA
001C90 E9B7 30F7            12      JR  NC,DRD1
001C92 E9B9 DBDB            11      IN  A,(0DBH)    ;MB8876 データレジスタ
001C94 E9BB 2F               4      CPL         ;データバスが負論理
001C95 E9BC 77               7      LD  (HL),A
001C96 E9BD 23               6      INC HL
001C97 E9BE 18F0            12      JR  DRD1
                                
       E9C0                     DRD3:
001C99 E9C0 B7               4      OR  A
001C9A E9C1 FB               4      EI
001C9B E9C2 D1              10      POP DE
001C9C E9C3 13               6      INC DE
001C9D E9C4 CD11E9          17      CALL    FDMOFF
001CA0 E9C7 2808            12      JR  Z,DISKOK_RD
001CA2 E9C9 CDE0E9          17      CALL    DISKC
001CA5 E9CC 20D6            12      JR  NZ,DRD0
001CA7 E9CE B7               4      OR  A
001CA8 E9CF 20B4            12      JR  NZ,ERRW
                                
       E9D1                     DISKOK_RD:
001CAA E9D1 0601             7      LD  B,1
       E9D2                     RDBSMC  EQU $-1
001CAC E9D3 10C6            13      DJNZ    DRDBL
001CAE E9D5 C9              10      RET
                                
       E9D6                     ERRDR:
001CAF E9D6 D1              10      POP DE
001CB0 E9D7 CDF1E9          17      CALL    DELP
001CB3 E9DA 20C8            12      JR  NZ,DRD0
001CB5 E9DC B7               4      OR  A
001CB6 E9DD 20A6            12      JR  NZ,ERRW
001CB8 E9DF C9              10      RET
       E9E0                     DISKC:
001CB9 E9E0 1B               6      DEC DE
001CBA E9E1 CB5F             8      BIT 3,A
001CBC E9E3 C432E9          17      CALL    NZ,RNF
       E9E6                     DISKD:
001CBF E9E6 E5              11      PUSH    HL
001CC0 E9E7 2138E9          10      LD  HL,RETRY
001CC3 E9EA 35              11      DEC (HL)
001CC4 E9EB E1              10      POP HL
001CC5 E9EC 200C            12      JR  NZ,ERR      ;Retry
001CC7 E9EE B7               4      OR  A
001CC8 E9EF 2809            12      JR  Z,ERR       ;Error
                                
       E9F1                     DELP:
001CCA E9F1 CD32E9          17      CALL    RNF
001CCD E9F4 CD11E9          17      CALL    FDMOFF
001CD0 E9F7 3EFF             7      LD  A,0FFH
       E9F9                     AERRZ:
001CD2 E9F9 BF               4      CP  A
       E9FA                     ERR:
001CD3 E9FA 3EFF             7      LD  A,0FFH
001CD5 E9FC C9              10      RET
[EOF:M7DISK.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   MZ-700/1500
                                
                                ;   EMM DRIVER
                                ;   1セクタ可変(256/512/1024)
                                
       E9FD                     EDWT:
001CD6 E9FD F5              11      PUSH    AF
001CD7 E9FE CD1CEA          17      CALL    EADR
001CDA EA01 0600             7      LD  B,0
       EA03                     EDWT1:
001CDC EA03 EDB3                    OTIR
001CDE EA05 3D               4      DEC A
001CDF EA06 20FB            12      JR  NZ,EDWT1
001CE1 EA08 180B            12      JR  EDRW1
                                
       EA0A                     EDRD:
001CE3 EA0A C5              11      PUSH    BC
001CE4 EA0B CD1CEA          17      CALL    EADR
001CE7 EA0E 0600             7      LD  B,0
       EA10                     EDRD1:
001CE9 EA10 EDB2                    INIR
001CEB EA12 3D               4      DEC A
001CEC EA13 20FB            12      JR  NZ,EDRD1
       EA15                     EDRW1:
001CEE EA15 F1              10      POP AF
001CEF EA16 83               4      ADD A,E ;セクタを進める
001CF0 EA17 5F               4      LD  E,A
001CF1 EA18 8A               4      ADC A,D
001CF2 EA19 93               4      SUB E
001CF3 EA1A 57               4      LD  D,A
001CF4 EA1B C9              10      RET
                                
       EA1C                     EADR:
001CF5 EA1C D5              11      PUSH    DE
001CF6 EA1D EB               4      EX  DE,HL
001CF7 EA1E 78               4      LD  A,B
001CF8 EA1F DD460F          19      LD  B,(IX+DPB_BPS)
       EA22                     EADR1:              ;読み込むセクタ数と1クラスタのセクタ数を掛ける
001CFB EA22 CB18             8      RR  B
001CFD EA24 3804            12      JR  C,EADR2
001CFF EA26 87               4      ADD A,A
001D00 EA27 29              11      ADD HL,HL
001D01 EA28 18F8            12      JR  EADR1
       EA2A                     EADR2:
001D03 EA2A DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001D06 EA2D DD460C          19      LD  B,(IX+DPB_MAXCYL)
001D09 EA30 09              11      ADD HL,BC
001D0A EA31 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001D0D EA34 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
001D0F EA36 0C               4      INC C
001D10 EA37 ED69            12      OUT (C),L
001D12 EA39 0C               4      INC C
001D13 EA3A ED61            12      OUT (C),H
001D15 EA3C 0C               4      INC C
001D16 EA3D EB               4      EX  DE,HL
001D17 EA3E D1              10      POP DE
001D18 EA3F C9              10      RET
                                
                                ;   CMOS BACKUP MEMORY DRIVER(32KB)
                                ;   1セクタ256
                                
       EA40                     CDWT:
001D19 EA40 78               4      LD  A,B
001D1A EA41 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001D1D EA44 ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001D1F EA46 ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001D21 EA48 01FA00          10      LD  BC,000FAH
       EA4B                     CDWT1:
001D24 EA4B EDB3                    OTIR            ;W)データ書き込み・アドレスカウンタ+1
001D26 EA4D 13               6      INC DE
001D27 EA4E 3D               4      DEC A
001D28 EA4F 20FA            12      JR  NZ,CDWT1
001D2A EA51 A7               4      AND A
001D2B EA52 C9              10      RET
                                
       EA53                     CDRD:
001D2C EA53 78               4      LD  A,B
001D2D EA54 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001D30 EA57 ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001D32 EA59 ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001D34 EA5B 01F900          10      LD  BC,000F9H
       EA5E                     CDRD1:
001D37 EA5E EDB2                    INIR            ;R)データ読み出し・アドレスカウンタ+1
001D39 EA60 13               6      INC DE
001D3A EA61 3D               4      DEC A
001D3B EA62 20FA            12      JR  NZ,CDRD1
001D3D EA64 A7               4      AND A
001D3E EA65 C9              10      RET
                                
                                ;   RAM DISK DRIVER (64KB)
                                ;   1セクタ256
                                
       EA66                     RDWT:
001D3F EA66 3EB3             7      LD  A,0B3H      ;OTIR
001D41 EA68 1802            12      JR  RDRW
       EA6A                     RDRD:
001D43 EA6A 3EB2             7      LD  A,0B2H      ;INIR
       EA6C                     RDRW:
001D45 EA6C 3279EA          13      LD  (RDRW1+1),A
                                
001D48 EA6F 78               4      LD  A,B
001D49 EA70 43               4      LD  B,E     ;B=アドレスカウンタ上位(X1の様な16bitのI/Oアクセス)
001D4A EA71 0EEB             7      LD  C,0EBH
001D4C EA73 ED71            12      OUT (C),0       ;0=アドレスカウンタ下位
001D4E EA75 0D               4      DEC C       ;EA(R)データ読み出し・アドレスカウンタ+1
001D4F EA76 0600             7      LD  B,0
       EA78                     RDRW1:
001D51 EA78 EDB2                    INIR            ;自己書き換え(INIR/OTIR)
001D53 EA7A 13               6      INC DE
001D54 EA7B 3D               4      DEC A
001D55 EA7C 20FA            12      JR  NZ,RDRW1
001D57 EA7E A7               4      AND A
001D58 EA7F C9              10      RET
                                
                                ;   G-RAM(PCG) DISK DRIVER (24KB)
                                ;   1セクタ256
                                
       EA80                     GDWT:
001D59 EA80 C5              11      PUSH    BC
001D5A EA81 D5              11      PUSH    DE
001D5B EA82 CDAAEA          17      CALL    GADR
       EA85                     GDWT2:
001D5E EA85 4E               7      LD  C,(HL)
001D5F EA86 23               6      INC HL
001D60 EA87 EB               4      EX  DE,HL   ;HL=PCG,DE=メモリ
001D61 EA88 CDD2CF          17      CALL    WR_PCG
001D64 EA8B 23               6      INC HL
001D65 EA8C EB               4      EX  DE,HL   ;HL=メモリ,DE=PCG
001D66 EA8D 10F6            13      DJNZ    GDWT2
001D68 EA8F D1              10      POP DE
001D69 EA90 1C               4      INC E
001D6A EA91 C1              10      POP BC
001D6B EA92 10EC            13      DJNZ    GDWT
001D6D EA94 C9              10      RET
       EA95                     GDRD:
001D6E EA95 C5              11      PUSH    BC
001D6F EA96 D5              11      PUSH    DE
001D70 EA97 CDAAEA          17      CALL    GADR
       EA9A                     GDRD2:
001D73 EA9A EB               4      EX  DE,HL   ;HL=PCG,DE=メモリ
001D74 EA9B CDCACF          17      CALL    RD_PCG
001D77 EA9E 23               6      INC HL
001D78 EA9F EB               4      EX  DE,HL   ;HL=メモリ,DE=PCG
001D79 EAA0 71               7      LD  (HL),C
001D7A EAA1 23               6      INC HL
001D7B EAA2 10F6            13      DJNZ    GDRD2
001D7D EAA4 D1              10      POP DE
001D7E EAA5 1C               4      INC E
001D7F EAA6 C1              10      POP BC
001D80 EAA7 10EC            13      DJNZ    GDRD
001D82 EAA9 C9              10      RET
                                
       EAAA                     GADR:
001D83 EAAA 7B               4      LD  A,E
001D84 EAAB E61F             7      AND 01FH
001D86 EAAD C6D0             7      ADD A,0D0H
001D88 EAAF 57               4      LD  D,A
001D89 EAB0 7B               4      LD  A,E
001D8A EAB1 07               4      RLCA
001D8B EAB2 07               4      RLCA
001D8C EAB3 07               4      RLCA
001D8D EAB4 3C               4      INC A
001D8E EAB5 0600             7      LD  B,0
001D90 EAB7 58               4      LD  E,B
001D91 EAB8 C9              10      RET
[EOF:M7DISK2.ASM:UTF_8]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
001D92 EAB9                     PATHD:  DS  PATHX
001DCD EAF4 00                  PATHE:  DB  0
                                
       EAF5                     DTA_CCP:
001DCE EAF5                         DS  37
                                
       EB1A                     FCB_BAT:
001DF3 EB1A                         DS  37
                                
001E18 EB3F 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
001E23 EB4A 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "M7TABLE.ASM"
                                
                                ;   LSX-Dodgers TABLE 表示関連のテーブル
                                ;   MZ-700/1500
                                
       EB51                     AT_TABLE:
001E2A EB51                         DS  TABLEAD-AT_TABLE
                                
       ED40                     KEY_TABLE:
002019 ED40 12081E1F1C1D5C2F        DB  12H,08H,1EH,1FH,1CH,1DH,5CH,'/'
002021 ED48 5C5E2D2030392C2E        DB  5CH,'^','-',20H,'0','9',',','.'
002029 ED50 3132333435363738        DB  '1','2','3','4','5','6','7','8'
002031 ED58 6162636465666768        DB  'a','b','c','d','e','f','g','h'
002039 ED60 696A6B6C6D6E6F70        DB  'i','j','k','l','m','n','o','p'
002041 ED68 7172737475767778        DB  'q','r','s','t','u','v','w','x'
002049 ED70 797A405B5D000000        DB  'y','z','@','[',']',00H,00H,00H
002051 ED78 001B3D09003B3A0D        DB  00H,1BH,'=',09H,00H,';',':',0DH
       ED80                     SHIFT_TABLE:
002059 ED80 12081E1F1C1D5F3F        DB  12H,08H,1EH,1FH,1CH,1DH,'_','?'
002061 ED88 7C7E3D2030293C3E        DB  '|','~','=',20H,'0',')','<','>'
002069 ED90 2122232425262728        DB  '!','"','#','$','%','&',27H,'('
002071 ED98 4142434445464748        DB  'A','B','C','D','E','F','G','H'
002079 EDA0 494A4B4C4D4E4F50        DB  'I','J','K','L','M','N','O','P'
002081 EDA8 5152535455565758        DB  'Q','R','S','T','U','V','W','X'
002089 EDB0 595A607B7D000000        DB  'Y','Z','`','{','}',00H,00H,00H
002091 EDB8 00003D09002B2A0D        DB  00H,00H,'=',09H,00H,'+','*',0DH
       EDC0                     CTRL_TABLE:
002099 EDC0 12081E1F1C1D3F2F        DB  12H,08H,1EH,1FH,1CH,1DH,'?','/'
0020A1 EDC8 2A2B2D2030392C2E        DB  '*','+','-',20H,'0','9',',','.'
0020A9 EDD0 3132333435363738        DB  '1','2','3','4','5','6','7','8'
0020B1 EDD8 0102030405060708        DB  01H,02H,03H,04H,05H,06H,07H,08H
0020B9 EDE0 090A0B0C0D0E0F10        DB  09H,0AH,0BH,0CH,0DH,0EH,0FH,10H
0020C1 EDE8 1112131415161718        DB  11H,12H,13H,14H,15H,16H,17H,18H
0020C9 EDF0 191A1B5B5D000000        DB  19H,1AH,1BH,'[',']',00H,00H,00H
0020D1 EDF8 00003D09003B3A0D        DB  00H,00H,'=',09H,00H,';',':',0DH
                                
                                ;   アドレス下位1バイトが0になるように
       EE00                     CD_TABLE:
0020D9 EE00 00D1D2D3D4D5D6D0        DB  $00,$D1,$D2,$D3,$D4,$D5,$D6,$D0 ;月火水木金土日
0020E1 EE08 D8DCD9DADBD7CFCE        DB  $D8,$DC,$D9,$DA,$DB,$D7,$CF,$CE ;年円時分秒
0020E9 EE10 601F5F5E1E1B7978        DB  $60,$1F,$5F,$5E,$1E,$1B,$79,$78 ;
0020F1 EE18 5C5D1C1D6DCACDC7        DB  $5C,$5D,$1C,$1D,$6D,$CA,$CD,$C7 ;
0020F9 EE20 0061626364656667        DB  $00,$61,$62,$63,$64,$65,$66,$67 ; !"#$%&'
002101 EE28 68696B6A2F2A2E2D        DB  $68,$69,$6B,$6A,$2F,$2A,$2E,$2D ;()*+,-./
002109 EE30 2021222324252627        DB  $20,$21,$22,$23,$24,$25,$26,$27 ;01234567
002111 EE38 28294F2C512B5749        DB  $28,$29,$4F,$2C,$51,$2B,$57,$49 ;89:;<=>?
002119 EE40 5501020304050607        DB  $55,$01,$02,$03,$04,$05,$06,$07 ;@ABCDEFG
002121 EE48 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;HIJKLMNO
002129 EE50 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;PQRSTUVW
002131 EE58 18191A52DD54507C        DB  $18,$19,$1A,$52,$DD,$54,$50,$7C ;XYZ[\]^_
002139 EE60 5901020304050607        DB  $59,$01,$02,$03,$04,$05,$06,$07 ;`abcdefg   ATB:1
002141 EE68 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;hijklmno   ATB:1
002149 EE70 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;pqrstuvw   ATB:1
002151 EE78 18191ACB35CC705A        DB  $18,$19,$1A,$CB,$35,$CC,$70,$5A ;xyz{|}~    ATB:1
002159 EE80 415346444847B49E        DB  $41,$53,$46,$44,$48,$47,$B4,$9E ;トランプ〇●をぁ   ATB:1
002161 EE88 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ぃぅぇぉゃゅょっ   ATB:1
002169 EE90 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーあいうえおかき   ATB:1
002171 EE98 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;くけこさしすせそ   ATB:1
002179 EEA0 F0BD9DB1B5B9B49E        DB  $F0,$BD,$9D,$B1,$B5,$B9,$B4,$9E ;　。「」、・ヲァ
002181 EEA8 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ィゥェォャョュッ
002189 EEB0 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーアイウエオカキ
002191 EEB8 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;クケコサシスセソ
002199 EEC0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;タチツテトナニヌ
0021A1 EEC8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ネノハヒフヘホマ
0021A9 EED0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;ミムメモヤユヨラ
0021B1 EED8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;リルレロワン゛゜
0021B9 EEE0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;たちつてとねにぬ   ATB:1
0021C1 EEE8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ねのはひふへほま   ATB:1
0021C9 EEF0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;みむめもやゆよら   ATB:1
0021D1 EEF8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;りるれろわん゛゜   ATB:1
       EF00                     DC_TABLE:
0021D9 EF00 2041424344454647        DB  $20,$41,$42,$43,$44,$45,$46,$47 ;0
0021E1 EF08 48494A4B4C4D4E4F        DB  $48,$49,$4A,$4B,$4C,$4D,$4E,$4F
0021E9 EF10 5051525354555657        DB  $50,$51,$52,$53,$54,$55,$56,$57 ;1
0021F1 EF18 58595A151A1B1411        DB  $58,$59,$5A,$15,$1A,$1B,$14,$11
0021F9 EF20 3031323334353637        DB  $30,$31,$32,$33,$34,$35,$36,$37 ;2
002201 EF28 38392D3D3B2F2E2C        DB  $38,$39,$2D,$3D,$3B,$2F,$2E,$2C
002209 EF30 00000000007C0000        DB  $00,$00,$00,$00,$00,$7C,$00,$00 ;3
002211 EF38 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
002219 EF40 0080000083008285        DB  $00,$80,$00,$00,$83,$00,$82,$85 ;4
002221 EF48 843F00000000003A        DB  $84,$3F,$00,$00,$00,$00,$00,$3A
002229 EF50 5E3C5B815D40003E        DB  $5E,$3C,$5B,$81,$5D,$40,$00,$3E ;5
002231 EF58 00607F0018191312        DB  $00,$60,$7F,$00,$18,$19,$13,$12
002239 EF60 1021222324252627        DB  $10,$21,$22,$23,$24,$25,$26,$27 ;6
002241 EF68 28292B2A001C0000        DB  $28,$29,$2B,$2A,$00,$1C,$00,$00
002249 EF70 7E00000000000000        DB  $7E,$00,$00,$00,$00,$00,$00,$00 ;7
002251 EF78 171600005F000000        DB  $17,$16,$00,$00,$5F,$00,$00,$00
002259 EF80 00C19A9F9C92CA97        DB  $00,$C1,$9A,$9F,$9C,$92,$CA,$97 ;8
002261 EF88 98C6CFC9D8D3D0D7        DB  $98,$C6,$CF,$C9,$D8,$D3,$D0,$D7
002269 EF90 9EC09DC496C5CBC3        DB  $9E,$C0,$9D,$C4,$96,$C5,$CB,$C3 ;9
002271 EF98 9BDDC2DB99A2878C        DB  $9B,$DD,$C2,$DB,$99,$A2,$87,$8C
002279 EFA0 DCC7CC91939495D4        DB  $DC,$C7,$CC,$91,$93,$94,$95,$D4 ;A
002281 EFA8 D5D6CECDDAD2D9C8        DB  $D5,$D6,$CE,$CD,$DA,$D2,$D9,$C8
002289 EFB0 D1A3888D86A4898E        DB  $D1,$A3,$88,$8D,$86,$A4,$89,$8E ;B
002291 EFB8 DFA58A8FDEA18B90        DB  $DF,$A5,$8A,$8F,$DE,$A1,$8B,$90
002299 EFC0 000000000000001F        DB  $00,$00,$00,$00,$00,$00,$00,$1F ;C
0022A1 EFC8 00001D7B7D1E0F0E        DB  $00,$00,$1D,$7B,$7D,$1E,$0F,$0E
0022A9 EFD0 070102030405060D        DB  $07,$01,$02,$03,$04,$05,$06,$0D ;D
0022B1 EFD8 080A0B0C095C0000        DB  $08,$0A,$0B,$0C,$09,$5C,$00,$00
0022B9 EFE0 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00 ;E
0022C1 EFE8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
0022C9 EFF0 A000000000000000        DB  $A0,$00,$00,$00,$00,$00,$00,$00 ;F
0022D1 EFF8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
[EOF:M7TABLE.ASM:SHIFT_JIS]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
       F000                     AT_WORK:
0022D9 F000                         DS  WORKAD-AT_WORK
                                
       F000                     CPM_BOOT:
0022D9 F000 C30000          10      JP  0
       F003                     _SYS00:     ;(BDOS)プログラム終了
       F003                     CPM_WBOOT:
0022DC F003 C3FECF          10      JP  WBOOT1
       F006                     CPM_CONST:
0022DF F006 C3A4D7          10      JP  CONSTX
       F009                     _SYS07:     ;(BDOS)コンソール直接入力
       F009                     CPM_CONIN:
0022E2 F009 C33FD7          10      JP  FLGET
       F00C                     CPM_CONOUT:
0022E5 F00C C349D9          10      JP  CONOUT1
                                
       F00F                     DECBF:              ;10進数表示時のバッファ(5バイト)
0022E8 F00F                         DS  5
       F00F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       F011                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
       F014                     FDRV:
0022ED F014 00                      DB  0
       F015                     FNAME:
0022EE F015                         DS  36
       F039                     SFILE:
002312 F039                         DS  33      ;DRV FILENAME
       F05A                     _DISKE:
002333 F05A C309D7          10      JP  SHOW_ERROR
                                
002336 F05D 0000                LEFTX:  DW  0
002338 F05F 0000                DTAX:   DW  0
                                
       F061                     ZERO:
       F061                     BEEPD:
00233A F061 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
002342 F069 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
       F062                     RTC_YY  EQU BEEPD+1
       F063                     RTC_MW  EQU BEEPD+2
       F064                     RTC_DD  EQU BEEPD+3
       F065                     RTC_TT  EQU BEEPD+4
       F066                     RTC_MM  EQU BEEPD+5
       F067                     RTC_SS  EQU BEEPD+6
       F062                     ROM_SLT EQU BEEPD+1
                                
       F070                     CHECK:
002349 F070 00                      DB  0
                                
       F071                     OK:
00234A F071 4F4B24                  DB  "OK$"
00234D F074                         DS  5
       F079                     COMERM:
002352 F079 4572726F722124          DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
       F080                     _CYL0:
002359 F080 FF                      DB  0FFH    ;Cylinder
       F081                     _CYL1:
00235A F081 FF                      DB  0FFH    ;Cylinder
       F082                     _CYL2:
00235B F082 FF                      DB  0FFH    ;Cylinder
       F083                     _CYL3:
00235C F083 FF                      DB  0FFH    ;Cylinder
       F084                     _DRIVE:
00235D F084 00                      DB  0   ;unit number
       F085                     _SEEKSP:
00235E F085 00                      DB  0   ;Seek speed
       F086                     _ISEEK:
00235F F086 32                      DB  50  ;
002360 F087                         DS  1
       F088                     _DRV:
002361 F088 00                      DB  0
       F089                     _DSK:
002362 F089 FF                      DB  0FFH
       F08A                     _DTA:
002363 F08A 8000                    DW  00080H
       F08C                     _CTC:
002365 F08C 0000                    DW  0
       F08E                     _TXADR:
002367 F08E 0000                    DW  0
       F090                     _KEYPS:
002369 F090 0000                    DW  0
       F092                     _KEYD:
00236B F092 00FF                    DW  0FF00H  ;キーデータ
       F094                     _KEYSP:
00236D F094 8310                    DB  KEYSP_L,KEYSP_H ;オートリピートの速度
       F096                     _COLORF:
00236F F096 70                      DB  COLORF  ;色
       F097                     _LINE:
002370 F097 19                      DB  LINE
                                
       F098                     _FCB:
002371 F098 0000                    DW  0   ;SEARCH FILES
       F09A                     _FBPS:
002373 F09A 0000                    DW  0   ;    //
       F09C                     _FBAD:
002375 F09C 0000                    DW  0   ;    //
       F09E                     _FBCNT:
002377 F09E 00                      DB  0   ;    //
       F09F                     _FILEN:
002378 F09F 00                      DB  0   ;    //
       F0A0                     _DIRF:
002379 F0A0 00                      DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
00237A F0A1                         DS  1
       F0A2                     _WTFATF:
00237B F0A2 00                      DB  0   ;FATバッファの更新フラグ
00237C F0A3                         DS  1
       F0A4                     _WTDBF:
00237D F0A4 00                      DB  0   ;データバッファの更新フラグ
       F0A5                     _DBDRV:
00237E F0A5 FF                      DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
       F0A6                     _DBSEC:
00237F F0A6 0000                    DW  0   ;データバッファにあるデータを読み込んだセクタ番号
       F0A8                     _DPB:
002381 F0A8 0000                    DW  0
       F0AA                     _FATDRV:
002383 F0AA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
       F0AB                     _FATIX:
002384 F0AB 00                      DB  0   ;FATバッファに読み込んでいるインデックス
       F0AC                     _FAKEFREE:
002385 F0AC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
002387 F0AE                         DS  2
                                
       F0B0                     CRTCD:
002389 F0B0 6F                      DB  06FH
       F0B1                     _WIDTH:
00238A F0B1 28                      DB  WIDTH
       F0B2                     TVRAMTOP:
00238B F0B2 5938                    DB  059H,038H
00238D F0B4 1F02                    DB  01FH,002H
       F0B6                     _LINE2:
00238F F0B6 19                      DB  019H
       F0B7                     WKE4:
002390 F0B7 1C                      DB  01CH
       F0B8                     WKE6:
002391 F0B8 00                      DB  000H
       F0B9                     WK40:
002392 F0B9 07                      DB  007H
       F0BA                     _PAGE_MINUS:
002393 F0BA 18FC                    DW  0-WIDTH*LINE
       F0BC                     _WIDTH_MINUS:
002395 F0BC D8FF                    DW  0-WIDTH
       F0BE                     WK30:
002397 F0BE 0C                      DB  00CH
       F0BF                     WK31:
       F0BF                     WK1FD0:
002398 F0BF 20                      DB  020H
                                
002399 F0C0 0000                CTC0:   DW  INTCTCE
00239B F0C2 0000                CTC1:   DW  INTCTCE
00239D F0C4 0000                CTC2:   DW  INTCTCE
00239F F0C6 0000                CTC3:   DW  INTCTCE
0023A1 F0C8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
0023A3 F0CA C390DA          10  _INKEY: JP  INKEY
0023A6 F0CD C335D8          10  _PRINT: JP  PRINT
0023A9 F0D0 C304DB          10  _SCRN:  JP  SCRN
0023AC F0D3 C3F2D9          10  _POS:   JP  POS
0023AF F0D6 C317D9          10  _LOC:   JP  LOC
       F0D9                     _CHGDRV:
0023B2 F0D9 C3A2E7          10      JP  CHGDRV
       F0DC                     _GETDPB:
0023B5 F0DC C360E8          10      JP  GETDPB
       F0DF                     _FFLUSH:
0023B8 F0DF C37EE8          10      JP  FFLUSH
       F0E2                     _RDFATX:
0023BB F0E2 C37AE4          10      JP  RDFATX
0023BE F0E5 C3ACE5          10  _RDFAT: JP  RDFAT
0023C1 F0E8 C339E9          10  _WTTRK: JP  WTTRK
0023C4 F0EB C396E9          10  _FDRD:  JP  FDRD
0023C7 F0EE C33FE9          10  _FDWT:  JP  FDWT
       F0F1                     _BPB2DPB:
0023CA F0F1 C344E6          10      JP  BPB2DPB
       F0F4                     _BREAK:
0023CD F0F4 C38DD1          10      JP  END_BATCH
       F0F7                     _GNCL:
0023D0 F0F7 C326E5          10      JP  GNCL        ; self-modifying code
       F0F8                     GNCPAT  EQU $-2
       F0FA                     _SNCL:
0023D3 F0FA C349E5          10      JP  SNCL        ; self-modifying code
       F0FB                     SNCPAT  EQU $-2
       F0FD                     _COMANL:
0023D6 F0FD C346D0          10      JP  COMANL
                                
       F100                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       F100                     STABLE:
                                ;0
0023D9 F100 03F016D722D7E4DC        DW  _SYS00,_SYS01,_SYS02,_SYS03
0023E1 F108 74D474D427D709F0        DW  _SYS04,_SYS05,_SYS06,_SYS07
0023E9 F110 2FD776D475D7A1D7        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
0023F1 F118 8BD490D49FD4B0D4        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
0023F9 F120 04D54BD594D5C5D5        DW  _SYS10,_SYS11,_SYS12,_SYS13
002401 F128 CDD5E3D5F8D5F0D5        DW  _SYS14,_SYS15,_SYS16,_SYS17
002409 F130 3FD644D649D64FD6        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
002411 F138 74D475D674D479D6        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
002419 F140 74D42FD637D680D6        DW  _SYS20,_SYS21,_SYS22,_SYS23
002421 F148 A5D674D43AE108E2        DW  _SYS24,_ERROR,_SYS26,_SYS27
002429 F150 37D6AFD6B2D7E4DC        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
002431 F158 B8D7E4DC74D4D0D6        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
002439 F160 CAD674D474D474D4        DW  _SYS30,_ERROR,_ERROR,_ERROR
002441 F168 74D474D474D474D4        DW  _ERROR,_ERROR,_ERROR,_ERROR
002449 F170 74D4E4DCE4DCF1D6        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
002451 F178 57D4                    DW  _DOS2
                                
002453 F17A                         DS  1
       F17B                     _MAX_SEC_SZ_H:
002454 F17B 04                      DB  MAX_SEC_SZ_H
       F17C                     _FATBF:
002455 F17C 30F3                    DW  FATBF
       F17E                     _DTBUF:
002457 F17E 30FB                    DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       F180                     CTRLTB:
002459 F180 9AD89AD8D0D8C5D9        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
002461 F188 BFD9FCD8B0D959D9        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
002469 F190 A6D8C1D8C8D92AD9        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
002471 F198 ADD912D9DAD99AD8        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
002479 F1A0 9AD89AD822D99AD8        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
002481 F1A8 9AD89AD89AD89AD8        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
002489 F1B0 9AD89AD8ADD931D9        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
002491 F1B8 89D8ADD8B6D8C8D9        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
002499 F1C0 0200                M2D:    DW  2
00249B F1C2 FD02                    DB  0FDH,2
00249D F1C4 6401                    DW  356
00249F F1C6 FF0728090182            DB  0FFH,7,40,9,1,082H
0024A5 F1CC 0500A7000800            DW  5,0A7H,8
                                
0024AB F1D2 0200                M2HD:   DW  2
0024AD F1D4 FE01                    DB  0FEH,1
0024AF F1D6 C704                    DW  1223
0024B1 F1D8 FE064D080184            DB  0FEH,6,77,8,1,084H
0024B7 F1DE 0500A7000900            DW  5,0A7H,9
                                
0024BD F1E4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
0024BF F1E6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
0024C1 F1E8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
0024C3 F1EA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       F1EE                     SDDATAE:
                                
0024C7 F1EE                         DS  2
       F1F0                     _FCB_BAT:
0024C9 F1F0 1AEB                    DW  FCB_BAT
       F1F2                     _PATH:
0024CB F1F2 B9EA                    DW  PATHD
                                
0024CD F1F4                     SCDIR:  DS  2       ;+14 +15
0024CF F1F6                     SFBPS:  DS  2       ;FBPS
0024D1 F1F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
0024D3 F1FA 0000                _FATPS: DW  0
0024D5 F1FC 0000                _DIRPS: DW  0
0024D7 F1FE 0000                _CLPS:  DW  0
                                
       F200                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "M7DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   MZ-700/1500
                                
       F200                     _DEVICE:
                                
                                ;   A:
                                
0024D9 F200 0200                    DW  2   ;DPB_FATLN
0024DB F202 EBF0                    DW  _FDRD   ;DPB_DRD
0024DD F204 EEF0                    DW  _FDWT   ;DPB_DWT
0024DF F206 FD                      DB  0FDH    ;DPB_FATID
0024E0 F207 02                      DB  2   ;DPB_SECPCL
0024E1 F208 6401                    DW  356 ;DPB_MAXCL
0024E3 F20A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
0024E4 F20B 07                      DB  7   ;DPB_DIRSCNT
0024E5 F20C 28                      DB  40  ;DPB_MAXCYL
0024E6 F20D 09                      DB  9   ;DPB_MAXSEC Number of sectors
0024E7 F20E 01                      DB  1   ;DPB_FATPS
0024E8 F20F 82                      DB  082H    ;DPB_BPS
0024E9 F210 0500                    DW  5   ;DPB_DIRPS
0024EB F212 27                      DB  027H    ;DPB_DEVICE Device Number
0024EC F213 00                      DB  0   ;DPB_UNITNO
0024ED F214 0800                    DW  8   ;DPB_ADDCL
0024EF F216 0000                    DW  0   ;DPB_16
0024F1 F218 0000                    DW  0   ;DPB_18
0024F3 F21A 0000                    DW  0   ;DPB_SDIR
0024F5 F21C 46444430                DB  "FDD0"  ;DPB_NAME
                                
                                ;   B:
                                
0024F9 F220 0200                    DW  2   ;DPB_FATLN
0024FB F222 EBF0                    DW  _FDRD   ;DPB_DRD
0024FD F224 EEF0                    DW  _FDWT   ;DPB_DWT
0024FF F226 FD                      DB  0FDH    ;DPB_FATID
002500 F227 02                      DB  2   ;DPB_SECPCL
002501 F228 6401                    DW  356 ;DPB_MAXCL
002503 F22A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002504 F22B 07                      DB  7   ;DPB_DIRSCNT
002505 F22C 28                      DB  40  ;DPB_MAXCYL
002506 F22D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002507 F22E 01                      DB  1   ;DPB_FATPS
002508 F22F 82                      DB  082H    ;DPB_BPS
002509 F230 0500                    DW  5   ;DPB_DIRPS
00250B F232 27                      DB  027H    ;DPB_DEVICE Device Number
00250C F233 01                      DB  1   ;DPB_UNITNO
00250D F234 0800                    DW  8   ;DPB_ADDCL
00250F F236 0000                    DW  0   ;DPB_16
002511 F238 0000                    DW  0   ;DPB_18
002513 F23A 0000                    DW  0   ;DPB_SDIR
002515 F23C 46444431                DB  "FDD1"  ;DPB_NAME
                                
                                ;   C:
                                
002519 F240 0100                    DW  1   ;DPB_FATLN
00251B F242 53EA                    DW  CDRD    ;DPB_DRD
00251D F244 40EA                    DW  CDWT    ;DPB_DWT
00251F F246 FA                      DB  0FAH    ;DPB_FATID
002520 F247 01                      DB  1   ;DPB_SECPCL
002521 F248 7A00                    DW  122 ;DPB_MAXCL
002523 F24A 00                      DB  0   ;DPB_FDMODE
002524 F24B 06                      DB  6   ;DPB_DIRSCNT
002525 F24C 00                      DB  0   ;DPB_MAXCYL
002526 F24D 00                      DB  0   ;DPB_MAXSEC
002527 F24E 01                      DB  1   ;DPB_FATPS
002528 F24F 01                      DB  1   ;DPB_BPS
002529 F250 0200                    DW  2   ;DPB_DIRPS
00252B F252 0C                      DB  00CH    ;DPB_DEVICE
00252C F253 F8                      DB  0F8H    ;DPB_UNITNO
00252D F254 0600                    DW  6   ;DPB_ADDCL
00252F F256 0000                    DW  0   ;DPB_16
002531 F258 0000                    DW  0   ;DPB_18
002533 F25A 0000                    DW  0   ;DPB_SDIR
002535 F25C 434D4F53                DB  "CMOS"  ;DPB_NAME
                                
                                ;   D:
                                
002539 F260                         DS  32
                                
                                ;   E:
                                
       F280                     EMMFL:
002559 F280 0000                    DW  0   ;DPB_FATLN
00255B F282 0AEA                    DW  EDRD    ;DPB_DRD
00255D F284 FDE9                    DW  EDWT    ;DPB_DWT
00255F F286 FA                      DB  0FAH    ;DPB_FATID
002560 F287 02                      DB  2   ;DPB_SECPCL
002561 F288 0000                    DW  0   ;DPB_MAXCL
002563 F28A 00                      DB  0   ;DPB_FDMODE
002564 F28B 10                      DB  16  ;DPB_DIRSCNT
002565 F28C 00                      DB  0   ;DPB_MAXCYL
002566 F28D 00                      DB  0   ;DPB_MAXSEC
002567 F28E 01                      DB  1   ;DPB_FATPS
002568 F28F 01                      DB  1   ;DPB_BPS
002569 F290 0000                    DW  0   ;DPB_DIRPS
00256B F292 26                      DB  026H    ;DPB_DEVICE
00256C F293 00                      DB  0   ;DPB_UNITNO
00256D F294 0000                    DW  0   ;DPB_ADDCL
00256F F296 0000                    DW  0   ;DPB_16
002571 F298 0000                    DW  0   ;DPB_18
002573 F29A 0000                    DW  0   ;DPB_SDIR
002575 F29C 454D4D30                DB  "EMM0"  ;DPB_NAME
                                
                                ;   F:
                                
002579 F2A0 0200                    DW  2   ;DPB_FATLN
00257B F2A2 6AEA                    DW  RDRD    ;DPB_DRD
00257D F2A4 66EA                    DW  RDWT    ;DPB_DWT
00257F F2A6 FA                      DB  0FAH    ;DPB_FATID
002580 F2A7 01                      DB  1   ;DPB_SECPCL
002581 F2A8 F600                    DW  246 ;DPB_MAXCL
002583 F2AA 00                      DB  0   ;DPB_FDMODE
002584 F2AB 09                      DB  9   ;DPB_DIRSCNT
002585 F2AC 00                      DB  0   ;DPB_MAXCYL
002586 F2AD 00                      DB  0   ;DPB_MAXSEC
002587 F2AE 01                      DB  1   ;DPB_FATPS
002588 F2AF 01                      DB  1   ;DPB_BPS
002589 F2B0 0300                    DW  3   ;DPB_DIRPS
00258B F2B2 0F                      DB  00FH    ;DPB_DEVICE
00258C F2B3 00                      DB  0   ;DPB_UNITNO
00258D F2B4 0A00                    DW  10  ;DPB_ADDCL
00258F F2B6 0000                    DW  0   ;DPB_16
002591 F2B8 0000                    DW  0   ;DPB_18
002593 F2BA 0000                    DW  0   ;DPB_SDIR
002595 F2BC 52414D46                DB  "RAMF"  ;DPB_NAME
                                
                                ;   G:
       F2C0                     GRAMFL:
002599 F2C0 0100                    DW  1   ;DPB_FATLN
00259B F2C2 95EA                    DW  GDRD    ;DPB_DRD
00259D F2C4 80EA                    DW  GDWT    ;DPB_DWT
00259F F2C6 FA                      DB  0FAH    ;DPB_FATID
0025A0 F2C7 01                      DB  1   ;DPB_SECPCL
0025A1 F2C8 5A00                    DW  90  ;DPB_MAXCL
0025A3 F2CA 00                      DB  0   ;DPB_FDMODE
0025A4 F2CB 06                      DB  6   ;DPB_DIRSCNT
0025A5 F2CC 00                      DB  0   ;DPB_MAXCYL
0025A6 F2CD 00                      DB  0   ;DPB_MAXSEC
0025A7 F2CE 01                      DB  1   ;DPB_FATPS
0025A8 F2CF 01                      DB  1   ;DPB_BPS
0025A9 F2D0 0200                    DW  2   ;DPB_DIRPS
0025AB F2D2 05                      DB  005H    ;DPB_DEVICE
0025AC F2D3 F8                      DB  0F8H    ;DPB_UNITNO
0025AD F2D4 0600                    DW  6   ;DPB_ADDCL
0025AF F2D6 0000                    DW  0   ;DPB_16
0025B1 F2D8 0000                    DW  0   ;DPB_18
0025B3 F2DA 0000                    DW  0   ;DPB_SDIR
0025B5 F2DC 4752414D                DB  "GRAM"  ;DPB_NAME
                                
                                ;   H:
0025B9 F2E0                         DS  3
0025BC F2E3 00                      DB  0
[EOF:M7DPB.ASM:UTF_8]
                                
0025BD A5BD                         ORG $$+OFFSET,$$    ;$DEPHASE
       A5BD                     LAST_ADR:
                                
                                    END
[EOF:M7.ASM:UTF_8]
