                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   LSX-Dodgers for MZ-700/1500
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "M7DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MZ-700/1500
                                
       0001                     MAC EQU 1   ;MZ-700/1500
       0000                     DEV EQU 0
                                
       011D                     VER_6F  EQU 0011DH
                                
       8080                     RUN EQU 08080H
       8000                     OFFSET  EQU RUN-128
       CF06                     BDOS    EQU 0CF06H
       F000                     WORKAD  EQU 0F000H
       ED40                     TABLEAD EQU 0ED40H
       F300                     KEYBF   EQU 0F300H
       F330                     FATBF   EQU 0F330H
       FB30                     DTBUF   EQU 0FB30H
       FF30                     KBUF    EQU 0FF30H
       FFD9                     TRAP38  EQU 0FFD9H
       0028                     WIDTH   EQU 40
       0019                     LINE    EQU 25
       0070                     COLORF  EQU 070H
       0014                     KEYSP_H EQU 20
       0083                     KEYSP_L EQU 131
       0009                     COMS    EQU 9
       0004                     MAX_SEC_SZ_H    EQU 4       ;1セクタ1024バイトのサポート(2:off 4:on)
       0100                     BUFFER  EQU 00100H
       D0E7                     S27BUF_COM  EQU S27BUF
[EOF:M7DEF.ASM:SHIFT_JIS]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0006                     VER_2   EQU 6
       0002                     VER_3   EQU 2
       1D01                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0001                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0162                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0004                     _DVSW   EQU 00004H
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       F323                     DISKVE  EQU 0F323H
       F325                     BREAKV  EQU 0F325H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 8000                         ORG OFFSET
                                                    ;MZTヘッダ128バイト
000000 8000 01                      DB  1           ;ファイルモード
000001 8001 4C44202020202020        DB  "LD           "     ;ファイル名(13)
            2020202020          
00000E 800E 535953                  DB  "SYS"           ;拡張子(3)
000011 8011 0D                      DB  $0D
000012 8012 4525                    DW  LAST_ADR-RUN        ;サイズ
000014 8014 8080                    DW  RUN         ;開始アドレス
000016 8016 8080                    DW  RUN         ;実行アドレス
000018 8018                         DS  104
                                
                                    INCLUDE "M7INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   MZ-700/1500
                                
000080 8080 C38780          10      JP  START
000083 8083 011D                    DW  MACW
000085 8085 6201                    DW  VER
                                
       8087                     START:
000087 8087 F3               4      DI
000088 8088 ED56             8      IM  1
00008A 808A 318780          10      LD  SP,START
00008D 808D CD9B80          17      CALL    INIT        ;NZならAUTOEXECを実行
000090 8090 210000          10      LD  HL,0
000093 8093 E5              11      PUSH    HL
000094 8094 C8              11      RET Z
000095 8095 118081          10      LD  DE,AUTOD
000098 8098 C3FDF0          10      JP  _COMANL
                                
       809B                     INIT:
00009B 809B D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFFH)
00009D 809D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00009F 809F 21E781          10      LD  HL,INITE
0000A2 80A2 1106CF          10      LD  DE,BDOS
0000A5 80A5 01DE23          10      LD  BC,LAST_ADR-INITE
0000A8 80A8 EDB0                    LDIR
0000AA 80AA 21B681          10      LD  HL,M7BEEPD
0000AD 80AD 1162F0          10      LD  DE,BEEPD+1
0000B0 80B0 010A00          10      LD  BC,M7BEEPE-M7BEEPD
0000B3 80B3 EDB0                    LDIR
                                
0000B5 80B5 210000          10      LD  HL,0
0000B8 80B8 065C             7      LD  B,05CH
0000BA 80BA 3E                      DB  03EH    ;LD A,??
0000BB 80BB EF              12      RST 28H
0000BC 80BC CD40DC          17      CALL    FILL_MEMORY
0000BF 80BF 06A4             7      LD  B,0A4H
0000C1 80C1 AF               4      XOR A
0000C2 80C2 320400          13      LD  (_DVSW),A
0000C5 80C5 CD40DC          17      CALL    FILL_MEMORY
                                
0000C8 80C8 3EC3             7      LD  A,0C3H      ;JP
0000CA 80CA 2103F0          10      LD  HL,CPM_WBOOT
0000CD 80CD 320000          13      LD  (00000H),A
0000D0 80D0 220100          16      LD  (00001H),HL ;IPL
                                
0000D3 80D3 2106CF          10      LD  HL,BDOS
0000D6 80D6 320500          13      LD  (00005H),A
0000D9 80D9 220600          16      LD  (00006H),HL ;BDOS
                                
0000DC 80DC 21D9FF          10      LD  HL,TRAP38   ;TRAP38
0000DF 80DF 322800          13      LD  (00028H),A
0000E2 80E2 222900          16      LD  (00029H),HL ;RST 028H
                                
0000E5 80E5 323800          13      LD  (00038H),A
0000E8 80E8 21C9CF          10      LD  HL,IO_INT8253
0000EB 80EB 223900          16      LD  (00039H),HL
                                
0000EE 80EE 215BF0          10      LD  HL,_DISKE+1
0000F1 80F1 2223F3          16      LD  (DISKVE),HL
0000F4 80F4 21F5F0          10      LD  HL,_BREAK+1
0000F7 80F7 2225F3          16      LD  (BREAKV),HL
                                
0000FA 80FA 3EF0             7      LD  A,CPM_BOOT/256
0000FC 80FC 320B00          13      LD  (0000BH),A
                                
0000FF 80FF 3EE9             7      LD  A,0E9H      ;JP (HL)
000101 8101 320F00          13      LD  (0000FH),A
                                                ;CHECK PCG(MZ-1500)
000104 8104 2100E8          10      LD  HL,0E800H
000107 8107 46               7      LD  B,(HL)
000108 8108 F3               4      DI
000109 8109 3E01             7      LD  A,1
00010B 810B D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00010D 810D 4E               7      LD  C,(HL)
00010E 810E 79               4      LD  A,C
00010F 810F C6A5             7      ADD A,0A5H
000111 8111 5F               4      LD  E,A
000112 8112 73               7      LD  (HL),E
000113 8113 D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
000115 8115 71               7      LD  (HL),C
000116 8116 3E01             7      LD  A,1
000118 8118 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00011A 811A 7E               7      LD  A,(HL)
00011B 811B BB               4      CP  E
00011C 811C D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
00011E 811E 70               7      LD  (HL),B
00011F 811F FB               4      EI
000120 8120 2804            12      JR  Z,MZ1500
000122 8122 AF               4      XOR A       ;MZ-700はPCGバンクが存在しない
000123 8123 32C0F2          13      LD  (GRAMFL),A
       8126                     MZ1500:
000126 8126 DD2180F2        14      LD  IX,EMMFL
00012A 812A CD7581          17      CALL    CHECK_EMM_BPB
00012D 812D FEEB             7      CP  0EBH
00012F 812F 2817            12      JR  Z,EMM_BPB
000131 8131 DD360D02        19      LD  (IX+DPB_MAXSEC),2   ;BPBが512バイト目から始まる場合を調べる
000135 8135 CD7581          17      CALL    CHECK_EMM_BPB
000138 8138 DDBE06          19      CP  (IX+DPB_FATID)
00013B 813B 200B            12      JR  NZ,EMM_BPB
00013D 813D DD360D00        19      LD  (IX+DPB_MAXSEC),0   ;BPBが先頭の場合に戻す
                                
000141 8141 2103E0          10      LD  HL,0E003H       ;SOUND MASK (MZ-1500)
000144 8144 AF               4      XOR A
000145 8145 CD4BCF          17      CALL    WRMMIO
       8148                     EMM_BPB:
000148 8148 218C81          10      LD  HL,INIMES
00014B 814B CD8BD4          17      CALL    MSX
       814E                     INIT1:
00014E 814E F3               4      DI
00014F 814F 1100FF          10      LD  DE,0FF00H
000152 8152 0600             7      LD  B,0
000154 8154 CD29D3          17      CALL    ZERO_MEMORY_DE
000157 8157 21CAFF          10      LD  HL,EXTBIO
00015A 815A 36C9            10      LD  (HL),0C9H   ;RET
00015C 815C 23               6      INC HL
00015D 815D 060E             7      LD  B,TRAP38-EXTBIO-1
00015F 815F 3E                      DB  03EH    ;LD A,??
000160 8160 EF              12      RST 28H
000161 8161 CD40DC          17      CALL    FILL_MEMORY
000164 8164 21C081          10      LD  HL,AT_TRAP38
000167 8167 11D9FF          10      LD  DE,TRAP38
00016A 816A 012700          10      LD  BC,AT_TRAPE-AT_TRAP38
00016D 816D EDB0                    LDIR
                                
00016F 816F CDF3DA          17      CALL    CHKEY
000172 8172 FE03             7      CP  3
000174 8174 C9              10      RET
                                
       8175                     CHECK_EMM_BPB:
000175 8175 D5              11      PUSH    DE
000176 8176 110000          10      LD  DE,0
000179 8179 CD6CEA          17      CALL    EADR
00017C 817C D1              10      POP DE
00017D 817D ED78            12      IN  A,(C)
00017F 817F C9              10      RET
                                
000180 8180 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
000189 8189 413A00              AUTODV: DB  "A:",0
                                
00018C 818C 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for MZ-700/1500 v"
            6765727320666F72    
            204D5A2D3730302F    
            313530302076        
0001AA 81AA 312E                    DB  030H + VER_1, '.'
0001AC 81AC 3632                    DB  030H + VER_2 ,030H + VER_3
0001AE 81AE                         DB  ''
0001AE 81AE 2047616B750D0A          DB  " Gaku",0DH,0AH
0001B5 81B5 00                      DB  0
                                
       81B6                     M7BEEPD:
0001B6 81B6 0801                    DB  8,1
0001B8 81B8 0736                    DB  7,036H
0001BA 81BA 04F9                    DB  4,0F9H
0001BC 81BC 0403                    DB  4,3
0001BE 81BE 0301                    DB  3,1         ;SOUND MASK(MZ-1500)
       81C0                     M7BEEPE:
                                
       81C0                     AT_TRAP38:
0001C0 FFD9                         ORG TRAP38,AT_TRAP38-OFFSET
0001C0 FFD9 210000          10      LD  HL,0
0001C3 FFDC E3              19      EX  (SP),HL
0001C4 FFDD 3E24             7      LD  A,'$'
0001C6 FFDF CD1FD7          17      CALL    MSG_A
0001C9 FFE2 2B               6      DEC HL
0001CA FFE3 7C               4      LD  A,H
0001CB FFE4 CDE8FF          17      CALL    PRHX
0001CE FFE7 7D               4      LD  A,L
       FFE8                     PRHX:
0001CF FFE8 F5              11      PUSH    AF
0001D0 FFE9 07               4      RLCA
0001D1 FFEA 07               4      RLCA
0001D2 FFEB 07               4      RLCA
0001D3 FFEC 07               4      RLCA
0001D4 FFED CDF1FF          17      CALL    PRHX2
0001D7 FFF0 F1              10      POP AF
       FFF1                     PRHX2:
0001D8 FFF1 E60F             7      AND 00FH
0001DA FFF3 FE0A             7      CP  10
0001DC FFF5 3F               4      CCF
0001DD FFF6 CE30             7      ADC A,'0'
0001DF FFF8 27               4      DAA
0001E0 FFF9 C31FD7          10      JP  MSG_A
0001E3 FFFC                         DS  4
0001E7 81E7                         ORG $$+OFFSET,$$    ;$DEPHASE
       81E7                     AT_TRAPE:
                                
       81E7                     INITE:
0001E7 CF06                         ORG BDOS,INITE-OFFSET
                                
0001E7 CF06 C309CF          10      JP  IO_BDOS
[EOF:M7INIT.ASM:SHIFT_JIS]
                                    INCLUDE "M7BANK.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                ;   VRAM/KEY/TIMER(0D000H-0EFFFH)にアクセスするので0D000H-0FFFFHに置けない部分
                                ;
                                
       CF09                     IO_BDOS:
0001EA CF09 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001EC CF0B C34BD4          10      JP  BDOS0
                                
       CF0E                     IO_CLR:
0001EF CF0E D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF10                     C1AX1:
0001F1 CF10 7A               4      LD  A,D
0001F2 CF11 C6D0             7      ADD A,0D0H
0001F4 CF13 57               4      LD  D,A
0001F5 CF14 AF               4      XOR A
0001F6 CF15 12               7      LD  (DE),A      ;Text
0001F7 CF16 CBDA             8      SET 3,D
0001F9 CF18 3E00             7      LD  A,0     ;自己書き換え
                                                ;BDOS0+13Hが外部から書き換えされても動くようにする
       CF19                     ICSMC   EQU $-1
0001FB CF1A 12               7      LD  (DE),A      ;Color
0001FC CF1B 13               6      INC DE
0001FD CF1C 7A               4      LD  A,D
0001FE CF1D D6D8             7      SUB 0D8H
000200 CF1F 57               4      LD  D,A
000201 CF20 2118FC          10      LD  HL,0-WIDTH*LINE
       CF21                     _NEG_PAGE_SWC   EQU $-2
000204 CF23 19              11      ADD HL,DE
000205 CF24 30EA            12      JR  NC,C1AX1
000207 CF26 E1              10      POP HL
000208 CF27 D1              10      POP DE
000209 CF28 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00020B CF2A FB               4      EI
00020C CF2B C9              10      RET
                                
       CF2C                     RDKEYDATA:
00020D CF2C F3               4      DI
00020E CF2D D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000210 CF2F 3200E0          13      LD  (0E000H),A
000213 CF32 3A01E0          13      LD  A,(E001H)
000216 CF35 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000218 CF37 FB               4      EI
000219 CF38 C9              10      RET
                                
       CF39                     RD556VSYNC:
00021A CF39 F3               4      DI
00021B CF3A D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00021D CF3C 3A02E0          13      LD  A,(0E002H)
000220 CF3F D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000222 CF41 FB               4      EI
000223 CF42 C9              10      RET
                                
       CF43                     RDMMIO:
000224 CF43 F3               4      DI
000225 CF44 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000227 CF46 7E               7      LD  A,(HL)
000228 CF47 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00022A CF49 FB               4      EI
00022B CF4A C9              10      RET
                                
       CF4B                     WRMMIO:
00022C CF4B F3               4      DI
00022D CF4C D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00022F CF4E 77               7      LD  (HL),A
000230 CF4F D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000232 CF51 FB               4      EI
000233 CF52 C9              10      RET
                                
       CF53                     RDMMIO_BC:
000234 CF53 F3               4      DI
000235 CF54 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000237 CF56 0A               7      LD  A,(BC)
000238 CF57 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00023A CF59 FB               4      EI
00023B CF5A C9              10      RET
                                
       CF5B                     WRMMIO_BC:
00023C CF5B F3               4      DI
00023D CF5C D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00023F CF5E 02               7      LD  (BC),A
000240 CF5F D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000242 CF61 FB               4      EI
000243 CF62 C9              10      RET
                                
       CF63                     IO_PRINT:
000244 CF63 F3               4      DI
000245 CF64 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000247 CF66 77               7      LD  (HL),A
000248 CF67 CBDC             8      SET 3,H
00024A CF69 71               7      LD  (HL),C
00024B CF6A D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00024D CF6C FB               4      EI
00024E CF6D C9              10      RET
                                
       CF6E                     IO_CLLINE:
00024F CF6E F3               4      DI
000250 CF6F D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF71                     CLLINE1:
000252 CF71 CB9C             8      RES 3,H
000254 CF73 77               7      LD  (HL),A      ;Text
000255 CF74 CBDC             8      SET 3,H
000257 CF76 71               7      LD  (HL),C      ;Color
000258 CF77 23               6      INC HL
000259 CF78 10F7            13      DJNZ    CLLINE1
00025B CF7A D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00025D CF7C FB               4      EI
00025E CF7D C9              10      RET
                                
       CF7E                     IO_INSBS:
00025F CF7E F3               4      DI
000260 CF7F D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF81                     IO_INSBS1:
000262 CF81 CB9C             8      RES 3,H
000264 CF83 5E               7      LD  E,(HL)
000265 CF84 77               7      LD  (HL),A
000266 CF85 7B               4      LD  A,E
000267 CF86 CBDC             8      SET 3,H
000269 CF88 5E               7      LD  E,(HL)
00026A CF89 71               7      LD  (HL),C
00026B CF8A 4B               4      LD  C,E
       CF8B                     IO_INCDEC   EQU $   ; 自己書き換え
00026C CF8B 23               6      INC HL      ;INS->INC HL or BS->DEC HL
00026D CF8C 10F3            13      DJNZ    IO_INSBS1
00026F CF8E D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000271 CF90 FB               4      EI
000272 CF91 C9              10      RET
                                
       CF92                     IO_SCRUP:
000273 CF92 F3               4      DI
000274 CF93 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF95                     SCRUP1:
000276 CF95 2815            12      JR  Z,SCRCL
000278 CF97 D5              11      PUSH    DE
000279 CF98 E5              11      PUSH    HL
00027A CF99 CBDA             8      SET 3,D
00027C CF9B CBDC             8      SET 3,H
00027E CF9D 012800          10      LD  BC,WIDTH
000281 CFA0 EDB0                    LDIR
000283 CFA2 E1              10      POP HL
000284 CFA3 D1              10      POP DE
000285 CFA4 012800          10      LD  BC,WIDTH
000288 CFA7 EDB0                    LDIR
00028A CFA9 3D               4      DEC A
00028B CFAA 18E9            12      JR  SCRUP1
                                
       CFAC                     SCRCL:
00028D CFAC 0628             7      LD  B,WIDTH
00028F CFAE EB               4      EX  DE,HL
000290 CFAF D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000292 CFB1 CD11D9          17      CALL    CLLINE
000295 CFB4 E1              10      POP HL
000296 CFB5 D1              10      POP DE
000297 CFB6 C1              10      POP BC
000298 CFB7 C9              10      RET
                                
       CFB8                     RD_PCG:
000299 CFB8 F3               4      DI
00029A CFB9 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00029C CFBB 4E               7      LD  C,(HL)
       CFBC                     RW_PCG:
00029D CFBC D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
00029F CFBE FB               4      EI
0002A0 CFBF C9              10      RET
                                
       CFC0                     WR_PCG:
0002A1 CFC0 F3               4      DI
0002A2 CFC1 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
0002A4 CFC3 71               7      LD  (HL),C
0002A5 CFC4 18F6            12      JR  RW_PCG
                                
       CFC6                     IO_MON:
0002A7 CFC6 D3E4            11      OUT (0E4H),A    ;MONITOR ROM(0000H-0FFFH) & VRAM/KEY/TIMER(D000H-FFFFH)
0002A9 CFC8 C7              12      RST 0
                                
                                #IF EXISTS USE_8253
                                INITINT:
                                    OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
                                    LD  HL,0E007H   ;HL=0E007H 8253 コントロール
                                    LD  (HL),0B0H   ;Ch.2 カウンタの下位バイト→上位バイトの順に連続してアクセス Mode 0 16ビットバイナリ
                                    LD  (HL),074H   ;Ch.1 カウンタの下位バイト→上位バイトの順に連続してアクセス Mode 2 16ビットバイナリ
                                    DEC L       ;0E006H 8253 Ch.2 カウンタ
                                    LD  (HL),2
                                    LD  (HL),0
                                    DEC L       ;0E005H 8253 Ch.1 カウンタ
                                    LD  (HL),A
                                    LD  (HL),0
                                    LD  A,L     ;L=5
                                    LD  (0E003H),A  ;8255 コントロールポートでポートC(0E002H)のINTMSKを1にする
                                    OUT (0E1H),A    ;DRAM(D000H-FFFFH)
                                    RET
                                #ENDIF
                                
       CFC9                     IO_INT8253:
                                #IF EXISTS USE_8253
                                    PUSH    AF
                                    LD  A,(EXTBIO)
                                    LD  (INTMEM_SWC),A
                                    OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
                                    LD  A,1
                                    LD  (0E006H),A  ;8253 Ch.2 カウンタ
                                    XOR A
                                    LD  (0E006H),A  ;8253 Ch.2 カウンタ
                                    OUT (0E1H),A    ;DRAM(D000H-FFFFH)
                                    JP  INT8253
                                ROM8253E:
                                    OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
                                    POP AF
                                #ENDIF
0002AA CFC9 C9              10      RET
                                
       CFCA                     BANKE:
0002AB CFCA                         DS  0CFFEH-BANKE
[EOF:M7BANK.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   MZ-700/1500
                                
       CFFE                     WBOOT1:
0002DF CFFE D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)　ここは0CFFEH
0002E1 D000 D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFHH)
0002E3 D002 F3               4      DI
0002E4 D003 3A94F0          13      LD  A,(_KEYSP_L)
                                #IF EXISTS USE_8253
                                    CALL    INITINT
                                #ENDIF
0002E7 D006 ED7B0600        20      LD  SP,(SYSTEM+1)
0002EB D00A FB               4      EI
0002EC D00B 2ABAF0          16      LD  HL,(_PAGE_MINUS)
0002EF D00E 2221CF          16      LD  (_NEG_PAGE_SWC),HL
0002F2 D011 2192F0          10      LD  HL,_KEYD
0002F5 D014 3600            10      LD  (HL),0
0002F7 D016 CDF3DA          17      CALL    CHKEY
0002FA D019 CD1BD7          17      CALL    KEYBC_IFBREAK
0002FD D01C 3E04             7      LD  A,4
0002FF D01E CD1FD7          17      CALL    MSG_A
[EOF:M7CCP.ASM:UTF_8]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D021                     COMMAND:
000302 D021 3A6AEB          13      LD  A,(FCB_BAT)
000305 D024 B7               4      OR  A
000306 D025 C263D1          10      JP  NZ,C_BAT1
000309 D028 CDD7D0          17      CALL    SETDTA1
00030C D02B 3A0400          13      LD  A,(_DVSW)
00030F D02E C641             7      ADD A,'A'
000311 D030 CD1FD7          17      CALL    MSG_A
000314 D033 3E3E             7      LD  A,'>'
000316 D035 CD1FD7          17      CALL    MSG_A
000319 D038 3E50             7      LD  A,80
00031B D03A 12               7      LD  (DE),A
00031C D03B CD7BD7          17      CALL    _SYS0A      ;(BDOS)文字列入力
00031F D03E CD58D2          17      CALL    LTNL
       D041                     COMMAND2:
000322 D041 118200          10      LD  DE,DTA1+2
000325 D044 CDFDF0          17      CALL    _COMANL
000328 D047 DC0FD7          17      CALL    C,SHOW_ERROR
00032B D04A 18D5            12      JR  COMMAND
                                
       D04C                     COMANL:
00032D D04C CD95DB          17      CALL    FILE
000330 D04F 3A19F0          13      LD  A,(FNAME+4)
000333 D052 FE20             7      CP  020H
000335 D054 201C            12      JR  NZ,COMB2
000337 D056 D5              11      PUSH    DE
000338 D057 1115F0          10      LD  DE,FNAME
00033B D05A 1A               7      LD  A,(DE)
00033C D05B FE20             7      CP  020H
00033E D05D 2844            12      JR  Z,SDVSW
000340 D05F 1B               6      DEC DE
000341 D060 1A               7      LD  A,(DE)
000342 D061 C6FF             7      ADD A,0FFH
000344 D063 3809            12      JR  C,COMB
000346 D065 13               6      INC DE
                                
000347 D066 2115D4          10      LD  HL,COMTB
00034A D069 0609             7      LD  B,COMS
00034C D06B CD22DE          17      CALL    CPNAME
       D06E                     COMB:
00034F D06E D1              10      POP DE
000350 D06F D20ED7          10      JP  NC,JPHL
       D072                     COMB2:
000353 D072 EB               4      EX  DE,HL
000354 D073 2240D1          16      LD  (COMSWC),HL
000357 D076 F5              11      PUSH    AF
000358 D077 CDF8D0          17      CALL    CEXE4
00035B D07A F1              10      POP AF
00035C D07B 2115F0          10      LD  HL,FNAME
00035F D07E 116D00          10      LD  DE,FCB2FN   ;COMMAND NAME
000362 D081 010B00          10      LD  BC,11
000365 D084 EDB0                    LDIR
000367 D086 1109EB          10      LD  DE,PATHD
       D089                     CEX1:
00036A D089 1A               7      LD  A,(DE)
00036B D08A FE20             7      CP  020H
00036D D08C D8              11      RET C
00036E D08D CD8ADB          17      CALL    FILEC
000371 D090 D5              11      PUSH    DE
000372 D091 216D00          10      LD  HL,FCB2FN   ;COMMAND NAME
000375 D094 1115F0          10      LD  DE,FNAME
000378 D097 010B00          10      LD  BC,11
00037B D09A EDB0                    LDIR
00037D D09C CDF8D0          17      CALL    CEXE4
000380 D09F D1              10      POP DE
000381 D0A0 13               6      INC DE
000382 D0A1 18E6            12      JR  CEX1
                                
       D0A3                     SDVSW:
000384 D0A3 F1              10      POP AF
000385 D0A4 3A14F0          13      LD  A,(FDRV)
000388 D0A7 3D               4      DEC A
000389 D0A8 5F               4      LD  E,A
00038A D0A9 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
00038C D0AB 1831            12      JR  SYSTEM0
                                
       D0AD                     OPEN1:
00038E D0AD 2114F0          10      LD  HL,FDRV
       D0B0                     OPEN:
000391 D0B0 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D0B2                     OPEN3:
000393 D0B2 D5              11      PUSH    DE
000394 D0B3 1145EB          10      LD  DE,DTA_CCP
000397 D0B6 CDD4D0          17      CALL    SETDTA
00039A D0B9 EB               4      EX  DE,HL
00039B D0BA CDDED0          17      CALL    SYSTEM0
00039E D0BD D1              10      POP DE
00039F D0BE C9              10      RET
                                
       D0BF                     OPEN2:
0003A0 D0BF 0E12             7      LD  C,012H
0003A2 D0C1 18EF            12      JR  OPEN3
                                
       D0C3                     DEFCB:              ;Z=Ok NZ=Error
0003A4 D0C3 1145EB          10      LD  DE,DTA_CCP
0003A7 D0C6 CDDCD0          17      CALL    SYSC0F
                                
0003AA D0C9 1166EB          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
0003AD D0CC 0604             7      LD  B,4
0003AF D0CE CD29D3          17      CALL    ZERO_MEMORY_DE
       D0D1                     SETDTA100:
0003B2 D0D1 110001          10      LD  DE,BUFFER
       D0D4                     SETDTA:
0003B5 D0D4 C34FD6          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D0D7                     SETDTA1:
0003B8 D0D7 118000          10      LD  DE,DTA1
0003BB D0DA 18F8            12      JR  SETDTA
                                
       D0DC                     SYSC0F:
0003BD D0DC 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D0DE                     SYSTEM0:
0003BF D0DE CD0500          17      CALL    SYSTEM
0003C2 D0E1 B7               4      OR  A
0003C3 D0E2 C9              10      RET
                                
       D0E3                     C_CD:
0003C4 D0E3 0E5A             7      LD  C,05AH
0003C6 D0E5 18F7            12      JR  SYSTEM0
                                
       D0E7                     S27BUF:
0003C8 D0E7 2100FE          10      LD  HL,0-BUFFER-00100H  ;バッファー+スタック予備(0100H)
       D0EA                     S27BUF2:
0003CB D0EA 39              11      ADD HL,SP
0003CC D0EB 2E00             7      LD  L,0
0003CE D0ED 7C               4      LD  A,H
0003CF D0EE E6F8             7      AND 0F8H
0003D1 D0F0 67               4      LD  H,A
       D0F1                     S27DTA:
0003D2 D0F1 1145EB          10      LD  DE,DTA_CCP
       D0F4                     S27:
0003D5 D0F4 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
0003D7 D0F6 18E6            12      JR  SYSTEM0
                                
       D0F8                     CEXE4:
0003D9 D0F8 211DF0          10      LD  HL,FNAME+8
0003DC D0FB 7E               7      LD  A,(HL)
0003DD D0FC FE20             7      CP  020H
0003DF D0FE 2007            12      JR  NZ,CEXE7
0003E1 D100 3E3F             7      LD  A,'?'
0003E3 D102 77               7      LD  (HL),A
0003E4 D103 23               6      INC HL
0003E5 D104 77               7      LD  (HL),A
0003E6 D105 23               6      INC HL
0003E7 D106 77               7      LD  (HL),A
       D107                     CEXE7:
0003E8 D107 CDADD0          17      CALL    OPEN1
       D10A                     CEXE5:
0003EB D10A C0              11      RET NZ
0003EC D10B 2A4FEB          16      LD  HL,(DTA_CCP+1+9)
0003EF D10E 7C               4      LD  A,H
0003F0 D10F CDB1DE          17      CALL    CAP
0003F3 D112 67               4      LD  H,A
0003F4 D113 7D               4      LD  A,L
0003F5 D114 CDB1DE          17      CALL    CAP
0003F8 D117 6F               4      LD  L,A
0003F9 D118 3A4EEB          13      LD  A,(DTA_CCP+1+8)
0003FC D11B CDB1DE          17      CALL    CAP
0003FF D11E D642             7      SUB 'B'
000401 D120 282C            12      JR  Z,C_BAT
000403 D122 3D               4      DEC A       ;'C'
000404 D123 2805            12      JR  Z,C_EXE
       D125                     CEXE6:
000406 D125 CDBFD0          17      CALL    OPEN2
000409 D128 18E0            12      JR  CEXE5
                                
       D12A                     C_EXE:
00040B D12A 7C               4      LD  A,H
00040C D12B FE4D             7      CP  'M'
00040E D12D 20F6            12      JR  NZ,CEXE6
                                
000410 D12F CDC3D0          17      CALL    DEFCB
000413 D132 CDE7D0          17      CALL    S27BUF_COM
000416 D135 3D               4      DEC A
000417 D136 37               4      SCF
000418 D137 C0              11      RET NZ
000419 D138 7C               4      LD  A,H
00041A D139 B5               4      OR  L
00041B D13A 37               4      SCF
00041C D13B C8              11      RET Z
00041D D13C CDD7D0          17      CALL    SETDTA1
000420 D13F 110000          10      LD  DE,0                ; self-modifying code
       D140                     COMSWC  EQU $-2
000423 D142 ED7B0600        20      LD  SP,(SYSTEM+1)
000427 D146 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
000428 D147 6F               4      LD  L,A
000429 D148 E5              11      PUSH    HL              ; push $0000 (reboot address)
00042A D149 24               4      INC H
00042B D14A E5              11      PUSH    HL              ; push $0100 (TPA address)
00042C D14B C3F4D2          10      JP  SETFCB              ; and JP $0100
                                
       D14E                     C_BAT:
00042F D14E 114154          10      LD  DE,'A'+'T'*256
000432 D151 ED52            15      SBC HL,DE
000434 D153 20D0            12      JR  NZ,CEXE6
                                
000436 D155 CDC3D0          17      CALL    DEFCB
                                
000439 D158 2145EB          10      LD  HL,DTA_CCP
00043C D15B 116AEB          10      LD  DE,FCB_BAT
00043F D15E 012500          10      LD  BC,37
000442 D161 EDB0                    LDIR
       D163                     C_BAT1:
000444 D163 CDD1D0          17      CALL    SETDTA100
000447 D166 CD9AD1          17      CALL    FGETC_BAT
00044A D169 218100          10      LD  HL,DTA1+1
00044D D16C 2025            12      JR  NZ,END_BATCH
00044F D16E FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
000451 D170 38F1            12      JR  C,C_BAT1
000453 D172 3620            10      LD  (HL),' '
000455 D174 23               6      INC HL
       D175                     C_BAT2:
000456 D175 77               7      LD  (HL),A
000457 D176 23               6      INC HL
000458 D177 7D               4      LD  A,L
000459 D178 3C               4      INC A       ;L==0FFH
00045A D179 2809            12      JR  Z,RUN_BATCH
00045C D17B CD9AD1          17      CALL    FGETC_BAT
00045F D17E 2004            12      JR  NZ,RUN_BATCH
000461 D180 FE20             7      CP  020H
000463 D182 30F1            12      JR  NC,C_BAT2
       D184                     RUN_BATCH:
000465 D184 7D               4      LD  A,L
000466 D185 D67F             7      SUB DTA1-1
000468 D187 328000          13      LD  (DTA1),A
00046B D18A FE04             7      CP  4
00046D D18C 3805            12      JR  C,END_BATCH
00046F D18E 3600            10      LD  (HL),0
000471 D190 C341D0          10      JP  COMMAND2
       D193                     END_BATCH:
000474 D193 AF               4      XOR A       ;バッチファイルを閉じる
000475 D194 326AEB          13      LD  (FCB_BAT),A
000478 D197 C300F0          10      JP  CPM_BOOT
                                
       D19A                     FGETC_BAT:
00047B D19A 116AEB          10      LD  DE,FCB_BAT
       D19D                     FGETC:              ;1文字ずつ読み込む
00047E D19D E5              11      PUSH    HL      ;Z:成功
00047F D19E 210100          10      LD  HL,1
000482 D1A1 CDF4D0          17      CALL    S27
000485 D1A4 E1              10      POP HL
000486 D1A5 3A0001          13      LD  A,(BUFFER)
000489 D1A8 C9              10      RET
                                
       D1A9                     C_DEL:
00048A D1A9 CDF4D2          17      CALL    SETFCB
00048D D1AC CD35D7          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
000490 D1AF 0E13             7      LD  C,013H
000492 D1B1 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       D1B3                     C_REN:
000494 D1B3 CDF4D2          17      CALL    SETFCB
000497 D1B6 3E10             7      LD  A,010H      ;ディレクトリも対象にする
000499 D1B8 326900          13      LD  (FCB1+13),A ;属性
00049C D1BB 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       D1BD                     CDEL1:
00049E D1BD 115C00          10      LD  DE,FCB1
0004A1 D1C0 CD0500          17      CALL    SYSTEM
0004A4 D1C3 C6FF             7      ADD A,0FFH
0004A6 D1C5 C9              10      RET
                                
       D1C6                     C_DIR:
0004A7 D1C6 CD8ADB          17      CALL    FILEC
0004AA D1C9 2115F0          10      LD  HL,FDRV+1
0004AD D1CC CD0AD4          17      CALL    CWILD1
0004B0 D1CF 3EF1             7      LD  A,0F1H
0004B2 D1D1 3221F0          13      LD  (FDRV+13),A
0004B5 D1D4 CDADD0          17      CALL    OPEN1
       D1D7                     CDIR1:
0004B8 D1D7 B7               4      OR  A
0004B9 D1D8 2008            12      JR  NZ,PDSKF
0004BB D1DA CD25D2          17      CALL    P_NAME
0004BE D1DD CDBFD0          17      CALL    OPEN2
0004C1 D1E0 18F5            12      JR  CDIR1
       D1E2                     PDSKF:
0004C3 D1E2 3A14F0          13      LD  A,(FDRV)
0004C6 D1E5 5F               4      LD  E,A
0004C7 D1E6 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
0004C9 D1E8 CD0500          17      CALL    SYSTEM
0004CC D1EB 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
0004CD D1EC C601             7      ADD A,001H
0004CF D1EE D8              11      RET C       ;Aが0FFHだった場合
0004D0 D1EF 3E06             7      LD  A,8-2
       D1F1                     PDS1:               ;HL=未使用クラスタの総数
0004D2 D1F1 3C               4      INC A
0004D3 D1F2 CB19             8      RR  C
0004D5 D1F4 30FB            12      JR  NC,PDS1
       D1F6                     PDS2:               ;B←論理セクタのサイズの上位8ビット
0004D7 D1F6 3C               4      INC A
0004D8 D1F7 CB18             8      RR  B
0004DA D1F9 30FB            12      JR  NC,PDS2
0004DC D1FB 47               4      LD  B,A
                                
0004DD D1FC 110000          10      LD  DE,0
       D1FF                     PDS3:
0004E0 D1FF 29              11      ADD HL,HL
0004E1 D200 EB               4      EX  DE,HL
0004E2 D201 ED6A            15      ADC HL,HL
0004E4 D203 EB               4      EX  DE,HL
0004E5 D204 10F9            13      DJNZ    PDS3
       D206                     PDSKF1:
0004E7 D206 CD92D2          17      CALL    PRDEC_DEHL
0004EA D209 119AEB          10      LD  DE,FREE
0004ED D20C CD7CD4          17      CALL    _SYS09      ;(BDOS)文字列出力
0004F0 D20F CD7FD2          17      CALL    PUTDRV
0004F3 D212 3E5C             7      LD  A,05CH      ;\
0004F5 D214 CD1FD7          17      CALL    MSG_A
0004F8 D217 2A22F0          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
0004FB D21A AF               4      XOR A
0004FC D21B 11FEFF          10      LD  DE,0-2
0004FF D21E 19              11      ADD HL,DE
000500 D21F 23               6      INC HL
000501 D220 DC8FD2          17      CALL    C,PRDEC_HL
000504 D223 1833            12      JR  LTNL
                                
       D225                     P_NAME:
000506 D225 3A46EB          13      LD  A,(DTA_CCP+1)
000509 D228 FE2E             7      CP  '.'
00050B D22A C8              11      RET Z
                                
00050C D22B 3A51EB          13      LD  A,(DTA_CCP+1+00BH)
00050F D22E F5              11      PUSH    AF
000510 D22F CB67             8      BIT 4,A
000512 D231 2808            12      JR  Z,DIR3
000514 D233 118FEB          10      LD  DE,DIRMES
000517 D236 CD7CD4          17      CALL    _SYS09      ;(BDOS)文字列出力
00051A D239 180A            12      JR  DIR6
       D23B                     DIR3:
00051C D23B ED5B64EB        20      LD  DE,(DTA_CCP+1+01EH)
000520 D23F 2A62EB          16      LD  HL,(DTA_CCP+1+01CH)
000523 D242 CD92D2          17      CALL    PRDEC_DEHL
       D245                     DIR6:
000526 D245 F1              10      POP AF
000527 D246 0F               4      RRCA
000528 D247 9F               4      SBC A,A
000529 D248 E60A             7      AND '*'-020H
00052B D24A C620             7      ADD A,020H
00052D D24C CD1FD7          17      CALL    MSG_A
000530 D24F CD7FD2          17      CALL    PUTDRV
000533 D252 2146EB          10      LD  HL,DTA_CCP+1
000536 D255 CDD2D2          17      CALL    FPRNT
                                
       D258                     LTNL:
000539 D258 1E03             7      LD  E,3
00053B D25A C3CDF0          10      JP  _PRINT
                                
       D25D                     C_PATH:
00053E D25D CD6BDC          17      CALL    SPCUT
000541 D260 2109EB          10      LD  HL,PATHD
000544 D263 FE21             7      CP  021H
000546 D265 300C            12      JR  NC,CPATH0
       D267                     CPATHP:
000548 D267 7E               7      LD  A,(HL)
000549 D268 23               6      INC HL
00054A D269 FE20             7      CP  020H
00054C D26B 3F               4      CCF
00054D D26C 30EA            12      JR  NC,LTNL
00054F D26E CD1FD7          17      CALL    MSG_A
000552 D271 18F4            12      JR  CPATHP
       D273                     CPATH0:
000554 D273 FE3B             7      CP  ';'
000556 D275 2001            12      JR  NZ,CPATH1
000558 D277 13               6      INC DE
       D278                     CPATH1:
000559 D278 EB               4      EX  DE,HL
00055A D279 013B00          10      LD  BC,PATHX
00055D D27C EDB0                    LDIR
00055F D27E C9              10      RET
                                
       D27F                     PUTDRV:
000560 D27F 3A14F0          13      LD  A,(FDRV)
000563 D282 CD9EDC          17      CALL    GETDRV1
000566 D285 C641             7      ADD A,'A'
000568 D287 CD1FD7          17      CALL    MSG_A
00056B D28A 3E3A             7      LD  A,':'
       D28C                     MSG_AR:
00056D D28C C31FD7          10      JP  MSG_A
                                
       D28F                     PRDEC_HL:
000570 D28F AF               4      XOR A
000571 D290 5F               4      LD  E,A
000572 D291 57               4      LD  D,A
       D292                     PRDEC_DEHL:
000573 D292 D5              11      PUSH    DE
000574 D293 110FF0          10      LD  DE,DECBF
000577 D296 0605             7      LD  B,5
000579 D298 CD29D3          17      CALL    ZERO_MEMORY_DE  ;A=0
00057C D29B D1              10      POP DE
                                
00057D D29C 0E20             7      LD  C,32
       D29E                     DEC1:
00057F D29E 29              11      ADD HL,HL
000580 D29F EB               4      EX  DE,HL
000581 D2A0 ED6A            15      ADC HL,HL
000583 D2A2 EB               4      EX  DE,HL
000584 D2A3 E5              11      PUSH    HL
000585 D2A4 2113F0          10      LD  HL,DECBF+4
000588 D2A7 0605             7      LD  B,5
       D2A9                     DEC2:
00058A D2A9 7E               7      LD  A,(HL)
00058B D2AA 8F               4      ADC A,A
00058C D2AB 27               4      DAA
00058D D2AC 77               7      LD  (HL),A
00058E D2AD 2B               6      DEC HL
00058F D2AE 10F9            13      DJNZ    DEC2
000591 D2B0 E1              10      POP HL
000592 D2B1 0D               4      DEC C
000593 D2B2 20EA            12      JR  NZ,DEC1
                                
000595 D2B4 210FF0          10      LD  HL,DECBF
000598 D2B7 3E20             7      LD  A,020H
00059A D2B9 0604             7      LD  B,4
       D2BB                     DEC3:
00059C D2BB CDC8D2          17      CALL    DEC4
00059F D2BE CDC8D2          17      CALL    DEC4
0005A2 D2C1 23               6      INC HL
0005A3 D2C2 10F7            13      DJNZ    DEC3
       D2C4                     DECX:
0005A5 D2C4 CDC8D2          17      CALL    DEC4
0005A8 D2C7 AF               4      XOR A
       D2C8                     DEC4:
0005A9 D2C8 ED6F            18      RLD
0005AB D2CA FE20             7      CP  020H
0005AD D2CC 2802            12      JR  Z,DEC5
0005AF D2CE F630             7      OR  030H
       D2D0                     DEC5:
0005B1 D2D0 18BA            12      JR  MSG_AR
                                
       D2D2                     FPRNT:
0005B3 D2D2 0608             7      LD  B,8 ;ファイル名を表示
0005B5 D2D4 CDE3D2          17      CALL    P_N1
0005B8 D2D7 7E               7      LD  A,(HL)
0005B9 D2D8 CDBDDE          17      CALL    CAP3
0005BC D2DB D8              11      RET C   ;拡張子が無い
                                
0005BD D2DC 3E2E             7      LD  A,'.'
0005BF D2DE CD1FD7          17      CALL    MSG_A
0005C2 D2E1 0603             7      LD  B,3 ;拡張子を表示
       D2E3                     P_N1:
0005C4 D2E3 7E               7      LD  A,(HL)
0005C5 D2E4 CDBDDE          17      CALL    CAP3
0005C8 D2E7 3807            12      JR  C,P_N2
0005CA D2E9 CD1FD7          17      CALL    MSG_A
0005CD D2EC 23               6      INC HL
0005CE D2ED 10F4            13      DJNZ    P_N1
0005D0 D2EF C9              10      RET
       D2F0                     P_N2:
0005D1 D2F0 23               6      INC HL
0005D2 D2F1 10FD            13      DJNZ    P_N2
0005D4 D2F3 C9              10      RET
                                
       D2F4                     SETFCB:
0005D5 D2F4 CD6BDC          17      CALL    SPCUT
0005D8 D2F7 1A               7      LD  A,(DE)
0005D9 D2F8 FE20             7      CP  020H
0005DB D2FA 3801            12      JR  C,SETFCBA
0005DD D2FC 1B               6      DEC DE
       D2FD                     SETFCBA:
0005DE D2FD 0624             7      LD  B,36
0005E0 D2FF 215C00          10      LD  HL,FCB1
0005E3 D302 E5              11      PUSH    HL
0005E4 D303 AF               4      XOR A
0005E5 D304 CD40DC          17      CALL    FILL_MEMORY
0005E8 D307 E1              10      POP HL
0005E9 D308 D5              11      PUSH    DE
0005EA D309 CDB5D6          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0005ED D30C 216C00          10      LD  HL,FCB2
0005F0 D30F CDB5D6          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0005F3 D312 E1              10      POP HL
0005F4 D313 010050          10      LD  BC,05000H
0005F7 D316 118100          10      LD  DE,00081H
       D319                     SETFCB1:
0005FA D319 7E               7      LD  A,(HL)
0005FB D31A 23               6      INC HL
0005FC D31B FE20             7      CP  020H
0005FE D31D 3805            12      JR  C,SETFCB2
000600 D31F 12               7      LD  (DE),A
000601 D320 13               6      INC DE
000602 D321 0C               4      INC C
000603 D322 10F5            13      DJNZ    SETFCB1
       D324                     SETFCB2:
000605 D324 79               4      LD  A,C
000606 D325 328000          13      LD  (DTA1),A
000609 D328 04               4      INC B
       D329                     ZERO_MEMORY_DE:
00060A D329 AF               4      XOR A
       D32A                     FILL_MEMORY_DE:
00060B D32A 12               7      LD  (DE),A
00060C D32B 13               6      INC DE
00060D D32C 10FC            13      DJNZ    FILL_MEMORY_DE
00060F D32E C9              10      RET
                                
       D32F                     C_COPY:
000610 D32F CDF4D2          17      CALL    SETFCB
                                
000613 D332 1161F0          10      LD  DE,ZERO
000616 D335 CD8DDB          17      CALL    FILEC2
000619 D338 216C00          10      LD  HL,FCB2
00061C D33B CDBCD6          17      CALL    S29X1
                                
00061F D33E 3E10             7      LD  A,010H
000621 D340 326900          13      LD  (FCB1+13),A
000624 D343 216D00          10      LD  HL,FCB2FN
000627 D346 CD0AD4          17      CALL    CWILD1
       D349                     COPY0:
00062A D349 CD07D4          17      CALL    CWILD
00062D D34C 215C00          10      LD  HL,FCB1
000630 D34F CDB0D0          17      CALL    OPEN
000633 D352 37               4      SCF
       D353                     COPY1:
000634 D353 C0              11      RET NZ
000635 D354 CDC3D0          17      CALL    DEFCB
                                
000638 D357 3A52EB          13      LD  A,(DTA_CCP+13)
00063B D35A CB67             8      BIT 4,A
00063D D35C 2821            12      JR  Z,COPY1A
                                
00063F D35E 215D00          10      LD  HL,FCB1FN
000642 D361 CDD0DF          17      CALL    CHKWILD
000645 D364 3814            12      JR  C,COPY9
                                
000647 D366 3E20             7      LD  A,020H
000649 D368 325D00          13      LD  (FCB1FN),A
00064C D36B 2A5FEB          16      LD  HL,(DTA_CCP+26)
00064F D36E 23               6      INC HL
000650 D36F 226A00          16      LD  (FCB1+14),HL
000653 D372 18D5            12      JR  COPY0
                                
       D374                     COPY8:
000655 D374 CD7CD4          17      CALL    _SYS09      ;(BDOS)文字列出力
000658 D377 CD58D2          17      CALL    LTNL
       D37A                     COPY9:
00065B D37A CDBFD0          17      CALL    OPEN2
00065E D37D 18D4            12      JR  COPY1
                                
       D37F                     COPY1A:
000660 D37F 216C00          10      LD  HL,FCB2
000663 D382 1114F0          10      LD  DE,FDRV
000666 D385 0147EB          10      LD  BC,DTA_CCP+2
000669 D388 EDA0            16      LDI
00066B D38A 3E0B             7      LD  A,11
       D38C                     COPY2:
00066D D38C F5              11      PUSH    AF
00066E D38D 7E               7      LD  A,(HL)
00066F D38E FE3F             7      CP  '?'
000671 D390 2001            12      JR  NZ,COPY3
000673 D392 0A               7      LD  A,(BC)
       D393                     COPY3:
000674 D393 12               7      LD  (DE),A
000675 D394 03               6      INC BC
000676 D395 13               6      INC DE
000677 D396 23               6      INC HL
000678 D397 F1              10      POP AF
000679 D398 3D               4      DEC A
00067A D399 20F1            12      JR  NZ,COPY2
00067C D39B 010500          10      LD  BC,16-11
00067F D39E EDB0                    LDIR
       D3A0                     PUTNAME:
000681 D3A0 215D00          10      LD  HL,FCB1FN
000684 D3A3 CDD0DF          17      CALL    CHKWILD
000687 D3A6 300B            12      JR  NC,PUTN1
000689 D3A8 2115F0          10      LD  HL,FDRV+1
00068C D3AB CDD2D2          17      CALL    FPRNT
00068F D3AE 3E20             7      LD  A,020H
000691 D3B0 CD1FD7          17      CALL    MSG_A
       D3B3                     PUTN1:
000694 D3B3 1114F0          10      LD  DE,FDRV
000697 D3B6 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
000699 D3B8 CDDED0          17      CALL    SYSTEM0
00069C D3BB 2048            12      JR  NZ,COPYE2
00069E D3BD 67               4      LD  H,A     ;A=0
00069F D3BE 6F               4      LD  L,A
0006A0 D3BF 2235F0          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
0006A3 D3C2 2237F0          16      LD  (FDRV+35),HL
       D3C5                     COPY6:
0006A6 D3C5 CDE7D0          17      CALL    S27BUF
0006A9 D3C8 47               4      LD  B,A
0006AA D3C9 3C               4      INC A
0006AB D3CA 2831            12      JR  Z,COPYE
0006AD D3CC 7C               4      LD  A,H
0006AE D3CD B5               4      OR  L
0006AF D3CE 280C            12      JR  Z,COPY7
0006B1 D3D0 1114F0          10      LD  DE,FDRV
0006B4 D3D3 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0006B6 D3D5 CDDED0          17      CALL    SYSTEM0
0006B9 D3D8 2023            12      JR  NZ,COPYE
0006BB D3DA 10E9            13      DJNZ    COPY6
       D3DC                     COPY7:
0006BD D3DC 3A52EB          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
0006C0 D3DF 3221F0          13      LD  (FDRV+13),A
0006C3 D3E2 2159EB          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
0006C6 D3E5 1128F0          10      LD  DE,FDRV+20
0006C9 D3E8 010400          10      LD  BC,4
0006CC D3EB EDB0                    LDIR
                                
0006CE D3ED 1114F0          10      LD  DE,FDRV
0006D1 D3F0 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
0006D3 D3F2 CDDED0          17      CALL    SYSTEM0
0006D6 D3F5 2006            12      JR  NZ,COPYE
                                
0006D8 D3F7 1171F0          10      LD  DE,OK
0006DB D3FA C374D3          10      JP  COPY8
                                
       D3FD                     COPYE:
0006DE D3FD 1114F0          10      LD  DE,FDRV
0006E1 D400 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
0006E3 D402 CD0500          17      CALL    SYSTEM
       D405                     COPYE2:
0006E6 D405 37               4      SCF
0006E7 D406 C9              10      RET
                                
       D407                     CWILD:
0006E8 D407 215D00          10      LD  HL,FCB1FN
       D40A                     CWILD1:
0006EB D40A 7E               7      LD  A,(HL)
0006EC D40B FE20             7      CP  020H
0006EE D40D C0              11      RET NZ
       D40E                     CWILD2:
0006EF D40E 3E3F             7      LD  A,'?'
0006F1 D410 060B             7      LD  B,11
0006F3 D412 C340DC          10      JP  FILL_MEMORY
                                
       D415                     COMTB:
0006F6 D415 44202020                DB  "D   "  ;1
0006FA D419 C6D1                    DW  C_DIR
0006FC D41B 44495220                DB  "DIR "  ;2
000700 D41F C6D1                    DW  C_DIR
000702 D421 434F5059                DB  "COPY"  ;3
000706 D425 2FD3                    DW  C_COPY
000708 D427 43442020                DB  "CD  "  ;4
00070C D42B E3D0                    DW  C_CD
00070E D42D 44454C20                DB  "DEL "  ;5
000712 D431 A9D1                    DW  C_DEL
000714 D433 50415448                DB  "PATH"  ;6
000718 D437 5DD2                    DW  C_PATH
00071A D439 52454E20                DB  "REN "  ;7
00071E D43D B3D1                    DW  C_REN
000720 D43F 52454D20                DB  "REM "  ;8
000724 D443 79D4                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP2.ASM"
                                
                                ;   LSX-Dodgers CCP2
                                ;   MZ-700/1500
                                
000726 D445 4D4F4E20                DB  "MON "  ;9
00072A D449 7ADB                    DW  C_MON
[EOF:M7CCP2.ASM:UTF_8]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       D44B                     BDOS0:
00072C D44B E5              11      PUSH    HL
00072D D44C 79               4      LD  A,C
00072E D44D FE3C             7      CP  03CH
000730 D44F 3802            12      JR  C,DOS1
000732 D451 3E3C             7      LD  A,03CH
       D453                     DOS1:
000734 D453 87               4      ADD A,A
000735 D454 3258D4          13      LD  (DOS1_SWC),A
000738 D457 2A00F1          16      LD  HL,(STABLE)
       D458                     DOS1_SWC    EQU $-2
00073B D45A E3              19      EX  (SP),HL
00073C D45B 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
00073D D45C C9              10      RET
       D45D                     _DOS2:
00073E D45D FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
000740 D45F CAF7D6          10      JP  Z,_SYS5A
000743 D462 FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
000745 D464 CAB4D6          10      JP  Z,_SYS5C
000748 D467 FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
00074A D469 CACDE8          10      JP  Z,_SYS5F
00074D D46C FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
00074F D46E 200A            12      JR  NZ,_ERROR
000751 D470 011D01          10      LD  BC,VER_6F
000754 D473 116201          10      LD  DE,VER
000757 D476 210100          10      LD  HL,MACD
       D479                     C_REM:
00075A D479 AF               4      XOR A
       D47A                     _ERROR:
00075B D47A A7               4      AND A
00075C D47B C9              10      RET
                                
       D47C                     _SYS09:     ;文字列出力
00075D D47C D5              11      PUSH    DE
       D47D                     _SX09:
00075E D47D 1A               7      LD  A,(DE)
00075F D47E 13               6      INC DE
000760 D47F FE24             7      CP  '$'
000762 D481 2831            12      JR  Z,SX0E2
000764 D483 CD1FD7          17      CALL    MSG_A
000767 D486 18F5            12      JR  _SX09
                                
       D488                     MSX1:
000769 D488 CD1FD7          17      CALL    MSG_A
       D48B                     MSX:
00076C D48B 7E               7      LD  A,(HL)
00076D D48C 23               6      INC HL
00076E D48D B7               4      OR  A
00076F D48E 20F8            12      JR  NZ,MSX1
000771 D490 C9              10      RET
                                
       D491                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000772 D491 212200          10      LD  HL,00022H
000775 D494 7D               4      LD  A,L
000776 D495 C9              10      RET
                                
       D496                     _SYS0D:     ;(BDOS)ディスクリセット
000777 D496 CDDFF0          17      CALL    _FFLUSH
00077A D499 E5              11      PUSH    HL
00077B D49A 218000          10      LD  HL,00080H
00077E D49D 228AF0          16      LD  (_DTA),HL
000781 D4A0 E1              10      POP HL
000782 D4A1 D5              11      PUSH    DE
000783 D4A2 1E00             7      LD  E,0
000785 D4A4 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       D4A5                     _SYS0E:     ;(BDOS)カレントドライブの設定
000786 D4A5 D5              11      PUSH    DE
000787 D4A6 7B               4      LD  A,E
000788 D4A7 DDE5            15      PUSH    IX
00078A D4A9 CDDCF0          17      CALL    _GETDPB
00078D D4AC DDE1            14      POP IX
00078F D4AE 3804            12      JR  C,SX0E2
000791 D4B0 7B               4      LD  A,E
000792 D4B1 320400          13      LD  (_DVSW),A
       D4B4                     SX0E2:
000795 D4B4 D1              10      POP DE
000796 D4B5 C9              10      RET
                                
       D4B6                     _SYS0F:     ;(BDOS)ファイルのオープン
000797 D4B6 CD7DDC          17      CALL    SETDRV
00079A D4B9 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
00079D D4BC C602             7      ADD A,002H      ;Write
00079F D4BE 2848            12      JR  Z,FEND0F
0007A1 D4C0 CDCCDF          17      CALL    CHKWILDX
                                
0007A4 D4C3 D4A7DC          17      CALL    NC,SOPENX
       D4C6                     _S16XX:
0007A7 D4C6 3840            12      JR  C,FEND0F
                                                ;Directory location
0007A9 D4C8 3A9FF0          13      LD  A,(_FILEN)
0007AC D4CB FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
0007AF D4CE 3AA0F0          13      LD  A,(_DIRF)
0007B2 D4D1 FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
0007B5 D4D4 FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
0007B8 D4D7 FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
0007BB D4DA FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
0007BF D4DE FDE5            15      PUSH    IY
0007C1 D4E0 D1              10      POP DE
0007C2 D4E1 13               6      INC DE
0007C3 D4E2 010B00          10      LD  BC,11
0007C6 D4E5 EDB0                    LDIR
                                ;               Attribute
0007C8 D4E7 7E               7      LD  A,(HL)
0007C9 D4E8 FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
0007CC D4EB 110B00          10      LD  DE,11       ;Reserved
0007CF D4EE 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
0007D0 D4EF 11E4F1          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
0007D3 D4F2 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D4F4                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
0007D5 D4F4 1A               7      LD  A,(DE)
0007D6 D4F5 13               6      INC DE
0007D7 D4F6 32FDD4          13      LD  (S16PAT),A
0007DA D4F9 7E               7      LD  A,(HL)
0007DB D4FA 23               6      INC HL
0007DC D4FB FD7700          19      LD  (IY+0),A
       D4FD                     S16PAT  EQU $-1
0007DF D4FE 10F4            13      DJNZ    S16LOOP
                                
0007E1 D500 AF               4      XOR A
0007E2 D501 FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
0007E5 D504 FD22A5D5        20      LD  (OFCB_SWC),IY
       D508                     FEND0F:
0007E9 D508 1845            12      JR  FEND10
                                
       D50A                     _SYS10:     ;(BDOS)ファイルのクローズ
0007EB D50A CD7DDC          17      CALL    SETDRV
0007EE D50D FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0007F1 D510 D6FE             7      SUB 0FEH
0007F3 D512 37               4      SCF
0007F4 D513 3F               4      CCF
0007F5 D514 2039            12      JR  NZ,FEND10
       D516                     _S10A:              ;Write
0007F7 D516 FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
0007FA D519 FD770F          19      LD  (IY+15),A
                                
0007FD D51C FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
000800 D51F CDC8E0          17      CALL    SETTMS
                                
000803 D522 FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000806 D525 32A0F0          13      LD  (_DIRF),A
000809 D528 E67F             7      AND 07FH
00080B D52A 32EDE5          13      LD  (_SECPS),A
00080E D52D FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
000811 D530 FD561F          19      LD  D,(IY+31)
000814 D533 CDDBDD          17      CALL    READ_DIR
000817 D536 3817            12      JR  C,FEND10
                                
000819 D538 3A07DD          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
00081C D53B 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
00081D D53C FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
000820 D53F 6F               4      LD  L,A
000821 D540 2600             7      LD  H,0
000823 D542 29              11      ADD HL,HL       ;*2
000824 D543 29              11      ADD HL,HL       ;*4
000825 D544 29              11      ADD HL,HL       ;*8
000826 D545 29              11      ADD HL,HL       ;*16
000827 D546 29              11      ADD HL,HL       ;*32
000828 D547 ED4B7EF1        20      LD  BC,(_DTBUF)
00082C D54B 09              11      ADD HL,BC
                                
00082D D54C CDDCDF          17      CALL    SDIRENT
       D54F                     FEND10:
000830 D54F 1842            12      JR  FEND
                                
       D551                     _SYS11:     ;(BDOS)最初のファイルの検索
000832 D551 CD7DDC          17      CALL    SETDRV
000835 D554 CDD6DC          17      CALL    SOPEN
       D557                     _S12X1:
000838 D557 383A            12      JR  C,FEND
00083A D559 CD75DD          17      CALL    SOPENE2
00083D D55C ED5B8AF0        20      LD  DE,(_DTA)
000841 D560 3A88F0          13      LD  A,(_DRV)
000844 D563 3C               4      INC A
000845 D564 12               7      LD  (DE),A
000846 D565 D5              11      PUSH    DE
000847 D566 13               6      INC DE
000848 D567 012000          10      LD  BC,32
00084B D56A EDB0                    LDIR
00084D D56C FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000850 D56F FD660F          19      LD  H,(IY+15)
000853 D572 22F4F1          16      LD  (SCDIR),HL
000856 D575 2A9AF0          16      LD  HL,(_FBPS)
000859 D578 22F6F1          16      LD  (SFBPS),HL
00085C D57B 2A9FF0          16      LD  HL,(_FILEN)
00085F D57E 7C               4      LD  A,H
000860 D57F B7               4      OR  A
000861 D580 2806            12      JR  Z,_S12DIR
000863 D582 3AEDE5          13      LD  A,(_SECPS)
000866 D585 F680             7      OR  080H
000868 D587 67               4      LD  H,A
       D588                     _S12DIR:
000869 D588 22F8F1          16      LD  (SFNDF),HL  ;Directory position and Flags
00086C D58B E1              10      POP HL
00086D D58C 1139F0          10      LD  DE,SFILE
000870 D58F 0E21             7      LD  C,33
       D591                     _S11B:
000872 D591 EDB0                    LDIR
       D593                     FEND:
000874 D593 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D594                     FENDE:
000875 D594 FDE1            14      POP IY
000877 D596 C1              10      POP BC
000878 D597 D1              10      POP DE
000879 D598 E1              10      POP HL
00087A D599 C9              10      RET
                                
       D59A                     _SYS12:     ;(BDOS)次のファイルの検索
00087B D59A E5              11      PUSH    HL
00087C D59B D5              11      PUSH    DE
00087D D59C C5              11      PUSH    BC
00087E D59D FDE5            15      PUSH    IY
000880 D59F CD3ADD          17      CALL    NOPEN
000883 D5A2 18B3            12      JR  _S12X1
                                
       D5A4                     _S16K:
000885 D5A4 110000          10      LD  DE,0
       D5A5                     OFCB_SWC    EQU $-2
000888 D5A7 D5              11      PUSH    DE
000889 D5A8 061A             7      LD  B,26        ;First cluster
       D5AA                     S16K1:
00088B D5AA 13               6      INC DE
00088C D5AB 23               6      INC HL
00088D D5AC 10FC            13      DJNZ    S16K1
                                
00088F D5AE 1A               7      LD  A,(DE)
000890 D5AF BE               7      CP  (HL)
000891 D5B0 2015            12      JR  NZ,S16K2
000893 D5B2 13               6      INC DE
000894 D5B3 23               6      INC HL
000895 D5B4 1A               7      LD  A,(DE)
000896 D5B5 BE               7      CP  (HL)
000897 D5B6 200F            12      JR  NZ,S16K2
                                
000899 D5B8 E1              10      POP HL
00089A D5B9 FDE5            15      PUSH    IY
00089C D5BB D1              10      POP DE
00089D D5BC 7E               7      LD  A,(HL)
00089E D5BD CD92DC          17      CALL    IS_SAME_DRV_A_DE
0008A1 D5C0 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
0008A3 D5C2 ED52            15      SBC HL,DE       ;CP HL,DE
0008A5 D5C4 37               4      SCF
0008A6 D5C5 C0              11      RET NZ
0008A7 D5C6 E5              11      PUSH    HL
       D5C7                     S16K2:
0008A8 D5C7 E1              10      POP HL
       D5C8                     S16K3:
0008A9 D5C8 FDE5            15      PUSH    IY
0008AB D5CA D1              10      POP DE
       D5CB                     _SYS13:     ;(BDOS)ファイルの削除
0008AC D5CB CD7DDC          17      CALL    SETDRV
0008AF D5CE CD04DF          17      CALL    KILL
       D5D1                     FEND13:
0008B2 D5D1 18C0            12      JR  FEND
                                
       D5D3                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0008B4 D5D3 CD7DDC          17      CALL    SETDRV
0008B7 D5D6 CD40E4          17      CALL    INIT_SEQ
       D5D9                     SREAD:
0008BA D5D9 CD12E4          17      CALL    RB_READ
                                
0008BD D5DC C601             7      ADD A,001H
0008BF D5DE 38B3            12      JR  C,FEND
                                
0008C1 D5E0 7D               4      LD  A,L
0008C2 D5E1 D601             7      SUB 001H
       D5E3                     FENDX:
0008C4 D5E3 9F               4      SBC A,A
0008C5 D5E4 E603             7      AND 3
0008C7 D5E6 1F               4      RRA
0008C8 D5E7 18AB            12      JR  FENDE
                                
       D5E9                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
0008CA D5E9 CD7DDC          17      CALL    SETDRV
0008CD D5EC CD40E4          17      CALL    INIT_SEQ
       D5EF                     SWRITE:
0008D0 D5EF CD0DE4          17      CALL    RB_WRITE
                                
0008D3 D5F2 C6FF             7      ADD A,0FFH
0008D5 D5F4 18ED            12      JR  FENDX
                                
       D5F6                     _SYS17:     ;(BDOS)ファイル名の変更
0008D7 D5F6 CD7DDC          17      CALL    SETDRV
0008DA D5F9 CD5ADF          17      CALL    NAME
0008DD D5FC 18D3            12      JR  FEND13
                                
       D5FE                     _SYS16:     ;(BDOS)ファイルの作成
0008DF D5FE CD7DDC          17      CALL    SETDRV
                                
0008E2 D601 CDCCDF          17      CALL    CHKWILDX
0008E5 D604 38CB            12      JR  C,FEND13
0008E7 D606 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
0008EA D609 FE05             7      CP  5
0008EC D60B 2805            12      JR  Z,_S16X2
0008EE D60D FE21             7      CP  021H
0008F0 D60F DAD1D5          10      JP  C,FEND13
       D612                     _S16X2:
                                ;               Clear FCB
0008F3 D612 FDE5            15      PUSH    IY
0008F5 D614 E1              10      POP HL
0008F6 D615 011000          10      LD  BC,16
0008F9 D618 09              11      ADD HL,BC
       D619                     _S16X1:
0008FA D619 70               7      LD  (HL),B      ;B=0
0008FB D61A 23               6      INC HL
0008FC D61B 0D               4      DEC C
0008FD D61C 20FB            12      JR  NZ,_S16X1
                                
0008FF D61E CDCDE0          17      CALL    SETTMSX
000902 D621 FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000906 D625 CDA7DC          17      CALL    SOPENX
000909 D628 3F               4      CCF
00090A D629 CCA4D5          17      CALL    Z,_S16K
00090D D62C D486DD          17      CALL    NC,COPEN
000910 D62F D4DCDF          17      CALL    NC,SDIRENT
000913 D632 C3C6D4          10      JP  _S16XX
                                
       D635                     _SYS21:     ;(BDOS)ランダムな読み出し
000916 D635 CD7DDC          17      CALL    SETDRV
000919 D638 CD18E1          17      CALL    INIT_RND
00091C D63B 189C            12      JR  SREAD
                                
       D63D                     _SYS22:     ;(BDOS)ランダムな書き込み
       D63D                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
00091E D63D CD7DDC          17      CALL    SETDRV
000921 D640 CD18E1          17      CALL    INIT_RND
000924 D643 18AA            12      JR  SWRITE
                                
       D645                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000926 D645 21FF00          10      LD  HL,000FFH
000929 D648 AF               4      XOR A
00092A D649 C9              10      RET
                                
       D64A                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
00092B D64A 3A0400          13      LD  A,(_DVSW)   ;from LDOS
00092E D64D A7               4      AND A
00092F D64E C9              10      RET
                                
       D64F                     _SYS1A:     ;(BDOS)DTAの設定
000930 D64F ED538AF0        20      LD  (_DTA),DE
000934 D653 AF               4      XOR A
000935 D654 C9              10      RET
                                
       D655                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000936 D655 7B               4      LD  A,E
000937 D656 CD8BDC          17      CALL    GETDRV
00093A D659 CDDCF0          17      CALL    _GETDPB
00093D D65C D4E2F0          17      CALL    NC,_RDFATX
000940 D65F 210000          10      LD  HL,0
000943 D662 D4A6E0          17      CALL    NC,DSKF
                                
000946 D665 ED5BA7E0        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
00094A D669 1B               6      DEC DE      ;DE←クラスタの総数
00094B D66A FD2A7CF1        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
00094F D66E 9F               4      SBC A,A
000950 D66F D8              11      RET C
000951 D670 4F               4      LD  C,A     ;C=0
000952 D671 DD7E0F          19      LD  A,(IX+DPB_BPS)
000955 D674 E607             7      AND 7
000957 D676 47               4      LD  B,A
000958 D677 DD7E07          19      LD  A,(IX+DPB_SECPCL)
00095B D67A C9              10      RET
                                
       D67B                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
00095C D67B AF               4      XOR A
00095D D67C 67               4      LD  H,A
00095E D67D 6F               4      LD  L,A
00095F D67E C9              10      RET
                                
       D67F                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000960 D67F 2100F2          10      LD  HL,_DEVICE
000963 D682 7B               4      LD  A,E
000964 D683 C3DCF0          10      JP  _GETDPB
                                
       D686                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000967 D686 E5              11      PUSH    HL
000968 D687 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
00096A D689 CD4BD4          17      CALL    BDOS0
00096D D68C 381B            12      JR  C,_S23X1
                                
00096F D68E D5              11      PUSH    DE      ;EX DE,IY
000970 D68F FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000972 D691 FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000975 D694 FD6E11          19      LD  L,(IY+17)   ;
000978 D697 FD6612          19      LD  H,(IY+18)   ;
00097B D69A C5              11      PUSH    BC      ;
00097C D69B FD4613          19      LD  B,(IY+19)   ;
00097F D69E CD0AE1          17      CALL    GET_CPM_R_SIZE
000982 D6A1 C1              10      POP BC
       D6A2                     _S24X1:
000983 D6A2 CD2AE1          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000986 D6A5 FDE3            23      EX  (SP),IY     ;
000988 D6A7 D1              10      POP DE      ;
                                
000989 D6A8 AF               4      XOR A
       D6A9                     _S23X1:
00098A D6A9 E1              10      POP HL
00098B D6AA C9              10      RET
                                
       D6AB                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
00098C D6AB E5              11      PUSH    HL
00098D D6AC D5              11      PUSH    DE      ;EX DE,IY
00098E D6AD FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000990 D6AF CD48E4          17      CALL    GETSEQ
000993 D6B2 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D6B4                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
000995 D6B4 2B               6      DEC HL
       D6B5                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000996 D6B5 C5              11      PUSH    BC
000997 D6B6 E5              11      PUSH    HL
000998 D6B7 CD95DB          17      CALL    FILE
00099B D6BA E1              10      POP HL
00099C D6BB C1              10      POP BC
       D6BC                     S29X1:
00099D D6BC C5              11      PUSH    BC
00099E D6BD D5              11      PUSH    DE
00099F D6BE E5              11      PUSH    HL
0009A0 D6BF EB               4      EX  DE,HL
0009A1 D6C0 AF               4      XOR A
0009A2 D6C1 3221F0          13      LD  (FDRV+13),A
0009A5 D6C4 2114F0          10      LD  HL,FDRV
0009A8 D6C7 011000          10      LD  BC,16
0009AB D6CA EDB0                    LDIR
0009AD D6CC E1              10      POP HL
0009AE D6CD D1              10      POP DE
0009AF D6CE C1              10      POP BC
0009B0 D6CF C9              10      RET
                                
       D6D0                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
0009B1 D6D0 C5              11      PUSH    BC
0009B2 D6D1 018EE7          10      LD  BC,DWT24B
0009B5 D6D4 1804            12      JR  S2FX
       D6D6                     _SYS2F:
0009B7 D6D6 C5              11      PUSH    BC
0009B8 D6D7 0180E7          10      LD  BC,DRD24B
       D6DA                     S2FX:
0009BB D6DA ED43F0D6        20      LD  (S2F_SWC),BC
0009BF D6DE CDDFF0          17      CALL    _FFLUSH
                                
0009C2 D6E1 D5              11      PUSH    DE
0009C3 D6E2 E5              11      PUSH    HL
0009C4 D6E3 7D               4      LD  A,L     ;Drive
0009C5 D6E4 CDD9F0          17      CALL    _CHGDRV
0009C8 D6E7 3809            12      JR  C,POP_HL_DE_BC_SBCAA_RET
0009CA D6E9 44               4      LD  B,H     ;Number of clusters
0009CB D6EA 2A8AF0          16      LD  HL,(_DTA)
                                
0009CE D6ED 0E00             7      LD  C,0
0009D0 D6EF CD80E7          17      CALL    DRD24B
       D6F0                     S2F_SWC EQU $-2
       D6F2                     POP_HL_DE_BC_SBCAA_RET:
0009D3 D6F2 E1              10      POP HL
0009D4 D6F3 D1              10      POP DE
0009D5 D6F4 C1              10      POP BC
0009D6 D6F5 9F               4      SBC A,A
0009D7 D6F6 C9              10      RET
                                
       D6F7                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
0009D8 D6F7 C5              11      PUSH    BC
0009D9 D6F8 D5              11      PUSH    DE
0009DA D6F9 E5              11      PUSH    HL
0009DB D6FA CD8ADB          17      CALL    FILEC
0009DE D6FD 21F2D6          10      LD  HL,POP_HL_DE_BC_SBCAA_RET
0009E1 D700 E5              11      PUSH    HL
0009E2 D701 3A21F0          13      LD  A,(FDRV+13) ;(FCB)属性(アトリビュート))
0009E5 D704 E610             7      AND 010H        ;ディレクトリ
0009E7 D706 37               4      SCF
0009E8 D707 C8              11      RET Z
0009E9 D708 1114F0          10      LD  DE,FDRV
0009EC D70B 2A4EF1          16      LD  HL,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       D70E                     JPHL:
0009EF D70E E9               4      JP  (HL)
                                
       D70F                     SHOW_ERROR:         ;(9)
0009F0 D70F 1179F0          10      LD  DE,COMERM
0009F3 D712 CD7CD4          17      CALL    _SYS09      ;(BDOS)文字列出力
0009F6 D715 C300F0          10      JP  CPM_BOOT
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "M7IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                
       D47A                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D47A                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D47A                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D47A                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D47A                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D47A                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
                                #IF EXISTS USE_8253
                                ARWKEY:
                                    DEC A
                                    LD  (KEYAR),A
                                    JR  INT8253E
                                SETKEY1:
                                    LD  A,(_KEYSP_H)
                                    JR  SETKEY
                                INT8253:
                                    CALL    CHKEY
                                    CP  0
                                KEYDT   EQU $-1
                                    JR  NZ,SETKEY1
                                    PUSH    HL
                                    LD  HL,(_KEYPS)
                                    LD  A,H
                                    XOR L
                                    POP HL
                                    JR  NZ,INT8253E
                                    LD  A,0
                                KEYAR   EQU $-1
                                    OR  A
                                    JR  NZ,ARWKEY
                                SETKEY:
                                    LD  (KEYAR),A
                                    CALL    GETKEYD
                                    LD  (KEYDT),A
                                    CALL    KEYSET
                                INT8253E:
                                    LD  A,0
                                INTMEM_SWC  EQU $-1
                                    CP  0C9H        ;RAMの場合はEXTBIOにRETが入っている
                                    JP  NZ,ROM8253E
                                    POP AF
                                    EI
                                    RET
                                KEYSET:
                                KEYBS:
                                    OR  A
                                    RET Z
                                KEYBS1:
                                    CALL    KEYBC_IFBREAK
                                    PUSH    HL
                                    PUSH    AF
                                    LD  HL,(_KEYPS)
                                    INC L
                                    RES 5,L
                                    LD  A,L
                                    CP  H
                                    JR  Z,POP_AF_HL_SCF_RET
                                    LD  (_KEYPS),A
                                    LD  H,HIGH KEYBF
                                    POP AF
                                    LD  (HL),A
                                    POP HL
                                    RET
                                KEYBC_IFBREAK:
                                    CP  3
                                    RET NZ
                                KEYBC:
                                    PUSH    HL
                                    LD  HL,0
                                    LD  (_KEYPS),HL
                                    POP HL
                                    RET
                                #ENDIF
                                
       D718                     POP_AF_HL_SCF_RET:
0009F9 D718 F1              10      POP AF
0009FA D719 E1              10      POP HL
0009FB D71A 37               4      SCF
                                #IF EXISTS USE_8253
                                #ELSE
       D71B                     KEYBC_IFBREAK:
                                #ENDIF
0009FC D71B C9              10      RET
                                
       D71C                     _SYS01:     ;(BDOS)コンソール入力
0009FD D71C CD09F0          17      CALL    _SYS07
       D71F                     MSG_A:
000A00 D71F F5              11      PUSH    AF
000A01 D720 D5              11      PUSH    DE
000A02 D721 5F               4      LD  E,A
000A03 D722 CD28D7          17      CALL    _SYS02
000A06 D725 D1              10      POP DE
000A07 D726 F1              10      POP AF
000A08 D727 C9              10      RET
                                
       D728                     _SYS02:     ;(BDOS)コンソール出力
000A09 D728 CD3AD7          17      CALL    BREAK
000A0C D72B 1805            12      JR  PRINTX
                                
       D72D                     _SYS06:     ;(BDOS)コンソール直接入出力
000A0E D72D 7B               4      LD  A,E
000A0F D72E 3C               4      INC A
000A10 D72F CACAF0          10      JP  Z,_INKEY
       D732                     PRINTX:
000A13 D732 C3CDF0          10      JP  _PRINT
                                
       D735                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000A16 D735 CD09F0          17      CALL    _SYS07
000A19 D738 1803            12      JR  BREAK1
       D73A                     BREAK:
                                #IF EXISTS USE_8253
                                    EI
                                    LD  A,(_KEYD)
                                #ELSE
000A1B D73A CDF3DA          17      CALL    CHKEY
                                #ENDIF
       D73D                     BREAK1:
000A1E D73D FE03             7      CP  3       ;CTRL+C
000A20 D73F CCF4F0          17      CALL    Z,_BREAK
000A23 D742 FE13             7      CP  013H        ;CTRL+S
000A25 D744 C0              11      RET NZ
                                
       D745                     PAUSE:
                                #IF EXISTS USE_8253
                                    CALL    KEYBC
                                #ENDIF
                                
       D745                     FLGET:
000A26 D745 CDDFF0          17      CALL    _FFLUSH
000A29 D748 E5              11      PUSH    HL
000A2A D749 2A8EF0          16      LD  HL,(_TXADR)
000A2D D74C 7C               4      LD  A,H
000A2E D74D C6D0             7      ADD A,0D0H
000A30 D74F 67               4      LD  H,A
000A31 D750 CD43CF          17      CALL    RDMMIO
000A34 D753 3268D7          13      LD  (FLSMC),A
       D756                     FLGET1:
000A37 D756 CD39CF          17      CALL    RD556VSYNC
000A3A D759 CB77             8      BIT 6,A
000A3C D75B 3EEF             7      LD  A,0EFH      ;カーソル
000A3E D75D 280A            12      JR  Z,FLGET2
000A40 D75F CDAADA          17      CALL    GETKEYD
000A43 D762 B7               4      OR  A
000A44 D763 3EEF             7      LD  A,0EFH      ;カーソル
000A46 D765 2002            12      JR  NZ,FLGET2
000A48 D767 3E00             7      LD  A,0     ;自己書き換え
       D768                     FLSMC   EQU $-1
       D769                     FLGET2:
000A4A D769 CD4BCF          17      CALL    WRMMIO
000A4D D76C CDCAF0          17      CALL    _INKEY
000A50 D76F 28E5            12      JR  Z,FLGET1
000A52 D771 F5              11      PUSH    AF
000A53 D772 3A68D7          13      LD  A,(FLSMC)
000A56 D775 CD4BCF          17      CALL    WRMMIO
000A59 D778 F1              10      POP AF
000A5A D779 E1              10      POP HL
000A5B D77A C9              10      RET
                                
       D77B                     _SYS0A:     ;(BDOS)文字列入力
000A5C D77B C5              11      PUSH    BC
000A5D D77C E5              11      PUSH    HL
000A5E D77D D5              11      PUSH    DE
000A5F D77E CD1DDA          17      CALL    GETL
000A62 D781 1130FF          10      LD  DE,KBUF
000A65 D784 E1              10      POP HL
000A66 D785 E5              11      PUSH    HL
000A67 D786 0E00             7      LD  C,0
000A69 D788 3004            12      JR  NC,SAX0
000A6B D78A 23               6      INC HL
000A6C D78B 23               6      INC HL
000A6D D78C 1808            12      JR  SAX4
       D78E                     SAX0:
000A6F D78E 46               7      LD  B,(HL)
000A70 D78F 23               6      INC HL
       D790                     SAX1:
000A71 D790 23               6      INC HL
000A72 D791 1A               7      LD  A,(DE)
000A73 D792 13               6      INC DE
000A74 D793 B7               4      OR  A
000A75 D794 2004            12      JR  NZ,SAX2
       D796                     SAX4:
000A77 D796 360D            10      LD  (HL),00DH
000A79 D798 1804            12      JR  SAX3
       D79A                     SAX2:
000A7B D79A 77               7      LD  (HL),A
000A7C D79B 0C               4      INC C
000A7D D79C 10F2            13      DJNZ    SAX1
       D79E                     SAX3:
000A7F D79E D1              10      POP DE
000A80 D79F 79               4      LD  A,C
000A81 D7A0 13               6      INC DE
000A82 D7A1 12               7      LD  (DE),A
000A83 D7A2 1B               6      DEC DE
000A84 D7A3 E1              10      POP HL
000A85 D7A4 C1              10      POP BC
000A86 D7A5 A7               4      AND A
000A87 D7A6 C9              10      RET
                                
       D7A7                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000A88 D7A7 CD3AD7          17      CALL    BREAK
000A8B D7AA B7               4      OR  A
000A8C D7AB C8              11      RET Z
                                
       D7AC                     CONSTX:
000A8D D7AC CDDFF0          17      CALL    _FFLUSH
                                #IF EXISTS USE_8253
                                    PUSH    HL
                                    LD  HL,(_KEYPS)
                                    LD  A,H
                                    XOR L
                                    POP HL
                                    ADD A,0FFH
                                #ELSE
000A90 D7AF CDB9DA          17      CALL    INKEY
000A93 D7B2 C8              11      RET Z
000A94 D7B3 AF               4      XOR A
000A95 D7B4 32C1DA          13      LD  (SKIP_KEYWAIT),A
000A98 D7B7 37               4      SCF
                                #ENDIF
000A99 D7B8 9F               4      SBC A,A
000A9A D7B9 C9              10      RET
                                
       D7BA                     _SYS2A:     ;(BDOS)日付の獲得
       D7BA                     _SYS2C:     ;(BDOS)時刻の獲得
000A9B D7BA AF               4      XOR A
000A9C D7BB 57               4      LD  D,A
000A9D D7BC 5F               4      LD  E,A
000A9E D7BD 67               4      LD  H,A
000A9F D7BE 6F               4      LD  L,A
000AA0 D7BF C9              10      RET
                                
       D7C0                     ESC1:
000AA1 D7C0 7B               4      LD  A,E
000AA2 D7C1 FE41             7      CP  'A'
000AA4 D7C3 CAB8D8          10      JP  Z,CTRL1E
000AA7 D7C6 FE42             7      CP  'B'
000AA9 D7C8 CAE0D9          10      JP  Z,CTRL1F
000AAC D7CB FE43             7      CP  'C'
000AAE D7CD CA8BD8          10      JP  Z,CTRL1C
000AB1 D7D0 FE44             7      CP  'D'
000AB3 D7D2 CAAFD8          10      JP  Z,CTRL1D
000AB6 D7D5 FE45             7      CP  'E'
000AB8 D7D7 2802            12      JR  Z,CT0CX
000ABA D7D9 FE6A             7      CP  'j'
       D7DB                     CT0CX:
000ABC D7DB CAC4D9          10      JP  Z,CTRL0C
000ABF D7DE FE48             7      CP  'H'
000AC1 D7E0 CA31D9          10      JP  Z,CTRL0B
000AC4 D7E3 FE4A             7      CP  'J'
000AC6 D7E5 CAC7D9          10      JP  Z,CTRL06
000AC9 D7E8 FE4B             7      CP  'K'
000ACB D7EA CA03D9          10      JP  Z,CTRL05
000ACE D7ED FE4C             7      CP  'L'
000AD0 D7EF CAF2D9          10      JP  Z,CTRL0E
000AD3 D7F2 FE54             7      CP  'T'
000AD5 D7F4 CA03D9          10      JP  Z,CTRL05
000AD8 D7F7 FE78             7      CP  'x'
000ADA D7F9 2804            12      JR  Z,ESC1X
000ADC D7FB FE79             7      CP  'y'
000ADE D7FD 2002            12      JR  NZ,ESC1Y
       D7FF                     ESC1X:
000AE0 D7FF 3601            10      LD  (HL),1
       D801                     ESC1Y:
000AE2 D801 FE3D             7      CP  '='
000AE4 D803 2804            12      JR  Z,ESC1W
000AE6 D805 FE59             7      CP  'Y'
000AE8 D807 2002            12      JR  NZ,ESC1Z
       D809                     ESC1W:
000AEA D809 3602            10      LD  (HL),2
       D80B                     ESC1Z:
000AEC D80B FE20             7      CP  020H
000AEE D80D 3802            12      JR  C,ESC1C
000AF0 D80F 87               4      ADD A,A
000AF1 D810 D0              11      RET NC
       D811                     ESC1C:
000AF2 D811 E1              10      POP HL
000AF3 D812 1832            12      JR  ANK
                                
       D814                     ESC:
000AF5 D814 2177D8          10      LD  HL,PRINTE5
000AF8 D817 E5              11      PUSH    HL
000AF9 D818 213AD8          10      LD  HL,ESCFLG
000AFC D81B 3600            10      LD  (HL),0
000AFE D81D 3D               4      DEC A
000AFF D81E 28A0            12      JR  Z,ESC1
000B01 D820 3D               4      DEC A
000B02 D821 2009            12      JR  NZ,ESC2
000B04 D823 3603            10      LD  (HL),3
000B06 D825 7B               4      LD  A,E
000B07 D826 D620             7      SUB 020H
000B09 D828 322FD8          13      LD  (ESCYP+1),A
000B0C D82B C9              10      RET
       D82C                     ESC2:
000B0D D82C 3D               4      DEC A
000B0E D82D C0              11      RET NZ
000B0F D82E 2600             7  ESCYP:  LD  H,0
000B11 D830 7B               4      LD  A,E
000B12 D831 D620             7      SUB 020H
000B14 D833 6F               4      LD  L,A
000B15 D834 C3D6F0          10      JP  _LOC
                                
       D837                     PRINT:
000B18 D837 C5              11      PUSH    BC
000B19 D838 E5              11      PUSH    HL
000B1A D839 3E00             7      LD  A,000H      ;自己書き換え
       D83A                     ESCFLG  EQU $-1
000B1C D83B B7               4      OR  A
000B1D D83C 20D6            12      JR  NZ,ESC
                                
000B1F D83E 3E1F             7      LD  A,01FH
000B21 D840 BB               4      CP  E
000B22 D841 3038            12      JR  NC,CTRL
       D843                     INSFLG  EQU $
000B24 D843 018DD9          10      LD  BC,INSERT   ;自己書き換え
       D846                     ANK:
000B27 D846 3A96F0          13      LD  A,(_COLORF)
000B2A D849 4F               4      LD  C,A
000B2B D84A 7B               4      LD  A,E
000B2C D84B FE61             7      CP  'a'     ;英小文字
000B2E D84D 3806            12      JR  C,PRT1
000B30 D84F FE7B             7      CP  'z'+1
000B32 D851 3002            12      JR  NC,PRT1
000B34 D853 CBF9             8      SET 7,C
       D855                     PRT1:
000B36 D855 FE86             7      CP  $86     ;ひらがな1(を－そ)
000B38 D857 3806            12      JR  C,PRT2
000B3A D859 FEA0             7      CP  $A0
000B3C D85B 3002            12      JR  NC,PRT2
000B3E D85D CBF9             8      SET 7,C
       D85F                     PRT2:
000B40 D85F FEE0             7      CP  $E0     ;ひらがな2(たーん)
000B42 D861 3802            12      JR  C,PRT3
000B44 D863 CBF9             8      SET 7,C
       D865                     PRT3:
000B46 D865 2A8EF0          16      LD  HL,(_TXADR)
000B49 D868 7C               4      LD  A,H
000B4A D869 C6D0             7      ADD A,0D0H
000B4C D86B 67               4      LD  H,A
000B4D D86C 42               4      LD  B,D
000B4E D86D 16EE             7      LD  D,HIGH CD_TABLE
000B50 D86F 1A               7      LD  A,(DE)
000B51 D870 50               4      LD  D,B
000B52 D871 CD63CF          17      CALL    IO_PRINT
000B55 D874 CD8BD8          17      CALL    CTRL1C
       D877                     PRINTE5:
000B58 D877 E1              10      POP HL
000B59 D878 C1              10      POP BC
000B5A D879 AF               4      XOR A
000B5B D87A C9              10      RET
                                
       D87B                     CTRL:
000B5C D87B 7B               4      LD  A,E
000B5D D87C 87               4      ADD A,A
000B5E D87D F680             7      OR  080H
000B60 D87F 6F               4      LD  L,A
000B61 D880 26F1             7      LD  H,HIGH CTRLTB
000B63 D882 7E               7      LD  A,(HL)
000B64 D883 2C               4      INC L
000B65 D884 66               7      LD  H,(HL)
000B66 D885 6F               4      LD  L,A
000B67 D886 CD0ED7          17      CALL    JPHL
000B6A D889 18EC            12      JR  PRINTE5
                                
       D88B                     CTRL1C:
000B6C D88B ED4B8EF0        20      LD  BC,(_TXADR)
000B70 D88F 03               6      INC BC
       D890                     PRINTE3:
000B71 D890 2ABAF0          16      LD  HL,(_PAGE_MINUS)
000B74 D893 A7               4      AND A
000B75 D894 ED4A            15      ADC HL,BC
       D896                     PRINTE8:
000B77 D896 2805            12      JR  Z,PRINT2
000B79 D898 ED438EF0        20      LD  (_TXADR),BC
       D89C                     CTRL00:
000B7D D89C C9              10      RET
                                
       D89D                     PRINT2:
000B7E D89D CDF8D9          17      CALL    SCR
000B81 D8A0 21D8FF          10      LD  HL,0-WIDTH
000B84 D8A3 09              11      ADD HL,BC
       D8A4                     SET_TXADR_HL:
000B85 D8A4 228EF0          16      LD  (_TXADR),HL
000B88 D8A7 C9              10      RET
                                
       D8A8                     CTRL08:
000B89 D8A8 3A43D8          13      LD  A,(INSFLG)
000B8C D8AB FECD             7      CP  0CDH        ;CALL ????
000B8E D8AD 2823            12      JR  Z,CTRL02
       D8AF                     CTRL1D:
000B90 D8AF 2A8EF0          16      LD  HL,(_TXADR)
000B93 D8B2 7C               4      LD  A,H
000B94 D8B3 B5               4      OR  L
000B95 D8B4 C8              11      RET Z
000B96 D8B5 2B               6      DEC HL
000B97 D8B6 18EC            12      JR  SET_TXADR_HL
                                
       D8B8                     CTRL1E:
000B99 D8B8 ED4B8EF0        20      LD  BC,(_TXADR)
000B9D D8BC 21D8FF          10      LD  HL,0-WIDTH
000BA0 D8BF 09              11      ADD HL,BC
000BA1 D8C0 D0              11      RET NC
000BA2 D8C1 18E1            12      JR  SET_TXADR_HL
                                
       D8C3                     CTRL09:
000BA4 D8C3 ED4B8EF0        20      LD  BC,(_TXADR)
000BA8 D8C7 79               4      LD  A,C
000BA9 D8C8 E6F8             7      AND 0F8H
000BAB D8CA C608             7      ADD A,8
000BAD D8CC 4F               4      LD  C,A
000BAE D8CD 88               4      ADC A,B
000BAF D8CE 91               4      SUB C
000BB0 D8CF 47               4      LD  B,A
000BB1 D8D0 18BE            12      JR  PRINTE3
                                
       D8D2                     CTRL02:
000BB3 D8D2 CDAFD8          17      CALL    CTRL1D
000BB6 D8D5 C8              11      RET Z
000BB7 D8D6 D5              11      PUSH    DE
000BB8 D8D7 CDD3F0          17      CALL    _POS
000BBB D8DA 54               4      LD  D,H
000BBC D8DB 3E28             7      LD  A,WIDTH
000BBE D8DD 95               4      SUB L
000BBF D8DE 4F               4      LD  C,A
000BC0 D8DF 0D               4      DEC C
000BC1 D8E0 06D0             7      LD  B,0D0H
000BC3 D8E2 2A8EF0          16      LD  HL,(_TXADR)
000BC6 D8E5 09              11      ADD HL,BC
000BC7 D8E6 47               4      LD  B,A
                                
000BC8 D8E7 3AAED9          13      LD  A,(MULINE)
000BCB D8EA BA               4      CP  D
000BCC D8EB 2007            12      JR  NZ,C02X1
000BCE D8ED 112800          10      LD  DE,WIDTH
000BD1 D8F0 19              11      ADD HL,DE
000BD2 D8F1 78               4      LD  A,B
000BD3 D8F2 83               4      ADD A,E
000BD4 D8F3 47               4      LD  B,A
       D8F4                     C02X1:
000BD5 D8F4 3A96F0          13      LD  A,(_COLORF) ;C:Color
000BD8 D8F7 4F               4      LD  C,A
000BD9 D8F8 3E                      DB  03EH        ;LD A,?
000BDA D8F9 2B               6      DEC HL
000BDB D8FA 328BCF          13      LD  (IO_INCDEC),A
000BDE D8FD AF               4      XOR A       ;A:Text
000BDF D8FE CD7ECF          17      CALL    IO_INSBS
000BE2 D901 D1              10      POP DE
000BE3 D902 C9              10      RET
                                
       D903                     CTRL05:
000BE4 D903 CDD3F0          17      CALL    _POS
000BE7 D906 3E28             7      LD  A,WIDTH
000BE9 D908 95               4      SUB L
000BEA D909 47               4      LD  B,A
       D90A                     C08X1:
000BEB D90A 2A8EF0          16      LD  HL,(_TXADR)
000BEE D90D 7C               4      LD  A,H
000BEF D90E C6D0             7      ADD A,0D0H
000BF1 D910 67               4      LD  H,A
       D911                     CLLINE:
000BF2 D911 3A96F0          13      LD  A,(_COLORF)
000BF5 D914 4F               4      LD  C,A
000BF6 D915 AF               4      XOR A
000BF7 D916 C36ECF          10      JP  IO_CLLINE
                                
       D919                     CTRL0D:
000BFA D919 CDD3F0          17      CALL    _POS
000BFD D91C 2E00             7      LD  L,0
       D91E                     LOC:
000BFF D91E C5              11      PUSH    BC
000C00 D91F E5              11      PUSH    HL
000C01 D920 CD3ED9          17      CALL    LOC1
000C04 D923 228EF0          16      LD  (_TXADR),HL
000C07 D926 E1              10      POP HL
000C08 D927 C1              10      POP BC
000C09 D928 C9              10      RET
                                
       D929                     CTRL12:
000C0A D929 2143D8          10      LD  HL,INSFLG
000C0D D92C 7E               7      LD  A,(HL)
000C0E D92D EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
000C10 D92F 77               7      LD  (HL),A
000C11 D930 C9              10      RET
                                
       D931                     CTRL0B:
000C12 D931 210000          10      LD  HL,0
000C15 D934 228EF0          16      LD  (_TXADR),HL
000C18 D937 C9              10      RET
                                
       D938                     CTRL1B:
000C19 D938 3E01             7      LD  A,1
000C1B D93A 323AD8          13      LD  (ESCFLG),A
000C1E D93D C9              10      RET
                                
       D93E                     LOC1:
000C1F D93E D5              11      PUSH    DE
000C20 D93F 4D               4      LD  C,L
000C21 D940 0608             7      LD  B,8
000C23 D942 5C               4      LD  E,H
000C24 D943 210028          10      LD  HL,WIDTH*256
000C27 D946 55               4      LD  D,L ;L=0
       D947                     LOC2:
000C28 D947 29              11      ADD HL,HL
000C29 D948 3001            12      JR  NC,LOC3
000C2B D94A 19              11      ADD HL,DE
       D94B                     LOC3:
000C2C D94B 10FA            13      DJNZ    LOC2
000C2E D94D 09              11      ADD HL,BC
000C2F D94E D1              10      POP DE
000C30 D94F C9              10      RET
                                
       D950                     CONOUT1:
                                ;   CALL    CURSOR
000C31 D950 59               4      LD  E,C
000C32 D951 CDCDF0          17      CALL    _PRINT
000C35 D954 7B               4      LD  A,E
000C36 D955 FE0A             7      CP  00AH
000C38 D957 2006            12      JR  NZ,CURSOR
000C3A D959 CD19D9          17      CALL    CTRL0D
000C3D D95C CD03D9          17      CALL    CTRL05
       D95F                     CURSOR:
000C40 D95F C9              10      RET
                                
       D960                     CTRL07:
000C41 D960 06E0             7      LD  B,0E0H
000C43 D962 2162F0          10      LD  HL,BEEPD+1
       D965                     C07X0:
000C46 D965 4E               7      LD  C,(HL)
000C47 D966 23               6      INC HL
000C48 D967 7E               7      LD  A,(HL)
000C49 D968 23               6      INC HL
000C4A D969 CD5BCF          17      CALL    WRMMIO_BC
000C4D D96C 7D               4      LD  A,L
000C4E D96D FE6C             7      CP  (BEEPD+1+M7BEEPE-M7BEEPD)&255
000C50 D96F 20F4            12      JR  NZ,C07X0
000C52 D971 0610             7      LD  B,16
       D973                     C07X1:
000C54 D973 CD39CF          17      CALL    RD556VSYNC
000C57 D976 87               4      ADD A,A
000C58 D977 30FA            12      JR  NC,C07X1
       D979                     C07X2:
000C5A D979 CD39CF          17      CALL    RD556VSYNC
000C5D D97C 87               4      ADD A,A
000C5E D97D 38FA            12      JR  C,C07X2
000C60 D97F 10F2            13      DJNZ    C07X1
                                
000C62 D981 AF               4      XOR A
000C63 D982 2108E0          10      LD  HL,0E008H
000C66 D985 CD4BCF          17      CALL    WRMMIO
000C69 D988 2E03             7      LD  L,003H      ;SOUND MASK (MZ-1500)
000C6B D98A C34BCF          10      JP  WRMMIO
                                
       D98D                     INSERT:
000C6E D98D D5              11      PUSH    DE
000C6F D98E CDD3F0          17      CALL    _POS
000C72 D991 54               4      LD  D,H
000C73 D992 3E28             7      LD  A,WIDTH
000C75 D994 95               4      SUB L
000C76 D995 47               4      LD  B,A
000C77 D996 2A8EF0          16      LD  HL,(_TXADR)
000C7A D999 7C               4      LD  A,H
000C7B D99A C6D0             7      ADD A,0D0H
000C7D D99C 67               4      LD  H,A
000C7E D99D 3A96F0          13      LD  A,(_COLORF) ;C:Color
000C81 D9A0 4F               4      LD  C,A
000C82 D9A1 3E                      DB  03EH        ;LD A,?
000C83 D9A2 23               6      INC HL
000C84 D9A3 328BCF          13      LD  (IO_INCDEC),A
000C87 D9A6 AF               4      XOR A       ;A:Text
000C88 D9A7 CD7ECF          17      CALL    IO_INSBS
000C8B D9AA B7               4      OR  A
000C8C D9AB 2005            12      JR  NZ,INS1
       D9AE                     MULINE  EQU $+1
000C8E D9AD 3EFF             7      LD  A,-1
000C90 D9AF 92               4      SUB D
000C91 D9B0 2010            12      JR  NZ,INS2
       D9B2                     INS1:
000C93 D9B2 0628             7      LD  B,WIDTH
000C95 D9B4 F5              11      PUSH    AF
000C96 D9B5 3E                      DB  03EH        ;LD A,?
000C97 D9B6 23               6      INC HL
000C98 D9B7 328BCF          13      LD  (IO_INCDEC),A
000C9B D9BA F1              10      POP AF
000C9C D9BB CD7ECF          17      CALL    IO_INSBS
000C9F D9BE 7A               4      LD  A,D
000CA0 D9BF 32AED9          13      LD  (MULINE),A
       D9C2                     INS2:
000CA3 D9C2 D1              10      POP DE
000CA4 D9C3 C9              10      RET
                                
       D9C4                     CTRL0C:
000CA5 D9C4 CD31D9          17      CALL    CTRL0B
       D9C7                     CTRL06:
000CA8 D9C7 D5              11      PUSH    DE
000CA9 D9C8 E5              11      PUSH    HL
000CAA D9C9 ED5B8EF0        20      LD  DE,(_TXADR)
000CAE D9CD 3A96F0          13      LD  A,(_COLORF)
000CB1 D9D0 3219CF          13      LD  (ICSMC),A
000CB4 D9D3 F3               4      DI
000CB5 D9D4 C30ECF          10      JP  IO_CLR
                                
       D9D7                     CTRL04:
000CB8 D9D7 CDD3F0          17      CALL    _POS
000CBB D9DA 7D               4      LD  A,L
000CBC D9DB B7               4      OR  A
000CBD D9DC C8              11      RET Z
       D9DD                     CTRL03:
000CBE D9DD CD19D9          17      CALL    CTRL0D
       D9E0                     CTRL0A:
       D9E0                     CTRL1F:
000CC1 D9E0 2A8EF0          16      LD  HL,(_TXADR)
000CC4 D9E3 012800          10      LD  BC,WIDTH
000CC7 D9E6 09              11      ADD HL,BC
000CC8 D9E7 44               4      LD  B,H
000CC9 D9E8 4D               4      LD  C,L
000CCA D9E9 2ABAF0          16      LD  HL,(_PAGE_MINUS)
000CCD D9EC 09              11      ADD HL,BC
000CCE D9ED 3F               4      CCF
000CCF D9EE 9F               4      SBC A,A
000CD0 D9EF C396D8          10      JP  PRINTE8
                                
       D9F2                     CTRL0E:
000CD3 D9F2 CDD3F0          17      CALL    _POS
000CD6 D9F5 7C               4      LD  A,H
000CD7 D9F6 1804            12      JR  SCR1
       D9F8                     SCR:
000CD9 D9F8 3A97F0          13      LD  A,(_LINE)
000CDC D9FB 3D               4      DEC A
       D9FC                     SCR1:
000CDD D9FC C5              11      PUSH    BC
000CDE D9FD D5              11      PUSH    DE
000CDF D9FE E5              11      PUSH    HL
000CE0 D9FF 1100D0          10      LD  DE,0D000H
000CE3 DA02 2128D0          10      LD  HL,0D000H+WIDTH
                                
000CE6 DA05 47               4      LD  B,A
000CE7 DA06 B7               4      OR  A
000CE8 DA07 C392CF          10      JP  IO_SCRUP
                                
       DA0A                     POS:
000CEB DA0A 2A8EF0          16      LD  HL,(_TXADR)
000CEE DA0D C5              11      PUSH    BC
000CEF DA0E 01D8FF          10      LD  BC,0-WIDTH
000CF2 DA11 AF               4      XOR A
       DA12                     POS1:
000CF3 DA12 09              11      ADD HL,BC
000CF4 DA13 3C               4      INC A
000CF5 DA14 38FC            12      JR  C,POS1
000CF7 DA16 ED42            15      SBC HL,BC
000CF9 DA18 3D               4      DEC A
000CFA DA19 67               4      LD  H,A
000CFB DA1A C1              10      POP BC
000CFC DA1B A7               4      AND A
000CFD DA1C C9              10      RET
                                
       DA1D                     GETL:
000CFE DA1D CDD3F0          17      CALL    _POS
000D01 DA20 E5              11      PUSH    HL
000D02 DA21 3ECD             7      LD  A,0CDH      ;CALL ????
000D04 DA23 3243D8          13      LD  (INSFLG),A
       DA26                     GETL1:
000D07 DA26 CD35D7          17      CALL    _SYS08
000D0A DA29 FE09             7      CP  9
000D0C DA2B 2008            12      JR  NZ,GETL1V
000D0E DA2D 2130FF          10      LD  HL,KBUF
000D11 DA30 CD8BD4          17      CALL    MSX
000D14 DA33 18F1            12      JR  GETL1
       DA35                     GETL1V:
000D16 DA35 5F               4      LD  E,A
000D17 DA36 CDD3F0          17      CALL    _POS
000D1A DA39 CDCDF0          17      CALL    _PRINT
000D1D DA3C 7B               4      LD  A,E
000D1E DA3D FE20             7      CP  $20
000D20 DA3F 3809            12      JR  C,GETL1V1
000D22 DA41 7D               4      LD  A,L
000D23 DA42 FE27             7      CP  WIDTH-1
000D25 DA44 2004            12      JR  NZ,GETL1V1
000D27 DA46 7C               4      LD  A,H
000D28 DA47 32AED9          13      LD  (MULINE),A
       DA4A                     GETL1V1:
000D2B DA4A 7B               4      LD  A,E
000D2C DA4B FE0D             7      CP  00DH
000D2E DA4D 20D7            12      JR  NZ,GETL1
000D30 DA4F 3E01             7      LD  A,1     ;LD BC,????
000D32 DA51 3243D8          13      LD  (INSFLG),A
000D35 DA54 1130FF          10      LD  DE,KBUF
000D38 DA57 0628             7      LD  B,WIDTH
000D3A DA59 CD29D3          17      CALL    ZERO_MEMORY_DE
                                
000D3D DA5C D1              10      POP DE
000D3E DA5D CDD3F0          17      CALL    _POS
000D41 DA60 6B               4      LD  L,E
000D42 DA61 3E28             7      LD  A,WIDTH
000D44 DA63 95               4      SUB L
000D45 DA64 57               4      LD  D,A
                                
000D46 DA65 3AAED9          13      LD  A,(MULINE)
000D49 DA68 94               4      SUB H
000D4A DA69 280A            12      JR  Z,GL2X
000D4C DA6B 3C               4      INC A
000D4D DA6C 2010            12      JR  NZ,GL3X
000D4F DA6E 7C               4      LD  A,H
000D50 DA6F B7               4      OR  A
000D51 DA70 280C            12      JR  Z,GL3X
000D53 DA72 25               4      DEC H
000D54 DA73 1805            12      JR  GL4X
       DA75                     GL2X:
000D56 DA75 3E1F             7      LD  A,$1F
000D58 DA77 CD1FD7          17      CALL    MSG_A
       DA7A                     GL4X:
000D5B DA7A 7A               4      LD  A,D
000D5C DA7B C628             7      ADD A,WIDTH
000D5E DA7D 57               4      LD  D,A
       DA7E                     GL3X:
000D5F DA7E CD3ED9          17      CALL    LOC1
000D62 DA81 4D               4      LD  C,L
000D63 DA82 7C               4      LD  A,H
000D64 DA83 C6D0             7      ADD A,0D0H
000D66 DA85 47               4      LD  B,A
000D67 DA86 5A               4      LD  E,D
000D68 DA87 2130FF          10      LD  HL,KBUF
       DA8A                     GETL2:
000D6B DA8A CDD0F0          17      CALL    _SCRN
000D6E DA8D 03               6      INC BC
000D6F DA8E 77               7      LD  (HL),A
000D70 DA8F 23               6      INC HL
000D71 DA90 1D               4      DEC E
000D72 DA91 20F7            12      JR  NZ,GETL2
       DA93                     GETL3:
000D74 DA93 2B               6      DEC HL
000D75 DA94 7E               7      LD  A,(HL)
000D76 DA95 FE21             7      CP  021H
000D78 DA97 D0              11      RET NC
000D79 DA98 3600            10      LD  (HL),0
000D7B DA9A 15               4      DEC D
000D7C DA9B 20F6            12      JR  NZ,GETL3
000D7E DA9D C9              10      RET
                                
       DA9E                     INKEYB:
000D7F DA9E C1              10      POP BC
000D80 DA9F CB47             8      BIT 0,A
000D82 DAA1 3E08             7      LD  A,8
000D84 DAA3 2002            12      JR  NZ,SETKEYD
000D86 DAA5 3E03             7      LD  A,3
       DAA7                     SETKEYD:
000D88 DAA7 3292F0          13      LD  (_KEYD),A
       DAAA                     GETKEYD:
000D8B DAAA 3A92F0          13      LD  A,(_KEYD)
000D8E DAAD B7               4      OR  A
       DAAE                     GETKEYD_SWC:            ;ここがSCFの場合はキーを離すまで戻り値は0になる（自己書き換え）
000D8F DAAE A7               4      AND A
000D90 DAAF D0              11      RET NC
000D91 DAB0 2005            12      JR  NZ,GETKEYD1
000D93 DAB2 3E                      DB  03EH
000D94 DAB3 A7               4      AND A
000D95 DAB4 32AEDA          13      LD  (GETKEYD_SWC),A
       DAB7                     GETKEYD1:
000D98 DAB7 AF               4      XOR A
000D99 DAB8 C9              10      RET
                                
       DAB9                     INKEY:
                                #IF EXISTS USE_8253
                                    EI
                                    PUSH    HL
                                    LD  HL,(_KEYPS)
                                    LD  A,H
                                    XOR L
                                    JR  Z,INKEY1
                                    LD  A,H
                                    INC A
                                    AND 01FH
                                    LD  (_KEYPS+1),A
                                    LD  L,A
                                    LD  H,HIGH KEYBF
                                    LD  A,(HL)
                                INKEY1:
                                    POP HL
                                    OR  A
                                    RET
                                #ELSE
000D9A DAB9 E5              11      PUSH    HL
       DABA                     GETKEY:
000D9B DABA CDAADA          17      CALL    GETKEYD
000D9E DABD 6F               4      LD  L,A
000D9F DABE 2610             7      LD  H,16
       DABF                     GKSMC   EQU $-1
       DAC0                     GETKEY1:
000DA1 DAC0 3E01             7      LD  A,1
       DAC1                     SKIP_KEYWAIT:   EQU $-1
000DA3 DAC2 B7               4      OR  A
000DA4 DAC3 C4F3DA          17      CALL    NZ,CHKEY    ;キーを離すまで待つ
000DA7 DAC6 281E            12      JR  Z,GETKEY2
000DA9 DAC8 BD               4      CP  L
000DAA DAC9 201B            12      JR  NZ,GETKEY2
000DAC DACB CD39CF          17      CALL    RD556VSYNC
000DAF DACE 87               4      ADD A,A
000DB0 DACF 30EF            12      JR  NC,GETKEY1
       DAD1                     GETKEY1X:
000DB2 DAD1 CDF3DA          17      CALL    CHKEY       ;キーを離すまで待つ
000DB5 DAD4 2810            12      JR  Z,GETKEY2
000DB7 DAD6 BD               4      CP  L
000DB8 DAD7 200D            12      JR  NZ,GETKEY2
000DBA DAD9 CD39CF          17      CALL    RD556VSYNC
000DBD DADC 87               4      ADD A,A
000DBE DADD 38F2            12      JR  C,GETKEY1X
000DC0 DADF 25               4      DEC H
000DC1 DAE0 20DE            12      JR  NZ,GETKEY1
000DC3 DAE2 3E01             7      LD  A,1
000DC5 DAE4 1805            12      JR  GETKEY3
       DAE6                     GETKEY2:
000DC7 DAE6 3E10             7      LD  A,16
000DC9 DAE8 32C1DA          13      LD  (SKIP_KEYWAIT),A
       DAEB                     GETKEY3:
000DCC DAEB 32BFDA          13      LD  (GKSMC),A
000DCF DAEE CDAADA          17      CALL    GETKEYD
000DD2 DAF1 E1              10      POP HL
000DD3 DAF2 C9              10      RET
                                #ENDIF
       DAF3                     CHKEY:
000DD4 DAF3 C5              11      PUSH    BC
000DD5 DAF4 3E88             7      LD  A,$88
000DD7 DAF6 CD2CCF          17      CALL    RDKEYDATA
000DDA DAF9 4F               4      LD  C,A
000DDB DAFA 3A93F0          13      LD  A,(_KEYST)
000DDE DAFD B9               4      CP  C
000DDF DAFE 79               4      LD  A,C
000DE0 DAFF 3293F0          13      LD  (_KEYST),A
000DE3 DB02 280F            12      JR  Z,KEYST2
000DE5 DB04 CDAADA          17      CALL    GETKEYD
000DE8 DB07 2809            12      JR  Z,KEYST1
000DEA DB09 AF               4      XOR A
000DEB DB0A 3292F0          13      LD  (_KEYD),A
000DEE DB0D 3E                      DB  03EH
000DEF DB0E 37               4      SCF
000DF0 DB0F 32AEDA          13      LD  (GETKEYD_SWC),A
       DB12                     KEYST1:
000DF3 DB12 79               4      LD  A,C
       DB13                     KEYST2:
000DF4 DB13 CB7F             8      BIT 7,A
000DF6 DB15 2887            12      JR  Z,INKEYB
000DF8 DB17 E5              11      PUSH    HL
000DF9 DB18 0E87             7      LD  C,$87
000DFB DB1A 2140ED          10      LD  HL,KEY_TABLE
000DFE DB1D CB47             8      BIT 0,A
000E00 DB1F 2003            12      JR  NZ,CHKEY0
000E02 DB21 2180ED          10      LD  HL,SHIFT_TABLE
       DB24                     CHKEY0:
000E05 DB24 CB77             8      BIT 6,A
000E07 DB26 2003            12      JR  NZ,CHKEY1
000E09 DB28 21C0ED          10      LD  HL,CTRL_TABLE
       DB2B                     CHKEY1:
000E0C DB2B 79               4      LD  A,C
000E0D DB2C CD2CCF          17      CALL    RDKEYDATA
000E10 DB2F 0608             7      LD  B,8
       DB31                     CHKEY2:
000E12 DB31 87               4      ADD A,A
000E13 DB32 300A            12      JR  NC,CHKEY3
000E15 DB34 23               6      INC HL
000E16 DB35 10FA            13      DJNZ    CHKEY2
000E18 DB37 0D               4      DEC C
000E19 DB38 CB79             8      BIT 7,C
000E1B DB3A 20EF            12      JR  NZ,CHKEY1
000E1D DB3C AF               4      XOR A
000E1E DB3D 06                      DB  $06     ;LD B,?? 次の1バイトを飛ばす
       DB3E                     CHKEY3:
000E1F DB3E 7E               7      LD  A,(HL)
000E20 DB3F E1              10      POP HL
000E21 DB40 C1              10      POP BC
000E22 DB41 C3A7DA          10      JP  SETKEYD
                                
       DB44                     SCRN:
000E25 DB44 E5              11      PUSH    HL
000E26 DB45 CD53CF          17      CALL    RDMMIO_BC
000E29 DB48 6F               4      LD  L,A
000E2A DB49 26EF             7      LD  H,HIGH DC_TABLE
000E2C DB4B 7E               7      LD  A,(HL)
000E2D DB4C FE41             7      CP  'A'     ;英小文字チェック
000E2F DB4E 380E            12      JR  C,SCRN1
000E31 DB50 FE5B             7      CP  'Z'+1
000E33 DB52 DC60DB          17      CALL    C,SCRNC
000E36 DB55 FEA6             7      CP  $A6     ;ひらがなチェック
000E38 DB57 3805            12      JR  C,SCRN1
000E3A DB59 FEE0             7      CP  $E0
000E3C DB5B DC60DB          17      CALL    C,SCRNC
       DB5E                     SCRN1:
000E3F DB5E E1              10      POP HL
000E40 DB5F C9              10      RET
                                
       DB60                     SCRNC:
000E41 DB60 6F               4      LD  L,A
000E42 DB61 60               4      LD  H,B
000E43 DB62 CBD8             8      SET 3,B
000E45 DB64 CD53CF          17      CALL    RDMMIO_BC
000E48 DB67 44               4      LD  B,H
000E49 DB68 CB7F             8      BIT 7,A
000E4B DB6A 7D               4      LD  A,L
000E4C DB6B C8              11      RET Z
000E4D DB6C FE5B             7      CP  'Z'+1
000E4F DB6E 3804            12      JR  C,SCRNC_ADD
000E51 DB70 FEC0             7      CP  $C0
000E53 DB72 3803            12      JR  C,SCRNC_SUB
       DB74                     SCRNC_ADD:
000E55 DB74 C620             7      ADD A,$20
000E57 DB76 C9              10      RET
       DB77                     SCRNC_SUB:
000E58 DB77 D620             7      SUB $20
000E5A DB79 C9              10      RET
       DB7A                     C_MON:
000E5B DB7A 2100D8          10      LD  HL,0D800H
       DB7D                     MON1:
000E5E DB7D 3E71             7      LD  A,071H
000E60 DB7F CD4BCF          17      CALL    WRMMIO
000E63 DB82 23               6      INC HL
000E64 DB83 CB54             8      BIT 2,H
000E66 DB85 28F6            12      JR  Z,MON1
000E68 DB87 C3C6CF          10      JP  IO_MON
[EOF:M7IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
                                ;   【注意】バイナリサイズを下位1バイトを0丁度に調整する必要あり(X1/88)
       0000                     CHECK_FILE_SIZE EQU (FILEC-FILE_E) & 0FFH
       DB8A                     FILEC:
000E6B DB8A CD95DB          17      CALL    FILE
       DB8D                     FILEC2:
000E6E DB8D 3A15F0          13      LD  A,(FDRV+1)
000E71 DB90 FE20             7      CP  020H
000E73 DB92 C8              11      RET Z
000E74 DB93 1839            12      JR  SETDIR1
                                
       DB95                     FILE:
000E76 DB95 AF               4      XOR A
000E77 DB96 3214F0          13      LD  (FDRV),A
000E7A DB99 67               4      LD  H,A
000E7B DB9A 6F               4      LD  L,A
000E7C DB9B 2222F0          16      LD  (FDRV+14),HL
000E7F DB9E CD6BDC          17      CALL    SPCUT
000E82 DBA1 CD50DC          17      CALL    CCHK3
000E85 DBA4 2812            12      JR  Z,DEVI1
000E87 DBA6 13               6      INC DE
000E88 DBA7 1A               7      LD  A,(DE)
000E89 DBA8 1B               6      DEC DE
000E8A DBA9 FE3A             7      CP  ':'
000E8C DBAB 200B            12      JR  NZ,DEVI1
000E8E DBAD 1A               7      LD  A,(DE)      ;DRIVE
000E8F DBAE CDB1DE          17      CALL    CAP
000E92 DBB1 D640             7      SUB '@'
000E94 DBB3 13               6      INC DE
000E95 DBB4 13               6      INC DE
000E96 DBB5 3214F0          13      LD  (FDRV),A
       DBB8                     DEVI1:
000E99 DBB8 1A               7      LD  A,(DE)
000E9A DBB9 D65C             7      SUB 05CH        ;\
000E9C DBBB 2009            12      JR  NZ,NOROOT
000E9E DBBD 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
000E9F DBBE 222EF0          16      LD  (FDRV+26),HL
000EA2 DBC1 2C               4      INC L
000EA3 DBC2 2222F0          16      LD  (FDRV+14),HL
000EA6 DBC5 13               6      INC DE
       DBC6                     NOROOT:
                                
       DBC6                     SETDIR:
000EA7 DBC6 CDF1DB          17      CALL    FILED
000EAA DBC9 1A               7      LD  A,(DE)
000EAB DBCA FE5C             7      CP  05CH        ;\
000EAD DBCC C0              11      RET NZ
000EAE DBCD 13               6      INC DE
       DBCE                     SETDIR1:
000EAF DBCE 3E10             7      LD  A,010H      ;Directory
000EB1 DBD0 3221F0          13      LD  (FDRV+13),A
000EB4 DBD3 D5              11      PUSH    DE
000EB5 DBD4 1114F0          10      LD  DE,FDRV
000EB8 DBD7 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
000EBA DBD9 CD4BD4          17      CALL    BDOS0
000EBD DBDC D1              10      POP DE
000EBE DBDD B7               4      OR  A
000EBF DBDE C0              11      RET NZ
                                
000EC0 DBDF 3A21F0          13      LD  A,(FDRV+13)
000EC3 DBE2 E610             7      AND 010H        ;ディレクトリ
000EC5 DBE4 C8              11      RET Z
                                
000EC6 DBE5 CD38DC          17      CALL    FILEI
000EC9 DBE8 2A2EF0          16      LD  HL,(FDRV+26)
000ECC DBEB 23               6      INC HL
000ECD DBEC 2222F0          16      LD  (FDRV+14),HL
000ED0 DBEF 18D5            12      JR  SETDIR
                                
       DBF1                     FILED:
000ED2 DBF1 CD38DC          17      CALL    FILEI
000ED5 DBF4 2115F0          10      LD  HL,FNAME
                                
000ED8 DBF7 0608             7      LD  B,8
       DBF9                     FILE2:
000EDA DBF9 CD45DC          17      CALL    CCHKF
000EDD DBFC C8              11      RET Z
000EDE DBFD FE2A             7      CP  '*'
000EE0 DBFF 282E            12      JR  Z,FILE9
000EE2 DC01 FE2E             7      CP  '.'
000EE4 DC03 280C            12      JR  Z,FILE4
000EE6 DC05 77               7      LD  (HL),A
000EE7 DC06 23               6      INC HL
000EE8 DC07 10F0            13      DJNZ    FILE2
                                
       DC09                     FILE3:
000EEA DC09 CD45DC          17      CALL    CCHKF
000EED DC0C C8              11      RET Z
000EEE DC0D FE2E             7      CP  '.'
000EF0 DC0F 20F8            12      JR  NZ,FILE3
                                
       DC11                     FILE4:
000EF2 DC11 211DF0          10      LD  HL,FNAME+8
000EF5 DC14 0603             7      LD  B,3
                                
       DC16                     FILE4L:
000EF7 DC16 CD45DC          17      CALL    CCHKF
000EFA DC19 C8              11      RET Z
000EFB DC1A FE2E             7      CP  '.'
000EFD DC1C 2008            12      JR  NZ,FILE12
000EFF DC1E 3215F0          13      LD  (FNAME),A   ;Parent directory(..)
000F02 DC21 3216F0          13      LD  (FNAME+1),A
000F05 DC24 3E20             7      LD  A,020H
       DC26                     FILE12:
000F07 DC26 FE2A             7      CP  '*'
000F09 DC28 280A            12      JR  Z,FILE10
000F0B DC2A 77               7      LD  (HL),A
000F0C DC2B 23               6      INC HL
000F0D DC2C 10E8            13      DJNZ    FILE4L
000F0F DC2E C9              10      RET
                                
       DC2F                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000F10 DC2F CD34DC          17      CALL    FILE10
000F13 DC32 18D5            12      JR  FILE3
                                
       DC34                     FILE10:
000F15 DC34 3E3F             7      LD  A,'?'
000F17 DC36 1808            12      JR  FILL_MEMORY
       DC38                     FILEI:              ;名前＋拡張子をスペースで初期化
000F19 DC38 3E20             7      LD  A,020H
000F1B DC3A 01000B          10      LD  BC,11*256   ;C=0にしておく
000F1E DC3D 2115F0          10      LD  HL,FNAME
       DC40                     FILL_MEMORY:            ;HLからBバイトAで埋める
000F21 DC40 77               7      LD  (HL),A
000F22 DC41 23               6      INC HL
000F23 DC42 10FC            13      DJNZ    FILL_MEMORY
000F25 DC44 C9              10      RET
                                
       DC45                     CCHKF:
000F26 DC45 1A               7      LD  A,(DE)
000F27 DC46 CD4DDC          17      CALL    CCHK2
000F2A DC49 C8              11      RET Z
000F2B DC4A C3B9DF          10      JP  FKAN
                                
       DC4D                     CCHK2:
000F2E DC4D 0C               4      INC C
000F2F DC4E 0D               4      DEC C
000F30 DC4F C0              11      RET NZ
       DC50                     CCHK3:              ;ZF=1 で使えない文字
000F31 DC50 FE2B             7      CP  '+'
000F33 DC52 C8              11      RET Z
000F34 DC53 FE2C             7      CP  ','
000F36 DC55 C8              11      RET Z
000F37 DC56 FE2F             7      CP  '/'
000F39 DC58 C8              11      RET Z
000F3A DC59 FE3A             7      CP  ':'
000F3C DC5B C8              11      RET Z
000F3D DC5C FE3B             7      CP  ';'
000F3F DC5E C8              11      RET Z
000F40 DC5F FE3D             7      CP  '='
000F42 DC61 C8              11      RET Z
000F43 DC62 FE5C             7      CP  05CH    ;\
000F45 DC64 C8              11      RET Z
000F46 DC65 FE20             7      CP  020H
000F48 DC67 D0              11      RET NC
000F49 DC68 BF               4      CP  A       ;Z=1
000F4A DC69 C9              10      RET
                                
       DC6A                     SS1:
000F4B DC6A 13               6      INC DE
       DC6B                     SPCUT:              ;スペースをカット
000F4C DC6B 1A               7      LD  A,(DE)
000F4D DC6C FE20             7      CP  020H
000F4F DC6E 28FA            12      JR  Z,SS1
000F51 DC70 C9              10      RET
                                
       DC71                     SETDRVF:
000F52 DC71 1114F0          10      LD  DE,FDRV
       DC74                     SETDRV0:
000F55 DC74 CD7DDC          17      CALL    SETDRV
000F58 DC77 FDE1            14      POP IY
000F5A DC79 C1              10      POP BC
000F5B DC7A D1              10      POP DE
000F5C DC7B E1              10      POP HL
000F5D DC7C C9              10      RET
                                
       DC7D                     SETDRV:
000F5E DC7D E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
000F5F DC7E D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
000F60 DC7F C5              11      PUSH    BC
000F61 DC80 1A               7      LD  A,(DE)
000F62 DC81 D5              11      PUSH    DE
000F63 DC82 FDE3            23      EX  (SP),IY
                                
000F65 DC84 CD8BDC          17      CALL    GETDRV
000F68 DC87 CDD9F0          17      CALL    _CHGDRV
                                
000F6B DC8A E9               4      JP  (HL)
                                
       DC8B                     GETDRV:
000F6C DC8B CD9EDC          17      CALL    GETDRV1
000F6F DC8E 3288F0          13      LD  (_DRV),A
000F72 DC91 C9              10      RET
                                
       DC92                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
000F73 DC92 CD9EDC          17      CALL    GETDRV1
000F76 DC95 C5              11      PUSH    BC
000F77 DC96 4F               4      LD  C,A
000F78 DC97 1A               7      LD  A,(DE)
000F79 DC98 CD9EDC          17      CALL    GETDRV1
000F7C DC9B A9               4      XOR C
000F7D DC9C C1              10      POP BC
000F7E DC9D C9              10      RET
       DC9E                     GETDRV1:
000F7F DC9E E67F             7      AND 07FH
000F81 DCA0 D601             7      SUB 001H
000F83 DCA2 D0              11      RET NC
000F84 DCA3 3A0400          13      LD  A,(_DVSW)   ;Current Drive
000F87 DCA6 C9              10      RET
                                
       DCA7                     SOPENX:
000F88 DCA7 1139F0          10      LD  DE,SFILE
000F8B DCAA FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
000F8E DCAD CD92DC          17      CALL    IS_SAME_DRV_A_DE
000F91 DCB0 2024            12      JR  NZ,SOPEN
000F93 DCB2 13               6      INC DE
000F94 DCB3 FDE5            15      PUSH    IY
000F96 DCB5 E1              10      POP HL
000F97 DCB6 23               6      INC HL
000F98 DCB7 CD42DE          17      CALL    CPFILE
000F9B DCBA 201A            12      JR  NZ,SOPEN
                                
000F9D DCBC 2AF4F1          16      LD  HL,(SCDIR)
000FA0 DCBF FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
000FA3 DCC2 FD740F          19      LD  (IY+15),H
                                
000FA6 DCC5 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
000FA9 DCC8 229FF0          16      LD  (_FILEN),HL
                                
000FAC DCCB ED5BF6F1        20      LD  DE,(SFBPS)
000FB0 DCCF 2139F0          10      LD  HL,SFILE
000FB3 DCD2 36FF            10      LD  (HL),0FFH
000FB5 DCD4 23               6      INC HL
000FB6 DCD5 C9              10      RET
       DCD6                     SOPEN:
000FB7 DCD6 21EADD          10      LD  HL,FILESE
       DCD9                     SOPENC:
000FBA DCD9 2212DD          16      LD  (OPENPAT),HL
                                
000FBD DCDC CDE2F0          17      CALL    _RDFATX     ;Detect Media
000FC0 DCDF 3856            12      JR  C,RDDERR
                                
000FC2 DCE1 AF               4      XOR A
000FC3 DCE2 329FF0          13      LD  (_FILEN),A
000FC6 DCE5 CDEEDE          17      CALL    LDDIRX1     ;A=0で呼び出す
000FC9 DCE8 2818            12      JR  Z,SDIRX1
                                
000FCB DCEA CDDBDD          17      CALL    READ_DIR    ;Sub Directory
000FCE DCED 3808            12      JR  C,SDIRX0
000FD0 DCEF 2A7EF1          16      LD  HL,(_DTBUF)
000FD3 DCF2 7E               7      LD  A,(HL)
000FD4 DCF3 FE2E             7      CP  '.'
000FD6 DCF5 280F            12      JR  Z,SOPEN1
       DCF7                     SDIRX0:
000FD8 DCF7 AF               4      XOR A
000FD9 DCF8 32A0F0          13      LD  (_DIRF),A
000FDC DCFB FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
000FE0 DCFF FD770F          19      LD  (IY+15),A
       DD02                     SDIRX1:
000FE3 DD02 ED5BFCF1        20      LD  DE,(_DIRPS) ;Root Directory
       DD06                     SOPEN1:
000FE7 DD06 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       DD07                     SDECPAT EQU $-1
       DD08                     SOPEN1X:
000FE9 DD08 CDDBDD          17      CALL    READ_DIR    ;FILE SEARCH
000FEC DD0B 382A            12      JR  C,RDDERR
000FEE DD0D 2A7EF1          16      LD  HL,(_DTBUF)
       DD10                     SOPEN2:
000FF1 DD10 D5              11      PUSH    DE
000FF2 DD11 CDEADD          17      CALL    FILESE      ;(self-modifying code)
       DD12                     OPENPAT EQU $-2
000FF5 DD14 D1              10      POP DE
000FF6 DD15 386D            12      JR  C,SOPENE
000FF8 DD17 281B            12      JR  Z,SCF_FF_RET
       DD19                     SOPEN3:
000FFA DD19 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
000FFD DD1C B7               4      OR  A
000FFE DD1D 200C            12      JR  NZ,SOPEN5
001000 DD1F 13               6      INC DE      ;ルートディレクトリ
001001 DD20 E5              11      PUSH    HL
001002 DD21 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       DD22                     MD_PAT  EQU $-2
001005 DD24 ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
001007 DD26 E1              10      POP HL
001008 DD27 20DD            12      JR  NZ,SOPEN1
00100A DD29 1807            12      JR  SOPEN6
       DD2B                     SOPEN5:
00100C DD2B CDF5E5          17      CALL    GNCLX       ;END DIR
00100F DD2E D8              11      RET C
001010 DD2F CDA2DE          17      CALL    ENDCL
       DD32                     SOPEN6:
001013 DD32 38D2            12      JR  C,SOPEN1
       DD34                     SCF_FF_RET:
001015 DD34 37               4      SCF         ;CF=1
001016 DD35 9F               4      SBC A,A     ;A=0FFH
001017 DD36 C9              10      RET
                                
       DD37                     RDDERR:
001018 DD37 BF               4      CP  A       ;READ ERR CF=1 ZF=1
001019 DD38 37               4      SCF
00101A DD39 C9              10      RET
                                
       DD3A                     NOPEN:
00101B DD3A 21EADD          10      LD  HL,FILESE
00101E DD3D 2212DD          16      LD  (OPENPAT),HL
001021 DD40 FD2A98F0        20      LD  IY,(_FCB)
001025 DD44 CDCCDF          17      CALL    CHKWILDX
001028 DD47 30EB            12      JR  NC,SCF_FF_RET
00102A DD49 FD7E00          19      LD  A,(IY+0)
00102D DD4C CD8BDC          17      CALL    GETDRV
001030 DD4F CDD9F0          17      CALL    _CHGDRV
001033 DD52 D8              11      RET C
001034 DD53 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
001037 DD56 229FF0          16      LD  (_FILEN),HL
                                
00103A DD59 CDE9DE          17      CALL    LDDIRX
00103D DD5C ED5B9AF0        20      LD  DE,(_FBPS)
001041 DD60 CDDBDD          17      CALL    READ_DIR
001044 DD63 38D2            12      JR  C,RDDERR
001046 DD65 3A9EF0          13      LD  A,(_FBCNT)
001049 DD68 3D               4      DEC A
00104A DD69 28AE            12      JR  Z,SOPEN3
       DD6B                     NOPEN2:
00104C DD6B 2A9CF0          16      LD  HL,(_FBAD)
00104F DD6E 012000          10      LD  BC,020H
001052 DD71 09              11      ADD HL,BC
001053 DD72 4F               4      LD  C,A
001054 DD73 189B            12      JR  SOPEN2
                                
       DD75                     SOPENE2:
001056 DD75 229CF0          16      LD  (_FBAD),HL
001059 DD78 79               4      LD  A,C
00105A DD79 329EF0          13      LD  (_FBCNT),A
00105D DD7C ED539AF0        20      LD  (_FBPS),DE
001061 DD80 FD2298F0        20      LD  (_FCB),IY
       DD84                     SOPENE:
001065 DD84 AF               4      XOR A
001066 DD85 C9              10      RET
                                
       DD86                     COPEN:
001067 DD86 FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
00106B DD8A 2107DE          10      LD  HL,NEXTSE
00106E DD8D CDD9DC          17      CALL    SOPENC
001071 DD90 D0              11      RET NC
001072 DD91 C8              11      RET Z
001073 DD92 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
001076 DD95 B7               4      OR  A
001077 DD96 37               4      SCF
001078 DD97 C8              11      RET Z       ;ルートディレクトリ
001079 DD98 0601             7      LD  B,1
00107B DD9A CD2BE0          17      CALL    WRDF
00107E DD9D D8              11      RET C
00107F DD9E ED5BFEF1        20      LD  DE,(_CLPS)
001083 DDA2 D5              11      PUSH    DE
001084 DDA3 CD6BDE          17      CALL    DCPAT
001087 DDA6 CD76E4          17      CALL    DRDNX
00108A DDA9 2A7EF1          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
00108D DDAC ED4B61E3        20      LD  BC,(SECSZ)  ;1セクタのサイズ
001091 DDB0 AF               4      XOR A
       DDB1                     COPENCL:
001092 DDB1 77               7      LD  (HL),A
001093 DDB2 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001095 DDB4 EAB1DD          10      JP  PE,COPENCL
                                
001098 DDB7 3A89DE          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
00109B DDBA 3D               4      DEC A
00109C DDBB 2819            12      JR  Z,COPENE
00109E DDBD 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
0010A0 DDBF 32EDE5          13      LD  (_SECPS),A
0010A3 DDC2 D1              10      POP DE      ;DE=(_CLPS)
0010A4 DDC3 D5              11      PUSH    DE
       DDC4                     COPEN1:
0010A5 DDC4 D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
0010A6 DDC5 C5              11      PUSH    BC
0010A7 DDC6 2A7EF1          16      LD  HL,(_DTBUF)
0010AA DDC9 CD85DE          17      CALL    CLUSTX
0010AD DDCC CD8CE7          17      CALL    DWT24
0010B0 DDCF C1              10      POP BC
0010B1 DDD0 D1              10      POP DE
0010B2 DDD1 CDECE5          17      CALL    NEXTX
0010B5 DDD4 20EE            12      JR  NZ,COPEN1
       DDD6                     COPENE:
0010B7 DDD6 2A7EF1          16      LD  HL,(_DTBUF)
0010BA DDD9 D1              10      POP DE
0010BB DDDA C9              10      RET
                                
       DDDB                     READ_DIR:
0010BC DDDB ED53FEF1        20      LD  (_CLPS),DE
0010C0 DDDF C5              11      PUSH    BC
0010C1 DDE0 D5              11      PUSH    DE
0010C2 DDE1 CD6BDE          17      CALL    DCPAT
0010C5 DDE4 CD56E4          17      CALL    DRDX
0010C8 DDE7 D1              10      POP DE
0010C9 DDE8 C1              10      POP BC
0010CA DDE9 C9              10      RET
                                
       DDEA                     FILESE:
0010CB DDEA 7E               7      LD  A,(HL)
0010CC DDEB B7               4      OR  A
0010CD DDEC C8              11      RET Z       ;END:ZF=1 CF=0
0010CE DDED FEE5             7      CP  0E5H
0010D0 DDEF 280E            12      JR  Z,FILESE1
0010D2 DDF1 FDE5            15      PUSH    IY
0010D4 DDF3 D1              10      POP DE
0010D5 DDF4 13               6      INC DE
0010D6 DDF5 E5              11      PUSH    HL
0010D7 DDF6 CD42DE          17      CALL    CPFILE
0010DA DDF9 CC63DE          17      CALL    Z,CPFILE2
0010DD DDFC E1              10      POP HL
0010DE DDFD 37               4      SCF
0010DF DDFE C8              11      RET Z       ;!!!:(ZF=1) CF=1
       DDFF                     FILESE1:
0010E0 DDFF CD16DE          17      CALL    FNEXT
0010E3 DE02 20E6            12      JR  NZ,FILESE
       DE04                     ZF0_CF0_AFF_RET:
0010E5 DE04 F6FF             7      OR  0FFH        ;ZF=0 CF=0
0010E7 DE06 C9              10      RET
                                
       DE07                     NEXTSE:
0010E8 DE07 7E               7      LD  A,(HL)
0010E9 DE08 B7               4      OR  A
0010EA DE09 37               4      SCF
0010EB DE0A C8              11      RET Z       ;!!!:ZF=1 CF=1
0010EC DE0B FEE5             7      CP  0E5H
0010EE DE0D 37               4      SCF
0010EF DE0E C8              11      RET Z       ;!!!:(ZF=1) CF=1
0010F0 DE0F CD16DE          17      CALL    FNEXT
0010F3 DE12 20F3            12      JR  NZ,NEXTSE
0010F5 DE14 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       DE16                     FNEXT:
0010F7 DE16 E5              11      PUSH    HL
0010F8 DE17 219FF0          10      LD  HL,_FILEN
0010FB DE1A 34              11      INC (HL)
0010FC DE1B E1              10      POP HL
0010FD DE1C 112000          10      LD  DE,020H
001100 DE1F 19              11      ADD HL,DE
001101 DE20 0D               4      DEC C
001102 DE21 C9              10      RET
                                
       DE22                     CPNAME:
001103 DE22 C5              11      PUSH    BC
001104 DE23 D5              11      PUSH    DE
001105 DE24 E5              11      PUSH    HL
001106 DE25 CD3CDE          17      CALL    CPFILE4
001109 DE28 E1              10      POP HL
00110A DE29 23               6      INC HL
00110B DE2A 23               6      INC HL
00110C DE2B 23               6      INC HL
00110D DE2C 23               6      INC HL
00110E DE2D D1              10      POP DE
00110F DE2E C1              10      POP BC
001110 DE2F 2005            12      JR  NZ,CPNAME1
001112 DE31 7E               7      LD  A,(HL)
001113 DE32 23               6      INC HL
001114 DE33 66               7      LD  H,(HL)
001115 DE34 6F               4      LD  L,A
001116 DE35 C9              10      RET
       DE36                     CPNAME1:
001117 DE36 23               6      INC HL
001118 DE37 23               6      INC HL
001119 DE38 10E8            13      DJNZ    CPNAME
00111B DE3A 37               4      SCF
00111C DE3B C9              10      RET
                                
       DE3C                     CPFILE4:
00111D DE3C C5              11      PUSH    BC
00111E DE3D 010004          10      LD  BC,00400H
001121 DE40 1804            12      JR  CPSTR1
       DE42                     CPFILE:
001123 DE42 C5              11      PUSH    BC
001124 DE43 01000B          10      LD  BC,00B00H
       DE46                     CPSTR1:
001127 DE46 1A               7      LD  A,(DE)
001128 DE47 FE3F             7      CP  '?'     ;Wild card
00112A DE49 2812            12      JR  Z,CPSTR2
00112C DE4B 7E               7      LD  A,(HL)
00112D DE4C CDB2DF          17      CALL    FKANC
001130 DE4F E5              11      PUSH    HL
001131 DE50 67               4      LD  H,A
001132 DE51 1A               7      LD  A,(DE)
001133 DE52 CB01             8      RLC C
001135 DE54 CDB2DF          17      CALL    FKANC
001138 DE57 CB09             8      RRC C
00113A DE59 BC               4      CP  H       ;CP (HL),(DE)
00113B DE5A E1              10      POP HL
00113C DE5B 2004            12      JR  NZ,CPSTR3
       DE5D                     CPSTR2:
00113E DE5D 13               6      INC DE
00113F DE5E 23               6      INC HL
001140 DE5F 10E5            13      DJNZ    CPSTR1
       DE61                     CPSTR3:
001142 DE61 C1              10      POP BC
001143 DE62 C9              10      RET
                                
       DE63                     CPFILE2:
001144 DE63 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001147 DE66 F6E1             7      OR  0E1H
001149 DE68 2F               4      CPL
00114A DE69 A6               7      AND (HL)
00114B DE6A C9              10      RET
                                
       DE6B                     DCPAT:
00114C DE6B 0E00             7      LD  C,0
00114E DE6D 2A7EF1          16      LD  HL,(_DTBUF)
001151 DE70 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
001154 DE73 B7               4      OR  A
001155 DE74 C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
001156 DE75 3A89DE          13      LD  A,(SPCPAT)
001159 DE78 4F               4      LD  C,A
00115A DE79 3AEDE5          13      LD  A,(_SECPS)
00115D DE7C B9               4      CP  C
00115E DE7D 3801            12      JR  C,DC1
001160 DE7F AF               4      XOR A
       DE80                     DC1:
001161 DE80 F680             7      OR  080H
001163 DE82 32A0F0          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       DE85                     CLUSTX:
001166 DE85 E5              11      PUSH    HL
001167 DE86 EB               4      EX  DE,HL
001168 DE87 AF               4      XOR A
001169 DE88 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       DE89                     SPCPAT  EQU $-1
       DE8A                     L_CLDBL:
00116B DE8A CB19             8      RR  C       ;->CF
00116D DE8C 3804            12      JR  C,E_CLDBL
00116F DE8E 29              11      ADD HL,HL       ;*2
001170 DE8F 8F               4      ADC A,A
001171 DE90 18F8            12      JR  L_CLDBL
       DE92                     E_CLDBL:
001173 DE92 4F               4      LD  C,A
001174 DE93 3AEDE5          13      LD  A,(_SECPS)
001177 DE96 B5               4      OR  L
001178 DE97 6F               4      LD  L,A
001179 DE98 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       DE99                     CLSPAT  EQU $-2
00117C DE9B AF               4      XOR A
00117D DE9C 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
00117E DE9D 89               4      ADC A,C
00117F DE9E 4F               4      LD  C,A
001180 DE9F EB               4      EX  DE,HL
001181 DEA0 E1              10      POP HL
001182 DEA1 C9              10      RET
                                ;(8)
       DEA2                     ENDCL:
001183 DEA2 7A               4      LD  A,D ;END CLUSTER
001184 DEA3 FE01             7      CP  1   ;164=356    (self-modifying code)
       DEA4                     CLPAT1  EQU $-1
001186 DEA5 C0              11      RET NZ
001187 DEA6 7B               4      LD  A,E
001188 DEA7 FE64             7      CP  064H    ;       (self-modifying code)
       DEA8                     CLPAT2  EQU $-1
00118A DEA9 C9              10      RET
                                ;(3)
       DEAA                     CAP4:
00118B DEAA 3EE5             7      LD  A,0E5H
00118D DEAC C9              10      RET
                                                    ;for X1/88 ワークエリア
00118E DEAD 5BF0                    DW  _DISKE+1        ;DISKVE($F323)
001190 DEAF F5F0                    DW  _BREAK+1        ;BREAKV($F325)
                                
       DEB1                     CAP:            ;(9)
001192 DEB1 FE61             7      CP  'a'
001194 DEB3 D8              11      RET C
001195 DEB4 FE7B             7      CP  'z'+1
001197 DEB6 D0              11      RET NC
001198 DEB7 D620             7      SUB 020H
00119A DEB9 C9              10      RET
                                ;(10)
       DEBA                     CAP2:
00119B DEBA CDB1DE          17      CALL    CAP
       DEBD                     CAP3:               ;
00119E DEBD FE05             7      CP  5
0011A0 DEBF 28E9            12      JR  Z,CAP4
0011A2 DEC1 FE21             7      CP  021H
0011A4 DEC3 C9              10      RET
                                                    ;
       DEC4                     CHDIR:
0011A5 DEC4 CD9DE8          17      CALL    GETDPBD
0011A8 DEC7 381D            12      JR  C,CHDIR2
0011AA DEC9 DD751A          19      LD  (IX+DPB_SDIR),L
0011AD DECC DD741B          19      LD  (IX+DPB_SDIR+1),H
0011B0 DECF 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       DED1                     LDDIR:
0011B2 DED1 CD9DE8          17      CALL    GETDPBD
0011B5 DED4 DD5E1A          19      LD  E,(IX+DPB_SDIR)
0011B8 DED7 DD561B          19      LD  D,(IX+DPB_SDIR+1)
0011BB DEDA 13               6      INC DE
0011BC DEDB FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0011BF DEDE FD720F          19      LD  (IY+15),D
0011C2 DEE1 1B               6      DEC DE
0011C3 DEE2 AF               4      XOR A
0011C4 DEE3 32A0F0          13      LD  (_DIRF),A
       DEE6                     CHDIR2:
0011C7 DEE6 DDE1            14      POP IX
0011C9 DEE8 C9              10      RET
                                
       DEE9                     LDDIRX:
0011CA DEE9 3AA0F0          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
0011CD DEEC E67F             7      AND 07FH
       DEEE                     LDDIRX1:
0011CF DEEE 32EDE5          13      LD  (_SECPS),A
0011D2 DEF1 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0011D5 DEF4 FD560F          19      LD  D,(IY+15)
0011D8 DEF7 1B               6      DEC DE
0011D9 DEF8 CDA2DE          17      CALL    ENDCL
0011DC DEFB D4D1DE          17      CALL    NC,LDDIR
       DEFE                     LDDIRS:
0011DF DEFE 7A               4      LD  A,D
0011E0 DEFF B3               4      OR  E
0011E1 DF00 32A0F0          13      LD  (_DIRF),A   ;ディレクトリか判別
0011E4 DF03 C9              10      RET
                                
       DF04                     KILL:
0011E5 DF04 CDCCDF          17      CALL    CHKWILDX
0011E8 DF07 3834            12      JR  C,KILLW
0011EA DF09 CDA7DC          17      CALL    SOPENX
       DF0C                     KILLS:
0011ED DF0C 3E1F             7      LD  A,01FH
0011EF DF0E D450DF          17      CALL    NC,CHKATT
0011F2 DF11 D8              11      RET C
       DF12                     KILLSX:
0011F3 DF12 36E5            10      LD  (HL),0E5H   ;DIR
0011F5 DF14 CDA8DF          17      CALL    WTDB
0011F8 DF17 111A00          10      LD  DE,01AH
0011FB DF1A 19              11      ADD HL,DE
0011FC DF1B 5E               7      LD  E,(HL)
0011FD DF1C 23               6      INC HL
0011FE DF1D 56               7      LD  D,(HL)
       DF1E                     KILLS1:
0011FF DF1E CDA2DE          17      CALL    ENDCL
001202 DF21 D0              11      RET NC      ;CF=0
001203 DF22 21FEFF          10      LD  HL,0-2
001206 DF25 19              11      ADD HL,DE
001207 DF26 D0              11      RET NC      ;DE= 0 or 1
001208 DF27 D5              11      PUSH    DE
001209 DF28 CDF7F0          17      CALL    _GNCL
00120C DF2B ED53FEF1        20      LD  (_CLPS),DE
001210 DF2F D1              10      POP DE
001211 DF30 210000          10      LD  HL,0
001214 DF33 D4FAF0          17      CALL    NC,_SNCL
001217 DF36 D8              11      RET C
001218 DF37 ED5BFEF1        20      LD  DE,(_CLPS)  ;FAT
00121C DF3B 18E1            12      JR  KILLS1
                                
       DF3D                     KILLW:
00121E DF3D CDD6DC          17      CALL    SOPEN
       DF40                     KILLW1:
001221 DF40 380B            12      JR  C,KILLW2
001223 DF42 CD75DD          17      CALL    SOPENE2
001226 DF45 CD0CDF          17      CALL    KILLS
001229 DF48 CD3ADD          17      CALL    NOPEN
00122C DF4B 18F3            12      JR  KILLW1
       DF4D                     KILLW2:
00122E DF4D C8              11      RET Z
00122F DF4E 3F               4      CCF
001230 DF4F C9              10      RET
                                
       DF50                     CHKATT:
001231 DF50 E5              11      PUSH    HL
001232 DF51 110B00          10      LD  DE,00BH
001235 DF54 19              11      ADD HL,DE
001236 DF55 A6               7      AND (HL)
001237 DF56 E1              10      POP HL
001238 DF57 C8              11      RET Z
001239 DF58 37               4      SCF
00123A DF59 C9              10      RET
                                
       DF5A                     NAME:
00123B DF5A CDCCDF          17      CALL    CHKWILDX
00123E DF5D D8              11      RET C
00123F DF5E 110400          10      LD  DE,4
001242 DF61 19              11      ADD HL,DE
001243 DF62 2277DF          16      LD  (NAMEP),HL
001246 DF65 23               6      INC HL
001247 DF66 CDD0DF          17      CALL    CHKWILD
00124A DF69 D8              11      RET C
                                
00124B DF6A CDA7DC          17      CALL    SOPENX
00124E DF6D 3E0F             7      LD  A,00FH
001250 DF6F D450DF          17      CALL    NC,CHKATT
001253 DF72 D8              11      RET C
                                
001254 DF73 FDE5            15      PUSH    IY
001256 DF75 FD210000        14      LD  IY,0        ;自己書き換え
       DF77                     NAMEP   EQU $-2
00125A DF79 CDA7DC          17      CALL    SOPENX
00125D DF7C FDE3            23      EX  (SP),IY
00125F DF7E 3F               4      CCF
001260 DF7F D4D6DC          17      CALL    NC,SOPEN
001263 DF82 EB               4      EX  DE,HL
001264 DF83 E1              10      POP HL
001265 DF84 D8              11      RET C
                                
       DF85                     SETNAME:
001266 DF85 01000B          10      LD  BC,11*256
001269 DF88 23               6      INC HL
00126A DF89 7E               7      LD  A,(HL)
00126B DF8A FEE5             7      CP  0E5H
00126D DF8C 2004            12      JR  NZ,SNAME1
00126F DF8E 3E05             7      LD  A,5
001271 DF90 180E            12      JR  SNAME3
       DF92                     SNAME1:
001273 DF92 7E               7      LD  A,(HL)
001274 DF93 0C               4      INC C
001275 DF94 0D               4      DEC C
001276 DF95 2009            12      JR  NZ,SNAME3
001278 DF97 CDB1DE          17      CALL    CAP
00127B DF9A FEA0             7      CP  0A0H
00127D DF9C 2002            12      JR  NZ,SNAME3
00127F DF9E 3E20             7      LD  A,020H
       DFA0                     SNAME3:
001281 DFA0 12               7      LD  (DE),A
001282 DFA1 7E               7      LD  A,(HL)
001283 DFA2 23               6      INC HL
001284 DFA3 CDB9DF          17      CALL    FKAN
001287 DFA6 10EA            13      DJNZ    SNAME1
       DFA8                     WTDB:               ;バッファデータが更新された
001289 DFA8 3EFF             7      LD  A,0FFH
00128B DFAA 3239F0          13      LD  (SFILE),A
00128E DFAD 32A4F0          13      LD  (_WTDBF),A
001291 DFB0 AF               4      XOR A
001292 DFB1 C9              10      RET
                                
       DFB2                     FKANC:
001293 DFB2 CB41             8      BIT 0,C
001295 DFB4 CCBADE          17      CALL    Z,CAP2
001298 DFB7 1801            12      JR  FKANX
       DFB9                     FKAN:           ;漢字チェック
00129A DFB9 13               6      INC DE
       DFBA                     FKANX:
00129B DFBA CB41             8      BIT 0,C
00129D DFBC CB81             8      RES 0,C
00129F DFBE C0              11      RET NZ
0012A0 DFBF FE80             7      CP  080H
0012A2 DFC1 D8              11      RET C
0012A3 DFC2 FEA0             7      CP  0A0H
0012A5 DFC4 3803            12      JR  C,FKAN1
0012A7 DFC6 FEE0             7      CP  0E0H
0012A9 DFC8 D8              11      RET C
       DFC9                     FKAN1:
0012AA DFC9 0C               4      INC C
0012AB DFCA A7               4      AND A
0012AC DFCB C9              10      RET
                                
       DFCC                     CHKWILDX:
0012AD DFCC FDE5            15      PUSH    IY
0012AF DFCE E1              10      POP HL
0012B0 DFCF 23               6      INC HL
       DFD0                     CHKWILD:
0012B1 DFD0 060B             7      LD  B,11
0012B3 DFD2 3E3F             7      LD  A,'?'
       DFD4                     CHKWIL1:
0012B5 DFD4 BE               7      CP  (HL)
0012B6 DFD5 23               6      INC HL
0012B7 DFD6 37               4      SCF
0012B8 DFD7 C8              11      RET Z
0012B9 DFD8 10FA            13      DJNZ    CHKWIL1
0012BB DFDA AF               4      XOR A
0012BC DFDB C9              10      RET
                                
       DFDC                     SDIRENT:        ;IY=FCB HL=DIR
0012BD DFDC D5              11      PUSH    DE
0012BE DFDD E5              11      PUSH    HL
0012BF DFDE FDE5            15      PUSH    IY
0012C1 DFE0 D1              10      POP DE
0012C2 DFE1 EB               4      EX  DE,HL
0012C3 DFE2 CD85DF          17      CALL    SETNAME
                                ;               Attribute
0012C6 DFE5 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0012C9 DFE8 12               7      LD  (DE),A
0012CA DFE9 13               6      INC DE
                                ;               Reserved
0012CB DFEA AF               4      XOR A
0012CC DFEB 060A             7      LD  B,10
       DFED                     SDE1:
0012CE DFED 12               7      LD  (DE),A
0012CF DFEE 13               6      INC DE
0012D0 DFEF 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
0012D2 DFF1 21E4F1          10      LD  HL,SDDATA       ;(FCB)更新年月日
0012D5 DFF4 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       DFF6                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
0012D7 DFF6 7E               7      LD  A,(HL)
0012D8 DFF7 23               6      INC HL
0012D9 DFF8 32FDDF          13      LD  (SDPAT),A
0012DC DFFB FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       DFFD                     SDPAT   EQU $-1
0012DF DFFE 12               7      LD  (DE),A
0012E0 DFFF 13               6      INC DE
0012E1 E000 10F4            13      DJNZ    SDLOOP
                                
0012E3 E002 AF               4      XOR A
0012E4 E003 E1              10      POP HL
0012E5 E004 D1              10      POP DE
0012E6 E005 C9              10      RET
                                
       E006                     WOPEN:
0012E7 E006 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0012EA E009 E61F             7      AND 01FH
0012EC E00B 37               4      SCF
0012ED E00C C0              11      RET NZ
0012EE E00D FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       E011                     TOPEN2:
0012F2 E011 AF               4      XOR A
       E012                     TOPEN:              ;Initializes the time stamp
0012F3 E012 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
0012F7 E016 C9              10      RET
                                
       E017                     WRDFX:
0012F8 E017 3A89DE          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       E01A                     L_WRFX:
0012FB E01A 1F               4      RRA         ;->CF
0012FC E01B 3806            12      JR  C,E_WRFX
0012FE E01D CB39             8      SRL C
001300 E01F CB1C             8      RR  H       ;CH=CH/2
001302 E021 18F7            12      JR  L_WRFX
       E023                     E_WRFX:
001304 E023 41               4      LD  B,C
001305 E024 4C               4      LD  C,H
001306 E025 03               6      INC BC
001307 E026 3E37             7      LD  A,037H      ;SCF
001309 E028 3273E4          13      LD  (DRDN1),A
                                
       E02B                     WRDF:               ;BCクラスタ分FATを確保する
00130C E02B 110200          10      LD  DE,2
00130F E02E AF               4      XOR A
001310 E02F 32EDE5          13      LD  (_SECPS),A
       E032                     WRDF1:
001313 E032 C5              11      PUSH    BC
001314 E033 D5              11      PUSH    DE
001315 E034 CDF7F0          17      CALL    _GNCL
001318 E037 381C            12      JR  C,WRDF3
00131A E039 7A               4      LD  A,D     ;空いているかチェック
00131B E03A B3               4      OR  E
00131C E03B 202A            12      JR  NZ,WRDF4
00131E E03D E1              10      POP HL      ;HL=空いているクラスタ
00131F E03E E5              11      PUSH    HL
001320 E03F ED5BFEF1        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
001324 E043 22FEF1          16      LD  (_CLPS),HL
001327 E046 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
001328 E047 B3               4      OR  E
001329 E048 2008            12      JR  NZ,WRDF2
00132B E04A FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
00132E E04D FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
001331 E050 1803            12      JR  WRDF3
       E052                     WRDF2:
001333 E052 CDFAF0          17      CALL    _SNCL
       E055                     WRDF3:
001336 E055 D1              10      POP DE
001337 E056 C1              10      POP BC
001338 E057 D8              11      RET C
001339 E058 0B               6      DEC BC
00133A E059 78               4      LD  A,B
00133B E05A B1               4      OR  C
00133C E05B 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
00133E E05D ED5BFEF1        20      LD  DE,(_CLPS)
001342 E061 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
001345 E064 C3FAF0          10      JP  _SNCL
                                
       E067                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
001348 E067 D1              10      POP DE
001349 E068 C1              10      POP BC
       E069                     WRDF5:
00134A E069 13               6      INC DE
00134B E06A CDA2DE          17      CALL    ENDCL
00134E E06D 38C3            12      JR  C,WRDF1
001350 E06F 37               4      SCF
001351 E070 C9              10      RET
                                
       E071                     RWXR:
001352 E071 3A62E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E074                     L_RWX:
001355 E074 1F               4      RRA     ;->CF
001356 E075 3808            12      JR  C,E_RWX
001358 E077 CB38             8      SRL B   ;BCH=BCH/2
00135A E079 CB19             8      RR  C   ;
00135C E07B CB1C             8      RR  H   ;
00135E E07D 18F5            12      JR  L_RWX
       E07F                     E_RWX:
001360 E07F FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001363 E082 FD561B          19      LD  D,(IY+27)
001366 E085 AF               4      XOR A
001367 E086 32EDE5          13      LD  (_SECPS),A
       E089                     RWX1:
00136A E089 ED53FEF1        20      LD  (_CLPS),DE
00136E E08D 7A               4      LD  A,D
00136F E08E B3               4      OR  E
001370 E08F 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
001372 E091 78               4      LD  A,B
001373 E092 B1               4      OR  C
001374 E093 B4               4      OR  H
001375 E094 C8              11      RET Z       ;RET BCH==0 => CF=0
                                
001376 E095 CDF5E5          17      CALL    GNCLX
001379 E098 D8              11      RET C
00137A E099 7C               4      LD  A,H     ;
00137B E09A 25               4      DEC H       ;
00137C E09B B7               4      OR  A       ;DEC BCH
00137D E09C 2001            12      JR  NZ,RWX2     ;
00137F E09E 0B               6      DEC BC      ;
       E09F                     RWX2:
001380 E09F CDA2DE          17      CALL    ENDCL
001383 E0A2 38E5            12      JR  C,RWX1
       E0A4                     SCF_RET:
001385 E0A4 37               4      SCF
001386 E0A5 C9              10      RET
                                
       E0A6                     DSKF:
001387 E0A6 110000          10      LD  DE,0
       E0A7                     MAXCLP  EQU $-2
00138A E0A9 2AACF0          16      LD  HL,(_FAKEFREE)
00138D E0AC 7C               4      LD  A,H
00138E E0AD B5               4      OR  L
00138F E0AE 2803            12      JR  Z,DSKF1
001391 E0B0 110100          10      LD  DE,1
       E0B3                     DSKF1:
001394 E0B3 D5              11      PUSH    DE
001395 E0B4 CDF7F0          17      CALL    _GNCL
001398 E0B7 380C            12      JR  C,POPSCF
00139A E0B9 7A               4      LD  A,D
00139B E0BA B3               4      OR  E
00139C E0BB 2001            12      JR  NZ,DSKF2
00139E E0BD 23               6      INC HL
       E0BE                     DSKF2:
00139F E0BE D1              10      POP DE
0013A0 E0BF 1B               6      DEC DE
0013A1 E0C0 7A               4      LD  A,D
0013A2 E0C1 B3               4      OR  E
0013A3 E0C2 20EF            12      JR  NZ,DSKF1
0013A5 E0C4 C9              10      RET
                                
       E0C5                     POPSCF:
0013A6 E0C5 F1              10      POP AF
0013A7 E0C6 37               4      SCF
0013A8 E0C7 C9              10      RET
                                
       E0C8                     SETTMS:
0013A9 E0C8 FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
0013AC E0CB 3C               4      INC A
0013AD E0CC C0              11      RET NZ      ;ファイルが更新されていない
       E0CD                     SETTMSX:            ;FCBに日付時刻をセットする
0013AE E0CD CDBAD7          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
0013B1 E0D0 CB25             8      SLA L       ;   *2
0013B3 E0D2 CB25             8      SLA L       ;   *4
0013B5 E0D4 29              11      ADD HL,HL       ;*2 *8
0013B6 E0D5 29              11      ADD HL,HL       ;*4 *16
0013B7 E0D6 29              11      ADD HL,HL       ;*8 *32
0013B8 E0D7 7A               4      LD  A,D
0013B9 E0D8 0F               4      RRCA            ;bit.0->7->->->0->C
0013BA E0D9 E61F             7      AND 01FH
0013BC E0DB B5               4      OR  L
0013BD E0DC FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
0013C0 E0DF FD7417          19      LD  (IY+23),H
                                
0013C3 E0E2 CDBAD7          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
0013C6 E0E5 0144F8          10      LD  BC,0-1980
0013C9 E0E8 09              11      ADD HL,BC
0013CA E0E9 65               4      LD  H,L
                                
0013CB E0EA 7A               4      LD  A,D
0013CC E0EB 87               4      ADD A,A     ;*2
0013CD E0EC 87               4      ADD A,A     ;*4
0013CE E0ED 87               4      ADD A,A     ;*8
0013CF E0EE 87               4      ADD A,A     ;*16
0013D0 E0EF 6F               4      LD  L,A
0013D1 E0F0 29              11      ADD HL,HL       ;*32
0013D2 E0F1 7D               4      LD  A,L
0013D3 E0F2 B3               4      OR  E
0013D4 E0F3 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
0013D7 E0F6 FD7415          19      LD  (IY+21),H
0013DA E0F9 C9              10      RET
                                ;(16)
       E0FA                     PUSHRR:
0013DB E0FA 3226E4          13      LD  (SETSEQ_SWC_RND),A
0013DE E0FD 2238E4          16      LD  (SETSEQ_SWC_SEQ_RR),HL
0013E1 E100 CD20E1          17      CALL    GET_RR_AHL
0013E4 E103 220FF0          16      LD  (RR_BUF_HL),HL
0013E7 E106 3211F0          13      LD  (RR_BUF_A),A
0013EA E109 C9              10      RET
                                ;(14)
       E10A                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
0013EB E10A 87               4      ADD A,A     ;in BHLA => out AHL
0013EC E10B ED6A            15      ADC HL,HL
0013EE E10D CB18             8      RR  B
0013F0 E10F B7               4      OR  A
0013F1 E110 78               4      LD  A,B     ;ここでフラグは変化しない
0013F2 E111 C8              11      RET Z
0013F3 E112 2C               4      INC L       ;INC AHL
0013F4 E113 C0              11      RET NZ      ;
0013F5 E114 24               4      INC H       ;
0013F6 E115 C0              11      RET NZ      ;
0013F7 E116 3C               4      INC A       ;
0013F8 E117 C9              10      RET
                                ;(18)
       E118                     INIT_RND:
0013F9 E118 3ECD             7      LD  A,0CDH      ;CALL ????
0013FB E11A 2137E1          10      LD  HL,POPRR
0013FE E11D CDFAE0          17      CALL    PUSHRR
       E120                     GET_RR_AHL:
001401 E120 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
001404 E123 FD6622          19      LD  H,(IY+34)   ;
001407 E126 FD7E23          19      LD  A,(IY+35)   ;
00140A E129 C9              10      RET
                                ;(10)
       E12A                     SET_RR_AHL:
00140B E12A FD7521          19      LD  (IY+33),L   ;(FCB)Random record
00140E E12D FD7422          19      LD  (IY+34),H   ;
001411 E130 FD7723          19      LD  (IY+35),A   ;
001414 E133 C9              10      RET
                                ;(17)
       E134                     SETSEQ:
001415 E134 CD59E1          17      CALL    SETSEQ1
       E137                     POPRR:
001418 E137 F5              11      PUSH    AF
001419 E138 E5              11      PUSH    HL
00141A E139 2A0FF0          16      LD  HL,(RR_BUF_HL)
00141D E13C 3A11F0          13      LD  A,(RR_BUF_A)
001420 E13F CD2AE1          17      CALL    SET_RR_AHL
001423 E142 E1              10      POP HL
001424 E143 F1              10      POP AF
001425 E144 C9              10      RET
                                ;(20)
       E145                     GET_RR_BCDE:            ;BCDE=Random record
001426 E145 FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
001429 E148 FD5622          19      LD  D,(IY+34)
00142C E14B FD4E23          19      LD  C,(IY+35)
00142F E14E 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
001431 E150 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001435 E154 C0              11      RET NZ
001436 E155 FD4624          19      LD  B,(IY+36)
001439 E158 C9              10      RET
                                
       E159                     SETSEQ1:
00143A E159 F5              11      PUSH    AF
00143B E15A E5              11      PUSH    HL      ;AHL=Random record
00143C E15B CD20E1          17      CALL    GET_RR_AHL
00143F E15E 47               4      LD  B,A     ;AHL→HLA
001440 E15F 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
001441 E160 6C               4      LD  L,H     ;(IY+34)
001442 E161 60               4      LD  H,B     ;(IY+35)
001443 E162 0600             7      LD  B,0
                                
001445 E164 CD0AE1          17      CALL    GET_CPM_R_SIZE
                                
001448 E167 29              11      ADD HL,HL
001449 E168 CB3D             8      SRL L       ;L=L/2
00144B E16A FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
00144E E16D FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
001451 E170 E1              10      POP HL
001452 E171 F1              10      POP AF
001453 E172 C9              10      RET
                                
                                ;(23)
       E173                     RBXEND:             ;レコード数だけランダムレコードを進める
001454 E173 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       E174                     RBSIZE  EQU $-2
001457 E176 CD20E1          17      CALL    GET_RR_AHL
00145A E179 19              11      ADD HL,DE
00145B E17A CE00             7      ADC A,0
00145D E17C CD2AE1          17      CALL    SET_RR_AHL
001460 E17F EB               4      EX  DE,HL       ;HL=進めるレコード数
001461 E180 D0              11      RET NC
001462 E181 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001466 E185 C0              11      RET NZ
001467 E186 FD3424          23      INC (IY+36)
00146A E189 C9              10      RET
       E18A                     FILE_E:
                                
       DD34                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       DD34                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       DD34                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       DD34                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       DD34                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E18A                     _SYS26:     ;(BDOS)ランダムブロック書き込み
00146B E18A AF               4      XOR A
00146C E18B 3273E4          13      LD  (DRDN1),A   ;NOP
00146F E18E 2274E1          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
001472 E191 225DF0          16      LD  (LEFTX),HL
001475 E194 CD7DDC          17      CALL    SETDRV
                                
001478 E197 CDFDE2          17      CALL    RBX0
00147B E19A DA27E2          10      JP  C,RBWERR
00147E E19D CD06E0          17      CALL    WOPEN
001481 E1A0 DA27E2          10      JP  C,RBWERR
001484 E1A3 7C               4      LD  A,H
001485 E1A4 B5               4      OR  L
001486 E1A5 CA20E2          10      JP  Z,RBW1
                                
001489 E1A8 2B               6      DEC HL
                                
00148A E1A9 CD45E1          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
00148D E1AC 19              11      ADD HL,DE       ;BCHL=HL+BCDE
00148E E1AD 3001            12      JR  NC,S26X1    ;
001490 E1AF 03               6      INC BC      ;
       E1B0                     S26X1:
001491 E1B0 CD71E0          17      CALL    RWXR
001494 E1B3 DC17E0          17      CALL    C,WRDFX
001497 E1B6 DA27E2          10      JP  C,RBWERR
                                
00149A E1B9 CD2CE3          17      CALL    RBX2
00149D E1BC 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
00149F E1BE CD4BE3          17      CALL    RBXA
0014A2 E1C1 3864            12      JR  C,RBWERR
0014A4 E1C3 EB               4      EX  DE,HL
0014A5 E1C4 C5              11      PUSH    BC
0014A6 E1C5 EDB0                    LDIR
0014A8 E1C7 225FF0          16      LD  (DTAX),HL
                                
0014AB E1CA CDA8DF          17      CALL    WTDB        ;バッファデータは更新された
                                
0014AE E1CD 2A5DF0          16      LD  HL,(LEFTX)
0014B1 E1D0 D1              10      POP DE
0014B2 E1D1 ED52            15      SBC HL,DE
0014B4 E1D3 225DF0          16      LD  (LEFTX),HL
0014B7 E1D6 2831            12      JR  Z,RBWEND
                                
       E1D8                     RBWB:
0014B9 E1D8 CD80E3          17      CALL    RBXB
0014BC E1DB 2814            12      JR  Z,RBWC
       E1DD                     RBWB1:
0014BE E1DD C5              11      PUSH    BC
0014BF E1DE D5              11      PUSH    DE
0014C0 E1DF CD85DE          17      CALL    CLUSTX
0014C3 E1E2 CDA4E3          17      CALL    DWTC
0014C6 E1E5 D1              10      POP DE
0014C7 E1E6 C1              10      POP BC
0014C8 E1E7 D4F5E5          17      CALL    NC,GNCLX
0014CB E1EA 383B            12      JR  C,RBWERR
0014CD E1EC 10EF            13      DJNZ    RBWB1
0014CF E1EE CDF4E3          17      CALL    DRW_FLUSH
       E1F1                     RBWC:
0014D2 E1F1 CD98E3          17      CALL    RBXC
0014D5 E1F4 2813            12      JR  Z,RBWEND
0014D7 E1F6 C5              11      PUSH    BC
0014D8 E1F7 CD85DE          17      CALL    CLUSTX
0014DB E1FA CD72E4          17      CALL    DRDN
0014DE E1FD C1              10      POP BC
0014DF E1FE 3827            12      JR  C,RBWERR
0014E1 E200 ED5B7EF1        20      LD  DE,(_DTBUF)
0014E5 E204 EDB0                    LDIR
0014E7 E206 CDA8DF          17      CALL    WTDB        ;バッファデータは更新された
       E209                     RBWEND:
0014EA E209 CD73E1          17      CALL    RBXEND
                                
0014ED E20C CD0CE3          17      CALL    RBX1
0014F0 E20F 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
0014F2 E211 CD45E1          17      CALL    GET_RR_BCDE ;BCDE=Random record
0014F5 E214 FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
0014F8 E217 FD7211          19      LD  (IY+17),D   ;
0014FB E21A FD7112          19      LD  (IY+18),C   ;
0014FE E21D FD7013          19      LD  (IY+19),B   ;
       E220                     RBW1:
001501 E220 FDE1            14      POP IY
001503 E222 C1              10      POP BC
001504 E223 D1              10      POP DE
001505 E224 E1              10      POP HL
       E225                     DD_NUL:
001506 E225 AF               4      XOR A
       E226                     DRDF0:
       E226                     DWTF0:
001507 E226 C9              10      RET
                                
       E227                     RBWERR:
001508 E227 FDE5            15      PUSH    IY
00150A E229 D1              10      POP DE
00150B E22A 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
00150D E22C CD4BD4          17      CALL    BDOS0
       E22F                     RBRERR1:
001510 E22F 3E01             7      LD  A,001H
       E231                     RBRERR2:
001512 E231 FDE1            14      POP IY
001514 E233 C1              10      POP BC
001515 E234 D1              10      POP DE
001516 E235 E1              10      POP HL
001517 E236 37               4      SCF
001518 E237 210000          10      LD  HL,0
00151B E23A C9              10      RET
                                
       E23B                     RBRERR:
00151C E23B 3EFF             7      LD  A,0FFH
00151E E23D 18F2            12      JR  RBRERR2
                                
       E23F                     RBRFL:
001520 E23F 3E00             7  RBRFLP: LD  A,000H
001522 E241 FE0D             7      CP  00DH
001524 E243 2005            12      JR  NZ,RBRFL1
001526 E245 D5              11      PUSH    DE
001527 E246 1E0A             7      LD  E,00AH
001529 E248 1805            12      JR  RBRFL2
       E24A                     RBRFL1:
00152B E24A D5              11      PUSH    DE
00152C E24B CD09F0          17      CALL    _SYS07
00152F E24E 5F               4      LD  E,A
       E24F                     RBRFL2:
001530 E24F CDCDF0          17      CALL    _PRINT
001533 E252 7B               4      LD  A,E
001534 E253 D1              10      POP DE
001535 E254 3240E2          13      LD  (RBRFLP+1),A
001538 E257 C9              10      RET
                                
                                                ;Read random block
       E258                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001539 E258 225DF0          16      LD  (LEFTX),HL
00153C E25B CD7DDC          17      CALL    SETDRV
                                
00153F E25E FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
001543 E262 C2EBE2          10      JP  NZ,RBRDIR   ;ディレクトリ
001546 E265 CDFDE2          17      CALL    RBX0
001549 E268 DA3BE2          10      JP  C,RBRERR
00154C E26B CD0CE3          17      CALL    RBX1
00154F E26E D424E3          17      CALL    NC,RBX1R
001552 E271 DA2FE2          10      JP  C,RBRERR1
001555 E274 EB               4      EX  DE,HL
001556 E275 ED52            15      SBC HL,DE       ;CP 00HL,BCDE
001558 E277 19              11      ADD HL,DE
001559 E278 79               4      LD  A,C
00155A E279 DE00             7      SBC A,0
00155C E27B 78               4      LD  A,B
00155D E27C DE00             7      SBC A,0
00155F E27E 3801            12      JR  C,RBR1
001561 E280 EB               4      EX  DE,HL
       E281                     RBR1:
001562 E281 9F               4      SBC A,A
001563 E282 E601             7      AND 1
001565 E284 32E9E2          13      LD  (RBRA_SWC),A
                                
001568 E287 7C               4      LD  A,H
001569 E288 B5               4      OR  L
00156A E289 2857            12      JR  Z,RBREND0
                                
00156C E28B 2274E1          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
00156F E28E 225DF0          16      LD  (LEFTX),HL
                                
001572 E291 CD2CE3          17      CALL    RBX2
001575 E294 2819            12      JR  Z,RBRB
001577 E296 CD4BE3          17      CALL    RBXA
00157A E299 DA3BE2          10      JP  C,RBRERR
00157D E29C C5              11      PUSH    BC
00157E E29D EDB0                    LDIR
001580 E29F ED535FF0        20      LD  (DTAX),DE
001584 E2A3 2A5DF0          16      LD  HL,(LEFTX)
001587 E2A6 D1              10      POP DE
001588 E2A7 A7               4      AND A
001589 E2A8 ED52            15      SBC HL,DE
00158B E2AA 225DF0          16      LD  (LEFTX),HL
00158E E2AD 2830            12      JR  Z,RBREND
                                
       E2AF                     RBRB:
001590 E2AF CD80E3          17      CALL    RBXB
001593 E2B2 2815            12      JR  Z,RBRC
       E2B4                     RBRB1:
001595 E2B4 C5              11      PUSH    BC
001596 E2B5 D5              11      PUSH    DE
001597 E2B6 CD85DE          17      CALL    CLUSTX
00159A E2B9 CDAAE3          17      CALL    DRDC
00159D E2BC D1              10      POP DE
00159E E2BD C1              10      POP BC
00159F E2BE D4F5E5          17      CALL    NC,GNCLX
0015A2 E2C1 DA3BE2          10      JP  C,RBRERR
0015A5 E2C4 10EE            13      DJNZ    RBRB1
0015A7 E2C6 CDF4E3          17      CALL    DRW_FLUSH
       E2C9                     RBRC:
0015AA E2C9 CD98E3          17      CALL    RBXC
0015AD E2CC 2811            12      JR  Z,RBREND
0015AF E2CE C5              11      PUSH    BC
0015B0 E2CF CD85DE          17      CALL    CLUSTX
0015B3 E2D2 CD56E4          17      CALL    DRDX
0015B6 E2D5 C1              10      POP BC
0015B7 E2D6 DA3BE2          10      JP  C,RBRERR
0015BA E2D9 EB               4      EX  DE,HL
0015BB E2DA 2A7EF1          16      LD  HL,(_DTBUF)
0015BE E2DD EDB0                    LDIR
       E2DF                     RBREND:
0015C0 E2DF CD73E1          17      CALL    RBXEND
       E2E2                     RBREND0:
0015C3 E2E2 FDE1            14      POP IY
0015C5 E2E4 C1              10      POP BC
0015C6 E2E5 D1              10      POP DE
0015C7 E2E6 F1              10      POP AF  ;(HL)
0015C8 E2E7 AF               4      XOR A
0015C9 E2E8 3E00             7      LD  A,000H
       E2E9                     RBRA_SWC    EQU $-1
0015CB E2EA C9              10      RET
                                
       E2EB                     RBRDIR:
0015CC E2EB FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0015CF E2EE FD661B          19      LD  H,(IY+27)
0015D2 E2F1 CDC4DE          17      CALL    CHDIR
0015D5 E2F4 AF               4      XOR A
0015D6 E2F5 67               4      LD  H,A
0015D7 E2F6 6F               4      LD  L,A
0015D8 E2F7 3C               4      INC A
0015D9 E2F8 32E9E2          13      LD  (RBRA_SWC),A
0015DC E2FB 18E5            12      JR  RBREND0
                                ;(15)
       E2FD                     RBX0:
0015DE E2FD 2A8AF0          16      LD  HL,(_DTA)
0015E1 E300 225FF0          16      LD  (DTAX),HL
0015E4 E303 2A5DF0          16      LD  HL,(LEFTX)
0015E7 E306 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0015EA E309 D6FD             7      SUB 0FDH
0015EC E30B C9              10      RET
                                
       E30C                     RBX1:               ;ファイルサイズとランダムレコードを比べる
0015ED E30C E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
0015EE E30D FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
0015F1 E310 FD6611          19      LD  H,(IY+17)   ;
0015F4 E313 FD7E12          19      LD  A,(IY+18)   ;
                                
0015F7 E316 CD45E1          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0015FA E319 A7               4      AND A
0015FB E31A ED52            15      SBC HL,DE
0015FD E31C 99               4      SBC A,C
0015FE E31D 4F               4      LD  C,A
0015FF E31E FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
001602 E321 98               4      SBC A,B
001603 E322 D1              10      POP DE
001604 E323 C9              10      RET
       E324                     RBX1R:              ;(8)
001605 E324 47               4      LD  B,A
001606 E325 B1               4      OR  C
001607 E326 EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
001608 E327 B2               4      OR  D
001609 E328 B3               4      OR  E
00160A E329 C0              11      RET NZ
00160B E32A 37               4      SCF
00160C E32B C9              10      RET
                                
       E32C                     RBX2:               ;Cluster settings
00160D E32C FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
001610 E32F FD4E23          19      LD  C,(IY+35)
001613 E332 0600             7      LD  B,0
001615 E334 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001619 E338 2003            12      JR  NZ,RBX3
00161B E33A FD4624          19      LD  B,(IY+36)
       E33D                     RBX3:
00161E E33D CD71E0          17      CALL    RWXR
001621 E340 3A62E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
001624 E343 3D               4      DEC A
001625 E344 FDA622          19      AND (IY+34)
001628 E347 FDB621          19      OR  (IY+33)
00162B E34A C9              10      RET
                                
       E34B                     RBXA:
00162C E34B C5              11      PUSH    BC
00162D E34C D5              11      PUSH    DE
00162E E34D CD85DE          17      CALL    CLUSTX
001631 E350 CD56E4          17      CALL    DRDX
001634 E353 D1              10      POP DE
001635 E354 C1              10      POP BC
001636 E355 D4F5E5          17      CALL    NC,GNCLX
001639 E358 D8              11      RET C
00163A E359 ED53FEF1        20      LD  (_CLPS),DE
                                
00163E E35D FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
001641 E360 210004          10      LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
       E361                     SECSZ   EQU $-2
       E362                     SECSZ_H EQU $-1
001644 E363 7C               4      LD  A,H
001645 E364 3D               4      DEC A       ;1024=3 / 512=1
001646 E365 FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
001649 E368 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
00164A E369 ED42            15      SBC HL,BC       ;残りを計算
                                
00164C E36B ED5B5DF0        20      LD  DE,(LEFTX)
001650 E36F ED52            15      SBC HL,DE       ;CP HL,DE
001652 E371 19              11      ADD HL,DE       ;
001653 E372 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
001655 E374 EB               4      EX  DE,HL
       E375                     RBXA1:
001656 E375 E5              11      PUSH    HL
001657 E376 2A7EF1          16      LD  HL,(_DTBUF)
00165A E379 09              11      ADD HL,BC
00165B E37A ED5B5FF0        20      LD  DE,(DTAX)
00165F E37E C1              10      POP BC
001660 E37F C9              10      RET
                                
       E380                     RBXB:
001661 E380 2A5FF0          16      LD  HL,(DTAX)
001664 E383 ED5BFEF1        20      LD  DE,(_CLPS)
001668 E387 3A5EF0          13      LD  A,(LEFTX+1)
00166B E38A 47               4      LD  B,A
00166C E38B 3A62E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E38E                     RBXB1:
00166F E38E 1F               4      RRA     ;->CF
001670 E38F 3804            12      JR  C,RBXB2
001672 E391 CB38             8      SRL B   ;B=B/2
001674 E393 18F9            12      JR  RBXB1
       E395                     RBXB2:
001676 E395 78               4      LD  A,B
001677 E396 B7               4      OR  A
001678 E397 C9              10      RET
                                ;(12)
       E398                     RBXC:
001679 E398 ED4B5DF0        20      LD  BC,(LEFTX)
00167D E39C 3A62E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
001680 E39F 3D               4      DEC A
001681 E3A0 A0               4      AND B
001682 E3A1 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
001683 E3A2 B1               4      OR  C
001684 E3A3 C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E3A4                     DWTC:
001685 E3A4 E5              11      PUSH    HL
001686 E3A5 218EE7          10      LD  HL,DWT24B
001689 E3A8 1804            12      JR  DWTC1
       E3AA                     DRDC:
00168B E3AA E5              11      PUSH    HL
00168C E3AB 2180E7          10      LD  HL,DRD24B
       E3AE                     DWTC1:
00168F E3AE 2208E4          16      LD  (DRWF_MODE),HL
001692 E3B1 E1              10      POP HL
001693 E3B2 3AF8E3          13      LD  A,(DRWF_B)
001696 E3B5 B7               4      OR  A
001697 E3B6 200F            12      JR  NZ,DRDC1
       E3B8                     SAVE_DRWC:
001699 E3B8 0601             7      LD  B,1
00169B E3BA ED43F7E3        20      LD  (DRWF_C),BC
00169F E3BE ED53FEE3        20      LD  (DRWF_E),DE
0016A3 E3C2 2201E4          16      LD  (DRWF_HL),HL
0016A6 E3C5 1820            12      JR  INC_HL_DRWC
       E3C7                     DRDC1:
0016A8 E3C7 E5              11      PUSH    HL
0016A9 E3C8 21FEE3          10      LD  HL,DRWF_E
0016AC E3CB 86               7      ADD A,(HL)
0016AD E3CC F5              11      PUSH    AF
0016AE E3CD BB               4      CP  E
0016AF E3CE 201D            12      JR  NZ,DRDC2
0016B1 E3D0 F1              10      POP AF
0016B2 E3D1 23               6      INC HL
0016B3 E3D2 7E               7      LD  A,(HL)
0016B4 E3D3 CE00             7      ADC A,0
0016B6 E3D5 F5              11      PUSH    AF
0016B7 E3D6 BA               4      CP  D
0016B8 E3D7 2014            12      JR  NZ,DRDC2
0016BA E3D9 F1              10      POP AF
0016BB E3DA 3AF7E3          13      LD  A,(DRWF_C)
0016BE E3DD CE00             7      ADC A,0
0016C0 E3DF B9               4      CP  C
0016C1 E3E0 200C            12      JR  NZ,DRDC3
0016C3 E3E2 21F8E3          10      LD  HL,DRWF_B
0016C6 E3E5 34              11      INC (HL)
0016C7 E3E6 E1              10      POP HL
       E3E7                     INC_HL_DRWC:
0016C8 E3E7 3A62E3          13      LD  A,(SECSZ_H)     ;1セクタのサイズの上位1バイト
0016CB E3EA 84               4      ADD A,H
0016CC E3EB 67               4      LD  H,A
0016CD E3EC C9              10      RET
       E3ED                     DRDC2:
0016CE E3ED F1              10      POP AF
       E3EE                     DRDC3:
0016CF E3EE CDF4E3          17      CALL    DRW_FLUSH
0016D2 E3F1 E1              10      POP HL
0016D3 E3F2 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E3F4                     DRW_FLUSH:
0016D5 E3F4 C5              11      PUSH    BC
0016D6 E3F5 D5              11      PUSH    DE
0016D7 E3F6 010000          10      LD  BC,0
       E3F7                     DRWF_C  EQU $-2
       E3F8                     DRWF_B  EQU $-1
0016DA E3F9 78               4      LD  A,B
0016DB E3FA B7               4      OR  A
0016DC E3FB 280D            12      JR  Z,DRDF1
0016DE E3FD 110000          10      LD  DE,0
       E3FE                     DRWF_E  EQU $-2
       E3FF                     DRWF_D  EQU $-1
0016E1 E400 210000          10      LD  HL,0
       E401                     DRWF_HL EQU $-2
0016E4 E403 AF               4      XOR A
0016E5 E404 32F8E3          13      LD  (DRWF_B),A
0016E8 E407 CD80E7          17      CALL    DRD24B
       E408                     DRWF_MODE   EQU $-2
       E40A                     DRDF1:
0016EB E40A D1              10      POP DE
0016EC E40B C1              10      POP BC
0016ED E40C C9              10      RET
                                
       E40D                     RB_WRITE:
0016EE E40D C5              11      PUSH    BC
0016EF E40E 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0016F1 E410 1803            12      JR  RBRW
       E412                     RB_READ:
0016F3 E412 C5              11      PUSH    BC
0016F4 E413 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
       E415                     RBRW:
0016F6 E415 1F               4      RRA     ;AHL = AHL*128
0016F7 E416 7C               4      LD  A,H ;AHL = AHL0/2
0016F8 E417 1F               4      RRA     ;A
0016F9 E418 65               4      LD  H,L ;
0016FA E419 CB1C             8      RR  H   ;H
0016FC E41B 2E00             7      LD  L,0 ;
0016FE E41D CB1D             8      RR  L   ;L
001700 E41F CD2AE1          17      CALL    SET_RR_AHL
001703 E422 218000          10      LD  HL,128
001706 E425 C5              11      PUSH    BC
       E426                     SETSEQ_SWC_RND:
001707 E426 CD59E1          17      CALL    SETSEQ1     ;CALL SETSEQ1 or LD BC,SETSEQ1
00170A E429 C1              10      POP BC
00170B E42A FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
00170F E42E FDE5            15      PUSH    IY
001711 E430 D1              10      POP DE
001712 E431 D5              11      PUSH    DE
001713 E432 CD4BD4          17      CALL    BDOS0
001716 E435 FDE1            14      POP IY
001718 E437 CD34E1          17      CALL    SETSEQ      ;SETSEQ or POPRR
       E438                     SETSEQ_SWC_SEQ_RR   EQU $-2
00171B E43A FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
00171F E43E C1              10      POP BC
001720 E43F C9              10      RET
                                
                                ;(22)
       E440                     INIT_SEQ:
001721 E440 3E01             7      LD  A,1     ;LD BC,????
001723 E442 2134E1          10      LD  HL,SETSEQ
001726 E445 CDFAE0          17      CALL    PUSHRR
       E448                     GETSEQ:
001729 E448 FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
00172C E44B FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
00172F E44E AF               4      XOR A
                                
001730 E44F CB25             8      SLA L   ;L=L*2
                                
001732 E451 CB3C             8      SRL H   ;HL=HL/2
001734 E453 CB1D             8      RR  L   ;
001736 E455 C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E456                     DRDX:
001737 E456 CD94E4          17      CALL    DRDY
00173A E459 C8              11      RET Z
00173B E45A CD7AE4          17      CALL    DRDX1       ;データバッファの情報を保存
00173E E45D D8              11      RET C
00173F E45E E5              11      PUSH    HL
001740 E45F C5              11      PUSH    BC
001741 E460 D5              11      PUSH    DE
001742 E461 2A7EF1          16      LD  HL,(_DTBUF)
001745 E464 3ABDE4          13      LD  A,(_DBS24)
001748 E467 4F               4      LD  C,A
001749 E468 CD7EE7          17      CALL    DRD24
00174C E46B DC8FE4          17      CALL    C,DRDNE
       E46E                     POP_DE_BC_HL_RET:
00174F E46E D1              10      POP DE
001750 E46F C1              10      POP BC
001751 E470 E1              10      POP HL
001752 E471 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E472                     DRDN:
001753 E472 AF               4      XOR A
001754 E473 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
001755 E474 30E0            12      JR  NC,DRDX
       E476                     DRDNX:
001757 E476 CD94E4          17      CALL    DRDY
00175A E479 C8              11      RET Z
       E47A                     DRDX1:
00175B E47A CDAAE4          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
00175E E47D ED53A6F0        20      LD  (_DBSEC),DE
001762 E481 79               4      LD  A,C
001763 E482 32BDE4          13      LD  (_DBS24),A
                                
001766 E485 3A88F0          13      LD  A,(_DRV)
001769 E488 32A5F0          13      LD  (_DBDRV),A
00176C E48B CDD9F0          17      CALL    _CHGDRV
00176F E48E D0              11      RET NC
       E48F                     DRDNE:
001770 E48F 9F               4      SBC A,A     ;CF=1ならばA=0FFH
001771 E490 32A5F0          13      LD  (_DBDRV),A
001774 E493 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E494                     DRDY:
001775 E494 3ABDE4          13      LD  A,(_DBS24)
001778 E497 B9               4      CP  C
001779 E498 C0              11      RET NZ
                                
00177A E499 E5              11      PUSH    HL
00177B E49A 3A88F0          13      LD  A,(_DRV)
00177E E49D 21A5F0          10      LD  HL,_DBDRV
001781 E4A0 AE               7      XOR (HL)
001782 E4A1 2005            12      JR  NZ,POP_HL_RET
                                
001784 E4A3 2AA6F0          16      LD  HL,(_DBSEC)
001787 E4A6 ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E4A8                     POP_HL_RET:
001789 E4A8 E1              10      POP HL
00178A E4A9 C9              10      RET
                                
       E4AA                     DWTX:
00178B E4AA 3AA4F0          13      LD  A,(_WTDBF)
00178E E4AD B7               4      OR  A
00178F E4AE C8              11      RET Z
001790 E4AF AF               4      XOR A
001791 E4B0 32A4F0          13      LD  (_WTDBF),A
                                
001794 E4B3 E5              11      PUSH    HL
001795 E4B4 C5              11      PUSH    BC
001796 E4B5 D5              11      PUSH    DE
001797 E4B6 3AA5F0          13      LD  A,(_DBDRV)
00179A E4B9 CDD9F0          17      CALL    _CHGDRV
00179D E4BC 0E00             7      LD  C,0
       E4BD                     _DBS24  EQU $-1
00179F E4BE ED5BA6F0        20      LD  DE,(_DBSEC)
0017A3 E4C2 2A7EF1          16      LD  HL,(_DTBUF)
0017A6 E4C5 D48CE7          17      CALL    NC,DWT24
       E4C8                     POP_DE_BC_HL_RET2:
0017A9 E4C8 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E4CA                     RDFATX:
0017AB E4CA E5              11      PUSH    HL
0017AC E4CB 3A88F0          13      LD  A,(_DRV)
0017AF E4CE 21AAF0          10      LD  HL,_FATDRV
0017B2 E4D1 AE               7      XOR (HL)
0017B3 E4D2 28D4            12      JR  Z,POP_HL_RET
                                
0017B5 E4D4 C5              11      PUSH    BC
0017B6 E4D5 D5              11      PUSH    DE
0017B7 E4D6 DDE5            15      PUSH    IX
0017B9 E4D8 CDF4E4          17      CALL    WTFATX
0017BC E4DB 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
0017BE E4DD AF               4      XOR A
0017BF E4DE 32ABF0          13      LD  (_FATIX),A
0017C2 E4E1 3A88F0          13      LD  A,(_DRV)
0017C5 E4E4 32AAF0          13      LD  (_FATDRV),A
0017C8 E4E7 CDE5F0          17      CALL    _RDFAT
       E4EA                     RDFATE2:
0017CB E4EA 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
0017CD E4EC 9F               4      SBC A,A     ;A=0xFF
0017CE E4ED 32AAF0          13      LD  (_FATDRV),A
       E4F0                     POP_IX_DE_BC_HL_RET:
0017D1 E4F0 DDE1            14      POP IX
0017D3 E4F2 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E4F4                     WTFATX:
0017D5 E4F4 3AA2F0          13      LD  A,(_WTFATF)
0017D8 E4F7 B7               4      OR  A
0017D9 E4F8 C8              11      RET Z
0017DA E4F9 AF               4      XOR A
0017DB E4FA 32A2F0          13      LD  (_WTFATF),A
                                
0017DE E4FD E5              11      PUSH    HL
0017DF E4FE 3AAAF0          13      LD  A,(_FATDRV)
0017E2 E501 21A5F0          10      LD  HL,_DBDRV
0017E5 E504 AE               7      XOR (HL)
0017E6 E505 CCAAE4          17      CALL    Z,DWTX
0017E9 E508 389E            12      JR  C,POP_HL_RET
0017EB E50A C5              11      PUSH    BC
0017EC E50B D5              11      PUSH    DE
0017ED E50C DDE5            15      PUSH    IX
0017EF E50E CD9DE7          17      CALL    FATSETUP
0017F2 E511 D48EE7          17      CALL    NC,DWT24B
0017F5 E514 18DA            12      JR  POP_IX_DE_BC_HL_RET
                                
       E516                     N16CL1:
0017F7 E516 7A               4      LD  A,D
0017F8 E517 B3               4      OR  E
0017F9 E518 37               4      SCF
0017FA E519 C8              11      RET Z
                                
0017FB E51A 7A               4      LD  A,D
0017FC E51B 1807            12      JR  NCL1X
       E51D                     NCL1:
0017FE E51D 7A               4      LD  A,D
0017FF E51E B3               4      OR  E
001800 E51F 37               4      SCF
001801 E520 C8              11      RET Z
                                
001802 E521 7A               4      LD  A,D
001803 E522 CB3F             8      SRL A   ;/2
       E524                     NCL1X:
001805 E524 CB3F             8      SRL A   ;/2
                                
001807 E526 E5              11      PUSH    HL
001808 E527 3246E5          13      LD  (NCLPAT_FATIX),A    ;_FATIX
00180B E52A 2AAAF0          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
00180E E52D BC               4      CP  H
00180F E52E 3A88F0          13      LD  A,(_DRV)    ;LDではフラグは変化しない
001812 E531 3245E5          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
001815 E534 2005            12      JR  NZ,NCL2     ;FATIXが違う
001817 E536 BD               4      CP  L
001818 E537 2002            12      JR  NZ,NCL2     ;ドライブが違う
00181A E539 E1              10      POP HL
00181B E53A C9              10      RET
       E53B                     NCL2:
00181C E53B C5              11      PUSH    BC
00181D E53C D5              11      PUSH    DE
00181E E53D DDE5            15      PUSH    IX
001820 E53F CDF4E4          17      CALL    WTFATX
001823 E542 38AC            12      JR  C,POP_IX_DE_BC_HL_RET
001825 E544 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E546                     NCLPAT_FATIX    EQU $-1
       E545                     NCLPAT_FATDRV   EQU $-2
001828 E547 ED43AAF0        20      LD  (_FATDRV),BC
00182C E54B CD72E7          17      CALL    RDFATS
00182F E54E 189A            12      JR  RDFATE2
                                
       E550                     NCL3:
001831 E550 CB9A             8      RES 3,D
001833 E552 CB92             8      RES 2,D
001835 E554 6B               4      LD  L,E
001836 E555 62               4      LD  H,D
001837 E556 CB3C             8      SRL H   ;
001839 E558 CB1D             8      RR  L   ;HLA=HLA/2
00183B E55A 1F               4      RRA     ;
00183C E55B F5              11      PUSH    AF
00183D E55C 3AABF0          13      LD  A,(_FATIX)
001840 E55F 0F               4      RRCA
001841 E560 300B            12      JR  NC,NCL3X1
001843 E562 3A62E3          13      LD  A,(SECSZ_H)
001846 E565 FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの際に先頭を512バイトずらす
001848 E567 2004            12      JR  NZ,NCL3X1
00184A E569 010002          10      LD  BC,512
00184D E56C 09              11      ADD HL,BC
       E56D                     NCL3X1:
00184E E56D F1              10      POP AF
00184F E56E ED4B7CF1        20      LD  BC,(_FATBF)
001853 E572 19              11      ADD HL,DE
001854 E573 09              11      ADD HL,BC
001855 E574 17               4      RLA
001856 E575 C9              10      RET
                                
       E576                     GNCL:
001857 E576 CD1DE5          17      CALL    NCL1        ;GET NEXT CLUSTER
00185A E579 D8              11      RET C
00185B E57A C5              11      PUSH    BC
00185C E57B E5              11      PUSH    HL
00185D E57C CD50E5          17      CALL    NCL3
001860 E57F 3809            12      JR  C,GNC1
001862 E581 5E               7      LD  E,(HL)
001863 E582 23               6      INC HL
001864 E583 7E               7      LD  A,(HL)
001865 E584 E60F             7      AND 00FH
001867 E586 57               4      LD  D,A
001868 E587 E1              10      POP HL
001869 E588 C1              10      POP BC
00186A E589 C9              10      RET
       E58A                     GNC1:
00186B E58A 7E               7      LD  A,(HL)
00186C E58B 23               6      INC HL
00186D E58C 56               7      LD  D,(HL)
00186E E58D 0604             7      LD  B,4
       E58F                     GNC1L:
001870 E58F CB3A             8      SRL D   ;DA=DA/2
001872 E591 1F               4      RRA     ;
001873 E592 10FB            13      DJNZ    GNC1L
                                
001875 E594 5F               4      LD  E,A
001876 E595 E1              10      POP HL
001877 E596 C1              10      POP BC
001878 E597 A7               4      AND A
001879 E598 C9              10      RET
                                
       E599                     SNCL:
00187A E599 CD1DE5          17      CALL    NCL1
00187D E59C D8              11      RET C
                                ;               SET NEXT CLUSTER
00187E E59D E5              11      PUSH    HL
00187F E59E C5              11      PUSH    BC
001880 E59F D5              11      PUSH    DE
001881 E5A0 E5              11      PUSH    HL
001882 E5A1 CD50E5          17      CALL    NCL3
001885 E5A4 D1              10      POP DE
                                ;CF=ODD
001886 E5A5 7E               7      LD  A,(HL)
001887 E5A6 73               7      LD  (HL),E
001888 E5A7 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
00188A E5A9 23               6      INC HL
00188B E5AA ED67            18      RRD     ;M={A[3:0],E[3:0]}
00188D E5AC 7A               4      LD  A,D
00188E E5AD 1804            12      JR  SNC11
       E5AF                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
001890 E5AF ED6F            18      RLD     ;M={D[3:0],E[7:4]}
001892 E5B1 23               6      INC HL
001893 E5B2 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E5B3                     SNC11:
001894 E5B3 ED6F            18      RLD     ;M={M[7:4],D[3:0]}
001896 E5B5 B7               4      OR  A
001897 E5B6 D1              10      POP DE
001898 E5B7 C1              10      POP BC
001899 E5B8 E1              10      POP HL
       E5B9                     FAT_CHANGED:
00189A E5B9 3EFF             7      LD  A,0FFH
00189C E5BB 32A2F0          13      LD  (_WTFATF),A
00189F E5BE C9              10      RET
                                
       E5BF                     N16CL3:
0018A0 E5BF C5              11      PUSH    BC
0018A1 E5C0 6B               4      LD  L,E
0018A2 E5C1 7A               4      LD  A,D
0018A3 E5C2 E601             7      AND 1
0018A5 E5C4 67               4      LD  H,A
0018A6 E5C5 29              11      ADD HL,HL
0018A7 E5C6 ED4B7CF1        20      LD  BC,(_FATBF)
0018AB E5CA 09              11      ADD HL,BC
0018AC E5CB C1              10      POP BC
0018AD E5CC C9              10      RET
                                
       E5CD                     GNCL16:
0018AE E5CD CD16E5          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
0018B1 E5D0 D8              11      RET C
0018B2 E5D1 E5              11      PUSH    HL
0018B3 E5D2 CDBFE5          17      CALL    N16CL3
0018B6 E5D5 5E               7      LD  E,(HL)
0018B7 E5D6 23               6      INC HL
0018B8 E5D7 56               7      LD  D,(HL)
0018B9 E5D8 E1              10      POP HL
0018BA E5D9 C9              10      RET
                                
       E5DA                     SNCL16:
0018BB E5DA CD16E5          17      CALL    N16CL1      ;SET NEXT CLUSTER for FAT16
0018BE E5DD D8              11      RET C
0018BF E5DE D5              11      PUSH    DE
0018C0 E5DF E5              11      PUSH    HL
0018C1 E5E0 CDBFE5          17      CALL    N16CL3
0018C4 E5E3 D1              10      POP DE      ;HL
0018C5 E5E4 73               7      LD  (HL),E
0018C6 E5E5 23               6      INC HL
0018C7 E5E6 72               7      LD  (HL),D
0018C8 E5E7 6B               4      LD  L,E
0018C9 E5E8 62               4      LD  H,D
0018CA E5E9 D1              10      POP DE
0018CB E5EA 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E5EC                     NEXTX:
0018CD E5EC 3E00             7      LD  A,0 ;自己書き換え
       E5ED                     _SECPS  EQU $-1
0018CF E5EE 3C               4      INC A
0018D0 E5EF E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E5F0                     _NCPAT  EQU $-1
0018D2 E5F1 32EDE5          13      LD  (_SECPS),A
0018D5 E5F4 C9              10      RET
                                
       E5F5                     GNCLX:
0018D6 E5F5 CDECE5          17      CALL    NEXTX
0018D9 E5F8 C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
0018DA E5F9 C3F7F0          10      JP  _GNCL   ;次のクラスタを探す
                                
       E5FC                     RDFAT:
0018DD E5FC 3E80             7      LD  A,080H
0018DF E5FE 3270F0          13      LD  (CHECK),A
       E601                     RDFAT1:
0018E2 E601 3A88F0          13      LD  A,(_DRV)
0018E5 E604 CDA6E8          17      CALL    CHGDRVR
0018E8 E607 D8              11      RET C
0018E9 E608 DD7E12          19      LD  A,(IX+DPB_DEVICE)
0018EC E60B CB6F             8      BIT 5,A
0018EE E60D 286E            12      JR  Z,RDFAT0X
0018F0 E60F 2170F0          10      LD  HL,CHECK
0018F3 E612 A6               7      AND (HL)
0018F4 E613 77               7      LD  (HL),A
0018F5 E614 110000          10      LD  DE,0        ;BPB
0018F8 E617 2A7CF1          16      LD  HL,(_FATBF)
0018FB E61A 0E00             7      LD  C,0
0018FD E61C CD7EE7          17      CALL    DRD24
001900 E61F 3022            12      JR  NC,GETBPB
001902 E621 2170F0          10      LD  HL,CHECK
001905 E624 CB06            15      RLC (HL)
001907 E626 3F               4      CCF
001908 E627 D8              11      RET C
001909 E628 DDCB0A1E        23      RR  (IX+DPB_FDMODE)
00190D E62C 3F               4      CCF         ;フロッピーディスクのFDモード(2D/2HD)を切り替える
00190E E62D DDCB0A16        23      RL  (IX+DPB_FDMODE)
001912 E631 3A84F0          13      LD  A,(_DRIVE)
001915 E634 E603             7      AND 3
001917 E636 F680             7      OR  080H
001919 E638 6F               4      LD  L,A
00191A E639 26F0             7      LD  H,_CYL0/256
00191C E63B 3EFF             7      LD  A,0FFH
00191E E63D 3289F0          13      LD  (_DSK),A
001921 E640 77               7      LD  (HL),A
001922 E641 18BE            12      JR  RDFAT1
       E643                     GETBPB:
001924 E643 FDE5            15      PUSH    IY
001926 E645 FD2A7CF1        20      LD  IY,(_FATBF) ;BPB
00192A E649 CDF1F0          17      CALL    _BPB2DPB
00192D E64C FDE1            14      POP IY
00192F E64E DD7E12          19      LD  A,(IX+DPB_DEVICE)
001932 E651 3027            12      JR  NC,GETBPBOK
001934 E653 E60F             7      AND 00FH
001936 E655 FE07             7      CP  7
001938 E657 37               4      SCF
001939 E658 C0              11      RET NZ
00193A E659 DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
00193E E65D 21C0F1          10      LD  HL,M2D
001941 E660 2008            12      JR  NZ,SETFDMODE
001943 E662 2E04             7      LD  L,4
001945 E664 CD67E7          17      CALL    CHECK_MAXSECSZ
001948 E667 D8              11      RET C
001949 E668 2ED2             7      LD  L,M2HD-STABLE
       E66A                     SETFDMODE:
00194B E66A DDE5            15      PUSH    IX
00194D E66C D1              10      POP DE
00194E E66D EDA0            16      LDI
001950 E66F EDA0            16      LDI
001952 E671 13               6      INC DE
001953 E672 13               6      INC DE
001954 E673 13               6      INC DE
001955 E674 13               6      INC DE
001956 E675 010C00          10      LD  BC,12
001959 E678 EDB0                    LDIR
       E67A                     GETBPBOK:
00195B E67A CD12E8          17      CALL    CHGDRV2
       E67D                     RDFAT0X:
00195E E67D CD72E7          17      CALL    RDFATS
001961 E680 D8              11      RET C
001962 E681 DDAE06          19      XOR (IX+DPB_FATID)
001965 E684 C8              11      RET Z
001966 E685 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001969 E688 CB5F             8      BIT 3,A
00196B E68A 2803            12      JR  Z,RDFAT0X1
00196D E68C CB6F             8      BIT 5,A
00196F E68E C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
       E68F                     RDFAT0X1:
001970 E68F 37               4      SCF
001971 E690 C9              10      RET
                                
       E691                     POP_HL_SCF_RET:
001972 E691 E1              10      POP HL
001973 E692 37               4      SCF
001974 E693 C9              10      RET
                                
       E694                     BPB2DPB:
001975 E694 FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
001978 E697 B7               4      OR  A
001979 E698 37               4      SCF
00197A E699 C0              11      RET NZ
       E69A                     BPBOK:
00197B E69A FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
00197E E69D DD7707          19      LD  (IX+DPB_SECPCL),A
                                
001981 E6A0 FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
001984 E6A3 DD7700          19      LD  (IX+DPB_FATLN),A
001987 E6A6 FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
00198A E6A9 DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
00198D E6AC FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
001990 E6AF FD660F          19      LD  H,(IY+15)
001993 E6B2 DD750E          19      LD  (IX+DPB_FATPS),L
001996 E6B5 FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
001999 E6B8 FD5617          19      LD  D,(IY+23)
00199C E6BB FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E6BE                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
00199F E6BE 19              11      ADD HL,DE
0019A0 E6BF 10FD            13      DJNZ    BPBDP1
       E6C1                     BPBDP2:
0019A2 E6C1 DD7510          19      LD  (IX+DPB_DIRPS),L
0019A5 E6C4 DD7411          19      LD  (IX+DPB_DIRPS+1),H
0019A8 E6C7 E5              11      PUSH    HL
                                
0019A9 E6C8 FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
0019AC E6CB FD6612          19      LD  H,(IY+18)
0019AF E6CE FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
0019B2 E6D1 B7               4      OR  A
0019B3 E6D2 28BD            12      JR  Z,POP_HL_SCF_RET
0019B5 E6D4 0606             7      LD  B,6
       E6D6                     BPBBPS1:
0019B7 E6D6 05               4      DEC B
0019B8 E6D7 0F               4      RRCA
0019B9 E6D8 30FC            12      JR  NC,BPBBPS1
       E6DA                     BPBDE1:
0019BB E6DA 29              11      ADD HL,HL
0019BC E6DB 10FD            13      DJNZ    BPBDE1
                                
0019BE E6DD 7C               4      LD  A,H
0019BF E6DE DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
0019C2 E6E1 D1              10      POP DE      ;DPB_DIRPS
0019C3 E6E2 6C               4      LD  L,H
0019C4 E6E3 2600             7      LD  H,0
0019C6 E6E5 19              11      ADD HL,DE       ;MAXDIR
0019C7 E6E6 E5              11      PUSH    HL
0019C8 E6E7 FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
0019CB E6EA CB21             8      SLA C       ;*2
0019CD E6EC AF               4      XOR A
0019CE E6ED 47               4      LD  B,A
0019CF E6EE ED42            15      SBC HL,BC
0019D1 E6F0 DD7514          19      LD  (IX+DPB_ADDCL),L
0019D4 E6F3 DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
0019D7 E6F6 D1              10      POP DE      ;DE=DPB_MAXDIR
0019D8 E6F7 FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
0019DB E6FA FD6614          19      LD  H,(IY+20)
                                
0019DE E6FD DD7E12          19      LD  A,(IX+DPB_DEVICE)
0019E1 E700 E60F             7      AND 00FH
0019E3 E702 FE07             7      CP  7       ;フロッピー
0019E5 E704 2019            12      JR  NZ,NOT_FD
0019E7 E706 E5              11      PUSH    HL
0019E8 E707 FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
0019EB E70A DD710D          19      LD  (IX+DPB_MAXSEC),C
0019EE E70D AF               4      XOR A
0019EF E70E CB21             8      SLA C       ;両面なのでセクタ数を２倍
0019F1 E710 0610             7      LD  B,16
       E712                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
0019F3 E712 29              11      ADD HL,HL
0019F4 E713 17               4      RLA
0019F5 E714 B9               4      CP  C
0019F6 E715 3802            12      JR  C,DIVSEC1
0019F8 E717 91               4      SUB C
0019F9 E718 2C               4      INC L
       E719                     DIVSEC1:
0019FA E719 10F7            13      DJNZ    DIVSEC
0019FC E71B DD750C          19      LD  (IX+DPB_MAXCYL),L
0019FF E71E E1              10      POP HL  ;ここまでフロッピー専用
       E71F                     NOT_FD:
001A00 E71F 7C               4      LD  A,H
001A01 E720 B5               4      OR  L
001A02 E721 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001A04 E723 200E            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001A06 E725 2F               4      CPL         ;A=0FFH
001A07 E726 FD8623          19      ADD A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001A0A E729 D8              11      RET C
001A0B E72A FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001A0E E72D FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので、
001A11 E730 FD7E22          19      LD  A,(IY+34)   ;FAT12,FAT16では総セクタ数が24ビットを超えることは無い
       E733                     BPB16BIT:
001A14 E733 ED52            15      SBC HL,DE       ;DE=DPB_MAXDIR
001A16 E735 DE00             7      SBC A,0
001A18 E737 FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E73A                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001A1B E73A CB18             8      RR  B       ;->CY
001A1D E73C 3808            12      JR  C,BPBTC2
001A1F E73E CB3F             8      SRL A
001A21 E740 CB1C             8      RR  H       ;AHL=AHL/2
001A23 E742 CB1D             8      RR  L
001A25 E744 18F4            12      JR  BPBTC1
       E746                     BPBTC2:
001A27 E746 C6FF             7      ADD A,0FFH
001A29 E748 D8              11      RET C       ;念のため(クラスタ数が16ビットを超える場合)
001A2A E749 23               6      INC HL
001A2B E74A 23               6      INC HL
001A2C E74B DD7508          19      LD  (IX+DPB_MAXCL),L
001A2F E74E DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001A32 E751 FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001A35 E754 DD7706          19      LD  (IX+DPB_FATID),A
                                
001A38 E757 FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001A3B E75A C6FE             7      ADD A,0-2       ;>2:CF=1
001A3D E75C FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001A40 E75F 6F               4      LD  L,A
001A41 E760 3002            12      JR  NC,BPBFAT1
001A43 E762 F680             7      OR  080H
       E764                     BPBFAT1:            ;ここではCF=0
001A45 E764 DD770F          19      LD  (IX+DPB_BPS),A
       E767                     CHECK_MAXSECSZ:
001A48 E767 3A7BF1          13      LD  A,(_MAX_SEC_SZ_H)
001A4B E76A BD               4      CP  L
001A4C E76B C8              11      RET Z       ;1セクタ1024バイト
001A4D E76C 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001A4E E76D C8              11      RET Z       ;1セクタ256バイト
001A4F E76E 2D               4      DEC L
001A50 E76F C8              11      RET Z       ;1セクタ512バイト
001A51 E770 37               4      SCF
001A52 E771 C9              10      RET
                                
       E772                     RDFATS:
001A53 E772 CD9DE7          17      CALL    FATSETUP
001A56 E775 D8              11      RET C
001A57 E776 CD80E7          17      CALL    DRD24B
001A5A E779 2A7CF1          16      LD  HL,(_FATBF)
001A5D E77C 7E               7      LD  A,(HL)
001A5E E77D C9              10      RET
                                
       E77E                     DRD24:
001A5F E77E 0601             7      LD  B,1
       E780                     DRD24B:
001A61 E780 DDE5            15      PUSH    IX
001A63 E782 DD2AA8F0        20      LD  IX,(_DPB)
001A67 E786 CDE6E9          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E787                     DRDPAT  EQU $-2
001A6A E789 DDE1            14      POP IX
001A6C E78B C9              10      RET
                                
       E78C                     DWT24:
001A6D E78C 0601             7      LD  B,1
       E78E                     DWT24B:
001A6F E78E DDE5            15      PUSH    IX
001A71 E790 DD2AA8F0        20      LD  IX,(_DPB)
001A75 E794 CD8FE9          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       E795                     DWTPAT  EQU $-2
001A78 E797 DDE1            14      POP IX
001A7A E799 D0              11      RET NC
001A7B E79A C35AF0          10      JP  _DISKE
                                
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ512毎に1KBを切り替える
                                ;------------------------
       E79D                     FATSETUP:
001A7E E79D 3AAAF0          13      LD  A,(_FATDRV)
001A81 E7A0 CDA6E8          17      CALL    CHGDRVR     ;ドライブ切り替え
001A84 E7A3 D8              11      RET C
       E7A4                     FATS2:
001A85 E7A4 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001A88 E7A7 0F               4      RRCA
001A89 E7A8 CDD8E7          17      CALL    FATSETUP12  ;自己書き換え
       E7A9                     FATSX   EQU $-2
001A8C E7AB 210000          10      LD  HL,0
001A8F E7AE 4A               4      LD  C,D
001A90 E7AF 54               4      LD  D,H
001A91 E7B0 3AABF0          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-127(0-07FH):65535*2/1024
001A94 E7B3 47               4      LD  B,A
001A95 E7B4 04               4      INC B
001A96 E7B5 DD7E00          19      LD  A,(IX+DPB_FATLN)
       E7B8                     FAT_SKP:
001A99 E7B8 05               4      DEC B
001A9A E7B9 2809            12      JR  Z,FAT1
001A9C E7BB 19              11      ADD HL,DE
001A9D E7BC 93               4      SUB E
001A9E E7BD 30F9            12      JR  NC,FAT_SKP
001AA0 E7BF DDCB0146        20      BIT 0,(IX+DPB_FATLN+1)  ;FATサイズが0100H(256)の場合
001AA4 E7C3 C8              11      RET Z
       E7C4                     FAT1:
001AA5 E7C4 EB               4      EX  DE,HL
001AA6 E7C5 B7               4      OR  A       ;0の場合は0100Hとして扱う
001AA7 E7C6 2803            12      JR  Z,FAT3
001AA9 E7C8 B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001AAA E7C9 3801            12      JR  C,FAT2
       E7CB                     FAT3:
001AAC E7CB 79               4      LD  A,C
       E7CC                     FAT2:
001AAD E7CC 47               4      LD  B,A
                                
001AAE E7CD 2AFAF1          16      LD  HL,(_FATPS) ;fat sector pos
001AB1 E7D0 19              11      ADD HL,DE
001AB2 E7D1 EB               4      EX  DE,HL
001AB3 E7D2 2A7CF1          16      LD  HL,(_FATBF)
001AB6 E7D5 AF               4      XOR A       ;CF=0
001AB7 E7D6 4F               4      LD  C,A
001AB8 E7D7 C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       E7D8                     FATSETUP12:
001AB9 E7D8 110606          10      LD  DE,0606H    ;256
001ABC E7DB D8              11      RET C
001ABD E7DC 110303          10      LD  DE,0303H    ;512
001AC0 E7DF 0F               4      RRCA
001AC1 E7E0 D8              11      RET C
001AC2 E7E1 110102          10      LD  DE,0201H    ;1024
001AC5 E7E4 C9              10      RET
                                
       E7E5                     FATSETUP16:
001AC6 E7E5 110404          10      LD  DE,0404H    ;256
001AC9 E7E8 D8              11      RET C
001ACA E7E9 110202          10      LD  DE,0202H    ;512
001ACD E7EC 0F               4      RRCA
001ACE E7ED D8              11      RET C
001ACF E7EE 110101          10      LD  DE,0101H    ;1024
001AD2 E7F1 C9              10      RET
                                
       E7F2                     CHGDRV:
001AD3 E7F2 E5              11      PUSH    HL
001AD4 E7F3 2189F0          10      LD  HL,_DSK
001AD7 E7F6 BE               7      CP  (HL)
001AD8 E7F7 280A            12      JR  Z,CHGDRVE
       E7F9                     CHGDRV1:
001ADA E7F9 DDE5            15      PUSH    IX
001ADC E7FB CD05E8          17      CALL    CHGDRV0
001ADF E7FE 3A89F0          13      LD  A,(_DSK)
001AE2 E801 DDE1            14      POP IX
       E803                     CHGDRVE:
001AE4 E803 E1              10      POP HL
001AE5 E804 C9              10      RET
                                
       E805                     CHGDRV0:
001AE6 E805 6F               4      LD  L,A
001AE7 E806 CDDCF0          17      CALL    _GETDPB
001AEA E809 D8              11      RET C
001AEB E80A DD22A8F0        20      LD  (_DPB),IX
001AEF E80E 7D               4      LD  A,L
001AF0 E80F 3289F0          13      LD  (_DSK),A
       E812                     CHGDRV2:
001AF3 E812 C5              11      PUSH    BC
001AF4 E813 D5              11      PUSH    DE
001AF5 E814 ED735DE8        20      LD  (SPPAT2),SP
001AF9 E818 F3               4      DI
001AFA E819 DDF9            10      LD  SP,IX
                                
001AFC E81B E1              10      POP HL      ;00:DPB_FATLN
001AFD E81C E1              10      POP HL      ;02:DPB_DRD
001AFE E81D 2287E7          16      LD  (DRDPAT),HL
                                
001B01 E820 E1              10      POP HL
001B02 E821 2295E7          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001B05 E824 E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001B06 E825 7C               4      LD  A,H
001B07 E826 3289DE          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001B0A E829 3D               4      DEC A
001B0B E82A 32F0E5          13      LD  (_NCPAT),A
                                
001B0E E82D E1              10      POP HL      ;08:DPB_MAXCL
001B0F E82E 7D               4      LD  A,L
001B10 E82F 32A8DE          13      LD  (CLPAT2),A
001B13 E832 7C               4      LD  A,H
001B14 E833 32A4DE          13      LD  (CLPAT1),A
001B17 E836 2B               6      DEC HL
001B18 E837 22A7E0          16      LD  (MAXCLP),HL
                                
001B1B E83A E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001B1C E83B 4C               4      LD  C,H
                                
001B1D E83C E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001B1E E83D E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001B1F E83E 7C               4      LD  A,H     ;DPB_BPS
001B20 E83F E607             7      AND 7
001B22 E841 3262E3          13      LD  (SECSZ_H),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98等
                                                ;1セクタ256 GRAM/RAMF/CMOS等
                                                ;1024   512 256
                                                ;4  2   1
001B25 E844 87               4      ADD A,A     ;8  4   2
001B26 E845 87               4      ADD A,A     ;010H   8   4
001B27 E846 87               4      ADD A,A     ;020H   010H    8
001B28 E847 3207DD          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001B2B E84A 2600             7      LD  H,0
001B2D E84C 22FAF1          16      LD  (_FATPS),HL
                                
001B30 E84F E1              10      POP HL      ;10:DPB_DIRPS
001B31 E850 22FCF1          16      LD  (_DIRPS),HL
                                
001B34 E853 E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001B35 E854 7C               4      LD  A,H
001B36 E855 3284F0          13      LD  (_DRIVE),A
                                
001B39 E858 E1              10      POP HL      ;14:DPB_ADDCL
001B3A E859 2299DE          16      LD  (CLSPAT),HL
                                
001B3D E85C 310000          10      LD  SP,0        ;元のSPを復元
       E85D                     SPPAT2  EQU $-2
001B40 E85F FB               4      EI
001B41 E860 2AFCF1          16      LD  HL,(_DIRPS)
001B44 E863 0600             7      LD  B,0
001B46 E865 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001B47 E866 2222DD          16      LD  (MD_PAT),HL
                                
001B4A E869 2AA7E0          16      LD  HL,(MAXCLP)
001B4D E86C 110AF0          10      LD  DE,0-4086   ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001B50 E86F 19              11      ADD HL,DE
001B51 E870 380F            12      JR  C,SETFAT16
001B53 E872 2176E5          10      LD  HL,GNCL     ;FAT12
001B56 E875 1199E5          10      LD  DE,SNCL
001B59 E878 01D8E7          10      LD  BC,FATSETUP12
001B5C E87B DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001B60 E87F 180D            12      JR  EXTRA1
       E881                     SETFAT16:
001B62 E881 21CDE5          10      LD  HL,GNCL16   ;FAT16
001B65 E884 11DAE5          10      LD  DE,SNCL16
001B68 E887 01E5E7          10      LD  BC,FATSETUP16
001B6B E88A DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       E88E                     EXTRA1:
001B6F E88E 22F8F0          16      LD  (GNCPAT),HL
001B72 E891 ED53FBF0        20      LD  (SNCPAT),DE
001B76 E895 ED43A9E7        20      LD  (FATSX),BC
001B7A E899 D1              10      POP DE
001B7B E89A C1              10      POP BC
001B7C E89B AF               4      XOR A
001B7D E89C C9              10      RET
                                
       E89D                     GETDPBD:
001B7E E89D DDE3            23      EX  (SP),IX
001B80 E89F DDE5            15      PUSH    IX
001B82 E8A1 3A88F0          13      LD  A,(_DRV)
001B85 E8A4 1807            12      JR  GETDPB1
                                
       E8A6                     CHGDRVR:
001B87 E8A6 CDD9F0          17      CALL    _CHGDRV
001B8A E8A9 D8              11      RET C
001B8B E8AA 3A89F0          13      LD  A,(_DSK)
       E8AD                     GETDPB1:
001B8E E8AD C3DCF0          10      JP  _GETDPB
                                
       E8B0                     GETDPB:
001B91 E8B0 FE08             7      CP  8
001B93 E8B2 3F               4      CCF
001B94 E8B3 D8              11      RET C
001B95 E8B4 0F               4      RRCA
001B96 E8B5 0F               4      RRCA
001B97 E8B6 0F               4      RRCA
001B98 E8B7 DD                      DB  0DDH        ;Z80未定義命令
001B99 E8B8 6F               4      LD  L,A     ;LD IXL,A
001B9A E8B9 DD                      DB  0DDH        ;Z80未定義命令
001B9B E8BA 26F2             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
001B9D E8BC DD7E00          19      LD  A,(IX+DPB_FATLN)
001BA0 E8BF A7               4      AND A       ;CF=0の為
001BA1 E8C0 DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
001BA5 E8C4 C0              11      RET NZ      ;FAT16
001BA6 E8C5 DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001BAA E8C9 C0              11      RET NZ      ;BPB
001BAB E8CA FE01             7      CP  001H        ;A=0 THEN CF=1
001BAD E8CC C9              10      RET
                                
       E8CD                     _SYS5F:
001BAE E8CD AF               4      XOR A
       E8CE                     FFLUSH:
001BAF E8CE F5              11      PUSH    AF
001BB0 E8CF CDF4E4          17      CALL    WTFATX
001BB3 E8D2 AF               4      XOR A
001BB4 E8D3 32ABF0          13      LD  (_FATIX),A
001BB7 E8D6 2F               4      CPL         ;0FFH
001BB8 E8D7 32AAF0          13      LD  (_FATDRV),A
001BBB E8DA 3E                      DB  03EH        ;次のPUSH AFをスキップ
       E8DB                     FFLUSHBUF:
001BBC E8DB F5              11      PUSH    AF
001BBD E8DC CDAAE4          17      CALL    DWTX
001BC0 E8DF 3EFF             7      LD  A,0FFH
001BC2 E8E1 3239F0          13      LD  (SFILE),A
001BC5 E8E4 32A5F0          13      LD  (_DBDRV),A
001BC8 E8E7 F1              10      POP AF
001BC9 E8E8 C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   MZ-700/1500
                                
       E8E9                     SEEK:
001BCA E8E9 0610             7      LD  B,16
001BCC E8EB DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001BCF E8EE AF               4      XOR A
001BD0 E8EF EB               4      EX  DE,HL
       E8F0                     DIV1:
001BD1 E8F0 29              11      ADD HL,HL
001BD2 E8F1 8F               4      ADC A,A
001BD3 E8F2 B9               4      CP  C
001BD4 E8F3 3802            12      JR  C,DIV2
001BD6 E8F5 91               4      SUB C
001BD7 E8F6 2C               4      INC L
       E8F7                     DIV2:
001BD8 E8F7 10F7            13      DJNZ    DIV1
                                
001BDA E8F9 3C               4      INC A   ;最小のセクタは１固定
001BDB E8FA 55               4      LD  D,L ;TRACK
001BDC E8FB 5F               4      LD  E,A ;SECTOR
                                
001BDD E8FC 3A84F0          13      LD  A,(_DRIVE)
001BE0 E8FF FE04             7      CP  4
001BE2 E901 3F               4      CCF
001BE3 E902 D8              11      RET C
001BE4 E903 F684             7      OR  084H        ;Motor on + ドライブセレクト有効
001BE6 E905 D3DC            11      OUT (0DCH),A    ;モータ/ドライブセレクト制御レジスタ
001BE8 E907 CB3A             8      SRL D       ;CYLINDER
001BEA E909 9F               4      SBC A,A
001BEB E90A D3DD            11      OUT (0DDH),A    ;ヘッドセレクト制御レジスタ
                                
001BED E90C CD44E9          17      CALL    SETMODE
001BF0 E90F D8              11      RET C
                                
001BF1 E910 CD79E9          17      CALL    DRIVE
001BF4 E913 FEFF             7      CP  0FFH        ;A=0FFH Unknown CYLINDER
001BF6 E915 CC5BE9          17      CALL    Z,FDCRES    ;Restore
001BF9 E918 2F               4      CPL         ;データバスが負論理
001BFA E919 D3D9            11      OUT (0D9H),A    ;MB8876 トラックレジスタ
001BFC E91B 2F               4      CPL         ;データバスが負論理
001BFD E91C 92               4      SUB D
001BFE E91D C8              11      RET Z       ;No seek
                                
001BFF E91E DD7E0C          19      LD  A,(IX+DPB_MAXCYL)
001C02 E921 3D               4      DEC A
001C03 E922 BA               4      CP  D       ;Over CYLINDER
001C04 E923 D8              11      RET C
                                
001C05 E924 7A               4      LD  A,D
001C06 E925 2F               4      CPL         ;データバスが負論理
001C07 E926 D3DB            11      OUT (0DBH),A    ;MB8876 データレジスタ
001C09 E928 72               7      LD  (HL),D
                                
001C0A E929 0E18             7      LD  C,018H      ;FDC TypeIコマンド Seek
       E92B                     FDCCMD2:
001C0C E92B 3A85F0          13      LD  A,(_SEEKSP)
001C0F E92E B1               4      OR  C
                                
       E92F                     FDCCMD:
001C10 E92F CD70E9          17      CALL    COMSET
001C13 E932 3E80             7      LD  A,080H      ;FDC COMMAND(Self-modifying code)
       E933                     FDCSMC  EQU $-1
001C15 E934 E620             7      AND 020H        ;Write data Write track
001C17 E936 3C               4      INC A
                                
       E937                     SST:
001C18 E937 0E00             7      LD  C,0
       E939                     SST1:
001C1A E939 0D               4      DEC C       ; 4
001C1B E93A 20FD            12      JR  NZ,SST1     ;12 * 256 / 4 = About 1ms
001C1D E93C 3D               4      DEC A
001C1E E93D 20FA            12      JR  NZ,SST1
                                
001C20 E93F 0E01             7      LD  C,1
001C22 E941 CD49E9          17      CALL    READY
       E944                     SETMODE:
001C25 E944 CD73E9          17      CALL    DELAY0      ;Head select time
001C28 E947 0E81             7      LD  C,081H
       E949                     READY:
001C2A E949 0680             7      LD  B,128
       E94B                     READY2:
001C2C E94B DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001C2E E94D 2F               4      CPL         ;データバスが負論理
001C2F E94E A1               4      AND C       ;NOT READY,BUSY
001C30 E94F C8              11      RET Z
001C31 E950 CD39CF          17      CALL    RD556VSYNC
001C34 E953 07               4      RLCA
001C35 E954 A8               4      XOR B
001C36 E955 0F               4      RRCA
001C37 E956 30F3            12      JR  NC,READY2
001C39 E958 10F1            13      DJNZ    READY2
001C3B E95A C9              10      RET
                                
       E95B                     FDCRES:
001C3C E95B 3600            10      LD  (HL),0
001C3E E95D 0E08             7      LD  C,8     ;FDC TypeIコマンド Restore
001C40 E95F 18CA            12      JR  FDCCMD2
                                
       E961                     FDMOFF:
001C42 E961 F5              11      PUSH    AF
001C43 E962 AF               4      XOR A       ;Motor off(ドライブセレクト無効)
001C44 E963 D3DC            11      OUT (0DCH),A    ;モータ/ドライブセレクト制御レジスタ
001C46 E965 F1              10      POP AF
001C47 E966 C9              10      RET
                                
       E967                     SECSET_FDCCMD:
001C48 E967 3A33E9          13      LD  A,(FDCSMC)
       E96A                     SECSET:
001C4B E96A F5              11      PUSH    AF
001C4C E96B 7B               4      LD  A,E
001C4D E96C 2F               4      CPL         ;データバスが負論理
001C4E E96D D3DA            11      OUT (0DAH),A    ;MB8876 セクタレジスタ
001C50 E96F F1              10      POP AF
       E970                     COMSET:
001C51 E970 2F               4      CPL         ;データバスが負論理
001C52 E971 D3D8            11      OUT (0D8H),A    ;MB8876 ステータス/コマンドレジスタ
       E973                     DELAY0:
001C54 E973 3E1A             7      LD  A,26
       E975                     DELAY:
001C56 E975 3D               4      DEC A
001C57 E976 20FD            12      JR  NZ,DELAY
001C59 E978 C9              10      RET
                                
       E979                     DRIVE:                  ;ドライブのシリンダを得る
001C5A E979 2A84F0          16      LD  HL,(_DRIVE)
001C5D E97C 26F0             7      LD  H,_CYL0/256
001C5F E97E CBFD             8      SET 7,L
001C61 E980 7E               7      LD  A,(HL)
001C62 E981 C9              10      RET
                                
       E982                     RNF:                    ;ドライブのシリンダをリセット
001C63 E982 CD79E9          17      CALL    DRIVE
001C66 E985 36FF            10      LD  (HL),0FFH
001C68 E987 C9              10      RET
                                
001C69 E988 02                  RETRY:  DB  2
                                
                                
                                ;   FLOPPY DISK DRIVER
                                
       E989                     WTTRK:
001C6A E989 0601             7      LD  B,1
001C6C E98B 3EF4             7      LD  A,0F4H      ;FDC TypeIIIコマンド Write Track
001C6E E98D 1802            12      JR  WTTRK1
       E98F                     FDWT:
001C70 E98F 3EA0             7      LD  A,0A0H      ;FDC TypeIIコマンド Write Sector
       E991                     WTTRK1:
001C72 E991 3233E9          13      LD  (FDCSMC),A
       E994                     DWTBL:
001C75 E994 78               4      LD  A,B
001C76 E995 32D1E9          13      LD  (WTBSMC),A
001C79 E998 3E02             7      LD  A,2     ;Retry count
001C7B E99A 3288E9          13      LD  (RETRY),A
                                
       E99D                     DWT0:
001C7E E99D D5              11      PUSH    DE
001C7F E99E E5              11      PUSH    HL
001C80 E99F CDE9E8          17      CALL    SEEK        ;Write disk
001C83 E9A2 E1              10      POP HL
001C84 E9A3 3837            12      JR  C,ERRDW
001C86 E9A5 F3               4      DI
001C87 E9A6 CD67E9          17      CALL    SECSET_FDCCMD
001C8A E9A9 0EDB             7      LD  C,0DBH      ;MB8876 データレジスタ
       E9AB                     DWT1:
001C8C E9AB 7E               7      LD  A,(HL)
001C8D E9AC 2F               4      CPL         ;データバスが負論理
001C8E E9AD 57               4      LD  D,A
                                
       E9AE                     DWT2:
001C8F E9AE DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001C91 E9B0 2F               4      CPL         ;データバスが負論理
001C92 E9B1 0F               4      RRCA
001C93 E9B2 3008            12      JR  NC,DWT4
001C95 E9B4 0F               4      RRCA
001C96 E9B5 30F7            12      JR  NC,DWT2
       E9B7                     DWT3:
001C98 E9B7 ED51            12      OUT (C),D       ;MB8876 データレジスタ
001C9A E9B9 23               6      INC HL
001C9B E9BA 18EF            12      JR  DWT1
                                
       E9BC                     DWT4:
001C9D E9BC 3D               4      DEC A
001C9E E9BD 28F8            12      JR  Z,DWT3
001CA0 E9BF 3C               4      INC A
001CA1 E9C0 FB               4      EI
001CA2 E9C1 D1              10      POP DE
001CA3 E9C2 13               6      INC DE
001CA4 E9C3 CD61E9          17      CALL    FDMOFF
001CA7 E9C6 2808            12      JR  Z,DISKOK_WT
001CA9 E9C8 CD30EA          17      CALL    DISKC
001CAC E9CB 20D0            12      JR  NZ,DWT0
001CAE E9CD B7               4      OR  A
001CAF E9CE 2005            12      JR  NZ,ERRW
                                
       E9D0                     DISKOK_WT:
001CB1 E9D0 0601             7      LD  B,1
       E9D1                     WTBSMC  EQU $-1
001CB3 E9D2 10C0            13      DJNZ    DWTBL
001CB5 E9D4 C9              10      RET
                                
       E9D5                     ERRW:
001CB6 E9D5 3EFF             7      LD  A,0FFH
       E9D7                     ERRZ:
001CB8 E9D7 BF               4      CP  A       ;ZF=1
001CB9 E9D8 37               4      SCF
001CBA E9D9 C361E9          10      JP  FDMOFF
                                
       E9DC                     ERRDW:
001CBD E9DC D1              10      POP DE
001CBE E9DD CD41EA          17      CALL    DELP
001CC1 E9E0 20BB            12      JR  NZ,DWT0
001CC3 E9E2 B7               4      OR  A
001CC4 E9E3 20F0            12      JR  NZ,ERRW
001CC6 E9E5 C9              10      RET
                                
       E9E6                     FDRD:
001CC7 E9E6 3E80             7      LD  A,080H      ;FDC TypeIIコマンド Read Sector
001CC9 E9E8 3233E9          13      LD  (FDCSMC),A
       E9EB                     DRDBL:
001CCC E9EB 78               4      LD  A,B
001CCD E9EC 3222EA          13      LD  (RDBSMC),A
001CD0 E9EF 3E02             7      LD  A,2     ;Retry count
001CD2 E9F1 3288E9          13      LD  (RETRY),A
       E9F4                     DRD0:
001CD5 E9F4 D5              11      PUSH    DE
001CD6 E9F5 E5              11      PUSH    HL
001CD7 E9F6 CDE9E8          17      CALL    SEEK        ;Read disk
001CDA E9F9 E1              10      POP HL
001CDB E9FA 382A            12      JR  C,ERRDR
001CDD E9FC F3               4      DI
001CDE E9FD CD67E9          17      CALL    SECSET_FDCCMD
       EA00                     DRD1:
001CE1 EA00 DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001CE3 EA02 2F               4      CPL         ;データバスが負論理
001CE4 EA03 0F               4      RRCA
001CE5 EA04 300A            12      JR  NC,DRD3
001CE7 EA06 0F               4      RRCA
001CE8 EA07 30F7            12      JR  NC,DRD1
001CEA EA09 DBDB            11      IN  A,(0DBH)    ;MB8876 データレジスタ
001CEC EA0B 2F               4      CPL         ;データバスが負論理
001CED EA0C 77               7      LD  (HL),A
001CEE EA0D 23               6      INC HL
001CEF EA0E 18F0            12      JR  DRD1
                                
       EA10                     DRD3:
001CF1 EA10 B7               4      OR  A
001CF2 EA11 FB               4      EI
001CF3 EA12 D1              10      POP DE
001CF4 EA13 13               6      INC DE
001CF5 EA14 CD61E9          17      CALL    FDMOFF
001CF8 EA17 2808            12      JR  Z,DISKOK_RD
001CFA EA19 CD30EA          17      CALL    DISKC
001CFD EA1C 20D6            12      JR  NZ,DRD0
001CFF EA1E B7               4      OR  A
001D00 EA1F 20B4            12      JR  NZ,ERRW
                                
       EA21                     DISKOK_RD:
001D02 EA21 0601             7      LD  B,1
       EA22                     RDBSMC  EQU $-1
001D04 EA23 10C6            13      DJNZ    DRDBL
001D06 EA25 C9              10      RET
                                
       EA26                     ERRDR:
001D07 EA26 D1              10      POP DE
001D08 EA27 CD41EA          17      CALL    DELP
001D0B EA2A 20C8            12      JR  NZ,DRD0
001D0D EA2C B7               4      OR  A
001D0E EA2D 20A6            12      JR  NZ,ERRW
001D10 EA2F C9              10      RET
       EA30                     DISKC:
001D11 EA30 1B               6      DEC DE
001D12 EA31 CB5F             8      BIT 3,A
001D14 EA33 C482E9          17      CALL    NZ,RNF
       EA36                     DISKD:
001D17 EA36 E5              11      PUSH    HL
001D18 EA37 2188E9          10      LD  HL,RETRY
001D1B EA3A 35              11      DEC (HL)
001D1C EA3B E1              10      POP HL
001D1D EA3C 200C            12      JR  NZ,ERR      ;Retry
001D1F EA3E B7               4      OR  A
001D20 EA3F 2809            12      JR  Z,ERR       ;Error
                                
       EA41                     DELP:
001D22 EA41 CD82E9          17      CALL    RNF
001D25 EA44 CD61E9          17      CALL    FDMOFF
001D28 EA47 3EFF             7      LD  A,0FFH
       EA49                     AERRZ:
001D2A EA49 BF               4      CP  A
       EA4A                     ERR:
001D2B EA4A 3EFF             7      LD  A,0FFH
001D2D EA4C C9              10      RET
[EOF:M7DISK.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   MZ-700/1500
                                
                                ;   EMM DRIVER
                                ;   1セクタ可変(256/512/1024)
                                
       EA4D                     EDWT:
001D2E EA4D F5              11      PUSH    AF
001D2F EA4E CD6CEA          17      CALL    EADR
001D32 EA51 0600             7      LD  B,0
       EA53                     EDWT1:
001D34 EA53 EDB3                    OTIR
001D36 EA55 3D               4      DEC A
001D37 EA56 20FB            12      JR  NZ,EDWT1
001D39 EA58 180B            12      JR  EDRW1
                                
       EA5A                     EDRD:
001D3B EA5A C5              11      PUSH    BC
001D3C EA5B CD6CEA          17      CALL    EADR
001D3F EA5E 0600             7      LD  B,0
       EA60                     EDRD1:
001D41 EA60 EDB2                    INIR
001D43 EA62 3D               4      DEC A
001D44 EA63 20FB            12      JR  NZ,EDRD1
       EA65                     EDRW1:
001D46 EA65 F1              10      POP AF
001D47 EA66 83               4      ADD A,E ;セクタを進める
001D48 EA67 5F               4      LD  E,A
001D49 EA68 8A               4      ADC A,D
001D4A EA69 93               4      SUB E
001D4B EA6A 57               4      LD  D,A
001D4C EA6B C9              10      RET
                                
       EA6C                     EADR:
001D4D EA6C D5              11      PUSH    DE
001D4E EA6D EB               4      EX  DE,HL
001D4F EA6E 78               4      LD  A,B
001D50 EA6F DD460F          19      LD  B,(IX+DPB_BPS)
       EA72                     EADR1:              ;読み込むセクタ数と1クラスタのセクタ数を掛ける
001D53 EA72 CB18             8      RR  B
001D55 EA74 3804            12      JR  C,EADR2
001D57 EA76 87               4      ADD A,A
001D58 EA77 29              11      ADD HL,HL
001D59 EA78 18F8            12      JR  EADR1
       EA7A                     EADR2:
001D5B EA7A DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001D5E EA7D DD460C          19      LD  B,(IX+DPB_MAXCYL)
001D61 EA80 09              11      ADD HL,BC
001D62 EA81 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001D65 EA84 ED71            12      OUT (C),0       ;Z80未定義命令
001D67 EA86 0C               4      INC C
001D68 EA87 ED69            12      OUT (C),L
001D6A EA89 0C               4      INC C
001D6B EA8A ED61            12      OUT (C),H
001D6D EA8C 0C               4      INC C
001D6E EA8D EB               4      EX  DE,HL
001D6F EA8E D1              10      POP DE
001D70 EA8F C9              10      RET
                                
                                ;   CMOS BACKUP MEMORY DRIVER(32KB)
                                ;   1セクタ256
                                
       EA90                     CDWT:
001D71 EA90 78               4      LD  A,B
001D72 EA91 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001D75 EA94 ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001D77 EA96 ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001D79 EA98 01FA00          10      LD  BC,000FAH
       EA9B                     CDWT1:
001D7C EA9B EDB3                    OTIR            ;W)データ書き込み・アドレスカウンタ+1
001D7E EA9D 13               6      INC DE
001D7F EA9E 3D               4      DEC A
001D80 EA9F 20FA            12      JR  NZ,CDWT1
001D82 EAA1 A7               4      AND A
001D83 EAA2 C9              10      RET
                                
       EAA3                     CDRD:
001D84 EAA3 78               4      LD  A,B
001D85 EAA4 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001D88 EAA7 ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001D8A EAA9 ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001D8C EAAB 01F900          10      LD  BC,000F9H
       EAAE                     CDRD1:
001D8F EAAE EDB2                    INIR            ;R)データ読み出し・アドレスカウンタ+1
001D91 EAB0 13               6      INC DE
001D92 EAB1 3D               4      DEC A
001D93 EAB2 20FA            12      JR  NZ,CDRD1
001D95 EAB4 A7               4      AND A
001D96 EAB5 C9              10      RET
                                
                                ;   RAM DISK DRIVER (64KB)
                                ;   1セクタ256
                                
       EAB6                     RDWT:
001D97 EAB6 3EB3             7      LD  A,0B3H      ;OTIR
001D99 EAB8 1802            12      JR  RDRW
       EABA                     RDRD:
001D9B EABA 3EB2             7      LD  A,0B2H      ;INIR
       EABC                     RDRW:
001D9D EABC 32C9EA          13      LD  (RDRW_SWC),A
                                
001DA0 EABF 78               4      LD  A,B
001DA1 EAC0 43               4      LD  B,E     ;B=アドレスカウンタ上位(X1の様な16bitのI/Oアクセス)
001DA2 EAC1 0EEB             7      LD  C,0EBH
001DA4 EAC3 ED71            12      OUT (C),0       ;0=アドレスカウンタ下位
001DA6 EAC5 0D               4      DEC C       ;EA(R)データ読み出し・アドレスカウンタ+1
001DA7 EAC6 0600             7      LD  B,0
       EAC8                     RDRW1:
001DA9 EAC8 EDB2                    INIR            ;自己書き換え(INIR/OTIR)
       EAC9                     RDRW_SWC    EQU $-1
001DAB EACA 13               6      INC DE
001DAC EACB 3D               4      DEC A
001DAD EACC 20FA            12      JR  NZ,RDRW1
001DAF EACE A7               4      AND A
001DB0 EACF C9              10      RET
                                
                                ;   G-RAM(PCG) DISK DRIVER (24KB)
                                ;   1セクタ256
                                
       EAD0                     GDWT:
001DB1 EAD0 C5              11      PUSH    BC
001DB2 EAD1 D5              11      PUSH    DE
001DB3 EAD2 CDFAEA          17      CALL    GADR
       EAD5                     GDWT2:
001DB6 EAD5 4E               7      LD  C,(HL)
001DB7 EAD6 23               6      INC HL
001DB8 EAD7 EB               4      EX  DE,HL   ;HL=PCG,DE=メモリ
001DB9 EAD8 CDC0CF          17      CALL    WR_PCG
001DBC EADB 23               6      INC HL
001DBD EADC EB               4      EX  DE,HL   ;HL=メモリ,DE=PCG
001DBE EADD 10F6            13      DJNZ    GDWT2
001DC0 EADF D1              10      POP DE
001DC1 EAE0 1C               4      INC E
001DC2 EAE1 C1              10      POP BC
001DC3 EAE2 10EC            13      DJNZ    GDWT
001DC5 EAE4 C9              10      RET
       EAE5                     GDRD:
001DC6 EAE5 C5              11      PUSH    BC
001DC7 EAE6 D5              11      PUSH    DE
001DC8 EAE7 CDFAEA          17      CALL    GADR
       EAEA                     GDRD2:
001DCB EAEA EB               4      EX  DE,HL   ;HL=PCG,DE=メモリ
001DCC EAEB CDB8CF          17      CALL    RD_PCG
001DCF EAEE 23               6      INC HL
001DD0 EAEF EB               4      EX  DE,HL   ;HL=メモリ,DE=PCG
001DD1 EAF0 71               7      LD  (HL),C
001DD2 EAF1 23               6      INC HL
001DD3 EAF2 10F6            13      DJNZ    GDRD2
001DD5 EAF4 D1              10      POP DE
001DD6 EAF5 1C               4      INC E
001DD7 EAF6 C1              10      POP BC
001DD8 EAF7 10EC            13      DJNZ    GDRD
001DDA EAF9 C9              10      RET
                                
       EAFA                     GADR:
001DDB EAFA 7B               4      LD  A,E
001DDC EAFB E61F             7      AND 01FH
001DDE EAFD C6D0             7      ADD A,0D0H
001DE0 EAFF 57               4      LD  D,A
001DE1 EB00 7B               4      LD  A,E
001DE2 EB01 07               4      RLCA
001DE3 EB02 07               4      RLCA
001DE4 EB03 07               4      RLCA
001DE5 EB04 3C               4      INC A
001DE6 EB05 0600             7      LD  B,0
001DE8 EB07 58               4      LD  E,B
001DE9 EB08 C9              10      RET
[EOF:M7DISK2.ASM:UTF_8]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
001DEA EB09                     PATHD:  DS  PATHX
001E25 EB44 00                  PATHE:  DB  0
                                
       EB45                     DTA_CCP:
001E26 EB45                         DS  37
                                
       EB6A                     FCB_BAT:
001E4B EB6A                         DS  37
                                
001E70 EB8F 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
001E7B EB9A 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "M7TABLE.ASM"
                                
                                ;   LSX-Dodgers TABLE 表示関連のテーブル
                                ;   MZ-700/1500
                                
       EBA1                     AT_TABLE:
001E82 EBA1                         DS  TABLEAD-AT_TABLE
                                
       ED40                     KEY_TABLE:
002021 ED40 12081E1F1C1D5C2F        DB  12H,08H,1EH,1FH,1CH,1DH,5CH,'/'
002029 ED48 5C5E2D2030392C2E        DB  5CH,'^','-',20H,'0','9',',','.'
002031 ED50 3132333435363738        DB  '1','2','3','4','5','6','7','8'
002039 ED58 6162636465666768        DB  'a','b','c','d','e','f','g','h'
002041 ED60 696A6B6C6D6E6F70        DB  'i','j','k','l','m','n','o','p'
002049 ED68 7172737475767778        DB  'q','r','s','t','u','v','w','x'
002051 ED70 797A405B5D000000        DB  'y','z','@','[',']',00H,00H,00H
002059 ED78 001B3D09003B3A0D        DB  00H,1BH,'=',09H,00H,';',':',0DH
       ED80                     SHIFT_TABLE:
002061 ED80 12081E1F1C1D5F3F        DB  12H,08H,1EH,1FH,1CH,1DH,'_','?'
002069 ED88 7C7E3D2030293C3E        DB  '|','~','=',20H,'0',')','<','>'
002071 ED90 2122232425262728        DB  '!','"','#','$','%','&',27H,'('
002079 ED98 4142434445464748        DB  'A','B','C','D','E','F','G','H'
002081 EDA0 494A4B4C4D4E4F50        DB  'I','J','K','L','M','N','O','P'
002089 EDA8 5152535455565758        DB  'Q','R','S','T','U','V','W','X'
002091 EDB0 595A607B7D000000        DB  'Y','Z','`','{','}',00H,00H,00H
002099 EDB8 00003D09002B2A0D        DB  00H,00H,'=',09H,00H,'+','*',0DH
       EDC0                     CTRL_TABLE:
0020A1 EDC0 12081E1F1C1D3F2F        DB  12H,08H,1EH,1FH,1CH,1DH,'?','/'
0020A9 EDC8 2A2B2D2030392C2E        DB  '*','+','-',20H,'0','9',',','.'
0020B1 EDD0 3132333435363738        DB  '1','2','3','4','5','6','7','8'
0020B9 EDD8 0102030405060708        DB  01H,02H,03H,04H,05H,06H,07H,08H
0020C1 EDE0 090A0B0C0D0E0F10        DB  09H,0AH,0BH,0CH,0DH,0EH,0FH,10H
0020C9 EDE8 1112131415161718        DB  11H,12H,13H,14H,15H,16H,17H,18H
0020D1 EDF0 191A1B5B5D000000        DB  19H,1AH,1BH,'[',']',00H,00H,00H
0020D9 EDF8 00003D09003B3A0D        DB  00H,00H,'=',09H,00H,';',':',0DH
                                
                                ;   アドレス下位1バイトが0になるように
       EE00                     CD_TABLE:
0020E1 EE00 00D1D2D3D4D5D6D0        DB  $00,$D1,$D2,$D3,$D4,$D5,$D6,$D0 ;月火水木金土日
0020E9 EE08 D8DCD9DADBD7CFCE        DB  $D8,$DC,$D9,$DA,$DB,$D7,$CF,$CE ;年円時分秒
0020F1 EE10 601F5F5E1E1B7978        DB  $60,$1F,$5F,$5E,$1E,$1B,$79,$78 ;
0020F9 EE18 5C5D1C1D6DCACDC7        DB  $5C,$5D,$1C,$1D,$6D,$CA,$CD,$C7 ;
002101 EE20 0061626364656667        DB  $00,$61,$62,$63,$64,$65,$66,$67 ; !"#$%&'
002109 EE28 68696B6A2F2A2E2D        DB  $68,$69,$6B,$6A,$2F,$2A,$2E,$2D ;()*+,-./
002111 EE30 2021222324252627        DB  $20,$21,$22,$23,$24,$25,$26,$27 ;01234567
002119 EE38 28294F2C512B5749        DB  $28,$29,$4F,$2C,$51,$2B,$57,$49 ;89:;<=>?
002121 EE40 5501020304050607        DB  $55,$01,$02,$03,$04,$05,$06,$07 ;@ABCDEFG
002129 EE48 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;HIJKLMNO
002131 EE50 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;PQRSTUVW
002139 EE58 18191A52DD54E37C        DB  $18,$19,$1A,$52,$DD,$54,$E3,$7C ;XYZ[\]^_
002141 EE60 5901020304050607        DB  $59,$01,$02,$03,$04,$05,$06,$07 ;`abcdefg   ATB:1
002149 EE68 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;hijklmno   ATB:1
002151 EE70 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;pqrstuvw   ATB:1
002159 EE78 18191ACB35CC705A        DB  $18,$19,$1A,$CB,$35,$CC,$70,$5A ;xyz{|}~    ATB:1
002161 EE80 415346444847B49E        DB  $41,$53,$46,$44,$48,$47,$B4,$9E ;トランプ〇●をぁ   ATB:1
002169 EE88 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ぃぅぇぉゃゅょっ   ATB:1
002171 EE90 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーあいうえおかき   ATB:1
002179 EE98 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;くけこさしすせそ   ATB:1
002181 EEA0 F0BD9DB1B5B9B49E        DB  $F0,$BD,$9D,$B1,$B5,$B9,$B4,$9E ;　。「」、・ヲァ
002189 EEA8 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ィゥェォャョュッ
002191 EEB0 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーアイウエオカキ
002199 EEB8 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;クケコサシスセソ
0021A1 EEC0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;タチツテトナニヌ
0021A9 EEC8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ネノハヒフヘホマ
0021B1 EED0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;ミムメモヤユヨラ
0021B9 EED8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;リルレロワン゛゜
0021C1 EEE0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;たちつてとねにぬ   ATB:1
0021C9 EEE8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ねのはひふへほま   ATB:1
0021D1 EEF0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;みむめもやゆよら   ATB:1
0021D9 EEF8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;りるれろわん゛゜   ATB:1
       EF00                     DC_TABLE:
0021E1 EF00 2041424344454647        DB  $20,$41,$42,$43,$44,$45,$46,$47 ;0
0021E9 EF08 48494A4B4C4D4E4F        DB  $48,$49,$4A,$4B,$4C,$4D,$4E,$4F
0021F1 EF10 5051525354555657        DB  $50,$51,$52,$53,$54,$55,$56,$57 ;1
0021F9 EF18 58595A151A1B1411        DB  $58,$59,$5A,$15,$1A,$1B,$14,$11
002201 EF20 3031323334353637        DB  $30,$31,$32,$33,$34,$35,$36,$37 ;2
002209 EF28 38392D3D3B2F2E2C        DB  $38,$39,$2D,$3D,$3B,$2F,$2E,$2C
002211 EF30 00000000007C0000        DB  $00,$00,$00,$00,$00,$7C,$00,$00 ;3
002219 EF38 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
002221 EF40 0080000083008285        DB  $00,$80,$00,$00,$83,$00,$82,$85 ;4
002229 EF48 843F00000000003A        DB  $84,$3F,$00,$00,$00,$00,$00,$3A
002231 EF50 5E3C5B815D40003E        DB  $5E,$3C,$5B,$81,$5D,$40,$00,$3E ;5
002239 EF58 00607F0018191312        DB  $00,$60,$7F,$00,$18,$19,$13,$12
002241 EF60 1021222324252627        DB  $10,$21,$22,$23,$24,$25,$26,$27 ;6
002249 EF68 28292B2A001C0000        DB  $28,$29,$2B,$2A,$00,$1C,$00,$00
002251 EF70 7E00000000000000        DB  $7E,$00,$00,$00,$00,$00,$00,$00 ;7
002259 EF78 171600005F000000        DB  $17,$16,$00,$00,$5F,$00,$00,$00
002261 EF80 00C19A9F9C92CA97        DB  $00,$C1,$9A,$9F,$9C,$92,$CA,$97 ;8
002269 EF88 98C6CFC9D8D3D0D7        DB  $98,$C6,$CF,$C9,$D8,$D3,$D0,$D7
002271 EF90 9EC09DC496C5CBC3        DB  $9E,$C0,$9D,$C4,$96,$C5,$CB,$C3 ;9
002279 EF98 9BDDC2DB99A2878C        DB  $9B,$DD,$C2,$DB,$99,$A2,$87,$8C
002281 EFA0 DCC7CC91939495D4        DB  $DC,$C7,$CC,$91,$93,$94,$95,$D4 ;A
002289 EFA8 D5D6CECDDAD2D9C8        DB  $D5,$D6,$CE,$CD,$DA,$D2,$D9,$C8
002291 EFB0 D1A3888D86A4898E        DB  $D1,$A3,$88,$8D,$86,$A4,$89,$8E ;B
002299 EFB8 DFA58A8FDEA18B90        DB  $DF,$A5,$8A,$8F,$DE,$A1,$8B,$90
0022A1 EFC0 000000000000001F        DB  $00,$00,$00,$00,$00,$00,$00,$1F ;C
0022A9 EFC8 00001D7B7D1E0F0E        DB  $00,$00,$1D,$7B,$7D,$1E,$0F,$0E
0022B1 EFD0 070102030405060D        DB  $07,$01,$02,$03,$04,$05,$06,$0D ;D
0022B9 EFD8 080A0B0C095C0000        DB  $08,$0A,$0B,$0C,$09,$5C,$00,$00
0022C1 EFE0 0000005E00000000        DB  $00,$00,$00,$5E,$00,$00,$00,$00 ;E
0022C9 EFE8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
0022D1 EFF0 A000000000000000        DB  $A0,$00,$00,$00,$00,$00,$00,$00 ;F
0022D9 EFF8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
[EOF:M7TABLE.ASM:SHIFT_JIS]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
                                ;   ALIGN   256
       F000                     AT_WORK:
0022E1 F000                         DS  WORKAD-AT_WORK
                                
       F000                     CPM_BOOT:
0022E1 F000 C30000          10      JP  0
       F003                     _SYS00:     ;(BDOS)プログラム終了
       F003                     CPM_WBOOT:
0022E4 F003 C3FECF          10      JP  WBOOT1
       F006                     CPM_CONST:
0022E7 F006 C3ACD7          10      JP  CONSTX
       F009                     _SYS07:     ;(BDOS)コンソール直接入力
       F009                     CPM_CONIN:
0022EA F009 C345D7          10      JP  FLGET
       F00C                     CPM_CONOUT:
0022ED F00C C350D9          10      JP  CONOUT1
                                
       F00F                     DECBF:              ;10進数表示時のバッファ(5バイト)
0022F0 F00F                         DS  5
       F00F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       F011                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
       F014                     FDRV:
0022F5 F014 00                      DB  0
       F015                     FNAME:
0022F6 F015                         DS  36
       F039                     SFILE:
00231A F039                         DS  33      ;DRV FILENAME
       F05A                     _DISKE:
00233B F05A C30FD7          10      JP  SHOW_ERROR
                                
00233E F05D 0000                LEFTX:  DW  0
002340 F05F 0000                DTAX:   DW  0
                                
                                ;   PSGのビープ音のデータ(X1)
       F061                     BEEPD:
002342 F061 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
00234A F069 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
                                ;
       F062                     RTC_YY  EQU BEEPD+1 ;RTCのバッファ年(88)
       F063                     RTC_MW  EQU BEEPD+2 ;RTCのバッファ月(88)
       F064                     RTC_DD  EQU BEEPD+3 ;RTCのバッファ日(88)
       F065                     RTC_TT  EQU BEEPD+4 ;RTCのバッファ時(88)
       F066                     RTC_MM  EQU BEEPD+5 ;RTCのバッファ分(88)
       F067                     RTC_SS  EQU BEEPD+6 ;RTCのバッファ秒(88)
       F062                     ROM_SLT EQU BEEPD+1 ;ROMのスロット(MSX)
       F061                     ZERO    EQU BEEPD
                                
       F070                     CHECK:
002351 F070 00                      DB  0
                                
       F071                     OK:
002352 F071 4F4B24                  DB  "OK$"
002355 F074                         DS  5
       F079                     COMERM:
00235A F079 4572726F722124          DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
       F080                     _CYL0:
002361 F080 FF                      DB  0FFH    ;Cylinder
       F081                     _CYL1:
002362 F081 FF                      DB  0FFH    ;Cylinder
       F082                     _CYL2:
002363 F082 FF                      DB  0FFH    ;Cylinder
       F083                     _CYL3:
002364 F083 FF                      DB  0FFH    ;Cylinder
       F084                     _DRIVE:
002365 F084 00                      DB  0   ;unit number
       F085                     _SEEKSP:
002366 F085 00                      DB  0   ;Seek speed
       F086                     _ISEEK:
002367 F086 32                      DB  50  ;
002368 F087                         DS  1
       F088                     _DRV:
002369 F088 00                      DB  0
       F089                     _DSK:
00236A F089 FF                      DB  0FFH
       F08A                     _DTA:
00236B F08A 8000                    DW  00080H
       F08C                     _CTC:
00236D F08C 0000                    DW  0
       F08E                     _TXADR:
00236F F08E 0000                    DW  0
       F090                     _KEYPS:
002371 F090 0000                    DW  0
       F092                     _KEYD:
002373 F092 00                      DB  000H    ;キーデータ
       F093                     _KEYST:
002374 F093 FF                      DB  0FFH    ;キーステータス(SHIFT,CTRLの状態)
       F094                     _KEYSP_L:
002375 F094 83                      DB  KEYSP_L ;オートリピートの速度
       F095                     _KEYSP_H:
002376 F095 14                      DB  KEYSP_H ;オートリピートの速度
       F096                     _COLORF:
002377 F096 70                      DB  COLORF  ;色
       F097                     _LINE:
002378 F097 19                      DB  LINE
                                
                                            ;次のファイルの検索(C=12)で使用するFCB
       F098                     _FCB:
002379 F098 0000                    DW  0   ;SEARCH FILES
       F09A                     _FBPS:
00237B F09A 0000                    DW  0   ;    //
       F09C                     _FBAD:
00237D F09C 0000                    DW  0   ;    //
       F09E                     _FBCNT:
00237F F09E 00                      DB  0   ;    //
       F09F                     _FILEN:
002380 F09F 00                      DB  0   ;    //
       F0A0                     _DIRF:
002381 F0A0 00                      DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
002382 F0A1                         DS  1
       F0A2                     _WTFATF:
002383 F0A2 00                      DB  0   ;FATバッファの更新フラグ
002384 F0A3                         DS  1
       F0A4                     _WTDBF:
002385 F0A4 00                      DB  0   ;データバッファの更新フラグ
       F0A5                     _DBDRV:
002386 F0A5 FF                      DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
       F0A6                     _DBSEC:
002387 F0A6 0000                    DW  0   ;データバッファにあるデータを読み込んだセクタ番号
       F0A8                     _DPB:
002389 F0A8 0000                    DW  0
       F0AA                     _FATDRV:
00238B F0AA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
       F0AB                     _FATIX:
00238C F0AB 00                      DB  0   ;FATバッファに読み込んでいるインデックス
       F0AC                     _FAKEFREE:
00238D F0AC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
00238F F0AE                         DS  2
                                ;   画面周りのデータ
       F0B0                     CRTCD:
002391 F0B0 6F                      DB  06FH
       F0B1                     _WIDTH:
002392 F0B1 28                      DB  WIDTH
       F0B2                     TVRAMTOP:
002393 F0B2 5938                    DB  059H,038H
002395 F0B4 1F02                    DB  01FH,002H
       F0B6                     _LINE2:
002397 F0B6 19                      DB  019H
       F0B7                     WKE4:
002398 F0B7 1C                      DB  01CH
       F0B8                     WKE6:
002399 F0B8 00                      DB  000H
       F0B9                     WK40:
00239A F0B9 07                      DB  007H
       F0BA                     _PAGE_MINUS:
00239B F0BA 18FC                    DW  0-WIDTH*LINE
       F0BC                     _WIDTH_MINUS:
00239D F0BC D8FF                    DW  0-WIDTH
       F0BE                     WK30:
00239F F0BE 0C                      DB  00CH
       F0BF                     WK31:
       F0BF                     WK1FD0:
0023A0 F0BF 20                      DB  020H
                                
                                ;   割り込みベクタ(X1)
0023A1 F0C0 0000                CTC0:   DW  INTCTCE
0023A3 F0C2 0000                CTC1:   DW  INTCTCE
0023A5 F0C4 0000                CTC2:   DW  INTCTCE
0023A7 F0C6 0000                CTC3:   DW  INTCTCE
0023A9 F0C8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
0023AB F0CA C3B9DA          10  _INKEY: JP  INKEY
0023AE F0CD C337D8          10  _PRINT: JP  PRINT
0023B1 F0D0 C344DB          10  _SCRN:  JP  SCRN
0023B4 F0D3 C30ADA          10  _POS:   JP  POS
0023B7 F0D6 C31ED9          10  _LOC:   JP  LOC
       F0D9                     _CHGDRV:
0023BA F0D9 C3F2E7          10      JP  CHGDRV
       F0DC                     _GETDPB:
0023BD F0DC C3B0E8          10      JP  GETDPB
       F0DF                     _FFLUSH:
0023C0 F0DF C3CEE8          10      JP  FFLUSH
       F0E2                     _RDFATX:
0023C3 F0E2 C3CAE4          10      JP  RDFATX
0023C6 F0E5 C3FCE5          10  _RDFAT: JP  RDFAT
0023C9 F0E8 C389E9          10  _WTTRK: JP  WTTRK
0023CC F0EB C3E6E9          10  _FDRD:  JP  FDRD
0023CF F0EE C38FE9          10  _FDWT:  JP  FDWT
       F0F1                     _BPB2DPB:
0023D2 F0F1 C394E6          10      JP  BPB2DPB
       F0F4                     _BREAK:
0023D5 F0F4 C393D1          10      JP  END_BATCH
       F0F7                     _GNCL:
0023D8 F0F7 C376E5          10      JP  GNCL        ; self-modifying code
       F0F8                     GNCPAT  EQU $-2
       F0FA                     _SNCL:
0023DB F0FA C399E5          10      JP  SNCL        ; self-modifying code
       F0FB                     SNCPAT  EQU $-2
       F0FD                     _COMANL:
0023DE F0FD C34CD0          10      JP  COMANL
                                
       F100                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       F100                     STABLE:
                                ;0
0023E1 F100 03F01CD728D734DD        DW  _SYS00,_SYS01,_SYS02,_SYS03
0023E9 F108 7AD47AD42DD709F0        DW  _SYS04,_SYS05,_SYS06,_SYS07
0023F1 F110 35D77CD47BD7A7D7        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
0023F9 F118 91D496D4A5D4B6D4        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
002401 F120 0AD551D59AD5CBD5        DW  _SYS10,_SYS11,_SYS12,_SYS13
002409 F128 D3D5E9D5FED5F6D5        DW  _SYS14,_SYS15,_SYS16,_SYS17
002411 F130 45D64AD64FD655D6        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
002419 F138 7AD47BD67AD47FD6        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
002421 F140 7AD435D63DD686D6        DW  _SYS20,_SYS21,_SYS22,_SYS23
002429 F148 ABD67AD48AE158E2        DW  _SYS24,_ERROR,_SYS26,_SYS27
002431 F150 3DD6B5D6BAD734DD        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
002439 F158 BAD734DD7AD4D6D6        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
002441 F160 D0D67AD47AD47AD4        DW  _SYS30,_ERROR,_ERROR,_ERROR
002449 F168 7AD47AD47AD47AD4        DW  _ERROR,_ERROR,_ERROR,_ERROR
002451 F170 7AD434DD34DDF7D6        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
002459 F178 5DD4                    DW  _DOS2
                                
00245B F17A                         DS  1
       F17B                     _MAX_SEC_SZ_H:
00245C F17B 04                      DB  MAX_SEC_SZ_H
                                
                                ;   FATバッファのアドレス
       F17C                     _FATBF:
00245D F17C 30F3                    DW  FATBF
                                
                                ;   データバッファのアドレス
       F17E                     _DTBUF:
00245F F17E 30FB                    DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       F180                     CTRLTB:
002461 F180 9CD89CD8D2D8DDD9        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
002469 F188 D7D903D9C7D960D9        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
002471 F190 A8D8C3D8E0D931D9        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
002479 F198 C4D919D9F2D99CD8        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
002481 F1A0 9CD89CD829D99CD8        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
002489 F1A8 9CD89CD89CD89CD8        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
002491 F1B0 9CD89CD8C4D938D9        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
002499 F1B8 8BD8AFD8B8D8E0D9        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
                                ;   2D/2DDでBPBがない場合のデフォルト値(2D/360KB/9セクタ1024バイト)
0024A1 F1C0 0200                M2D:    DW  2
0024A3 F1C2 FD02                    DB  0FDH,2
0024A5 F1C4 6401                    DW  356
0024A7 F1C6 FF0728090182            DB  0FFH,7,40,9,1,082H
0024AD F1CC 0500A7000800            DW  5,0A7H,8
                                
                                ;   2HDでBPBがない場合のデフォルト値(2HD/1.23MB/8セクタ1024バイト)
0024B3 F1D2 0200                M2HD:   DW  2
0024B5 F1D4 FE01                    DB  0FEH,1
0024B7 F1D6 C704                    DW  1223
0024B9 F1D8 FE064D080184            DB  0FEH,6,77,8,1,084H
0024BF F1DE 0500A7000900            DW  5,0A7H,9
                                
                                ;   ディレクトリエントリとFCBの変換テーブル(日付+時刻+サイズ)
0024C5 F1E4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
0024C7 F1E6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
0024C9 F1E8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
0024CB F1EA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       F1EE                     SDDATAE:
                                
0024CF F1EE                         DS  2
                                
                                ;   バッチファイルのFCB
       F1F0                     _FCB_BAT:
0024D1 F1F0 6AEB                    DW  FCB_BAT
       F1F2                     _PATH:
0024D3 F1F2 09EB                    DW  PATHD
                                
0024D5 F1F4                     SCDIR:  DS  2       ;+14 +15
0024D7 F1F6                     SFBPS:  DS  2       ;FBPS
0024D9 F1F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
0024DB F1FA 0000                _FATPS: DW  0
0024DD F1FC 0000                _DIRPS: DW  0
0024DF F1FE 0000                _CLPS:  DW  0
                                
       F200                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "M7DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   MZ-700/1500
                                
       F200                     _DEVICE:
                                
                                ;   A:
                                
0024E1 F200 0200                    DW  2   ;DPB_FATLN
0024E3 F202 EBF0                    DW  _FDRD   ;DPB_DRD
0024E5 F204 EEF0                    DW  _FDWT   ;DPB_DWT
0024E7 F206 FD                      DB  0FDH    ;DPB_FATID
0024E8 F207 02                      DB  2   ;DPB_SECPCL
0024E9 F208 6401                    DW  356 ;DPB_MAXCL
0024EB F20A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
0024EC F20B 07                      DB  7   ;DPB_DIRSCNT
0024ED F20C 28                      DB  40  ;DPB_MAXCYL
0024EE F20D 09                      DB  9   ;DPB_MAXSEC Number of sectors
0024EF F20E 01                      DB  1   ;DPB_FATPS
0024F0 F20F 82                      DB  082H    ;DPB_BPS
0024F1 F210 0500                    DW  5   ;DPB_DIRPS
0024F3 F212 27                      DB  027H    ;DPB_DEVICE Device Number
0024F4 F213 00                      DB  0   ;DPB_UNITNO
0024F5 F214 0800                    DW  8   ;DPB_ADDCL
0024F7 F216 0000                    DW  0   ;DPB_16
0024F9 F218 0000                    DW  0   ;DPB_18
0024FB F21A 0000                    DW  0   ;DPB_SDIR
0024FD F21C 46444430                DB  "FDD0"  ;DPB_NAME
                                
                                ;   B:
                                
002501 F220 0200                    DW  2   ;DPB_FATLN
002503 F222 EBF0                    DW  _FDRD   ;DPB_DRD
002505 F224 EEF0                    DW  _FDWT   ;DPB_DWT
002507 F226 FD                      DB  0FDH    ;DPB_FATID
002508 F227 02                      DB  2   ;DPB_SECPCL
002509 F228 6401                    DW  356 ;DPB_MAXCL
00250B F22A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
00250C F22B 07                      DB  7   ;DPB_DIRSCNT
00250D F22C 28                      DB  40  ;DPB_MAXCYL
00250E F22D 09                      DB  9   ;DPB_MAXSEC Number of sectors
00250F F22E 01                      DB  1   ;DPB_FATPS
002510 F22F 82                      DB  082H    ;DPB_BPS
002511 F230 0500                    DW  5   ;DPB_DIRPS
002513 F232 27                      DB  027H    ;DPB_DEVICE Device Number
002514 F233 01                      DB  1   ;DPB_UNITNO
002515 F234 0800                    DW  8   ;DPB_ADDCL
002517 F236 0000                    DW  0   ;DPB_16
002519 F238 0000                    DW  0   ;DPB_18
00251B F23A 0000                    DW  0   ;DPB_SDIR
00251D F23C 46444431                DB  "FDD1"  ;DPB_NAME
                                
                                ;   C:
                                
002521 F240 0100                    DW  1   ;DPB_FATLN
002523 F242 A3EA                    DW  CDRD    ;DPB_DRD
002525 F244 90EA                    DW  CDWT    ;DPB_DWT
002527 F246 FA                      DB  0FAH    ;DPB_FATID
002528 F247 01                      DB  1   ;DPB_SECPCL
002529 F248 7A00                    DW  122 ;DPB_MAXCL
00252B F24A 00                      DB  0   ;DPB_FDMODE
00252C F24B 06                      DB  6   ;DPB_DIRSCNT
00252D F24C 00                      DB  0   ;DPB_MAXCYL
00252E F24D 00                      DB  0   ;DPB_MAXSEC
00252F F24E 01                      DB  1   ;DPB_FATPS
002530 F24F 01                      DB  1   ;DPB_BPS
002531 F250 0200                    DW  2   ;DPB_DIRPS
002533 F252 0C                      DB  00CH    ;DPB_DEVICE
002534 F253 F8                      DB  0F8H    ;DPB_UNITNO
002535 F254 0600                    DW  6   ;DPB_ADDCL
002537 F256 0000                    DW  0   ;DPB_16
002539 F258 0000                    DW  0   ;DPB_18
00253B F25A 0000                    DW  0   ;DPB_SDIR
00253D F25C 434D4F53                DB  "CMOS"  ;DPB_NAME
                                
                                ;   D:
                                
002541 F260                         DS  32
                                
                                ;   E:
                                
       F280                     EMMFL:
002561 F280 0000                    DW  0   ;DPB_FATLN
002563 F282 5AEA                    DW  EDRD    ;DPB_DRD
002565 F284 4DEA                    DW  EDWT    ;DPB_DWT
002567 F286 FA                      DB  0FAH    ;DPB_FATID
002568 F287 02                      DB  2   ;DPB_SECPCL
002569 F288 0000                    DW  0   ;DPB_MAXCL
00256B F28A 00                      DB  0   ;DPB_FDMODE
00256C F28B 10                      DB  16  ;DPB_DIRSCNT
00256D F28C 00                      DB  0   ;DPB_MAXCYL
00256E F28D 00                      DB  0   ;DPB_MAXSEC
00256F F28E 01                      DB  1   ;DPB_FATPS
002570 F28F 01                      DB  1   ;DPB_BPS
002571 F290 0000                    DW  0   ;DPB_DIRPS
002573 F292 26                      DB  026H    ;DPB_DEVICE
002574 F293 00                      DB  0   ;DPB_UNITNO
002575 F294 0000                    DW  0   ;DPB_ADDCL
002577 F296 0000                    DW  0   ;DPB_16
002579 F298 0000                    DW  0   ;DPB_18
00257B F29A 0000                    DW  0   ;DPB_SDIR
00257D F29C 454D4D30                DB  "EMM0"  ;DPB_NAME
                                
                                ;   F:
                                
002581 F2A0 0200                    DW  2   ;DPB_FATLN
002583 F2A2 BAEA                    DW  RDRD    ;DPB_DRD
002585 F2A4 B6EA                    DW  RDWT    ;DPB_DWT
002587 F2A6 FA                      DB  0FAH    ;DPB_FATID
002588 F2A7 01                      DB  1   ;DPB_SECPCL
002589 F2A8 F600                    DW  246 ;DPB_MAXCL
00258B F2AA 00                      DB  0   ;DPB_FDMODE
00258C F2AB 09                      DB  9   ;DPB_DIRSCNT
00258D F2AC 00                      DB  0   ;DPB_MAXCYL
00258E F2AD 00                      DB  0   ;DPB_MAXSEC
00258F F2AE 01                      DB  1   ;DPB_FATPS
002590 F2AF 01                      DB  1   ;DPB_BPS
002591 F2B0 0300                    DW  3   ;DPB_DIRPS
002593 F2B2 0F                      DB  00FH    ;DPB_DEVICE
002594 F2B3 00                      DB  0   ;DPB_UNITNO
002595 F2B4 0A00                    DW  10  ;DPB_ADDCL
002597 F2B6 0000                    DW  0   ;DPB_16
002599 F2B8 0000                    DW  0   ;DPB_18
00259B F2BA 0000                    DW  0   ;DPB_SDIR
00259D F2BC 52414D46                DB  "RAMF"  ;DPB_NAME
                                
                                ;   G:
       F2C0                     GRAMFL:
0025A1 F2C0 0100                    DW  1   ;DPB_FATLN
0025A3 F2C2 E5EA                    DW  GDRD    ;DPB_DRD
0025A5 F2C4 D0EA                    DW  GDWT    ;DPB_DWT
0025A7 F2C6 FA                      DB  0FAH    ;DPB_FATID
0025A8 F2C7 01                      DB  1   ;DPB_SECPCL
0025A9 F2C8 5A00                    DW  90  ;DPB_MAXCL
0025AB F2CA 00                      DB  0   ;DPB_FDMODE
0025AC F2CB 06                      DB  6   ;DPB_DIRSCNT
0025AD F2CC 00                      DB  0   ;DPB_MAXCYL
0025AE F2CD 00                      DB  0   ;DPB_MAXSEC
0025AF F2CE 01                      DB  1   ;DPB_FATPS
0025B0 F2CF 01                      DB  1   ;DPB_BPS
0025B1 F2D0 0200                    DW  2   ;DPB_DIRPS
0025B3 F2D2 05                      DB  005H    ;DPB_DEVICE
0025B4 F2D3 F8                      DB  0F8H    ;DPB_UNITNO
0025B5 F2D4 0600                    DW  6   ;DPB_ADDCL
0025B7 F2D6 0000                    DW  0   ;DPB_16
0025B9 F2D8 0000                    DW  0   ;DPB_18
0025BB F2DA 0000                    DW  0   ;DPB_SDIR
0025BD F2DC 4752414D                DB  "GRAM"  ;DPB_NAME
                                
                                ;   H:
0025C1 F2E0                         DS  3
0025C4 F2E3 00                      DB  0
[EOF:M7DPB.ASM:UTF_8]
                                
       A5C5                     LAST_ADR    EQU $$+OFFSET
                                
                                    END
[EOF:M7.ASM:UTF_8]
