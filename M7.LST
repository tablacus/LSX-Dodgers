                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   LSX-Dodgers for MZ-700/1500
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "M7DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MZ-700/1500
                                
       0001                     MAC EQU 1   ;MZ-700/1500
       0001                     VER_1   EQU 1
       0004                     VER_2   EQU 4
       0003                     VER_3   EQU 3
                                
       8080                     RUN EQU 08080H
       8000                     OFFSET  EQU RUN-128
       CF06                     BDOS    EQU 0CF06H
       ED00                     TABLEAD EQU 0ED00H
       EF00                     WORKAD  EQU 0EF00H
       F200                     FATBF   EQU 0F200H
       FA00                     DTBUF   EQU 0FA00H
       FE00                     KEYBF   EQU 0FE00H
       FF00                     KBUF    EQU 0FF00H
       FFD9                     TRAP38  EQU 0FFD9H
       0028                     WIDTH   EQU 40
       0019                     LINE    EQU 25
       0071                     COLORF  EQU 071H
[EOF:M7DEF.ASM:UTF_8]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       1D01                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0001                     MACD    EQU MAC + 00000H    ;機種フラグとデバイスフラグ
       0147                     VER EQU VER_1 * 256 + VER_2 * 17 + VER_3
                                
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       FFCA                     EXTBIO  EQU 0FFCAH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 8000                         ORG OFFSET
                                                    ;MZTヘッダ128バイト
000000 8000 01                      DB  1           ;ファイルモード
000001 8001 4C53582D444F4447        DB  "LSX-DODGERS  "     ;ファイル名(13)
            4552532020          
00000E 800E 535953                  DB  "SYS"           ;拡張子(3)
000011 8011 0D                      DB  $0D
000012 8012 0924                    DW  LAST_ADR-RUN        ;サイズ
000014 8014 8080                    DW  RUN         ;開始アドレス
000016 8016 8080                    DW  RUN         ;実行アドレス
000018 8018                         DS  104
                                
                                    INCLUDE "M7INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   MZ-700/1500
                                
000080 8080 C38780          10      JP  START
000083 8083 011D                    DW  MACW
000085 8085 4701                    DW  VER
                                
       8087                     START:
000087 8087 F3               4      DI
000088 8088 ED56             8      IM  1
00008A 808A 318780          10      LD  SP,START
00008D 808D CD9B80          17      CALL    INIT        ;NZならAUTOEXECを実行
000090 8090 210000          10      LD  HL,0
000093 8093 E5              11      PUSH    HL
000094 8094 C8              11      RET Z
000095 8095 113281          10      LD  DE,AUTOD
000098 8098 C3FDEF          10      JP  _COMANL
                                
       809B                     INIT:
00009B 809B D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFHH)
00009D 809D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00009F 809F 218F81          10      LD  HL,INITE
0000A2 80A2 1106CF          10      LD  DE,BDOS
0000A5 80A5 01FA22          10      LD  BC,LAST_ADR-INITE
0000A8 80A8 EDB0                    LDIR
                                
0000AA 80AA 210000          10      LD  HL,0
0000AD 80AD 065C             7      LD  B,05CH
0000AF 80AF 3EEF             7      LD  A,0EFH      ;RST 28H
0000B1 80B1 CD86DE          17      CALL    FILL_MEMORY
0000B4 80B4 06A4             7      LD  B,0A4H
0000B6 80B6 AF               4      XOR A
0000B7 80B7 CD86DE          17      CALL    FILL_MEMORY
                                
0000BA 80BA 3EC3             7      LD  A,0C3H      ;JP
0000BC 80BC 2103EF          10      LD  HL,CPM_WBOOT
0000BF 80BF 320000          13      LD  (00000H),A
0000C2 80C2 220100          16      LD  (00001H),HL ;IPL
                                
0000C5 80C5 21011D          10      LD  HL,MACW     ;3 bit7  DPB Compatible LA(1)
0000C8 80C8 220300          16      LD  (00003H),HL ;  bit6-0 Machine
                                ;               ;4 LSX-Dodgers(01DH)
0000CB 80CB 2106CF          10      LD  HL,BDOS
0000CE 80CE 320500          13      LD  (00005H),A
0000D1 80D1 220600          16      LD  (00006H),HL ;BDOS
                                
0000D4 80D4 21D9FF          10      LD  HL,TRAP38   ;TRAP38
0000D7 80D7 322800          13      LD  (00028H),A
0000DA 80DA 222900          16      LD  (00029H),HL ;RST 038H
                                
0000DD 80DD 3EC9             7      LD  A,0C9H      ;モード1割り込み
0000DF 80DF 323800          13      LD  (00038H),A
                                
0000E2 80E2 3EEF             7      LD  A,CPM_BOOT/256
0000E4 80E4 320B00          13      LD  (0000BH),A
                                
0000E7 80E7 3EE9             7      LD  A,0E9H      ;JP (HL)
0000E9 80E9 320F00          13      LD  (0000FH),A
                                
0000EC 80EC 3A7DF0          13      LD  A,(_FATBF+1)
0000EF 80EF 321300          13      LD  (00013H),A
                                
0000F2 80F2 3A7FF0          13      LD  A,(_DTBUF+1)
0000F5 80F5 321700          13      LD  (00017H),A
                                
0000F8 80F8 3EFE             7      LD  A,KEYBF/256
0000FA 80FA 321B00          13      LD  (0001BH),A
                                
0000FD 80FD 3EFF             7      LD  A,KBUF/256
0000FF 80FF 321F00          13      LD  (0001FH),A
                                
000102 8102 214701          10      LD  HL,VER
000105 8105 225A00          16      LD  (0005AH),HL
                                
000108 8108 213E81          10      LD  HL,INIMES
00010B 810B CD75D6          17      CALL    MSX
       810E                     INIT1:
00010E 810E F3               4      DI
00010F 810F 1100FF          10      LD  DE,0FF00H
000112 8112 0600             7      LD  B,0
000114 8114 CDBDD3          17      CALL    ZERO_MEMORY_DE
000117 8117 21CAFF          10      LD  HL,EXTBIO
00011A 811A 060F             7      LD  B,TRAP38-EXTBIO
00011C 811C 3EEF             7      LD  A,0EFH      ;RST 28H
00011E 811E CD86DE          17      CALL    FILL_MEMORY
000121 8121 216881          10      LD  HL,AT_TRAP38
000124 8124 11D9FF          10      LD  DE,TRAP38
000127 8127 012700          10      LD  BC,AT_TRAPE-AT_TRAP38
00012A 812A EDB0                    LDIR
                                
00012C 812C CDC1DC          17      CALL    CHKEY
00012F 812F FE03             7      CP  3
000131 8131 C9              10      RET
                                
000132 8132 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
00013B 813B 413A00              AUTODV: DB  "A:",0
                                
00013E 813E 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for MZ-700/1500 v"
            6765727320666F72    
            204D5A2D3730302F    
            313530302076        
                                ;   DB  030H + VER_1, '.'
                                ;   DB  030H + VER_2 ,030H + VER_3
00015C 815C 302E3031                DB  '0.01'          ;表示
000160 8160 2047616B750D0A          DB  ' Gaku',0DH,0AH
000167 8167 00                      DB  0
                                
       8168                     AT_TRAP38:
000168 FFD9                         ORG TRAP38,AT_TRAP38-OFFSET
000168 FFD9 210000          10      LD  HL,0
00016B FFDC E3              19      EX  (SP),HL
00016C FFDD 3E24             7      LD  A,'$'
00016E FFDF CD4CD9          17      CALL    MSG_A
000171 FFE2 2B               6      DEC HL
000172 FFE3 7C               4      LD  A,H
000173 FFE4 CDE8FF          17      CALL    PRHX
000176 FFE7 7D               4      LD  A,L
       FFE8                     PRHX:
000177 FFE8 F5              11      PUSH    AF
000178 FFE9 07               4      RLCA
000179 FFEA 07               4      RLCA
00017A FFEB 07               4      RLCA
00017B FFEC 07               4      RLCA
00017C FFED CDF1FF          17      CALL    PRHX2
00017F FFF0 F1              10      POP AF
       FFF1                     PRHX2:
000180 FFF1 E60F             7      AND 00FH
000182 FFF3 FE0A             7      CP  10
000184 FFF5 3802            12      JR  C,PRHX3
000186 FFF7 C607             7      ADD A,'A'-'0'-10
       FFF9                     PRHX3:
000188 FFF9 C630             7      ADD A,'0'
00018A FFFB C34CD9          10      JP  MSG_A
00018D FFFE                         DS  2
       818F                         ORG $$+OFFSET   ;$DEPHASE
       818F                     AT_TRAPE:
                                
       818F                     INITE:
00018F CF06                         ORG BDOS,INITE-OFFSET
                                
00018F CF06 C309CF          10      JP  IO_BDOS
[EOF:M7INIT.ASM:SHIFT_JIS]
                                    INCLUDE "M7BANK.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                ;   VRAM/KEY/TIMER(0D000H-0EFFFH)にアクセスするので0D000H-0FFFFHに置けない部分
                                ;
                                
       CF09                     IO_BDOS:
000192 CF09 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000194 CF0B C31ED6          10      JP  BDOS0
                                
       CF0E                     RDKEYDATA:
000197 CF0E D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000199 CF10 3200E0          13      LD  (0E000H),A
00019C CF13 3A01E0          13      LD  A,(E001H)
00019F CF16 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001A1 CF18 C9              10      RET
                                
       CF19                     RD556VSYNC:
0001A2 CF19 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001A4 CF1B 3A02E0          13      LD  A,(0E002H)
0001A7 CF1E D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001A9 CF20 C9              10      RET
                                
       CF21                     RDMMIO:
0001AA CF21 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001AC CF23 7E               7      LD  A,(HL)
0001AD CF24 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001AF CF26 C9              10      RET
                                
       CF27                     WRMMIO:
0001B0 CF27 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001B2 CF29 77               7      LD  (HL),A
0001B3 CF2A D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001B5 CF2C C9              10      RET
                                
       CF2D                     RDMMIO_BC:
0001B6 CF2D D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001B8 CF2F 0A               7      LD  A,(BC)
0001B9 CF30 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001BB CF32 C9              10      RET
                                
       CF33                     IO_PRINT:
0001BC CF33 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001BE CF35 77               7      LD  (HL),A
0001BF CF36 CBDC             8      SET 3,H
       CF39                     IPCSMC  EQU $+1
0001C1 CF38 0E00             7      LD  C,0     ;自己書き換え
0001C3 CF3A 7B               4      LD  A,E
0001C4 CF3B FE61             7      CP  'a'
0001C6 CF3D 3806            12      JR  C,PRT1
0001C8 CF3F FE7B             7      CP  'z'+1
0001CA CF41 3002            12      JR  NC,PRT1
0001CC CF43 CBF9             8      SET 7,C
       CF45                     PRT1:
0001CE CF45 71               7      LD  (HL),C
0001CF CF46 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001D1 CF48 C9              10      RET
                                
       CF49                     IO_CLR:
0001D2 CF49 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF4B                     C1AX1:
0001D4 CF4B 7A               4      LD  A,D
0001D5 CF4C C6D0             7      ADD A,0D0H
0001D7 CF4E 57               4      LD  D,A
0001D8 CF4F AF               4      XOR A
0001D9 CF50 12               7      LD  (DE),A      ;Text
0001DA CF51 CBDA             8      SET 3,D
       CF54                     ICSMC   EQU $+1
0001DC CF53 3E00             7      LD  A,0     ;自己書き換え
0001DE CF55 12               7      LD  (DE),A      ;Color
0001DF CF56 13               6      INC DE
0001E0 CF57 7A               4      LD  A,D
0001E1 CF58 D6D8             7      SUB 0D8H
0001E3 CF5A 57               4      LD  D,A
0001E4 CF5B 2118FC          10      LD  HL,0-WIDTH*LINE
0001E7 CF5E 19              11      ADD HL,DE
0001E8 CF5F 30EA            12      JR  NC,C1AX1
0001EA CF61 E1              10      POP HL
0001EB CF62 D1              10      POP DE
0001EC CF63 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001EE CF65 C9              10      RET
                                
       CF66                     IO_CLLINE:
0001EF CF66 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF68                     CLLINE1:
0001F1 CF68 CB9C             8      RES 3,H
0001F3 CF6A 71               7      LD  (HL),C      ;Text
0001F4 CF6B CBDC             8      SET 3,H
0001F6 CF6D 77               7      LD  (HL),A      ;Color
0001F7 CF6E 23               6      INC HL
0001F8 CF6F 10F7            13      DJNZ    CLLINE1
0001FA CF71 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001FC CF73 C9              10      RET
                                
       CF74                     IO_INS:
0001FD CF74 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001FF CF76 CD8CCF          17      CALL    C12S
000202 CF79 23               6      INC HL
000203 CF7A 10F8            13      DJNZ    IO_INS
000205 CF7C D1              10      POP DE
000206 CF7D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000208 CF7F C9              10      RET
                                
       CF80                     IO_BS:
000209 CF80 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00020B CF82 CD8CCF          17      CALL    C12S
00020E CF85 2B               6      DEC HL
00020F CF86 10F8            13      DJNZ    IO_BS
000211 CF88 D1              10      POP DE
000212 CF89 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000214 CF8B C9              10      RET
                                
       CF8C                     C12S:
000215 CF8C CB9C             8      RES 3,H
000217 CF8E 56               7      LD  D,(HL)
000218 CF8F 73               7      LD  (HL),E
000219 CF90 5A               4      LD  E,D
00021A CF91 CBDC             8      SET 3,H
00021C CF93 56               7      LD  D,(HL)
00021D CF94 77               7      LD  (HL),A
00021E CF95 7A               4      LD  A,D
00021F CF96 C9              10      RET
                                
       CF97                     IO_SCRUP:
000220 CF97 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF99                     SCRUP1:
000222 CF99 2815            12      JR  Z,SCRCL
000224 CF9B D5              11      PUSH    DE
000225 CF9C E5              11      PUSH    HL
000226 CF9D CBDA             8      SET 3,D
000228 CF9F CBDC             8      SET 3,H
00022A CFA1 012800          10      LD  BC,WIDTH
00022D CFA4 EDB0                    LDIR
00022F CFA6 E1              10      POP HL
000230 CFA7 D1              10      POP DE
000231 CFA8 012800          10      LD  BC,WIDTH
000234 CFAB EDB0                    LDIR
000236 CFAD 3D               4      DEC A
000237 CFAE 18E9            12      JR  SCRUP1
                                
       CFB0                     SCRCL:
000239 CFB0 0628             7      LD  B,WIDTH
00023B CFB2 EB               4      EX  DE,HL
00023C CFB3 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00023E CFB5 CD23DB          17      CALL    CLLINE
000241 CFB8 E1              10      POP HL
000242 CFB9 D1              10      POP DE
000243 CFBA C1              10      POP BC
000244 CFBB C9              10      RET
                                
       CFBC                     BANKE:
000245 CFBC                         DS  0CFFEH-BANKE        ;スタックエリア
       CFFE                     EXTSP:
                                
[EOF:M7BANK.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   MZ-700/1500
                                
       CFFE                     WBOOT1:
000287 CFFE D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)　ここは0CFFEH
000289 D000 D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFHH)
00028B D002 ED7B0600        20      LD  SP,(SYSTEM+1)
00028F D006 FB               4      EI
000290 D007 2192EF          10      LD  HL,_KEYD
000293 D00A 3600            10      LD  (HL),0
000295 D00C CDC1DC          17      CALL    CHKEY
000298 D00F CD39D9          17      CALL    KEYBC_IFBREAK
00029B D012 3E04             7      LD  A,4
00029D D014 CD4CD9          17      CALL    MSG_A
[EOF:M7CCP.ASM:UTF_8]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D017                     COMMAND:
0002A0 D017 CDCAD0          17      CALL    SETDTA1
0002A3 D01A 3A87EF          13      LD  A,(_DVSW)
0002A6 D01D C641             7      ADD A,'A'
0002A8 D01F CD4CD9          17      CALL    MSG_A
0002AB D022 3E3E             7      LD  A,'>'
0002AD D024 CD4CD9          17      CALL    MSG_A
0002B0 D027 3E50             7      LD  A,80
0002B2 D029 12               7      LD  (DE),A
0002B3 D02A CDABD9          17      CALL    _SYS0A      ;(BDOS)文字列入力
0002B6 D02D CD7FD2          17      CALL    LTNL
                                
0002B9 D030 118200          10      LD  DE,DTA1+2
0002BC D033 CDFDEF          17      CALL    _COMANL
0002BF D036 30DF            12      JR  NC,COMMAND
0002C1 D038 1179EF          10      LD  DE,COMERM
0002C4 D03B CD66D6          17      CALL    _SYS09      ;(BDOS)文字列出力
0002C7 D03E C7              12      RST 0
                                
       D03F                     COMANL:
0002C8 D03F CDDADD          17      CALL    FILE
0002CB D042 3A19EF          13      LD  A,(FNAME+4)
0002CE D045 FE20             7      CP  020H
0002D0 D047 201C            12      JR  NZ,COMB2
0002D2 D049 D5              11      PUSH    DE
0002D3 D04A 1115EF          10      LD  DE,FNAME
0002D6 D04D 1A               7      LD  A,(DE)
0002D7 D04E FE20             7      CP  020H
0002D9 D050 2844            12      JR  Z,SDVSW
0002DB D052 1B               6      DEC DE
0002DC D053 1A               7      LD  A,(DE)
0002DD D054 C6FF             7      ADD A,0FFH
0002DF D056 3809            12      JR  C,COMB
0002E1 D058 13               6      INC DE
                                
0002E2 D059 218AD5          10      LD  HL,COMTB
0002E5 D05C 0609             7      LD  B,COMS
0002E7 D05E CD5EE0          17      CALL    CPNAME
       D061                     COMB:
0002EA D061 D1              10      POP DE
0002EB D062 D20F00          10      JP  NC,JP_HL
       D065                     COMB2:
0002EE D065 EB               4      EX  DE,HL
0002EF D066 223ED1          16      LD  (COMPAT+1),HL
0002F2 D069 F5              11      PUSH    AF
0002F3 D06A CDEAD0          17      CALL    CEXE4
0002F6 D06D F1              10      POP AF
0002F7 D06E 2115EF          10      LD  HL,FNAME
0002FA D071 116D00          10      LD  DE,FCB2+1   ;COMMAND NAME
0002FD D074 010B00          10      LD  BC,11
000300 D077 EDB0                    LDIR
000302 D079 1149D5          10      LD  DE,PATHD
       D07C                     CEX1:
000305 D07C 1A               7      LD  A,(DE)
000306 D07D FE20             7      CP  020H
000308 D07F D8              11      RET C
000309 D080 CDCFDD          17      CALL    FILEC
00030C D083 D5              11      PUSH    DE
00030D D084 216D00          10      LD  HL,FCB2+1   ;COMMAND NAME
000310 D087 1115EF          10      LD  DE,FNAME
000313 D08A 010B00          10      LD  BC,11
000316 D08D EDB0                    LDIR
000318 D08F CDEAD0          17      CALL    CEXE4
00031B D092 D1              10      POP DE
00031C D093 13               6      INC DE
00031D D094 18E6            12      JR  CEX1
                                
       D096                     SDVSW:
00031F D096 F1              10      POP AF
000320 D097 3A14EF          13      LD  A,(FDRV)
000323 D09A 3D               4      DEC A
000324 D09B 5F               4      LD  E,A
000325 D09C 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
000327 D09E 1831            12      JR  SYSTEM0
                                
       D0A0                     OPEN1:
000329 D0A0 2114EF          10      LD  HL,FDRV
       D0A3                     OPEN:
00032C D0A3 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D0A5                     OPEN3:
00032E D0A5 D5              11      PUSH    DE
00032F D0A6 1124D5          10      LD  DE,DTA_CCP
000332 D0A9 CDC7D0          17      CALL    SETDTA
000335 D0AC EB               4      EX  DE,HL
000336 D0AD CDD1D0          17      CALL    SYSTEM0
000339 D0B0 D1              10      POP DE
00033A D0B1 C9              10      RET
                                
       D0B2                     OPEN2:
00033B D0B2 0E12             7      LD  C,012H
00033D D0B4 18EF            12      JR  OPEN3
                                
       D0B6                     DEFCB:              ;Z=Ok NZ=Error
00033F D0B6 1124D5          10      LD  DE,DTA_CCP
000342 D0B9 CDCFD0          17      CALL    SYSC0F
                                
000345 D0BC 1145D5          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
000348 D0BF 0604             7      LD  B,4
00034A D0C1 CDBDD3          17      CALL    ZERO_MEMORY_DE
00034D D0C4 110001          10      LD  DE,00100H
       D0C7                     SETDTA:
000350 D0C7 C36AD8          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D0CA                     SETDTA1:
000353 D0CA 118000          10      LD  DE,DTA1
000356 D0CD 18F8            12      JR  SETDTA
                                
       D0CF                     SYSC0F:
000358 D0CF 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D0D1                     SYSTEM0:
00035A D0D1 CD0500          17      CALL    SYSTEM
00035D D0D4 B7               4      OR  A
00035E D0D5 C9              10      RET
                                
       D0D6                     C_CD:
00035F D0D6 0E5A             7      LD  C,5AH
000361 D0D8 18F7            12      JR  SYSTEM0
                                
       D0DA                     S27BUF:
000363 D0DA 3A0700          13      LD  A,(SYSTEM+2)
000366 D0DD 3D               4      DEC A
000367 D0DE E6F8             7      AND 0F8H
000369 D0E0 67               4      LD  H,A
00036A D0E1 2E00             7      LD  L,0
       D0E3                     S27DTA:
00036C D0E3 1124D5          10      LD  DE,DTA_CCP
       D0E6                     S27:
00036F D0E6 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
000371 D0E8 18E7            12      JR  SYSTEM0
                                
       D0EA                     CEXE4:
000373 D0EA 3A14EF          13      LD  A,(FDRV)
000376 D0ED 325700          13      LD  (00057H),A
000379 D0F0 2A22EF          16      LD  HL,(FDRV+14)
00037C D0F3 225800          16      LD  (00058H),HL
                                
00037F D0F6 211DEF          10      LD  HL,FNAME+8
000382 D0F9 7E               7      LD  A,(HL)
000383 D0FA FE20             7      CP  020H
000385 D0FC 2007            12      JR  NZ,CEXE7
000387 D0FE 3E3F             7      LD  A,'?'
000389 D100 77               7      LD  (HL),A
00038A D101 23               6      INC HL
00038B D102 77               7      LD  (HL),A
00038C D103 23               6      INC HL
00038D D104 77               7      LD  (HL),A
       D105                     CEXE7:
00038E D105 CDA0D0          17      CALL    OPEN1
       D108                     CEXE5:
000391 D108 C0              11      RET NZ
000392 D109 2A2ED5          16      LD  HL,(DTA_CCP+1+9)
000395 D10C 7C               4      LD  A,H
000396 D10D CDE6E0          17      CALL    CAP
000399 D110 67               4      LD  H,A
00039A D111 7D               4      LD  A,L
00039B D112 CDE6E0          17      CALL    CAP
00039E D115 6F               4      LD  L,A
00039F D116 3A2DD5          13      LD  A,(DTA_CCP+1+8)
0003A2 D119 CDE6E0          17      CALL    CAP
0003A5 D11C D642             7      SUB 'B'
0003A7 D11E 282C            12      JR  Z,C_BAT
0003A9 D120 3D               4      DEC A       ;'C'
0003AA D121 2805            12      JR  Z,C_EXE
       D123                     CEXE6:
0003AC D123 CDB2D0          17      CALL    OPEN2
0003AF D126 18E0            12      JR  CEXE5
                                
       D128                     C_EXE:
0003B1 D128 7C               4      LD  A,H
0003B2 D129 FE4D             7      CP  'M'
0003B4 D12B 20F6            12      JR  NZ,CEXE6
                                
0003B6 D12D CDB6D0          17      CALL    DEFCB
0003B9 D130 CDDAD0          17      CALL    S27BUF
0003BC D133 3D               4      DEC A
0003BD D134 37               4      SCF
0003BE D135 C0              11      RET NZ
0003BF D136 7C               4      LD  A,H
0003C0 D137 B5               4      OR  L
0003C1 D138 37               4      SCF
0003C2 D139 C8              11      RET Z
0003C3 D13A CDCAD0          17      CALL    SETDTA1
0003C6 D13D 110000          10  COMPAT: LD  DE,0                ; self-modifying code
0003C9 D140 ED7B0600        20      LD  SP,(SYSTEM+1)
0003CD D144 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
0003CE D145 6F               4      LD  L,A
0003CF D146 E5              11      PUSH    HL              ; push $0000 (reboot address)
0003D0 D147 24               4      INC H
0003D1 D148 E5              11      PUSH    HL              ; push $0100 (TPA address)
0003D2 D149 C388D3          10      JP  SETFCB              ; and JP $0100
                                
       D14C                     C_BAT:
0003D5 D14C 114154          10      LD  DE,'A'+'T'*256
0003D8 D14F ED52            15      SBC HL,DE
0003DA D151 20D0            12      JR  NZ,CEXE6
                                
0003DC D153 F1              10      POP AF
0003DD D154 F1              10      POP AF
0003DE D155 CDB6D0          17      CALL    DEFCB
0003E1 D158 210002          10      LD  HL,00200H
0003E4 D15B CDE3D0          17      CALL    S27DTA
0003E7 D15E C6FE             7      ADD A,0FEH
0003E9 D160 D8              11      RET C
0003EA D161 7D               4      LD  A,L
0003EB D162 B7               4      OR  A
0003EC D163 37               4      SCF
0003ED D164 C8              11      RET Z
0003EE D165 3C               4      INC A
0003EF D166 F5              11      PUSH    AF
                                
0003F0 D167 CD3CD9          17      CALL    KEYBC
0003F3 D16A 3E06             7      LD  A,6
0003F5 D16C CD4CD9          17      CALL    MSG_A
0003F8 D16F C1              10      POP BC
0003F9 D170 210001          10      LD  HL,00100H
       D173                     BAT1:
0003FC D173 A7               4      AND A
0003FD D174 05               4      DEC B
0003FE D175 C8              11      RET Z
0003FF D176 7E               7      LD  A,(HL)
000400 D177 FE25             7      CP  '%'
000402 D179 280C            12      JR  Z,BAT2
       D17B                     BAT1X:
000404 D17B 7E               7      LD  A,(HL)
000405 D17C 23               6      INC HL
000406 D17D FE1A             7      CP  01AH
000408 D17F C8              11      RET Z
000409 D180 FE0A             7      CP  00AH
00040B D182 C421D9          17      CALL    NZ,KEYBS
00040E D185 18EC            12      JR  BAT1
                                
       D187                     BAT2:
000410 D187 23               6      INC HL
000411 D188 7E               7      LD  A,(HL)
000412 D189 2B               6      DEC HL
000413 D18A D631             7      SUB '1'
000415 D18C 38ED            12      JR  C,BAT1X
000417 D18E FE09             7      CP  9
000419 D190 30E9            12      JR  NC,BAT1X
00041B D192 23               6      INC HL
00041C D193 23               6      INC HL
00041D D194 3C               4      INC A
00041E D195 4F               4      LD  C,A
00041F D196 ED5B3ED1        20      LD  DE,(COMPAT+1)
       D19A                     BAT3:
000423 D19A 1A               7      LD  A,(DE)
000424 D19B B7               4      OR  A
000425 D19C 28D5            12      JR  Z,BAT1
000427 D19E CDB1DE          17      CALL    SPCUT
00042A D1A1 0D               4      DEC C
00042B D1A2 2808            12      JR  Z,BAT5
       D1A4                     BAT4:
00042D D1A4 1A               7      LD  A,(DE)
00042E D1A5 FE21             7      CP  021H
000430 D1A7 38F1            12      JR  C,BAT3
000432 D1A9 13               6      INC DE
000433 D1AA 18F8            12      JR  BAT4
       D1AC                     BAT5:
000435 D1AC 1A               7      LD  A,(DE)
000436 D1AD FE21             7      CP  021H
000438 D1AF 38C2            12      JR  C,BAT1
00043A D1B1 13               6      INC DE
00043B D1B2 CD21D9          17      CALL    KEYBS
00043E D1B5 18F5            12      JR  BAT5
                                
       D1B7                     SWITCH:
000440 D1B7 1A               7      LD  A,(DE)
       D1B8                     SW1:
000441 D1B8 13               6      INC DE
000442 D1B9 B9               4      CP  C
000443 D1BA 1A               7      LD  A,(DE)
000444 D1BB C8              11      RET Z
000445 D1BC FE20             7      CP  020H
000447 D1BE 30F8            12      JR  NC,SW1
       D1C0                     C_REM:
000449 D1C0 AF               4      XOR A
00044A D1C1 C9              10      RET
                                
       D1C2                     C_DEL:
00044B D1C2 CD88D3          17      CALL    SETFCB
00044E D1C5 CD62D9          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
000451 D1C8 0E13             7      LD  C,013H
000453 D1CA 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       D1CC                     C_REN:
000455 D1CC CD88D3          17      CALL    SETFCB
000458 D1CF 3E10             7      LD  A,010H      ;ディレクトリも対象にする
00045A D1D1 326900          13      LD  (FCB1+13),A ;属性
00045D D1D4 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       D1D6                     CDEL1:
00045F D1D6 115C00          10      LD  DE,FCB1
000462 D1D9 CD0500          17      CALL    SYSTEM
000465 D1DC C6FF             7      ADD A,0FFH
000467 D1DE C9              10      RET
                                
       D1DF                     C_DIR:
000468 D1DF CDCFDD          17      CALL    FILEC
00046B D1E2 2115EF          10      LD  HL,FDRV+1
00046E D1E5 CD19D5          17      CALL    CWILD1
000471 D1E8 3EF1             7      LD  A,0F1H
000473 D1EA 3221EF          13      LD  (FDRV+13),A
000476 D1ED CDA0D0          17      CALL    OPEN1
       D1F0                     CDIR1:
000479 D1F0 B7               4      OR  A
00047A D1F1 2008            12      JR  NZ,PDSKF
00047C D1F3 CD3ED2          17      CALL    P_NAME
00047F D1F6 CDB2D0          17      CALL    OPEN2
000482 D1F9 18F5            12      JR  CDIR1
                                
       D1FB                     PDSKF:
000484 D1FB 3A14EF          13      LD  A,(FDRV)
000487 D1FE 5F               4      LD  E,A
000488 D1FF 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
00048A D201 CD0500          17      CALL    SYSTEM
00048D D204 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
00048E D205 C601             7      ADD A,001H
000490 D207 D8              11      RET C       ;Aが0FFHだった場合
000491 D208 3E06             7      LD  A,8-2
       D20A                     PDS1:               ;HL=未使用クラスタの総数
000493 D20A 3C               4      INC A
000494 D20B CB19             8      RR  C
000496 D20D 30FB            12      JR  NC,PDS1
       D20F                     PDS2:               ;B←論理セクタのサイズの上位8ビット
000498 D20F 3C               4      INC A
000499 D210 CB18             8      RR  B
00049B D212 30FB            12      JR  NC,PDS2
00049D D214 47               4      LD  B,A
                                
00049E D215 110000          10      LD  DE,0
       D218                     PDS3:
0004A1 D218 29              11      ADD HL,HL
0004A2 D219 EB               4      EX  DE,HL
0004A3 D21A ED6A            15      ADC HL,HL
0004A5 D21C EB               4      EX  DE,HL
0004A6 D21D 10F9            13      DJNZ    PDS3
       D21F                     PDSKF1:
0004A8 D21F CDB7D2          17      CALL    PRDEC_DEHL
0004AB D222 11C0D5          10      LD  DE,FREE
0004AE D225 CD66D6          17      CALL    _SYS09      ;(BDOS)文字列出力
0004B1 D228 CDA6D2          17      CALL    PUTDRV
0004B4 D22B 3E5C             7      LD  A,05CH      ;\
0004B6 D22D CD4CD9          17      CALL    MSG_A
0004B9 D230 2A22EF          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
0004BC D233 AF               4      XOR A
0004BD D234 11FEFF          10      LD  DE,0-2
0004C0 D237 19              11      ADD HL,DE
0004C1 D238 23               6      INC HL
0004C2 D239 DCB3D2          17      CALL    C,PRDEC_HL
0004C5 D23C 1841            12      JR  LTNL
                                
       D23E                     P_NAME:
0004C7 D23E 3A25D5          13      LD  A,(DTA_CCP+1)
0004CA D241 FE2E             7      CP  '.'
0004CC D243 C8              11      RET Z
0004CD D244 11D8D5          10      LD  DE,DIRHD
0004D0 D247 CD66D6          17      CALL    _SYS09      ;(BDOS)文字列出力
0004D3 D24A 3A30D5          13      LD  A,(DTA_CCP+1+00BH)
0004D6 D24D F5              11      PUSH    AF
0004D7 D24E 0F               4      RRCA
0004D8 D24F 9F               4      SBC A,A
0004D9 D250 E60A             7      AND '*'-020H
0004DB D252 C620             7      ADD A,020H
0004DD D254 CD4CD9          17      CALL    MSG_A
0004E0 D257 CDA6D2          17      CALL    PUTDRV
0004E3 D25A 2125D5          10      LD  HL,DTA_CCP+1
0004E6 D25D CDF7D2          17      CALL    FPRNT
                                
0004E9 D260 F1              10      POP AF
0004EA D261 CB67             8      BIT 4,A
0004EC D263 2808            12      JR  Z,DIR3
0004EE D265 11CDD5          10      LD  DE,DIRMES
0004F1 D268 CD66D6          17      CALL    _SYS09      ;(BDOS)文字列出力
0004F4 D26B 180A            12      JR  DIR6
       D26D                     DIR3:
0004F6 D26D ED5B43D5        20      LD  DE,(DTA_CCP+1+01EH)
0004FA D271 2A41D5          16      LD  HL,(DTA_CCP+1+01CH)
0004FD D274 CDB7D2          17      CALL    PRDEC_DEHL
       D277                     DIR6:
000500 D277 3AB1EF          13      LD  A,(CRTCD+1)
000503 D27A FE29             7      CP  40+1
000505 D27C D419D3          17      CALL    NC,PRTTMS
                                
       D27F                     LTNL:
000508 D27F 1E03             7      LD  E,3
00050A D281 C3CDEF          10      JP  _PRINT
                                
       D284                     C_PATH:
00050D D284 CDB1DE          17      CALL    SPCUT
000510 D287 2149D5          10      LD  HL,PATHD
000513 D28A FE21             7      CP  021H
000515 D28C 300C            12      JR  NC,CPATH0
       D28E                     CPATHP:
000517 D28E 7E               7      LD  A,(HL)
000518 D28F 23               6      INC HL
000519 D290 FE20             7      CP  020H
00051B D292 3F               4      CCF
00051C D293 30EA            12      JR  NC,LTNL
00051E D295 CD4CD9          17      CALL    MSG_A
000521 D298 18F4            12      JR  CPATHP
       D29A                     CPATH0:
000523 D29A FE3B             7      CP  ';'
000525 D29C 2001            12      JR  NZ,CPATH1
000527 D29E 13               6      INC DE
       D29F                     CPATH1:
000528 D29F EB               4      EX  DE,HL
000529 D2A0 014000          10      LD  BC,PATHX
00052C D2A3 EDB0                    LDIR
00052E D2A5 C9              10      RET
                                
       D2A6                     PUTDRV:
00052F D2A6 3A14EF          13      LD  A,(FDRV)
000532 D2A9 C640             7      ADD A,'A'-1
000534 D2AB CD4CD9          17      CALL    MSG_A
000537 D2AE 3E3A             7      LD  A,':'
       D2B0                     MSG_AR:
000539 D2B0 C34CD9          10      JP  MSG_A
                                
       D2B3                     PRDEC_HL:
00053C D2B3 AF               4      XOR A
       D2B4                     PRDEC_AHL:
00053D D2B4 5F               4      LD  E,A
00053E D2B5 1600             7      LD  D,0
       D2B7                     PRDEC_DEHL:
000540 D2B7 D5              11      PUSH    DE
000541 D2B8 110FEF          10      LD  DE,DECBF
000544 D2BB 0605             7      LD  B,5
000546 D2BD CDBDD3          17      CALL    ZERO_MEMORY_DE  ;A=0
000549 D2C0 D1              10      POP DE
                                
00054A D2C1 0E20             7      LD  C,32
       D2C3                     DEC1:
00054C D2C3 29              11      ADD HL,HL
00054D D2C4 EB               4      EX  DE,HL
00054E D2C5 ED6A            15      ADC HL,HL
000550 D2C7 EB               4      EX  DE,HL
000551 D2C8 E5              11      PUSH    HL
000552 D2C9 2113EF          10      LD  HL,DECBF+4
000555 D2CC 0605             7      LD  B,5
       D2CE                     DEC2:
000557 D2CE 7E               7      LD  A,(HL)
000558 D2CF 8F               4      ADC A,A
000559 D2D0 27               4      DAA
00055A D2D1 77               7      LD  (HL),A
00055B D2D2 2B               6      DEC HL
00055C D2D3 10F9            13      DJNZ    DEC2
00055E D2D5 E1              10      POP HL
00055F D2D6 0D               4      DEC C
000560 D2D7 20EA            12      JR  NZ,DEC1
                                
000562 D2D9 210FEF          10      LD  HL,DECBF
000565 D2DC 3E20             7      LD  A,020H
000567 D2DE 0604             7      LD  B,4
       D2E0                     DEC3:
000569 D2E0 CDEDD2          17      CALL    DEC4
00056C D2E3 CDEDD2          17      CALL    DEC4
00056F D2E6 23               6      INC HL
000570 D2E7 10F7            13      DJNZ    DEC3
       D2E9                     DECX:
000572 D2E9 CDEDD2          17      CALL    DEC4
000575 D2EC AF               4      XOR A
       D2ED                     DEC4:
000576 D2ED ED6F            18      RLD
000578 D2EF FE20             7      CP  020H
00057A D2F1 2802            12      JR  Z,DEC5
00057C D2F3 F630             7      OR  030H
       D2F5                     DEC5:
00057E D2F5 18B9            12      JR  MSG_AR
                                
       D2F7                     FPRNT:
000580 D2F7 0608             7      LD  B,8
000582 D2F9 CD0AD3          17      CALL    P_N1
000585 D2FC 7E               7      LD  A,(HL)
000586 D2FD C680             7      ADD A,0A0H-020H
000588 D2FF FEA0             7      CP  0A0H
00058A D301 2802            12      JR  Z,FPR1
00058C D303 3E2E             7      LD  A,'.'
       D305                     FPR1:
00058E D305 CD4CD9          17      CALL    MSG_A
000591 D308 0603             7      LD  B,3
                                
       D30A                     P_N1:
000593 D30A C5              11      PUSH    BC
000594 D30B E5              11      PUSH    HL
000595 D30C 7E               7      LD  A,(HL)
000596 D30D CDF2E0          17      CALL    CAP3
000599 D310 CD4CD9          17      CALL    MSG_A
00059C D313 E1              10      POP HL
00059D D314 C1              10      POP BC
00059E D315 23               6      INC HL
00059F D316 10F2            13      DJNZ    P_N1
0005A1 D318 C9              10      RET
                                
       D319                     PRTTMS:
0005A2 D319 3E20             7      LD  A,020H
0005A4 D31B CD4CD9          17      CALL    MSG_A
                                
0005A7 D31E 2A3DD5          16      LD  HL,(DTA_CCP+1+24)
0005AA D321 7D               4      LD  A,L
0005AB D322 B7               4      OR  A
0005AC D323 C8              11      RET Z
0005AD D324 CB3C             8      SRL H
0005AF D326 17               4      RLA
0005B0 D327 17               4      RLA
0005B1 D328 17               4      RLA
0005B2 D329 17               4      RLA
0005B3 D32A E60F             7      AND 00FH
0005B5 D32C 57               4      LD  D,A
0005B6 D32D 7C               4      LD  A,H
0005B7 D32E C650             7      ADD A,80
0005B9 D330 CD73D3          17      CALL    PRDEC_A
0005BC D333 3E2D             7      LD  A,'-'
0005BE D335 CD4CD9          17      CALL    MSG_A
0005C1 D338 7A               4      LD  A,D
0005C2 D339 CD73D3          17      CALL    PRDEC_A
0005C5 D33C 3E2D             7      LD  A,'-'
0005C7 D33E CD4CD9          17      CALL    MSG_A
0005CA D341 7D               4      LD  A,L
0005CB D342 E61F             7      AND 01FH
0005CD D344 CD73D3          17      CALL    PRDEC_A
                                
0005D0 D347 2A3BD5          16      LD  HL,(DTA_CCP+1+22)
                                
0005D3 D34A 3E20             7      LD  A,020H
0005D5 D34C CD4CD9          17      CALL    MSG_A
0005D8 D34F 7C               4      LD  A,H
0005D9 D350 65               4      LD  H,L
0005DA D351 0603             7      LD  B,3
       D353                     PRTTMS1:
0005DC D353 1F               4      RRA
0005DD D354 CB1D             8      RR  L
0005DF D356 10FB            13      DJNZ    PRTTMS1
0005E1 D358 E61F             7      AND 01FH
0005E3 D35A CD73D3          17      CALL    PRDEC_A
0005E6 D35D 3E3A             7      LD  A,':'
0005E8 D35F CD4CD9          17      CALL    MSG_A
0005EB D362 7D               4      LD  A,L
0005EC D363 0F               4      RRCA
0005ED D364 0F               4      RRCA
0005EE D365 E63F             7      AND 03FH
0005F0 D367 CD73D3          17      CALL    PRDEC_A
0005F3 D36A 3E3A             7      LD  A,':'
0005F5 D36C CD4CD9          17      CALL    MSG_A
0005F8 D36F 7C               4      LD  A,H
0005F9 D370 E61F             7      AND 01FH
0005FB D372 87               4      ADD A,A
                                
                                ;   PRINT10
                                
       D373                     PRDEC_A:
0005FC D373 E5              11      PUSH    HL
0005FD D374 0608             7      LD  B,8
0005FF D376 4F               4      LD  C,A
000600 D377 AF               4      XOR A
       D378                     PRTA1:
000601 D378 CB01             4      RLC C
000603 D37A 8F               4      ADC A,A
000604 D37B 27               4      DAA
000605 D37C 10FA            13      DJNZ    PRTA1
000607 D37E 210FEF          10      LD  HL,DECBF
00060A D381 77               7      LD  (HL),A
00060B D382 AF               4      XOR A
00060C D383 CDE9D2          17      CALL    DECX
00060F D386 E1              10      POP HL
000610 D387 C9              10      RET
                                
       D388                     SETFCB:
000611 D388 CDB1DE          17      CALL    SPCUT
000614 D38B 1A               7      LD  A,(DE)
000615 D38C FE20             7      CP  020H
000617 D38E 3801            12      JR  C,SETFCBA
000619 D390 1B               6      DEC DE
       D391                     SETFCBA:
00061A D391 0624             7      LD  B,36
00061C D393 215C00          10      LD  HL,FCB1
00061F D396 E5              11      PUSH    HL
000620 D397 AF               4      XOR A
000621 D398 CD86DE          17      CALL    FILL_MEMORY
000624 D39B E1              10      POP HL
000625 D39C D5              11      PUSH    DE
000626 D39D CDC9D8          17      CALL    _SYS5C      ;(BDOS)ファイル名の解析
000629 D3A0 216C00          10      LD  HL,FCB2
00062C D3A3 CDC9D8          17      CALL    _SYS5C      ;(BDOS)ファイル名の解析
00062F D3A6 E1              10      POP HL
000630 D3A7 010050          10      LD  BC,05000H
000633 D3AA 118100          10      LD  DE,00081H
       D3AD                     SETFCB1:
000636 D3AD 7E               7      LD  A,(HL)
000637 D3AE 23               6      INC HL
000638 D3AF FE20             7      CP  020H
00063A D3B1 3805            12      JR  C,SETFCB2
00063C D3B3 12               7      LD  (DE),A
00063D D3B4 13               6      INC DE
00063E D3B5 0C               4      INC C
00063F D3B6 10F5            13      DJNZ    SETFCB1
       D3B8                     SETFCB2:
000641 D3B8 79               4      LD  A,C
000642 D3B9 328000          13      LD  (DTA1),A
000645 D3BC 04               4      INC B
       D3BD                     ZERO_MEMORY_DE:
000646 D3BD AF               4      XOR A
       D3BE                     FILL_MEMORY_DE:
000647 D3BE 12               7      LD  (DE),A
000648 D3BF 13               6      INC DE
000649 D3C0 10FC            13      DJNZ    FILL_MEMORY_DE
00064B D3C2 C9              10      RET
                                
       D3C3                     C_COPY:
00064C D3C3 CD88D3          17      CALL    SETFCB
00064F D3C6 118100          10      LD  DE,DTA1+1
000652 D3C9 0E2F             7      LD  C,'/'
000654 D3CB CDB7D1          17      CALL    SWITCH
000657 D3CE CDE6E0          17      CALL    CAP
00065A D3D1 3259D4          13      LD  (SW+1),A
                                
00065D D3D4 1161EF          10      LD  DE,BEEPD
000660 D3D7 CDD2DD          17      CALL    FILEC2
000663 D3DA 216C00          10      LD  HL,FCB2
000666 D3DD CDD0D8          17      CALL    S29X1
                                
000669 D3E0 3E10             7      LD  A,010H
00066B D3E2 326900          13      LD  (FCB1+13),A
00066E D3E5 216D00          10      LD  HL,FCB2+1
000671 D3E8 CD19D5          17      CALL    CWILD1
       D3EB                     COPY0:
000674 D3EB CD16D5          17      CALL    CWILD
000677 D3EE 215C00          10      LD  HL,FCB1
00067A D3F1 CDA3D0          17      CALL    OPEN
00067D D3F4 37               4      SCF
       D3F5                     COPY1:
00067E D3F5 C0              11      RET NZ
00067F D3F6 CDB6D0          17      CALL    DEFCB
                                
000682 D3F9 3A31D5          13      LD  A,(DTA_CCP+13)
000685 D3FC CB67             8      BIT 4,A
000687 D3FE 2824            12      JR  Z,COPY1A
                                
000689 D400 215D00          10      LD  HL,FCB1+1
00068C D403 CD15E2          17      CALL    CHKWILD
00068F D406 3817            12      JR  C,COPY9
                                
000691 D408 3E20             7      LD  A,020H
000693 D40A 325D00          13      LD  (FCB1+1),A
000696 D40D 2A3ED5          16      LD  HL,(DTA_CCP+26)
000699 D410 23               6      INC HL
00069A D411 226A00          16      LD  (FCB1+14),HL
00069D D414 18D5            12      JR  COPY0
                                
       D416                     COPYS:
00069F D416 1174EF          10      LD  DE,SKIP
       D419                     COPY8:
0006A2 D419 CD66D6          17      CALL    _SYS09      ;(BDOS)文字列出力
0006A5 D41C CD7FD2          17      CALL    LTNL
       D41F                     COPY9:
0006A8 D41F CDB2D0          17      CALL    OPEN2
0006AB D422 18D1            12      JR  COPY1
                                
       D424                     COPY1A:
0006AD D424 216C00          10      LD  HL,FCB2
0006B0 D427 1114EF          10      LD  DE,FDRV
0006B3 D42A 0126D5          10      LD  BC,DTA_CCP+2
0006B6 D42D EDA0            16      LDI
0006B8 D42F 3E0B             7      LD  A,11
       D431                     COPY2:
0006BA D431 F5              11      PUSH    AF
0006BB D432 7E               7      LD  A,(HL)
0006BC D433 FE3F             7      CP  '?'
0006BE D435 2001            12      JR  NZ,COPY3
0006C0 D437 0A               7      LD  A,(BC)
       D438                     COPY3:
0006C1 D438 12               7      LD  (DE),A
0006C2 D439 03               6      INC BC
0006C3 D43A 13               6      INC DE
0006C4 D43B 23               6      INC HL
0006C5 D43C F1              10      POP AF
0006C6 D43D 3D               4      DEC A
0006C7 D43E 20F1            12      JR  NZ,COPY2
0006C9 D440 010500          10      LD  BC,16-11
0006CC D443 EDB0                    LDIR
       D445                     PUTNAME:
0006CE D445 215D00          10      LD  HL,FCB1+1
0006D1 D448 CD15E2          17      CALL    CHKWILD
0006D4 D44B 300B            12      JR  NC,PUTN1
0006D6 D44D 2115EF          10      LD  HL,FDRV+1
0006D9 D450 CDF7D2          17      CALL    FPRNT
0006DC D453 3E20             7      LD  A,020H
0006DE D455 CD4CD9          17      CALL    MSG_A
       D458                     PUTN1:
0006E1 D458 3E00             7  SW: LD  A,000H
0006E3 D45A FE54             7      CP  'T'
0006E5 D45C 2005            12      JR  NZ,CSW1
0006E7 D45E 2178D4          10      LD  HL,SWNE
0006EA D461 1807            12      JR  SWT1
       D463                     CSW1:
0006EC D463 FE4E             7      CP  'N'
0006EE D465 2011            12      JR  NZ,SWNE
0006F0 D467 2116D4          10      LD  HL,COPYS
       D46A                     SWT1:
0006F3 D46A 1114EF          10      LD  DE,FDRV
0006F6 D46D CDCFD0          17      CALL    SYSC0F
0006F9 D470 2801            12      JR  Z,SWN1
0006FB D472 E9               4      JP  (HL)
       D473                     SWN1:
0006FC D473 CDCCD4          17      CALL    CTIME
0006FF D476 309E            12      JR  NC,COPYS
       D478                     SWNE:
000701 D478 1114EF          10      LD  DE,FDRV
000704 D47B 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
000706 D47D CDD1D0          17      CALL    SYSTEM0
000709 D480 2048            12      JR  NZ,COPYE2
00070B D482 67               4      LD  H,A     ;A=0
00070C D483 6F               4      LD  L,A
00070D D484 2235EF          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
000710 D487 2237EF          16      LD  (FDRV+35),HL
       D48A                     COPY6:
000713 D48A CDDAD0          17      CALL    S27BUF
000716 D48D 47               4      LD  B,A
000717 D48E 3C               4      INC A
000718 D48F 2831            12      JR  Z,COPYE
00071A D491 7C               4      LD  A,H
00071B D492 B5               4      OR  L
00071C D493 280C            12      JR  Z,COPY7
00071E D495 1114EF          10      LD  DE,FDRV
000721 D498 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
000723 D49A CDD1D0          17      CALL    SYSTEM0
000726 D49D 2023            12      JR  NZ,COPYE
000728 D49F 10E9            13      DJNZ    COPY6
       D4A1                     COPY7:
00072A D4A1 3A31D5          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
00072D D4A4 3221EF          13      LD  (FDRV+13),A
000730 D4A7 2138D5          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
000733 D4AA 1128EF          10      LD  DE,FDRV+20
000736 D4AD 010400          10      LD  BC,4
000739 D4B0 EDB0                    LDIR
                                
00073B D4B2 1114EF          10      LD  DE,FDRV
00073E D4B5 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
000740 D4B7 CDD1D0          17      CALL    SYSTEM0
000743 D4BA 2006            12      JR  NZ,COPYE
                                
000745 D4BC 1171EF          10      LD  DE,OK
000748 D4BF C319D4          10      JP  COPY8
                                
       D4C2                     COPYE:
00074B D4C2 1114EF          10      LD  DE,FDRV
00074E D4C5 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
000750 D4C7 CD0500          17      CALL    SYSTEM
       D4CA                     COPYE2:
000753 D4CA 37               4      SCF
000754 D4CB C9              10      RET
                                
       D4CC                     CTIME:
000755 D4CC ED5B38D5        20      LD  DE,(DTA_CCP+20)
000759 D4D0 2A28EF          16      LD  HL,(FDRV+20)
00075C D4D3 A7               4      AND A
00075D D4D4 ED52            15      SBC HL,DE
00075F D4D6 C0              11      RET NZ
000760 D4D7 ED5B3AD5        20      LD  DE,(DTA_CCP+22)
000764 D4DB 2A2AEF          16      LD  HL,(FDRV+22)
000767 D4DE ED52            15      SBC HL,DE
000769 D4E0 C9              10      RET
                                
       D4E1                     C_TYPE:
00076A D4E1 CD88D3          17      CALL    SETFCB
00076D D4E4 215C00          10      LD  HL,FCB1
000770 D4E7 CDA3D0          17      CALL    OPEN
000773 D4EA 37               4      SCF
       D4EB                     TYPE1:
000774 D4EB C0              11      RET NZ
000775 D4EC CDB6D0          17      CALL    DEFCB
000778 D4EF 3E06             7      LD  A,6
00077A D4F1 CD4CD9          17      CALL    MSG_A
       D4F4                     TYPE2:
00077D D4F4 CDDAD0          17      CALL    S27BUF
000780 D4F7 C6FE             7      ADD A,0FEH
000782 D4F9 D8              11      RET C
000783 D4FA 7C               4      LD  A,H
000784 D4FB B5               4      OR  L
000785 D4FC 2813            12      JR  Z,TYPEE
000787 D4FE 010001          10      LD  BC,00100H
       D501                     TYPE3:
00078A D501 0A               7      LD  A,(BC)
00078B D502 03               6      INC BC
00078C D503 FE1A             7      CP  01AH
00078E D505 280A            12      JR  Z,TYPEE
000790 D507 CD4CD9          17      CALL    MSG_A
000793 D50A 2B               6      DEC HL
000794 D50B 7C               4      LD  A,H
000795 D50C B5               4      OR  L
000796 D50D 20F2            12      JR  NZ,TYPE3
000798 D50F 18E3            12      JR  TYPE2
       D511                     TYPEE:
00079A D511 CDB2D0          17      CALL    OPEN2
00079D D514 18D5            12      JR  TYPE1
                                
       D516                     CWILD:
00079F D516 215D00          10      LD  HL,FCB1+1
       D519                     CWILD1:
0007A2 D519 7E               7      LD  A,(HL)
0007A3 D51A FE20             7      CP  020H
0007A5 D51C C0              11      RET NZ
       D51D                     CWILD2:
0007A6 D51D 3E3F             7      LD  A,'?'
0007A8 D51F 060B             7      LD  B,11
0007AA D521 C386DE          10      JP  FILL_MEMORY
                                
       D524                     DTA_CCP:
0007AD D524                         DS  37
                                
       0040                     PATHX   EQU 64
0007D2 D549                     PATHD:  DS  PATHX
000812 D589 00                  PATHE:  DB  0
                                
       0009                     COMS    EQU 9
       D58A                     COMTB:
000813 D58A 44202020                DB  "D   "  ;1
000817 D58E DFD1                    DW  C_DIR
000819 D590 44495220                DB  "DIR "  ;2
00081D D594 DFD1                    DW  C_DIR
00081F D596 434F5059                DB  "COPY"  ;3
000823 D59A C3D3                    DW  C_COPY
000825 D59C 43442020                DB  "CD  "  ;4
000829 D5A0 D6D0                    DW  C_CD
00082B D5A2 44454C20                DB  "DEL "  ;5
00082F D5A6 C2D1                    DW  C_DEL
000831 D5A8 50415448                DB  "PATH"  ;6
000835 D5AC 84D2                    DW  C_PATH
000837 D5AE 52454E20                DB  "REN "  ;7
00083B D5B2 CCD1                    DW  C_REN
00083D D5B4 54595045                DB  "TYPE"  ;8
000841 D5B8 E1D4                    DW  C_TYPE
000843 D5BA 52454D20                DB  "REM "  ;9
000847 D5BE C0D1                    DW  C_REM
                                
000849 D5C0 2062797465732066    FREE:   DB  " bytes free",9,'$'
            7265650924          
000856 D5CD 20202020203C4449    DIRMES: DB  "     <DIR>$"
            523E24              
000861 D5D8 20203A24            DIRHD:  DB  "  :$"
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   MZ-700/1500
                                
                                ;   EMM DRIVER
                                
                                
       D5DC                     EDWT:
000865 D5DC F5              11      PUSH    AF
000866 D5DD CDFBD5          17      CALL    EADR
000869 D5E0 0600             7      LD  B,0
       D5E2                     EDWT1:
00086B D5E2 EDB3                    OTIR
00086D D5E4 3D               4      DEC A
00086E D5E5 20FB            12      JR  NZ,EDWT1
000870 D5E7 180B            12      JR  EDRW1
                                
       D5E9                     EDRD:
000872 D5E9 C5              11      PUSH    BC
000873 D5EA CDFBD5          17      CALL    EADR
000876 D5ED 0600             7      LD  B,0
       D5EF                     EDRD1:
000878 D5EF EDB2                    INIR
00087A D5F1 3D               4      DEC A
00087B D5F2 20FB            12      JR  NZ,EDRD1
       D5F4                     EDRW1:
00087D D5F4 F1              10      POP AF
00087E D5F5 83               4      ADD A,E ;セクタを進める
00087F D5F6 5F               4      LD  E,A
000880 D5F7 8A               4      ADC A,D
000881 D5F8 93               4      SUB E
000882 D5F9 57               4      LD  D,A
000883 D5FA C9              10      RET
                                
       D5FB                     EADR:
000884 D5FB C5              11      PUSH    BC
000885 D5FC D5              11      PUSH    DE
000886 D5FD EB               4      EX  DE,HL
000887 D5FE 29              11      ADD HL,HL
000888 D5FF DD4E0D          19      LD  C,(IX+00DH) ;DPB_0D_MAXSEC
00088B D602 DD460C          19      LD  B,(IX+00CH) ;DPB_0C_MAXCYL
00088E D605 09              11      ADD HL,BC
00088F D606 DD4E13          19      LD  C,(IX+013H) ;DPB_13_UNITNO
000892 D609 ED49            12      OUT (C),C
000894 D60B 0C               4      INC C
000895 D60C ED69            12      OUT (C),L
000897 D60E 0C               4      INC C
000898 D60F ED61            12      OUT (C),H
00089A D611 0C               4      INC C
00089B D612 EB               4      EX  DE,HL
00089C D613 D1              10      POP DE
00089D D614 DD460F          19      LD  B,(IX+00FH) ;DPB_0F_BPS
0008A0 D617 F1              10      POP AF
       D618                     EADR1:              ;読み込むセクタ数と1クラスタのセクタ数を掛ける
0008A1 D618 CB18             8      RR  B
0008A3 D61A D8              11      RET C
0008A4 D61B 87               4      ADD A,A
0008A5 D61C 18FA            12      JR  EADR1
[EOF:M7DISK2.ASM:UTF_8]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       D61E                     BDOS0:
0008A7 D61E E5              11      PUSH    HL
0008A8 D61F 210001          10      LD  HL,00100H
0008AB D622 39              11      ADD HL,SP
0008AC D623 3810            12      JR  C,BDOS1X
       D625                     BDOS2:
0008AE D625 E1              10      POP HL
0008AF D626 ED7331D6        20      LD  (BDSP+1),SP
0008B3 D62A 31FECF          10      LD  SP,EXTSP
0008B6 D62D CD34D6          17      CALL    BDOS1
0008B9 D630 310000          10  BDSP:   LD  SP,0
0008BC D633 C9              10      RET
       D634                     BDOS1:
0008BD D634 E5              11      PUSH    HL
       D635                     BDOS1X:
0008BE D635 79               4      LD  A,C
0008BF D636 FE3C             7      CP  03CH
0008C1 D638 3802            12      JR  C,DOS1
0008C3 D63A 3E3C             7      LD  A,03CH
       D63C                     DOS1:
0008C5 D63C 87               4      ADD A,A
0008C6 D63D 6F               4      LD  L,A
0008C7 D63E 26F0             7      LD  H,STABLE/256
0008C9 D640 7E               7      LD  A,(HL)
0008CA D641 2C               4      INC L
0008CB D642 66               7      LD  H,(HL)
0008CC D643 6F               4      LD  L,A
0008CD D644 E3              19      EX  (SP),HL
0008CE D645 79               4      LD  A,C
0008CF D646 C9              10      RET
       D647                     _DOS2:
0008D0 D647 FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
0008D2 D649 CA0DD9          10      JP  Z,_SYS5A
0008D5 D64C FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
0008D7 D64E CAC9D8          10      JP  Z,_SYS5C
0008DA D651 FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
0008DC D653 CA41EA          10      JP  Z,_SYS5F
0008DF D656 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
0008E1 D658 200A            12      JR  NZ,_ERROR
0008E3 D65A 011D01          10      LD  BC,011DH
0008E6 D65D 114701          10      LD  DE,VER
0008E9 D660 210100          10      LD  HL,MACD
0008EC D663 AF               4      XOR A
       D664                     _ERROR:
0008ED D664 A7               4      AND A
0008EE D665 C9              10      RET
                                
       D666                     _SYS09:     ;文字列出力
0008EF D666 D5              11      PUSH    DE
       D667                     _SX09:
0008F0 D667 1A               7      LD  A,(DE)
0008F1 D668 13               6      INC DE
0008F2 D669 FE24             7      CP  '$'
0008F4 D66B 2831            12      JR  Z,SX0E2
0008F6 D66D CD4CD9          17      CALL    MSG_A
0008F9 D670 18F5            12      JR  _SX09
                                
       D672                     MSX1:
0008FB D672 CD4CD9          17      CALL    MSG_A
       D675                     MSX:
0008FE D675 7E               7      LD  A,(HL)
0008FF D676 23               6      INC HL
000900 D677 B7               4      OR  A
000901 D678 20F8            12      JR  NZ,MSX1
000903 D67A C9              10      RET
                                
       D67B                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000904 D67B 212200          10      LD  HL,00022H
000907 D67E 7D               4      LD  A,L
000908 D67F C9              10      RET
                                
       D680                     _SYS0D:     ;(BDOS)ディスクリセット
000909 D680 CDDFEF          17      CALL    _FFLUSH
00090C D683 E5              11      PUSH    HL
00090D D684 218000          10      LD  HL,00080H
000910 D687 228AEF          16      LD  (_DTA),HL
000913 D68A E1              10      POP HL
000914 D68B D5              11      PUSH    DE
000915 D68C 1E00             7      LD  E,0
000917 D68E 3E                      DB  03EH
                                
       D68F                     _SYS0E:     ;(BDOS)カレントドライブの設定
000918 D68F D5              11      PUSH    DE
000919 D690 7B               4      LD  A,E
00091A D691 DDE5            15      PUSH    IX
00091C D693 CDDCEF          17      CALL    _GETDPB
00091F D696 DDE1            14      POP IX
000921 D698 3804            12      JR  C,SX0E2
000923 D69A 7B               4      LD  A,E
000924 D69B 3287EF          13      LD  (_DVSW),A
       D69E                     SX0E2:
000927 D69E 3E08             7      LD  A,8
000929 D6A0 D1              10      POP DE
00092A D6A1 C9              10      RET
                                
       D6A2                     _SYS0F:     ;(BDOS)ファイルのオープン
00092B D6A2 CDC3DE          17      CALL    SETDRV
00092E D6A5 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000931 D6A8 C602             7      ADD A,002H      ;Write
000933 D6AA 2848            12      JR  Z,FEND0F
000935 D6AC CD11E2          17      CALL    CHKWILDX
                                
000938 D6AF D4E3DE          17      CALL    NC,SOPENX
       D6B2                     _S16XX:
00093B D6B2 3840            12      JR  C,FEND0F
                                                ;Directory location
00093D D6B4 3A9FEF          13      LD  A,(_FILEN)
000940 D6B7 FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
000943 D6BA 3AA0EF          13      LD  A,(_DIRF)
000946 D6BD FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
000949 D6C0 FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
00094C D6C3 FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
00094F D6C6 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
000953 D6CA FDE5            15      PUSH    IY
000955 D6CC D1              10      POP DE
000956 D6CD 13               6      INC DE
000957 D6CE 010B00          10      LD  BC,11
00095A D6D1 EDB0                    LDIR
                                ;               Attribute
00095C D6D3 7E               7      LD  A,(HL)
00095D D6D4 FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
000960 D6D7 110B00          10      LD  DE,11       ;Reserved
000963 D6DA 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
000964 D6DB 11EAF0          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
000967 D6DE 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D6E0                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
000969 D6E0 1A               7      LD  A,(DE)
00096A D6E1 13               6      INC DE
00096B D6E2 32E9D6          13      LD  (S16PAT+2),A
00096E D6E5 7E               7      LD  A,(HL)
00096F D6E6 23               6      INC HL
000970 D6E7 FD7700          19  S16PAT: LD  (IY+0),A
000973 D6EA 10F4            13      DJNZ    S16LOOP
                                
000975 D6EC AF               4      XOR A
000976 D6ED FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
000979 D6F0 FD2298D7        20      LD  (OFCB+1),IY
       D6F4                     FEND0F:
00097D D6F4 1845            12      JR  FEND10
                                
       D6F6                     _SYS10:     ;(BDOS)ファイルのクローズ
00097F D6F6 CDC3DE          17      CALL    SETDRV
000982 D6F9 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000985 D6FC D6FE             7      SUB 0FEH
000987 D6FE 37               4      SCF
000988 D6FF 3F               4      CCF
000989 D700 2039            12      JR  NZ,FEND10
       D702                     _S10A:              ;Write
00098B D702 FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
00098E D705 FD770F          19      LD  (IY+15),A
                                
000991 D708 FD341C          23      INC (IY+28)     ;0FEH->0FFH ;オープンモード
000994 D70B CDFFE2          17      CALL    SETTMS
                                
000997 D70E FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
00099A D711 32A0EF          13      LD  (_DIRF),A
00099D D714 E67F             7      AND 07FH
00099F D716 326EE7          13      LD  (_SECPS+1),A
0009A2 D719 FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
0009A5 D71C FD561F          19      LD  D,(IY+31)
0009A8 D71F CD17E0          17      CALL    READ_DIR
0009AB D722 3817            12      JR  C,FEND10
                                
0009AD D724 3A41DF          13  SDECM1: LD  A,(SDECPAT+1)   ;1セクタ辺りのディレクトリエントリ数
0009B0 D727 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
0009B1 D728 FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
0009B4 D72B 6F               4      LD  L,A
0009B5 D72C 2600             7      LD  H,0
0009B7 D72E 29              11      ADD HL,HL       ;*2
0009B8 D72F 29              11      ADD HL,HL       ;*4
0009B9 D730 29              11      ADD HL,HL       ;*8
0009BA D731 29              11      ADD HL,HL       ;*16
0009BB D732 29              11      ADD HL,HL       ;*32
0009BC D733 ED4B7EF0        20      LD  BC,(_DTBUF)
0009C0 D737 09              11      ADD HL,BC
                                
0009C1 D738 CD21E2          17      CALL    SDIRENT
       D73B                     FEND10:
0009C4 D73B 1842            12      JR  FEND
                                
       D73D                     _SYS11:     ;(BDOS)最初のファイルの検索
0009C6 D73D CDC3DE          17      CALL    SETDRV
0009C9 D740 CD10DF          17      CALL    SOPEN
       D743                     _S12X1:
0009CC D743 383A            12      JR  C,FEND
0009CE D745 CDB0DF          17      CALL    SOPENE2
0009D1 D748 ED5B8AEF        20      LD  DE,(_DTA)
0009D5 D74C 3A88EF          13      LD  A,(_DRV)
0009D8 D74F 3C               4      INC A
0009D9 D750 12               7      LD  (DE),A
0009DA D751 D5              11      PUSH    DE
0009DB D752 13               6      INC DE
0009DC D753 012000          10      LD  BC,32
0009DF D756 EDB0                    LDIR
0009E1 D758 FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
0009E4 D75B FD660F          19      LD  H,(IY+15)
0009E7 D75E 22F4F0          16      LD  (SCDIR),HL
0009EA D761 2A9AEF          16      LD  HL,(_FBPS)
0009ED D764 22F6F0          16      LD  (SFBPS),HL
0009F0 D767 2A9FEF          16      LD  HL,(_FILEN)
0009F3 D76A 7C               4      LD  A,H
0009F4 D76B B7               4      OR  A
0009F5 D76C 2806            12      JR  Z,_S12DIR
0009F7 D76E 3A6EE7          13      LD  A,(_SECPS+1)
0009FA D771 F680             7      OR  080H
0009FC D773 67               4      LD  H,A
       D774                     _S12DIR:
0009FD D774 22F8F0          16      LD  (SFNDF),HL  ;Directory position and Flags
000A00 D777 E1              10      POP HL
000A01 D778 1139EF          10      LD  DE,SFILE
000A04 D77B 0E21             7      LD  C,33
       D77D                     _S11B:
000A06 D77D EDB0                    LDIR
       D77F                     FEND:
000A08 D77F 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D780                     FENDE:
000A09 D780 FDE1            14      POP IY
000A0B D782 C1              10      POP BC
000A0C D783 D1              10      POP DE
000A0D D784 E1              10      POP HL
000A0E D785 C9              10      RET
                                
       D786                     _SYS12:     ;(BDOS)次のファイルの検索
000A0F D786 E5              11      PUSH    HL
000A10 D787 D5              11      PUSH    DE
000A11 D788 C5              11      PUSH    BC
000A12 D789 FDE5            15      PUSH    IY
000A14 D78B CD74DF          17      CALL    NOPEN
000A17 D78E 18B3            12      JR  _S12X1
                                
       D790                     _S16K:
000A19 D790 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000A1C D793 FEFD             7      CP  0FDH        ;Device(0FDH)
000A1E D795 37               4      SCF
000A1F D796 C8              11      RET Z
                                
000A20 D797 110000          10  OFCB:   LD  DE,0
000A23 D79A D5              11      PUSH    DE
000A24 D79B 061A             7      LD  B,26        ;First cluster
       D79D                     S16K1:
000A26 D79D 13               6      INC DE
000A27 D79E 23               6      INC HL
000A28 D79F 10FC            13      DJNZ    S16K1
                                
000A2A D7A1 1A               7      LD  A,(DE)
000A2B D7A2 BE               7      CP  (HL)
000A2C D7A3 2013            12      JR  NZ,S16K2
000A2E D7A5 13               6      INC DE
000A2F D7A6 23               6      INC HL
000A30 D7A7 1A               7      LD  A,(DE)
000A31 D7A8 BE               7      CP  (HL)
000A32 D7A9 200D            12      JR  NZ,S16K2
                                
000A34 D7AB E1              10      POP HL
000A35 D7AC FDE5            15      PUSH    IY
000A37 D7AE D1              10      POP DE
000A38 D7AF 1A               7      LD  A,(DE)      ;Drive
000A39 D7B0 BE               7      CP  (HL)
000A3A D7B1 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
000A3C D7B3 ED52            15      SBC HL,DE       ;CP HL,DE
000A3E D7B5 37               4      SCF
000A3F D7B6 C0              11      RET NZ
000A40 D7B7 E5              11      PUSH    HL
       D7B8                     S16K2:
000A41 D7B8 E1              10      POP HL
       D7B9                     S16K3:
000A42 D7B9 FDE5            15      PUSH    IY
000A44 D7BB D1              10      POP DE
       D7BC                     _SYS13:     ;(BDOS)ファイルの削除
000A45 D7BC CDC3DE          17      CALL    SETDRV
000A48 D7BF CD41E1          17      CALL    KILL
       D7C2                     FEND13:
000A4B D7C2 18BB            12      JR  FEND
                                
       D7C4                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000A4D D7C4 CDC3DE          17      CALL    SETDRV
000A50 D7C7 CD31E3          17      CALL    PUSHRR
000A53 D7CA CD72E3          17      CALL    GETSEQ
                                
000A56 D7CD CD86E3          17      CALL    RB_READ
000A59 D7D0 E5              11      PUSH    HL
000A5A D7D1 CD45E3          17      CALL    SETSEQ
       D7D4                     SREAD:
000A5D D7D4 E1              10      POP HL
                                
000A5E D7D5 C601             7      ADD A,001H
000A60 D7D7 38A6            12      JR  C,FEND
                                
000A62 D7D9 7D               4      LD  A,L
000A63 D7DA D601             7      SUB 001H
       D7DC                     FENDX:
000A65 D7DC 9F               4      SBC A,A
000A66 D7DD E603             7      AND 3
000A68 D7DF 1F               4      RRA
000A69 D7E0 189E            12      JR  FENDE
                                
       D7E2                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
000A6B D7E2 CDC3DE          17      CALL    SETDRV
000A6E D7E5 CD31E3          17      CALL    PUSHRR
000A71 D7E8 CD72E3          17      CALL    GETSEQ
                                
000A74 D7EB CD7FE3          17      CALL    RB_WRITE
000A77 D7EE E5              11      PUSH    HL
000A78 D7EF CD45E3          17      CALL    SETSEQ
       D7F2                     SWRITE:
000A7B D7F2 E1              10      POP HL
                                
000A7C D7F3 C6FF             7      ADD A,0FFH
000A7E D7F5 18E5            12      JR  FENDX
                                
       D7F7                     _SYS17:     ;(BDOS)ファイル名の変更
000A80 D7F7 CDC3DE          17      CALL    SETDRV
000A83 D7FA CD97E1          17      CALL    NAME
000A86 D7FD 18C3            12      JR  FEND13
                                
       D7FF                     _SYS16:     ;(BDOS)ファイルの作成
000A88 D7FF CDC3DE          17      CALL    SETDRV
                                
000A8B D802 CD11E2          17      CALL    CHKWILDX
000A8E D805 38BB            12      JR  C,FEND13
000A90 D807 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
000A93 D80A FE05             7      CP  5
000A95 D80C 2805            12      JR  Z,_S16X2
000A97 D80E FE21             7      CP  021H
000A99 D810 DAC2D7          10      JP  C,FEND13
       D813                     _S16X2:
                                ;               Clear FCB
000A9C D813 FDE5            15      PUSH    IY
000A9E D815 E1              10      POP HL
000A9F D816 011000          10      LD  BC,16
000AA2 D819 09              11      ADD HL,BC
       D81A                     _S16X1:
000AA3 D81A 70               7      LD  (HL),B      ;B=0
000AA4 D81B 23               6      INC HL
000AA5 D81C 0D               4      DEC C
000AA6 D81D 20FB            12      JR  NZ,_S16X1
                                
000AA8 D81F CD04E3          17      CALL    SETTMSX
000AAB D822 FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000AAF D826 CDE3DE          17      CALL    SOPENX
000AB2 D829 3F               4      CCF
000AB3 D82A CC90D7          17      CALL    Z,_S16K
000AB6 D82D D4C1DF          17      CALL    NC,COPEN
000AB9 D830 D421E2          17      CALL    NC,SDIRENT
000ABC D833 C3B2D6          10      JP  _S16XX
                                
       D836                     _SYS21:     ;(BDOS)ランダムな読み出し
                                
000ABF D836 CDC3DE          17      CALL    SETDRV
000AC2 D839 CD31E3          17      CALL    PUSHRR
000AC5 D83C FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
000AC8 D83F FD6622          19      LD  H,(IY+34)
                                
000ACB D842 CD86E3          17      CALL    RB_READ
000ACE D845 E5              11      PUSH    HL
000ACF D846 CD5CE3          17      CALL    POPRR
000AD2 D849 1889            12      JR  SREAD
                                
       D84B                     _SYS22:     ;(BDOS)ランダムな書き込み
       D84B                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000AD4 D84B CDC3DE          17      CALL    SETDRV
000AD7 D84E CD31E3          17      CALL    PUSHRR
000ADA D851 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
000ADD D854 FD6622          19      LD  H,(IY+34)
                                
000AE0 D857 CD7FE3          17      CALL    RB_WRITE
000AE3 D85A E5              11      PUSH    HL
000AE4 D85B CD5CE3          17      CALL    POPRR
000AE7 D85E 1892            12      JR  SWRITE
                                
       D860                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000AE9 D860 21FF00          10      LD  HL,000FFH
000AEC D863 AF               4      XOR A
000AED D864 C9              10      RET
                                
       D865                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000AEE D865 3A87EF          13      LD  A,(_DVSW)
000AF1 D868 A7               4      AND A
000AF2 D869 C9              10      RET
                                
       D86A                     _SYS1A:     ;(BDOS)DTAの設定
000AF3 D86A ED538AEF        20      LD  (_DTA),DE
000AF7 D86E AF               4      XOR A
000AF8 D86F C9              10      RET
                                
       D870                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000AF9 D870 7B               4      LD  A,E
000AFA D871 CDD6DE          17      CALL    GETDRV
000AFD D874 CDDCEF          17      CALL    _GETDPB
000B00 D877 D4E2EF          17      CALL    NC,_RDFATX
000B03 D87A 210000          10      LD  HL,0
000B06 D87D D4DDE2          17      CALL    NC,DSKF
                                
000B09 D880 ED5BDEE2        20      LD  DE,(MAXCLP+1)   ;DPB_08_MAXCL-1
000B0D D884 1B               6      DEC DE      ;DE←クラスタの総数
000B0E D885 FD2A7CF0        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000B12 D889 9F               4      SBC A,A
000B13 D88A D8              11      RET C
000B14 D88B 4F               4      LD  C,A     ;C=0
000B15 D88C DD7E0F          19      LD  A,(IX+00FH) ;DPB_0F_BPS
000B18 D88F E60F             7      AND 00FH
000B1A D891 47               4      LD  B,A
000B1B D892 DD7E07          19      LD  A,(IX+7)    ;DPB_07_SECPCL
000B1E D895 C9              10      RET
                                
       D896                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000B1F D896 AF               4      XOR A
000B20 D897 67               4      LD  H,A
000B21 D898 6F               4      LD  L,A
000B22 D899 C9              10      RET
                                
       D89A                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000B23 D89A 2100F1          10      LD  HL,DEVICE
000B26 D89D 7B               4      LD  A,E
000B27 D89E C3DCEF          10      JP  _GETDPB
                                
       D8A1                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000B2A D8A1 E5              11      PUSH    HL
000B2B D8A2 2A1EF0          16      LD  HL,(STABLE+2*00FH)  ;ファイルのオープン
000B2E D8A5 CD0F00          17      CALL    JP_HL
000B31 D8A8 3814            12      JR  C,_S23X1
                                
000B33 D8AA D5              11      PUSH    DE      ;EX DE,IY
000B34 D8AB FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000B36 D8AD CD62E3          17      CALL    GETSIZE
       D8B0                     _S24X1:
000B39 D8B0 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
000B3C D8B3 FD7422          19      LD  (IY+34),H
000B3F D8B6 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000B43 D8BA FDE3            23      EX  (SP),IY     ;
000B45 D8BC D1              10      POP DE      ;
                                
000B46 D8BD AF               4      XOR A
       D8BE                     _S23X1:
000B47 D8BE E1              10      POP HL
000B48 D8BF C9              10      RET
                                
       D8C0                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000B49 D8C0 E5              11      PUSH    HL
000B4A D8C1 D5              11      PUSH    DE      ;EX DE,IY
000B4B D8C2 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000B4D D8C4 CD72E3          17      CALL    GETSEQ
000B50 D8C7 18E7            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D8C9                     _SYS5C:     ;(BDOS)ファイル名の解析
000B52 D8C9 C5              11      PUSH    BC
000B53 D8CA E5              11      PUSH    HL
000B54 D8CB CDDADD          17      CALL    FILE
000B57 D8CE E1              10      POP HL
000B58 D8CF C1              10      POP BC
       D8D0                     S29X1:
000B59 D8D0 C5              11      PUSH    BC
000B5A D8D1 D5              11      PUSH    DE
000B5B D8D2 E5              11      PUSH    HL
000B5C D8D3 EB               4      EX  DE,HL
000B5D D8D4 2114EF          10      LD  HL,FDRV
000B60 D8D7 010D00          10      LD  BC,13
000B63 D8DA EDB0                    LDIR
000B65 D8DC 70               7      LD  (HL),B      ;B=0
000B66 D8DD 0E03             7      LD  C,3
000B68 D8DF EDB0                    LDIR
000B6A D8E1 E1              10      POP HL
000B6B D8E2 D1              10      POP DE
000B6C D8E3 C1              10      POP BC
000B6D D8E4 AF               4      XOR A
000B6E D8E5 C9              10      RET
                                
       D8E6                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
000B6F D8E6 C5              11      PUSH    BC
000B70 D8E7 01DCE8          10      LD  BC,DWT24B
000B73 D8EA 1804            12      JR  S2FX
       D8EC                     _SYS2F:
000B75 D8EC C5              11      PUSH    BC
000B76 D8ED 01CCE8          10      LD  BC,DRD24B
       D8F0                     S2FX:
000B79 D8F0 ED4306D9        20      LD  (S2FPAT+1),BC
000B7D D8F4 CDDFEF          17      CALL    _FFLUSH
                                
000B80 D8F7 D5              11      PUSH    DE
000B81 D8F8 E5              11      PUSH    HL
000B82 D8F9 7D               4      LD  A,L     ;Drive
000B83 D8FA CDD9EF          17      CALL    _CHGDRV
000B86 D8FD 3809            12      JR  C,S30X2
000B88 D8FF 44               4      LD  B,H     ;Number of clusters
000B89 D900 2A8AEF          16      LD  HL,(_DTA)
                                
000B8C D903 0E00             7      LD  C,0
000B8E D905 CDCCE8          17  S2FPAT: CALL    DRD24B
       D908                     S30X2:
000B91 D908 E1              10      POP HL
000B92 D909 D1              10      POP DE
000B93 D90A C1              10      POP BC
000B94 D90B 9F               4      SBC A,A
000B95 D90C C9              10      RET
                                
       D90D                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
000B96 D90D C5              11      PUSH    BC
000B97 D90E D5              11      PUSH    DE
000B98 D90F E5              11      PUSH    HL
000B99 D910 CDCFDD          17      CALL    FILEC
000B9C D913 210000          10      LD  HL,0
000B9F D916 1114EF          10      LD  DE,FDRV
000BA2 D919 2A4EF0          16      LD  HL,(STABLE+2*027H)  ;ランダムブロック読み込み
000BA5 D91C CD0F00          17      CALL    JP_HL
000BA8 D91F 18E7            12      JR  S30X2
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "M7IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                
       D664                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D664                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D664                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D664                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D664                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D664                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
       D921                     KEYSET:
       D921                     KEYBS:
000BAA D921 B7               4      OR  A
000BAB D922 C8              11      RET Z
       D923                     KEYBS1:
000BAC D923 CD39D9          17      CALL    KEYBC_IFBREAK
000BAF D926 E5              11      PUSH    HL
000BB0 D927 F5              11      PUSH    AF
000BB1 D928 2A90EF          16      LD  HL,(_KEYPS)
000BB4 D92B 2C               4      INC L
000BB5 D92C 7D               4      LD  A,L
000BB6 D92D BC               4      CP  H
000BB7 D92E 2815            12      JR  Z,POP_AF_HL_SCF_RET
000BB9 D930 3290EF          13      LD  (_KEYPS),A
000BBC D933 26FE             7      LD  H,KEYBF/256
000BBE D935 F1              10      POP AF
000BBF D936 77               7      LD  (HL),A
000BC0 D937 E1              10      POP HL
000BC1 D938 C9              10      RET
       D939                     KEYBC_IFBREAK:
000BC2 D939 FE03             7      CP  3
000BC4 D93B C0              11      RET NZ
       D93C                     KEYBC:
000BC5 D93C E5              11      PUSH    HL
000BC6 D93D 210000          10      LD  HL,0
000BC9 D940 2290EF          16      LD  (_KEYPS),HL
000BCC D943 E1              10      POP HL
000BCD D944 C9              10      RET
                                
       D945                     POP_AF_HL_SCF_RET:
000BCE D945 F1              10      POP AF
000BCF D946 E1              10      POP HL
000BD0 D947 37               4      SCF
000BD1 D948 C9              10      RET
                                
       D949                     _SYS01:     ;(BDOS)コンソール入力
000BD2 D949 CD09EF          17      CALL    _SYS07
       D94C                     MSG_A:
000BD5 D94C F5              11      PUSH    AF
000BD6 D94D D5              11      PUSH    DE
000BD7 D94E 5F               4      LD  E,A
000BD8 D94F CD55D9          17      CALL    _SYS02
000BDB D952 D1              10      POP DE
000BDC D953 F1              10      POP AF
000BDD D954 C9              10      RET
                                
       D955                     _SYS02:     ;(BDOS)コンソール出力
000BDE D955 CD67D9          17      CALL    BREAK
000BE1 D958 1805            12      JR  PRINTX
                                
       D95A                     _SYS06:     ;(BDOS)コンソール直接入出力
000BE3 D95A 7B               4      LD  A,E
000BE4 D95B 3C               4      INC A
000BE5 D95C CACAEF          10      JP  Z,_INKEY
       D95F                     PRINTX:
000BE8 D95F C3CDEF          10      JP  _PRINT
                                
       D962                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000BEB D962 CD09EF          17      CALL    _SYS07
000BEE D965 1803            12      JR  BREAK1
       D967                     BREAK:
000BF0 D967 CDC1DC          17      CALL    CHKEY
       D96A                     BREAK1:
000BF3 D96A FE03             7      CP  3       ;CTRL+C
000BF5 D96C CA00EF          10      JP  Z,CPM_BOOT
000BF8 D96F FE13             7      CP  013H        ;CTRL+S
000BFA D971 C0              11      RET NZ
                                
       D972                     PAUSE:
000BFB D972 CD3CD9          17      CALL    KEYBC
                                
       D975                     FLGET:
000BFE D975 CDDFEF          17      CALL    _FFLUSH
000C01 D978 E5              11      PUSH    HL
000C02 D979 2A8EEF          16      LD  HL,(_TXADR)
000C05 D97C 7C               4      LD  A,H
000C06 D97D C6D0             7      ADD A,0D0H
000C08 D97F 67               4      LD  H,A
000C09 D980 CD21CF          17      CALL    RDMMIO
000C0C D983 3298D9          13      LD  (FLSMC),A
       D986                     FLGET1:
000C0F D986 CD19CF          17      CALL    RD556VSYNC
000C12 D989 CB77             8      BIT 6,A
000C14 D98B 3EEF             7      LD  A,0EFH      ;カーソル
000C16 D98D 200A            12      JR  NZ,FLGET2
000C18 D98F 3A92EF          13      LD  A,(_KEYD)
000C1B D992 B7               4      OR  A
000C1C D993 3EEF             7      LD  A,0EFH      ;カーソル
000C1E D995 2002            12      JR  NZ,FLGET2
       D998                     FLSMC   EQU $+1
000C20 D997 3E00             7      LD  A,0     ;自己書き換え
       D999                     FLGET2:
000C22 D999 CD27CF          17      CALL    WRMMIO
000C25 D99C CDCAEF          17      CALL    _INKEY
000C28 D99F 28E5            12      JR  Z,FLGET1
000C2A D9A1 F5              11      PUSH    AF
000C2B D9A2 3A98D9          13      LD  A,(FLSMC)
000C2E D9A5 CD27CF          17      CALL    WRMMIO
000C31 D9A8 F1              10      POP AF
000C32 D9A9 E1              10      POP HL
000C33 D9AA C9              10      RET
                                
       D9AB                     _SYS0A:     ;(BDOS)文字列入力
000C34 D9AB C5              11      PUSH    BC
000C35 D9AC E5              11      PUSH    HL
000C36 D9AD D5              11      PUSH    DE
000C37 D9AE CD13DC          17      CALL    GETL
000C3A D9B1 1100FF          10      LD  DE,KBUF
000C3D D9B4 E1              10      POP HL
000C3E D9B5 E5              11      PUSH    HL
000C3F D9B6 0E00             7      LD  C,0
000C41 D9B8 3004            12      JR  NC,SAX0
000C43 D9BA 23               6      INC HL
000C44 D9BB 23               6      INC HL
000C45 D9BC 1808            12      JR  SAX4
       D9BE                     SAX0:
000C47 D9BE 46               7      LD  B,(HL)
000C48 D9BF 23               6      INC HL
       D9C0                     SAX1:
000C49 D9C0 23               6      INC HL
000C4A D9C1 1A               7      LD  A,(DE)
000C4B D9C2 13               6      INC DE
000C4C D9C3 B7               4      OR  A
000C4D D9C4 2004            12      JR  NZ,SAX2
       D9C6                     SAX4:
000C4F D9C6 360D            10      LD  (HL),00DH
000C51 D9C8 1804            12      JR  SAX3
       D9CA                     SAX2:
000C53 D9CA 77               7      LD  (HL),A
000C54 D9CB 0C               4      INC C
000C55 D9CC 10F2            13      DJNZ    SAX1
       D9CE                     SAX3:
000C57 D9CE D1              10      POP DE
000C58 D9CF 79               4      LD  A,C
000C59 D9D0 13               6      INC DE
000C5A D9D1 12               7      LD  (DE),A
000C5B D9D2 1B               6      DEC DE
000C5C D9D3 E1              10      POP HL
000C5D D9D4 C1              10      POP BC
000C5E D9D5 A7               4      AND A
000C5F D9D6 C9              10      RET
                                
       D9D7                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000C60 D9D7 CD67D9          17      CALL    BREAK
000C63 D9DA 3A92EF          13      LD  A,(_KEYD)
000C66 D9DD B7               4      OR  A
000C67 D9DE C8              11      RET Z
       D9DF                     CONSTX:
000C68 D9DF CDDFEF          17      CALL    _FFLUSH
000C6B D9E2 E5              11      PUSH    HL
000C6C D9E3 2A90EF          16      LD  HL,(_KEYPS)
000C6F D9E6 7C               4      LD  A,H
000C70 D9E7 AD               4      XOR L
000C71 D9E8 E1              10      POP HL
000C72 D9E9 CCC1DC          17      CALL    Z,CHKEY
000C75 D9EC C6FF             7      ADD A,0FFH
000C77 D9EE 9F               4      SBC A,A
000C78 D9EF C9              10      RET
                                
       D9F0                     _SYS2A:     ;(BDOS)日付の獲得
000C79 D9F0 210000          10      LD  HL,0
000C7C D9F3 110000          10      LD  DE,0
000C7F D9F6 AF               4      XOR A
000C80 D9F7 C9              10      RET
                                
       D9F8                     _SYS2C:     ;(BDOS)時刻の獲得
000C81 D9F8 210000          10      LD  HL,0
000C84 D9FB 110000          10      LD  DE,0
000C87 D9FE AF               4      XOR A
000C88 D9FF C9              10      RET
                                
       DA00                     ESC1:
000C89 DA00 7B               4      LD  A,E
000C8A DA01 FE41             7      CP  'A'
000C8C DA03 CADFDA          10      JP  Z,CTRL1E
000C8F DA06 FE42             7      CP  'B'
000C91 DA08 CAD6DB          10      JP  Z,CTRL1F
000C94 DA0B FE43             7      CP  'C'
000C96 DA0D CAB2DA          10      JP  Z,CTRL1C
000C99 DA10 FE44             7      CP  'D'
000C9B DA12 CAD6DA          10      JP  Z,CTRL1D
000C9E DA15 FE45             7      CP  'E'
000CA0 DA17 2802            12      JR  Z,CT0CX
000CA2 DA19 FE6A             7      CP  'j'
       DA1B                     CT0CX:
000CA4 DA1B CABBDB          10      JP  Z,CTRL0C
000CA7 DA1E FE48             7      CP  'H'
000CA9 DA20 CA43DB          10      JP  Z,CTRL0B
000CAC DA23 FE4A             7      CP  'J'
000CAE DA25 CABEDB          10      JP  Z,CTRL06
000CB1 DA28 FE4B             7      CP  'K'
000CB3 DA2A CA15DB          10      JP  Z,CTRL05
000CB6 DA2D FE4C             7      CP  'L'
000CB8 DA2F CAE8DB          10      JP  Z,CTRL0E
000CBB DA32 FE54             7      CP  'T'
000CBD DA34 CA15DB          10      JP  Z,CTRL05
000CC0 DA37 FE78             7      CP  'x'
000CC2 DA39 2804            12      JR  Z,ESC1X
000CC4 DA3B FE79             7      CP  'y'
000CC6 DA3D 2002            12      JR  NZ,ESC1Y
       DA3F                     ESC1X:
000CC8 DA3F 3601            10      LD  (HL),1
       DA41                     ESC1Y:
000CCA DA41 FE3D             7      CP  '='
000CCC DA43 2804            12      JR  Z,ESC1W
000CCE DA45 FE59             7      CP  'Y'
000CD0 DA47 2002            12      JR  NZ,ESC1Z
       DA49                     ESC1W:
000CD2 DA49 3602            10      LD  (HL),2
       DA4B                     ESC1Z:
000CD4 DA4B FE20             7      CP  020H
000CD6 DA4D 3802            12      JR  C,ESC1C
000CD8 DA4F 87               4      ADD A,A
000CD9 DA50 D0              11      RET NC
       DA51                     ESC1C:
000CDA DA51 E1              10      POP HL
000CDB DA52 1832            12      JR  ANK
                                
       DA54                     ESC:
000CDD DA54 219EDA          10      LD  HL,PRINTE5
000CE0 DA57 E5              11      PUSH    HL
000CE1 DA58 217ADA          10      LD  HL,ESCFLG
000CE4 DA5B 3600            10      LD  (HL),0
000CE6 DA5D 3D               4      DEC A
000CE7 DA5E 28A0            12      JR  Z,ESC1
000CE9 DA60 3D               4      DEC A
000CEA DA61 2009            12      JR  NZ,ESC2
000CEC DA63 3603            10      LD  (HL),3
000CEE DA65 7B               4      LD  A,E
000CEF DA66 D620             7      SUB 020H
000CF1 DA68 326FDA          13      LD  (ESCYP+1),A
000CF4 DA6B C9              10      RET
       DA6C                     ESC2:
000CF5 DA6C 3D               4      DEC A
000CF6 DA6D C0              11      RET NZ
000CF7 DA6E 2600             7  ESCYP:  LD  H,0
000CF9 DA70 7B               4      LD  A,E
000CFA DA71 D620             7      SUB 020H
000CFC DA73 6F               4      LD  L,A
000CFD DA74 C3D6EF          10      JP  _LOC
                                
       DA77                     PRINT:
000D00 DA77 C5              11      PUSH    BC
000D01 DA78 E5              11      PUSH    HL
       DA7A                     ESCFLG  EQU $+1
000D02 DA79 3E00             7      LD  A,000H      ;自己書き換え
000D04 DA7B B7               4      OR  A
000D05 DA7C 20D6            12      JR  NZ,ESC
                                
000D07 DA7E 3E1F             7      LD  A,01FH
000D09 DA80 BB               4      CP  E
000D0A DA81 301F            12      JR  NC,CTRL
       DA83                     INSFLG  EQU $
000D0C DA83 01A4DB          10      LD  BC,INSERT   ;自己書き換え
       DA86                     ANK:
000D0F DA86 2A8EEF          16      LD  HL,(_TXADR)
000D12 DA89 7C               4      LD  A,H
000D13 DA8A C6D0             7      ADD A,0D0H
000D15 DA8C 67               4      LD  H,A
000D16 DA8D 4A               4      LD  C,D
000D17 DA8E 16ED             7      LD  D,CD_TABLE/256
000D19 DA90 3A96EF          13      LD  A,(_COLORF)
000D1C DA93 3239CF          13      LD  (IPCSMC),A
000D1F DA96 1A               7      LD  A,(DE)
000D20 DA97 51               4      LD  D,C
000D21 DA98 CD33CF          17      CALL    IO_PRINT
000D24 DA9B CDB2DA          17      CALL    CTRL1C
       DA9E                     PRINTE5:
000D27 DA9E E1              10      POP HL
000D28 DA9F C1              10      POP BC
000D29 DAA0 AF               4      XOR A
000D2A DAA1 C9              10      RET
                                
       DAA2                     CTRL:
000D2B DAA2 7B               4      LD  A,E
000D2C DAA3 87               4      ADD A,A
000D2D DAA4 F680             7      OR  080H
000D2F DAA6 6F               4      LD  L,A
000D30 DAA7 26F0             7      LD  H,CTRLTB/256
000D32 DAA9 7E               7      LD  A,(HL)
000D33 DAAA 2C               4      INC L
000D34 DAAB 66               7      LD  H,(HL)
000D35 DAAC 6F               4      LD  L,A
000D36 DAAD CD0F00          17      CALL    JP_HL
000D39 DAB0 18EC            12      JR  PRINTE5
                                
       DAB2                     CTRL1C:
000D3B DAB2 ED4B8EEF        20      LD  BC,(_TXADR)
000D3F DAB6 03               6      INC BC
       DAB7                     PRINTE3:
000D40 DAB7 2118FC          10      LD  HL,0-WIDTH*LINE
000D43 DABA A7               4      AND A
000D44 DABB ED4A            15      ADC HL,BC
       DABD                     PRINTE8:
000D46 DABD 2805            12      JR  Z,PRINT2
000D48 DABF ED438EEF        20      LD  (_TXADR),BC
       DAC3                     CTRL00:
000D4C DAC3 C9              10      RET
                                
       DAC4                     PRINT2:
000D4D DAC4 CDEEDB          17      CALL    SCR
000D50 DAC7 21D8FF          10      LD  HL,0-WIDTH
000D53 DACA 09              11      ADD HL,BC
       DACB                     SET_TXADR_HL:
000D54 DACB 228EEF          16      LD  (_TXADR),HL
000D57 DACE C9              10      RET
                                
       DACF                     CTRL08:
000D58 DACF 3A83DA          13      LD  A,(INSFLG)
000D5B DAD2 FECD             7      CP  0CDH        ;CALL ????
000D5D DAD4 2823            12      JR  Z,CTRL02
       DAD6                     CTRL1D:
000D5F DAD6 2A8EEF          16      LD  HL,(_TXADR)
000D62 DAD9 7C               4      LD  A,H
000D63 DADA B5               4      OR  L
000D64 DADB C8              11      RET Z
000D65 DADC 2B               6      DEC HL
000D66 DADD 18EC            12      JR  SET_TXADR_HL
                                
       DADF                     CTRL1E:
000D68 DADF ED4B8EEF        20      LD  BC,(_TXADR)
000D6C DAE3 21D8FF          10      LD  HL,0-WIDTH
000D6F DAE6 09              11      ADD HL,BC
000D70 DAE7 D0              11      RET NC
000D71 DAE8 18E1            12      JR  SET_TXADR_HL
                                
       DAEA                     CTRL09:
000D73 DAEA ED4B8EEF        20      LD  BC,(_TXADR)
000D77 DAEE 79               4      LD  A,C
000D78 DAEF E6F8             7      AND 0F8H
000D7A DAF1 C608             7      ADD A,8
000D7C DAF3 4F               4      LD  C,A
000D7D DAF4 88               4      ADC A,B
000D7E DAF5 91               4      SUB C
000D7F DAF6 47               4      LD  B,A
000D80 DAF7 18BE            12      JR  PRINTE3
                                
       DAF9                     CTRL02:
000D82 DAF9 CDD6DA          17      CALL    CTRL1D
000D85 DAFC C8              11      RET Z
000D86 DAFD D5              11      PUSH    DE
000D87 DAFE CDD3EF          17      CALL    _POS
000D8A DB01 3E28             7      LD  A,WIDTH
000D8C DB03 95               4      SUB L
000D8D DB04 4F               4      LD  C,A
000D8E DB05 0D               4      DEC C
000D8F DB06 06D0             7      LD  B,0D0H
000D91 DB08 2A8EEF          16      LD  HL,(_TXADR)
000D94 DB0B 09              11      ADD HL,BC
000D95 DB0C 47               4      LD  B,A
000D96 DB0D 1E00             7      LD  E,0     ;E:Text
000D98 DB0F 3A96EF          13      LD  A,(_COLORF) ;A:Color
000D9B DB12 C380CF          10      JP  IO_BS
                                
       DB15                     CTRL05:
000D9E DB15 CDD3EF          17      CALL    _POS
000DA1 DB18 3E28             7      LD  A,WIDTH
000DA3 DB1A 95               4      SUB L
000DA4 DB1B 47               4      LD  B,A
       DB1C                     C08X1:
000DA5 DB1C 2A8EEF          16      LD  HL,(_TXADR)
000DA8 DB1F 7C               4      LD  A,H
000DA9 DB20 C6D0             7      ADD A,0D0H
000DAB DB22 67               4      LD  H,A
       DB23                     CLLINE:
000DAC DB23 0E00             7      LD  C,0
000DAE DB25 3A96EF          13      LD  A,(_COLORF)
000DB1 DB28 C366CF          10      JP  IO_CLLINE
                                
       DB2B                     CTRL0D:
000DB4 DB2B CDD3EF          17      CALL    _POS
000DB7 DB2E 2E00             7      LD  L,0
       DB30                     LOC:
000DB9 DB30 C5              11      PUSH    BC
000DBA DB31 E5              11      PUSH    HL
000DBB DB32 CD50DB          17      CALL    LOC1
000DBE DB35 228EEF          16      LD  (_TXADR),HL
000DC1 DB38 E1              10      POP HL
000DC2 DB39 C1              10      POP BC
000DC3 DB3A C9              10      RET
                                
       DB3B                     CTRL12:
000DC4 DB3B 2183DA          10      LD  HL,INSFLG
000DC7 DB3E 7E               7      LD  A,(HL)
000DC8 DB3F EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
000DCA DB41 77               7      LD  (HL),A
000DCB DB42 C9              10      RET
                                
       DB43                     CTRL0B:
000DCC DB43 210000          10      LD  HL,0
000DCF DB46 228EEF          16      LD  (_TXADR),HL
000DD2 DB49 C9              10      RET
                                
       DB4A                     CTRL1B:
000DD3 DB4A 3E01             7      LD  A,1
000DD5 DB4C 327ADA          13      LD  (ESCFLG),A
000DD8 DB4F C9              10      RET
                                
       DB50                     LOC1:
000DD9 DB50 D5              11      PUSH    DE
000DDA DB51 4D               4      LD  C,L
000DDB DB52 0608             7      LD  B,8
000DDD DB54 5C               4      LD  E,H
000DDE DB55 210028          10      LD  HL,WIDTH*256
000DE1 DB58 55               4      LD  D,L ;L=0
       DB59                     LOC2:
000DE2 DB59 29              11      ADD HL,HL
000DE3 DB5A 3001            12      JR  NC,LOC3
000DE5 DB5C 19              11      ADD HL,DE
       DB5D                     LOC3:
000DE6 DB5D 10FA            13      DJNZ    LOC2
000DE8 DB5F 09              11      ADD HL,BC
000DE9 DB60 D1              10      POP DE
000DEA DB61 C9              10      RET
                                
       DB62                     CONOUT1:
                                ;   CALL    CURSOR
000DEB DB62 59               4      LD  E,C
000DEC DB63 CDCDEF          17      CALL    _PRINT
000DEF DB66 7B               4      LD  A,E
000DF0 DB67 FE0A             7      CP  00AH
000DF2 DB69 2006            12      JR  NZ,CURSOR
000DF4 DB6B CD2BDB          17      CALL    CTRL0D
000DF7 DB6E CD15DB          17      CALL    CTRL05
       DB71                     CURSOR:
000DFA DB71 C9              10      RET
                                
       DB72                     CTRL07:
000DFB DB72 3E01             7      LD  A,1
000DFD DB74 2108E0          10      LD  HL,0E008H
000E00 DB77 CD27CF          17      CALL    WRMMIO
000E03 DB7A 2D               4      DEC L
000E04 DB7B 3E36             7      LD  A,036H
000E06 DB7D CD27CF          17      CALL    WRMMIO
000E09 DB80 2E04             7      LD  L,004H
000E0B DB82 3EF9             7      LD  A,0F9H
000E0D DB84 CD27CF          17      CALL    WRMMIO
000E10 DB87 3E03             7      LD  A,003H
000E12 DB89 CD27CF          17      CALL    WRMMIO
000E15 DB8C 0610             7      LD  B,16
       DB8E                     C07X1:
000E17 DB8E CD19CF          17      CALL    RD556VSYNC
000E1A DB91 87               4      ADD A,A
000E1B DB92 30FA            12      JR  NC,C07X1
       DB94                     C07X2:
000E1D DB94 CD19CF          17      CALL    RD556VSYNC
000E20 DB97 87               4      ADD A,A
000E21 DB98 38FA            12      JR  C,C07X2
000E23 DB9A 10F2            13      DJNZ    C07X1
                                
000E25 DB9C AF               4      XOR A
000E26 DB9D 2108E0          10      LD  HL,0E008H
000E29 DBA0 CD27CF          17      CALL    WRMMIO
000E2C DBA3 C9              10      RET
                                
       DBA4                     INSERT:
000E2D DBA4 D5              11      PUSH    DE
000E2E DBA5 CDD3EF          17      CALL    _POS
000E31 DBA8 3E28             7      LD  A,WIDTH
000E33 DBAA 95               4      SUB L
000E34 DBAB 47               4      LD  B,A
000E35 DBAC 2A8EEF          16      LD  HL,(_TXADR)
000E38 DBAF 7C               4      LD  A,H
000E39 DBB0 C6D0             7      ADD A,0D0H
000E3B DBB2 67               4      LD  H,A
000E3C DBB3 1E00             7      LD  E,0     ;E:Text
000E3E DBB5 3A96EF          13      LD  A,(_COLORF) ;L:Color
000E41 DBB8 C374CF          10      JP  IO_INS
                                
       DBBB                     CTRL0C:
000E44 DBBB CD43DB          17      CALL    CTRL0B
       DBBE                     CTRL06:
000E47 DBBE D5              11      PUSH    DE
000E48 DBBF E5              11      PUSH    HL
000E49 DBC0 ED5B8EEF        20      LD  DE,(_TXADR)
000E4D DBC4 3A96EF          13      LD  A,(_COLORF)
000E50 DBC7 3254CF          13      LD  (ICSMC),A
000E53 DBCA C349CF          10      JP  IO_CLR
                                
       DBCD                     CTRL04:
000E56 DBCD CDD3EF          17      CALL    _POS
000E59 DBD0 7D               4      LD  A,L
000E5A DBD1 B7               4      OR  A
000E5B DBD2 C8              11      RET Z
       DBD3                     CTRL03:
000E5C DBD3 CD2BDB          17      CALL    CTRL0D
       DBD6                     CTRL0A:
       DBD6                     CTRL1F:
000E5F DBD6 2A8EEF          16      LD  HL,(_TXADR)
000E62 DBD9 012800          10      LD  BC,WIDTH
000E65 DBDC 09              11      ADD HL,BC
000E66 DBDD 44               4      LD  B,H
000E67 DBDE 4D               4      LD  C,L
000E68 DBDF 2118FC          10      LD  HL,0-WIDTH*LINE
000E6B DBE2 09              11      ADD HL,BC
000E6C DBE3 3F               4      CCF
000E6D DBE4 9F               4      SBC A,A
000E6E DBE5 C3BDDA          10      JP  PRINTE8
                                
       DBE8                     CTRL0E:
000E71 DBE8 CDD3EF          17      CALL    _POS
000E74 DBEB 7C               4      LD  A,H
000E75 DBEC 1804            12      JR  SCR1
       DBEE                     SCR:
000E77 DBEE 3A97EF          13      LD  A,(_LINE)
000E7A DBF1 3D               4      DEC A
       DBF2                     SCR1:
000E7B DBF2 C5              11      PUSH    BC
000E7C DBF3 D5              11      PUSH    DE
000E7D DBF4 E5              11      PUSH    HL
000E7E DBF5 1100D0          10      LD  DE,0D000H
000E81 DBF8 2128D0          10      LD  HL,0D000H+WIDTH
                                
000E84 DBFB 47               4      LD  B,A
000E85 DBFC B7               4      OR  A
000E86 DBFD C397CF          10      JP  IO_SCRUP
                                
       DC00                     POS:
000E89 DC00 2A8EEF          16      LD  HL,(_TXADR)
000E8C DC03 C5              11      PUSH    BC
000E8D DC04 01D8FF          10      LD  BC,0-WIDTH
000E90 DC07 AF               4      XOR A
       DC08                     POS1:
000E91 DC08 09              11      ADD HL,BC
000E92 DC09 3C               4      INC A
000E93 DC0A 38FC            12      JR  C,POS1
000E95 DC0C ED42            15      SBC HL,BC
000E97 DC0E 3D               4      DEC A
000E98 DC0F 67               4      LD  H,A
000E99 DC10 C1              10      POP BC
000E9A DC11 A7               4      AND A
000E9B DC12 C9              10      RET
                                
       DC13                     GETL:
000E9C DC13 CDD3EF          17      CALL    _POS
000E9F DC16 E5              11      PUSH    HL
000EA0 DC17 3ECD             7      LD  A,0CDH      ;CALL ????
000EA2 DC19 3283DA          13      LD  (INSFLG),A
       DC1C                     GETL1:
000EA5 DC1C CD62D9          17      CALL    _SYS08
000EA8 DC1F FE09             7      CP  9
000EAA DC21 2008            12      JR  NZ,GETL1V
000EAC DC23 2100FF          10      LD  HL,KBUF
000EAF DC26 CD75D6          17      CALL    MSX
000EB2 DC29 18F1            12      JR  GETL1
       DC2B                     GETL1V:
000EB4 DC2B 5F               4      LD  E,A
000EB5 DC2C CDCDEF          17      CALL    _PRINT
                                
000EB8 DC2F 7B               4      LD  A,E
000EB9 DC30 FE0D             7      CP  00DH
000EBB DC32 20E8            12      JR  NZ,GETL1
000EBD DC34 3E01             7      LD  A,1     ;LD BC,????
000EBF DC36 3283DA          13      LD  (INSFLG),A
000EC2 DC39 1100FF          10      LD  DE,KBUF
000EC5 DC3C 0628             7      LD  B,WIDTH
000EC7 DC3E CDBDD3          17      CALL    ZERO_MEMORY_DE
                                
000ECA DC41 D1              10      POP DE
000ECB DC42 CDD3EF          17      CALL    _POS
000ECE DC45 6B               4      LD  L,E
000ECF DC46 3E28             7      LD  A,WIDTH
000ED1 DC48 95               4      SUB L
000ED2 DC49 57               4      LD  D,A
000ED3 DC4A CD50DB          17      CALL    LOC1
000ED6 DC4D 4D               4      LD  C,L
000ED7 DC4E 7C               4      LD  A,H
000ED8 DC4F C6D0             7      ADD A,0D0H
000EDA DC51 47               4      LD  B,A
000EDB DC52 5A               4      LD  E,D
000EDC DC53 2100FF          10      LD  HL,KBUF
       DC56                     GETL2:
000EDF DC56 CDD0EF          17      CALL    _SCRN
000EE2 DC59 03               6      INC BC
000EE3 DC5A 77               7      LD  (HL),A
000EE4 DC5B 23               6      INC HL
000EE5 DC5C 1D               4      DEC E
000EE6 DC5D 20F7            12      JR  NZ,GETL2
       DC5F                     GETL3:
000EE8 DC5F 2B               6      DEC HL
000EE9 DC60 7E               7      LD  A,(HL)
000EEA DC61 FE21             7      CP  021H
000EEC DC63 D0              11      RET NC
000EED DC64 3600            10      LD  (HL),0
000EEF DC66 15               4      DEC D
000EF0 DC67 20F6            12      JR  NZ,GETL3
000EF2 DC69 C9              10      RET
                                
       DC6A                     INKEYB:
000EF3 DC6A C1              10      POP BC
000EF4 DC6B CB47             8      BIT 0,A
000EF6 DC6D 3E08             7      LD  A,8
000EF8 DC6F 2016            12      JR  NZ,INKEYD
000EFA DC71 3E03             7      LD  A,3
000EFC DC73 1812            12      JR  INKEYD
       DC75                     INKEY:
000EFE DC75 E5              11      PUSH    HL
000EFF DC76 2A90EF          16      LD  HL,(_KEYPS)
000F02 DC79 7C               4      LD  A,H
000F03 DC7A AD               4      XOR L
000F04 DC7B 280F            12      JR  Z,GETKEY
000F06 DC7D 7C               4      LD  A,H
000F07 DC7E 3C               4      INC A
000F08 DC7F 3291EF          13      LD  (_KEYPS+1),A
000F0B DC82 6F               4      LD  L,A
000F0C DC83 26FE             7      LD  H,KEYBF/256
000F0E DC85 7E               7      LD  A,(HL)
000F0F DC86 E1              10      POP HL
       DC87                     INKEYD:
000F10 DC87 B7               4      OR  A
000F11 DC88 3292EF          13      LD  (_KEYD),A
000F14 DC8B C9              10      RET
       DC8C                     GETKEY:
000F15 DC8C 3A92EF          13      LD  A,(_KEYD)
000F18 DC8F B7               4      OR  A
000F19 DC90 6F               4      LD  L,A
000F1A DC91 2610             7  GKSMC:  LD  H,16
       DC93                     GETKEY1:
000F1C DC93 CDC1DC          17      CALL    CHKEY       ;キーを離すまで待つ
000F1F DC96 281E            12      JR  Z,GETKEY2
000F21 DC98 BD               4      CP  L
000F22 DC99 201B            12      JR  NZ,GETKEY2
000F24 DC9B CD19CF          17      CALL    RD556VSYNC
000F27 DC9E 87               4      ADD A,A
000F28 DC9F 30F2            12      JR  NC,GETKEY1
       DCA1                     GETKEY1X:
000F2A DCA1 CDC1DC          17      CALL    CHKEY       ;キーを離すまで待つ
000F2D DCA4 2810            12      JR  Z,GETKEY2
000F2F DCA6 BD               4      CP  L
000F30 DCA7 200D            12      JR  NZ,GETKEY2
000F32 DCA9 CD19CF          17      CALL    RD556VSYNC
000F35 DCAC 87               4      ADD A,A
000F36 DCAD 38F2            12      JR  C,GETKEY1X
000F38 DCAF 25               4      DEC H
000F39 DCB0 20E1            12      JR  NZ,GETKEY1
000F3B DCB2 3E01             7      LD  A,1
000F3D DCB4 1802            12      JR  GETKEY3
       DCB6                     GETKEY2:
000F3F DCB6 3E10             7      LD  A,16
       DCB8                     GETKEY3:
000F41 DCB8 3292DC          13      LD  (GKSMC+1),A
000F44 DCBB 3A92EF          13      LD  A,(_KEYD)
000F47 DCBE B7               4      OR  A
000F48 DCBF E1              10      POP HL
000F49 DCC0 C0              11      RET NZ
       DCC1                     CHKEY:
000F4A DCC1 C5              11      PUSH    BC
000F4B DCC2 3E08             7      LD  A,8
000F4D DCC4 CD0ECF          17      CALL    RDKEYDATA
000F50 DCC7 3293EF          13      LD  (_KEYD+1),A
000F53 DCCA CB7F             8      BIT 7,A
000F55 DCCC 289C            12      JR  Z,INKEYB
000F57 DCCE E5              11      PUSH    HL
000F58 DCCF 0E07             7      LD  C,7
000F5A DCD1 210CDD          10      LD  HL,KEY_TABLE
000F5D DCD4 CB47             8      BIT 0,A
000F5F DCD6 2003            12      JR  NZ,INKEY0
000F61 DCD8 214DDD          10      LD  HL,SHIFT_TABLE
       DCDB                     INKEY0:
000F64 DCDB CB77             8      BIT 6,A
000F66 DCDD 2003            12      JR  NZ,INKEY1
000F68 DCDF 218EDD          10      LD  HL,CTRL_TABLE
       DCE2                     INKEY1:
000F6B DCE2 79               4      LD  A,C
000F6C DCE3 CD0ECF          17      CALL    RDKEYDATA
000F6F DCE6 0608             7      LD  B,8
       DCE8                     INKEY2:
000F71 DCE8 87               4      ADD A,A
000F72 DCE9 3008            12      JR  NC,INKEY3
000F74 DCEB 23               6      INC HL
000F75 DCEC 10FA            13      DJNZ    INKEY2
000F77 DCEE 0D               4      DEC C
000F78 DCEF 79               4      LD  A,C
000F79 DCF0 3C               4      INC A
000F7A DCF1 20EF            12      JR  NZ,INKEY1
       DCF3                     INKEY3:
000F7C DCF3 7E               7      LD  A,(HL)
000F7D DCF4 E1              10      POP HL
000F7E DCF5 C1              10      POP BC
000F7F DCF6 188F            12      JR  INKEYD
                                
       DCF8                     SCRN:
000F81 DCF8 E5              11      PUSH    HL
000F82 DCF9 CD2DCF          17      CALL    RDMMIO_BC
000F85 DCFC 6F               4      LD  L,A
000F86 DCFD 26EE             7      LD  H,DC_TABLE/256
000F88 DCFF 7E               7      LD  A,(HL)
000F89 DD00 FE41             7      CP  'A'
000F8B DD02 3806            12      JR  C,SCRN1
000F8D DD04 FE5B             7      CP  'Z'+1
000F8F DD06 3002            12      JR  NC,SCRN1
000F91 DD08 C620             7      ADD A,'a'-'A'
       DD0A                     SCRN1:
000F93 DD0A E1              10      POP HL
000F94 DD0B C9              10      RET
                                
       DD0C                     KEY_TABLE:
000F95 DD0C 12081E1F1C1D5C2F        DB  12H,08H,1EH,1FH,1CH,1DH,5CH,'/'
000F9D DD14 5C5E2D2030392C2E        DB  5CH,'^','-',20H,'0','9',',','.'
000FA5 DD1C 3132333435363738        DB  '1','2','3','4','5','6','7','8'
000FAD DD24 6162636465666768        DB  'a','b','c','d','e','f','g','h'
000FB5 DD2C 696A6B6C6D6E6F70        DB  'i','j','k','l','m','n','o','p'
000FBD DD34 7172737475767778        DB  'q','r','s','t','u','v','w','x'
000FC5 DD3C 797A405B5D000000        DB  'y','z','@','[',']',00H,00H,00H
000FCD DD44 001B3D09003B3A0D        DB  00H,1BH,'=',09H,00H,';',':',0DH
000FD5 DD4C 00                      DB  00H
       DD4D                     SHIFT_TABLE:
000FD6 DD4D 12081E1F1C1D5F3F        DB  12H,08H,1EH,1FH,1CH,1DH,'_','?'
000FDE DD55 7C7E3D2030293C3E        DB  '|','~','=',20H,'0',')','<','>'
000FE6 DD5D 2122232425262728        DB  '!','"','#','$','%','&',27H,'('
000FEE DD65 4142434445464748        DB  'A','B','C','D','E','F','G','H'
000FF6 DD6D 494A4B4C4D4E4F50        DB  'I','J','K','L','M','N','O','P'
000FFE DD75 5152535455565758        DB  'Q','R','S','T','U','V','W','X'
001006 DD7D 595A607B7D000000        DB  'Y','Z','`','{','}',00H,00H,00H
00100E DD85 00003D09002B2A0D        DB  00H,00H,'=',09H,00H,'+','*',0DH
001016 DD8D 00                      DB  00H
       DD8E                     CTRL_TABLE:
001017 DD8E 12081E1F1C1D3F2F        DB  12H,08H,1EH,1FH,1CH,1DH,'?','/'
00101F DD96 2A2B2D2030392C2E        DB  '*','+','-',20H,'0','9',',','.'
001027 DD9E 3132333435363738        DB  '1','2','3','4','5','6','7','8'
00102F DDA6 0102030405060708        DB  01H,02H,03H,04H,05H,06H,07H,08H
001037 DDAE 090A0B0C0D0E0F10        DB  09H,0AH,0BH,0CH,0DH,0EH,0FH,10H
00103F DDB6 1112131415161718        DB  11H,12H,13H,14H,15H,16H,17H,18H
001047 DDBE 191A1B5B5D000000        DB  19H,1AH,1BH,'[',']',00H,00H,00H
00104F DDC6 00003D09003B3A0D        DB  00H,00H,'=',09H,00H,';',':',0DH
001057 DDCE 00                      DB  00H
                                
                                
[EOF:M7IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
       DDCF                     FILEC:
001058 DDCF CDDADD          17      CALL    FILE
       DDD2                     FILEC2:
00105B DDD2 3A15EF          13      LD  A,(FDRV+1)
00105E DDD5 FE20             7      CP  020H
001060 DDD7 C8              11      RET Z
001061 DDD8 1839            12      JR  SETDIR1
                                
       DDDA                     FILE:
001063 DDDA AF               4      XOR A
001064 DDDB 3214EF          13      LD  (FDRV),A
001067 DDDE 67               4      LD  H,A
001068 DDDF 6F               4      LD  L,A
001069 DDE0 2222EF          16      LD  (FDRV+14),HL
00106C DDE3 CDB1DE          17      CALL    SPCUT
00106F DDE6 CD96DE          17      CALL    CCHK3
001072 DDE9 2812            12      JR  Z,DEVI1
001074 DDEB 13               6      INC DE
001075 DDEC 1A               7      LD  A,(DE)
001076 DDED 1B               6      DEC DE
001077 DDEE FE3A             7      CP  ':'
001079 DDF0 200B            12      JR  NZ,DEVI1
00107B DDF2 1A               7      LD  A,(DE)      ;DRIVE
00107C DDF3 CDE6E0          17      CALL    CAP
00107F DDF6 D640             7      SUB '@'
001081 DDF8 13               6      INC DE
001082 DDF9 13               6      INC DE
001083 DDFA 3214EF          13      LD  (FDRV),A
       DDFD                     DEVI1:
001086 DDFD 1A               7      LD  A,(DE)
001087 DDFE D65C             7      SUB 05CH        ;\
001089 DE00 2009            12      JR  NZ,NOROOT
00108B DE02 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
00108C DE03 222EEF          16      LD  (FDRV+26),HL
00108F DE06 2C               4      INC L
001090 DE07 2222EF          16      LD  (FDRV+14),HL
001093 DE0A 13               6      INC DE
       DE0B                     NOROOT:
                                
       DE0B                     SETDIR:
001094 DE0B CD37DE          17      CALL    FILED
001097 DE0E 1A               7      LD  A,(DE)
001098 DE0F FE5C             7      CP  05CH        ;\
00109A DE11 C0              11      RET NZ
00109B DE12 13               6      INC DE
       DE13                     SETDIR1:
00109C DE13 3E10             7      LD  A,010H      ;Directory
00109E DE15 3221EF          13      LD  (FDRV+13),A
0010A1 DE18 D5              11      PUSH    DE
0010A2 DE19 1114EF          10      LD  DE,FDRV
0010A5 DE1C 2A1EF0          16      LD  HL,(STABLE+2*00FH)
0010A8 DE1F CD0F00          17      CALL    JP_HL
0010AB DE22 D1              10      POP DE
0010AC DE23 B7               4      OR  A
0010AD DE24 C0              11      RET NZ
                                
0010AE DE25 3A21EF          13      LD  A,(FDRV+13)
0010B1 DE28 CB67             8      BIT 4,A
0010B3 DE2A C8              11      RET Z
                                
0010B4 DE2B CD7EDE          17      CALL    FILEI
0010B7 DE2E 2A2EEF          16      LD  HL,(FDRV+26)
0010BA DE31 23               6      INC HL
0010BB DE32 2222EF          16      LD  (FDRV+14),HL
0010BE DE35 18D4            12      JR  SETDIR
                                
       DE37                     FILED:
0010C0 DE37 CD7EDE          17      CALL    FILEI
0010C3 DE3A 2115EF          10      LD  HL,FNAME
                                
0010C6 DE3D 0608             7      LD  B,8
       DE3F                     FILE2:
0010C8 DE3F CD8BDE          17      CALL    CCHKF
0010CB DE42 C8              11      RET Z
0010CC DE43 FE2A             7      CP  '*'
0010CE DE45 282E            12      JR  Z,FILE9
0010D0 DE47 FE2E             7      CP  '.'
0010D2 DE49 280C            12      JR  Z,FILE4
0010D4 DE4B 77               7      LD  (HL),A
0010D5 DE4C 23               6      INC HL
0010D6 DE4D 10F0            13      DJNZ    FILE2
                                
       DE4F                     FILE3:
0010D8 DE4F CD8BDE          17      CALL    CCHKF
0010DB DE52 C8              11      RET Z
0010DC DE53 FE2E             7      CP  '.'
0010DE DE55 20F8            12      JR  NZ,FILE3
                                
       DE57                     FILE4:
0010E0 DE57 211DEF          10      LD  HL,FNAME+8
0010E3 DE5A 0603             7      LD  B,3
                                
       DE5C                     FILE4L:
0010E5 DE5C CD8BDE          17      CALL    CCHKF
0010E8 DE5F C8              11      RET Z
0010E9 DE60 FE2E             7      CP  '.'
0010EB DE62 2008            12      JR  NZ,FILE12
0010ED DE64 3215EF          13      LD  (FNAME),A   ;Parent directory(..)
0010F0 DE67 3216EF          13      LD  (FNAME+1),A
0010F3 DE6A 3E20             7      LD  A,020H
       DE6C                     FILE12:
0010F5 DE6C FE2A             7      CP  '*'
0010F7 DE6E 280A            12      JR  Z,FILE10
0010F9 DE70 77               7      LD  (HL),A
0010FA DE71 23               6      INC HL
0010FB DE72 10E8            13      DJNZ    FILE4L
0010FD DE74 C9              10      RET
                                
       DE75                     FILE9:              ;名前の*処理、名前の残りを?で埋める
0010FE DE75 CD7ADE          17      CALL    FILE10
001101 DE78 18D5            12      JR  FILE3
                                
       DE7A                     FILE10:
001103 DE7A 3E3F             7      LD  A,'?'
001105 DE7C 1808            12      JR  FILL_MEMORY
       DE7E                     FILEI:              ;名前＋拡張子をスペースで初期化
001107 DE7E 3E20             7      LD  A,020H
001109 DE80 01000B          10      LD  BC,11*256   ;C=0にしておく
00110C DE83 2115EF          10      LD  HL,FNAME
       DE86                     FILL_MEMORY:            ;HLからBバイトAで埋める
00110F DE86 77               7      LD  (HL),A
001110 DE87 23               6      INC HL
001111 DE88 10FC            13      DJNZ    FILL_MEMORY
001113 DE8A C9              10      RET
                                
       DE8B                     CCHKF:
001114 DE8B 1A               7      LD  A,(DE)
001115 DE8C CD93DE          17      CALL    CCHK2
001118 DE8F C8              11      RET Z
001119 DE90 C3FEE1          10      JP  FKAN
                                
       DE93                     CCHK2:
00111C DE93 0C               4      INC C
00111D DE94 0D               4      DEC C
00111E DE95 C0              11      RET NZ
       DE96                     CCHK3:              ;ZF=1 で使えない文字
00111F DE96 FE2B             7      CP  '+'
001121 DE98 C8              11      RET Z
001122 DE99 FE2C             7      CP  ','
001124 DE9B C8              11      RET Z
001125 DE9C FE2F             7      CP  '/'
001127 DE9E C8              11      RET Z
001128 DE9F FE3A             7      CP  ':'
00112A DEA1 C8              11      RET Z
00112B DEA2 FE3B             7      CP  ';'
00112D DEA4 C8              11      RET Z
00112E DEA5 FE3D             7      CP  '='
001130 DEA7 C8              11      RET Z
001131 DEA8 FE5C             7      CP  05CH    ;\
001133 DEAA C8              11      RET Z
001134 DEAB FE20             7      CP  020H
001136 DEAD D0              11      RET NC
001137 DEAE BF               4      CP  A       ;Z=1
001138 DEAF C9              10      RET
                                
       DEB0                     SS1:
001139 DEB0 13               6      INC DE
       DEB1                     SPCUT:              ;スペースをカット
00113A DEB1 1A               7      LD  A,(DE)
00113B DEB2 FE20             7      CP  020H
00113D DEB4 28FA            12      JR  Z,SS1
00113F DEB6 C9              10      RET
                                
       DEB7                     SETDRVF:
001140 DEB7 1114EF          10      LD  DE,FDRV
       DEBA                     SETDRV0:
001143 DEBA CDC3DE          17      CALL    SETDRV
001146 DEBD FDE1            14      POP IY
001148 DEBF C1              10      POP BC
001149 DEC0 D1              10      POP DE
00114A DEC1 E1              10      POP HL
00114B DEC2 C9              10      RET
                                
       DEC3                     SETDRV:
00114C DEC3 E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
00114D DEC4 D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
00114E DEC5 C5              11      PUSH    BC
00114F DEC6 1A               7      LD  A,(DE)
001150 DEC7 D5              11      PUSH    DE
001151 DEC8 FDE3            23      EX  (SP),IY
                                
001153 DECA CDD6DE          17      CALL    GETDRV
001156 DECD 3C               4      INC A
001157 DECE FD7700          19      LD  (IY+0),A    ;(FCB)ドライブ番号
00115A DED1 3D               4      DEC A
00115B DED2 CDD9EF          17      CALL    _CHGDRV
                                
00115E DED5 E9               4      JP  (HL)
                                
       DED6                     GETDRV:
00115F DED6 E67F             7      AND 07FH
001161 DED8 D601             7      SUB 001H
001163 DEDA 3003            12      JR  NC,GETDRV1
001165 DEDC 3A87EF          13      LD  A,(_DVSW)   ;Current Drive
       DEDF                     GETDRV1:
001168 DEDF 3288EF          13      LD  (_DRV),A
00116B DEE2 C9              10      RET
                                
       DEE3                     SOPENX:
00116C DEE3 1139EF          10      LD  DE,SFILE
00116F DEE6 1A               7      LD  A,(DE)
001170 DEE7 FDBE00           7      CP  (IY+0)      ;(FCB)ドライブ番号
001173 DEEA 2024            12      JR  NZ,SOPEN
001175 DEEC 13               6      INC DE
001176 DEED FDE5            15      PUSH    IY
001178 DEEF E1              10      POP HL
001179 DEF0 23               6      INC HL
00117A DEF1 CD7EE0          17      CALL    CPFILE
00117D DEF4 201A            12      JR  NZ,SOPEN
                                
00117F DEF6 2AF4F0          16      LD  HL,(SCDIR)
001182 DEF9 FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
001185 DEFC FD740F          19      LD  (IY+15),H
                                
001188 DEFF 2AF8F0          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
00118B DF02 229FEF          16      LD  (_FILEN),HL
                                
00118E DF05 ED5BF6F0        20      LD  DE,(SFBPS)
001192 DF09 2139EF          10      LD  HL,SFILE
001195 DF0C 36FF            10      LD  (HL),0FFH
001197 DF0E 23               6      INC HL
001198 DF0F C9              10      RET
       DF10                     SOPEN:
001199 DF10 2126E0          10      LD  HL,FILESE
       DF13                     SOPENC:
00119C DF13 224CDF          16      LD  (OPENPAT+1),HL
                                
00119F DF16 CDE2EF          17      CALL    _RDFATX     ;Detect Media
0011A2 DF19 3856            12      JR  C,RDDERR
                                
0011A4 DF1B AF               4      XOR A
0011A5 DF1C 329FEF          13      LD  (_FILEN),A
0011A8 DF1F CD2BE1          17      CALL    LDDIRX1     ;A=0で呼び出す
0011AB DF22 2818            12      JR  Z,SDIRX1
                                
0011AD DF24 CD17E0          17      CALL    READ_DIR    ;Sub Directory
0011B0 DF27 3808            12      JR  C,SDIRX0
0011B2 DF29 2A7EF0          16      LD  HL,(_DTBUF)
0011B5 DF2C 7E               7      LD  A,(HL)
0011B6 DF2D FE2E             7      CP  '.'
0011B8 DF2F 280F            12      JR  Z,SOPEN1
       DF31                     SDIRX0:
0011BA DF31 AF               4      XOR A
0011BB DF32 32A0EF          13      LD  (_DIRF),A
0011BE DF35 FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
0011C2 DF39 FD770F          19      LD  (IY+15),A
       DF3C                     SDIRX1:
0011C5 DF3C ED5BFCF0        20      LD  DE,(_DIRPS) ;Root Directory
       DF40                     SOPEN1:
0011C9 DF40 0E20             7  SDECPAT:LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       DF42                     SOPEN1X:
0011CB DF42 CD17E0          17      CALL    READ_DIR    ;FILE SEARCH
0011CE DF45 382A            12      JR  C,RDDERR
0011D0 DF47 2A7EF0          16      LD  HL,(_DTBUF)
       DF4A                     SOPEN2:
0011D3 DF4A D5              11      PUSH    DE
0011D4 DF4B CD26E0          17  OPENPAT:CALL    FILESE      ;(self-modifying code)
0011D7 DF4E D1              10      POP DE
0011D8 DF4F 386E            12      JR  C,SOPENE
0011DA DF51 281B            12      JR  Z,SCF_FF_RET
       DF53                     SOPEN3:
0011DC DF53 3AA0EF          13      LD  A,(_DIRF)   ;ディレクトリか判別
0011DF DF56 B7               4      OR  A
0011E0 DF57 200C            12      JR  NZ,SOPEN5
0011E2 DF59 13               6      INC DE      ;ルートディレクトリ
0011E3 DF5A E5              11      PUSH    HL
0011E4 DF5B 210C00          10  MD_PAT: LD  HL,12       ;(self-modifying code)MAXDIR
0011E7 DF5E ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
0011E9 DF60 E1              10      POP HL
0011EA DF61 20DD            12      JR  NZ,SOPEN1
0011EC DF63 1807            12      JR  SOPEN6
       DF65                     SOPEN5:
0011EE DF65 CD76E7          17      CALL    GNCLX       ;END DIR
0011F1 DF68 D8              11      RET C
0011F2 DF69 CDDEE0          17      CALL    ENDCL
       DF6C                     SOPEN6:
0011F5 DF6C 38D2            12      JR  C,SOPEN1
       DF6E                     SCF_FF_RET:
0011F7 DF6E 37               4      SCF         ;CF=1
0011F8 DF6F 9F               4      SBC A,A     ;A=0FFH
0011F9 DF70 C9              10      RET
                                
       DF71                     RDDERR:
0011FA DF71 BF               4      CP  A       ;READ ERR CF=1 ZF=1
0011FB DF72 37               4      SCF
0011FC DF73 C9              10      RET
                                
       DF74                     NOPEN:
0011FD DF74 2126E0          10      LD  HL,FILESE
001200 DF77 224CDF          16      LD  (OPENPAT+1),HL
001203 DF7A FD2A98EF        20      LD  IY,(_FCB)
001207 DF7E CD11E2          17      CALL    CHKWILDX
00120A DF81 30EB            12      JR  NC,SCF_FF_RET
00120C DF83 FD7E00          19      LD  A,(IY+0)    ;(FCB)ドライブ番号
00120F DF86 3D               4      DEC A
001210 DF87 3288EF          13      LD  (_DRV),A
001213 DF8A CDD9EF          17      CALL    _CHGDRV
001216 DF8D D8              11      RET C
001217 DF8E 2AF8F0          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
00121A DF91 229FEF          16      LD  (_FILEN),HL
                                
00121D DF94 CD26E1          17      CALL    LDDIRX
001220 DF97 ED5B9AEF        20      LD  DE,(_FBPS)
001224 DF9B CD17E0          17      CALL    READ_DIR
001227 DF9E 38D1            12      JR  C,RDDERR
001229 DFA0 3A9EEF          13      LD  A,(_FBCNT)
00122C DFA3 3D               4      DEC A
00122D DFA4 28AD            12      JR  Z,SOPEN3
       DFA6                     NOPEN2:
00122F DFA6 2A9CEF          16      LD  HL,(_FBAD)
001232 DFA9 012000          10      LD  BC,020H
001235 DFAC 09              11      ADD HL,BC
001236 DFAD 4F               4      LD  C,A
001237 DFAE 189A            12      JR  SOPEN2
                                
       DFB0                     SOPENE2:
001239 DFB0 229CEF          16      LD  (_FBAD),HL
00123C DFB3 79               4      LD  A,C
00123D DFB4 329EEF          13      LD  (_FBCNT),A
001240 DFB7 ED539AEF        20      LD  (_FBPS),DE
001244 DFBB FD2298EF        20      LD  (_FCB),IY
       DFBF                     SOPENE:
001248 DFBF AF               4      XOR A
001249 DFC0 C9              10      RET
                                
       DFC1                     COPEN:
00124A DFC1 FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
00124E DFC5 2143E0          10      LD  HL,NEXTSE
001251 DFC8 CD13DF          17      CALL    SOPENC
001254 DFCB D0              11      RET NC
001255 DFCC C8              11      RET Z
001256 DFCD 3AA0EF          13      LD  A,(_DIRF)   ;ディレクトリか判別
001259 DFD0 B7               4      OR  A
00125A DFD1 37               4      SCF
00125B DFD2 C8              11      RET Z       ;ルートディレクトリ
00125C DFD3 0601             7      LD  B,1
00125E DFD5 CD6DE2          17      CALL    WRDF
001261 DFD8 D8              11      RET C
001262 DFD9 ED5BFEF0        20      LD  DE,(_CLPS)
001266 DFDD D5              11      PUSH    DE
001267 DFDE CDA7E0          17      CALL    DCPAT
00126A DFE1 CD01E6          17      CALL    DRDNX
00126D DFE4 2A7EF0          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
001270 DFE7 3A7CE5          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
001273 DFEA 47               4      LD  B,A
001274 DFEB AF               4      XOR A
001275 DFEC 4F               4      LD  C,A
       DFED                     COPENCL:
001276 DFED 77               7      LD  (HL),A
001277 DFEE EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001279 DFF0 EAEDDF          10      JP  PE,COPENCL
                                
00127C DFF3 3AC5E0          13      LD  A,(SPCPAT+1)    ;1クラスタの論理セクタ数
00127F DFF6 3D               4      DEC A
001280 DFF7 2819            12      JR  Z,COPENE
001282 DFF9 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
001284 DFFB 326EE7          13      LD  (_SECPS+1),A
001287 DFFE D1              10      POP DE      ;DE=(_CLPS)
001288 DFFF D5              11      PUSH    DE
       E000                     COPEN1:
001289 E000 D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
00128A E001 C5              11      PUSH    BC
00128B E002 2A7EF0          16      LD  HL,(_DTBUF)
00128E E005 CDC1E0          17      CALL    CLUSTX
001291 E008 CDDAE8          17      CALL    DWT24
001294 E00B C1              10      POP BC
001295 E00C D1              10      POP DE
001296 E00D CD6DE7          17      CALL    NEXTX
001299 E010 20EE            12      JR  NZ,COPEN1
       E012                     COPENE:
00129B E012 2A7EF0          16      LD  HL,(_DTBUF)
00129E E015 D1              10      POP DE
00129F E016 C9              10      RET
                                
       E017                     READ_DIR:
0012A0 E017 ED53FEF0        20      LD  (_CLPS),DE
0012A4 E01B C5              11      PUSH    BC
0012A5 E01C D5              11      PUSH    DE
0012A6 E01D CDA7E0          17      CALL    DCPAT
0012A9 E020 CDE1E5          17      CALL    DRDX
0012AC E023 D1              10      POP DE
0012AD E024 C1              10      POP BC
0012AE E025 C9              10      RET
                                
       E026                     FILESE:
0012AF E026 7E               7      LD  A,(HL)
0012B0 E027 B7               4      OR  A
0012B1 E028 C8              11      RET Z       ;END:ZF=1 CF=0
0012B2 E029 FEE5             7      CP  0E5H
0012B4 E02B 280E            12      JR  Z,FILESE1
0012B6 E02D FDE5            15      PUSH    IY
0012B8 E02F D1              10      POP DE
0012B9 E030 13               6      INC DE
0012BA E031 E5              11      PUSH    HL
0012BB E032 CD7EE0          17      CALL    CPFILE
0012BE E035 CC9FE0          17      CALL    Z,CPFILE2
0012C1 E038 E1              10      POP HL
0012C2 E039 37               4      SCF
0012C3 E03A C8              11      RET Z       ;!!!:(ZF=1) CF=1
       E03B                     FILESE1:
0012C4 E03B CD52E0          17      CALL    FNEXT
0012C7 E03E 20E6            12      JR  NZ,FILESE
       E040                     ZF0_CF0_AFF_RET:
0012C9 E040 F6FF             7      OR  0FFH        ;ZF=0 CF=0
0012CB E042 C9              10      RET
                                
       E043                     NEXTSE:
0012CC E043 7E               7      LD  A,(HL)
0012CD E044 B7               4      OR  A
0012CE E045 37               4      SCF
0012CF E046 C8              11      RET Z       ;!!!:ZF=1 CF=1
0012D0 E047 FEE5             7      CP  0E5H
0012D2 E049 37               4      SCF
0012D3 E04A C8              11      RET Z       ;!!!:(ZF=1) CF=1
0012D4 E04B CD52E0          17      CALL    FNEXT
0012D7 E04E 20F3            12      JR  NZ,NEXTSE
0012D9 E050 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       E052                     FNEXT:
0012DB E052 E5              11      PUSH    HL
0012DC E053 219FEF          10      LD  HL,_FILEN
0012DF E056 34              11      INC (HL)
0012E0 E057 E1              10      POP HL
0012E1 E058 112000          10      LD  DE,020H
0012E4 E05B 19              11      ADD HL,DE
0012E5 E05C 0D               4      DEC C
0012E6 E05D C9              10      RET
                                
       E05E                     CPNAME:
0012E7 E05E C5              11      PUSH    BC
0012E8 E05F D5              11      PUSH    DE
0012E9 E060 E5              11      PUSH    HL
0012EA E061 CD78E0          17      CALL    CPFILE4
0012ED E064 E1              10      POP HL
0012EE E065 23               6      INC HL
0012EF E066 23               6      INC HL
0012F0 E067 23               6      INC HL
0012F1 E068 23               6      INC HL
0012F2 E069 D1              10      POP DE
0012F3 E06A C1              10      POP BC
0012F4 E06B 2005            12      JR  NZ,CPNAME1
0012F6 E06D 7E               7      LD  A,(HL)
0012F7 E06E 23               6      INC HL
0012F8 E06F 66               7      LD  H,(HL)
0012F9 E070 6F               4      LD  L,A
0012FA E071 C9              10      RET
       E072                     CPNAME1:
0012FB E072 23               6      INC HL
0012FC E073 23               6      INC HL
0012FD E074 10E8            13      DJNZ    CPNAME
0012FF E076 37               4      SCF
001300 E077 C9              10      RET
                                
       E078                     CPFILE4:
001301 E078 C5              11      PUSH    BC
001302 E079 010004          10      LD  BC,00400H
001305 E07C 1804            12      JR  CPSTR1
       E07E                     CPFILE:
001307 E07E C5              11      PUSH    BC
001308 E07F 01000B          10      LD  BC,00B00H
       E082                     CPSTR1:
00130B E082 1A               7      LD  A,(DE)
00130C E083 FE3F             7      CP  '?'     ;Wild card
00130E E085 2812            12      JR  Z,CPSTR2
001310 E087 7E               7      LD  A,(HL)
001311 E088 CDF7E1          17      CALL    FKANC
001314 E08B E5              11      PUSH    HL
001315 E08C 67               4      LD  H,A
001316 E08D 1A               7      LD  A,(DE)
001317 E08E CB01             4      RLC C
001319 E090 CDF7E1          17      CALL    FKANC
00131C E093 CB09             4      RRC C
00131E E095 BC               4      CP  H       ;CP (HL),(DE)
00131F E096 E1              10      POP HL
001320 E097 2004            12      JR  NZ,CPSTR3
       E099                     CPSTR2:
001322 E099 13               6      INC DE
001323 E09A 23               6      INC HL
001324 E09B 10E5            13      DJNZ    CPSTR1
       E09D                     CPSTR3:
001326 E09D C1              10      POP BC
001327 E09E C9              10      RET
                                
       E09F                     CPFILE2:
001328 E09F FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
00132B E0A2 F6E1             7      OR  0E1H
00132D E0A4 2F               4      CPL
00132E E0A5 A6               7      AND (HL)
00132F E0A6 C9              10      RET
                                
       E0A7                     DCPAT:
001330 E0A7 0E00             7      LD  C,0
001332 E0A9 2A7EF0          16      LD  HL,(_DTBUF)
001335 E0AC 3AA0EF          13      LD  A,(_DIRF)   ;ディレクトリか判別
001338 E0AF B7               4      OR  A
001339 E0B0 C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
00133A E0B1 3AC5E0          13      LD  A,(SPCPAT+1)
00133D E0B4 4F               4      LD  C,A
00133E E0B5 3A6EE7          13      LD  A,(_SECPS+1)
001341 E0B8 B9               4      CP  C
001342 E0B9 3801            12      JR  C,DC1
001344 E0BB AF               4      XOR A
       E0BC                     DC1:
001345 E0BC F680             7      OR  080H
001347 E0BE 32A0EF          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       E0C1                     CLUSTX:
00134A E0C1 E5              11      PUSH    HL
00134B E0C2 EB               4      EX  DE,HL
00134C E0C3 AF               4      XOR A
00134D E0C4 0E01             7  SPCPAT: LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       E0C6                     L_CLDBL:
00134F E0C6 CB19             8      RR  C       ;->CF
001351 E0C8 3804            12      JR  C,E_CLDBL
001353 E0CA 29              11      ADD HL,HL       ;*2
001354 E0CB 8F               4      ADC A,A
001355 E0CC 18F8            12      JR  L_CLDBL
       E0CE                     E_CLDBL:
001357 E0CE 4F               4      LD  C,A
001358 E0CF 3A6EE7          13      LD  A,(_SECPS+1)
00135B E0D2 B5               4      OR  L
00135C E0D3 6F               4      LD  L,A
00135D E0D4 110800          10  CLSPAT: LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
001360 E0D7 AF               4      XOR A
001361 E0D8 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
001362 E0D9 89               4      ADC A,C
001363 E0DA 4F               4      LD  C,A
001364 E0DB EB               4      EX  DE,HL
001365 E0DC E1              10      POP HL
001366 E0DD C9              10      RET
                                
       E0DE                     ENDCL:
001367 E0DE 7A               4      LD  A,D ;END CLUSTER
001368 E0DF FE01             7  CLPAT1: CP  1   ;164=356    (self-modifying code)
00136A E0E1 C0              11      RET NZ
00136B E0E2 7B               4      LD  A,E
00136C E0E3 FE64             7  CLPAT2: CP  064H    ;       (self-modifying code)
00136E E0E5 C9              10      RET
                                
       E0E6                     CAP:
00136F E0E6 FE61             7      CP  'a'
001371 E0E8 D8              11      RET C
001372 E0E9 FE7B             7      CP  'z'+1
001374 E0EB D0              11      RET NC
001375 E0EC D620             7      SUB 020H
001377 E0EE C9              10      RET
       E0EF                     CAP2:
001378 E0EF CDE6E0          17      CALL    CAP
       E0F2                     CAP3:
00137B E0F2 CDFBE0          17      CALL    CAP4
00137E E0F5 FE21             7      CP  021H
001380 E0F7 D0              11      RET NC
001381 E0F8 3EA0             7      LD  A,0A0H
001383 E0FA C9              10      RET
       E0FB                     CAP4:
001384 E0FB FE05             7      CP  5
001386 E0FD C0              11      RET NZ
001387 E0FE 3EE5             7      LD  A,0E5H
001389 E100 C9              10      RET
                                
       E101                     CHDIR:
00138A E101 CD11EA          17      CALL    GETDPBD
00138D E104 381D            12      JR  C,CHDIR2
00138F E106 DD751A          19      LD  (IX+01AH),L     ;_SDIR_
001392 E109 DD741B          19      LD  (IX+01BH),H     ;_SDIR_+1
001395 E10C 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       E10E                     LDDIR:
001397 E10E CD11EA          17      CALL    GETDPBD
00139A E111 DD5E1A          19      LD  E,(IX+01AH)     ;_SDIR_
00139D E114 DD561B          19      LD  D,(IX+01BH)     ;_SDIR_+1
0013A0 E117 13               6      INC DE
0013A1 E118 FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0013A4 E11B FD720F          19      LD  (IY+15),D
0013A7 E11E 1B               6      DEC DE
0013A8 E11F AF               4      XOR A
0013A9 E120 32A0EF          13      LD  (_DIRF),A
       E123                     CHDIR2:
0013AC E123 DDE1            14      POP IX
0013AE E125 C9              10      RET
                                
       E126                     LDDIRX:
0013AF E126 3AA0EF          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
0013B2 E129 E67F             7      AND 07FH
       E12B                     LDDIRX1:
0013B4 E12B 326EE7          13      LD  (_SECPS+1),A
0013B7 E12E FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0013BA E131 FD560F          19      LD  D,(IY+15)
0013BD E134 1B               6      DEC DE
0013BE E135 CDDEE0          17      CALL    ENDCL
0013C1 E138 D40EE1          17      CALL    NC,LDDIR
       E13B                     LDDIRS:
0013C4 E13B 7A               4      LD  A,D
0013C5 E13C B3               4      OR  E
0013C6 E13D 32A0EF          13      LD  (_DIRF),A   ;ディレクトリか判別
0013C9 E140 C9              10      RET
                                
       E141                     KILL:
0013CA E141 CD11E2          17      CALL    CHKWILDX
0013CD E144 3834            12      JR  C,KILLW
0013CF E146 CDE3DE          17      CALL    SOPENX
       E149                     KILLS:
0013D2 E149 3E1F             7      LD  A,01FH
0013D4 E14B D48DE1          17      CALL    NC,CHKATT
0013D7 E14E D8              11      RET C
       E14F                     KILLSX:
0013D8 E14F 36E5            10      LD  (HL),0E5H   ;DIR
0013DA E151 CDEBE1          17      CALL    WTDB
0013DD E154 111A00          10      LD  DE,01AH
0013E0 E157 19              11      ADD HL,DE
0013E1 E158 5E               7      LD  E,(HL)
0013E2 E159 23               6      INC HL
0013E3 E15A 56               7      LD  D,(HL)
       E15B                     KILLS1:
0013E4 E15B CDDEE0          17      CALL    ENDCL
0013E7 E15E D0              11      RET NC      ;CF=0
0013E8 E15F 21FEFF          10      LD  HL,0-2
0013EB E162 19              11      ADD HL,DE
0013EC E163 D0              11      RET NC      ;DE= 0 or 1
0013ED E164 D5              11      PUSH    DE
0013EE E165 CDF7EF          17      CALL    _GNCL
0013F1 E168 ED53FEF0        20      LD  (_CLPS),DE
0013F5 E16C D1              10      POP DE
0013F6 E16D 210000          10      LD  HL,0
0013F9 E170 D4FAEF          17      CALL    NC,_SNCL
0013FC E173 D8              11      RET C
0013FD E174 ED5BFEF0        20      LD  DE,(_CLPS)  ;FAT
001401 E178 18E1            12      JR  KILLS1
                                
       E17A                     KILLW:
001403 E17A CD10DF          17      CALL    SOPEN
       E17D                     KILLW1:
001406 E17D 380B            12      JR  C,KILLW2
001408 E17F CDB0DF          17      CALL    SOPENE2
00140B E182 CD49E1          17      CALL    KILLS
00140E E185 CD74DF          17      CALL    NOPEN
001411 E188 18F3            12      JR  KILLW1
       E18A                     KILLW2:
001413 E18A C8              11      RET Z
001414 E18B 3F               4      CCF
001415 E18C C9              10      RET
                                
       E18D                     CHKATT:
001416 E18D E5              11      PUSH    HL
001417 E18E 110B00          10      LD  DE,00BH
00141A E191 19              11      ADD HL,DE
00141B E192 A6               7      AND (HL)
00141C E193 E1              10      POP HL
00141D E194 C8              11      RET Z
00141E E195 37               4      SCF
00141F E196 C9              10      RET
                                
       E197                     NAME:
001420 E197 CD11E2          17      CALL    CHKWILDX
001423 E19A D8              11      RET C
001424 E19B 110400          10      LD  DE,4
001427 E19E 19              11      ADD HL,DE
001428 E19F 22B7E1          16      LD  (NAMEP+2),HL
00142B E1A2 23               6      INC HL
00142C E1A3 CD15E2          17      CALL    CHKWILD
00142F E1A6 D8              11      RET C
                                
001430 E1A7 CDE3DE          17      CALL    SOPENX
001433 E1AA 3E0F             7      LD  A,00FH
001435 E1AC D48DE1          17      CALL    NC,CHKATT
001438 E1AF D8              11      RET C
                                
001439 E1B0 FD7E00          19      LD  A,(IY+0)
00143C E1B3 FDE5            15      PUSH    IY
00143E E1B5 FD210000        14  NAMEP:  LD  IY,0        ;自己書き換え
001442 E1B9 FD7700          19      LD  (IY+0),A
001445 E1BC CDE3DE          17      CALL    SOPENX
001448 E1BF FDE3            23      EX  (SP),IY
00144A E1C1 3F               4      CCF
00144B E1C2 D410DF          17      CALL    NC,SOPEN
00144E E1C5 EB               4      EX  DE,HL
00144F E1C6 E1              10      POP HL
001450 E1C7 D8              11      RET C
                                
       E1C8                     SETNAME:
001451 E1C8 01000B          10      LD  BC,11*256
001454 E1CB 23               6      INC HL
001455 E1CC 7E               7      LD  A,(HL)
001456 E1CD FEE5             7      CP  0E5H
001458 E1CF 2004            12      JR  NZ,SNAME1
00145A E1D1 3E05             7      LD  A,5
00145C E1D3 180E            12      JR  SNAME3
       E1D5                     SNAME1:
00145E E1D5 7E               7      LD  A,(HL)
00145F E1D6 0C               4      INC C
001460 E1D7 0D               4      DEC C
001461 E1D8 2009            12      JR  NZ,SNAME3
001463 E1DA CDE6E0          17      CALL    CAP
001466 E1DD FEA0             7      CP  0A0H
001468 E1DF 2002            12      JR  NZ,SNAME3
00146A E1E1 3E20             7      LD  A,020H
       E1E3                     SNAME3:
00146C E1E3 12               7      LD  (DE),A
00146D E1E4 7E               7      LD  A,(HL)
00146E E1E5 23               6      INC HL
00146F E1E6 CDFEE1          17      CALL    FKAN
001472 E1E9 10EA            13      DJNZ    SNAME1
       E1EB                     WTDB:
001474 E1EB 3EFF             7      LD  A,0FFH
001476 E1ED 3239EF          13      LD  (SFILE),A
       E1F0                     SWTDBF:
001479 E1F0 3E01             7      LD  A,1
00147B E1F2 32A4EF          13      LD  (_WTDBF),A
00147E E1F5 AF               4      XOR A
00147F E1F6 C9              10      RET
                                
       E1F7                     FKANC:
001480 E1F7 CB41             8      BIT 0,C
001482 E1F9 CCEFE0          17      CALL    Z,CAP2
001485 E1FC 1801            12      JR  FKANX
       E1FE                     FKAN:           ;漢字チェック
001487 E1FE 13               6      INC DE
       E1FF                     FKANX:
001488 E1FF CB41             8      BIT 0,C
00148A E201 CB81             8      RES 0,C
00148C E203 C0              11      RET NZ
00148D E204 FE80             7      CP  080H
00148F E206 D8              11      RET C
001490 E207 FEA0             7      CP  0A0H
001492 E209 3803            12      JR  C,FKAN1
001494 E20B FEE0             7      CP  0E0H
001496 E20D D8              11      RET C
       E20E                     FKAN1:
001497 E20E 0C               4      INC C
001498 E20F A7               4      AND A
001499 E210 C9              10      RET
                                
       E211                     CHKWILDX:
00149A E211 FDE5            15      PUSH    IY
00149C E213 E1              10      POP HL
00149D E214 23               6      INC HL
       E215                     CHKWILD:
00149E E215 060B             7      LD  B,11
0014A0 E217 3E3F             7      LD  A,'?'
       E219                     CHKWIL1:
0014A2 E219 BE               7      CP  (HL)
0014A3 E21A 23               6      INC HL
0014A4 E21B 37               4      SCF
0014A5 E21C C8              11      RET Z
0014A6 E21D 10FA            13      DJNZ    CHKWIL1
0014A8 E21F AF               4      XOR A
0014A9 E220 C9              10      RET
                                
       E221                     SDIRENT:        ;IY=FCB HL=DIR
0014AA E221 D5              11      PUSH    DE
0014AB E222 E5              11      PUSH    HL
0014AC E223 FDE5            15      PUSH    IY
0014AE E225 D1              10      POP DE
0014AF E226 EB               4      EX  DE,HL
0014B0 E227 CDC8E1          17      CALL    SETNAME
                                ;               Attribute
0014B3 E22A FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0014B6 E22D 12               7      LD  (DE),A
0014B7 E22E 13               6      INC DE
                                ;               Reserved
0014B8 E22F AF               4      XOR A
0014B9 E230 060A             7      LD  B,10
       E232                     SDE1:
0014BB E232 12               7      LD  (DE),A
0014BC E233 13               6      INC DE
0014BD E234 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
0014BF E236 21EAF0          10      LD  HL,SDDATA       ;(FCB)更新年月日
0014C2 E239 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       E23B                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
0014C4 E23B 7E               7      LD  A,(HL)
0014C5 E23C 23               6      INC HL
0014C6 E23D 3242E2          13      LD  (SDPAT+2),A
0014C9 E240 FD7E00          19  SDPAT:  LD  A,(IY+0)    ;LD A,(IY+A)
0014CC E243 12               7      LD  (DE),A
0014CD E244 13               6      INC DE
0014CE E245 10F4            13      DJNZ    SDLOOP
                                
0014D0 E247 AF               4      XOR A
0014D1 E248 E1              10      POP HL
0014D2 E249 D1              10      POP DE
0014D3 E24A C9              10      RET
                                
       E24B                     WOPEN:
0014D4 E24B FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0014D7 E24E E61F             7      AND 01FH
0014D9 E250 37               4      SCF
0014DA E251 C0              11      RET NZ
0014DB E252 FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       E256                     TOPEN2:
0014DF E256 AF               4      XOR A
       E257                     TOPEN:              ;Initializes the time stamp
0014E0 E257 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
0014E4 E25B C9              10      RET
                                
       E25C                     WRDFX:
0014E5 E25C 3AC5E0          13      LD  A,(SPCPAT+1)    ;1クラスタの論理セクタ
       E25F                     L_WRFX:
0014E8 E25F 1F               4      RRA     ;->CF
0014E9 E260 3804            12      JR  C,E_WRFX
0014EB E262 CB39             8      SRL C   ;C=C/2
0014ED E264 18F9            12      JR  L_WRFX
       E266                     E_WRFX:
0014EF E266 41               4      LD  B,C
0014F0 E267 04               4      INC B
0014F1 E268 3E37             7      LD  A,037H      ;SCF
0014F3 E26A 32FEE5          13      LD  (DRDN1),A
                                
       E26D                     WRDF:               ;Bクラスタ分FATを確保する
0014F6 E26D 110200          10      LD  DE,2
0014F9 E270 AF               4      XOR A
0014FA E271 326EE7          13      LD  (_SECPS+1),A
       E274                     WRDF1:
0014FD E274 C5              11      PUSH    BC
0014FE E275 D5              11      PUSH    DE
0014FF E276 CDF7EF          17      CALL    _GNCL
001502 E279 381C            12      JR  C,WRDF3
001504 E27B 7A               4      LD  A,D     ;空いているかチェック
001505 E27C B3               4      OR  E
001506 E27D 2027            12      JR  NZ,WRDF4
001508 E27F E1              10      POP HL      ;HL=空いているクラスタ
001509 E280 E5              11      PUSH    HL
00150A E281 ED5BFEF0        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
00150E E285 22FEF0          16      LD  (_CLPS),HL
001511 E288 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
001512 E289 B3               4      OR  E
001513 E28A 2008            12      JR  NZ,WRDF2
001515 E28C FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
001518 E28F FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
00151B E292 1803            12      JR  WRDF3
       E294                     WRDF2:
00151D E294 CDFAEF          17      CALL    _SNCL
       E297                     WRDF3:
001520 E297 D1              10      POP DE
001521 E298 C1              10      POP BC
001522 E299 D8              11      RET C
001523 E29A 100C            13      DJNZ    WRDF5       ;ここでループカウンタチェック
001525 E29C ED5BFEF0        20      LD  DE,(_CLPS)
001529 E2A0 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
00152C E2A3 C3FAEF          10      JP  _SNCL
                                
       E2A6                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
00152F E2A6 D1              10      POP DE
001530 E2A7 C1              10      POP BC
       E2A8                     WRDF5:
001531 E2A8 13               6      INC DE
001532 E2A9 CDDEE0          17      CALL    ENDCL
001535 E2AC 38C6            12      JR  C,WRDF1
001537 E2AE 37               4      SCF
001538 E2AF C9              10      RET
                                
       E2B0                     RWXR:
001539 E2B0 3A7CE5          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       E2B3                     L_RWX:
00153C E2B3 1F               4      RRA     ;->CF
00153D E2B4 3806            12      JR  C,E_RWX
00153F E2B6 CB38             8      SRL B   ;BC=BC/2
001541 E2B8 CB19             8      RR  C   ;
001543 E2BA 18F7            12      JR  L_RWX
       E2BC                     E_RWX:
001545 E2BC FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001548 E2BF FD561B          19      LD  D,(IY+27)
00154B E2C2 AF               4      XOR A
00154C E2C3 326EE7          13      LD  (_SECPS+1),A
       E2C6                     RWX1:
00154F E2C6 ED53FEF0        20      LD  (_CLPS),DE
001553 E2CA 7A               4      LD  A,D
001554 E2CB B3               4      OR  E
001555 E2CC 280D            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
001557 E2CE 78               4      LD  A,B
001558 E2CF B1               4      OR  C
001559 E2D0 C8              11      RET Z       ;RET BC==0 => CF=0
                                
00155A E2D1 CD76E7          17      CALL    GNCLX
00155D E2D4 D8              11      RET C
00155E E2D5 0B               6      DEC BC
                                
00155F E2D6 CDDEE0          17      CALL    ENDCL
001562 E2D9 38EB            12      JR  C,RWX1
       E2DB                     SCF_RET:
001564 E2DB 37               4      SCF
001565 E2DC C9              10      RET
                                
       E2DD                     DSKF:
001566 E2DD 110000          10  MAXCLP: LD  DE,0
001569 E2E0 2AACEF          16      LD  HL,(_FAKEFREE)
00156C E2E3 7C               4      LD  A,H
00156D E2E4 B5               4      OR  L
00156E E2E5 2803            12      JR  Z,DSKF1
001570 E2E7 110100          10      LD  DE,1
       E2EA                     DSKF1:
001573 E2EA D5              11      PUSH    DE
001574 E2EB CDF7EF          17      CALL    _GNCL
001577 E2EE 380C            12      JR  C,POPSCF
001579 E2F0 7A               4      LD  A,D
00157A E2F1 B3               4      OR  E
00157B E2F2 2001            12      JR  NZ,DSKF2
00157D E2F4 23               6      INC HL
       E2F5                     DSKF2:
00157E E2F5 D1              10      POP DE
00157F E2F6 1B               6      DEC DE
001580 E2F7 7A               4      LD  A,D
001581 E2F8 B3               4      OR  E
001582 E2F9 20EF            12      JR  NZ,DSKF1
001584 E2FB C9              10      RET
                                
       E2FC                     POPSCF:
001585 E2FC F1              10      POP AF
001586 E2FD 37               4      SCF
001587 E2FE C9              10      RET
                                
       E2FF                     SETTMS:
001588 E2FF FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
00158B E302 3C               4      INC A
00158C E303 C0              11      RET NZ      ;ファイルが更新されていない
       E304                     SETTMSX:            ;FCBに日付時刻をセットする
00158D E304 CDF8D9          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
001590 E307 CB25             8      SLA L       ;   *2
001592 E309 CB25             8      SLA L       ;   *4
001594 E30B 29              11      ADD HL,HL       ;*2 *8
001595 E30C 29              11      ADD HL,HL       ;*4 *16
001596 E30D 29              11      ADD HL,HL       ;*8 *32
001597 E30E 7A               4      LD  A,D
001598 E30F 0F               4      RRCA            ;bit.0->7->->->0->C
001599 E310 E61F             7      AND 01FH
00159B E312 B5               4      OR  L
00159C E313 FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
00159F E316 FD7417          19      LD  (IY+23),H
                                
0015A2 E319 CDF0D9          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
0015A5 E31C 0144F8          10      LD  BC,0-1980
0015A8 E31F 09              11      ADD HL,BC
0015A9 E320 65               4      LD  H,L
                                
0015AA E321 7A               4      LD  A,D
0015AB E322 87               4      ADD A,A     ;*2
0015AC E323 87               4      ADD A,A     ;*4
0015AD E324 87               4      ADD A,A     ;*8
0015AE E325 87               4      ADD A,A     ;*16
0015AF E326 6F               4      LD  L,A
0015B0 E327 29              11      ADD HL,HL       ;*32
0015B1 E328 7D               4      LD  A,L
0015B2 E329 B3               4      OR  E
0015B3 E32A FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
0015B6 E32D FD7415          19      LD  (IY+21),H
0015B9 E330 C9              10      RET
                                
       E331                     PUSHRR:
0015BA E331 CD37E3          17      CALL    SUBRR
       E334                     POPRR1:
0015BD E334 EDB0                    LDIR
0015BF E336 C9              10      RET
                                
       E337                     SUBRR:
0015C0 E337 FDE5            15      PUSH    IY
0015C2 E339 E1              10      POP HL
0015C3 E33A 112100          10      LD  DE,33
0015C6 E33D 19              11      ADD HL,DE
0015C7 E33E 115AEF          10      LD  DE,HLBUF
0015CA E341 010300          10      LD  BC,3
0015CD E344 C9              10      RET
                                
       E345                     SETSEQ:
0015CE E345 F5              11      PUSH    AF      ;AHL=Random record
0015CF E346 FD7E21          19      LD  A,(IY+33)   ;(FCB)ランダムレコード
0015D2 E349 FD6E22          19      LD  L,(IY+34)
0015D5 E34C FD6623          19      LD  H,(IY+35)
                                
0015D8 E34F CD6BE3          17      CALL    SSQ1
                                
0015DB E352 29              11      ADD HL,HL
0015DC E353 CB3D             8      SRL L       ;L=L/2
0015DE E355 FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
0015E1 E358 FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
0015E4 E35B F1              10      POP AF
                                
       E35C                     POPRR:
0015E5 E35C CD37E3          17      CALL    SUBRR
0015E8 E35F EB               4      EX  DE,HL
0015E9 E360 18D2            12      JR  POPRR1
                                
       E362                     GETSIZE:
0015EB E362 FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
0015EE E365 FD6E11          19      LD  L,(IY+17)
0015F1 E368 FD6612          19      LD  H,(IY+18)
       E36B                     SSQ1:               ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
0015F4 E36B 87               4      ADD A,A     ;in HLA => out HL
0015F5 E36C ED6A            15      ADC HL,HL
0015F7 E36E B7               4      OR  A
0015F8 E36F C8              11      RET Z
0015F9 E370 23               6      INC HL
0015FA E371 C9              10      RET
                                
       E372                     GETSEQ:
0015FB E372 FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
0015FE E375 FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
                                
001601 E378 CB25             8      SLA L   ;L=L*2
                                
001603 E37A CB3C             8      SRL H   ;HL=HL/2
001605 E37C CB1D             8      RR  L   ;
001607 E37E C9              10      RET
                                
       E37F                     RB_WRITE:
001608 E37F C5              11      PUSH    BC
001609 E380 ED4B4CF0        20      LD  BC,(STABLE+2*026H)  ;(BDOS)ランダムブロック書き込み
00160D E384 1805            12      JR  RBRW
       E386                     RB_READ:
00160F E386 C5              11      PUSH    BC
001610 E387 ED4B4EF0        20      LD  BC,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       E38B                     RBRW:
001614 E38B AF               4      XOR A   ;HLA = HL*128
001615 E38C CB3C             8      SRL H   ;HL=HL/2
001617 E38E CB1D             8      RR  L   ;
001619 E390 1F               4      RRA         ;HLA
00161A E391 FD7721          19      LD  (IY+33),A   ;(FCB)ランダムレコード
00161D E394 FD7522          19      LD  (IY+34),L
001620 E397 FD7423          19      LD  (IY+35),H
001623 E39A 218000          10      LD  HL,128
                                
001626 E39D FDE5            15      PUSH    IY
001628 E39F D1              10      POP DE
001629 E3A0 D5              11      PUSH    DE
00162A E3A1 CDA8E3          17      CALL    JP_BC
00162D E3A4 FDE1            14      POP IY
00162F E3A6 C1              10      POP BC
001630 E3A7 C9              10      RET
       E3A8                     JP_BC:
001631 E3A8 C5              11      PUSH    BC
001632 E3A9 C9              10      RET
                                
       DF6E                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       DF6E                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       DF6E                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       DF6E                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       DF6E                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E3AA                     _SYS26:     ;(BDOS)ランダムブロック書き込み
001633 E3AA AF               4      XOR A
001634 E3AB 32FEE5          13      LD  (DRDN1),A   ;NOP
001637 E3AE 22BFE5          16      LD  (LEFT+1),HL ;HL←書き込むレコード数
00163A E3B1 225DEF          16      LD  (LEFTX),HL
00163D E3B4 CDC3DE          17      CALL    SETDRV
                                
001640 E3B7 CD27E5          17      CALL    RBX0
001643 E3BA DA50E4          10      JP  C,RBWERR
001646 E3BD CD4BE2          17      CALL    WOPEN
001649 E3C0 DA50E4          10      JP  C,RBWERR
00164C E3C3 7C               4      LD  A,H
00164D E3C4 B5               4      OR  L
00164E E3C5 CA49E4          10      JP  Z,RBW1
                                
001651 E3C8 2B               6      DEC HL
                                
001652 E3C9 CDD7E5          17      CALL    GET_RR_CDE  ;CDE=Random record
                                
001655 E3CC AF               4      XOR A   ;AHL=HL+CDE
001656 E3CD 19              11      ADD HL,DE
001657 E3CE 89               4      ADC A,C
                                
001658 E3CF 47               4      LD  B,A
001659 E3D0 4C               4      LD  C,H
                                
00165A E3D1 CDB0E2          17      CALL    RWXR
00165D E3D4 DC5CE2          17      CALL    C,WRDFX
001660 E3D7 DA50E4          10      JP  C,RBWERR
                                
001663 E3DA CD50E5          17      CALL    RBX2
001666 E3DD 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
001668 E3DF CD64E5          17      CALL    RBXA
00166B E3E2 386C            12      JR  C,RBWERR
00166D E3E4 EB               4      EX  DE,HL
00166E E3E5 C5              11      PUSH    BC
00166F E3E6 EDB0                    LDIR
001671 E3E8 225FEF          16      LD  (DTAX),HL
                                
001674 E3EB CDF0E1          17      CALL    SWTDBF      ;バッファデータは更新された
                                
001677 E3EE 2A5DEF          16      LD  HL,(LEFTX)
00167A E3F1 D1              10      POP DE
00167B E3F2 ED52            15      SBC HL,DE
00167D E3F4 225DEF          16      LD  (LEFTX),HL
001680 E3F7 2830            12      JR  Z,RBWEND
                                
       E3F9                     RBWB:
001682 E3F9 CD9AE5          17      CALL    RBXB
001685 E3FC 2813            12      JR  Z,RBWC
       E3FE                     RBWB1:
001687 E3FE C5              11      PUSH    BC
001688 E3FF D5              11      PUSH    DE
001689 E400 CDC1E0          17      CALL    CLUSTX
00168C E403 CDDAE8          17      CALL    DWT24
00168F E406 D1              10      POP DE
001690 E407 C1              10      POP BC
001691 E408 3846            12      JR  C,RBWERR
001693 E40A CD76E7          17      CALL    GNCLX
001696 E40D 3841            12      JR  C,RBWERR
001698 E40F 10ED            13      DJNZ    RBWB1
       E411                     RBWC:
00169A E411 CDB2E5          17      CALL    RBXC
00169D E414 2813            12      JR  Z,RBWEND
00169F E416 C5              11      PUSH    BC
0016A0 E417 CDC1E0          17      CALL    CLUSTX
0016A3 E41A CDFDE5          17      CALL    DRDN
0016A6 E41D C1              10      POP BC
0016A7 E41E 3830            12      JR  C,RBWERR
0016A9 E420 ED5B7EF0        20      LD  DE,(_DTBUF)
0016AD E424 EDB0                    LDIR
0016AF E426 CDF0E1          17      CALL    SWTDBF      ;バッファデータは更新された
       E429                     RBWEND:
0016B2 E429 CDBEE5          17      CALL    RBXEND
                                
0016B5 E42C CD36E5          17      CALL    RBX1
0016B8 E42F 3018            12      JR  NC,RBW1
0016BA E431 2ABFE5          16      LD  HL,(LEFT+1)
0016BD E434 FD5E10          19      LD  E,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
0016C0 E437 FD5611          19      LD  D,(IY+17)   ;CDE=File size
0016C3 E43A FD4E12          19      LD  C,(IY+18)
0016C6 E43D AF               4      XOR A
0016C7 E43E 19              11      ADD HL,DE
0016C8 E43F 89               4      ADC A,C
0016C9 E440 FD7510          19      LD  (IY+16),L   ;(FCB)ファイルのサイズ(バイト単位)
0016CC E443 FD7411          19      LD  (IY+17),H
0016CF E446 FD7712          19      LD  (IY+18),A
       E449                     RBW1:
0016D2 E449 FDE1            14      POP IY
0016D4 E44B C1              10      POP BC
0016D5 E44C D1              10      POP DE
0016D6 E44D E1              10      POP HL
       E44E                     DD_NUL:
0016D7 E44E AF               4      XOR A
0016D8 E44F C9              10      RET
                                
       E450                     RBWERR:
0016D9 E450 FDE5            15      PUSH    IY
0016DB E452 D1              10      POP DE
0016DC E453 2A20F0          16      LD  HL,(STABLE+2*010H)
0016DF E456 CD0F00          17      CALL    JP_HL
       E459                     RBRERR1:
0016E2 E459 3E01             7      LD  A,001H
       E45B                     RBRERR2:
0016E4 E45B FDE1            14      POP IY
0016E6 E45D C1              10      POP BC
0016E7 E45E D1              10      POP DE
0016E8 E45F E1              10      POP HL
0016E9 E460 37               4      SCF
0016EA E461 210000          10      LD  HL,0
0016ED E464 C9              10      RET
                                
       E465                     RBRERR:
0016EE E465 3EFF             7      LD  A,0FFH
0016F0 E467 18F2            12      JR  RBRERR2
                                
       E469                     RBRFL:
0016F2 E469 3E00             7  RBRFLP: LD  A,000H
0016F4 E46B FE0D             7      CP  00DH
0016F6 E46D 2005            12      JR  NZ,RBRFL1
0016F8 E46F D5              11      PUSH    DE
0016F9 E470 1E0A             7      LD  E,00AH
0016FB E472 1805            12      JR  RBRFL2
       E474                     RBRFL1:
0016FD E474 D5              11      PUSH    DE
0016FE E475 CD09EF          17      CALL    _SYS07
001701 E478 5F               4      LD  E,A
       E479                     RBRFL2:
001702 E479 CDCDEF          17      CALL    _PRINT
001705 E47C 7B               4      LD  A,E
001706 E47D D1              10      POP DE
001707 E47E 326AE4          13      LD  (RBRFLP+1),A
00170A E481 C9              10      RET
       E482                     DDX:
00170B E482 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
00170E E485 CDE6E0          17      CALL    CAP
001711 E488 FE41             7      CP  'A'
001713 E48A C9              10      RET
                                
                                                ;Read random block
       E48B                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001714 E48B 225DEF          16      LD  (LEFTX),HL
001717 E48E CDC3DE          17      CALL    SETDRV
                                
00171A E491 FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
00171E E495 C215E5          10      JP  NZ,RBRDIR   ;ディレクトリ
001721 E498 CD27E5          17      CALL    RBX0
001724 E49B DA65E4          10      JP  C,RBRERR
001727 E49E CD36E5          17      CALL    RBX1
00172A E4A1 DA59E4          10      JP  C,RBRERR1
00172D E4A4 79               4      LD  A,C
00172E E4A5 EB               4      EX  DE,HL
00172F E4A6 ED52            15      SBC HL,DE       ;CP 0HL,CDE
001731 E4A8 19              11      ADD HL,DE
001732 E4A9 DE00             7      SBC A,000H
001734 E4AB 3801            12      JR  C,RBR1
001736 E4AD EB               4      EX  DE,HL
       E4AE                     RBR1:
001737 E4AE 9F               4      SBC A,A
001738 E4AF E601             7      AND 1
00173A E4B1 3213E5          13      LD  (RBRAP+1),A
                                
00173D E4B4 7C               4      LD  A,H
00173E E4B5 B5               4      OR  L
00173F E4B6 2854            12      JR  Z,RBREND0
                                
001741 E4B8 22BFE5          16      LD  (LEFT+1),HL ;Read record byte
001744 E4BB 225DEF          16      LD  (LEFTX),HL
                                
001747 E4BE CD50E5          17      CALL    RBX2
00174A E4C1 2819            12      JR  Z,RBRB
00174C E4C3 CD64E5          17      CALL    RBXA
00174F E4C6 DA65E4          10      JP  C,RBRERR
001752 E4C9 C5              11      PUSH    BC
001753 E4CA EDB0                    LDIR
001755 E4CC ED535FEF        20      LD  (DTAX),DE
001759 E4D0 2A5DEF          16      LD  HL,(LEFTX)
00175C E4D3 D1              10      POP DE
00175D E4D4 A7               4      AND A
00175E E4D5 ED52            15      SBC HL,DE
001760 E4D7 225DEF          16      LD  (LEFTX),HL
001763 E4DA 282D            12      JR  Z,RBREND
                                
       E4DC                     RBRB:
001765 E4DC CD9AE5          17      CALL    RBXB
001768 E4DF 2812            12      JR  Z,RBRC
       E4E1                     RBRB1:
00176A E4E1 C5              11      PUSH    BC
00176B E4E2 D5              11      PUSH    DE
00176C E4E3 CDC1E0          17      CALL    CLUSTX
00176F E4E6 CDCAE8          17      CALL    DRD24
001772 E4E9 D1              10      POP DE
001773 E4EA C1              10      POP BC
001774 E4EB D476E7          17      CALL    NC,GNCLX
001777 E4EE DA65E4          10      JP  C,RBRERR
00177A E4F1 10EE            13      DJNZ    RBRB1
       E4F3                     RBRC:
00177C E4F3 CDB2E5          17      CALL    RBXC
00177F E4F6 2811            12      JR  Z,RBREND
001781 E4F8 C5              11      PUSH    BC
001782 E4F9 CDC1E0          17      CALL    CLUSTX
001785 E4FC CDE1E5          17      CALL    DRDX
001788 E4FF C1              10      POP BC
001789 E500 DA65E4          10      JP  C,RBRERR
00178C E503 EB               4      EX  DE,HL
00178D E504 2A7EF0          16      LD  HL,(_DTBUF)
001790 E507 EDB0                    LDIR
       E509                     RBREND:
001792 E509 CDBEE5          17      CALL    RBXEND
       E50C                     RBREND0:
001795 E50C FDE1            14      POP IY
001797 E50E C1              10      POP BC
001798 E50F D1              10      POP DE
001799 E510 F1              10      POP AF  ;(HL)
00179A E511 AF               4      XOR A
00179B E512 3E00             7  RBRAP:  LD  A,000H
00179D E514 C9              10      RET
                                
       E515                     RBRDIR:
00179E E515 FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0017A1 E518 FD661B          19      LD  H,(IY+27)
0017A4 E51B CD01E1          17      CALL    CHDIR
0017A7 E51E AF               4      XOR A
0017A8 E51F 67               4      LD  H,A
0017A9 E520 6F               4      LD  L,A
0017AA E521 3C               4      INC A
0017AB E522 3213E5          13      LD  (RBRAP+1),A
0017AE E525 18E5            12      JR  RBREND0
                                
       E527                     RBX0:
0017B0 E527 2A8AEF          16      LD  HL,(_DTA)
0017B3 E52A 225FEF          16      LD  (DTAX),HL
0017B6 E52D 2A5DEF          16      LD  HL,(LEFTX)
0017B9 E530 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0017BC E533 D6FD             7      SUB 0FDH
0017BE E535 C9              10      RET
                                
       E536                     RBX1:
0017BF E536 E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
0017C0 E537 FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
0017C3 E53A FD6611          19      LD  H,(IY+17)
0017C6 E53D FD7E12          19      LD  A,(IY+18)
                                
0017C9 E540 CDD7E5          17      CALL    GET_RR_CDE  ;CDE=Random record
                                
0017CC E543 A7               4      AND A
0017CD E544 ED52            15      SBC HL,DE
0017CF E546 99               4      SBC A,C
0017D0 E547 D1              10      POP DE
                                
0017D1 E548 D8              11      RET C
0017D2 E549 4F               4      LD  C,A
0017D3 E54A EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
0017D4 E54B B2               4      OR  D
0017D5 E54C B3               4      OR  E
0017D6 E54D C0              11      RET NZ
0017D7 E54E 37               4      SCF
0017D8 E54F C9              10      RET
                                
       E550                     RBX2:               ;Cluster settings
0017D9 E550 FD4E22          19      LD  C,(IY+34)   ;(+33)(FCB)ランダムレコード
0017DC E553 FD4623          19      LD  B,(IY+35)
0017DF E556 CDB0E2          17      CALL    RWXR
0017E2 E559 3A7CE5          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
0017E5 E55C 3D               4      DEC A
0017E6 E55D FDA622          19      AND (IY+34)
0017E9 E560 FDB621          19      OR  (IY+33)
0017EC E563 C9              10      RET
                                
       E564                     RBXA:
0017ED E564 C5              11      PUSH    BC
0017EE E565 D5              11      PUSH    DE
0017EF E566 CDC1E0          17      CALL    CLUSTX
0017F2 E569 CDE1E5          17      CALL    DRDX
0017F5 E56C D1              10      POP DE
0017F6 E56D C1              10      POP BC
0017F7 E56E D8              11      RET C
0017F8 E56F CD76E7          17      CALL    GNCLX
0017FB E572 D8              11      RET C
0017FC E573 ED53FEF0        20      LD  (_CLPS),DE
                                
001800 E577 FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
001803 E57A 210004          10  SECSZ:  LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
001806 E57D 7C               4      LD  A,H
001807 E57E 3D               4      DEC A       ;1024=3 / 512=1
001808 E57F FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
00180B E582 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
00180C E583 ED42            15      SBC HL,BC       ;残りを計算
                                
00180E E585 ED5B5DEF        20      LD  DE,(LEFTX)
001812 E589 ED52            15      SBC HL,DE       ;CP HL,DE
001814 E58B 19              11      ADD HL,DE       ;
001815 E58C 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
001817 E58E EB               4      EX  DE,HL
       E58F                     RBXA1:
001818 E58F E5              11      PUSH    HL
001819 E590 2A7EF0          16      LD  HL,(_DTBUF)
00181C E593 09              11      ADD HL,BC
00181D E594 ED5B5FEF        20      LD  DE,(DTAX)
001821 E598 C1              10      POP BC
001822 E599 C9              10      RET
                                
       E59A                     RBXB:
001823 E59A 2A5FEF          16      LD  HL,(DTAX)
001826 E59D ED5BFEF0        20      LD  DE,(_CLPS)
00182A E5A1 3A5EEF          13      LD  A,(LEFTX+1)
00182D E5A4 47               4      LD  B,A
00182E E5A5 3A7CE5          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       E5A8                     RBXB1:
001831 E5A8 1F               4      RRA     ;->CF
001832 E5A9 3804            12      JR  C,RBXB2
001834 E5AB CB38             8      SRL B   ;B=B/2
001836 E5AD 18F9            12      JR  RBXB1
       E5AF                     RBXB2:
001838 E5AF 78               4      LD  A,B
001839 E5B0 B7               4      OR  A
00183A E5B1 C9              10      RET
                                
       E5B2                     RBXC:
00183B E5B2 ED4B5DEF        20      LD  BC,(LEFTX)
00183F E5B6 3A7CE5          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
001842 E5B9 3D               4      DEC A
001843 E5BA A0               4      AND B
001844 E5BB 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
001845 E5BC B1               4      OR  C
001846 E5BD C9              10      RET
                                
       E5BE                     RBXEND:
001847 E5BE 110000          10  LEFT:   LD  DE,0
00184A E5C1 AF               4      XOR A
00184B E5C2 FD6E21          19      LD  L,(IY+33)   ;(FCB)ランダムレコード
00184E E5C5 FD6622          19      LD  H,(IY+34)
001851 E5C8 19              11      ADD HL,DE
001852 E5C9 FD8E23          19      ADC A,(IY+35)
001855 E5CC FD7521          19      LD  (IY+33),L   ;(FCB)ランダムレコード
001858 E5CF FD7422          19      LD  (IY+34),H
00185B E5D2 FD7723          19      LD  (IY+35),A
00185E E5D5 EB               4      EX  DE,HL       ;HL=Read byte
00185F E5D6 C9              10      RET
                                
       E5D7                     GET_RR_CDE:         ;CDE=Random record
001860 E5D7 FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
001863 E5DA FD5622          19      LD  D,(IY+34)
001866 E5DD FD4E23          19      LD  C,(IY+35)
001869 E5E0 C9              10      RET
                                
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E5E1                     DRDX:
00186A E5E1 CD1FE6          17      CALL    DRDY
00186D E5E4 C8              11      RET Z
00186E E5E5 CD05E6          17      CALL    DRDX1       ;データバッファの情報を保存
001871 E5E8 D8              11      RET C
001872 E5E9 E5              11      PUSH    HL
001873 E5EA C5              11      PUSH    BC
001874 E5EB D5              11      PUSH    DE
001875 E5EC 2A7EF0          16      LD  HL,(_DTBUF)
001878 E5EF 3A48E6          13      LD  A,(_DBS24+1)
00187B E5F2 4F               4      LD  C,A
00187C E5F3 CDCAE8          17      CALL    DRD24
00187F E5F6 DC1AE6          17      CALL    C,DRDNE
       E5F9                     POP_DE_BC_HL_RET:
001882 E5F9 D1              10      POP DE
001883 E5FA C1              10      POP BC
001884 E5FB E1              10      POP HL
001885 E5FC C9              10      RET
                                
                                ;   CDE:セクタ番号
       E5FD                     DRDN:
001886 E5FD AF               4      XOR A
001887 E5FE 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
001888 E5FF 30E0            12      JR  NC,DRDX
       E601                     DRDNX:
00188A E601 CD1FE6          17      CALL    DRDY
00188D E604 C8              11      RET Z
       E605                     DRDX1:
00188E E605 CD35E6          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
001891 E608 ED53A6EF        20      LD  (_DBSEC),DE
001895 E60C 79               4      LD  A,C
001896 E60D 3248E6          13      LD  (_DBS24+1),A
                                
001899 E610 3A88EF          13      LD  A,(_DRV)
00189C E613 32A5EF          13      LD  (_DBDRV),A
00189F E616 CDD9EF          17      CALL    _CHGDRV
0018A2 E619 D0              11      RET NC
       E61A                     DRDNE:
0018A3 E61A 9F               4      SBC A,A     ;CF=1ならばA=0FFH
0018A4 E61B 32A5EF          13      LD  (_DBDRV),A
0018A7 E61E C9              10      RET
                                
                                ;   CDE:セクタ番号
       E61F                     DRDY:
0018A8 E61F 3A48E6          13      LD  A,(_DBS24+1)
0018AB E622 B9               4      CP  C
0018AC E623 C0              11      RET NZ
                                
0018AD E624 E5              11      PUSH    HL
0018AE E625 3A88EF          13      LD  A,(_DRV)
0018B1 E628 21A5EF          10      LD  HL,_DBDRV
0018B4 E62B AE               7      XOR (HL)
0018B5 E62C 2005            12      JR  NZ,POP_HL_RET
                                
0018B7 E62E 2AA6EF          16      LD  HL,(_DBSEC)
0018BA E631 ED52            15      SBC HL,DE       ;CF=0
       E633                     POP_HL_RET:
0018BC E633 E1              10      POP HL
0018BD E634 C9              10      RET
                                
       E635                     DWTX:
0018BE E635 3AA4EF          13      LD  A,(_WTDBF)
0018C1 E638 B7               4      OR  A
0018C2 E639 C8              11      RET Z
0018C3 E63A AF               4      XOR A
0018C4 E63B 32A4EF          13      LD  (_WTDBF),A
                                
0018C7 E63E E5              11      PUSH    HL
0018C8 E63F C5              11      PUSH    BC
0018C9 E640 D5              11      PUSH    DE
0018CA E641 3AA5EF          13      LD  A,(_DBDRV)
0018CD E644 CDD9EF          17      CALL    _CHGDRV
0018D0 E647 0E00             7  _DBS24: LD  C,0
0018D2 E649 ED5BA6EF        20      LD  DE,(_DBSEC)
0018D6 E64D 2A7EF0          16      LD  HL,(_DTBUF)
0018D9 E650 D4DAE8          17      CALL    NC,DWT24
       E653                     POP_DE_BC_HL_RET2:
0018DC E653 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E655                     RDFATX:
0018DE E655 E5              11      PUSH    HL
0018DF E656 3A88EF          13      LD  A,(_DRV)
0018E2 E659 21AAEF          10      LD  HL,_FATDRV
0018E5 E65C AE               7      XOR (HL)
0018E6 E65D 28D4            12      JR  Z,POP_HL_RET
                                
0018E8 E65F C5              11      PUSH    BC
0018E9 E660 D5              11      PUSH    DE
0018EA E661 DDE5            15      PUSH    IX
0018EC E663 CD7FE6          17      CALL    WTFATX
0018EF E666 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
0018F1 E668 AF               4      XOR A
0018F2 E669 32ABEF          13      LD  (_FATIX),A
0018F5 E66C 3A88EF          13      LD  A,(_DRV)
0018F8 E66F 32AAEF          13      LD  (_FATDRV),A
0018FB E672 CDE5EF          17      CALL    _RDFAT
       E675                     RDFATE2:
0018FE E675 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
001900 E677 9F               4      SBC A,A     ;A=0xFF
001901 E678 32AAEF          13      LD  (_FATDRV),A
       E67B                     POP_IX_DE_BC_HL_RET:
001904 E67B DDE1            14      POP IX
001906 E67D 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E67F                     WTFATX:
001908 E67F 3AA2EF          13      LD  A,(_WTFATF)
00190B E682 B7               4      OR  A
00190C E683 C8              11      RET Z
00190D E684 E5              11      PUSH    HL
00190E E685 3AAAEF          13      LD  A,(_FATDRV)
001911 E688 21A5EF          10      LD  HL,_DBDRV
001914 E68B AE               7      XOR (HL)
001915 E68C CC35E6          17      CALL    Z,DWTX
001918 E68F 38A2            12      JR  C,POP_HL_RET
00191A E691 C5              11      PUSH    BC
00191B E692 D5              11      PUSH    DE
00191C E693 DDE5            15      PUSH    IX
00191E E695 CDE7E8          17      CALL    WTFAT
001921 E698 AF               4      XOR A
001922 E699 32A2EF          13      LD  (_WTFATF),A
001925 E69C 18DD            12      JR  POP_IX_DE_BC_HL_RET
                                
       E69E                     NCL1:
001927 E69E 7A               4      LD  A,D
001928 E69F B3               4      OR  E
001929 E6A0 37               4      SCF
00192A E6A1 C8              11      RET Z
                                
00192B E6A2 7A               4      LD  A,D
00192C E6A3 CB3F             8      SRL A   ;/2
00192E E6A5 CB3F             8      SRL A   ;/2
                                
001930 E6A7 E5              11      PUSH    HL
001931 E6A8 32C7E6          13      LD  (NCLPAT+2),A    ;_FATIX
001934 E6AB 2AAAEF          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
001937 E6AE BC               4      CP  H
001938 E6AF 3A88EF          13      LD  A,(_DRV)    ;この間でフラグは変化しない
00193B E6B2 32C6E6          13      LD  (NCLPAT+1),A    ;_FATDRV
00193E E6B5 2005            12      JR  NZ,NCL2     ;FATIXが違う
001940 E6B7 BD               4      CP  L
001941 E6B8 2002            12      JR  NZ,NCL2     ;ドライブが違う
001943 E6BA E1              10      POP HL
001944 E6BB C9              10      RET
       E6BC                     NCL2:
001945 E6BC C5              11      PUSH    BC
001946 E6BD D5              11      PUSH    DE
001947 E6BE DDE5            15      PUSH    IX
001949 E6C0 CD7FE6          17      CALL    WTFATX
00194C E6C3 38B6            12      JR  C,POP_IX_DE_BC_HL_RET
00194E E6C5 010000          10  NCLPAT: LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
001951 E6C8 ED43AAEF        20      LD  (_FATDRV),BC
001955 E6CC CDBCE8          17      CALL    RDFATS
001958 E6CF 18A4            12      JR  RDFATE2
                                
       E6D1                     NCL3:
00195A E6D1 CB9A             8      RES 3,D
00195C E6D3 CB92             8      RES 2,D
00195E E6D5 6B               4      LD  L,E
00195F E6D6 62               4      LD  H,D
001960 E6D7 CB3C             8      SRL H   ;
001962 E6D9 CB1D             8      RR  L   ;HLA=HLA/2
001964 E6DB 1F               4      RRA     ;
001965 E6DC F5              11      PUSH    AF
001966 E6DD 3AABEF          13      LD  A,(_FATIX)
001969 E6E0 0F               4      RRCA
00196A E6E1 300B            12      JR  NC,NCL3X1
00196C E6E3 3A7CE5          13      LD  A,(SECSZ+2)
00196F E6E6 FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
001971 E6E8 2004            12      JR  NZ,NCL3X1
001973 E6EA 010002          10      LD  BC,512
001976 E6ED 09              11      ADD HL,BC
       E6EE                     NCL3X1:
001977 E6EE F1              10      POP AF
001978 E6EF ED4B7CF0        20      LD  BC,(_FATBF)
00197C E6F3 19              11      ADD HL,DE
00197D E6F4 09              11      ADD HL,BC
00197E E6F5 17               4      RLA
00197F E6F6 C9              10      RET
                                
       E6F7                     GNCL:
001980 E6F7 CD9EE6          17      CALL    NCL1        ;GET NEXT CLUSTER
001983 E6FA D8              11      RET C
001984 E6FB C5              11      PUSH    BC
001985 E6FC E5              11      PUSH    HL
001986 E6FD CDD1E6          17      CALL    NCL3
001989 E700 3809            12      JR  C,GNC1
00198B E702 5E               7      LD  E,(HL)
00198C E703 23               6      INC HL
00198D E704 7E               7      LD  A,(HL)
00198E E705 E60F             7      AND 00FH
001990 E707 57               4      LD  D,A
001991 E708 E1              10      POP HL
001992 E709 C1              10      POP BC
001993 E70A C9              10      RET
       E70B                     GNC1:
001994 E70B 7E               7      LD  A,(HL)
001995 E70C 23               6      INC HL
001996 E70D 56               7      LD  D,(HL)
001997 E70E 0604             7      LD  B,4
       E710                     GNC1L:
001999 E710 CB3A             8      SRL D   ;DA=DA/2
00199B E712 1F               4      RRA     ;
00199C E713 10FB            13      DJNZ    GNC1L
                                
00199E E715 5F               4      LD  E,A
00199F E716 E1              10      POP HL
0019A0 E717 C1              10      POP BC
0019A1 E718 A7               4      AND A
0019A2 E719 C9              10      RET
                                
       E71A                     SNCL:
0019A3 E71A CD9EE6          17      CALL    NCL1
0019A6 E71D D8              11      RET C
                                ;               SET NEXT CLUSTER
0019A7 E71E E5              11      PUSH    HL
0019A8 E71F C5              11      PUSH    BC
0019A9 E720 D5              11      PUSH    DE
0019AA E721 E5              11      PUSH    HL
0019AB E722 CDD1E6          17      CALL    NCL3
0019AE E725 D1              10      POP DE
                                ;CF=ODD
0019AF E726 7E               7      LD  A,(HL)
0019B0 E727 73               7      LD  (HL),E
0019B1 E728 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
0019B3 E72A 23               6      INC HL
0019B4 E72B ED67            18      RRD     ;M={A[3:0],E[3:0]}
0019B6 E72D 7A               4      LD  A,D
0019B7 E72E 1804            12      JR  SNC11
       E730                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
0019B9 E730 ED6F            18      RLD     ;M={D[3:0],E[7:4]}
0019BB E732 23               6      INC HL
0019BC E733 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E734                     SNC11:
0019BD E734 ED6F            18      RLD     ;M={M[7:4],D[3:0]}
0019BF E736 B7               4      OR  A
0019C0 E737 D1              10      POP DE
0019C1 E738 C1              10      POP BC
0019C2 E739 E1              10      POP HL
       E73A                     FAT_CHANGED:
0019C3 E73A 3E01             7      LD  A,1
0019C5 E73C 32A2EF          13      LD  (_WTFATF),A
0019C8 E73F C9              10      RET
                                
       E740                     N16CL3:
0019C9 E740 C5              11      PUSH    BC
0019CA E741 6B               4      LD  L,E
0019CB E742 7A               4      LD  A,D
0019CC E743 E603             7      AND 3
0019CE E745 67               4      LD  H,A
0019CF E746 29              11      ADD HL,HL
0019D0 E747 ED4B7CF0        20      LD  BC,(_FATBF)
0019D4 E74B 09              11      ADD HL,BC
0019D5 E74C C1              10      POP BC
0019D6 E74D C9              10      RET
                                
       E74E                     GNCL16:
0019D7 E74E CD9EE6          17      CALL    NCL1        ;GET NEXT CLUSTER for FAT16
0019DA E751 D8              11      RET C
0019DB E752 E5              11      PUSH    HL
0019DC E753 CD40E7          17      CALL    N16CL3
0019DF E756 5E               7      LD  E,(HL)
0019E0 E757 23               6      INC HL
0019E1 E758 56               7      LD  D,(HL)
0019E2 E759 E1              10      POP HL
0019E3 E75A C9              10      RET
                                
       E75B                     SNCL16:
0019E4 E75B CD9EE6          17      CALL    NCL1        ;GET NEXT CLUSTER for FAT16
0019E7 E75E D8              11      RET C
0019E8 E75F D5              11      PUSH    DE
0019E9 E760 E5              11      PUSH    HL
0019EA E761 CD40E7          17      CALL    N16CL3
0019ED E764 D1              10      POP DE      ;HL
0019EE E765 73               7      LD  (HL),E
0019EF E766 23               6      INC HL
0019F0 E767 72               7      LD  (HL),D
0019F1 E768 6B               4      LD  L,E
0019F2 E769 62               4      LD  H,D
0019F3 E76A D1              10      POP DE
0019F4 E76B 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E76D                     NEXTX:
0019F6 E76D 3E00             7  _SECPS: LD  A,0 ;自己書き換え
0019F8 E76F 3C               4      INC A
0019F9 E770 E600             7  NCPAT:  AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
0019FB E772 326EE7          13      LD  (_SECPS+1),A
0019FE E775 C9              10      RET
                                
       E776                     GNCLX:
0019FF E776 CD6DE7          17      CALL    NEXTX
001A02 E779 C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
001A03 E77A C3F7EF          10      JP  _GNCL   ;次のクラスタを探す
                                
       E77D                     RDFAT:
001A06 E77D 3E80             7      LD  A,080H
001A08 E77F 3270EF          13      LD  (CHECK),A
       E782                     RDFAT1:
001A0B E782 3A88EF          13      LD  A,(_DRV)
001A0E E785 CD1AEA          17      CALL    CHGDRVR
001A11 E788 D8              11      RET C
001A12 E789 DD7E12          19      LD  A,(IX+012H) ;DPB_12_DEVICE
001A15 E78C CB6F             8      BIT 5,A
001A17 E78E 2843            12      JR  Z,RDFAT0X
001A19 E790 2170EF          10      LD  HL,CHECK
001A1C E793 A6               7      AND (HL)
001A1D E794 77               7      LD  (HL),A
001A1E E795 110000          10      LD  DE,0        ;BPB
001A21 E798 2A7CF0          16      LD  HL,(_FATBF)
001A24 E79B CDC8E8          17      CALL    DRD16
001A27 E79E 3024            12      JR  NC,GETBPB
001A29 E7A0 2170EF          10      LD  HL,CHECK
001A2C E7A3 CB06            15      RLC (HL)
001A2E E7A5 3F               4      CCF
001A2F E7A6 D8              11      RET C
001A30 E7A7 DDCB0A1E        23      RR  (IX+00AH)   ;DPB_0A_FDMODE
001A34 E7AB 3F               4      CCF         ;フロッピーディスクのMFMモードを切り替える
001A35 E7AC DDCB0A16        23      RL  (IX+00AH)   ;DPB_0A_FDMODE
001A39 E7B0 3EFF             7      LD  A,0FFH
001A3B E7B2 3289EF          13      LD  (_DSK),A
001A3E E7B5 3A84EF          13      LD  A,(_DRIVE)
001A41 E7B8 E603             7      AND 3
001A43 E7BA F680             7      OR  080H
001A45 E7BC 6F               4      LD  L,A
001A46 E7BD 26EF             7      LD  H,_CYL0/256
001A48 E7BF 3EFF             7      LD  A,0FFH
001A4A E7C1 77               7      LD  (HL),A
001A4B E7C2 18BE            12      JR  RDFAT1
       E7C4                     GETBPB:
001A4D E7C4 FDE5            15      PUSH    IY
001A4F E7C6 FD2A7CF0        20      LD  IY,(_FATBF) ;BPB
001A53 E7CA CDF1EF          17      CALL    _BPB2DPB
001A56 E7CD FDE1            14      POP IY
001A58 E7CF D8              11      RET C
001A59 E7D0 CD70E9          17      CALL    CHGDRV2
       E7D3                     RDFAT0X:
001A5C E7D3 CDBCE8          17      CALL    RDFATS
001A5F E7D6 D8              11      RET C
001A60 E7D7 DDBE06           7      CP  (IX+6)      ;DPB_06_FATID
001A63 E7DA C8              11      RET Z
001A64 E7DB DDCB126E        20      BIT 5,(IX+012H) ;DPB_12_DEVICE
001A68 E7DF C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
001A69 E7E0 37               4      SCF
001A6A E7E1 C9              10      RET
                                
       E7E2                     BPB2DPB:
001A6B E7E2 FD7E00          19      LD  A,(IY+0)    ;BS_JmpBoot
001A6E E7E5 FEEB             7      CP  0EBH        ;Short jump
001A70 E7E7 2808            12      JR  Z,BPBOK
001A72 E7E9 FEE9             7      CP  0E9H        ;Near jump
001A74 E7EB 2804            12      JR  Z,BPBOK
001A76 E7ED FE60             7      CP  060H        ;X68k
001A78 E7EF 37               4      SCF
001A79 E7F0 C0              11      RET NZ
       E7F1                     BPBOK:
001A7A E7F1 FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
001A7D E7F4 DD7707          19      LD  (IX+7),A    ;DPB_07_SECPCL
                                
001A80 E7F7 FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
001A83 E7FA DD7700          19      LD  (IX+0),A    ;DPB_00_FATLN
001A86 E7FD FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
001A89 E800 DD7701          19      LD  (IX+1),A    ;DPB_00_FATLN
                                
001A8C E803 FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
001A8F E806 FD660F          19      LD  H,(IY+15)
001A92 E809 DD750E          19      LD  (IX+00EH),L ;DPB_0E_FATPS
001A95 E80C FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
001A98 E80F FD5617          19      LD  D,(IY+23)
001A9B E812 FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E815                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
001A9E E815 19              11      ADD HL,DE
001A9F E816 10FD            13      DJNZ    BPBDP1
       E818                     BPBDP2:
001AA1 E818 DD7510          19      LD  (IX+010H),L ;DPB_10_DIRPS
001AA4 E81B DD7411          19      LD  (IX+011H),H
001AA7 E81E E5              11      PUSH    HL
                                
001AA8 E81F FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
001AAB E822 FD6612          19      LD  H,(IY+18)
001AAE E825 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001AB1 E828 0606             7      LD  B,6
       E82A                     BPBBPS1:
001AB3 E82A 05               4      DEC B
001AB4 E82B 0F               4      RRCA
001AB5 E82C 30FC            12      JR  NC,BPBBPS1
       E82E                     BPBDE1:
001AB7 E82E 29              11      ADD HL,HL
001AB8 E82F 10FD            13      DJNZ    BPBDE1
                                
001ABA E831 7C               4      LD  A,H
001ABB E832 DD770B          19      LD  (IX+00BH),A ;DPB_0B_DIRSCNT
                                
001ABE E835 D1              10      POP DE      ;DPB_10_DIRPS
001ABF E836 6C               4      LD  L,H
001AC0 E837 2600             7      LD  H,0
001AC2 E839 19              11      ADD HL,DE       ;MAXDIR
001AC3 E83A E5              11      PUSH    HL
001AC4 E83B FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
001AC7 E83E CB21             8      SLA C       ;*2
001AC9 E840 AF               4      XOR A
001ACA E841 47               4      LD  B,A
001ACB E842 ED42            15      SBC HL,BC
001ACD E844 DD7514          19      LD  (IX+014H),L ;DPB_14_ADDCL16
001AD0 E847 DD7415          19      LD  (IX+015H),H
                                
001AD3 E84A D1              10      POP DE      ;DE=DPB_0B_MAXDIR
001AD4 E84B FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
001AD7 E84E FD6614          19      LD  H,(IY+20)
001ADA E851 7C               4      LD  A,H
001ADB E852 B5               4      OR  L
001ADC E853 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001ADE E855 2010            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001AE0 E857 FD7E23          19      LD  A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001AE3 E85A B7               4      OR  A
001AE4 E85B 37               4      SCF
001AE5 E85C C0              11      RET NZ
001AE6 E85D FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001AE9 E860 FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_07_SECPCL)が最大128なので
001AEC E863 FD7E22          19      LD  A,(IY+34)   ;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
001AEF E866 A7               4      AND A       ;CF=0
       E867                     BPB16BIT:
001AF0 E867 ED52            15      SBC HL,DE
001AF2 E869 DE00             7      SBC A,0
001AF4 E86B FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E86E                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001AF7 E86E CB18             8      RR  B       ;->CY
001AF9 E870 3808            12      JR  C,BPBTC2
001AFB E872 CB3F             8      SRL A
001AFD E874 CB1C             8      RR  H       ;AHL=AHL/2
001AFF E876 CB1D             8      RR  L
001B01 E878 18F4            12      JR  BPBTC1
       E87A                     BPBTC2:
001B03 E87A B7               4      OR  A
001B04 E87B 37               4      SCF
001B05 E87C C0              11      RET NZ      ;念のため(クラスタ数が16ビットを超える場合)
001B06 E87D 23               6      INC HL
001B07 E87E 23               6      INC HL
001B08 E87F DD7508          19      LD  (IX+8),L    ;DPB_08_MAXCL
001B0B E882 DD7409          19      LD  (IX+9),H
                                
001B0E E885 FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001B11 E888 DD7706          19      LD  (IX+6),A    ;DPB_06_FATID
                                
001B14 E88B DDCB0A7E        20      BIT 7,(IX+00AH) ;DPB_0A_FDMODE
001B18 E88F 2817            12      JR  Z,NOT_FD
001B1A E891 2E28             7      LD  L,40        ;MAXCYLの設定（要検討）ここから下はフロッピーのみ書き換える
001B1C E893 FEFD             7      CP  0FDH    ;2D
001B1E E895 2808            12      JR  Z,SETCYL
001B20 E897 2E4D             7      LD  L,77
001B22 E899 FEFE             7      CP  0FEH    ;2HD
001B24 E89B 2802            12      JR  Z,SETCYL
001B26 E89D 2E50             7      LD  L,80    ;その他2DD等
       E89F                     SETCYL:
001B28 E89F DD750C          19      LD  (IX+00CH),L ;DPB_0C_MAXCYL
001B2B E8A2 FD7E18          19      LD  A,(IY+24)   ;BPB_SecPerTr
001B2E E8A5 DD770D          19      LD  (IX+00DH),A ;DPB_0D_MAXSEC  ;ここまでフロッピー専用
       E8A8                     NOT_FD:
001B31 E8A8 FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001B34 E8AB FE02             7      CP  2       ;>2:NC
001B36 E8AD FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001B39 E8B0 3802            12      JR  C,BPBFAT1
001B3B E8B2 F680             7      OR  080H
       E8B4                     BPBFAT1:
001B3D E8B4 DD770F          19      LD  (IX+00FH),A ;DPB_0F_BPS
                                
001B40 E8B7 E67F             7      AND 07FH        ;セクタバッファが1KBしかないので1KBを超える場合はCF=1でエラーにする
001B42 E8B9 C6FB             7      ADD A,0-5       ;0-4:CF=0 5以上:CF=1
001B44 E8BB C9              10      RET
                                
       E8BC                     RDFATS:
001B45 E8BC CD02E9          17      CALL    FATSETUP
001B48 E8BF D8              11      RET C
001B49 E8C0 CDCCE8          17      CALL    DRD24B
001B4C E8C3 2A7CF0          16      LD  HL,(_FATBF)
001B4F E8C6 7E               7      LD  A,(HL)
001B50 E8C7 C9              10      RET
                                
       E8C8                     DRD16:
001B51 E8C8 0E00             7      LD  C,0
       E8CA                     DRD24:
001B53 E8CA 0601             7      LD  B,1
       E8CC                     DRD24B:
001B55 E8CC DDE5            15      PUSH    IX
001B57 E8CE DD2AA8EF        20      LD  IX,(_DPB)
001B5B E8D2 CD6AEB          17  DRDPAT: CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E8D5                     POP_IX_RET:
001B5E E8D5 DDE1            14      POP IX
001B60 E8D7 C9              10      RET
                                
       E8D8                     DWT16:
001B61 E8D8 0E00             7      LD  C,0
       E8DA                     DWT24:
001B63 E8DA 0601             7      LD  B,1
       E8DC                     DWT24B:
001B65 E8DC DDE5            15      PUSH    IX
001B67 E8DE DD2AA8EF        20      LD  IX,(_DPB)
001B6B E8E2 CD0DEB          17  DWTPAT: CALL    FDWT        ;自己書き換え（ディスク書き込み）
001B6E E8E5 18EE            12      JR  POP_IX_RET
                                
       E8E7                     WTFAT:
001B70 E8E7 CD02E9          17      CALL    FATSETUP
001B73 E8EA D4DCE8          17      CALL    NC,DWT24B
001B76 E8ED D8              11      RET C
001B77 E8EE DDCB0F7E        20      BIT 7,(IX+00FH) ;DPB_0F_BPS
001B7B E8F2 C8              11      RET Z       ;予備FATが無い
001B7C E8F3 CD09E9          17      CALL    FATS2
001B7F E8F6 E5              11      PUSH    HL      ;予備FAT
001B80 E8F7 DD6E00          19      LD  L,(IX+0)    ;DPB_00_FATLN
001B83 E8FA DD6601          19      LD  H,(IX+1)
001B86 E8FD 19              11      ADD HL,DE
001B87 E8FE EB               4      EX  DE,HL
001B88 E8FF E1              10      POP HL
001B89 E900 18DA            12      JR  DWT24B
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ1024毎に2KBを切り替える
                                ;------------------------
       E902                     FATSETUP:
001B8B E902 3AAAEF          13      LD  A,(_FATDRV)
001B8E E905 CD1AEA          17      CALL    CHGDRVR     ;ドライブ切り替え
001B91 E908 D8              11      RET C
       E909                     FATS2:
001B92 E909 DD7E0F          19      LD  A,(IX+00FH) ;DPB_0F_BPS 512=2 1024=4
001B95 E90C 0F               4      RRCA
001B96 E90D CD36E9          17  FATSX:  CALL    FATSETUP12  ;自己書き換え
001B99 E910 210000          10      LD  HL,0
001B9C E913 4A               4      LD  C,D
001B9D E914 54               4      LD  D,H
001B9E E915 3AABEF          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
001BA1 E918 47               4      LD  B,A
001BA2 E919 04               4      INC B
001BA3 E91A DD7E00          19      LD  A,(IX+0)    ;DPB_00_FATLN
       E91D                     FAT_SKP:
001BA6 E91D 05               4      DEC B
001BA7 E91E 2805            12      JR  Z,FAT1
001BA9 E920 19              11      ADD HL,DE
001BAA E921 93               4      SUB E
001BAB E922 30F9            12      JR  NC,FAT_SKP
001BAD E924 C9              10      RET
       E925                     FAT1:
001BAE E925 EB               4      EX  DE,HL
001BAF E926 B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001BB0 E927 3801            12      JR  C,FAT2
001BB2 E929 79               4      LD  A,C
       E92A                     FAT2:
001BB3 E92A 47               4      LD  B,A
                                
001BB4 E92B 2AFAF0          16      LD  HL,(_FATPS) ;fat sector pos
001BB7 E92E 19              11      ADD HL,DE
001BB8 E92F EB               4      EX  DE,HL
001BB9 E930 2A7CF0          16      LD  HL,(_FATBF)
001BBC E933 AF               4      XOR A       ;CF=0
001BBD E934 4F               4      LD  C,A
001BBE E935 C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       E936                     FATSETUP12:
001BBF E936 110606          10      LD  DE,0606H    ;256
001BC2 E939 D8              11      RET C
001BC3 E93A 110303          10      LD  DE,0303H    ;512
001BC6 E93D 0F               4      RRCA
001BC7 E93E D8              11      RET C
001BC8 E93F 110102          10      LD  DE,0201H    ;1024
001BCB E942 C9              10      RET
                                
       E943                     FATSETUP16:
001BCC E943 110808          10      LD  DE,0808H    ;256
001BCF E946 D8              11      RET C
001BD0 E947 110404          10      LD  DE,0404H
001BD3 E94A 0F               4      RRCA            ;512
001BD4 E94B D8              11      RET C
001BD5 E94C 110202          10      LD  DE,0202H    ;1024
001BD8 E94F C9              10      RET
                                
       E950                     CHGDRV:
001BD9 E950 E5              11      PUSH    HL
001BDA E951 2189EF          10      LD  HL,_DSK
001BDD E954 BE               7      CP  (HL)
001BDE E955 280A            12      JR  Z,CHGDRVE
       E957                     CHGDRV1:
001BE0 E957 DDE5            15      PUSH    IX
001BE2 E959 CD63E9          17      CALL    CHGDRV0
001BE5 E95C 3A89EF          13      LD  A,(_DSK)
001BE8 E95F DDE1            14      POP IX
       E961                     CHGDRVE:
001BEA E961 E1              10      POP HL
001BEB E962 C9              10      RET
                                
       E963                     CHGDRV0:
001BEC E963 6F               4      LD  L,A
001BED E964 CDDCEF          17      CALL    _GETDPB
001BF0 E967 D8              11      RET C
001BF1 E968 DD22A8EF        20      LD  (_DPB),IX
001BF5 E96C 7D               4      LD  A,L
001BF6 E96D 3289EF          13      LD  (_DSK),A
       E970                     CHGDRV2:
001BF9 E970 C5              11      PUSH    BC
001BFA E971 D5              11      PUSH    DE
001BFB E972 ED73CFE9        20      LD  (SPPAT2+1),SP
001BFF E976 F3               4      DI
001C00 E977 DDF9            10      LD  SP,IX
                                
001C02 E979 E1              10      POP HL      ;DPB_00_FATLN
001C03 E97A E1              10      POP HL      ;DPB_02_DRD
001C04 E97B 22D3E8          16      LD  (DRDPAT+1),HL
                                
001C07 E97E E1              10      POP HL
001C08 E97F 22E3E8          16      LD  (DWTPAT+1),HL   ;DPB_04_DWT
                                
001C0B E982 E1              10      POP HL      ;L=DPB_06_FATID H=DPB_07_SECPCL
001C0C E983 7C               4      LD  A,H
001C0D E984 32C5E0          13      LD  (SPCPAT+1),A    ;1クラスタの論理セクタ数
001C10 E987 3D               4      DEC A
001C11 E988 3271E7          13      LD  (NCPAT+1),A
                                
001C14 E98B E1              10      POP HL      ;DPB_08_MAXCL
001C15 E98C 7D               4      LD  A,L
001C16 E98D 32E4E0          13      LD  (CLPAT2+1),A
001C19 E990 7C               4      LD  A,H
001C1A E991 32E0E0          13      LD  (CLPAT1+1),A
001C1D E994 2B               6      DEC HL
001C1E E995 22DEE2          16      LD  (MAXCLP+1),HL
                                
001C21 E998 E1              10      POP HL      ;L=DPB_0A_FDMODE H=DPB_0B_DIRSCNT
001C22 E999 7D               4      LD  A,L
001C23 E99A F6FE             7      OR  0FEH
001C25 E99C 320AEC          13      LD  (FDMODE+1),A
001C28 E99F 07               4      RLCA
001C29 E9A0 E603             7      AND 3
001C2B E9A2 32ACEA          13      LD  (FSPAT+1),A
001C2E E9A5 4C               4      LD  C,H
                                
001C2F E9A6 E1              10      POP HL      ;L=DPB_0C_MAXCYL H=DPB_0D_MAXSEC
001C30 E9A7 7D               4      LD  A,L
001C31 E9A8 32A1EF          13      LD  (_MAXCYL),A
001C34 E9AB 7C               4      LD  A,H
001C35 E9AC 3266EA          13      LD  (MAXSEC+1),A
                                
001C38 E9AF E1              10      POP HL      ;L=DPB_0E_FATPS H=DPB_0F_BPS
001C39 E9B0 7C               4      LD  A,H     ;DPB_0F_BPS
001C3A E9B1 E607             7      AND 7
001C3C E9B3 327CE5          13      LD  (SECSZ+2),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM等
                                                ;1セクタ1024 2HD/2HDE98
                                                ;1セクタ256 GRAM等
                                                ;1024   512 256
                                                ;4  2   1
001C3F E9B6 87               4      ADD A,A     ;8  4   2
001C40 E9B7 87               4      ADD A,A     ;010H   8   4
001C41 E9B8 87               4      ADD A,A     ;020H   010H    8
001C42 E9B9 3241DF          13      LD  (SDECPAT+1),A   ;1セクタ辺りのディレクトリエントリ数
                                
001C45 E9BC 2600             7      LD  H,0
001C47 E9BE 22FAF0          16      LD  (_FATPS),HL
                                
001C4A E9C1 E1              10      POP HL      ;L=DPB_10_DIRPS
001C4B E9C2 22FCF0          16      LD  (_DIRPS),HL
                                
001C4E E9C5 E1              10      POP HL      ;L=DPB_12_DEVICE H=DPB_13_UNITNO
001C4F E9C6 7C               4      LD  A,H
001C50 E9C7 3284EF          13      LD  (_DRIVE),A
                                
001C53 E9CA E1              10      POP HL      ;DPB_14_ADDCL16
001C54 E9CB 22D5E0          16      LD  (CLSPAT+1),HL
                                
001C57 E9CE 310000          10  SPPAT2: LD  SP,0        ;元のSPを復元
001C5A E9D1 FB               4      EI
001C5B E9D2 2AFCF0          16      LD  HL,(_DIRPS)
001C5E E9D5 0600             7      LD  B,0
001C60 E9D7 09              11      ADD HL,BC
001C61 E9D8 225CDF          16      LD  (MD_PAT+1),HL
                                
001C64 E9DB 2ADEE2          16      LD  HL,(MAXCLP+1);
001C67 E9DE 11F60F          10      LD  DE,4086
001C6A E9E1 B7               4      OR  A
001C6B E9E2 ED52            15      SBC HL,DE
001C6D E9E4 300F            12      JR  NC,SETFAT16
001C6F E9E6 21F7E6          10      LD  HL,GNCL     ;FAT12
001C72 E9E9 111AE7          10      LD  DE,SNCL
001C75 E9EC 0136E9          10      LD  BC,FATSETUP12
001C78 E9EF DDCB0FAE        23      RES 5,(IX+00FH) ;DPB_0F_BPS(FAT12)
001C7C E9F3 180D            12      JR  EXTRA1
       E9F5                     SETFAT16:
001C7E E9F5 214EE7          10      LD  HL,GNCL16   ;FAT16
001C81 E9F8 115BE7          10      LD  DE,SNCL16
001C84 E9FB 0143E9          10      LD  BC,FATSETUP16
001C87 E9FE DDCB0FEE        23      SET 5,(IX+00FH) ;DPB_0F_BPS(FAT16)
       EA02                     EXTRA1:
001C8B EA02 22F8EF          16      LD  (GNCPAT+1),HL
001C8E EA05 ED53FBEF        20      LD  (SNCPAT+1),DE
001C92 EA09 ED430EE9        20      LD  (FATSX+1),BC
001C96 EA0D D1              10      POP DE
001C97 EA0E C1              10      POP BC
001C98 EA0F AF               4      XOR A
001C99 EA10 C9              10      RET
                                
       EA11                     GETDPBD:
001C9A EA11 DDE3            23      EX  (SP),IX
001C9C EA13 DDE5            15      PUSH    IX
001C9E EA15 3A88EF          13      LD  A,(_DRV)
001CA1 EA18 1807            12      JR  GETDPB1
                                
       EA1A                     CHGDRVR:
001CA3 EA1A CDD9EF          17      CALL    _CHGDRV
001CA6 EA1D D8              11      RET C
001CA7 EA1E 3A89EF          13      LD  A,(_DSK)
       EA21                     GETDPB1:
001CAA EA21 C3DCEF          10      JP  _GETDPB
                                
       EA24                     GETDPB:
001CAD EA24 FE08             7      CP  8
001CAF EA26 3F               4      CCF
001CB0 EA27 D8              11      RET C
001CB1 EA28 0F               4      RRCA
001CB2 EA29 0F               4      RRCA
001CB3 EA2A 0F               4      RRCA
001CB4 EA2B DD                      DB  0DDH        ;Z80未定義命令
001CB5 EA2C 6F               4      LD  L,A     ;LD IXL,A
001CB6 EA2D DD                      DB  0DDH        ;Z80未定義命令
001CB7 EA2E 26F1             7      LD  H,DEVICE/256    ;LD IXH,DEVICE/256
001CB9 EA30 DD7E00          19      LD  A,(IX+0)    ;DPB_00_FATLN
001CBC EA33 B7               4      OR  A       ;CF=0の為
001CBD EA34 DDCB0F6E        20      BIT 5,(IX+00FH) ;DPB_0F_BPS
001CC1 EA38 C0              11      RET NZ      ;FAT16
001CC2 EA39 DDCB126E        20      BIT 5,(IX+012H) ;DPB_12_DEVICE
001CC6 EA3D C0              11      RET NZ      ;BPB
001CC7 EA3E FE01             7      CP  001H        ;A=0 THEN CF=1
001CC9 EA40 C9              10      RET
                                
       EA41                     _SYS5F:
001CCA EA41 AF               4      XOR A
       EA42                     FFLUSH:
001CCB EA42 F5              11      PUSH    AF
001CCC EA43 3EFF             7      LD  A,0FFH
001CCE EA45 3239EF          13      LD  (SFILE),A
001CD1 EA48 CD35E6          17      CALL    DWTX
001CD4 EA4B 3EFF             7      LD  A,0FFH
001CD6 EA4D 32A5EF          13      LD  (_DBDRV),A
001CD9 EA50 CD7FE6          17      CALL    WTFATX
001CDC EA53 AF               4      XOR A
001CDD EA54 32ABEF          13      LD  (_FATIX),A
001CE0 EA57 2F               4      CPL
001CE1 EA58 32AAEF          13      LD  (_FATDRV),A
001CE4 EA5B F1              10      POP AF
001CE5 EA5C C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   MZ-700/1500
                                
       EA5D                     SEEK:
001CE6 EA5D 7A               4      LD  A,D
001CE7 EA5E B3               4      OR  E
001CE8 EA5F 3E01             7      LD  A,001H
001CEA EA61 2811            12      JR  Z,DIV3
                                
001CEC EA63 0610             7      LD  B,16
001CEE EA65 0E00             7  MAXSEC: LD  C,000H
001CF0 EA67 AF               4      XOR A
001CF1 EA68 EB               4      EX  DE,HL
       EA69                     DIV1:
001CF2 EA69 29              11      ADD HL,HL
001CF3 EA6A 8F               4      ADC A,A
001CF4 EA6B B9               4      CP  C
001CF5 EA6C 3802            12      JR  C,DIV2
001CF7 EA6E 91               4      SUB C
001CF8 EA6F 2C               4      INC L
       EA70                     DIV2:
001CF9 EA70 10F7            13      DJNZ    DIV1
                                
001CFB EA72 3C               4      INC A   ;最小のセクタは１固定
001CFC EA73 55               4      LD  D,L ;TRACK
       EA74                     DIV3:
001CFD EA74 5F               4      LD  E,A ;Remainder
                                
001CFE EA75 3A84EF          13      LD  A,(_DRIVE)
001D01 EA78 FE04             7      CP  4
001D03 EA7A 3F               4      CCF
001D04 EA7B D8              11      RET C
001D05 EA7C F684             7      OR  084H        ;Motor on + ドライブセレクト有効
001D07 EA7E D3DC            11      OUT (0DCH),A
001D09 EA80 CB3A             8      SRL D       ;CYLINDER
001D0B EA82 9F               4      SBC A,A
001D0C EA83 D3DD            11      OUT (0DDH),A    ;SIDE
                                
001D0E EA85 CDC2EA          17      CALL    SETMODE
001D11 EA88 D8              11      RET C
                                
001D12 EA89 CDF7EA          17      CALL    DRIVE
001D15 EA8C FEFF             7      CP  0FFH        ;A=0FFH Unknown CYLINDER
001D17 EA8E CCDEEA          17      CALL    Z,FDCRES    ;Restore
001D1A EA91 2F               4      CPL         ;データバスが負論理
001D1B EA92 D3D9            11      OUT (0D9H),A    ;Currrent CYLINDER
001D1D EA94 2F               4      CPL         ;データバスが負論理
001D1E EA95 92               4      SUB D
001D1F EA96 C8              11      RET Z       ;No seek
                                
001D20 EA97 3A86EF          13      LD  A,(_ISEEK)
001D23 EA9A 4F               4      LD  C,A
                                
001D24 EA9B 3AA1EF          13      LD  A,(_MAXCYL) ;Max CYLINDER
001D27 EA9E 3D               4      DEC A
001D28 EA9F BA               4      CP  D       ;Over CYLINDER
001D29 EAA0 D8              11      RET C
                                
001D2A EAA1 7A               4      LD  A,D
001D2B EAA2 2F               4      CPL         ;データバスが負論理
001D2C EAA3 D3DB            11      OUT (0DBH),A
001D2E EAA5 72               7      LD  (HL),D
                                
001D2F EAA6 0E18             7      LD  C,018H      ;Seek
       EAA8                     FDCCMD2:
001D31 EAA8 3A85EF          13      LD  A,(_SEEKSP)
001D34 EAAB E6FF             7  FSPAT:  AND 0FFH
001D36 EAAD B1               4      OR  C
                                
       EAAE                     FDCCMD:
001D37 EAAE CDEEEA          17      CALL    COMSET
       EAB2                     FDCSMC  EQU $+1
001D3A EAB1 3E80             7      LD  A,080H      ;FDC COMMAND(Self-modifying code)
001D3C EAB3 E620             7      AND 020H        ;Write data Write track
001D3E EAB5 3C               4      INC A
                                
       EAB6                     SST:
001D3F EAB6 0E00             7      LD  C,0
       EAB8                     SST1:
001D41 EAB8 0D               4      DEC C       ; 4
001D42 EAB9 20FD            12      JR  NZ,SST1     ;12 * 256 / 4 = About 1ms
001D44 EABB 3D               4      DEC A
001D45 EABC 20FA            12      JR  NZ,SST1
                                
001D47 EABE 3C               4      INC A       ;A=1
001D48 EABF CDC7EA          17      CALL    READY
       EAC2                     SETMODE:
001D4B EAC2 CDF1EA          17      CALL    DELAY0      ;Head select time
001D4E EAC5 3E81             7      LD  A,081H
       EAC7                     READY:
001D50 EAC7 32D1EA          13      LD  (WAITA),A
001D53 EACA E5              11      PUSH    HL
001D54 EACB 26F8             7      LD  H,0F8H
       EACD                     READY2:
001D56 EACD DBD8            11      IN  A,(0D8H)
001D58 EACF 2F               4      CPL         ;データバスが負論理
       EAD1                     WAITA   EQU $+1
001D59 EAD0 E681             7      AND 081H        ;NOT READY,BUSY
001D5B EAD2 2808            12      JR  Z,READYE
001D5D EAD4 E3              19      EX  (SP),HL     ;wait 19clock
001D5E EAD5 E3              19      EX  (SP),HL     ; //
001D5F EAD6 2B               6      DEC HL
001D60 EAD7 7C               4      LD  A,H
001D61 EAD8 B5               4      OR  L
001D62 EAD9 20F2            12      JR  NZ,READY2
001D64 EADB 37               4      SCF
       EADC                     READYE:
001D65 EADC E1              10      POP HL
001D66 EADD C9              10      RET
                                
       EADE                     FDCRES:
001D67 EADE 3600            10      LD  (HL),0
001D69 EAE0 0E08             7      LD  C,8
001D6B EAE2 18C4            12      JR  FDCCMD2
                                
       EAE4                     FDMOFF:
001D6D EAE4 AF               4      XOR A       ;Motor off(ドライブセレクト無効)
001D6E EAE5 D3DC            11      OUT (0DCH),A
001D70 EAE7 C9              10      RET
                                
       EAE8                     SECSET:
001D71 EAE8 F5              11      PUSH    AF
001D72 EAE9 7B               4      LD  A,E
001D73 EAEA 2F               4      CPL         ;データバスが負論理
001D74 EAEB D3DA            11      OUT (0DAH),A
001D76 EAED F1              10      POP AF
       EAEE                     COMSET:
001D77 EAEE 2F               4      CPL         ;データバスが負論理
001D78 EAEF D3D8            11      OUT (0D8H),A
       EAF1                     DELAY0:
001D7A EAF1 3E1A             7      LD  A,26
       EAF3                     DELAY:
001D7C EAF3 3D               4      DEC A
001D7D EAF4 20FD            12      JR  NZ,DELAY
001D7F EAF6 C9              10      RET
                                
       EAF7                     DRIVE:
001D80 EAF7 2A84EF          16      LD  HL,(_DRIVE)
001D83 EAFA 26EF             7      LD  H,_CYL0/256
001D85 EAFC CBFD             8      SET 7,L
001D87 EAFE 7E               7      LD  A,(HL)
001D88 EAFF C9              10      RET
                                
       EB00                     RNF:
001D89 EB00 CDF7EA          17      CALL    DRIVE
001D8C EB03 36FF            10      LD  (HL),0FFH
001D8E EB05 C9              10      RET
                                
001D8F EB06 02                  RETRY:  DB  2
                                
                                
                                ;   FLOPPY DISK DRIVER
                                
       EB07                     WTTRK:
001D90 EB07 0601             7      LD  B,1
001D92 EB09 3EF0             7      LD  A,0F0H
001D94 EB0B 1802            12      JR  WTTRK1
       EB0D                     FDWT:
001D96 EB0D 3EA0             7      LD  A,0A0H
       EB0F                     WTTRK1:
001D98 EB0F 32B2EA          13      LD  (FDCSMC),A
       EB12                     DWTBL:
001D9B EB12 78               4      LD  A,B
001D9C EB13 3255EB          13      LD  (WTBSMC),A
001D9F EB16 3E02             7      LD  A,2     ;Retry count
001DA1 EB18 3206EB          13      LD  (RETRY),A
                                
       EB1B                     DWT0:
001DA4 EB1B D5              11      PUSH    DE
001DA5 EB1C E5              11      PUSH    HL
001DA6 EB1D 22EFEB          16      LD  (DHLSMC),HL
001DA9 EB20 CD5DEA          17      CALL    SEEK        ;Write disk
001DAC EB23 E1              10      POP HL
001DAD EB24 383A            12      JR  C,ERRDW
001DAF EB26 F3               4      DI
001DB0 EB27 3AB2EA          13      LD  A,(FDCSMC)
001DB3 EB2A CDE8EA          17      CALL    SECSET
001DB6 EB2D 0EDB             7      LD  C,0DBH
       EB2F                     DWT1:
001DB8 EB2F 7E               7      LD  A,(HL)
001DB9 EB30 2F               4      CPL         ;データバスが負論理
001DBA EB31 57               4      LD  D,A
                                
       EB32                     DWT2:
001DBB EB32 DBD8            11      IN  A,(0D8H)
001DBD EB34 2F               4      CPL         ;データバスが負論理
001DBE EB35 0F               4      RRCA
001DBF EB36 3008            12      JR  NC,DWT4
001DC1 EB38 0F               4      RRCA
001DC2 EB39 30F7            12      JR  NC,DWT2
       EB3B                     DWT3:
001DC4 EB3B ED51            12      OUT (C),D
001DC6 EB3D 23               6      INC HL
001DC7 EB3E 18EF            12      JR  DWT1
                                
       EB40                     DWT4:
001DC9 EB40 3D               4      DEC A
001DCA EB41 28F8            12      JR  Z,DWT3
001DCC EB43 3C               4      INC A
001DCD EB44 FB               4      EI
001DCE EB45 D1              10      POP DE
001DCF EB46 13               6      INC DE
001DD0 EB47 CDE4EA          17      CALL    FDMOFF
001DD3 EB4A 2808            12      JR  Z,DISKOK_WT
001DD5 EB4C CDBAEB          17      CALL    DISKC
001DD8 EB4F 20CA            12      JR  NZ,DWT0
001DDA EB51 B7               4      OR  A
001DDB EB52 2005            12      JR  NZ,ERRW
                                
       EB54                     DISKOK_WT:
       EB55                     WTBSMC  EQU $+1
001DDD EB54 0601             7      LD  B,1
001DDF EB56 10BA            13      DJNZ    DWTBL
001DE1 EB58 C9              10      RET
                                
       EB59                     ERRW:
001DE2 EB59 3EFF             7      LD  A,0FFH
       EB5B                     ERRZ:
001DE4 EB5B BF               4      CP  A
001DE5 EB5C 37               4      SCF
001DE6 EB5D C3E4EA          10      JP  FDMOFF
                                
       EB60                     ERRDW:
001DE9 EB60 D1              10      POP DE
001DEA EB61 CDCBEB          17      CALL    DELP
001DED EB64 20B5            12      JR  NZ,DWT0
001DEF EB66 B7               4      OR  A
001DF0 EB67 20F0            12      JR  NZ,ERRW
001DF2 EB69 C9              10      RET
                                
       EB6A                     FDRD:
001DF3 EB6A 3E80             7      LD  A,080H
001DF5 EB6C 32B2EA          13      LD  (FDCSMC),A
       EB6F                     DRDBL:
001DF8 EB6F 78               4      LD  A,B
001DF9 EB70 32ACEB          13      LD  (RDBSMC),A
001DFC EB73 3E02             7      LD  A,2     ;Retry count
001DFE EB75 3206EB          13      LD  (RETRY),A
       EB78                     DRD0:
001E01 EB78 D5              11      PUSH    DE
001E02 EB79 E5              11      PUSH    HL
001E03 EB7A 22EFEB          16      LD  (DHLSMC),HL
001E06 EB7D CD5DEA          17      CALL    SEEK        ;Read disk
001E09 EB80 E1              10      POP HL
001E0A EB81 382D            12      JR  C,ERRDR
001E0C EB83 F3               4      DI
001E0D EB84 3AB2EA          13      LD  A,(FDCSMC)
001E10 EB87 CDE8EA          17      CALL    SECSET
       EB8A                     DRD1:
001E13 EB8A DBD8            11      IN  A,(0D8H)
001E15 EB8C 2F               4      CPL         ;データバスが負論理
001E16 EB8D 0F               4      RRCA
001E17 EB8E 300A            12      JR  NC,DRD3
001E19 EB90 0F               4      RRCA
001E1A EB91 30F7            12      JR  NC,DRD1
001E1C EB93 DBDB            11      IN  A,(0DBH)
001E1E EB95 2F               4      CPL         ;データバスが負論理
001E1F EB96 77               7      LD  (HL),A
001E20 EB97 23               6      INC HL
001E21 EB98 18F0            12      JR  DRD1
                                
       EB9A                     DRD3:
001E23 EB9A B7               4      OR  A
001E24 EB9B FB               4      EI
001E25 EB9C D1              10      POP DE
001E26 EB9D 13               6      INC DE
001E27 EB9E CDE4EA          17      CALL    FDMOFF
001E2A EBA1 2808            12      JR  Z,DISKOK_RD
001E2C EBA3 CDBAEB          17      CALL    DISKC
001E2F EBA6 20D0            12      JR  NZ,DRD0
001E31 EBA8 B7               4      OR  A
001E32 EBA9 20AE            12      JR  NZ,ERRW
                                
       EBAB                     DISKOK_RD:
       EBAC                     RDBSMC  EQU $+1
001E34 EBAB 0601             7      LD  B,1
001E36 EBAD 10C0            13      DJNZ    DRDBL
001E38 EBAF C9              10      RET
                                
       EBB0                     ERRDR:
001E39 EBB0 D1              10      POP DE
001E3A EBB1 CDCBEB          17      CALL    DELP
001E3D EBB4 20C2            12      JR  NZ,DRD0
001E3F EBB6 B7               4      OR  A
001E40 EBB7 20A0            12      JR  NZ,ERRW
001E42 EBB9 C9              10      RET
       EBBA                     DISKC:
001E43 EBBA 1B               6      DEC DE
001E44 EBBB CB5F             8      BIT 3,A
001E46 EBBD C400EB          17      CALL    NZ,RNF
       EBC0                     DISKD:
001E49 EBC0 E5              11      PUSH    HL
001E4A EBC1 2106EB          10      LD  HL,RETRY
001E4D EBC4 35              11      DEC (HL)
001E4E EBC5 E1              10      POP HL
001E4F EBC6 203E            12      JR  NZ,ERR      ;Retry
001E51 EBC8 B7               4      OR  A
001E52 EBC9 283B            12      JR  Z,ERR       ;Error
                                
       EBCB                     DELP:
001E54 EBCB CD00EB          17      CALL    RNF
001E57 EBCE CDE4EA          17      CALL    FDMOFF
001E5A EBD1 3A85EF          13      LD  A,(_SEEKSP)
001E5D EBD4 87               4      ADD A,A
001E5E EBD5 382E            12      JR  C,AERRZ
       EBD7                     DELP1:
001E60 EBD7 D5              11      PUSH    DE
001E61 EBD8 21C0F0          10      LD  HL,DEMES
001E64 EBDB CD75D6          17      CALL    MSX
001E67 EBDE CD3CD9          17      CALL    KEYBC
       EBE1                     DELP2:
001E6A EBE1 CDCAEF          17      CALL    _INKEY
001E6D EBE4 28FB            12      JR  Z,DELP2
                                
001E6F EBE6 D1              10      POP DE
001E70 EBE7 CDE6E0          17      CALL    CAP
001E73 EBEA FE52             7      CP  'R'     ;Retry
001E75 EBEC 200A            12      JR  NZ,DELP3
       EBEF                     DHLSMC  EQU $+1
001E77 EBEE 210000          10      LD  HL,0        ;Self-modifying code
001E7A EBF1 3E02             7      LD  A,2
001E7C EBF3 3206EB          13      LD  (RETRY),A
001E7F EBF6 B7               4      OR  A
001E80 EBF7 C9              10      RET
       EBF8                     DELP3:
001E81 EBF8 FE49             7      CP  'I'     ;Ignore
001E83 EBFA 2807            12      JR  Z,IGNORE
001E85 EBFC FE41             7      CP  'A'     ;Abort
001E87 EBFE 20D7            12      JR  NZ,DELP1
001E89 EC00 C300EF          10      JP  CPM_BOOT
       EC03                     IGNORE:
001E8C EC03 3EFF             7      LD  A,0FFH
       EC05                     AERRZ:
001E8E EC05 BF               4      CP  A
       EC06                     ERR:
001E8F EC06 3EFF             7      LD  A,0FFH
001E91 EC08 C9              10      RET
                                
001E92 EC09 3EFF             7  FDMODE: LD  A,0FFH      ;Floppy mode(2D/2HD) (Self-modifying code)
[EOF:M7DISK.ASM:SHIFT_JIS]
                                
                                    INCLUDE "M7TABLE.ASM"
                                
                                ;   LSX-Dodgers TABLE 表示関連のテーブル
                                ;   MZ-700/1500
                                ;   アドレス下位1バイトが0になるように
                                
       EC0B                     AT_TABLE:
001E94 EC0B                         DS  TABLEAD-AT_TABLE
       ED00                     CD_TABLE:
001F89 ED00 000000C700000000        DB  $00,$00,$00,$C7,$00,$00,$00,$00
001F91 ED08 454000C5C6E20000        DB  $45,$40,$00,$C5,$C6,$E2,$00,$00
001F99 ED10 00007E0000000000        DB  $00,$00,$7E,$00,$00,$00,$00,$00
001FA1 ED18 00000058C3C4C2C1        DB  $00,$00,$00,$58,$C3,$C4,$C2,$C1
001FA9 ED20 0061626364656667        DB  $00,$61,$62,$63,$64,$65,$66,$67 ; !"#$%&'
001FB1 ED28 68696B6A2F2A2E2D        DB  $68,$69,$6B,$6A,$2F,$2A,$2E,$2D ;()*+,-./
001FB9 ED30 2021222324252627        DB  $20,$21,$22,$23,$24,$25,$26,$27 ;01234567
001FC1 ED38 28294F2C512B5749        DB  $28,$29,$4F,$2C,$51,$2B,$57,$49 ;89:;<=>?
001FC9 ED40 5501020304050607        DB  $55,$01,$02,$03,$04,$05,$06,$07 ;@ABCDEFG
001FD1 ED48 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;HIJKLMNO
001FD9 ED50 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;PQRSTUVW
001FE1 ED58 18191A52DD54507C        DB  $18,$19,$1A,$52,$DD,$54,$50,$7C ;XYZ[\]^_
001FE9 ED60 5901020304050607        DB  $59,$01,$02,$03,$04,$05,$06,$07 ;`abcdefg   ATB:1
001FF1 ED68 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;hijklmno
001FF9 ED70 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;pqrstuvw
002001 ED78 18191ACB35CC7060        DB  $18,$19,$1A,$CB,$35,$CC,$70,$60 ;xyz{|}~π
002009 ED80 F1F2F3F4F5F6F7F8        DB  $F1,$F2,$F3,$F4,$F5,$F6,$F7,$F8
002011 ED88 F9FAFBFCFDFEFF76        DB  $F9,$FA,$FB,$FC,$FD,$FE,$FF,$76
002019 ED90 78791F5F5E1E1B5D        DB  $78,$79,$1F,$5F,$5E,$1E,$1B,$5D
002021 ED98 1D1C5C4C6F6E4B77        DB  $1D,$1C,$5C,$4C,$6F,$6E,$4B,$77
002029 EDA0 F0BD9DB1B5B9B49E        DB  $F0,$BD,$9D,$B1,$B5,$B9,$B4,$9E ;　。「」、・ヲァ
002031 EDA8 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ィゥェォャョュッ
002039 EDB0 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーアイウエオカキ
002041 EDB8 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;クケコサシスセソ
002049 EDC0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;タチツテトナニヌ
002051 EDC8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ネノハヒフヘホマ
002059 EDD0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;ミムメモヤユヨラ
002061 EDD8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;リルレロワン
002069 EDE0 4748415344464E4D        DB  $47,$48,$41,$53,$44,$46,$4E,$4D
002071 EDE8 6D733233726C5B4A        DB  $6D,$73,$32,$33,$72,$6C,$5B,$4A
002079 EDF0 5AD6D5D4D3D2D1D0        DB  $5A,$D6,$D5,$D4,$D3,$D2,$D1,$D0
002081 EDF8 D9DADBD8DCCAD8CD        DB  $D9,$DA,$DB,$D8,$DC,$CA,$D8,$CD
       EE00                     DC_TABLE:
002089 EE00 2041424344454647        DB  $20,$41,$42,$43,$44,$45,$46,$47 ;0
002091 EE08 48494A4B4C4D4E4F        DB  $48,$49,$4A,$4B,$4C,$4D,$4E,$4F
002099 EE10 5051525354555657        DB  $50,$51,$52,$53,$54,$55,$56,$57 ;1
0020A1 EE18 58595A9699989592        DB  $58,$59,$5A,$96,$99,$98,$95,$92
0020A9 EE20 3031323334353637        DB  $30,$31,$32,$33,$34,$35,$36,$37 ;2
0020B1 EE28 38392D3D3B2F2E2C        DB  $38,$39,$2D,$3D,$3B,$2F,$2E,$2C
0020B9 EE30 0000EAEB007C0000        DB  $00,$00,$EA,$EB,$00,$7C,$00,$00 ;3
0020C1 EE38 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
0020C9 EE40 09E20000E408E5E0        DB  $09,$E2,$00,$00,$E4,$08,$E5,$E0 ;4
0020D1 EE48 E13FEF9E9BE7E63A        DB  $E1,$3F,$EF,$9E,$9B,$E7,$E6,$3A
0020D9 EE50 5E3C5BE35D40003E        DB  $5E,$3C,$5B,$E3,$5D,$40,$00,$3E ;5
0020E1 EE58 1B60F0EE9A979493        DB  $1B,$60,$F0,$EE,$9A,$97,$94,$93
0020E9 EE60 7F21222324252627        DB  $7F,$21,$22,$23,$24,$25,$26,$27 ;6
0020F1 EE68 28292B2AEDE89D9C        DB  $28,$29,$2B,$2A,$ED,$E8,$9D,$9C
0020F9 EE70 7E00ECE900008F9F        DB  $7E,$00,$EC,$E9,$00,$00,$8F,$9F ;7
002101 EE78 909100005F001200        DB  $90,$91,$00,$00,$5F,$00,$12,$00
002109 EE80 00C1BABFBCB2CAB7        DB  $00,$C1,$BA,$BF,$BC,$B2,$CA,$B7 ;8
002111 EE88 B8C6CFC9D8D3D0D7        DB  $B8,$C6,$CF,$C9,$D8,$D3,$D0,$D7
002119 EE90 BEC0BDC4B6C5CBC3        DB  $BE,$C0,$BD,$C4,$B6,$C5,$CB,$C3 ;9
002121 EE98 BBDDC2DBB9A2A7AC        DB  $BB,$DD,$C2,$DB,$B9,$A2,$A7,$AC
002129 EEA0 DCC7CCB1B3B4B5D4        DB  $DC,$C7,$CC,$B1,$B3,$B4,$B5,$D4 ;A
002131 EEA8 D5D6CECDDAD2D9C8        DB  $D5,$D6,$CE,$CD,$DA,$D2,$D9,$C8
002139 EEB0 D1A3A8ADA6A4A9AE        DB  $D1,$A3,$A8,$AD,$A6,$A4,$A9,$AE ;B
002141 EEB8 DFA5AAAFDEA1ABB0        DB  $DF,$A5,$AA,$AF,$DE,$A1,$AB,$B0
002149 EEC0 001F1E1C1D0B0C03        DB  $00,$1F,$1E,$1C,$1D,$0B,$0C,$03 ;C
002151 EEC8 0000FD7B7DFF0000        DB  $00,$00,$FD,$7B,$7D,$FF,$00,$00
002159 EED0 F7F6F5F4F3F2F100        DB  $F7,$F6,$F5,$F4,$F3,$F2,$F1,$00 ;D
002161 EED8 FBF8F9FAFC5C0000        DB  $FB,$F8,$F9,$FA,$FC,$5C,$00,$00
002169 EEE0 00000D0000000000        DB  $00,$00,$0D,$00,$00,$00,$00,$00 ;E
002171 EEE8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
002179 EEF0 A080818283848586        DB  $A0,$80,$81,$82,$83,$84,$85,$86 ;F
002181 EEF8 8788898A8B8C8D8E        DB  $87,$88,$89,$8A,$8B,$8C,$8D,$8E
[EOF:M7TABLE.ASM:SHIFT_JIS]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
       EF00                     AT_WORK:
002189 EF00                         DS  WORKAD-AT_WORK
                                
       EF00                     CPM_BOOT:
002189 EF00 C30000          10      JP  0
       EF03                     _SYS00:     ;(BDOS)プログラム終了
       EF03                     CPM_WBOOT:
00218C EF03 C3FECF          10      JP  WBOOT1
       EF06                     CPM_CONST:
00218F EF06 C3DFD9          10      JP  CONSTX
       EF09                     _SYS07:     ;(BDOS)コンソール直接入力
       EF09                     CPM_CONIN:
002192 EF09 C375D9          10      JP  FLGET
       EF0C                     CPM_CONOUT:
002195 EF0C C362DB          10      JP  CONOUT1
                                
       EF0F                     DECBF:
002198 EF0F                         DS  5
00219D EF14 00                  FDRV    DB  0
00219E EF15                     FNAME   DS  36
0021C2 EF39                     SFILE:  DS  33      ;DRV FILENAME
0021E3 EF5A                     HLBUF:  DS  3       ;Random record buffer
                                
0021E6 EF5D 0000                LEFTX:  DW  0
0021E8 EF5F 0000                DTAX:   DW  0
                                
0021EA EF61 008E01000B000C10    BEEPD:  DB  0,08EH,1,0,00BH,0,00CH,010H
0021F2 EF69 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
                                
0021F9 EF70 00                  CHECK:  DB  0
                                
0021FA EF71 4F4B24              OK: DB  "OK$"
0021FD EF74 536B697024          SKIP:   DB  "Skip$"
002202 EF79 4572726F722124      COMERM: DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
002209 EF80 FF                  _CYL0:  DB  0FFH    ;Cylinder
00220A EF81 FF                  _CYL1:  DB  0FFH    ;Cylinder
00220B EF82 FF                  _CYL2:  DB  0FFH    ;Cylinder
00220C EF83 FF                  _CYL3:  DB  0FFH    ;Cylinder
00220D EF84 00                  _DRIVE: DB  0   ;unit number
00220E EF85 00                  _SEEKSP:DB  0   ;Seek speed
00220F EF86 FF                  _ISEEK: DB  0FFH    ;
002210 EF87 00                  _DVSW:  DB  0
002211 EF88 00                  _DRV:   DB  0
002212 EF89 FF                  _DSK:   DB  0FFH
002213 EF8A 8000                _DTA:   DW  00080H
002215 EF8C 0000                _CTC:   DW  0
002217 EF8E 0000                _TXADR: DW  0
002219 EF90 0000                _KEYPS: DW  0
00221B EF92 00FF                _KEYD:  DW  0FF00H  ;キーデータ
00221D EF94 C210                _KEYSP: DW  010C2H
00221F EF96 71                  _COLORF:DB  COLORF  ;色
002220 EF97 19                  _LINE:  DB  LINE
                                
002221 EF98 0000                _FCB:   DW  0
002223 EF9A 0000                _FBPS:  DW  0   ;SEARCH FILES
002225 EF9C 0000                _FBAD:  DW  0   ;    //
002227 EF9E 00                  _FBCNT: DB  0   ;    //
002228 EF9F 00                  _FILEN: DB  0
002229 EFA0 00                  _DIRF:  DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
00222A EFA1 00                  _MAXCYL:DB  0
00222B EFA2 00                  _WTFATF:DB  0   ;FATバッファの更新フラグ
00222C EFA3                             DS  1
00222D EFA4 00                  _WTDBF: DB  0   ;データバッファの更新フラグ
00222E EFA5 FF                  _DBDRV: DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
00222F EFA6 0000                _DBSEC: DW  0   ;データバッファにあるデータを読み込んだセクタ番号
002231 EFA8 0000                _DPB:   DW  0
       EFAA                     _FATDRV:
002233 EFAA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
002234 EFAB 00                  _FATIX: DB  0   ;FATバッファに読み込んでいるインデックス
       EFAC                     _FAKEFREE:
002235 EFAC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
002237 EFAE                         DS  2
                                
002239 EFB0 6F2859381F02191C    CRTCD:  DB  06FH,WIDTH,059H,038H,01FH,002H,019H,01CH
002241 EFB8 0007                    DB  000H,007H
002243 EFBA 18FCD8FF                DW  0-WIDTH*LINE,0-WIDTH
002247 EFBE 0C                      DB  00CH
002248 EFBF 20                  WK1FD0: DB  020H
                                
002249 EFC0 0000                CTC0:   DW  INTCTCE
00224B EFC2 0000                CTC1:   DW  INTCTCE
00224D EFC4 0000                CTC2:   DW  INTCTC2
00224F EFC6 0000                CTC3:   DW  INTCTCE
002251 EFC8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
002253 EFCA C375DC          10  _INKEY: JP  INKEY
002256 EFCD C377DA          10  _PRINT: JP  PRINT
002259 EFD0 C3F8DC          10  _SCRN:  JP  SCRN
00225C EFD3 C300DC          10  _POS:   JP  POS
00225F EFD6 C330DB          10  _LOC:   JP  LOC
       EFD9                     _CHGDRV:
002262 EFD9 C350E9          10      JP  CHGDRV
       EFDC                     _GETDPB:
002265 EFDC C324EA          10      JP  GETDPB
       EFDF                     _FFLUSH:
002268 EFDF C342EA          10      JP  FFLUSH
       EFE2                     _RDFATX:
00226B EFE2 C355E6          10      JP  RDFATX
00226E EFE5 C37DE7          10  _RDFAT: JP  RDFAT
002271 EFE8 C307EB          10  _WTTRK: JP  WTTRK
002274 EFEB C36AEB          10  _FDRD:  JP  FDRD
002277 EFEE C30DEB          10  _FDWT:  JP  FDWT
       EFF1                     _BPB2DPB:
00227A EFF1 C3E2E7          10      JP  BPB2DPB
00227D EFF4                         DS  3
       EFF7                     _GNCL:
002280 EFF7 C3F7E6          10  GNCPAT: JP  GNCL        ; self-modifying code
       EFFA                     _SNCL:
002283 EFFA C31AE7          10  SNCPAT: JP  SNCL        ; self-modifying code
002286 EFFD C33FD0          10  _COMANL:JP  COMANL
                                
       F000                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       F000                     STABLE:
                                ;0
002289 F000 03EF49D955D96EDF        DW  _SYS00,_SYS01,_SYS02,_SYS03
002291 F008 64D664D65AD909EF        DW  _SYS04,_SYS05,_SYS06,_SYS07
002299 F010 62D966D6ABD9D7D9        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
0022A1 F018 7BD680D68FD6A2D6        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
0022A9 F020 F6D63DD786D7BCD7        DW  _SYS10,_SYS11,_SYS12,_SYS13
0022B1 F028 C4D7E2D7FFD7F7D7        DW  _SYS14,_SYS15,_SYS16,_SYS17
0022B9 F030 60D865D86AD870D8        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
0022C1 F038 64D696D864D69AD8        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
0022C9 F040 64D636D84BD8A1D8        DW  _SYS20,_SYS21,_SYS22,_SYS23
0022D1 F048 C0D864D6AAE38BE4        DW  _SYS24,_ERROR,_SYS26,_SYS27
0022D9 F050 4BD8C9D8F0D96EDF        DW  _SYS28,_SYS5C,_SYS2A,_SYS2B
0022E1 F058 F8D96EDF64D6ECD8        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
0022E9 F060 E6D864D664D664D6        DW  _SYS30,_ERROR,_ERROR,_ERROR
0022F1 F068 64D664D664D664D6        DW  _ERROR,_ERROR,_ERROR,_ERROR
0022F9 F070 64D66EDF6EDF0DD9        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
002301 F078 47D6                    DW  _DOS2
                                
002303 F07A                         DS  2
002305 F07C 00F2                _FATBF: DW  FATBF
002307 F07E 00FA                _DTBUF: DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       F080                     CTRLTB:
002309 F080 C3DAC3DAF9DAD3DB        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
002311 F088 CDDB15DBBEDB72DB        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
002319 F090 CFDAEADAD6DB43DB        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
002321 F098 BBDB2BDBE8DBC3DA        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
002329 F0A0 C3DAC3DA3BDBC3DA        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
002331 F0A8 C3DAC3DAC3DAC3DA        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
002339 F0B0 C3DAC3DABBDB4ADB        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
002341 F0B8 B2DAD6DADFDAD6DB        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
002349 F0C0 0307                DEMES:  DB  3,7
00234B F0C2 4465766963652049        DB  "Device I/O Error",5,3
            2F4F204572726F72    
            0503                
00235D F0D4 41626F7274205265        DB  "Abort Retry Ignore?",5,3,0
            7472792049676E6F    
            72653F050300        
                                
002373 F0EA 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
002375 F0EC 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
002377 F0EE 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
002379 F0F0 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       F0F4                     SDDATAE:
                                
00237D F0F4                     SCDIR:  DS  2       ;+14 +15
00237F F0F6                     SFBPS:  DS  2       ;FBPS
002381 F0F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
002383 F0FA 0000                _FATPS: DW  0
002385 F0FC 0000                _DIRPS: DW  0
002387 F0FE 0000                _CLPS:  DW  0
                                
       F100                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "M7DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   MZ-700/1500
                                
       F100                     DEVICE:
                                
                                ;   A:
                                
002389 F100 0200                    DW  2   ;DPB_00_FATLN
00238B F102 EBEF                    DW  _FDRD   ;DPB_02_DRD
00238D F104 EEEF                    DW  _FDWT   ;DPB_04_DWT
00238F F106 FD                      DB  0FDH    ;DPB_06_FATID
002390 F107 02                      DB  2   ;DPB_07_SECPCL
002391 F108 6401                    DW  356 ;DPB_08_MAXCL
002393 F10A FF                      DB  0FFH    ;DPB_0A_FDMODE  0FFH=2D / 0FEH=2HD
002394 F10B 07                      DB  7   ;DPB_0B_DIRSCNT
002395 F10C 28                      DB  40  ;DPB_0C_MAXCYL
002396 F10D 09                      DB  9   ;DPB_0D_MAXSEC  Number of sectors
002397 F10E 01                      DB  1   ;DPB_0E_FATPS
002398 F10F 82                      DB  082H    ;DPB_0F_BPS
002399 F110 0500                    DW  5   ;DPB_10_DIRPS
00239B F112 27                      DB  027H    ;DPB_12_DEVICE  Device Number
00239C F113 00                      DB  0   ;DPB_13_UNITNO
00239D F114 0800                    DW  8   ;DPB_14_ADDCL16
00239F F116 0000                    DW  0   ;DPB_16
0023A1 F118 0000                    DW  0   ;DPB_18
0023A3 F11A 0000                    DW  0   ;DPB_1A_SDIR
0023A5 F11C 46444430                DB  "FDD0"  ;DPB_1C_NAME
                                
                                ;   B:
                                
0023A9 F120 0200                    DW  2   ;DPB_00_FATLN
0023AB F122 EBEF                    DW  _FDRD   ;DPB_02_DRD
0023AD F124 EEEF                    DW  _FDWT   ;DPB_04_DWT
0023AF F126 FD                      DB  0FDH    ;DPB_06_FATID
0023B0 F127 02                      DB  2   ;DPB_07_SECPCL
0023B1 F128 6401                    DW  356 ;DPB_08_MAXCL
0023B3 F12A FF                      DB  0FFH    ;DPB_0A_FDMODE  0FFH=2D / 0FEH=2HD
0023B4 F12B 07                      DB  7   ;DPB_0B_DIRSCNT
0023B5 F12C 28                      DB  40  ;DPB_0C_MAXCYL
0023B6 F12D 09                      DB  9   ;DPB_0D_MAXSEC  Number of sectors
0023B7 F12E 01                      DB  1   ;DPB_0E_FATPS
0023B8 F12F 82                      DB  082H    ;DPB_0F_BPS
0023B9 F130 0500                    DW  5   ;DPB_10_DIRPS
0023BB F132 27                      DB  027H    ;DPB_12_DEVICE  Device Number
0023BC F133 01                      DB  1   ;DPB_13_UNITNO
0023BD F134 0800                    DW  8   ;DPB_14_ADDCL16
0023BF F136 0000                    DW  0   ;DPB_16
0023C1 F138 0000                    DW  0   ;DPB_18
0023C3 F13A 0000                    DW  0   ;DPB_1A_SDIR
0023C5 F13C 46444431                DB  "FDD1"  ;DPB_1C_NAME
                                
                                ;   C:
                                
0023C9 F140                         DS  32
                                
                                ;   D:
                                
0023E9 F160                         DS  32
                                
                                ;   E:
                                
002409 F180 0000                    DW  0   ;DPB_00_FATLN
00240B F182 E9D5                    DW  EDRD    ;DPB_02_DRD
00240D F184 DCD5                    DW  EDWT    ;DPB_04_DWT
00240F F186 FA                      DB  0FAH    ;DPB_06_FATID
002410 F187 02                      DB  2   ;DPB_07_SECPCL
002411 F188 0000                    DW  0   ;DPB_08_MAXCL
002413 F18A 00                      DB  0   ;DPB_0A_FDMODE
002414 F18B 00                      DB  512 ;DPB_0B_DIRSCNT
002415 F18C 00                      DB  0   ;DPB_0C_MAXCYL
002416 F18D 00                      DB  0   ;DPB_0D_MAXSEC
002417 F18E 01                      DB  1   ;DPB_0E_FATPS
002418 F18F 01                      DB  1   ;DPB_0F_BPS
002419 F190 0000                    DW  0   ;DPB_10_DIRPS
00241B F192 26                      DB  026H    ;DPB_12_DEVICE
00241C F193 00                      DB  0   ;DPB_13_UNITNO
00241D F194 0000                    DW  0   ;DPB_14_ADDCL16
00241F F196 0000                    DW  0   ;DPB_16
002421 F198 0000                    DW  0   ;DPB_18
002423 F19A 0000                    DW  0   ;DPB_1A_SDIR
002425 F19C 454D4D30                DB  "EMM0"  ;DPB_1C_NAME
                                
                                ;   F:
                                
002429 F1A0                         DS  32
                                
                                ;   G:
                                
002449 F1C0                         DS  32
                                
                                ;   H:
002469 F1E0                         DS  31
002488 F1FF 00                      DB  0
[EOF:M7DPB.ASM:UTF_8]
                                
       A489                         ORG $$+OFFSET   ;$DEPHASE
       A489                     LAST_ADR:
                                
                                    END
[EOF:M7.ASM:UTF_8]
